# Comparing `tmp/druhg-1.3.0.tar.gz` & `tmp/druhg-1.4.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist\druhg-1.3.0.tar", last modified: Thu Apr 21 02:48:52 2022, max compression
+gzip compressed data, was "dist\druhg-1.4.0.tar", last modified: Sun Jul 16 08:10:04 2023, max compression
```

## Comparing `druhg-1.3.0.tar` & `druhg-1.4.0.tar`

### file list

```diff
@@ -1,29 +1,34 @@
-drwxrwxrwx   0        0        0        0 2022-04-21 02:48:52.247667 druhg-1.3.0/
--rw-rw-rw-   0        0        0       76 2020-01-05 16:02:35.000000 druhg-1.3.0/MANIFEST.in
--rw-rw-rw-   0        0        0     7219 2022-04-21 02:48:52.246668 druhg-1.3.0/PKG-INFO
--rw-rw-rw-   0        0        0     4925 2022-04-17 17:18:15.000000 druhg-1.3.0/README.rst
-drwxrwxrwx   0        0        0        0 2022-04-21 02:48:52.231677 druhg-1.3.0/druhg/
--rw-rw-rw-   0        0        0       34 2022-04-21 02:34:43.000000 druhg-1.3.0/druhg/__init__.py
--rw-rw-rw-   0        0        0   484190 2022-04-20 18:10:28.000000 druhg-1.3.0/druhg/_druhg_amalgamation.c
--rw-rw-rw-   0        0        0      761 2022-04-17 16:37:04.000000 druhg-1.3.0/druhg/_druhg_amalgamation.pxd
--rw-rw-rw-   0        0        0     4325 2022-04-18 16:11:56.000000 druhg-1.3.0/druhg/_druhg_amalgamation.pyx
--rw-rw-rw-   0        0        0   618490 2022-04-20 18:10:29.000000 druhg-1.3.0/druhg/_druhg_label.c
--rw-rw-rw-   0        0        0     9618 2022-04-17 17:40:41.000000 druhg-1.3.0/druhg/_druhg_label.pyx
--rw-rw-rw-   0        0        0  1090815 2022-04-20 18:10:18.000000 druhg-1.3.0/druhg/_druhg_tree.c
--rw-rw-rw-   0        0        0      457 2022-04-17 10:15:25.000000 druhg-1.3.0/druhg/_druhg_tree.pxd
--rw-rw-rw-   0        0        0    23881 2022-04-17 16:21:24.000000 druhg-1.3.0/druhg/_druhg_tree.pyx
--rw-rw-rw-   0        0        0    13843 2022-04-20 18:27:25.000000 druhg-1.3.0/druhg/druhg_.py
--rw-rw-rw-   0        0        0    16724 2022-04-15 17:35:50.000000 druhg-1.3.0/druhg/plots.py
-drwxrwxrwx   0        0        0        0 2022-04-21 02:48:52.244669 druhg-1.3.0/druhg/tests/
--rw-rw-rw-   0        0        0    29102 2022-04-21 02:37:48.000000 druhg-1.3.0/druhg/tests/test_druhg.py
-drwxrwxrwx   0        0        0        0 2022-04-21 02:48:52.242670 druhg-1.3.0/druhg.egg-info/
--rw-rw-rw-   0        0        0     7219 2022-04-21 02:48:52.000000 druhg-1.3.0/druhg.egg-info/PKG-INFO
--rw-rw-rw-   0        0        0      506 2022-04-21 02:48:52.000000 druhg-1.3.0/druhg.egg-info/SOURCES.txt
--rw-rw-rw-   0        0        0        1 2022-04-21 02:48:52.000000 druhg-1.3.0/druhg.egg-info/dependency_links.txt
--rw-rw-rw-   0        0        0        2 2022-04-20 18:18:22.000000 druhg-1.3.0/druhg.egg-info/not-zip-safe
--rw-rw-rw-   0        0        0       55 2022-04-21 02:48:52.000000 druhg-1.3.0/druhg.egg-info/requires.txt
--rw-rw-rw-   0        0        0        6 2022-04-21 02:48:52.000000 druhg-1.3.0/druhg.egg-info/top_level.txt
--rw-rw-rw-   0        0        0       86 2018-11-01 09:15:52.000000 druhg-1.3.0/pyproject.toml
--rw-rw-rw-   0        0        0       61 2021-04-20 06:15:13.000000 druhg-1.3.0/requirements.txt
--rw-rw-rw-   0        0        0       42 2022-04-21 02:48:52.247667 druhg-1.3.0/setup.cfg
--rw-rw-rw-   0        0        0     3093 2022-04-21 02:11:53.000000 druhg-1.3.0/setup.py
+drwxrwxrwx   0        0        0        0 2023-07-16 08:10:04.207906 druhg-1.4.0/
+-rw-rw-rw-   0        0        0       76 2020-01-05 16:02:35.000000 druhg-1.4.0/MANIFEST.in
+-rw-rw-rw-   0        0        0     7211 2023-07-16 08:10:04.207906 druhg-1.4.0/PKG-INFO
+-rw-rw-rw-   0        0        0     4925 2022-04-17 17:18:15.000000 druhg-1.4.0/README.rst
+drwxrwxrwx   0        0        0        0 2023-07-16 08:10:04.207906 druhg-1.4.0/druhg/
+-rw-rw-rw-   0        0        0       34 2022-09-01 04:19:20.000000 druhg-1.4.0/druhg/__init__.py
+-rw-rw-rw-   0        0        0   652832 2022-08-29 05:53:17.000000 druhg-1.4.0/druhg/_cyheapq.c
+-rw-rw-rw-   0        0        0     8368 2022-08-29 03:59:45.000000 druhg-1.4.0/druhg/_cyheapq.pyx
+-rw-rw-rw-   0        0        0   538770 2023-07-15 12:41:59.000000 druhg-1.4.0/druhg/_druhg_group.c
+-rw-rw-rw-   0        0        0     1167 2023-07-15 11:29:55.000000 druhg-1.4.0/druhg/_druhg_group.pxd
+-rw-rw-rw-   0        0        0     4658 2023-07-15 12:01:20.000000 druhg-1.4.0/druhg/_druhg_group.pyx
+-rw-rw-rw-   0        0        0   528465 2023-07-15 13:16:48.000000 druhg-1.4.0/druhg/_druhg_label.c
+-rw-rw-rw-   0        0        0     8014 2023-07-15 13:16:30.000000 druhg-1.4.0/druhg/_druhg_label.pyx
+-rw-rw-rw-   0        0        0  1097281 2023-07-15 12:41:55.000000 druhg-1.4.0/druhg/_druhg_tree.c
+-rw-rw-rw-   0        0        0      169 2023-07-15 11:43:34.000000 druhg-1.4.0/druhg/_druhg_tree.pxd
+-rw-rw-rw-   0        0        0    15676 2023-07-15 11:45:13.000000 druhg-1.4.0/druhg/_druhg_tree.pyx
+-rw-rw-rw-   0        0        0   431933 2023-07-15 12:41:49.000000 druhg-1.4.0/druhg/_druhg_unionfind.c
+-rw-rw-rw-   0        0        0      778 2023-07-15 12:24:35.000000 druhg-1.4.0/druhg/_druhg_unionfind.pxd
+-rw-rw-rw-   0        0        0     2457 2023-07-15 12:02:51.000000 druhg-1.4.0/druhg/_druhg_unionfind.pyx
+-rw-rw-rw-   0        0        0    17795 2023-07-16 07:39:48.000000 druhg-1.4.0/druhg/druhg_.py
+-rw-rw-rw-   0        0        0    17904 2023-07-15 12:04:27.000000 druhg-1.4.0/druhg/plots.py
+drwxrwxrwx   0        0        0        0 2023-07-16 08:10:04.207906 druhg-1.4.0/druhg/tests/
+-rw-rw-rw-   0        0        0    30490 2023-07-16 07:58:49.000000 druhg-1.4.0/druhg/tests/test_druhg.py
+drwxrwxrwx   0        0        0        0 2023-07-16 08:10:04.207906 druhg-1.4.0/druhg.egg-info/
+-rw-rw-rw-   0        0        0     7211 2023-07-16 08:10:04.000000 druhg-1.4.0/druhg.egg-info/PKG-INFO
+-rw-rw-rw-   0        0        0      600 2023-07-16 08:10:04.000000 druhg-1.4.0/druhg.egg-info/SOURCES.txt
+-rw-rw-rw-   0        0        0        1 2023-07-16 08:10:04.000000 druhg-1.4.0/druhg.egg-info/dependency_links.txt
+-rw-rw-rw-   0        0        0        2 2022-04-20 18:18:22.000000 druhg-1.4.0/druhg.egg-info/not-zip-safe
+-rw-rw-rw-   0        0        0       55 2023-07-16 08:10:04.000000 druhg-1.4.0/druhg.egg-info/requires.txt
+-rw-rw-rw-   0        0        0        6 2023-07-16 08:10:04.000000 druhg-1.4.0/druhg.egg-info/top_level.txt
+-rw-rw-rw-   0        0        0       86 2018-11-01 09:15:52.000000 druhg-1.4.0/pyproject.toml
+-rw-rw-rw-   0        0        0       61 2021-04-20 06:15:13.000000 druhg-1.4.0/requirements.txt
+-rw-rw-rw-   0        0        0       42 2023-07-16 08:10:04.223529 druhg-1.4.0/setup.cfg
+-rw-rw-rw-   0        0        0     3387 2023-07-16 08:09:25.000000 druhg-1.4.0/setup.py
```

### Comparing `druhg-1.3.0/PKG-INFO` & `druhg-1.4.0/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 Metadata-Version: 1.2
 Name: druhg
-Version: 1.3.0
+Version: 1.4.0
 Summary: Universal clustering based on dialectical materialism
 Home-page: https://github.com/artamono/druhg
-Maintainer: Pavel "DRUHG" Artamonov
+Maintainer: Pavel Artamonov
 Maintainer-email: druhg.p@gmail.com
 License: BSD
 Description: .. image:: https://img.shields.io/pypi/v/druhg.svg
             :target: https://pypi.python.org/pypi/druhg/
             :alt: PyPI Version
         .. image:: https://img.shields.io/pypi/l/druhg.svg
             :target: https://github.com/artamono/druhg/blob/master/LICENSE
```

### Comparing `druhg-1.3.0/README.rst` & `druhg-1.4.0/README.rst`

 * *Files identical despite different names*

### Comparing `druhg-1.3.0/druhg/_druhg_amalgamation.c` & `druhg-1.4.0/druhg/_druhg_unionfind.c`

 * *Files 9% similar despite different names*

```diff
@@ -1,19 +1,19 @@
 /* Generated by Cython 3.0.0a10 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
         "depends": [],
-        "name": "druhg._druhg_amalgamation",
+        "name": "druhg._druhg_unionfind",
         "sources": [
-            "druhg/_druhg_amalgamation.pyx"
+            "druhg/_druhg_unionfind.pyx"
         ]
     },
-    "module_name": "druhg._druhg_amalgamation"
+    "module_name": "druhg._druhg_unionfind"
 }
 END: Cython Metadata */
 
 #ifndef PY_SSIZE_T_CLEAN
 #define PY_SSIZE_T_CLEAN
 #endif /* PY_SSIZE_T_CLEAN */
 #if defined(CYTHON_LIMITED_API) && 0
@@ -940,28 +940,27 @@
   #ifdef __cplusplus
     #define __PYX_EXTERN_C extern "C"
   #else
     #define __PYX_EXTERN_C extern
   #endif
 #endif
 
-#define __PYX_HAVE__druhg___druhg_amalgamation
-#define __PYX_HAVE_API__druhg___druhg_amalgamation
+#define __PYX_HAVE__druhg___druhg_unionfind
+#define __PYX_HAVE_API__druhg___druhg_unionfind
 /* Early includes */
 #include <string.h>
 #include <stdio.h>
 
     /* Using NumPy API declarations from "numpy/__init__.cython-30.pxd" */
     
 #include "numpy/arrayobject.h"
 #include "numpy/ndarrayobject.h"
 #include "numpy/ndarraytypes.h"
 #include "numpy/arrayscalars.h"
 #include "numpy/ufuncobject.h"
-#include <math.h>
 #ifdef _OPENMP
 #include <omp.h>
 #endif /* _OPENMP */
 
 #if defined(PYREX_WITHOUT_ASSERTIONS) && !defined(CYTHON_WITHOUT_ASSERTIONS)
 #define CYTHON_WITHOUT_ASSERTIONS
 #endif
@@ -1197,15 +1196,15 @@
   #undef _Complex_I
   #define _Complex_I 1.0fj
 #endif
 
 /* #### Code section: filename_table ### */
 
 static const char *__pyx_f[] = {
-  "druhg\\\\_druhg_amalgamation.pyx",
+  "druhg\\\\_druhg_unionfind.pyx",
   "<stringsource>",
   "venv\\\\lib\\\\site-packages\\\\numpy\\\\__init__.cython-30.pxd",
   "venv\\\\lib\\\\site-packages\\\\Cython\\\\Includes\\\\cpython\\\\type.pxd",
 };
 /* #### Code section: utility_code_proto_before_types ### */
 /* #### Code section: numeric_typedefs ### */
 
@@ -1421,15 +1420,15 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 /* #### Code section: type_declarations ### */
 
 /*--- Type declarations ---*/
-struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation;
+struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind;
 
 /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":771
  * ctypedef npy_longdouble longdouble_t
  * 
  * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t
@@ -1459,46 +1458,49 @@
  * 
  * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  */
 typedef npy_cdouble __pyx_t_5numpy_complex_t;
 
-/* "druhg/_druhg_amalgamation.pxd":11
- * cimport numpy as np
+/* "druhg/_druhg_unionfind.pxd":16
+ * 
  * 
- * cdef class Amalgamation (object):             # <<<<<<<<<<<<<<
+ * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
  *     cdef:
- *         np.intp_t size
+ *         np.intp_t p_size
  */
-struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation {
+struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind {
   PyObject_HEAD
-  struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_vtab;
-  __pyx_t_5numpy_intp_t size;
-  __pyx_t_5numpy_intp_t clusters;
-  PyObject *energies;
+  struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *__pyx_vtab;
+  __pyx_t_5numpy_intp_t p_size;
+  PyArrayObject *parent_arr;
+  __pyx_t_5numpy_intp_t *parent;
+  PyArrayObject *fast_arr;
+  __pyx_t_5numpy_intp_t *fast;
+  __pyx_t_5numpy_intp_t next_label;
 };
 
 
 
-/* "druhg/_druhg_amalgamation.pyx":33
- *     return delta
+/* "druhg/_druhg_unionfind.pyx":20
+ *     return buffer_parents, buffer_fast
  * 
- * cdef class Amalgamation (object):             # <<<<<<<<<<<<<<
- *     # declarations are in pxd file
- *     # https://cython.readthedocs.io/en/latest/src/userguide/sharing_declarations.html
+ * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
+ * 
+ *     def __init__(self, np.intp_t N, buffer_parents, buffer_fast=None):
  */
 
-struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation {
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *(*merge_amalgamations)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, __pyx_t_5numpy_double_t);
-  __pyx_t_5numpy_double_t (*border_overcoming)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t);
-  __pyx_t_5numpy_double_t (*border_overcoming_rev)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t);
-  void (*_amalgamate)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, PyObject *);
+struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind {
+  __pyx_t_5numpy_intp_t (*nullify)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *);
+  __pyx_t_5numpy_intp_t (*mark_up)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t);
+  __pyx_t_5numpy_intp_t (*is_same_parent)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
+  void (*__pyx_union)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
 };
-static struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation;
+static struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *__pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind;
 /* #### Code section: utility_code_proto ### */
 
 /* --- Runtime support code (head) --- */
 /* Refnanny.proto */
 #ifndef CYTHON_REFNANNY
   #define CYTHON_REFNANNY 0
 #endif
@@ -1568,144 +1570,22 @@
 #define __Pyx_DECREF_SET(r, v) do {\
         PyObject *tmp = (PyObject *) r;\
         r = v; __Pyx_DECREF(tmp);\
     } while (0)
 #define __Pyx_CLEAR(r)    do { PyObject* tmp = ((PyObject*)(r)); r = NULL; __Pyx_DECREF(tmp);} while(0)
 #define __Pyx_XCLEAR(r)   do { if((r) != NULL) {PyObject* tmp = ((PyObject*)(r)); r = NULL; __Pyx_DECREF(tmp);}} while(0)
 
-/* TupleAndListFromArray.proto */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_PyList_FromArray(PyObject *const *src, Py_ssize_t n);
-static CYTHON_INLINE PyObject* __Pyx_PyTuple_FromArray(PyObject *const *src, Py_ssize_t n);
-#endif
-
-/* IncludeStringH.proto */
-#include <string.h>
-
-/* BytesEquals.proto */
-static CYTHON_INLINE int __Pyx_PyBytes_Equals(PyObject* s1, PyObject* s2, int equals);
-
-/* UnicodeEquals.proto */
-static CYTHON_INLINE int __Pyx_PyUnicode_Equals(PyObject* s1, PyObject* s2, int equals);
-
-/* fastcall.proto */
-#define __Pyx_Arg_VARARGS(args, i) PyTuple_GET_ITEM(args, i)
-#define __Pyx_NumKwargs_VARARGS(kwds) PyDict_Size(kwds)
-#define __Pyx_KwValues_VARARGS(args, nargs) NULL
-#define __Pyx_GetKwValue_VARARGS(kw, kwvalues, s) __Pyx_PyDict_GetItemStrWithError(kw, s)
-#define __Pyx_KwargsAsDict_VARARGS(kw, kwvalues) PyDict_Copy(kw)
-#if CYTHON_METH_FASTCALL
-    #define __Pyx_Arg_FASTCALL(args, i) args[i]
-    #define __Pyx_NumKwargs_FASTCALL(kwds) PyTuple_GET_SIZE(kwds)
-    #define __Pyx_KwValues_FASTCALL(args, nargs) (&args[nargs])
-    static CYTHON_INLINE PyObject * __Pyx_GetKwValue_FASTCALL(PyObject *kwnames, PyObject *const *kwvalues, PyObject *s);
-    #define __Pyx_KwargsAsDict_FASTCALL(kw, kwvalues) _PyStack_AsDict(kwvalues, kw)
-#else
-    #define __Pyx_Arg_FASTCALL __Pyx_Arg_VARARGS
-    #define __Pyx_NumKwargs_FASTCALL __Pyx_NumKwargs_VARARGS
-    #define __Pyx_KwValues_FASTCALL __Pyx_KwValues_VARARGS
-    #define __Pyx_GetKwValue_FASTCALL __Pyx_GetKwValue_VARARGS
-    #define __Pyx_KwargsAsDict_FASTCALL __Pyx_KwargsAsDict_VARARGS
-#endif
-#if CYTHON_COMPILING_IN_CPYTHON
-#define __Pyx_ArgsSlice_VARARGS(args, start, stop) __Pyx_PyTuple_FromArray(&__Pyx_Arg_VARARGS(args, start), stop - start)
-#define __Pyx_ArgsSlice_FASTCALL(args, start, stop) __Pyx_PyTuple_FromArray(&__Pyx_Arg_FASTCALL(args, start), stop - start)
-#else
-#define __Pyx_ArgsSlice_VARARGS(args, start, stop) PyTuple_GetSlice(args, start, stop)
-#define __Pyx_ArgsSlice_FASTCALL(args, start, stop) PyTuple_GetSlice(args, start, stop)
-#endif
-
-/* RaiseDoubleKeywords.proto */
-static void __Pyx_RaiseDoubleKeywordsError(const char* func_name, PyObject* kw_name);
-
-/* ParseKeywords.proto */
-static int __Pyx_ParseOptionalKeywords(PyObject *kwds, PyObject *const *kwvalues,
-    PyObject **argnames[],
-    PyObject *kwds2, PyObject *values[], Py_ssize_t num_pos_args,
-    const char* function_name);
-
-/* RaiseArgTupleInvalid.proto */
-static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
-    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
-
-/* IterFinish.proto */
-static CYTHON_INLINE int __Pyx_IterFinish(void);
-
-/* set_iter.proto */
-static CYTHON_INLINE PyObject* __Pyx_set_iterator(PyObject* iterable, int is_set,
-                                                  Py_ssize_t* p_orig_length, int* p_source_is_set);
-static CYTHON_INLINE int __Pyx_set_iter_next(
-        PyObject* iter_obj, Py_ssize_t orig_length,
-        Py_ssize_t* ppos, PyObject **value,
-        int source_is_set);
-
-/* dict_getitem_default.proto */
-static PyObject* __Pyx_PyDict_GetItemDefault(PyObject* d, PyObject* key, PyObject* default_value);
-
-/* PyObjectCall.proto */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
-#else
-#define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
-#endif
-
-/* PyObjectGetAttrStr.proto */
-#if CYTHON_USE_TYPE_SLOTS
-static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStr(PyObject* obj, PyObject* attr_name);
-#else
-#define __Pyx_PyObject_GetAttrStr(o,n) PyObject_GetAttr(o,n)
-#endif
-
-/* UnpackUnboundCMethod.proto */
-typedef struct {
-    PyObject *type;
-    PyObject **method_name;
-    PyCFunction func;
-    PyObject *method;
-    int flag;
-} __Pyx_CachedCFunction;
-
-/* CallUnboundCMethod1.proto */
-static PyObject* __Pyx__CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg);
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg);
+/* PyErrExceptionMatches.proto */
+#if CYTHON_FAST_THREAD_STATE
+#define __Pyx_PyErr_ExceptionMatches(err) __Pyx_PyErr_ExceptionMatchesInState(__pyx_tstate, err)
+static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err);
 #else
-#define __Pyx_CallUnboundCMethod1(cfunc, self, arg)  __Pyx__CallUnboundCMethod1(cfunc, self, arg)
+#define __Pyx_PyErr_ExceptionMatches(err)  PyErr_ExceptionMatches(err)
 #endif
 
-/* CallUnboundCMethod2.proto */
-static PyObject* __Pyx__CallUnboundCMethod2(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg1, PyObject* arg2);
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030600B1
-static CYTHON_INLINE PyObject *__Pyx_CallUnboundCMethod2(__Pyx_CachedCFunction *cfunc, PyObject *self, PyObject *arg1, PyObject *arg2);
-#else
-#define __Pyx_CallUnboundCMethod2(cfunc, self, arg1, arg2)  __Pyx__CallUnboundCMethod2(cfunc, self, arg1, arg2)
-#endif
-
-/* GetItemInt.proto */
-#define __Pyx_GetItemInt(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_GetItemInt_Fast(o, (Py_ssize_t)i, is_list, wraparound, boundscheck) :\
-    (is_list ? (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL) :\
-               __Pyx_GetItemInt_Generic(o, to_py_func(i))))
-#define __Pyx_GetItemInt_List(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_GetItemInt_List_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
-    (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL))
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
-                                                              int wraparound, int boundscheck);
-#define __Pyx_GetItemInt_Tuple(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_GetItemInt_Tuple_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
-    (PyErr_SetString(PyExc_IndexError, "tuple index out of range"), (PyObject*)NULL))
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
-                                                              int wraparound, int boundscheck);
-static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j);
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i,
-                                                     int is_list, int wraparound, int boundscheck);
-
 /* PyThreadStateGet.proto */
 #if CYTHON_FAST_THREAD_STATE
 #define __Pyx_PyThreadState_declare  PyThreadState *__pyx_tstate;
 #define __Pyx_PyThreadState_assign  __pyx_tstate = __Pyx_PyThreadState_Current;
 #define __Pyx_PyErr_Occurred()  __pyx_tstate->curexc_type
 #else
 #define __Pyx_PyThreadState_declare
@@ -1734,126 +1614,81 @@
 #define __Pyx_ErrFetchWithState(type, value, tb)  PyErr_Fetch(type, value, tb)
 #define __Pyx_ErrRestoreInState(tstate, type, value, tb)  PyErr_Restore(type, value, tb)
 #define __Pyx_ErrFetchInState(tstate, type, value, tb)  PyErr_Fetch(type, value, tb)
 #define __Pyx_ErrRestore(type, value, tb)  PyErr_Restore(type, value, tb)
 #define __Pyx_ErrFetch(type, value, tb)  PyErr_Fetch(type, value, tb)
 #endif
 
-/* WriteUnraisableException.proto */
-static void __Pyx_WriteUnraisable(const char *name, int clineno,
-                                  int lineno, const char *filename,
-                                  int full_traceback, int nogil);
-
-/* PyFunctionFastCall.proto */
-#if CYTHON_FAST_PYCALL
-#if !CYTHON_VECTORCALL
-#define __Pyx_PyFunction_FastCall(func, args, nargs)\
-    __Pyx_PyFunction_FastCallDict((func), (args), (nargs), NULL)
-static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs);
-#endif
-#define __Pyx_BUILD_ASSERT_EXPR(cond)\
-    (sizeof(char [1 - 2*!(cond)]) - 1)
-#ifndef Py_MEMBER_SIZE
-#define Py_MEMBER_SIZE(type, member) sizeof(((type *)0)->member)
-#endif
-#if !CYTHON_VECTORCALL
-  static size_t __pyx_pyframe_localsplus_offset = 0;
-  #include "frameobject.h"
-  #define __Pxy_PyFrame_Initialize_Offsets()\
-    ((void)__Pyx_BUILD_ASSERT_EXPR(sizeof(PyFrameObject) == offsetof(PyFrameObject, f_localsplus) + Py_MEMBER_SIZE(PyFrameObject, f_localsplus)),\
-     (void)(__pyx_pyframe_localsplus_offset = ((size_t)PyFrame_Type.tp_basicsize) - Py_MEMBER_SIZE(PyFrameObject, f_localsplus)))
-  #define __Pyx_PyFrame_GetLocalsplus(frame)\
-    (assert(__pyx_pyframe_localsplus_offset), (PyObject **)(((char *)(frame)) + __pyx_pyframe_localsplus_offset))
-#endif // !CYTHON_VECTORCALL
-#endif
-
-/* PyObjectCallMethO.proto */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg);
+/* PyObjectGetAttrStr.proto */
+#if CYTHON_USE_TYPE_SLOTS
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStr(PyObject* obj, PyObject* attr_name);
+#else
+#define __Pyx_PyObject_GetAttrStr(o,n) PyObject_GetAttr(o,n)
 #endif
 
-/* PyObjectFastCall.proto */
-#define __Pyx_PyObject_FastCall(func, args, nargs)  __Pyx_PyObject_FastCallDict(func, args, (size_t)(nargs), NULL)
-static CYTHON_INLINE PyObject* __Pyx_PyObject_FastCallDict(PyObject *func, PyObject **args, size_t nargs, PyObject *kwargs);
-
-/* PyObjectCallNoArg.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func);
-
-/* PyObjectCallOneArg.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg);
+/* PyObjectGetAttrStrNoError.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStrNoError(PyObject* obj, PyObject* attr_name);
 
-/* PyObjectGetMethod.proto */
-static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method);
+/* GetBuiltinName.proto */
+static PyObject *__Pyx_GetBuiltinName(PyObject *name);
 
-/* PyObjectCallMethod0.proto */
-static PyObject* __Pyx_PyObject_CallMethod0(PyObject* obj, PyObject* method_name);
+/* TupleAndListFromArray.proto */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_PyList_FromArray(PyObject *const *src, Py_ssize_t n);
+static CYTHON_INLINE PyObject* __Pyx_PyTuple_FromArray(PyObject *const *src, Py_ssize_t n);
+#endif
 
-/* RaiseNeedMoreValuesToUnpack.proto */
-static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index);
+/* IncludeStringH.proto */
+#include <string.h>
 
-/* RaiseTooManyValuesToUnpack.proto */
-static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected);
+/* BytesEquals.proto */
+static CYTHON_INLINE int __Pyx_PyBytes_Equals(PyObject* s1, PyObject* s2, int equals);
 
-/* UnpackItemEndCheck.proto */
-static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected);
+/* UnicodeEquals.proto */
+static CYTHON_INLINE int __Pyx_PyUnicode_Equals(PyObject* s1, PyObject* s2, int equals);
 
-/* RaiseNoneIterError.proto */
-static CYTHON_INLINE void __Pyx_RaiseNoneNotIterableError(void);
-
-/* UnpackTupleError.proto */
-static void __Pyx_UnpackTupleError(PyObject *, Py_ssize_t index);
-
-/* UnpackTuple2.proto */
-#define __Pyx_unpack_tuple2(tuple, value1, value2, is_tuple, has_known_size, decref_tuple)\
-    (likely(is_tuple || PyTuple_Check(tuple)) ?\
-        (likely(has_known_size || PyTuple_GET_SIZE(tuple) == 2) ?\
-            __Pyx_unpack_tuple2_exact(tuple, value1, value2, decref_tuple) :\
-            (__Pyx_UnpackTupleError(tuple, 2), -1)) :\
-        __Pyx_unpack_tuple2_generic(tuple, value1, value2, has_known_size, decref_tuple))
-static CYTHON_INLINE int __Pyx_unpack_tuple2_exact(
-    PyObject* tuple, PyObject** value1, PyObject** value2, int decref_tuple);
-static int __Pyx_unpack_tuple2_generic(
-    PyObject* tuple, PyObject** value1, PyObject** value2, int has_known_size, int decref_tuple);
-
-/* dict_iter.proto */
-static CYTHON_INLINE PyObject* __Pyx_dict_iterator(PyObject* dict, int is_dict, PyObject* method_name,
-                                                   Py_ssize_t* p_orig_length, int* p_is_dict);
-static CYTHON_INLINE int __Pyx_dict_iter_next(PyObject* dict_or_iter, Py_ssize_t orig_length, Py_ssize_t* ppos,
-                                              PyObject** pkey, PyObject** pvalue, PyObject** pitem, int is_dict);
-
-/* DictGetItem.proto */
-#if PY_MAJOR_VERSION >= 3 && !CYTHON_COMPILING_IN_PYPY
-static PyObject *__Pyx_PyDict_GetItem(PyObject *d, PyObject* key);
-#define __Pyx_PyObject_Dict_GetItem(obj, name)\
-    (likely(PyDict_CheckExact(obj)) ?\
-     __Pyx_PyDict_GetItem(obj, name) : PyObject_GetItem(obj, name))
+/* fastcall.proto */
+#define __Pyx_Arg_VARARGS(args, i) PyTuple_GET_ITEM(args, i)
+#define __Pyx_NumKwargs_VARARGS(kwds) PyDict_Size(kwds)
+#define __Pyx_KwValues_VARARGS(args, nargs) NULL
+#define __Pyx_GetKwValue_VARARGS(kw, kwvalues, s) __Pyx_PyDict_GetItemStrWithError(kw, s)
+#define __Pyx_KwargsAsDict_VARARGS(kw, kwvalues) PyDict_Copy(kw)
+#if CYTHON_METH_FASTCALL
+    #define __Pyx_Arg_FASTCALL(args, i) args[i]
+    #define __Pyx_NumKwargs_FASTCALL(kwds) PyTuple_GET_SIZE(kwds)
+    #define __Pyx_KwValues_FASTCALL(args, nargs) (&args[nargs])
+    static CYTHON_INLINE PyObject * __Pyx_GetKwValue_FASTCALL(PyObject *kwnames, PyObject *const *kwvalues, PyObject *s);
+    #define __Pyx_KwargsAsDict_FASTCALL(kw, kwvalues) _PyStack_AsDict(kwvalues, kw)
 #else
-#define __Pyx_PyDict_GetItem(d, key) PyObject_GetItem(d, key)
-#define __Pyx_PyObject_Dict_GetItem(obj, name)  PyObject_GetItem(obj, name)
+    #define __Pyx_Arg_FASTCALL __Pyx_Arg_VARARGS
+    #define __Pyx_NumKwargs_FASTCALL __Pyx_NumKwargs_VARARGS
+    #define __Pyx_KwValues_FASTCALL __Pyx_KwValues_VARARGS
+    #define __Pyx_GetKwValue_FASTCALL __Pyx_GetKwValue_VARARGS
+    #define __Pyx_KwargsAsDict_FASTCALL __Pyx_KwargsAsDict_VARARGS
 #endif
-
-/* KeywordStringCheck.proto */
-static int __Pyx_CheckKeywordStrings(PyObject *kw, const char* function_name, int kw_allowed);
-
-/* PyErrExceptionMatches.proto */
-#if CYTHON_FAST_THREAD_STATE
-#define __Pyx_PyErr_ExceptionMatches(err) __Pyx_PyErr_ExceptionMatchesInState(__pyx_tstate, err)
-static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err);
+#if CYTHON_COMPILING_IN_CPYTHON
+#define __Pyx_ArgsSlice_VARARGS(args, start, stop) __Pyx_PyTuple_FromArray(&__Pyx_Arg_VARARGS(args, start), stop - start)
+#define __Pyx_ArgsSlice_FASTCALL(args, start, stop) __Pyx_PyTuple_FromArray(&__Pyx_Arg_FASTCALL(args, start), stop - start)
 #else
-#define __Pyx_PyErr_ExceptionMatches(err)  PyErr_ExceptionMatches(err)
+#define __Pyx_ArgsSlice_VARARGS(args, start, stop) PyTuple_GetSlice(args, start, stop)
+#define __Pyx_ArgsSlice_FASTCALL(args, start, stop) PyTuple_GetSlice(args, start, stop)
 #endif
 
-/* GetAttr3.proto */
-static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *, PyObject *, PyObject *);
+/* RaiseDoubleKeywords.proto */
+static void __Pyx_RaiseDoubleKeywordsError(const char* func_name, PyObject* kw_name);
 
-/* PyObjectGetAttrStrNoError.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStrNoError(PyObject* obj, PyObject* attr_name);
+/* ParseKeywords.proto */
+static int __Pyx_ParseOptionalKeywords(PyObject *kwds, PyObject *const *kwvalues,
+    PyObject **argnames[],
+    PyObject *kwds2, PyObject *values[], Py_ssize_t num_pos_args,
+    const char* function_name);
 
-/* GetBuiltinName.proto */
-static PyObject *__Pyx_GetBuiltinName(PyObject *name);
+/* RaiseArgTupleInvalid.proto */
+static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
+    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
 
 /* PyDictVersioning.proto */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
 #define __PYX_DICT_VERSION_INIT  ((PY_UINT64_T) -1)
 #define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
 #define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
     (version_var) = __PYX_GET_DICT_VERSION(dict);\
@@ -1894,31 +1729,53 @@
 static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value);
 #else
 #define __Pyx_GetModuleGlobalName(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
 #define __Pyx_GetModuleGlobalNameUncached(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
 static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name);
 #endif
 
-/* RaiseUnexpectedTypeError.proto */
-static int __Pyx_RaiseUnexpectedTypeError(const char *expected, PyObject *obj);
+/* PyObjectCall.proto */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
+#else
+#define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
+#endif
 
-/* Import.proto */
-static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
+/* ExtTypeTest.proto */
+static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type);
 
-/* ImportFrom.proto */
-static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name);
+/* SliceObject.proto */
+#define __Pyx_PyObject_DelSlice(obj, cstart, cstop, py_start, py_stop, py_slice, has_cstart, has_cstop, wraparound)\
+    __Pyx_PyObject_SetSlice(obj, (PyObject*)NULL, cstart, cstop, py_start, py_stop, py_slice, has_cstart, has_cstop, wraparound)
+static CYTHON_INLINE int __Pyx_PyObject_SetSlice(
+        PyObject* obj, PyObject* value, Py_ssize_t cstart, Py_ssize_t cstop,
+        PyObject** py_start, PyObject** py_stop, PyObject** py_slice,
+        int has_cstart, int has_cstop, int wraparound);
+
+/* PyIntCompare.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_NeObjC(PyObject *op1, PyObject *op2, long intval, long inplace);
+
+/* PyIntBinop.proto */
+#if !CYTHON_COMPILING_IN_PYPY
+static PyObject* __Pyx_PyInt_SubtractObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check);
+#else
+#define __Pyx_PyInt_SubtractObjC(op1, op2, intval, inplace, zerodivision_check)\
+    (inplace ? PyNumber_InPlaceSubtract(op1, op2) : PyNumber_Subtract(op1, op2))
+#endif
+
+/* WriteUnraisableException.proto */
+static void __Pyx_WriteUnraisable(const char *name, int clineno,
+                                  int lineno, const char *filename,
+                                  int full_traceback, int nogil);
 
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
-/* GetAttr.proto */
-static CYTHON_INLINE PyObject *__Pyx_GetAttr(PyObject *, PyObject *);
-
-/* HasAttr.proto */
-static CYTHON_INLINE int __Pyx_HasAttr(PyObject *, PyObject *);
+/* KeywordStringCheck.proto */
+static int __Pyx_CheckKeywordStrings(PyObject *kw, const char* function_name, int kw_allowed);
 
 /* GetTopmostException.proto */
 #if CYTHON_USE_EXC_INFO_STACK
 static _PyErr_StackItem * __Pyx_PyErr_GetTopmostException(PyThreadState *tstate);
 #endif
 
 /* SaveResetException.proto */
@@ -1944,14 +1801,58 @@
 #include <structmember.h>
 
 /* FixUpExtensionType.proto */
 #if CYTHON_USE_TYPE_SPECS
 static int __Pyx_fix_up_extension_type_from_spec(PyType_Spec *spec, PyTypeObject *type);
 #endif
 
+/* PyFunctionFastCall.proto */
+#if CYTHON_FAST_PYCALL
+#if !CYTHON_VECTORCALL
+#define __Pyx_PyFunction_FastCall(func, args, nargs)\
+    __Pyx_PyFunction_FastCallDict((func), (args), (nargs), NULL)
+static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs);
+#endif
+#define __Pyx_BUILD_ASSERT_EXPR(cond)\
+    (sizeof(char [1 - 2*!(cond)]) - 1)
+#ifndef Py_MEMBER_SIZE
+#define Py_MEMBER_SIZE(type, member) sizeof(((type *)0)->member)
+#endif
+#if !CYTHON_VECTORCALL
+  static size_t __pyx_pyframe_localsplus_offset = 0;
+  #include "frameobject.h"
+  #define __Pxy_PyFrame_Initialize_Offsets()\
+    ((void)__Pyx_BUILD_ASSERT_EXPR(sizeof(PyFrameObject) == offsetof(PyFrameObject, f_localsplus) + Py_MEMBER_SIZE(PyFrameObject, f_localsplus)),\
+     (void)(__pyx_pyframe_localsplus_offset = ((size_t)PyFrame_Type.tp_basicsize) - Py_MEMBER_SIZE(PyFrameObject, f_localsplus)))
+  #define __Pyx_PyFrame_GetLocalsplus(frame)\
+    (assert(__pyx_pyframe_localsplus_offset), (PyObject **)(((char *)(frame)) + __pyx_pyframe_localsplus_offset))
+#endif // !CYTHON_VECTORCALL
+#endif
+
+/* PyObjectCallMethO.proto */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg);
+#endif
+
+/* PyObjectFastCall.proto */
+#define __Pyx_PyObject_FastCall(func, args, nargs)  __Pyx_PyObject_FastCallDict(func, args, (size_t)(nargs), NULL)
+static CYTHON_INLINE PyObject* __Pyx_PyObject_FastCallDict(PyObject *func, PyObject **args, size_t nargs, PyObject *kwargs);
+
+/* PyObjectCallNoArg.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func);
+
+/* PyObjectCallOneArg.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg);
+
+/* PyObjectGetMethod.proto */
+static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method);
+
+/* PyObjectCallMethod0.proto */
+static PyObject* __Pyx_PyObject_CallMethod0(PyObject* obj, PyObject* method_name);
+
 /* ValidateBasesTuple.proto */
 #if CYTHON_COMPILING_IN_CPYTHON || CYTHON_COMPILING_IN_LIMITED_API || CYTHON_USE_TYPE_SPECS
 static int __Pyx_validate_bases_tuple(const char *type_name, Py_ssize_t dictoffset, PyObject *bases);
 #endif
 
 /* PyType_Ready.proto */
 static CYTHON_UNUSED int __Pyx_PyType_Ready(PyTypeObject *t);
@@ -1993,14 +1894,17 @@
    __Pyx_ImportType_CheckSize_Error = 0,
    __Pyx_ImportType_CheckSize_Warn = 1,
    __Pyx_ImportType_CheckSize_Ignore = 2
 };
 static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, enum __Pyx_ImportType_CheckSize check_size);
 #endif
 
+/* Import.proto */
+static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
+
 /* ImportDottedModule.proto */
 static PyObject *__Pyx_ImportDottedModule(PyObject *name, PyObject *parts_tuple);
 
 /* FetchCommonType.proto */
 #if !CYTHON_USE_TYPE_SPECS
 static PyTypeObject* __Pyx_FetchCommonType(PyTypeObject* type);
 #else
@@ -2142,19 +2046,14 @@
 static void __pyx_insert_code_object(int code_line, PyCodeObject* code_object);
 #endif
 
 /* AddTraceback.proto */
 static void __Pyx_AddTraceback(const char *funcname, int c_line,
                                int py_line, const char *filename);
 
-/* GCCDiagnostics.proto */
-#if defined(__GNUC__) && (__GNUC__ > 4 || (__GNUC__ == 4 && __GNUC_MINOR__ >= 6))
-#define __Pyx_HAS_GCC_DIAGNOSTIC
-#endif
-
 /* RealImag.proto */
 #if CYTHON_CCOMPLEX
   #ifdef __cplusplus
     #define __Pyx_CREAL(z) ((z).real())
     #define __Pyx_CIMAG(z) ((z).imag())
   #else
     #define __Pyx_CREAL(z) (__real__(z))
@@ -2245,36 +2144,41 @@
     static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_conj_double(__pyx_t_double_complex);
     #if 1
         static CYTHON_INLINE double __Pyx_c_abs_double(__pyx_t_double_complex);
         static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_pow_double(__pyx_t_double_complex, __pyx_t_double_complex);
     #endif
 #endif
 
-/* CIntFromPy.proto */
-static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);
-
-/* CIntFromPy.proto */
-static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);
-
-/* CIntToPy.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
-
 /* FormatTypeName.proto */
 #if CYTHON_COMPILING_IN_LIMITED_API
 typedef PyObject *__Pyx_TypeName;
 #define __Pyx_FMT_TYPENAME "%U"
 static __Pyx_TypeName __Pyx_PyType_GetName(PyTypeObject* tp);
 #define __Pyx_DECREF_TypeName(obj) Py_XDECREF(obj)
 #else
 typedef const char *__Pyx_TypeName;
 #define __Pyx_FMT_TYPENAME "%.200s"
 #define __Pyx_PyType_GetName(tp) ((tp)->tp_name)
 #define __Pyx_DECREF_TypeName(obj)
 #endif
 
+/* GCCDiagnostics.proto */
+#if defined(__GNUC__) && (__GNUC__ > 4 || (__GNUC__ == 4 && __GNUC_MINOR__ >= 6))
+#define __Pyx_HAS_GCC_DIAGNOSTIC
+#endif
+
+/* CIntToPy.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
+
+/* CIntFromPy.proto */
+static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);
+
+/* CIntFromPy.proto */
+static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);
+
 /* FastTypeChecks.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 #define __Pyx_TypeCheck(obj, type) __Pyx_IsSubtype(Py_TYPE(obj), (PyTypeObject *)type)
 #define __Pyx_TypeCheck2(obj, type1, type2) __Pyx_IsAnySubtype2(Py_TYPE(obj), (PyTypeObject *)type1, (PyTypeObject *)type2)
 static CYTHON_INLINE int __Pyx_IsSubtype(PyTypeObject *a, PyTypeObject *b);
 static CYTHON_INLINE int __Pyx_IsAnySubtype2(PyTypeObject *cls, PyTypeObject *a, PyTypeObject *b);
 static CYTHON_INLINE int __Pyx_PyErr_GivenExceptionMatches(PyObject *err, PyObject *type);
@@ -2295,18 +2199,18 @@
 #if CYTHON_COMPILING_IN_LIMITED_API
 static int __Pyx_InitString(__Pyx_StringTabEntry t, PyObject **str);
 #else
 static int __Pyx_InitStrings(__Pyx_StringTabEntry *t);
 #endif
 
 /* #### Code section: module_declarations ### */
-static void __pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation__amalgamate(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_size, __pyx_t_5numpy_intp_t __pyx_v_clusters, PyObject *__pyx_v_o_energies); /* proto*/
-static struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_merge_amalgamations(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, CYTHON_UNUSED __pyx_t_5numpy_double_t __pyx_v_g, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_other, __pyx_t_5numpy_double_t __pyx_v_jump1, __pyx_t_5numpy_double_t __pyx_v_jump2); /* proto*/
-static __pyx_t_5numpy_double_t __pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_border_overcoming(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, __pyx_t_5numpy_double_t __pyx_v_g, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_other, __pyx_t_5numpy_double_t __pyx_v_PRECISION); /* proto*/
-static __pyx_t_5numpy_double_t __pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_border_overcoming_rev(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, __pyx_t_5numpy_double_t __pyx_v_g, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_other, __pyx_t_5numpy_double_t __pyx_v_PRECISION); /* proto*/
+static __pyx_t_5numpy_intp_t __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_nullify(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self); /* proto*/
+static __pyx_t_5numpy_intp_t __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_mark_up(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n); /* proto*/
+static __pyx_t_5numpy_intp_t __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_is_same_parent(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_p, __pyx_t_5numpy_intp_t __pyx_v_on); /* proto*/
+static void __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_union(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n, __pyx_t_5numpy_intp_t __pyx_v_on, __pyx_t_5numpy_intp_t __pyx_v_p, __pyx_t_5numpy_intp_t __pyx_v_op); /* proto*/
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_7ndarray_4base_base(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE PyArray_Descr *__pyx_f_5numpy_7ndarray_5descr_descr(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE int __pyx_f_5numpy_7ndarray_4ndim_ndim(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp *__pyx_f_5numpy_7ndarray_5shape_shape(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp *__pyx_f_5numpy_7ndarray_7strides_strides(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp __pyx_f_5numpy_7ndarray_4size_size(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE char *__pyx_f_5numpy_7ndarray_4data_data(PyArrayObject *__pyx_v_self); /* proto*/
@@ -2359,164 +2263,151 @@
 static PyTypeObject *__pyx_ptype_5numpy_floating = 0;
 static PyTypeObject *__pyx_ptype_5numpy_complexfloating = 0;
 static PyTypeObject *__pyx_ptype_5numpy_flexible = 0;
 static PyTypeObject *__pyx_ptype_5numpy_character = 0;
 static PyTypeObject *__pyx_ptype_5numpy_ufunc = 0;
 #endif
 
-/* Module declarations from "libc.math" */
+/* Module declarations from "druhg._druhg_unionfind" */
 #if !CYTHON_USE_MODULE_STATE
+static PyTypeObject *__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = 0;
 #endif
-
-/* Module declarations from "druhg._druhg_amalgamation" */
-#if !CYTHON_USE_MODULE_STATE
-static PyTypeObject *__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation = 0;
-#endif
-static PyObject *__pyx_f_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation__set_state(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, PyObject *); /*proto*/
 /* #### Code section: typeinfo ### */
 /* #### Code section: before_global_var ### */
-#define __Pyx_MODULE_NAME "druhg._druhg_amalgamation"
-extern int __pyx_module_is_main_druhg___druhg_amalgamation;
-int __pyx_module_is_main_druhg___druhg_amalgamation = 0;
+#define __Pyx_MODULE_NAME "druhg._druhg_unionfind"
+extern int __pyx_module_is_main_druhg___druhg_unionfind;
+int __pyx_module_is_main_druhg___druhg_unionfind = 0;
 
-/* Implementation of "druhg._druhg_amalgamation" */
+/* Implementation of "druhg._druhg_unionfind" */
 /* #### Code section: global_var ### */
+static PyObject *__pyx_builtin_print;
+static PyObject *__pyx_builtin_AssertionError;
+static PyObject *__pyx_builtin_TypeError;
 static PyObject *__pyx_builtin_ImportError;
 /* #### Code section: string_decls ### */
-static const char __pyx_k__2[] = ".";
-static const char __pyx_k__5[] = "*";
+static const char __pyx_k_N[] = "N";
+static const char __pyx_k__4[] = "*";
 static const char __pyx_k_gc[] = "gc";
 static const char __pyx_k_np[] = "np";
-static const char __pyx_k__12[] = "?";
-static const char __pyx_k_get[] = "get";
-static const char __pyx_k_new[] = "__new__";
-static const char __pyx_k_sys[] = "sys";
-static const char __pyx_k_dict[] = "__dict__";
+static const char __pyx_k__11[] = "?";
+static const char __pyx_k_intp[] = "intp";
 static const char __pyx_k_main[] = "__main__";
 static const char __pyx_k_name[] = "__name__";
 static const char __pyx_k_self[] = "self";
-static const char __pyx_k_size[] = "size";
 static const char __pyx_k_spec[] = "__spec__";
 static const char __pyx_k_test[] = "__test__";
+static const char __pyx_k_dtype[] = "dtype";
 static const char __pyx_k_numpy[] = "numpy";
-static const char __pyx_k_state[] = "state";
-static const char __pyx_k_dict_2[] = "_dict";
+static const char __pyx_k_print[] = "print";
+static const char __pyx_k_zeros[] = "zeros";
 static const char __pyx_k_enable[] = "enable";
 static const char __pyx_k_import[] = "__import__";
-static const char __pyx_k_pickle[] = "pickle";
 static const char __pyx_k_reduce[] = "__reduce__";
-static const char __pyx_k_update[] = "update";
 static const char __pyx_k_disable[] = "disable";
-static const char __pyx_k_clusters[] = "clusters";
 static const char __pyx_k_getstate[] = "__getstate__";
-static const char __pyx_k_pyx_type[] = "__pyx_type";
 static const char __pyx_k_setstate[] = "__setstate__";
+static const char __pyx_k_TypeError[] = "TypeError";
+static const char __pyx_k_UnionFind[] = "UnionFind";
 static const char __pyx_k_isenabled[] = "isenabled";
 static const char __pyx_k_pyx_state[] = "__pyx_state";
 static const char __pyx_k_reduce_ex[] = "__reduce_ex__";
-static const char __pyx_k_pyx_result[] = "__pyx_result";
 static const char __pyx_k_pyx_vtable[] = "__pyx_vtable__";
 static const char __pyx_k_ImportError[] = "ImportError";
-static const char __pyx_k_PickleError[] = "PickleError";
-static const char __pyx_k_Amalgamation[] = "Amalgamation";
+static const char __pyx_k_buffer_fast[] = "buffer_fast";
 static const char __pyx_k_initializing[] = "_initializing";
 static const char __pyx_k_is_coroutine[] = "_is_coroutine";
-static const char __pyx_k_pyx_checksum[] = "__pyx_checksum";
 static const char __pyx_k_stringsource[] = "<stringsource>";
-static const char __pyx_k_use_setstate[] = "use_setstate";
 static const char __pyx_k_reduce_cython[] = "__reduce_cython__";
-static const char __pyx_k_pyx_PickleError[] = "__pyx_PickleError";
+static const char __pyx_k_AssertionError[] = "AssertionError";
+static const char __pyx_k_buffer_parents[] = "buffer_parents";
 static const char __pyx_k_setstate_cython[] = "__setstate_cython__";
 static const char __pyx_k_asyncio_coroutines[] = "asyncio.coroutines";
 static const char __pyx_k_cline_in_traceback[] = "cline_in_traceback";
-static const char __pyx_k_druhg__druhg_amalgamation[] = "druhg._druhg_amalgamation";
-static const char __pyx_k_pyx_unpickle_Amalgamation[] = "__pyx_unpickle_Amalgamation";
-static const char __pyx_k_Amalgamation___reduce_cython[] = "Amalgamation.__reduce_cython__";
-static const char __pyx_k_Amalgamation___setstate_cython[] = "Amalgamation.__setstate_cython__";
+static const char __pyx_k_druhg__druhg_unionfind[] = "druhg._druhg_unionfind";
+static const char __pyx_k_allocate_unionfind_pair[] = "allocate_unionfind_pair";
+static const char __pyx_k_UnionFind___reduce_cython[] = "UnionFind.__reduce_cython__";
+static const char __pyx_k_druhg__druhg_unionfind_pyx[] = "druhg\\_druhg_unionfind.pyx";
+static const char __pyx_k_ERROR_fast_arr_is_too_small[] = "ERROR: fast_arr is too small";
+static const char __pyx_k_UnionFind___setstate_cython[] = "UnionFind.__setstate_cython__";
+static const char __pyx_k_ERROR_buffer_was_not_provided[] = "ERROR: buffer was not provided";
+static const char __pyx_k_ERROR_parent_arr_is_too_small[] = "ERROR: parent_arr is too small";
 static const char __pyx_k_numpy_core_multiarray_failed_to[] = "numpy.core.multiarray failed to import";
-static const char __pyx_k_Incompatible_checksums_s_vs_0xad[] = "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))";
+static const char __pyx_k_self_fast_self_parent_cannot_be[] = "self.fast,self.parent cannot be converted to a Python object for pickling";
 static const char __pyx_k_numpy_core_umath_failed_to_impor[] = "numpy.core.umath failed to import";
 #if !CYTHON_USE_MODULE_STATE
-static PyObject *__pyx_n_s_Amalgamation;
-static PyObject *__pyx_n_s_Amalgamation___reduce_cython;
-static PyObject *__pyx_n_s_Amalgamation___setstate_cython;
+static PyObject *__pyx_n_s_AssertionError;
+static PyObject *__pyx_kp_u_ERROR_buffer_was_not_provided;
+static PyObject *__pyx_kp_u_ERROR_fast_arr_is_too_small;
+static PyObject *__pyx_kp_u_ERROR_parent_arr_is_too_small;
 static PyObject *__pyx_n_s_ImportError;
-static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xad;
-static PyObject *__pyx_n_s_PickleError;
-static PyObject *__pyx_n_s__12;
-static PyObject *__pyx_kp_u__2;
-static PyObject *__pyx_n_s__5;
+static PyObject *__pyx_n_s_N;
+static PyObject *__pyx_n_s_TypeError;
+static PyObject *__pyx_n_s_UnionFind;
+static PyObject *__pyx_n_s_UnionFind___reduce_cython;
+static PyObject *__pyx_n_s_UnionFind___setstate_cython;
+static PyObject *__pyx_n_s__11;
+static PyObject *__pyx_n_s__4;
+static PyObject *__pyx_n_s_allocate_unionfind_pair;
 static PyObject *__pyx_n_s_asyncio_coroutines;
+static PyObject *__pyx_n_s_buffer_fast;
+static PyObject *__pyx_n_s_buffer_parents;
 static PyObject *__pyx_n_s_cline_in_traceback;
-static PyObject *__pyx_n_s_clusters;
-static PyObject *__pyx_n_s_dict;
-static PyObject *__pyx_n_s_dict_2;
 static PyObject *__pyx_kp_u_disable;
-static PyObject *__pyx_n_s_druhg__druhg_amalgamation;
+static PyObject *__pyx_n_s_druhg__druhg_unionfind;
+static PyObject *__pyx_kp_s_druhg__druhg_unionfind_pyx;
+static PyObject *__pyx_n_s_dtype;
 static PyObject *__pyx_kp_u_enable;
 static PyObject *__pyx_kp_u_gc;
-static PyObject *__pyx_n_s_get;
 static PyObject *__pyx_n_s_getstate;
 static PyObject *__pyx_n_s_import;
 static PyObject *__pyx_n_s_initializing;
+static PyObject *__pyx_n_s_intp;
 static PyObject *__pyx_n_s_is_coroutine;
 static PyObject *__pyx_kp_u_isenabled;
 static PyObject *__pyx_n_s_main;
 static PyObject *__pyx_n_s_name;
-static PyObject *__pyx_n_s_new;
 static PyObject *__pyx_n_s_np;
 static PyObject *__pyx_n_s_numpy;
 static PyObject *__pyx_kp_u_numpy_core_multiarray_failed_to;
 static PyObject *__pyx_kp_u_numpy_core_umath_failed_to_impor;
-static PyObject *__pyx_n_s_pickle;
-static PyObject *__pyx_n_s_pyx_PickleError;
-static PyObject *__pyx_n_s_pyx_checksum;
-static PyObject *__pyx_n_s_pyx_result;
+static PyObject *__pyx_n_s_print;
 static PyObject *__pyx_n_s_pyx_state;
-static PyObject *__pyx_n_s_pyx_type;
-static PyObject *__pyx_n_s_pyx_unpickle_Amalgamation;
 static PyObject *__pyx_n_s_pyx_vtable;
 static PyObject *__pyx_n_s_reduce;
 static PyObject *__pyx_n_s_reduce_cython;
 static PyObject *__pyx_n_s_reduce_ex;
 static PyObject *__pyx_n_s_self;
+static PyObject *__pyx_kp_s_self_fast_self_parent_cannot_be;
 static PyObject *__pyx_n_s_setstate;
 static PyObject *__pyx_n_s_setstate_cython;
-static PyObject *__pyx_n_s_size;
 static PyObject *__pyx_n_s_spec;
-static PyObject *__pyx_n_s_state;
 static PyObject *__pyx_kp_s_stringsource;
-static PyObject *__pyx_n_s_sys;
 static PyObject *__pyx_n_s_test;
-static PyObject *__pyx_n_s_update;
-static PyObject *__pyx_n_s_use_setstate;
+static PyObject *__pyx_n_s_zeros;
 #endif
 /* #### Code section: decls ### */
-static int __pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation___init__(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, int __pyx_v_size, int __pyx_v_clusters); /* proto */
-static PyObject *__pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation_2__reduce_cython__(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation_4__setstate_cython__(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_tp_new_5druhg_19_druhg_amalgamation_Amalgamation(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
-static __Pyx_CachedCFunction __pyx_umethod_PyDict_Type_get = {0, 0, 0, 0, 0};
+static PyObject *__pyx_pf_5druhg_16_druhg_unionfind_allocate_unionfind_pair(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_N); /* proto */
+static int __pyx_pf_5druhg_16_druhg_unionfind_9UnionFind___init__(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_N, PyObject *__pyx_v_buffer_parents, PyObject *__pyx_v_buffer_fast); /* proto */
+static PyObject *__pyx_pf_5druhg_16_druhg_unionfind_9UnionFind_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_5druhg_16_druhg_unionfind_9UnionFind_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_tp_new_5druhg_16_druhg_unionfind_UnionFind(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 #if !CYTHON_USE_MODULE_STATE
-static PyObject *__pyx_float_0_;
-static PyObject *__pyx_float_1_;
 static PyObject *__pyx_int_0;
-static PyObject *__pyx_int_182298202;
+static PyObject *__pyx_int_1;
 #endif
 #if !CYTHON_USE_MODULE_STATE
 static PyObject *__pyx_tuple_;
+static PyObject *__pyx_tuple__2;
 static PyObject *__pyx_tuple__3;
-static PyObject *__pyx_tuple__4;
-static PyObject *__pyx_tuple__6;
-static PyObject *__pyx_tuple__8;
-static PyObject *__pyx_tuple__10;
-static PyObject *__pyx_codeobj__7;
-static PyObject *__pyx_codeobj__9;
-static PyObject *__pyx_codeobj__11;
+static PyObject *__pyx_tuple__5;
+static PyObject *__pyx_tuple__7;
+static PyObject *__pyx_tuple__9;
+static PyObject *__pyx_codeobj__6;
+static PyObject *__pyx_codeobj__8;
+static PyObject *__pyx_codeobj__10;
 #endif
 /* #### Code section: late_includes ### */
 /* #### Code section: module_state ### */
 #if CYTHON_USE_MODULE_STATE
 typedef struct {
   PyObject *__pyx_d;
   PyObject *__pyx_b;
@@ -2542,82 +2433,76 @@
   PyTypeObject *__pyx_ptype_5numpy_unsignedinteger;
   PyTypeObject *__pyx_ptype_5numpy_inexact;
   PyTypeObject *__pyx_ptype_5numpy_floating;
   PyTypeObject *__pyx_ptype_5numpy_complexfloating;
   PyTypeObject *__pyx_ptype_5numpy_flexible;
   PyTypeObject *__pyx_ptype_5numpy_character;
   PyTypeObject *__pyx_ptype_5numpy_ufunc;
-  PyTypeObject *__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation;
-  PyObject *__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation;
-  PyObject *__pyx_n_s_Amalgamation;
-  PyObject *__pyx_n_s_Amalgamation___reduce_cython;
-  PyObject *__pyx_n_s_Amalgamation___setstate_cython;
+  PyTypeObject *__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind;
+  PyObject *__pyx_type_5druhg_16_druhg_unionfind_UnionFind;
+  PyObject *__pyx_n_s_AssertionError;
+  PyObject *__pyx_kp_u_ERROR_buffer_was_not_provided;
+  PyObject *__pyx_kp_u_ERROR_fast_arr_is_too_small;
+  PyObject *__pyx_kp_u_ERROR_parent_arr_is_too_small;
   PyObject *__pyx_n_s_ImportError;
-  PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xad;
-  PyObject *__pyx_n_s_PickleError;
-  PyObject *__pyx_n_s__12;
-  PyObject *__pyx_kp_u__2;
-  PyObject *__pyx_n_s__5;
+  PyObject *__pyx_n_s_N;
+  PyObject *__pyx_n_s_TypeError;
+  PyObject *__pyx_n_s_UnionFind;
+  PyObject *__pyx_n_s_UnionFind___reduce_cython;
+  PyObject *__pyx_n_s_UnionFind___setstate_cython;
+  PyObject *__pyx_n_s__11;
+  PyObject *__pyx_n_s__4;
+  PyObject *__pyx_n_s_allocate_unionfind_pair;
   PyObject *__pyx_n_s_asyncio_coroutines;
+  PyObject *__pyx_n_s_buffer_fast;
+  PyObject *__pyx_n_s_buffer_parents;
   PyObject *__pyx_n_s_cline_in_traceback;
-  PyObject *__pyx_n_s_clusters;
-  PyObject *__pyx_n_s_dict;
-  PyObject *__pyx_n_s_dict_2;
   PyObject *__pyx_kp_u_disable;
-  PyObject *__pyx_n_s_druhg__druhg_amalgamation;
+  PyObject *__pyx_n_s_druhg__druhg_unionfind;
+  PyObject *__pyx_kp_s_druhg__druhg_unionfind_pyx;
+  PyObject *__pyx_n_s_dtype;
   PyObject *__pyx_kp_u_enable;
   PyObject *__pyx_kp_u_gc;
-  PyObject *__pyx_n_s_get;
   PyObject *__pyx_n_s_getstate;
   PyObject *__pyx_n_s_import;
   PyObject *__pyx_n_s_initializing;
+  PyObject *__pyx_n_s_intp;
   PyObject *__pyx_n_s_is_coroutine;
   PyObject *__pyx_kp_u_isenabled;
   PyObject *__pyx_n_s_main;
   PyObject *__pyx_n_s_name;
-  PyObject *__pyx_n_s_new;
   PyObject *__pyx_n_s_np;
   PyObject *__pyx_n_s_numpy;
   PyObject *__pyx_kp_u_numpy_core_multiarray_failed_to;
   PyObject *__pyx_kp_u_numpy_core_umath_failed_to_impor;
-  PyObject *__pyx_n_s_pickle;
-  PyObject *__pyx_n_s_pyx_PickleError;
-  PyObject *__pyx_n_s_pyx_checksum;
-  PyObject *__pyx_n_s_pyx_result;
+  PyObject *__pyx_n_s_print;
   PyObject *__pyx_n_s_pyx_state;
-  PyObject *__pyx_n_s_pyx_type;
-  PyObject *__pyx_n_s_pyx_unpickle_Amalgamation;
   PyObject *__pyx_n_s_pyx_vtable;
   PyObject *__pyx_n_s_reduce;
   PyObject *__pyx_n_s_reduce_cython;
   PyObject *__pyx_n_s_reduce_ex;
   PyObject *__pyx_n_s_self;
+  PyObject *__pyx_kp_s_self_fast_self_parent_cannot_be;
   PyObject *__pyx_n_s_setstate;
   PyObject *__pyx_n_s_setstate_cython;
-  PyObject *__pyx_n_s_size;
   PyObject *__pyx_n_s_spec;
-  PyObject *__pyx_n_s_state;
   PyObject *__pyx_kp_s_stringsource;
-  PyObject *__pyx_n_s_sys;
   PyObject *__pyx_n_s_test;
-  PyObject *__pyx_n_s_update;
-  PyObject *__pyx_n_s_use_setstate;
-  PyObject *__pyx_float_0_;
-  PyObject *__pyx_float_1_;
+  PyObject *__pyx_n_s_zeros;
   PyObject *__pyx_int_0;
-  PyObject *__pyx_int_182298202;
+  PyObject *__pyx_int_1;
   PyObject *__pyx_tuple_;
+  PyObject *__pyx_tuple__2;
   PyObject *__pyx_tuple__3;
-  PyObject *__pyx_tuple__4;
-  PyObject *__pyx_tuple__6;
-  PyObject *__pyx_tuple__8;
-  PyObject *__pyx_tuple__10;
-  PyObject *__pyx_codeobj__7;
-  PyObject *__pyx_codeobj__9;
-  PyObject *__pyx_codeobj__11;
+  PyObject *__pyx_tuple__5;
+  PyObject *__pyx_tuple__7;
+  PyObject *__pyx_tuple__9;
+  PyObject *__pyx_codeobj__6;
+  PyObject *__pyx_codeobj__8;
+  PyObject *__pyx_codeobj__10;
 } __pyx_mstate;
 
 #ifdef __cplusplus
 namespace {
   extern struct PyModuleDef __pyx_moduledef;
 } /* anonymous namespace */
 #else
@@ -2659,82 +2544,76 @@
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_unsignedinteger);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_inexact);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_floating);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_complexfloating);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_flexible);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_character);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_ufunc);
-  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation);
-  Py_CLEAR(clear_module_state->__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation);
-  Py_CLEAR(clear_module_state->__pyx_n_s_Amalgamation);
-  Py_CLEAR(clear_module_state->__pyx_n_s_Amalgamation___reduce_cython);
-  Py_CLEAR(clear_module_state->__pyx_n_s_Amalgamation___setstate_cython);
+  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind);
+  Py_CLEAR(clear_module_state->__pyx_type_5druhg_16_druhg_unionfind_UnionFind);
+  Py_CLEAR(clear_module_state->__pyx_n_s_AssertionError);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_buffer_was_not_provided);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_fast_arr_is_too_small);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_parent_arr_is_too_small);
   Py_CLEAR(clear_module_state->__pyx_n_s_ImportError);
-  Py_CLEAR(clear_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0xad);
-  Py_CLEAR(clear_module_state->__pyx_n_s_PickleError);
-  Py_CLEAR(clear_module_state->__pyx_n_s__12);
-  Py_CLEAR(clear_module_state->__pyx_kp_u__2);
-  Py_CLEAR(clear_module_state->__pyx_n_s__5);
+  Py_CLEAR(clear_module_state->__pyx_n_s_N);
+  Py_CLEAR(clear_module_state->__pyx_n_s_TypeError);
+  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind);
+  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind___reduce_cython);
+  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind___setstate_cython);
+  Py_CLEAR(clear_module_state->__pyx_n_s__11);
+  Py_CLEAR(clear_module_state->__pyx_n_s__4);
+  Py_CLEAR(clear_module_state->__pyx_n_s_allocate_unionfind_pair);
   Py_CLEAR(clear_module_state->__pyx_n_s_asyncio_coroutines);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_fast);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_parents);
   Py_CLEAR(clear_module_state->__pyx_n_s_cline_in_traceback);
-  Py_CLEAR(clear_module_state->__pyx_n_s_clusters);
-  Py_CLEAR(clear_module_state->__pyx_n_s_dict);
-  Py_CLEAR(clear_module_state->__pyx_n_s_dict_2);
   Py_CLEAR(clear_module_state->__pyx_kp_u_disable);
-  Py_CLEAR(clear_module_state->__pyx_n_s_druhg__druhg_amalgamation);
+  Py_CLEAR(clear_module_state->__pyx_n_s_druhg__druhg_unionfind);
+  Py_CLEAR(clear_module_state->__pyx_kp_s_druhg__druhg_unionfind_pyx);
+  Py_CLEAR(clear_module_state->__pyx_n_s_dtype);
   Py_CLEAR(clear_module_state->__pyx_kp_u_enable);
   Py_CLEAR(clear_module_state->__pyx_kp_u_gc);
-  Py_CLEAR(clear_module_state->__pyx_n_s_get);
   Py_CLEAR(clear_module_state->__pyx_n_s_getstate);
   Py_CLEAR(clear_module_state->__pyx_n_s_import);
   Py_CLEAR(clear_module_state->__pyx_n_s_initializing);
+  Py_CLEAR(clear_module_state->__pyx_n_s_intp);
   Py_CLEAR(clear_module_state->__pyx_n_s_is_coroutine);
   Py_CLEAR(clear_module_state->__pyx_kp_u_isenabled);
   Py_CLEAR(clear_module_state->__pyx_n_s_main);
   Py_CLEAR(clear_module_state->__pyx_n_s_name);
-  Py_CLEAR(clear_module_state->__pyx_n_s_new);
   Py_CLEAR(clear_module_state->__pyx_n_s_np);
   Py_CLEAR(clear_module_state->__pyx_n_s_numpy);
   Py_CLEAR(clear_module_state->__pyx_kp_u_numpy_core_multiarray_failed_to);
   Py_CLEAR(clear_module_state->__pyx_kp_u_numpy_core_umath_failed_to_impor);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pickle);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pyx_PickleError);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pyx_checksum);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pyx_result);
+  Py_CLEAR(clear_module_state->__pyx_n_s_print);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_state);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pyx_type);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pyx_unpickle_Amalgamation);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_vtable);
   Py_CLEAR(clear_module_state->__pyx_n_s_reduce);
   Py_CLEAR(clear_module_state->__pyx_n_s_reduce_cython);
   Py_CLEAR(clear_module_state->__pyx_n_s_reduce_ex);
   Py_CLEAR(clear_module_state->__pyx_n_s_self);
+  Py_CLEAR(clear_module_state->__pyx_kp_s_self_fast_self_parent_cannot_be);
   Py_CLEAR(clear_module_state->__pyx_n_s_setstate);
   Py_CLEAR(clear_module_state->__pyx_n_s_setstate_cython);
-  Py_CLEAR(clear_module_state->__pyx_n_s_size);
   Py_CLEAR(clear_module_state->__pyx_n_s_spec);
-  Py_CLEAR(clear_module_state->__pyx_n_s_state);
   Py_CLEAR(clear_module_state->__pyx_kp_s_stringsource);
-  Py_CLEAR(clear_module_state->__pyx_n_s_sys);
   Py_CLEAR(clear_module_state->__pyx_n_s_test);
-  Py_CLEAR(clear_module_state->__pyx_n_s_update);
-  Py_CLEAR(clear_module_state->__pyx_n_s_use_setstate);
-  Py_CLEAR(clear_module_state->__pyx_float_0_);
-  Py_CLEAR(clear_module_state->__pyx_float_1_);
+  Py_CLEAR(clear_module_state->__pyx_n_s_zeros);
   Py_CLEAR(clear_module_state->__pyx_int_0);
-  Py_CLEAR(clear_module_state->__pyx_int_182298202);
+  Py_CLEAR(clear_module_state->__pyx_int_1);
   Py_CLEAR(clear_module_state->__pyx_tuple_);
+  Py_CLEAR(clear_module_state->__pyx_tuple__2);
   Py_CLEAR(clear_module_state->__pyx_tuple__3);
-  Py_CLEAR(clear_module_state->__pyx_tuple__4);
-  Py_CLEAR(clear_module_state->__pyx_tuple__6);
-  Py_CLEAR(clear_module_state->__pyx_tuple__8);
-  Py_CLEAR(clear_module_state->__pyx_tuple__10);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__7);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__9);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__11);
+  Py_CLEAR(clear_module_state->__pyx_tuple__5);
+  Py_CLEAR(clear_module_state->__pyx_tuple__7);
+  Py_CLEAR(clear_module_state->__pyx_tuple__9);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__6);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__8);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__10);
   return 0;
 }
 #endif
 /* #### Code section: module_state_traverse ### */
 #if CYTHON_USE_MODULE_STATE
 static int __pyx_m_traverse(PyObject *m, visitproc visit, void *arg) {
   __pyx_mstate *traverse_module_state = __pyx_mstate(m);
@@ -2763,82 +2642,76 @@
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_unsignedinteger);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_inexact);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_floating);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_complexfloating);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_flexible);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_character);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_ufunc);
-  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation);
-  Py_VISIT(traverse_module_state->__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation);
-  Py_VISIT(traverse_module_state->__pyx_n_s_Amalgamation);
-  Py_VISIT(traverse_module_state->__pyx_n_s_Amalgamation___reduce_cython);
-  Py_VISIT(traverse_module_state->__pyx_n_s_Amalgamation___setstate_cython);
+  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind);
+  Py_VISIT(traverse_module_state->__pyx_type_5druhg_16_druhg_unionfind_UnionFind);
+  Py_VISIT(traverse_module_state->__pyx_n_s_AssertionError);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_buffer_was_not_provided);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_fast_arr_is_too_small);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_parent_arr_is_too_small);
   Py_VISIT(traverse_module_state->__pyx_n_s_ImportError);
-  Py_VISIT(traverse_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0xad);
-  Py_VISIT(traverse_module_state->__pyx_n_s_PickleError);
-  Py_VISIT(traverse_module_state->__pyx_n_s__12);
-  Py_VISIT(traverse_module_state->__pyx_kp_u__2);
-  Py_VISIT(traverse_module_state->__pyx_n_s__5);
+  Py_VISIT(traverse_module_state->__pyx_n_s_N);
+  Py_VISIT(traverse_module_state->__pyx_n_s_TypeError);
+  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind);
+  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind___reduce_cython);
+  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind___setstate_cython);
+  Py_VISIT(traverse_module_state->__pyx_n_s__11);
+  Py_VISIT(traverse_module_state->__pyx_n_s__4);
+  Py_VISIT(traverse_module_state->__pyx_n_s_allocate_unionfind_pair);
   Py_VISIT(traverse_module_state->__pyx_n_s_asyncio_coroutines);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_fast);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_parents);
   Py_VISIT(traverse_module_state->__pyx_n_s_cline_in_traceback);
-  Py_VISIT(traverse_module_state->__pyx_n_s_clusters);
-  Py_VISIT(traverse_module_state->__pyx_n_s_dict);
-  Py_VISIT(traverse_module_state->__pyx_n_s_dict_2);
   Py_VISIT(traverse_module_state->__pyx_kp_u_disable);
-  Py_VISIT(traverse_module_state->__pyx_n_s_druhg__druhg_amalgamation);
+  Py_VISIT(traverse_module_state->__pyx_n_s_druhg__druhg_unionfind);
+  Py_VISIT(traverse_module_state->__pyx_kp_s_druhg__druhg_unionfind_pyx);
+  Py_VISIT(traverse_module_state->__pyx_n_s_dtype);
   Py_VISIT(traverse_module_state->__pyx_kp_u_enable);
   Py_VISIT(traverse_module_state->__pyx_kp_u_gc);
-  Py_VISIT(traverse_module_state->__pyx_n_s_get);
   Py_VISIT(traverse_module_state->__pyx_n_s_getstate);
   Py_VISIT(traverse_module_state->__pyx_n_s_import);
   Py_VISIT(traverse_module_state->__pyx_n_s_initializing);
+  Py_VISIT(traverse_module_state->__pyx_n_s_intp);
   Py_VISIT(traverse_module_state->__pyx_n_s_is_coroutine);
   Py_VISIT(traverse_module_state->__pyx_kp_u_isenabled);
   Py_VISIT(traverse_module_state->__pyx_n_s_main);
   Py_VISIT(traverse_module_state->__pyx_n_s_name);
-  Py_VISIT(traverse_module_state->__pyx_n_s_new);
   Py_VISIT(traverse_module_state->__pyx_n_s_np);
   Py_VISIT(traverse_module_state->__pyx_n_s_numpy);
   Py_VISIT(traverse_module_state->__pyx_kp_u_numpy_core_multiarray_failed_to);
   Py_VISIT(traverse_module_state->__pyx_kp_u_numpy_core_umath_failed_to_impor);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pickle);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pyx_PickleError);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pyx_checksum);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pyx_result);
+  Py_VISIT(traverse_module_state->__pyx_n_s_print);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_state);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pyx_type);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pyx_unpickle_Amalgamation);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_vtable);
   Py_VISIT(traverse_module_state->__pyx_n_s_reduce);
   Py_VISIT(traverse_module_state->__pyx_n_s_reduce_cython);
   Py_VISIT(traverse_module_state->__pyx_n_s_reduce_ex);
   Py_VISIT(traverse_module_state->__pyx_n_s_self);
+  Py_VISIT(traverse_module_state->__pyx_kp_s_self_fast_self_parent_cannot_be);
   Py_VISIT(traverse_module_state->__pyx_n_s_setstate);
   Py_VISIT(traverse_module_state->__pyx_n_s_setstate_cython);
-  Py_VISIT(traverse_module_state->__pyx_n_s_size);
   Py_VISIT(traverse_module_state->__pyx_n_s_spec);
-  Py_VISIT(traverse_module_state->__pyx_n_s_state);
   Py_VISIT(traverse_module_state->__pyx_kp_s_stringsource);
-  Py_VISIT(traverse_module_state->__pyx_n_s_sys);
   Py_VISIT(traverse_module_state->__pyx_n_s_test);
-  Py_VISIT(traverse_module_state->__pyx_n_s_update);
-  Py_VISIT(traverse_module_state->__pyx_n_s_use_setstate);
-  Py_VISIT(traverse_module_state->__pyx_float_0_);
-  Py_VISIT(traverse_module_state->__pyx_float_1_);
+  Py_VISIT(traverse_module_state->__pyx_n_s_zeros);
   Py_VISIT(traverse_module_state->__pyx_int_0);
-  Py_VISIT(traverse_module_state->__pyx_int_182298202);
+  Py_VISIT(traverse_module_state->__pyx_int_1);
   Py_VISIT(traverse_module_state->__pyx_tuple_);
+  Py_VISIT(traverse_module_state->__pyx_tuple__2);
   Py_VISIT(traverse_module_state->__pyx_tuple__3);
-  Py_VISIT(traverse_module_state->__pyx_tuple__4);
-  Py_VISIT(traverse_module_state->__pyx_tuple__6);
-  Py_VISIT(traverse_module_state->__pyx_tuple__8);
-  Py_VISIT(traverse_module_state->__pyx_tuple__10);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__7);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__9);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__11);
+  Py_VISIT(traverse_module_state->__pyx_tuple__5);
+  Py_VISIT(traverse_module_state->__pyx_tuple__7);
+  Py_VISIT(traverse_module_state->__pyx_tuple__9);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__6);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__8);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__10);
   return 0;
 }
 #endif
 /* #### Code section: module_state_defines ### */
 #if CYTHON_USE_MODULE_STATE
 #define __pyx_d __pyx_mstate_global->__pyx_d
 #define __pyx_b __pyx_mstate_global->__pyx_b
@@ -2864,1337 +2737,1143 @@
 #define __pyx_ptype_5numpy_unsignedinteger __pyx_mstate_global->__pyx_ptype_5numpy_unsignedinteger
 #define __pyx_ptype_5numpy_inexact __pyx_mstate_global->__pyx_ptype_5numpy_inexact
 #define __pyx_ptype_5numpy_floating __pyx_mstate_global->__pyx_ptype_5numpy_floating
 #define __pyx_ptype_5numpy_complexfloating __pyx_mstate_global->__pyx_ptype_5numpy_complexfloating
 #define __pyx_ptype_5numpy_flexible __pyx_mstate_global->__pyx_ptype_5numpy_flexible
 #define __pyx_ptype_5numpy_character __pyx_mstate_global->__pyx_ptype_5numpy_character
 #define __pyx_ptype_5numpy_ufunc __pyx_mstate_global->__pyx_ptype_5numpy_ufunc
-#define __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation __pyx_mstate_global->__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation
-#define __pyx_type_5druhg_19_druhg_amalgamation_Amalgamation __pyx_mstate_global->__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation
-#define __pyx_n_s_Amalgamation __pyx_mstate_global->__pyx_n_s_Amalgamation
-#define __pyx_n_s_Amalgamation___reduce_cython __pyx_mstate_global->__pyx_n_s_Amalgamation___reduce_cython
-#define __pyx_n_s_Amalgamation___setstate_cython __pyx_mstate_global->__pyx_n_s_Amalgamation___setstate_cython
+#define __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind __pyx_mstate_global->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind
+#define __pyx_type_5druhg_16_druhg_unionfind_UnionFind __pyx_mstate_global->__pyx_type_5druhg_16_druhg_unionfind_UnionFind
+#define __pyx_n_s_AssertionError __pyx_mstate_global->__pyx_n_s_AssertionError
+#define __pyx_kp_u_ERROR_buffer_was_not_provided __pyx_mstate_global->__pyx_kp_u_ERROR_buffer_was_not_provided
+#define __pyx_kp_u_ERROR_fast_arr_is_too_small __pyx_mstate_global->__pyx_kp_u_ERROR_fast_arr_is_too_small
+#define __pyx_kp_u_ERROR_parent_arr_is_too_small __pyx_mstate_global->__pyx_kp_u_ERROR_parent_arr_is_too_small
 #define __pyx_n_s_ImportError __pyx_mstate_global->__pyx_n_s_ImportError
-#define __pyx_kp_s_Incompatible_checksums_s_vs_0xad __pyx_mstate_global->__pyx_kp_s_Incompatible_checksums_s_vs_0xad
-#define __pyx_n_s_PickleError __pyx_mstate_global->__pyx_n_s_PickleError
-#define __pyx_n_s__12 __pyx_mstate_global->__pyx_n_s__12
-#define __pyx_kp_u__2 __pyx_mstate_global->__pyx_kp_u__2
-#define __pyx_n_s__5 __pyx_mstate_global->__pyx_n_s__5
+#define __pyx_n_s_N __pyx_mstate_global->__pyx_n_s_N
+#define __pyx_n_s_TypeError __pyx_mstate_global->__pyx_n_s_TypeError
+#define __pyx_n_s_UnionFind __pyx_mstate_global->__pyx_n_s_UnionFind
+#define __pyx_n_s_UnionFind___reduce_cython __pyx_mstate_global->__pyx_n_s_UnionFind___reduce_cython
+#define __pyx_n_s_UnionFind___setstate_cython __pyx_mstate_global->__pyx_n_s_UnionFind___setstate_cython
+#define __pyx_n_s__11 __pyx_mstate_global->__pyx_n_s__11
+#define __pyx_n_s__4 __pyx_mstate_global->__pyx_n_s__4
+#define __pyx_n_s_allocate_unionfind_pair __pyx_mstate_global->__pyx_n_s_allocate_unionfind_pair
 #define __pyx_n_s_asyncio_coroutines __pyx_mstate_global->__pyx_n_s_asyncio_coroutines
+#define __pyx_n_s_buffer_fast __pyx_mstate_global->__pyx_n_s_buffer_fast
+#define __pyx_n_s_buffer_parents __pyx_mstate_global->__pyx_n_s_buffer_parents
 #define __pyx_n_s_cline_in_traceback __pyx_mstate_global->__pyx_n_s_cline_in_traceback
-#define __pyx_n_s_clusters __pyx_mstate_global->__pyx_n_s_clusters
-#define __pyx_n_s_dict __pyx_mstate_global->__pyx_n_s_dict
-#define __pyx_n_s_dict_2 __pyx_mstate_global->__pyx_n_s_dict_2
 #define __pyx_kp_u_disable __pyx_mstate_global->__pyx_kp_u_disable
-#define __pyx_n_s_druhg__druhg_amalgamation __pyx_mstate_global->__pyx_n_s_druhg__druhg_amalgamation
+#define __pyx_n_s_druhg__druhg_unionfind __pyx_mstate_global->__pyx_n_s_druhg__druhg_unionfind
+#define __pyx_kp_s_druhg__druhg_unionfind_pyx __pyx_mstate_global->__pyx_kp_s_druhg__druhg_unionfind_pyx
+#define __pyx_n_s_dtype __pyx_mstate_global->__pyx_n_s_dtype
 #define __pyx_kp_u_enable __pyx_mstate_global->__pyx_kp_u_enable
 #define __pyx_kp_u_gc __pyx_mstate_global->__pyx_kp_u_gc
-#define __pyx_n_s_get __pyx_mstate_global->__pyx_n_s_get
 #define __pyx_n_s_getstate __pyx_mstate_global->__pyx_n_s_getstate
 #define __pyx_n_s_import __pyx_mstate_global->__pyx_n_s_import
 #define __pyx_n_s_initializing __pyx_mstate_global->__pyx_n_s_initializing
+#define __pyx_n_s_intp __pyx_mstate_global->__pyx_n_s_intp
 #define __pyx_n_s_is_coroutine __pyx_mstate_global->__pyx_n_s_is_coroutine
 #define __pyx_kp_u_isenabled __pyx_mstate_global->__pyx_kp_u_isenabled
 #define __pyx_n_s_main __pyx_mstate_global->__pyx_n_s_main
 #define __pyx_n_s_name __pyx_mstate_global->__pyx_n_s_name
-#define __pyx_n_s_new __pyx_mstate_global->__pyx_n_s_new
 #define __pyx_n_s_np __pyx_mstate_global->__pyx_n_s_np
 #define __pyx_n_s_numpy __pyx_mstate_global->__pyx_n_s_numpy
 #define __pyx_kp_u_numpy_core_multiarray_failed_to __pyx_mstate_global->__pyx_kp_u_numpy_core_multiarray_failed_to
 #define __pyx_kp_u_numpy_core_umath_failed_to_impor __pyx_mstate_global->__pyx_kp_u_numpy_core_umath_failed_to_impor
-#define __pyx_n_s_pickle __pyx_mstate_global->__pyx_n_s_pickle
-#define __pyx_n_s_pyx_PickleError __pyx_mstate_global->__pyx_n_s_pyx_PickleError
-#define __pyx_n_s_pyx_checksum __pyx_mstate_global->__pyx_n_s_pyx_checksum
-#define __pyx_n_s_pyx_result __pyx_mstate_global->__pyx_n_s_pyx_result
+#define __pyx_n_s_print __pyx_mstate_global->__pyx_n_s_print
 #define __pyx_n_s_pyx_state __pyx_mstate_global->__pyx_n_s_pyx_state
-#define __pyx_n_s_pyx_type __pyx_mstate_global->__pyx_n_s_pyx_type
-#define __pyx_n_s_pyx_unpickle_Amalgamation __pyx_mstate_global->__pyx_n_s_pyx_unpickle_Amalgamation
 #define __pyx_n_s_pyx_vtable __pyx_mstate_global->__pyx_n_s_pyx_vtable
 #define __pyx_n_s_reduce __pyx_mstate_global->__pyx_n_s_reduce
 #define __pyx_n_s_reduce_cython __pyx_mstate_global->__pyx_n_s_reduce_cython
 #define __pyx_n_s_reduce_ex __pyx_mstate_global->__pyx_n_s_reduce_ex
 #define __pyx_n_s_self __pyx_mstate_global->__pyx_n_s_self
+#define __pyx_kp_s_self_fast_self_parent_cannot_be __pyx_mstate_global->__pyx_kp_s_self_fast_self_parent_cannot_be
 #define __pyx_n_s_setstate __pyx_mstate_global->__pyx_n_s_setstate
 #define __pyx_n_s_setstate_cython __pyx_mstate_global->__pyx_n_s_setstate_cython
-#define __pyx_n_s_size __pyx_mstate_global->__pyx_n_s_size
 #define __pyx_n_s_spec __pyx_mstate_global->__pyx_n_s_spec
-#define __pyx_n_s_state __pyx_mstate_global->__pyx_n_s_state
 #define __pyx_kp_s_stringsource __pyx_mstate_global->__pyx_kp_s_stringsource
-#define __pyx_n_s_sys __pyx_mstate_global->__pyx_n_s_sys
 #define __pyx_n_s_test __pyx_mstate_global->__pyx_n_s_test
-#define __pyx_n_s_update __pyx_mstate_global->__pyx_n_s_update
-#define __pyx_n_s_use_setstate __pyx_mstate_global->__pyx_n_s_use_setstate
-#define __pyx_float_0_ __pyx_mstate_global->__pyx_float_0_
-#define __pyx_float_1_ __pyx_mstate_global->__pyx_float_1_
+#define __pyx_n_s_zeros __pyx_mstate_global->__pyx_n_s_zeros
 #define __pyx_int_0 __pyx_mstate_global->__pyx_int_0
-#define __pyx_int_182298202 __pyx_mstate_global->__pyx_int_182298202
+#define __pyx_int_1 __pyx_mstate_global->__pyx_int_1
 #define __pyx_tuple_ __pyx_mstate_global->__pyx_tuple_
+#define __pyx_tuple__2 __pyx_mstate_global->__pyx_tuple__2
 #define __pyx_tuple__3 __pyx_mstate_global->__pyx_tuple__3
-#define __pyx_tuple__4 __pyx_mstate_global->__pyx_tuple__4
-#define __pyx_tuple__6 __pyx_mstate_global->__pyx_tuple__6
-#define __pyx_tuple__8 __pyx_mstate_global->__pyx_tuple__8
-#define __pyx_tuple__10 __pyx_mstate_global->__pyx_tuple__10
-#define __pyx_codeobj__7 __pyx_mstate_global->__pyx_codeobj__7
-#define __pyx_codeobj__9 __pyx_mstate_global->__pyx_codeobj__9
-#define __pyx_codeobj__11 __pyx_mstate_global->__pyx_codeobj__11
+#define __pyx_tuple__5 __pyx_mstate_global->__pyx_tuple__5
+#define __pyx_tuple__7 __pyx_mstate_global->__pyx_tuple__7
+#define __pyx_tuple__9 __pyx_mstate_global->__pyx_tuple__9
+#define __pyx_codeobj__6 __pyx_mstate_global->__pyx_codeobj__6
+#define __pyx_codeobj__8 __pyx_mstate_global->__pyx_codeobj__8
+#define __pyx_codeobj__10 __pyx_mstate_global->__pyx_codeobj__10
 #endif
 /* #### Code section: module_code ### */
 
-/* "druhg/_druhg_amalgamation.pyx":18
- * from libc.math cimport fabs, pow
+/* "druhg/_druhg_unionfind.pyx":15
+ * cimport numpy as np
  * 
- * cdef np.double_t merge_means(np.intp_t na, np.double_t meana,             # <<<<<<<<<<<<<<
- *                              np.intp_t nb, np.double_t meanb
- *                             ):
+ * def allocate_unionfind_pair(np.intp_t N):             # <<<<<<<<<<<<<<
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access
  */
 
-static __pyx_t_5numpy_double_t __pyx_f_5druhg_19_druhg_amalgamation_merge_means(__pyx_t_5numpy_intp_t __pyx_v_na, __pyx_t_5numpy_double_t __pyx_v_meana, __pyx_t_5numpy_intp_t __pyx_v_nb, __pyx_t_5numpy_double_t __pyx_v_meanb) {
-  __pyx_t_5numpy_double_t __pyx_v_delta;
-  __pyx_t_5numpy_double_t __pyx_r;
+/* Python wrapper */
+static PyObject *__pyx_pw_5druhg_16_druhg_unionfind_1allocate_unionfind_pair(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+); /*proto*/
+static PyMethodDef __pyx_mdef_5druhg_16_druhg_unionfind_1allocate_unionfind_pair = {"allocate_unionfind_pair", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_16_druhg_unionfind_1allocate_unionfind_pair, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_16_druhg_unionfind_1allocate_unionfind_pair(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+) {
+  __pyx_t_5numpy_intp_t __pyx_v_N;
+  #if !CYTHON_METH_FASTCALL
+  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
+  #endif
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("allocate_unionfind_pair (wrapper)", 0);
+  {
+    #if CYTHON_USE_MODULE_STATE
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,0};
+    #else
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,0};
+    #endif
+    PyObject* values[1] = {0};
+    if (__pyx_kwds) {
+      Py_ssize_t kw_args;
+      switch (__pyx_nargs) {
+        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
+      switch (__pyx_nargs) {
+        case  0:
+        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_N)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 15, __pyx_L3_error)
+        else goto __pyx_L5_argtuple_error;
+      }
+      if (unlikely(kw_args > 0)) {
+        const Py_ssize_t kwd_pos_args = __pyx_nargs;
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "allocate_unionfind_pair") < 0)) __PYX_ERR(0, 15, __pyx_L3_error)
+      }
+    } else if (unlikely(__pyx_nargs != 1)) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+    }
+    __pyx_v_N = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_N == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 15, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("allocate_unionfind_pair", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 15, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("druhg._druhg_unionfind.allocate_unionfind_pair", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_5druhg_16_druhg_unionfind_allocate_unionfind_pair(__pyx_self, __pyx_v_N);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_5druhg_16_druhg_unionfind_allocate_unionfind_pair(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_N) {
+  PyObject *__pyx_v_buffer_parents = NULL;
+  PyObject *__pyx_v_buffer_fast = NULL;
+  PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("merge_means", 0);
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("allocate_unionfind_pair", 0);
 
-  /* "druhg/_druhg_amalgamation.pyx":26
+  /* "druhg/_druhg_unionfind.pyx":16
  * 
- *     # nx = na + nb
- *     delta = meanb - meana             # <<<<<<<<<<<<<<
- *     delta = meana + delta*nb/(na + nb)
- *     # use this for big n's
+ * def allocate_unionfind_pair(np.intp_t N):
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases             # <<<<<<<<<<<<<<
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access
+ *     return buffer_parents, buffer_fast
  */
-  __pyx_v_delta = (__pyx_v_meanb - __pyx_v_meana);
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyInt_FromSsize_t((2 * __pyx_v_N)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v_buffer_parents = __pyx_t_5;
+  __pyx_t_5 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":27
- *     # nx = na + nb
- *     delta = meanb - meana
- *     delta = meana + delta*nb/(na + nb)             # <<<<<<<<<<<<<<
- *     # use this for big n's
- *     # mu = (mu*n + mu_2*n_2) / nx
+  /* "druhg/_druhg_unionfind.pyx":17
+ * def allocate_unionfind_pair(np.intp_t N):
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access             # <<<<<<<<<<<<<<
+ *     return buffer_parents, buffer_fast
+ * 
  */
-  __pyx_v_delta = (__pyx_v_meana + ((__pyx_v_delta * __pyx_v_nb) / ((__pyx_t_5numpy_double_t)(__pyx_v_na + __pyx_v_nb))));
+  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_N); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5);
+  __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_intp); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_v_buffer_fast = __pyx_t_4;
+  __pyx_t_4 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":31
- *     # mu = (mu*n + mu_2*n_2) / nx
- *     # m2a = m2a + m2b + delta**2*na*nb/nx
- *     return delta             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_unionfind.pyx":18
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access
+ *     return buffer_parents, buffer_fast             # <<<<<<<<<<<<<<
  * 
- * cdef class Amalgamation (object):
+ * cdef class UnionFind (object):
  */
-  __pyx_r = __pyx_v_delta;
+  __Pyx_XDECREF(__pyx_r);
+  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 18, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_INCREF(__pyx_v_buffer_parents);
+  __Pyx_GIVEREF(__pyx_v_buffer_parents);
+  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_v_buffer_parents);
+  __Pyx_INCREF(__pyx_v_buffer_fast);
+  __Pyx_GIVEREF(__pyx_v_buffer_fast);
+  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_v_buffer_fast);
+  __pyx_r = __pyx_t_4;
+  __pyx_t_4 = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_amalgamation.pyx":18
- * from libc.math cimport fabs, pow
+  /* "druhg/_druhg_unionfind.pyx":15
+ * cimport numpy as np
  * 
- * cdef np.double_t merge_means(np.intp_t na, np.double_t meana,             # <<<<<<<<<<<<<<
- *                              np.intp_t nb, np.double_t meanb
- *                             ):
+ * def allocate_unionfind_pair(np.intp_t N):             # <<<<<<<<<<<<<<
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access
  */
 
   /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_AddTraceback("druhg._druhg_unionfind.allocate_unionfind_pair", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
   __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_buffer_parents);
+  __Pyx_XDECREF(__pyx_v_buffer_fast);
+  __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_amalgamation.pyx":37
- *     # https://cython.readthedocs.io/en/latest/src/userguide/sharing_declarations.html
+/* "druhg/_druhg_unionfind.pyx":22
+ * cdef class UnionFind (object):
  * 
- *     def __init__(self, int size = 1, int clusters = 1):             # <<<<<<<<<<<<<<
- *         self.size = size
- *         self.clusters = clusters
+ *     def __init__(self, np.intp_t N, buffer_parents, buffer_fast=None):             # <<<<<<<<<<<<<<
+ *         self.p_size = N
+ *         self.next_label = N + 1
  */
 
 /* Python wrapper */
-static int __pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  int __pyx_v_size;
-  int __pyx_v_clusters;
+static int __pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  __pyx_t_5numpy_intp_t __pyx_v_N;
+  PyObject *__pyx_v_buffer_parents = 0;
+  PyObject *__pyx_v_buffer_fast = 0;
   CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
   CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
     #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_size,&__pyx_n_s_clusters,0};
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,&__pyx_n_s_buffer_parents,&__pyx_n_s_buffer_fast,0};
     #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_size,&__pyx_n_s_clusters,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,&__pyx_n_s_buffer_parents,&__pyx_n_s_buffer_fast,0};
     #endif
-    PyObject* values[2] = {0,0};
+    PyObject* values[3] = {0,0,0};
+    values[2] = ((PyObject *)Py_None);
     if (__pyx_kwds) {
       Py_ssize_t kw_args;
       switch (__pyx_nargs) {
+        case  3: values[2] = __Pyx_Arg_VARARGS(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
         case  2: values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_VARARGS(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_size);
-          if (value) { values[0] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 37, __pyx_L3_error)
-        }
+        if (likely((values[0] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_N)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 22, __pyx_L3_error)
+        else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
+        if (likely((values[1] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_parents)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 22, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 3, 1); __PYX_ERR(0, 22, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_clusters);
-          if (value) { values[1] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 37, __pyx_L3_error)
+          PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_fast);
+          if (value) { values[2] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 22, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 37, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 22, __pyx_L3_error)
       }
     } else {
       switch (__pyx_nargs) {
-        case  2: values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
-        CYTHON_FALLTHROUGH;
-        case  1: values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
+        case  3: values[2] = __Pyx_Arg_VARARGS(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
-        case  0: break;
+        case  2: values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
+        values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
+        break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    if (values[0]) {
-      __pyx_v_size = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 37, __pyx_L3_error)
-    } else {
-      __pyx_v_size = ((int)1);
-    }
-    if (values[1]) {
-      __pyx_v_clusters = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_clusters == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 37, __pyx_L3_error)
-    } else {
-      __pyx_v_clusters = ((int)1);
-    }
+    __pyx_v_N = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_N == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 22, __pyx_L3_error)
+    __pyx_v_buffer_parents = values[1];
+    __pyx_v_buffer_fast = values[2];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 0, 2, __pyx_nargs); __PYX_ERR(0, 37, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 3, __pyx_nargs); __PYX_ERR(0, 22, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.Amalgamation.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_unionfind.UnionFind.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation___init__(((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_self), __pyx_v_size, __pyx_v_clusters);
+  __pyx_r = __pyx_pf_5druhg_16_druhg_unionfind_9UnionFind___init__(((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self), __pyx_v_N, __pyx_v_buffer_parents, __pyx_v_buffer_fast);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation___init__(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, int __pyx_v_size, int __pyx_v_clusters) {
+static int __pyx_pf_5druhg_16_druhg_unionfind_9UnionFind___init__(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_N, PyObject *__pyx_v_buffer_parents, PyObject *__pyx_v_buffer_fast) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
+  Py_ssize_t __pyx_t_4;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "druhg/_druhg_amalgamation.pyx":38
+  /* "druhg/_druhg_unionfind.pyx":23
  * 
- *     def __init__(self, int size = 1, int clusters = 1):
- *         self.size = size             # <<<<<<<<<<<<<<
- *         self.clusters = clusters
- *         self.energies = None
- */
-  __pyx_v_self->size = __pyx_v_size;
-
-  /* "druhg/_druhg_amalgamation.pyx":39
- *     def __init__(self, int size = 1, int clusters = 1):
- *         self.size = size
- *         self.clusters = clusters             # <<<<<<<<<<<<<<
- *         self.energies = None
+ *     def __init__(self, np.intp_t N, buffer_parents, buffer_fast=None):
+ *         self.p_size = N             # <<<<<<<<<<<<<<
+ *         self.next_label = N + 1
  * 
  */
-  __pyx_v_self->clusters = __pyx_v_clusters;
+  __pyx_v_self->p_size = __pyx_v_N;
 
-  /* "druhg/_druhg_amalgamation.pyx":40
- *         self.size = size
- *         self.clusters = clusters
- *         self.energies = None             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_unionfind.pyx":24
+ *     def __init__(self, np.intp_t N, buffer_parents, buffer_fast=None):
+ *         self.p_size = N
+ *         self.next_label = N + 1             # <<<<<<<<<<<<<<
  * 
- *     cdef void _amalgamate(self, np.intp_t size, np.intp_t clusters, dict o_energies):
+ *         self.parent_arr = buffer_parents
  */
-  __Pyx_INCREF(Py_None);
-  __Pyx_GIVEREF(Py_None);
-  __Pyx_GOTREF(__pyx_v_self->energies);
-  __Pyx_DECREF(__pyx_v_self->energies);
-  __pyx_v_self->energies = ((PyObject*)Py_None);
+  __pyx_v_self->next_label = (__pyx_v_N + 1);
 
-  /* "druhg/_druhg_amalgamation.pyx":37
- *     # https://cython.readthedocs.io/en/latest/src/userguide/sharing_declarations.html
+  /* "druhg/_druhg_unionfind.pyx":26
+ *         self.next_label = N + 1
+ * 
+ *         self.parent_arr = buffer_parents             # <<<<<<<<<<<<<<
+ *         self.parent = NULL
  * 
- *     def __init__(self, int size = 1, int clusters = 1):             # <<<<<<<<<<<<<<
- *         self.size = size
- *         self.clusters = clusters
  */
+  if (!(likely(((__pyx_v_buffer_parents) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_buffer_parents, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 26, __pyx_L1_error)
+  __pyx_t_1 = __pyx_v_buffer_parents;
+  __Pyx_INCREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->parent_arr);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->parent_arr);
+  __pyx_v_self->parent_arr = ((PyArrayObject *)__pyx_t_1);
+  __pyx_t_1 = 0;
 
-  /* function exit code */
-  __pyx_r = 0;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_amalgamation.pyx":42
- *         self.energies = None
+  /* "druhg/_druhg_unionfind.pyx":27
  * 
- *     cdef void _amalgamate(self, np.intp_t size, np.intp_t clusters, dict o_energies):             # <<<<<<<<<<<<<<
- *         self.size += size
- *         self.clusters += clusters
+ *         self.parent_arr = buffer_parents
+ *         self.parent = NULL             # <<<<<<<<<<<<<<
+ * 
+ *         self.fast_arr = buffer_fast
  */
+  __pyx_v_self->parent = NULL;
 
-static void __pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation__amalgamate(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_size, __pyx_t_5numpy_intp_t __pyx_v_clusters, PyObject *__pyx_v_o_energies) {
-  PyObject *__pyx_v_energy = NULL;
-  PyObject *__pyx_v_elem = NULL;
-  PyObject *__pyx_v_v1 = NULL;
-  PyObject *__pyx_v_v2 = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  Py_ssize_t __pyx_t_2;
-  Py_ssize_t __pyx_t_3;
-  int __pyx_t_4;
-  PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  PyObject *__pyx_t_7 = NULL;
-  int __pyx_t_8;
-  PyObject *__pyx_t_9 = NULL;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("_amalgamate", 0);
-
-  /* "druhg/_druhg_amalgamation.pyx":43
+  /* "druhg/_druhg_unionfind.pyx":29
+ *         self.parent = NULL
  * 
- *     cdef void _amalgamate(self, np.intp_t size, np.intp_t clusters, dict o_energies):
- *         self.size += size             # <<<<<<<<<<<<<<
- *         self.clusters += clusters
+ *         self.fast_arr = buffer_fast             # <<<<<<<<<<<<<<
+ *         self.fast = NULL
  * 
  */
-  __pyx_v_self->size = (__pyx_v_self->size + __pyx_v_size);
+  if (!(likely(((__pyx_v_buffer_fast) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_buffer_fast, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 29, __pyx_L1_error)
+  __pyx_t_1 = __pyx_v_buffer_fast;
+  __Pyx_INCREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->fast_arr);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->fast_arr);
+  __pyx_v_self->fast_arr = ((PyArrayObject *)__pyx_t_1);
+  __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":44
- *     cdef void _amalgamate(self, np.intp_t size, np.intp_t clusters, dict o_energies):
- *         self.size += size
- *         self.clusters += clusters             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_unionfind.pyx":30
+ * 
+ *         self.fast_arr = buffer_fast
+ *         self.fast = NULL             # <<<<<<<<<<<<<<
  * 
- *         energy = dict()
+ *         if buffer_parents is None:
  */
-  __pyx_v_self->clusters = (__pyx_v_self->clusters + __pyx_v_clusters);
+  __pyx_v_self->fast = NULL;
 
-  /* "druhg/_druhg_amalgamation.pyx":46
- *         self.clusters += clusters
+  /* "druhg/_druhg_unionfind.pyx":32
+ *         self.fast = NULL
  * 
- *         energy = dict()             # <<<<<<<<<<<<<<
- *         for elem in set(self.energies) | set(o_energies):
- *             v1 = self.energies.get(elem, (0,0.,))
+ *         if buffer_parents is None:             # <<<<<<<<<<<<<<
+ *             print('ERROR: buffer was not provided')
+ *             return
  */
-  __pyx_t_1 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_v_energy = ((PyObject*)__pyx_t_1);
-  __pyx_t_1 = 0;
+  __pyx_t_2 = (__pyx_v_buffer_parents == Py_None);
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
 
-  /* "druhg/_druhg_amalgamation.pyx":47
+    /* "druhg/_druhg_unionfind.pyx":33
  * 
- *         energy = dict()
- *         for elem in set(self.energies) | set(o_energies):             # <<<<<<<<<<<<<<
- *             v1 = self.energies.get(elem, (0,0.,))
- *             v2 = o_energies.get(elem, (0,0.,))
+ *         if buffer_parents is None:
+ *             print('ERROR: buffer was not provided')             # <<<<<<<<<<<<<<
+ *             return
+ *         elif len(self.parent_arr) < 2*N:
  */
-  __pyx_t_2 = 0;
-  __pyx_t_5 = PySet_New(__pyx_v_self->energies); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 47, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_6 = PySet_New(__pyx_v_o_energies); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 47, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_7 = PyNumber_Or(__pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 47, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_7);
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  __pyx_t_6 = __Pyx_set_iterator(__pyx_t_7, 1, (&__pyx_t_3), (&__pyx_t_4)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 47, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-  __Pyx_XDECREF(__pyx_t_1);
-  __pyx_t_1 = __pyx_t_6;
-  __pyx_t_6 = 0;
-  while (1) {
-    __pyx_t_8 = __Pyx_set_iter_next(__pyx_t_1, __pyx_t_3, &__pyx_t_2, &__pyx_t_6, __pyx_t_4);
-    if (unlikely(__pyx_t_8 == 0)) break;
-    if (unlikely(__pyx_t_8 == -1)) __PYX_ERR(0, 47, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __Pyx_XDECREF_SET(__pyx_v_elem, __pyx_t_6);
-    __pyx_t_6 = 0;
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 33, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-    /* "druhg/_druhg_amalgamation.pyx":48
- *         energy = dict()
- *         for elem in set(self.energies) | set(o_energies):
- *             v1 = self.energies.get(elem, (0,0.,))             # <<<<<<<<<<<<<<
- *             v2 = o_energies.get(elem, (0,0.,))
- *             energy[elem] = (v1[0]+v2[0], v1[1]+v2[1],)
- */
-    if (unlikely(__pyx_v_self->energies == Py_None)) {
-      PyErr_Format(PyExc_AttributeError, "'NoneType' object has no attribute '%.30s'", "get");
-      __PYX_ERR(0, 48, __pyx_L1_error)
-    }
-    __pyx_t_6 = __Pyx_PyDict_GetItemDefault(__pyx_v_self->energies, __pyx_v_elem, __pyx_tuple_); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 48, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __Pyx_XDECREF_SET(__pyx_v_v1, __pyx_t_6);
-    __pyx_t_6 = 0;
+    /* "druhg/_druhg_unionfind.pyx":34
+ *         if buffer_parents is None:
+ *             print('ERROR: buffer was not provided')
+ *             return             # <<<<<<<<<<<<<<
+ *         elif len(self.parent_arr) < 2*N:
+ *             print('ERROR: parent_arr is too small', len(self.parent_arr), 2*N)
+ */
+    __pyx_r = 0;
+    goto __pyx_L0;
 
-    /* "druhg/_druhg_amalgamation.pyx":49
- *         for elem in set(self.energies) | set(o_energies):
- *             v1 = self.energies.get(elem, (0,0.,))
- *             v2 = o_energies.get(elem, (0,0.,))             # <<<<<<<<<<<<<<
- *             energy[elem] = (v1[0]+v2[0], v1[1]+v2[1],)
+    /* "druhg/_druhg_unionfind.pyx":32
+ *         self.fast = NULL
  * 
+ *         if buffer_parents is None:             # <<<<<<<<<<<<<<
+ *             print('ERROR: buffer was not provided')
+ *             return
  */
-    if (unlikely(__pyx_v_o_energies == Py_None)) {
-      PyErr_Format(PyExc_AttributeError, "'NoneType' object has no attribute '%.30s'", "get");
-      __PYX_ERR(0, 49, __pyx_L1_error)
-    }
-    __pyx_t_6 = __Pyx_PyDict_GetItemDefault(__pyx_v_o_energies, __pyx_v_elem, __pyx_tuple_); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 49, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __Pyx_XDECREF_SET(__pyx_v_v2, __pyx_t_6);
-    __pyx_t_6 = 0;
+  }
 
-    /* "druhg/_druhg_amalgamation.pyx":50
- *             v1 = self.energies.get(elem, (0,0.,))
- *             v2 = o_energies.get(elem, (0,0.,))
- *             energy[elem] = (v1[0]+v2[0], v1[1]+v2[1],)             # <<<<<<<<<<<<<<
- * 
- *         self.energies = energy
+  /* "druhg/_druhg_unionfind.pyx":35
+ *             print('ERROR: buffer was not provided')
+ *             return
+ *         elif len(self.parent_arr) < 2*N:             # <<<<<<<<<<<<<<
+ *             print('ERROR: parent_arr is too small', len(self.parent_arr), 2*N)
+ *             return
  */
-    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_v1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 50, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_v2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 50, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_5 = PyNumber_Add(__pyx_t_6, __pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 50, __pyx_L1_error)
+  __pyx_t_1 = ((PyObject *)__pyx_v_self->parent_arr);
+  __Pyx_INCREF(__pyx_t_1);
+  __pyx_t_4 = PyObject_Length(__pyx_t_1); if (unlikely(__pyx_t_4 == ((Py_ssize_t)-1))) __PYX_ERR(0, 35, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = ((__pyx_t_4 < (2 * __pyx_v_N)) != 0);
+  if (__pyx_t_3) {
+
+    /* "druhg/_druhg_unionfind.pyx":36
+ *             return
+ *         elif len(self.parent_arr) < 2*N:
+ *             print('ERROR: parent_arr is too small', len(self.parent_arr), 2*N)             # <<<<<<<<<<<<<<
+ *             return
+ *         else:
+ */
+    __pyx_t_1 = ((PyObject *)__pyx_v_self->parent_arr);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_t_4 = PyObject_Length(__pyx_t_1); if (unlikely(__pyx_t_4 == ((Py_ssize_t)-1))) __PYX_ERR(0, 36, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = PyInt_FromSsize_t(__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 36, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = PyInt_FromSsize_t((2 * __pyx_v_N)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 36, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_v1, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 50, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_v2, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 50, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_9 = PyNumber_Add(__pyx_t_7, __pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 50, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 50, __pyx_L1_error)
+    __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 36, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_INCREF(__pyx_kp_u_ERROR_parent_arr_is_too_small);
+    __Pyx_GIVEREF(__pyx_kp_u_ERROR_parent_arr_is_too_small);
+    PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_kp_u_ERROR_parent_arr_is_too_small);
+    __Pyx_GIVEREF(__pyx_t_1);
+    PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_1);
     __Pyx_GIVEREF(__pyx_t_5);
-    PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
-    __Pyx_GIVEREF(__pyx_t_9);
-    PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_9);
+    PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_5);
+    __pyx_t_1 = 0;
     __pyx_t_5 = 0;
-    __pyx_t_9 = 0;
-    if (unlikely((PyDict_SetItem(__pyx_v_energy, __pyx_v_elem, __pyx_t_6) < 0))) __PYX_ERR(0, 50, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_6, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 36, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  }
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":52
- *             energy[elem] = (v1[0]+v2[0], v1[1]+v2[1],)
- * 
- *         self.energies = energy             # <<<<<<<<<<<<<<
- * 
- *     cdef Amalgamation merge_amalgamations(self, np.double_t g, Amalgamation other, np.double_t jump1, np.double_t jump2):
+    /* "druhg/_druhg_unionfind.pyx":37
+ *         elif len(self.parent_arr) < 2*N:
+ *             print('ERROR: parent_arr is too small', len(self.parent_arr), 2*N)
+ *             return             # <<<<<<<<<<<<<<
+ *         else:
+ *             self.parent = (<np.intp_t *> self.parent_arr.data)
  */
-  __Pyx_INCREF(__pyx_v_energy);
-  __Pyx_GIVEREF(__pyx_v_energy);
-  __Pyx_GOTREF(__pyx_v_self->energies);
-  __Pyx_DECREF(__pyx_v_self->energies);
-  __pyx_v_self->energies = __pyx_v_energy;
+    __pyx_r = 0;
+    goto __pyx_L0;
 
-  /* "druhg/_druhg_amalgamation.pyx":42
- *         self.energies = None
- * 
- *     cdef void _amalgamate(self, np.intp_t size, np.intp_t clusters, dict o_energies):             # <<<<<<<<<<<<<<
- *         self.size += size
- *         self.clusters += clusters
+    /* "druhg/_druhg_unionfind.pyx":35
+ *             print('ERROR: buffer was not provided')
+ *             return
+ *         elif len(self.parent_arr) < 2*N:             # <<<<<<<<<<<<<<
+ *             print('ERROR: parent_arr is too small', len(self.parent_arr), 2*N)
+ *             return
  */
+  }
 
-  /* function exit code */
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_7);
-  __Pyx_XDECREF(__pyx_t_9);
-  __Pyx_WriteUnraisable("druhg._druhg_amalgamation.Amalgamation._amalgamate", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
-  __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_energy);
-  __Pyx_XDECREF(__pyx_v_elem);
-  __Pyx_XDECREF(__pyx_v_v1);
-  __Pyx_XDECREF(__pyx_v_v2);
-  __Pyx_RefNannyFinishContext();
-}
-
-/* "druhg/_druhg_amalgamation.pyx":54
- *         self.energies = energy
+  /* "druhg/_druhg_unionfind.pyx":39
+ *             return
+ *         else:
+ *             self.parent = (<np.intp_t *> self.parent_arr.data)             # <<<<<<<<<<<<<<
  * 
- *     cdef Amalgamation merge_amalgamations(self, np.double_t g, Amalgamation other, np.double_t jump1, np.double_t jump2):             # <<<<<<<<<<<<<<
- *         cdef:
- *             np.intp_t osize, oclusters
- */
-
-static struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_merge_amalgamations(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, CYTHON_UNUSED __pyx_t_5numpy_double_t __pyx_v_g, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_other, __pyx_t_5numpy_double_t __pyx_v_jump1, __pyx_t_5numpy_double_t __pyx_v_jump2) {
-  __pyx_t_5numpy_intp_t __pyx_v_osize;
-  __pyx_t_5numpy_intp_t __pyx_v_oclusters;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_ret = 0;
-  PyObject *__pyx_v_o_energies = NULL;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  __pyx_t_5numpy_intp_t __pyx_t_3;
-  __pyx_t_5numpy_intp_t __pyx_t_4;
-  PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  PyObject *__pyx_t_7 = NULL;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("merge_amalgamations", 0);
-
-  /* "druhg/_druhg_amalgamation.pyx":58
- *             np.intp_t osize, oclusters
- *             Amalgamation ret
- *         ret = self             # <<<<<<<<<<<<<<
- *         if self.size == 1:
- *             ret = Amalgamation() # the self will be reused
- */
-  __Pyx_INCREF((PyObject *)__pyx_v_self);
-  __pyx_v_ret = __pyx_v_self;
-
-  /* "druhg/_druhg_amalgamation.pyx":59
- *             Amalgamation ret
- *         ret = self
- *         if self.size == 1:             # <<<<<<<<<<<<<<
- *             ret = Amalgamation() # the self will be reused
- * # ----------------------
+ *         if buffer_fast is None:
  */
-  __pyx_t_1 = ((__pyx_v_self->size == 1) != 0);
-  if (__pyx_t_1) {
+  /*else*/ {
+    __pyx_t_5 = ((PyObject *)__pyx_v_self->parent_arr);
+    __Pyx_INCREF(__pyx_t_5);
+    __pyx_v_self->parent = ((__pyx_t_5numpy_intp_t *)__pyx_f_5numpy_7ndarray_4data_data(((PyArrayObject *)__pyx_t_5)));
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  }
 
-    /* "druhg/_druhg_amalgamation.pyx":60
- *         ret = self
- *         if self.size == 1:
- *             ret = Amalgamation() # the self will be reused             # <<<<<<<<<<<<<<
- * # ----------------------
- *         osize, oclusters, o_energies = other.size, other.clusters, other.energies
- */
-    __pyx_t_2 = __Pyx_PyObject_CallNoArg(((PyObject *)__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 60, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF_SET(__pyx_v_ret, ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_2));
-    __pyx_t_2 = 0;
-
-    /* "druhg/_druhg_amalgamation.pyx":59
- *             Amalgamation ret
- *         ret = self
- *         if self.size == 1:             # <<<<<<<<<<<<<<
- *             ret = Amalgamation() # the self will be reused
- * # ----------------------
+  /* "druhg/_druhg_unionfind.pyx":41
+ *             self.parent = (<np.intp_t *> self.parent_arr.data)
+ * 
+ *         if buffer_fast is None:             # <<<<<<<<<<<<<<
+ *             return
+ *         elif len(self.fast_arr) < N:
  */
-  }
+  __pyx_t_3 = (__pyx_v_buffer_fast == Py_None);
+  __pyx_t_2 = (__pyx_t_3 != 0);
+  if (__pyx_t_2) {
 
-  /* "druhg/_druhg_amalgamation.pyx":62
- *             ret = Amalgamation() # the self will be reused
- * # ----------------------
- *         osize, oclusters, o_energies = other.size, other.clusters, other.energies             # <<<<<<<<<<<<<<
- * # ----------------------
- *         if jump1 >= 0:
- */
-  __pyx_t_3 = __pyx_v_other->size;
-  __pyx_t_4 = __pyx_v_other->clusters;
-  __pyx_t_2 = __pyx_v_other->energies;
-  __Pyx_INCREF(__pyx_t_2);
-  __pyx_v_osize = __pyx_t_3;
-  __pyx_v_oclusters = __pyx_t_4;
-  __pyx_v_o_energies = ((PyObject*)__pyx_t_2);
-  __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_amalgamation.pyx":64
- *         osize, oclusters, o_energies = other.size, other.clusters, other.energies
- * # ----------------------
- *         if jump1 >= 0:             # <<<<<<<<<<<<<<
- *             ret.clusters = 1
- *             ret.energies = {ret.size : (1., jump1,)}
+    /* "druhg/_druhg_unionfind.pyx":42
+ * 
+ *         if buffer_fast is None:
+ *             return             # <<<<<<<<<<<<<<
+ *         elif len(self.fast_arr) < N:
+ *             print('ERROR: fast_arr is too small', len(self.fast_arr), N)
  */
-  __pyx_t_1 = ((__pyx_v_jump1 >= 0.0) != 0);
-  if (__pyx_t_1) {
+    __pyx_r = 0;
+    goto __pyx_L0;
 
-    /* "druhg/_druhg_amalgamation.pyx":65
- * # ----------------------
- *         if jump1 >= 0:
- *             ret.clusters = 1             # <<<<<<<<<<<<<<
- *             ret.energies = {ret.size : (1., jump1,)}
- * # ----------------------
- */
-    __pyx_v_ret->clusters = 1;
-
-    /* "druhg/_druhg_amalgamation.pyx":66
- *         if jump1 >= 0:
- *             ret.clusters = 1
- *             ret.energies = {ret.size : (1., jump1,)}             # <<<<<<<<<<<<<<
- * # ----------------------
- *         if jump2 >= 0:
- */
-    __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 66, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_ret->size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 66, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_jump1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 66, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 66, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_7);
-    __Pyx_INCREF(__pyx_float_1_);
-    __Pyx_GIVEREF(__pyx_float_1_);
-    PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_float_1_);
-    __Pyx_GIVEREF(__pyx_t_6);
-    PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_t_6);
-    __pyx_t_6 = 0;
-    if (PyDict_SetItem(__pyx_t_2, __pyx_t_5, __pyx_t_7) < 0) __PYX_ERR(0, 66, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __Pyx_GIVEREF(__pyx_t_2);
-    __Pyx_GOTREF(__pyx_v_ret->energies);
-    __Pyx_DECREF(__pyx_v_ret->energies);
-    __pyx_v_ret->energies = ((PyObject*)__pyx_t_2);
-    __pyx_t_2 = 0;
-
-    /* "druhg/_druhg_amalgamation.pyx":64
- *         osize, oclusters, o_energies = other.size, other.clusters, other.energies
- * # ----------------------
- *         if jump1 >= 0:             # <<<<<<<<<<<<<<
- *             ret.clusters = 1
- *             ret.energies = {ret.size : (1., jump1,)}
+    /* "druhg/_druhg_unionfind.pyx":41
+ *             self.parent = (<np.intp_t *> self.parent_arr.data)
+ * 
+ *         if buffer_fast is None:             # <<<<<<<<<<<<<<
+ *             return
+ *         elif len(self.fast_arr) < N:
  */
   }
 
-  /* "druhg/_druhg_amalgamation.pyx":68
- *             ret.energies = {ret.size : (1., jump1,)}
- * # ----------------------
- *         if jump2 >= 0:             # <<<<<<<<<<<<<<
- *             oclusters = 1
- *             o_energies = {osize : (1., jump2,)}
+  /* "druhg/_druhg_unionfind.pyx":43
+ *         if buffer_fast is None:
+ *             return
+ *         elif len(self.fast_arr) < N:             # <<<<<<<<<<<<<<
+ *             print('ERROR: fast_arr is too small', len(self.fast_arr), N)
+ *             return
  */
-  __pyx_t_1 = ((__pyx_v_jump2 >= 0.0) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_5 = ((PyObject *)__pyx_v_self->fast_arr);
+  __Pyx_INCREF(__pyx_t_5);
+  __pyx_t_4 = PyObject_Length(__pyx_t_5); if (unlikely(__pyx_t_4 == ((Py_ssize_t)-1))) __PYX_ERR(0, 43, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_2 = ((__pyx_t_4 < __pyx_v_N) != 0);
+  if (__pyx_t_2) {
 
-    /* "druhg/_druhg_amalgamation.pyx":69
- * # ----------------------
- *         if jump2 >= 0:
- *             oclusters = 1             # <<<<<<<<<<<<<<
- *             o_energies = {osize : (1., jump2,)}
- * # ----------------------
- */
-    __pyx_v_oclusters = 1;
-
-    /* "druhg/_druhg_amalgamation.pyx":70
- *         if jump2 >= 0:
- *             oclusters = 1
- *             o_energies = {osize : (1., jump2,)}             # <<<<<<<<<<<<<<
- * # ----------------------
- * 
- */
-    __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 70, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_7 = PyInt_FromSsize_t(__pyx_v_osize); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 70, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_jump2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 70, __pyx_L1_error)
+    /* "druhg/_druhg_unionfind.pyx":44
+ *             return
+ *         elif len(self.fast_arr) < N:
+ *             print('ERROR: fast_arr is too small', len(self.fast_arr), N)             # <<<<<<<<<<<<<<
+ *             return
+ *         else:
+ */
+    __pyx_t_5 = ((PyObject *)__pyx_v_self->fast_arr);
+    __Pyx_INCREF(__pyx_t_5);
+    __pyx_t_4 = PyObject_Length(__pyx_t_5); if (unlikely(__pyx_t_4 == ((Py_ssize_t)-1))) __PYX_ERR(0, 44, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = PyInt_FromSsize_t(__pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 70, __pyx_L1_error)
+    __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_N); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __Pyx_INCREF(__pyx_float_1_);
-    __Pyx_GIVEREF(__pyx_float_1_);
-    PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_float_1_);
+    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 44, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_kp_u_ERROR_fast_arr_is_too_small);
+    __Pyx_GIVEREF(__pyx_kp_u_ERROR_fast_arr_is_too_small);
+    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_kp_u_ERROR_fast_arr_is_too_small);
     __Pyx_GIVEREF(__pyx_t_5);
-    PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_5);
+    __Pyx_GIVEREF(__pyx_t_6);
+    PyTuple_SET_ITEM(__pyx_t_1, 2, __pyx_t_6);
     __pyx_t_5 = 0;
-    if (PyDict_SetItem(__pyx_t_2, __pyx_t_7, __pyx_t_6) < 0) __PYX_ERR(0, 70, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __pyx_t_6 = 0;
+    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_1, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 44, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_DECREF_SET(__pyx_v_o_energies, ((PyObject*)__pyx_t_2));
-    __pyx_t_2 = 0;
 
-    /* "druhg/_druhg_amalgamation.pyx":68
- *             ret.energies = {ret.size : (1., jump1,)}
- * # ----------------------
- *         if jump2 >= 0:             # <<<<<<<<<<<<<<
- *             oclusters = 1
- *             o_energies = {osize : (1., jump2,)}
+    /* "druhg/_druhg_unionfind.pyx":45
+ *         elif len(self.fast_arr) < N:
+ *             print('ERROR: fast_arr is too small', len(self.fast_arr), N)
+ *             return             # <<<<<<<<<<<<<<
+ *         else:
+ *             self.fast = (<np.intp_t *> self.fast_arr.data)
  */
-  }
+    __pyx_r = 0;
+    goto __pyx_L0;
 
-  /* "druhg/_druhg_amalgamation.pyx":73
- * # ----------------------
- * 
- *         ret._amalgamate(osize, oclusters, o_energies)             # <<<<<<<<<<<<<<
- *         return ret
- * 
+    /* "druhg/_druhg_unionfind.pyx":43
+ *         if buffer_fast is None:
+ *             return
+ *         elif len(self.fast_arr) < N:             # <<<<<<<<<<<<<<
+ *             print('ERROR: fast_arr is too small', len(self.fast_arr), N)
+ *             return
  */
-  ((struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_ret->__pyx_vtab)->_amalgamate(__pyx_v_ret, __pyx_v_osize, __pyx_v_oclusters, __pyx_v_o_energies);
+  }
 
-  /* "druhg/_druhg_amalgamation.pyx":74
- * 
- *         ret._amalgamate(osize, oclusters, o_energies)
- *         return ret             # <<<<<<<<<<<<<<
- * 
+  /* "druhg/_druhg_unionfind.pyx":47
+ *             return
+ *         else:
+ *             self.fast = (<np.intp_t *> self.fast_arr.data)             # <<<<<<<<<<<<<<
  * 
+ *     cdef np.intp_t nullify(self):
  */
-  __Pyx_XDECREF((PyObject *)__pyx_r);
-  __Pyx_INCREF((PyObject *)__pyx_v_ret);
-  __pyx_r = __pyx_v_ret;
-  goto __pyx_L0;
+  /*else*/ {
+    __pyx_t_6 = ((PyObject *)__pyx_v_self->fast_arr);
+    __Pyx_INCREF(__pyx_t_6);
+    __pyx_v_self->fast = ((__pyx_t_5numpy_intp_t *)__pyx_f_5numpy_7ndarray_4data_data(((PyArrayObject *)__pyx_t_6)));
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  }
 
-  /* "druhg/_druhg_amalgamation.pyx":54
- *         self.energies = energy
+  /* "druhg/_druhg_unionfind.pyx":22
+ * cdef class UnionFind (object):
  * 
- *     cdef Amalgamation merge_amalgamations(self, np.double_t g, Amalgamation other, np.double_t jump1, np.double_t jump2):             # <<<<<<<<<<<<<<
- *         cdef:
- *             np.intp_t osize, oclusters
+ *     def __init__(self, np.intp_t N, buffer_parents, buffer_fast=None):             # <<<<<<<<<<<<<<
+ *         self.p_size = N
+ *         self.next_label = N + 1
  */
 
   /* function exit code */
+  __pyx_r = 0;
+  goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_5);
   __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_7);
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.Amalgamation.merge_amalgamations", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = 0;
+  __Pyx_AddTraceback("druhg._druhg_unionfind.UnionFind.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = -1;
   __pyx_L0:;
-  __Pyx_XDECREF((PyObject *)__pyx_v_ret);
-  __Pyx_XDECREF(__pyx_v_o_energies);
-  __Pyx_XGIVEREF((PyObject *)__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_amalgamation.pyx":77
- * 
+/* "druhg/_druhg_unionfind.pyx":49
+ *             self.fast = (<np.intp_t *> self.fast_arr.data)
  * 
- *     cdef np.double_t border_overcoming(self, np.double_t g, Amalgamation other, np.double_t PRECISION):             # <<<<<<<<<<<<<<
- *         # returns negative if cluster didn't form
- *         # limit_to_ought:
- */
-
-static __pyx_t_5numpy_double_t __pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_border_overcoming(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, __pyx_t_5numpy_double_t __pyx_v_g, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_other, __pyx_t_5numpy_double_t __pyx_v_PRECISION) {
-  __pyx_t_5numpy_double_t __pyx_v_insides;
-  __pyx_t_5numpy_double_t __pyx_v_limit;
-  __pyx_t_5numpy_double_t __pyx_v_clusters;
-  __pyx_t_5numpy_double_t __pyx_v_osize;
-  __pyx_t_5numpy_double_t __pyx_v_n;
-  __pyx_t_5numpy_double_t __pyx_v_c;
-  __pyx_t_5numpy_double_t __pyx_v_e;
-  __pyx_t_5numpy_double_t __pyx_r;
+ *     cdef np.intp_t nullify(self):             # <<<<<<<<<<<<<<
+ *         self.parent_arr[:2 * self.p_size] = 0
+ *         i = self.p_size
+ */
+
+static __pyx_t_5numpy_intp_t __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_nullify(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self) {
+  PyObject *__pyx_v_i = NULL;
+  __pyx_t_5numpy_intp_t __pyx_r;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
+  PyObject *__pyx_t_1 = NULL;
   int __pyx_t_2;
   __pyx_t_5numpy_intp_t __pyx_t_3;
-  double __pyx_t_4;
-  double __pyx_t_5;
-  PyObject *__pyx_t_6 = NULL;
-  Py_ssize_t __pyx_t_7;
-  Py_ssize_t __pyx_t_8;
-  int __pyx_t_9;
-  PyObject *__pyx_t_10 = NULL;
-  int __pyx_t_11;
-  __pyx_t_5numpy_double_t __pyx_t_12;
-  PyObject *__pyx_t_13 = NULL;
-  PyObject *__pyx_t_14 = NULL;
-  PyObject *__pyx_t_15 = NULL;
-  PyObject *(*__pyx_t_16)(PyObject *);
-  __pyx_t_5numpy_double_t __pyx_t_17;
-  __pyx_t_5numpy_double_t __pyx_t_18;
+  Py_ssize_t __pyx_t_4;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("border_overcoming", 0);
+  __Pyx_RefNannySetupContext("nullify", 0);
 
-  /* "druhg/_druhg_amalgamation.pyx":86
- *         cdef np.double_t n, c, e
- * 
- *         if self.energies is None:             # <<<<<<<<<<<<<<
- *             return g # first connection always clusterize
+  /* "druhg/_druhg_unionfind.pyx":50
  * 
+ *     cdef np.intp_t nullify(self):
+ *         self.parent_arr[:2 * self.p_size] = 0             # <<<<<<<<<<<<<<
+ *         i = self.p_size
+ *         while i!=0:
  */
-  __pyx_t_1 = (__pyx_v_self->energies == ((PyObject*)Py_None));
-  __pyx_t_2 = (__pyx_t_1 != 0);
-  if (__pyx_t_2) {
+  if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_self->parent_arr), __pyx_int_0, 0, (2 * __pyx_v_self->p_size), NULL, NULL, NULL, 0, 1, 0) < 0) __PYX_ERR(0, 50, __pyx_L1_error)
 
-    /* "druhg/_druhg_amalgamation.pyx":87
- * 
- *         if self.energies is None:
- *             return g # first connection always clusterize             # <<<<<<<<<<<<<<
- * 
- *         clusters = self.clusters - 1
+  /* "druhg/_druhg_unionfind.pyx":51
+ *     cdef np.intp_t nullify(self):
+ *         self.parent_arr[:2 * self.p_size] = 0
+ *         i = self.p_size             # <<<<<<<<<<<<<<
+ *         while i!=0:
+ *             i -= 1
  */
-    __pyx_r = __pyx_v_g;
-    goto __pyx_L0;
+  __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_self->p_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 51, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_v_i = __pyx_t_1;
+  __pyx_t_1 = 0;
 
-    /* "druhg/_druhg_amalgamation.pyx":86
- *         cdef np.double_t n, c, e
- * 
- *         if self.energies is None:             # <<<<<<<<<<<<<<
- *             return g # first connection always clusterize
- * 
+  /* "druhg/_druhg_unionfind.pyx":52
+ *         self.parent_arr[:2 * self.p_size] = 0
+ *         i = self.p_size
+ *         while i!=0:             # <<<<<<<<<<<<<<
+ *             i -= 1
+ *             self.fast[i] = i
  */
-  }
-
-  /* "druhg/_druhg_amalgamation.pyx":89
- *             return g # first connection always clusterize
- * 
- *         clusters = self.clusters - 1             # <<<<<<<<<<<<<<
- *         osize = other.size
+  while (1) {
+    __pyx_t_1 = __Pyx_PyInt_NeObjC(__pyx_v_i, __pyx_int_0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 52, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_2 < 0))) __PYX_ERR(0, 52, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    if (!__pyx_t_2) break;
+
+    /* "druhg/_druhg_unionfind.pyx":53
+ *         i = self.p_size
+ *         while i!=0:
+ *             i -= 1             # <<<<<<<<<<<<<<
+ *             self.fast[i] = i
  * 
  */
-  __pyx_v_clusters = (__pyx_v_self->clusters - 1);
+    __pyx_t_1 = __Pyx_PyInt_SubtractObjC(__pyx_v_i, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 53, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF_SET(__pyx_v_i, __pyx_t_1);
+    __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":90
- * 
- *         clusters = self.clusters - 1
- *         osize = other.size             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_unionfind.pyx":54
+ *         while i!=0:
+ *             i -= 1
+ *             self.fast[i] = i             # <<<<<<<<<<<<<<
  * 
- *         insides, limit = 0., 0.
+ *     cdef np.intp_t mark_up(self, np.intp_t n):
  */
-  __pyx_t_3 = __pyx_v_other->size;
-  __pyx_v_osize = __pyx_t_3;
+    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_v_i); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 54, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyIndex_AsSsize_t(__pyx_v_i); if (unlikely((__pyx_t_4 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(0, 54, __pyx_L1_error)
+    (__pyx_v_self->fast[__pyx_t_4]) = __pyx_t_3;
+  }
 
-  /* "druhg/_druhg_amalgamation.pyx":92
- *         osize = other.size
+  /* "druhg/_druhg_unionfind.pyx":49
+ *             self.fast = (<np.intp_t *> self.fast_arr.data)
  * 
- *         insides, limit = 0., 0.             # <<<<<<<<<<<<<<
- *         for n in self.energies:
- *             c,e = self.energies[n]
+ *     cdef np.intp_t nullify(self):             # <<<<<<<<<<<<<<
+ *         self.parent_arr[:2 * self.p_size] = 0
+ *         i = self.p_size
  */
-  __pyx_t_4 = 0.;
-  __pyx_t_5 = 0.;
-  __pyx_v_insides = __pyx_t_4;
-  __pyx_v_limit = __pyx_t_5;
 
-  /* "druhg/_druhg_amalgamation.pyx":93
+  /* function exit code */
+  __pyx_r = 0;
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_WriteUnraisable("druhg._druhg_unionfind.UnionFind.nullify", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
+  __pyx_r = 0;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_i);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "druhg/_druhg_unionfind.pyx":56
+ *             self.fast[i] = i
  * 
- *         insides, limit = 0., 0.
- *         for n in self.energies:             # <<<<<<<<<<<<<<
- *             c,e = self.energies[n]
- *             insides += n/min(n, clusters) * e
+ *     cdef np.intp_t mark_up(self, np.intp_t n):             # <<<<<<<<<<<<<<
+ *         assert self.fast != NULL
+ *         cdef np.intp_t p
  */
-  __pyx_t_7 = 0;
-  if (unlikely(__pyx_v_self->energies == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-    __PYX_ERR(0, 93, __pyx_L1_error)
-  }
-  __pyx_t_10 = __Pyx_dict_iterator(__pyx_v_self->energies, 1, ((PyObject *)NULL), (&__pyx_t_8), (&__pyx_t_9)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 93, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_6);
-  __pyx_t_6 = __pyx_t_10;
-  __pyx_t_10 = 0;
-  while (1) {
-    __pyx_t_11 = __Pyx_dict_iter_next(__pyx_t_6, __pyx_t_8, &__pyx_t_7, &__pyx_t_10, NULL, NULL, __pyx_t_9);
-    if (unlikely(__pyx_t_11 == 0)) break;
-    if (unlikely(__pyx_t_11 == -1)) __PYX_ERR(0, 93, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_12 = __pyx_PyFloat_AsDouble(__pyx_t_10); if (unlikely((__pyx_t_12 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 93, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __pyx_v_n = __pyx_t_12;
-
-    /* "druhg/_druhg_amalgamation.pyx":94
- *         insides, limit = 0., 0.
- *         for n in self.energies:
- *             c,e = self.energies[n]             # <<<<<<<<<<<<<<
- *             insides += n/min(n, clusters) * e
- *             limit += min(n, osize)/n * c
- */
-    if (unlikely(__pyx_v_self->energies == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-      __PYX_ERR(0, 94, __pyx_L1_error)
-    }
-    __pyx_t_10 = PyFloat_FromDouble(__pyx_v_n); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 94, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_13 = __Pyx_PyDict_GetItem(__pyx_v_self->energies, __pyx_t_10); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 94, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    if ((likely(PyTuple_CheckExact(__pyx_t_13))) || (PyList_CheckExact(__pyx_t_13))) {
-      PyObject* sequence = __pyx_t_13;
-      Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
-      if (unlikely(size != 2)) {
-        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
-        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 94, __pyx_L1_error)
-      }
-      #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-      if (likely(PyTuple_CheckExact(sequence))) {
-        __pyx_t_10 = PyTuple_GET_ITEM(sequence, 0); 
-        __pyx_t_14 = PyTuple_GET_ITEM(sequence, 1); 
-      } else {
-        __pyx_t_10 = PyList_GET_ITEM(sequence, 0); 
-        __pyx_t_14 = PyList_GET_ITEM(sequence, 1); 
-      }
-      __Pyx_INCREF(__pyx_t_10);
-      __Pyx_INCREF(__pyx_t_14);
-      #else
-      __pyx_t_10 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 94, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_14 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 94, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_14);
-      #endif
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-    } else {
-      Py_ssize_t index = -1;
-      __pyx_t_15 = PyObject_GetIter(__pyx_t_13); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 94, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_15);
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-      __pyx_t_16 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_15);
-      index = 0; __pyx_t_10 = __pyx_t_16(__pyx_t_15); if (unlikely(!__pyx_t_10)) goto __pyx_L6_unpacking_failed;
-      __Pyx_GOTREF(__pyx_t_10);
-      index = 1; __pyx_t_14 = __pyx_t_16(__pyx_t_15); if (unlikely(!__pyx_t_14)) goto __pyx_L6_unpacking_failed;
-      __Pyx_GOTREF(__pyx_t_14);
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_16(__pyx_t_15), 2) < 0) __PYX_ERR(0, 94, __pyx_L1_error)
-      __pyx_t_16 = NULL;
-      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
-      goto __pyx_L7_unpacking_done;
-      __pyx_L6_unpacking_failed:;
-      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
-      __pyx_t_16 = NULL;
-      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 94, __pyx_L1_error)
-      __pyx_L7_unpacking_done:;
-    }
-    __pyx_t_12 = __pyx_PyFloat_AsDouble(__pyx_t_10); if (unlikely((__pyx_t_12 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 94, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __pyx_t_17 = __pyx_PyFloat_AsDouble(__pyx_t_14); if (unlikely((__pyx_t_17 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 94, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
-    __pyx_v_c = __pyx_t_12;
-    __pyx_v_e = __pyx_t_17;
-
-    /* "druhg/_druhg_amalgamation.pyx":95
- *         for n in self.energies:
- *             c,e = self.energies[n]
- *             insides += n/min(n, clusters) * e             # <<<<<<<<<<<<<<
- *             limit += min(n, osize)/n * c
- *             # print (n, e, c, n/min(n, clusters) * e, min(n, osize)/n * c)
- */
-    __pyx_t_17 = __pyx_v_clusters;
-    __pyx_t_12 = __pyx_v_n;
-    if (((__pyx_t_17 < __pyx_t_12) != 0)) {
-      __pyx_t_18 = __pyx_t_17;
-    } else {
-      __pyx_t_18 = __pyx_t_12;
-    }
-    __pyx_v_insides = (__pyx_v_insides + ((__pyx_v_n / __pyx_t_18) * __pyx_v_e));
 
-    /* "druhg/_druhg_amalgamation.pyx":96
- *             c,e = self.energies[n]
- *             insides += n/min(n, clusters) * e
- *             limit += min(n, osize)/n * c             # <<<<<<<<<<<<<<
- *             # print (n, e, c, n/min(n, clusters) * e, min(n, osize)/n * c)
+static __pyx_t_5numpy_intp_t __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_mark_up(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n) {
+  __pyx_t_5numpy_intp_t __pyx_v_p;
+  __pyx_t_5numpy_intp_t __pyx_r;
+  __Pyx_RefNannyDeclarations
+  int __pyx_t_1;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("mark_up", 0);
+
+  /* "druhg/_druhg_unionfind.pyx":57
+ * 
+ *     cdef np.intp_t mark_up(self, np.intp_t n):
+ *         assert self.fast != NULL             # <<<<<<<<<<<<<<
+ *         cdef np.intp_t p
  * 
  */
-    __pyx_t_18 = __pyx_v_osize;
-    __pyx_t_17 = __pyx_v_n;
-    if (((__pyx_t_18 < __pyx_t_17) != 0)) {
-      __pyx_t_12 = __pyx_t_18;
-    } else {
-      __pyx_t_12 = __pyx_t_17;
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = ((__pyx_v_self->fast != NULL) != 0);
+    if (unlikely(!__pyx_t_1)) {
+      __Pyx_Raise(__pyx_builtin_AssertionError, 0, 0, 0);
+      __PYX_ERR(0, 57, __pyx_L1_error)
     }
-    __pyx_v_limit = (__pyx_v_limit + ((__pyx_t_12 / __pyx_v_n) * __pyx_v_c));
   }
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  #else
+  if ((1)); else __PYX_ERR(0, 57, __pyx_L1_error)
+  #endif
 
-  /* "druhg/_druhg_amalgamation.pyx":99
- *             # print (n, e, c, n/min(n, clusters) * e, min(n, osize)/n * c)
+  /* "druhg/_druhg_unionfind.pyx":60
+ *         cdef np.intp_t p
  * 
- *         limit *= g-PRECISION             # <<<<<<<<<<<<<<
- * 
- *         # print('..',g, 'c', clusters, other.clusters, 's', self.size, other.size, 'r', insides,  limit)
+ *         p = self.fast[n]             # <<<<<<<<<<<<<<
+ *         while self.parent[p] != 0:
+ *             assert p != self.parent[p]
  */
-  __pyx_v_limit = (__pyx_v_limit * (__pyx_v_g - __pyx_v_PRECISION));
+  __pyx_v_p = (__pyx_v_self->fast[__pyx_v_n]);
 
-  /* "druhg/_druhg_amalgamation.pyx":105
- *         # print (insides > limit,'=============================================')
- * 
- *         if insides < limit:             # <<<<<<<<<<<<<<
- *             return g
+  /* "druhg/_druhg_unionfind.pyx":61
  * 
+ *         p = self.fast[n]
+ *         while self.parent[p] != 0:             # <<<<<<<<<<<<<<
+ *             assert p != self.parent[p]
+ *             p = self.parent[p]
  */
-  __pyx_t_2 = ((__pyx_v_insides < __pyx_v_limit) != 0);
-  if (__pyx_t_2) {
+  while (1) {
+    __pyx_t_1 = (((__pyx_v_self->parent[__pyx_v_p]) != 0) != 0);
+    if (!__pyx_t_1) break;
 
-    /* "druhg/_druhg_amalgamation.pyx":106
- * 
- *         if insides < limit:
- *             return g             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_unionfind.pyx":62
+ *         p = self.fast[n]
+ *         while self.parent[p] != 0:
+ *             assert p != self.parent[p]             # <<<<<<<<<<<<<<
+ *             p = self.parent[p]
+ * 
+ */
+    #ifndef CYTHON_WITHOUT_ASSERTIONS
+    if (unlikely(!Py_OptimizeFlag)) {
+      __pyx_t_1 = ((__pyx_v_p != (__pyx_v_self->parent[__pyx_v_p])) != 0);
+      if (unlikely(!__pyx_t_1)) {
+        __Pyx_Raise(__pyx_builtin_AssertionError, 0, 0, 0);
+        __PYX_ERR(0, 62, __pyx_L1_error)
+      }
+    }
+    #else
+    if ((1)); else __PYX_ERR(0, 62, __pyx_L1_error)
+    #endif
+
+    /* "druhg/_druhg_unionfind.pyx":63
+ *         while self.parent[p] != 0:
+ *             assert p != self.parent[p]
+ *             p = self.parent[p]             # <<<<<<<<<<<<<<
  * 
- *         return -1.
+ *         self.fast[n] = p
  */
-    __pyx_r = __pyx_v_g;
-    goto __pyx_L0;
+    __pyx_v_p = (__pyx_v_self->parent[__pyx_v_p]);
+  }
 
-    /* "druhg/_druhg_amalgamation.pyx":105
- *         # print (insides > limit,'=============================================')
+  /* "druhg/_druhg_unionfind.pyx":65
+ *             p = self.parent[p]
  * 
- *         if insides < limit:             # <<<<<<<<<<<<<<
- *             return g
+ *         self.fast[n] = p             # <<<<<<<<<<<<<<
+ *         return p
  * 
  */
-  }
+  (__pyx_v_self->fast[__pyx_v_n]) = __pyx_v_p;
 
-  /* "druhg/_druhg_amalgamation.pyx":108
- *             return g
+  /* "druhg/_druhg_unionfind.pyx":66
  * 
- *         return -1.             # <<<<<<<<<<<<<<
+ *         self.fast[n] = p
+ *         return p             # <<<<<<<<<<<<<<
  * 
- *     cdef np.double_t border_overcoming_rev(self, np.double_t g, Amalgamation other, np.double_t PRECISION):
+ *     cdef np.intp_t is_same_parent(self, np.intp_t p, np.intp_t on):
  */
-  __pyx_r = -1.;
+  __pyx_r = __pyx_v_p;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_amalgamation.pyx":77
- * 
+  /* "druhg/_druhg_unionfind.pyx":56
+ *             self.fast[i] = i
  * 
- *     cdef np.double_t border_overcoming(self, np.double_t g, Amalgamation other, np.double_t PRECISION):             # <<<<<<<<<<<<<<
- *         # returns negative if cluster didn't form
- *         # limit_to_ought:
+ *     cdef np.intp_t mark_up(self, np.intp_t n):             # <<<<<<<<<<<<<<
+ *         assert self.fast != NULL
+ *         cdef np.intp_t p
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_13);
-  __Pyx_XDECREF(__pyx_t_14);
-  __Pyx_XDECREF(__pyx_t_15);
-  __Pyx_WriteUnraisable("druhg._druhg_amalgamation.Amalgamation.border_overcoming", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
+  __Pyx_WriteUnraisable("druhg._druhg_unionfind.UnionFind.mark_up", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_amalgamation.pyx":110
- *         return -1.
+/* "druhg/_druhg_unionfind.pyx":68
+ *         return p
  * 
- *     cdef np.double_t border_overcoming_rev(self, np.double_t g, Amalgamation other, np.double_t PRECISION):             # <<<<<<<<<<<<<<
- *         # returns negative if cluster didn't form
- *         # limit_to_ought:
- */
-
-static __pyx_t_5numpy_double_t __pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_border_overcoming_rev(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, __pyx_t_5numpy_double_t __pyx_v_g, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_other, __pyx_t_5numpy_double_t __pyx_v_PRECISION) {
-  __pyx_t_5numpy_double_t __pyx_v_insides;
-  __pyx_t_5numpy_double_t __pyx_v_limit;
-  __pyx_t_5numpy_double_t __pyx_v_clusters;
-  __pyx_t_5numpy_double_t __pyx_v_osize;
-  __pyx_t_5numpy_double_t __pyx_v_n;
-  __pyx_t_5numpy_double_t __pyx_v_c;
-  __pyx_t_5numpy_double_t __pyx_v_e;
-  __pyx_t_5numpy_double_t __pyx_r;
+ *     cdef np.intp_t is_same_parent(self, np.intp_t p, np.intp_t on):             # <<<<<<<<<<<<<<
+ *         assert self.fast != NULL
+ *         cdef np.intp_t op
+ */
+
+static __pyx_t_5numpy_intp_t __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_is_same_parent(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_p, __pyx_t_5numpy_intp_t __pyx_v_on) {
+  __pyx_t_5numpy_intp_t __pyx_v_op;
+  __pyx_t_5numpy_intp_t __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
-  int __pyx_t_2;
-  __pyx_t_5numpy_intp_t __pyx_t_3;
-  double __pyx_t_4;
-  double __pyx_t_5;
-  PyObject *__pyx_t_6 = NULL;
-  Py_ssize_t __pyx_t_7;
-  Py_ssize_t __pyx_t_8;
-  int __pyx_t_9;
-  PyObject *__pyx_t_10 = NULL;
-  int __pyx_t_11;
-  __pyx_t_5numpy_double_t __pyx_t_12;
-  PyObject *__pyx_t_13 = NULL;
-  PyObject *__pyx_t_14 = NULL;
-  PyObject *__pyx_t_15 = NULL;
-  PyObject *(*__pyx_t_16)(PyObject *);
-  __pyx_t_5numpy_double_t __pyx_t_17;
-  __pyx_t_5numpy_double_t __pyx_t_18;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("border_overcoming_rev", 0);
+  __Pyx_RefNannySetupContext("is_same_parent", 0);
 
-  /* "druhg/_druhg_amalgamation.pyx":119
- *         cdef np.double_t n, c, e
+  /* "druhg/_druhg_unionfind.pyx":69
  * 
- *         if self.energies is None:             # <<<<<<<<<<<<<<
- *             return pow(g, -1) # first connection always clusterize
- * 
- */
-  __pyx_t_1 = (__pyx_v_self->energies == ((PyObject*)Py_None));
-  __pyx_t_2 = (__pyx_t_1 != 0);
-  if (__pyx_t_2) {
+ *     cdef np.intp_t is_same_parent(self, np.intp_t p, np.intp_t on):
+ *         assert self.fast != NULL             # <<<<<<<<<<<<<<
+ *         cdef np.intp_t op
+ *         op = self.fast[on]
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = ((__pyx_v_self->fast != NULL) != 0);
+    if (unlikely(!__pyx_t_1)) {
+      __Pyx_Raise(__pyx_builtin_AssertionError, 0, 0, 0);
+      __PYX_ERR(0, 69, __pyx_L1_error)
+    }
+  }
+  #else
+  if ((1)); else __PYX_ERR(0, 69, __pyx_L1_error)
+  #endif
 
-    /* "druhg/_druhg_amalgamation.pyx":120
- * 
- *         if self.energies is None:
- *             return pow(g, -1) # first connection always clusterize             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_unionfind.pyx":71
+ *         assert self.fast != NULL
+ *         cdef np.intp_t op
+ *         op = self.fast[on]             # <<<<<<<<<<<<<<
  * 
- *         clusters = self.clusters - 1
+ *         if p == op:
  */
-    __pyx_r = pow(__pyx_v_g, -1.0);
-    goto __pyx_L0;
+  __pyx_v_op = (__pyx_v_self->fast[__pyx_v_on]);
 
-    /* "druhg/_druhg_amalgamation.pyx":119
- *         cdef np.double_t n, c, e
- * 
- *         if self.energies is None:             # <<<<<<<<<<<<<<
- *             return pow(g, -1) # first connection always clusterize
+  /* "druhg/_druhg_unionfind.pyx":73
+ *         op = self.fast[on]
  * 
+ *         if p == op:             # <<<<<<<<<<<<<<
+ *             return 1
+ *         return p == self.mark_up(on)
  */
-  }
+  __pyx_t_1 = ((__pyx_v_p == __pyx_v_op) != 0);
+  if (__pyx_t_1) {
 
-  /* "druhg/_druhg_amalgamation.pyx":122
- *             return pow(g, -1) # first connection always clusterize
+    /* "druhg/_druhg_unionfind.pyx":74
  * 
- *         clusters = self.clusters - 1             # <<<<<<<<<<<<<<
- *         osize = other.size
+ *         if p == op:
+ *             return 1             # <<<<<<<<<<<<<<
+ *         return p == self.mark_up(on)
  * 
  */
-  __pyx_v_clusters = (__pyx_v_self->clusters - 1);
+    __pyx_r = 1;
+    goto __pyx_L0;
 
-  /* "druhg/_druhg_amalgamation.pyx":123
- * 
- *         clusters = self.clusters - 1
- *         osize = other.size             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_unionfind.pyx":73
+ *         op = self.fast[on]
  * 
- *         insides, limit = 0., 0.
+ *         if p == op:             # <<<<<<<<<<<<<<
+ *             return 1
+ *         return p == self.mark_up(on)
  */
-  __pyx_t_3 = __pyx_v_other->size;
-  __pyx_v_osize = __pyx_t_3;
+  }
 
-  /* "druhg/_druhg_amalgamation.pyx":125
- *         osize = other.size
+  /* "druhg/_druhg_unionfind.pyx":75
+ *         if p == op:
+ *             return 1
+ *         return p == self.mark_up(on)             # <<<<<<<<<<<<<<
  * 
- *         insides, limit = 0., 0.             # <<<<<<<<<<<<<<
- *         for n in self.energies:
- *             c,e = self.energies[n]
+ *     cdef void union(self, np.intp_t n, np.intp_t on, np.intp_t p, np.intp_t op):
  */
-  __pyx_t_4 = 0.;
-  __pyx_t_5 = 0.;
-  __pyx_v_insides = __pyx_t_4;
-  __pyx_v_limit = __pyx_t_5;
+  __pyx_r = (__pyx_v_p == ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self->__pyx_vtab)->mark_up(__pyx_v_self, __pyx_v_on));
+  goto __pyx_L0;
 
-  /* "druhg/_druhg_amalgamation.pyx":126
+  /* "druhg/_druhg_unionfind.pyx":68
+ *         return p
  * 
- *         insides, limit = 0., 0.
- *         for n in self.energies:             # <<<<<<<<<<<<<<
- *             c,e = self.energies[n]
- *             insides += min(n, clusters)/n * e
+ *     cdef np.intp_t is_same_parent(self, np.intp_t p, np.intp_t on):             # <<<<<<<<<<<<<<
+ *         assert self.fast != NULL
+ *         cdef np.intp_t op
  */
-  __pyx_t_7 = 0;
-  if (unlikely(__pyx_v_self->energies == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-    __PYX_ERR(0, 126, __pyx_L1_error)
-  }
-  __pyx_t_10 = __Pyx_dict_iterator(__pyx_v_self->energies, 1, ((PyObject *)NULL), (&__pyx_t_8), (&__pyx_t_9)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 126, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_6);
-  __pyx_t_6 = __pyx_t_10;
-  __pyx_t_10 = 0;
-  while (1) {
-    __pyx_t_11 = __Pyx_dict_iter_next(__pyx_t_6, __pyx_t_8, &__pyx_t_7, &__pyx_t_10, NULL, NULL, __pyx_t_9);
-    if (unlikely(__pyx_t_11 == 0)) break;
-    if (unlikely(__pyx_t_11 == -1)) __PYX_ERR(0, 126, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_12 = __pyx_PyFloat_AsDouble(__pyx_t_10); if (unlikely((__pyx_t_12 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 126, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __pyx_v_n = __pyx_t_12;
-
-    /* "druhg/_druhg_amalgamation.pyx":127
- *         insides, limit = 0., 0.
- *         for n in self.energies:
- *             c,e = self.energies[n]             # <<<<<<<<<<<<<<
- *             insides += min(n, clusters)/n * e
- *             limit += n/min(n, osize) * c
- */
-    if (unlikely(__pyx_v_self->energies == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-      __PYX_ERR(0, 127, __pyx_L1_error)
-    }
-    __pyx_t_10 = PyFloat_FromDouble(__pyx_v_n); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 127, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_13 = __Pyx_PyDict_GetItem(__pyx_v_self->energies, __pyx_t_10); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 127, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    if ((likely(PyTuple_CheckExact(__pyx_t_13))) || (PyList_CheckExact(__pyx_t_13))) {
-      PyObject* sequence = __pyx_t_13;
-      Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
-      if (unlikely(size != 2)) {
-        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
-        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 127, __pyx_L1_error)
-      }
-      #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-      if (likely(PyTuple_CheckExact(sequence))) {
-        __pyx_t_10 = PyTuple_GET_ITEM(sequence, 0); 
-        __pyx_t_14 = PyTuple_GET_ITEM(sequence, 1); 
-      } else {
-        __pyx_t_10 = PyList_GET_ITEM(sequence, 0); 
-        __pyx_t_14 = PyList_GET_ITEM(sequence, 1); 
-      }
-      __Pyx_INCREF(__pyx_t_10);
-      __Pyx_INCREF(__pyx_t_14);
-      #else
-      __pyx_t_10 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 127, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_14 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 127, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_14);
-      #endif
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-    } else {
-      Py_ssize_t index = -1;
-      __pyx_t_15 = PyObject_GetIter(__pyx_t_13); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 127, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_15);
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-      __pyx_t_16 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_15);
-      index = 0; __pyx_t_10 = __pyx_t_16(__pyx_t_15); if (unlikely(!__pyx_t_10)) goto __pyx_L6_unpacking_failed;
-      __Pyx_GOTREF(__pyx_t_10);
-      index = 1; __pyx_t_14 = __pyx_t_16(__pyx_t_15); if (unlikely(!__pyx_t_14)) goto __pyx_L6_unpacking_failed;
-      __Pyx_GOTREF(__pyx_t_14);
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_16(__pyx_t_15), 2) < 0) __PYX_ERR(0, 127, __pyx_L1_error)
-      __pyx_t_16 = NULL;
-      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
-      goto __pyx_L7_unpacking_done;
-      __pyx_L6_unpacking_failed:;
-      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
-      __pyx_t_16 = NULL;
-      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 127, __pyx_L1_error)
-      __pyx_L7_unpacking_done:;
-    }
-    __pyx_t_12 = __pyx_PyFloat_AsDouble(__pyx_t_10); if (unlikely((__pyx_t_12 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 127, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __pyx_t_17 = __pyx_PyFloat_AsDouble(__pyx_t_14); if (unlikely((__pyx_t_17 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 127, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
-    __pyx_v_c = __pyx_t_12;
-    __pyx_v_e = __pyx_t_17;
-
-    /* "druhg/_druhg_amalgamation.pyx":128
- *         for n in self.energies:
- *             c,e = self.energies[n]
- *             insides += min(n, clusters)/n * e             # <<<<<<<<<<<<<<
- *             limit += n/min(n, osize) * c
- * 
- */
-    __pyx_t_17 = __pyx_v_clusters;
-    __pyx_t_12 = __pyx_v_n;
-    if (((__pyx_t_17 < __pyx_t_12) != 0)) {
-      __pyx_t_18 = __pyx_t_17;
-    } else {
-      __pyx_t_18 = __pyx_t_12;
-    }
-    __pyx_v_insides = (__pyx_v_insides + ((__pyx_t_18 / __pyx_v_n) * __pyx_v_e));
 
-    /* "druhg/_druhg_amalgamation.pyx":129
- *             c,e = self.energies[n]
- *             insides += min(n, clusters)/n * e
- *             limit += n/min(n, osize) * c             # <<<<<<<<<<<<<<
- * 
- *         insides *= g-PRECISION
- */
-    __pyx_t_18 = __pyx_v_osize;
-    __pyx_t_17 = __pyx_v_n;
-    if (((__pyx_t_18 < __pyx_t_17) != 0)) {
-      __pyx_t_12 = __pyx_t_18;
-    } else {
-      __pyx_t_12 = __pyx_t_17;
-    }
-    __pyx_v_limit = (__pyx_v_limit + ((__pyx_v_n / __pyx_t_12) * __pyx_v_c));
-  }
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_WriteUnraisable("druhg._druhg_unionfind.UnionFind.is_same_parent", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
+  __pyx_r = 0;
+  __pyx_L0:;
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
 
-  /* "druhg/_druhg_amalgamation.pyx":131
- *             limit += n/min(n, osize) * c
+/* "druhg/_druhg_unionfind.pyx":77
+ *         return p == self.mark_up(on)
  * 
- *         insides *= g-PRECISION             # <<<<<<<<<<<<<<
- *         if insides > limit:
- *             return pow(g, -1)
+ *     cdef void union(self, np.intp_t n, np.intp_t on, np.intp_t p, np.intp_t op):             # <<<<<<<<<<<<<<
+ *         assert self.fast != NULL
+ *         self.fast[n] = self.fast[on] = self.next_label
  */
-  __pyx_v_insides = (__pyx_v_insides * (__pyx_v_g - __pyx_v_PRECISION));
 
-  /* "druhg/_druhg_amalgamation.pyx":132
- * 
- *         insides *= g-PRECISION
- *         if insides > limit:             # <<<<<<<<<<<<<<
- *             return pow(g, -1)
+static void __pyx_f_5druhg_16_druhg_unionfind_9UnionFind_union(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n, __pyx_t_5numpy_intp_t __pyx_v_on, __pyx_t_5numpy_intp_t __pyx_v_p, __pyx_t_5numpy_intp_t __pyx_v_op) {
+  __Pyx_RefNannyDeclarations
+  int __pyx_t_1;
+  __pyx_t_5numpy_intp_t __pyx_t_2;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("union", 0);
+
+  /* "druhg/_druhg_unionfind.pyx":78
  * 
- */
-  __pyx_t_2 = ((__pyx_v_insides > __pyx_v_limit) != 0);
-  if (__pyx_t_2) {
+ *     cdef void union(self, np.intp_t n, np.intp_t on, np.intp_t p, np.intp_t op):
+ *         assert self.fast != NULL             # <<<<<<<<<<<<<<
+ *         self.fast[n] = self.fast[on] = self.next_label
+ *         self.parent[p] = self.parent[op] = self.next_label
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = ((__pyx_v_self->fast != NULL) != 0);
+    if (unlikely(!__pyx_t_1)) {
+      __Pyx_Raise(__pyx_builtin_AssertionError, 0, 0, 0);
+      __PYX_ERR(0, 78, __pyx_L1_error)
+    }
+  }
+  #else
+  if ((1)); else __PYX_ERR(0, 78, __pyx_L1_error)
+  #endif
 
-    /* "druhg/_druhg_amalgamation.pyx":133
- *         insides *= g-PRECISION
- *         if insides > limit:
- *             return pow(g, -1)             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_unionfind.pyx":79
+ *     cdef void union(self, np.intp_t n, np.intp_t on, np.intp_t p, np.intp_t op):
+ *         assert self.fast != NULL
+ *         self.fast[n] = self.fast[on] = self.next_label             # <<<<<<<<<<<<<<
+ *         self.parent[p] = self.parent[op] = self.next_label
  * 
- *         return -1.
  */
-    __pyx_r = pow(__pyx_v_g, -1.0);
-    goto __pyx_L0;
+  __pyx_t_2 = __pyx_v_self->next_label;
+  (__pyx_v_self->fast[__pyx_v_n]) = __pyx_t_2;
+  (__pyx_v_self->fast[__pyx_v_on]) = __pyx_t_2;
 
-    /* "druhg/_druhg_amalgamation.pyx":132
- * 
- *         insides *= g-PRECISION
- *         if insides > limit:             # <<<<<<<<<<<<<<
- *             return pow(g, -1)
+  /* "druhg/_druhg_unionfind.pyx":80
+ *         assert self.fast != NULL
+ *         self.fast[n] = self.fast[on] = self.next_label
+ *         self.parent[p] = self.parent[op] = self.next_label             # <<<<<<<<<<<<<<
  * 
+ *         self.next_label += 1
  */
-  }
+  __pyx_t_2 = __pyx_v_self->next_label;
+  (__pyx_v_self->parent[__pyx_v_p]) = __pyx_t_2;
+  (__pyx_v_self->parent[__pyx_v_op]) = __pyx_t_2;
 
-  /* "druhg/_druhg_amalgamation.pyx":135
- *             return pow(g, -1)
+  /* "druhg/_druhg_unionfind.pyx":82
+ *         self.parent[p] = self.parent[op] = self.next_label
  * 
- *         return -1.             # <<<<<<<<<<<<<<
+ *         self.next_label += 1             # <<<<<<<<<<<<<<
  */
-  __pyx_r = -1.;
-  goto __pyx_L0;
+  __pyx_v_self->next_label = (__pyx_v_self->next_label + 1);
 
-  /* "druhg/_druhg_amalgamation.pyx":110
- *         return -1.
+  /* "druhg/_druhg_unionfind.pyx":77
+ *         return p == self.mark_up(on)
  * 
- *     cdef np.double_t border_overcoming_rev(self, np.double_t g, Amalgamation other, np.double_t PRECISION):             # <<<<<<<<<<<<<<
- *         # returns negative if cluster didn't form
- *         # limit_to_ought:
+ *     cdef void union(self, np.intp_t n, np.intp_t on, np.intp_t p, np.intp_t op):             # <<<<<<<<<<<<<<
+ *         assert self.fast != NULL
+ *         self.fast[n] = self.fast[on] = self.next_label
  */
 
   /* function exit code */
+  goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_13);
-  __Pyx_XDECREF(__pyx_t_14);
-  __Pyx_XDECREF(__pyx_t_15);
-  __Pyx_WriteUnraisable("druhg._druhg_amalgamation.Amalgamation.border_overcoming_rev", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
-  __pyx_r = 0;
+  __Pyx_WriteUnraisable("druhg._druhg_unionfind.UnionFind.union", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
-  return __pyx_r;
 }
 
 /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     cdef tuple state
- *     cdef object _dict
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
+ * def __setstate_cython__(self, __pyx_state):
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_3__reduce_cython__(PyObject *__pyx_v_self, 
+static PyObject *__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_3__reduce_cython__(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_19_druhg_amalgamation_12Amalgamation_3__reduce_cython__ = {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_3__reduce_cython__(PyObject *__pyx_v_self, 
+static PyMethodDef __pyx_mdef_5druhg_16_druhg_unionfind_9UnionFind_3__reduce_cython__ = {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_3__reduce_cython__(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
   #if !CYTHON_METH_FASTCALL
@@ -4203,270 +3882,77 @@
   CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
   if (unlikely(__pyx_nargs > 0)) {
     __Pyx_RaiseArgtupleInvalid("__reduce_cython__", 1, 0, 0, __pyx_nargs); return NULL;}
   if (unlikely(__pyx_kwds) && __Pyx_NumKwargs_FASTCALL(__pyx_kwds) && unlikely(!__Pyx_CheckKeywordStrings(__pyx_kwds, "__reduce_cython__", 0))) return NULL;
-  __pyx_r = __pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation_2__reduce_cython__(((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_self));
+  __pyx_r = __pyx_pf_5druhg_16_druhg_unionfind_9UnionFind_2__reduce_cython__(((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation_2__reduce_cython__(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self) {
-  PyObject *__pyx_v_state = 0;
-  PyObject *__pyx_v__dict = 0;
-  int __pyx_v_use_setstate;
+static PyObject *__pyx_pf_5druhg_16_druhg_unionfind_9UnionFind_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  int __pyx_t_4;
-  int __pyx_t_5;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
-  /* "(tree fragment)":5
- *     cdef object _dict
- *     cdef bint use_setstate
- *     state = (self.clusters, self.energies, self.size)             # <<<<<<<<<<<<<<
- *     _dict = getattr(self, '__dict__', None)
- *     if _dict is not None:
- */
-  __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_self->clusters); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_self->size); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_1);
-  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
-  __Pyx_INCREF(__pyx_v_self->energies);
-  __Pyx_GIVEREF(__pyx_v_self->energies);
-  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_v_self->energies);
-  __Pyx_GIVEREF(__pyx_t_2);
-  PyTuple_SET_ITEM(__pyx_t_3, 2, __pyx_t_2);
-  __pyx_t_1 = 0;
-  __pyx_t_2 = 0;
-  __pyx_v_state = ((PyObject*)__pyx_t_3);
-  __pyx_t_3 = 0;
-
-  /* "(tree fragment)":6
- *     cdef bint use_setstate
- *     state = (self.clusters, self.energies, self.size)
- *     _dict = getattr(self, '__dict__', None)             # <<<<<<<<<<<<<<
- *     if _dict is not None:
- *         state += (_dict,)
- */
-  __pyx_t_3 = __Pyx_GetAttr3(((PyObject *)__pyx_v_self), __pyx_n_s_dict, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_v__dict = __pyx_t_3;
-  __pyx_t_3 = 0;
-
-  /* "(tree fragment)":7
- *     state = (self.clusters, self.energies, self.size)
- *     _dict = getattr(self, '__dict__', None)
- *     if _dict is not None:             # <<<<<<<<<<<<<<
- *         state += (_dict,)
- *         use_setstate = True
- */
-  __pyx_t_4 = (__pyx_v__dict != Py_None);
-  __pyx_t_5 = (__pyx_t_4 != 0);
-  if (__pyx_t_5) {
-
-    /* "(tree fragment)":8
- *     _dict = getattr(self, '__dict__', None)
- *     if _dict is not None:
- *         state += (_dict,)             # <<<<<<<<<<<<<<
- *         use_setstate = True
- *     else:
- */
-    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 8, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_INCREF(__pyx_v__dict);
-    __Pyx_GIVEREF(__pyx_v__dict);
-    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v__dict);
-    __pyx_t_2 = PyNumber_InPlaceAdd(__pyx_v_state, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 8, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_DECREF_SET(__pyx_v_state, ((PyObject*)__pyx_t_2));
-    __pyx_t_2 = 0;
-
-    /* "(tree fragment)":9
- *     if _dict is not None:
- *         state += (_dict,)
- *         use_setstate = True             # <<<<<<<<<<<<<<
- *     else:
- *         use_setstate = self.energies is not None
- */
-    __pyx_v_use_setstate = 1;
-
-    /* "(tree fragment)":7
- *     state = (self.clusters, self.energies, self.size)
- *     _dict = getattr(self, '__dict__', None)
- *     if _dict is not None:             # <<<<<<<<<<<<<<
- *         state += (_dict,)
- *         use_setstate = True
- */
-    goto __pyx_L3;
-  }
-
-  /* "(tree fragment)":11
- *         use_setstate = True
- *     else:
- *         use_setstate = self.energies is not None             # <<<<<<<<<<<<<<
- *     if use_setstate:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, None), state
- */
-  /*else*/ {
-    __pyx_t_5 = (__pyx_v_self->energies != ((PyObject*)Py_None));
-    __pyx_v_use_setstate = __pyx_t_5;
-  }
-  __pyx_L3:;
-
-  /* "(tree fragment)":12
- *     else:
- *         use_setstate = self.energies is not None
- *     if use_setstate:             # <<<<<<<<<<<<<<
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, None), state
- *     else:
- */
-  __pyx_t_5 = (__pyx_v_use_setstate != 0);
-  if (__pyx_t_5) {
-
-    /* "(tree fragment)":13
- *         use_setstate = self.energies is not None
- *     if use_setstate:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, None), state             # <<<<<<<<<<<<<<
- *     else:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)
- */
-    __Pyx_XDECREF(__pyx_r);
-    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_pyx_unpickle_Amalgamation); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 13, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 13, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_INCREF(__pyx_int_182298202);
-    __Pyx_GIVEREF(__pyx_int_182298202);
-    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_int_182298202);
-    __Pyx_INCREF(Py_None);
-    __Pyx_GIVEREF(Py_None);
-    PyTuple_SET_ITEM(__pyx_t_3, 2, Py_None);
-    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 13, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_GIVEREF(__pyx_t_2);
-    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_2);
-    __Pyx_GIVEREF(__pyx_t_3);
-    PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_3);
-    __Pyx_INCREF(__pyx_v_state);
-    __Pyx_GIVEREF(__pyx_v_state);
-    PyTuple_SET_ITEM(__pyx_t_1, 2, __pyx_v_state);
-    __pyx_t_2 = 0;
-    __pyx_t_3 = 0;
-    __pyx_r = __pyx_t_1;
-    __pyx_t_1 = 0;
-    goto __pyx_L0;
-
-    /* "(tree fragment)":12
- *     else:
- *         use_setstate = self.energies is not None
- *     if use_setstate:             # <<<<<<<<<<<<<<
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, None), state
- *     else:
- */
-  }
-
-  /* "(tree fragment)":15
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, None), state
- *     else:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)             # <<<<<<<<<<<<<<
+  /* "(tree fragment)":2
+ * def __reduce_cython__(self):
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
- *     __pyx_unpickle_Amalgamation__set_state(self, __pyx_state)
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  */
-  /*else*/ {
-    __Pyx_XDECREF(__pyx_r);
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_pyx_unpickle_Amalgamation); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 15, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 15, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_INCREF(__pyx_int_182298202);
-    __Pyx_GIVEREF(__pyx_int_182298202);
-    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_int_182298202);
-    __Pyx_INCREF(__pyx_v_state);
-    __Pyx_GIVEREF(__pyx_v_state);
-    PyTuple_SET_ITEM(__pyx_t_3, 2, __pyx_v_state);
-    __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 15, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_GIVEREF(__pyx_t_1);
-    PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
-    __Pyx_GIVEREF(__pyx_t_3);
-    PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_3);
-    __pyx_t_1 = 0;
-    __pyx_t_3 = 0;
-    __pyx_r = __pyx_t_2;
-    __pyx_t_2 = 0;
-    goto __pyx_L0;
-  }
+  __Pyx_Raise(__pyx_builtin_TypeError, __pyx_kp_s_self_fast_self_parent_cannot_be, 0, 0);
+  __PYX_ERR(1, 2, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     cdef tuple state
- *     cdef object _dict
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
+ * def __setstate_cython__(self, __pyx_state):
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.Amalgamation.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_unionfind.UnionFind.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
-  __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_state);
-  __Pyx_XDECREF(__pyx_v__dict);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "(tree fragment)":16
- *     else:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)
+/* "(tree fragment)":3
+ * def __reduce_cython__(self):
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_unpickle_Amalgamation__set_state(self, __pyx_state)
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_5__setstate_cython__(PyObject *__pyx_v_self, 
+static PyObject *__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_5__setstate_cython__(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_19_druhg_amalgamation_12Amalgamation_5__setstate_cython__ = {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_5__setstate_cython__(PyObject *__pyx_v_self, 
+static PyMethodDef __pyx_mdef_5druhg_16_druhg_unionfind_9UnionFind_5__setstate_cython__ = {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_5__setstate_cython__(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
-  PyObject *__pyx_v___pyx_state = 0;
+  CYTHON_UNUSED PyObject *__pyx_v___pyx_state = 0;
   #if !CYTHON_METH_FASTCALL
   CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
   #endif
   CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
@@ -4488,499 +3974,70 @@
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
         if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_pyx_state)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 16, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 3, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__setstate_cython__") < 0)) __PYX_ERR(1, 16, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__setstate_cython__") < 0)) __PYX_ERR(1, 3, __pyx_L3_error)
       }
     } else if (unlikely(__pyx_nargs != 1)) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
     }
     __pyx_v___pyx_state = values[0];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__setstate_cython__", 1, 1, 1, __pyx_nargs); __PYX_ERR(1, 16, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__setstate_cython__", 1, 1, 1, __pyx_nargs); __PYX_ERR(1, 3, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.Amalgamation.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_unionfind.UnionFind.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation_4__setstate_cython__(((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_self), __pyx_v___pyx_state);
+  __pyx_r = __pyx_pf_5druhg_16_druhg_unionfind_9UnionFind_4__setstate_cython__(((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self), __pyx_v___pyx_state);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_19_druhg_amalgamation_12Amalgamation_4__setstate_cython__(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_5druhg_16_druhg_unionfind_9UnionFind_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
-  /* "(tree fragment)":17
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)
+  /* "(tree fragment)":4
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  * def __setstate_cython__(self, __pyx_state):
- *     __pyx_unpickle_Amalgamation__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"             # <<<<<<<<<<<<<<
  */
-  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_v___pyx_state))) __PYX_ERR(1, 17, __pyx_L1_error)
-  __pyx_t_1 = __pyx_f_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_Raise(__pyx_builtin_TypeError, __pyx_kp_s_self_fast_self_parent_cannot_be, 0, 0);
+  __PYX_ERR(1, 4, __pyx_L1_error)
 
-  /* "(tree fragment)":16
- *     else:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)
+  /* "(tree fragment)":3
+ * def __reduce_cython__(self):
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_unpickle_Amalgamation__set_state(self, __pyx_state)
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  */
 
   /* function exit code */
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
-  goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.Amalgamation.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_unionfind.UnionFind.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
-  __pyx_L0:;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":1
- * def __pyx_unpickle_Amalgamation(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
- *     cdef object __pyx_PickleError
- *     cdef object __pyx_result
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_5druhg_19_druhg_amalgamation_1__pyx_unpickle_Amalgamation(PyObject *__pyx_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_19_druhg_amalgamation_1__pyx_unpickle_Amalgamation = {"__pyx_unpickle_Amalgamation", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_19_druhg_amalgamation_1__pyx_unpickle_Amalgamation, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_19_druhg_amalgamation_1__pyx_unpickle_Amalgamation(PyObject *__pyx_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-) {
-  PyObject *__pyx_v___pyx_type = 0;
-  long __pyx_v___pyx_checksum;
-  PyObject *__pyx_v___pyx_state = 0;
-  #if !CYTHON_METH_FASTCALL
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  #endif
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__pyx_unpickle_Amalgamation (wrapper)", 0);
-  {
-    #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
-    #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
-    #endif
-    PyObject* values[3] = {0,0,0};
-    if (__pyx_kwds) {
-      Py_ssize_t kw_args;
-      switch (__pyx_nargs) {
-        case  3: values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
-        case  2: values[1] = __Pyx_Arg_FASTCALL(__pyx_args, 1);
-        CYTHON_FALLTHROUGH;
-        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-        CYTHON_FALLTHROUGH;
-        case  0: break;
-        default: goto __pyx_L5_argtuple_error;
-      }
-      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
-      switch (__pyx_nargs) {
-        case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_pyx_type)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L3_error)
-        else goto __pyx_L5_argtuple_error;
-        CYTHON_FALLTHROUGH;
-        case  1:
-        if (likely((values[1] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_pyx_checksum)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Amalgamation", 1, 3, 3, 1); __PYX_ERR(1, 1, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  2:
-        if (likely((values[2] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_pyx_state)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Amalgamation", 1, 3, 3, 2); __PYX_ERR(1, 1, __pyx_L3_error)
-        }
-      }
-      if (unlikely(kw_args > 0)) {
-        const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__pyx_unpickle_Amalgamation") < 0)) __PYX_ERR(1, 1, __pyx_L3_error)
-      }
-    } else if (unlikely(__pyx_nargs != 3)) {
-      goto __pyx_L5_argtuple_error;
-    } else {
-      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-      values[1] = __Pyx_Arg_FASTCALL(__pyx_args, 1);
-      values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
-    }
-    __pyx_v___pyx_type = values[0];
-    __pyx_v___pyx_checksum = __Pyx_PyInt_As_long(values[1]); if (unlikely((__pyx_v___pyx_checksum == (long)-1) && PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L3_error)
-    __pyx_v___pyx_state = values[2];
-  }
-  goto __pyx_L4_argument_unpacking_done;
-  __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Amalgamation", 1, 3, 3, __pyx_nargs); __PYX_ERR(1, 1, __pyx_L3_error)
-  __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.__pyx_unpickle_Amalgamation", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __Pyx_RefNannyFinishContext();
-  return NULL;
-  __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_v___pyx_PickleError = 0;
-  PyObject *__pyx_v___pyx_result = 0;
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  PyObject *__pyx_t_4 = NULL;
-  int __pyx_t_5;
-  int __pyx_t_6;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__pyx_unpickle_Amalgamation", 0);
-
-  /* "(tree fragment)":4
- *     cdef object __pyx_PickleError
- *     cdef object __pyx_result
- *     if __pyx_checksum != 0xadda65a:             # <<<<<<<<<<<<<<
- *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum
- */
-  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0xadda65a) != 0);
-  if (__pyx_t_1) {
-
-    /* "(tree fragment)":5
- *     cdef object __pyx_result
- *     if __pyx_checksum != 0xadda65a:
- *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum
- *     __pyx_result = Amalgamation.__new__(__pyx_type)
- */
-    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_n_s_PickleError);
-    __Pyx_GIVEREF(__pyx_n_s_PickleError);
-    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
-    __pyx_t_3 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_t_2);
-    __pyx_v___pyx_PickleError = __pyx_t_2;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-    /* "(tree fragment)":6
- *     if __pyx_checksum != 0xadda65a:
- *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum             # <<<<<<<<<<<<<<
- *     __pyx_result = Amalgamation.__new__(__pyx_type)
- *     if __pyx_state is not None:
- */
-    __pyx_t_3 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0xad, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_Raise(__pyx_v___pyx_PickleError, __pyx_t_2, 0, 0);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __PYX_ERR(1, 6, __pyx_L1_error)
-
-    /* "(tree fragment)":4
- *     cdef object __pyx_PickleError
- *     cdef object __pyx_result
- *     if __pyx_checksum != 0xadda65a:             # <<<<<<<<<<<<<<
- *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum
- */
-  }
-
-  /* "(tree fragment)":7
- *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum
- *     __pyx_result = Amalgamation.__new__(__pyx_type)             # <<<<<<<<<<<<<<
- *     if __pyx_state is not None:
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)
- */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation), __pyx_n_s_new); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = NULL;
-  __pyx_t_5 = 0;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
-    if (likely(__pyx_t_4)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-      __Pyx_INCREF(__pyx_t_4);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_3, function);
-      __pyx_t_5 = 1;
-    }
-  }
-  {
-    PyObject *__pyx_callargs[2] = {__pyx_t_4, __pyx_v___pyx_type};
-    __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
-    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 7, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  }
-  __pyx_v___pyx_result = __pyx_t_2;
-  __pyx_t_2 = 0;
-
-  /* "(tree fragment)":8
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum
- *     __pyx_result = Amalgamation.__new__(__pyx_type)
- *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)
- *     return __pyx_result
- */
-  __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
-  __pyx_t_6 = (__pyx_t_1 != 0);
-  if (__pyx_t_6) {
-
-    /* "(tree fragment)":9
- *     __pyx_result = Amalgamation.__new__(__pyx_type)
- *     if __pyx_state is not None:
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
- *     return __pyx_result
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):
- */
-    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_v___pyx_state))) __PYX_ERR(1, 9, __pyx_L1_error)
-    __pyx_t_2 = __pyx_f_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation__set_state(((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 9, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-    /* "(tree fragment)":8
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xadda65a = (clusters, energies, size))" % __pyx_checksum
- *     __pyx_result = Amalgamation.__new__(__pyx_type)
- *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)
- *     return __pyx_result
- */
-  }
-
-  /* "(tree fragment)":10
- *     if __pyx_state is not None:
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)
- *     return __pyx_result             # <<<<<<<<<<<<<<
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]
- */
-  __Pyx_XDECREF(__pyx_r);
-  __Pyx_INCREF(__pyx_v___pyx_result);
-  __pyx_r = __pyx_v___pyx_result;
-  goto __pyx_L0;
-
-  /* "(tree fragment)":1
- * def __pyx_unpickle_Amalgamation(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
- *     cdef object __pyx_PickleError
- *     cdef object __pyx_result
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_4);
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.__pyx_unpickle_Amalgamation", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v___pyx_PickleError);
-  __Pyx_XDECREF(__pyx_v___pyx_result);
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":11
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)
- *     return __pyx_result
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]
- *     if len(__pyx_state) > 3 and hasattr(__pyx_result, '__dict__'):
- */
-
-static PyObject *__pyx_f_5druhg_19_druhg_amalgamation___pyx_unpickle_Amalgamation__set_state(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v___pyx_result, PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  __pyx_t_5numpy_intp_t __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  int __pyx_t_3;
-  Py_ssize_t __pyx_t_4;
-  int __pyx_t_5;
-  int __pyx_t_6;
-  PyObject *__pyx_t_7 = NULL;
-  PyObject *__pyx_t_8 = NULL;
-  int __pyx_t_9;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__pyx_unpickle_Amalgamation__set_state", 0);
-
-  /* "(tree fragment)":12
- *     return __pyx_result
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]             # <<<<<<<<<<<<<<
- *     if len(__pyx_state) > 3 and hasattr(__pyx_result, '__dict__'):
- *         __pyx_result.__dict__.update(__pyx_state[3])
- */
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 0)); if (unlikely((__pyx_t_1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __pyx_v___pyx_result->clusters = __pyx_t_1;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  if (!(likely(PyDict_CheckExact(PyTuple_GET_ITEM(__pyx_v___pyx_state, 1)))||((PyTuple_GET_ITEM(__pyx_v___pyx_state, 1)) == Py_None) || __Pyx_RaiseUnexpectedTypeError("dict", PyTuple_GET_ITEM(__pyx_v___pyx_state, 1)))) __PYX_ERR(1, 12, __pyx_L1_error)
-  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 1);
-  __Pyx_INCREF(__pyx_t_2);
-  __Pyx_GIVEREF(__pyx_t_2);
-  __Pyx_GOTREF(__pyx_v___pyx_result->energies);
-  __Pyx_DECREF(__pyx_v___pyx_result->energies);
-  __pyx_v___pyx_result->energies = ((PyObject*)__pyx_t_2);
-  __pyx_t_2 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 2)); if (unlikely((__pyx_t_1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __pyx_v___pyx_result->size = __pyx_t_1;
-
-  /* "(tree fragment)":13
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]
- *     if len(__pyx_state) > 3 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
- *         __pyx_result.__dict__.update(__pyx_state[3])
- */
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
-    __PYX_ERR(1, 13, __pyx_L1_error)
-  }
-  __pyx_t_4 = PyTuple_GET_SIZE(__pyx_v___pyx_state); if (unlikely(__pyx_t_4 == ((Py_ssize_t)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
-  __pyx_t_5 = ((__pyx_t_4 > 3) != 0);
-  if (__pyx_t_5) {
-  } else {
-    __pyx_t_3 = __pyx_t_5;
-    goto __pyx_L4_bool_binop_done;
-  }
-  __pyx_t_5 = __Pyx_HasAttr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(__pyx_t_5 == ((int)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
-  __pyx_t_6 = (__pyx_t_5 != 0);
-  __pyx_t_3 = __pyx_t_6;
-  __pyx_L4_bool_binop_done:;
-  if (__pyx_t_3) {
-
-    /* "(tree fragment)":14
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]
- *     if len(__pyx_state) > 3 and hasattr(__pyx_result, '__dict__'):
- *         __pyx_result.__dict__.update(__pyx_state[3])             # <<<<<<<<<<<<<<
- */
-    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 14, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_update); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_8);
-    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    if (unlikely(__pyx_v___pyx_state == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-      __PYX_ERR(1, 14, __pyx_L1_error)
-    }
-    __pyx_t_7 = NULL;
-    __pyx_t_9 = 0;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
-      __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_8);
-      if (likely(__pyx_t_7)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
-        __Pyx_INCREF(__pyx_t_7);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_8, function);
-        __pyx_t_9 = 1;
-      }
-    }
-    {
-      PyObject *__pyx_callargs[2] = {__pyx_t_7, PyTuple_GET_ITEM(__pyx_v___pyx_state, 3)};
-      __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_8, __pyx_callargs+1-__pyx_t_9, 1+__pyx_t_9);
-      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-      if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 14, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-    }
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-    /* "(tree fragment)":13
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]
- *     if len(__pyx_state) > 3 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
- *         __pyx_result.__dict__.update(__pyx_state[3])
- */
-  }
-
-  /* "(tree fragment)":11
- *         __pyx_unpickle_Amalgamation__set_state(<Amalgamation> __pyx_result, __pyx_state)
- *     return __pyx_result
- * cdef __pyx_unpickle_Amalgamation__set_state(Amalgamation __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_result.clusters = __pyx_state[0]; __pyx_result.energies = __pyx_state[1]; __pyx_result.size = __pyx_state[2]
- *     if len(__pyx_state) > 3 and hasattr(__pyx_result, '__dict__'):
- */
-
-  /* function exit code */
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_7);
-  __Pyx_XDECREF(__pyx_t_8);
-  __Pyx_AddTraceback("druhg._druhg_amalgamation.__pyx_unpickle_Amalgamation__set_state", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = 0;
-  __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":246
  * 
@@ -5756,15 +4813,15 @@
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":987
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__3, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 987, __pyx_L5_except_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 987, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(2, 987, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
@@ -5888,15 +4945,15 @@
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":993
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 993, __pyx_L5_except_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__3, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 993, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(2, 993, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
@@ -6020,15 +5077,15 @@
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":999
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 999, __pyx_L5_except_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__3, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 999, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(2, 999, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
@@ -6240,98 +5297,106 @@
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
-static struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation __pyx_vtable_5druhg_19_druhg_amalgamation_Amalgamation;
+static struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind __pyx_vtable_5druhg_16_druhg_unionfind_UnionFind;
 
-static PyObject *__pyx_tp_new_5druhg_19_druhg_amalgamation_Amalgamation(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *p;
+static PyObject *__pyx_tp_new_5druhg_16_druhg_unionfind_UnionFind(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
+  struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *p;
   PyObject *o;
   #if CYTHON_COMPILING_IN_LIMITED_API
   allocfunc alloc_func = (allocfunc)PyType_GetSlot(t, Py_tp_alloc);
   o = alloc_func(t, 0);
   #else
   if (likely(!__Pyx_PyType_HasFeature(t, Py_TPFLAGS_IS_ABSTRACT))) {
     o = (*t->tp_alloc)(t, 0);
   } else {
     o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
   }
   if (unlikely(!o)) return 0;
   #endif
-  p = ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)o);
-  p->__pyx_vtab = __pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation;
-  p->energies = ((PyObject*)Py_None); Py_INCREF(Py_None);
+  p = ((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)o);
+  p->__pyx_vtab = __pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind;
+  p->parent_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  p->fast_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
   return o;
 }
 
-static void __pyx_tp_dealloc_5druhg_19_druhg_amalgamation_Amalgamation(PyObject *o) {
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *p = (struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)o;
+static void __pyx_tp_dealloc_5druhg_16_druhg_unionfind_UnionFind(PyObject *o) {
+  struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *p = (struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)o;
   #if CYTHON_USE_TP_FINALIZE
   if (unlikely((PY_VERSION_HEX >= 0x03080000 || __Pyx_PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE)) && __Pyx_PyObject_GetSlot(o, tp_finalize, destructor)) && !_PyGC_FINALIZED(o)) {
-    if (__Pyx_PyObject_GetSlot(o, tp_dealloc, destructor) == __pyx_tp_dealloc_5druhg_19_druhg_amalgamation_Amalgamation) {
+    if (__Pyx_PyObject_GetSlot(o, tp_dealloc, destructor) == __pyx_tp_dealloc_5druhg_16_druhg_unionfind_UnionFind) {
       if (PyObject_CallFinalizerFromDealloc(o)) return;
     }
   }
   #endif
   PyObject_GC_UnTrack(o);
-  Py_CLEAR(p->energies);
+  Py_CLEAR(p->parent_arr);
+  Py_CLEAR(p->fast_arr);
   (*Py_TYPE(o)->tp_free)(o);
 }
 
-static int __pyx_tp_traverse_5druhg_19_druhg_amalgamation_Amalgamation(PyObject *o, visitproc v, void *a) {
+static int __pyx_tp_traverse_5druhg_16_druhg_unionfind_UnionFind(PyObject *o, visitproc v, void *a) {
   int e;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *p = (struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)o;
-  if (p->energies) {
-    e = (*v)(p->energies, a); if (e) return e;
+  struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *p = (struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)o;
+  if (p->parent_arr) {
+    e = (*v)(((PyObject *)p->parent_arr), a); if (e) return e;
+  }
+  if (p->fast_arr) {
+    e = (*v)(((PyObject *)p->fast_arr), a); if (e) return e;
   }
   return 0;
 }
 
-static int __pyx_tp_clear_5druhg_19_druhg_amalgamation_Amalgamation(PyObject *o) {
+static int __pyx_tp_clear_5druhg_16_druhg_unionfind_UnionFind(PyObject *o) {
   PyObject* tmp;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *p = (struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)o;
-  tmp = ((PyObject*)p->energies);
-  p->energies = ((PyObject*)Py_None); Py_INCREF(Py_None);
+  struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *p = (struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)o;
+  tmp = ((PyObject*)p->parent_arr);
+  p->parent_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->fast_arr);
+  p->fast_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
   Py_XDECREF(tmp);
   return 0;
 }
 
-static PyMethodDef __pyx_methods_5druhg_19_druhg_amalgamation_Amalgamation[] = {
-  {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
-  {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
+static PyMethodDef __pyx_methods_5druhg_16_druhg_unionfind_UnionFind[] = {
+  {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
+  {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
   {0, 0, 0, 0}
 };
 #if CYTHON_USE_TYPE_SPECS
-static PyType_Slot __pyx_type_5druhg_19_druhg_amalgamation_Amalgamation_slots[] = {
-  {Py_tp_dealloc, (void *)__pyx_tp_dealloc_5druhg_19_druhg_amalgamation_Amalgamation},
-  {Py_tp_traverse, (void *)__pyx_tp_traverse_5druhg_19_druhg_amalgamation_Amalgamation},
-  {Py_tp_clear, (void *)__pyx_tp_clear_5druhg_19_druhg_amalgamation_Amalgamation},
-  {Py_tp_methods, (void *)__pyx_methods_5druhg_19_druhg_amalgamation_Amalgamation},
-  {Py_tp_init, (void *)__pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_1__init__},
-  {Py_tp_new, (void *)__pyx_tp_new_5druhg_19_druhg_amalgamation_Amalgamation},
+static PyType_Slot __pyx_type_5druhg_16_druhg_unionfind_UnionFind_slots[] = {
+  {Py_tp_dealloc, (void *)__pyx_tp_dealloc_5druhg_16_druhg_unionfind_UnionFind},
+  {Py_tp_traverse, (void *)__pyx_tp_traverse_5druhg_16_druhg_unionfind_UnionFind},
+  {Py_tp_clear, (void *)__pyx_tp_clear_5druhg_16_druhg_unionfind_UnionFind},
+  {Py_tp_methods, (void *)__pyx_methods_5druhg_16_druhg_unionfind_UnionFind},
+  {Py_tp_init, (void *)__pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_1__init__},
+  {Py_tp_new, (void *)__pyx_tp_new_5druhg_16_druhg_unionfind_UnionFind},
   {0, 0},
 };
-static PyType_Spec __pyx_type_5druhg_19_druhg_amalgamation_Amalgamation_spec = {
-  "druhg._druhg_amalgamation.Amalgamation",
-  sizeof(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation),
+static PyType_Spec __pyx_type_5druhg_16_druhg_unionfind_UnionFind_spec = {
+  "druhg._druhg_unionfind.UnionFind",
+  sizeof(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind),
   0,
   Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC,
-  __pyx_type_5druhg_19_druhg_amalgamation_Amalgamation_slots,
+  __pyx_type_5druhg_16_druhg_unionfind_UnionFind_slots,
 };
 #else
 
-static PyTypeObject __pyx_type_5druhg_19_druhg_amalgamation_Amalgamation = {
+static PyTypeObject __pyx_type_5druhg_16_druhg_unionfind_UnionFind = {
   PyVarObject_HEAD_INIT(0, 0)
-  "druhg._druhg_amalgamation.""Amalgamation", /*tp_name*/
-  sizeof(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation), /*tp_basicsize*/
+  "druhg._druhg_unionfind.""UnionFind", /*tp_name*/
+  sizeof(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind), /*tp_basicsize*/
   0, /*tp_itemsize*/
-  __pyx_tp_dealloc_5druhg_19_druhg_amalgamation_Amalgamation, /*tp_dealloc*/
+  __pyx_tp_dealloc_5druhg_16_druhg_unionfind_UnionFind, /*tp_dealloc*/
   #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
   #endif
   #if PY_VERSION_HEX >= 0x030800b4
   0, /*tp_vectorcall_offset*/
   #endif
   0, /*tp_getattr*/
@@ -6350,33 +5415,33 @@
   0, /*tp_call*/
   0, /*tp_str*/
   0, /*tp_getattro*/
   0, /*tp_setattro*/
   0, /*tp_as_buffer*/
   Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
   0, /*tp_doc*/
-  __pyx_tp_traverse_5druhg_19_druhg_amalgamation_Amalgamation, /*tp_traverse*/
-  __pyx_tp_clear_5druhg_19_druhg_amalgamation_Amalgamation, /*tp_clear*/
+  __pyx_tp_traverse_5druhg_16_druhg_unionfind_UnionFind, /*tp_traverse*/
+  __pyx_tp_clear_5druhg_16_druhg_unionfind_UnionFind, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
-  __pyx_methods_5druhg_19_druhg_amalgamation_Amalgamation, /*tp_methods*/
+  __pyx_methods_5druhg_16_druhg_unionfind_UnionFind, /*tp_methods*/
   0, /*tp_members*/
   0, /*tp_getset*/
   0, /*tp_base*/
   0, /*tp_dict*/
   0, /*tp_descr_get*/
   0, /*tp_descr_set*/
   #if !CYTHON_USE_TYPE_SPECS
   0, /*tp_dictoffset*/
   #endif
-  __pyx_pw_5druhg_19_druhg_amalgamation_12Amalgamation_1__init__, /*tp_init*/
+  __pyx_pw_5druhg_16_druhg_unionfind_9UnionFind_1__init__, /*tp_init*/
   0, /*tp_alloc*/
-  __pyx_tp_new_5druhg_19_druhg_amalgamation_Amalgamation, /*tp_new*/
+  __pyx_tp_new_5druhg_16_druhg_unionfind_UnionFind, /*tp_new*/
   0, /*tp_free*/
   0, /*tp_is_gc*/
   0, /*tp_bases*/
   0, /*tp_mro*/
   0, /*tp_cache*/
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
@@ -6413,273 +5478,262 @@
     #define CYTHON_SMALL_CODE
 #endif
 #endif
 /* #### Code section: pystring_table ### */
 
 static __Pyx_StringTabEntry __pyx_string_tab[] = {
   #if CYTHON_USE_MODULE_STATE
-  {0, __pyx_k_Amalgamation, sizeof(__pyx_k_Amalgamation), 0, 0, 1, 1},
-  {0, __pyx_k_Amalgamation___reduce_cython, sizeof(__pyx_k_Amalgamation___reduce_cython), 0, 0, 1, 1},
-  {0, __pyx_k_Amalgamation___setstate_cython, sizeof(__pyx_k_Amalgamation___setstate_cython), 0, 0, 1, 1},
+  {0, __pyx_k_AssertionError, sizeof(__pyx_k_AssertionError), 0, 0, 1, 1},
+  {0, __pyx_k_ERROR_buffer_was_not_provided, sizeof(__pyx_k_ERROR_buffer_was_not_provided), 0, 1, 0, 0},
+  {0, __pyx_k_ERROR_fast_arr_is_too_small, sizeof(__pyx_k_ERROR_fast_arr_is_too_small), 0, 1, 0, 0},
+  {0, __pyx_k_ERROR_parent_arr_is_too_small, sizeof(__pyx_k_ERROR_parent_arr_is_too_small), 0, 1, 0, 0},
   {0, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
-  {0, __pyx_k_Incompatible_checksums_s_vs_0xad, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xad), 0, 0, 1, 0},
-  {0, __pyx_k_PickleError, sizeof(__pyx_k_PickleError), 0, 0, 1, 1},
-  {0, __pyx_k__12, sizeof(__pyx_k__12), 0, 0, 1, 1},
-  {0, __pyx_k__2, sizeof(__pyx_k__2), 0, 1, 0, 0},
-  {0, __pyx_k__5, sizeof(__pyx_k__5), 0, 0, 1, 1},
+  {0, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
+  {0, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
+  {0, __pyx_k_UnionFind, sizeof(__pyx_k_UnionFind), 0, 0, 1, 1},
+  {0, __pyx_k_UnionFind___reduce_cython, sizeof(__pyx_k_UnionFind___reduce_cython), 0, 0, 1, 1},
+  {0, __pyx_k_UnionFind___setstate_cython, sizeof(__pyx_k_UnionFind___setstate_cython), 0, 0, 1, 1},
+  {0, __pyx_k__11, sizeof(__pyx_k__11), 0, 0, 1, 1},
+  {0, __pyx_k__4, sizeof(__pyx_k__4), 0, 0, 1, 1},
+  {0, __pyx_k_allocate_unionfind_pair, sizeof(__pyx_k_allocate_unionfind_pair), 0, 0, 1, 1},
   {0, __pyx_k_asyncio_coroutines, sizeof(__pyx_k_asyncio_coroutines), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_fast, sizeof(__pyx_k_buffer_fast), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_parents, sizeof(__pyx_k_buffer_parents), 0, 0, 1, 1},
   {0, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
-  {0, __pyx_k_clusters, sizeof(__pyx_k_clusters), 0, 0, 1, 1},
-  {0, __pyx_k_dict, sizeof(__pyx_k_dict), 0, 0, 1, 1},
-  {0, __pyx_k_dict_2, sizeof(__pyx_k_dict_2), 0, 0, 1, 1},
   {0, __pyx_k_disable, sizeof(__pyx_k_disable), 0, 1, 0, 0},
-  {0, __pyx_k_druhg__druhg_amalgamation, sizeof(__pyx_k_druhg__druhg_amalgamation), 0, 0, 1, 1},
+  {0, __pyx_k_druhg__druhg_unionfind, sizeof(__pyx_k_druhg__druhg_unionfind), 0, 0, 1, 1},
+  {0, __pyx_k_druhg__druhg_unionfind_pyx, sizeof(__pyx_k_druhg__druhg_unionfind_pyx), 0, 0, 1, 0},
+  {0, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
   {0, __pyx_k_enable, sizeof(__pyx_k_enable), 0, 1, 0, 0},
   {0, __pyx_k_gc, sizeof(__pyx_k_gc), 0, 1, 0, 0},
-  {0, __pyx_k_get, sizeof(__pyx_k_get), 0, 0, 1, 1},
   {0, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
   {0, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {0, __pyx_k_initializing, sizeof(__pyx_k_initializing), 0, 0, 1, 1},
+  {0, __pyx_k_intp, sizeof(__pyx_k_intp), 0, 0, 1, 1},
   {0, __pyx_k_is_coroutine, sizeof(__pyx_k_is_coroutine), 0, 0, 1, 1},
   {0, __pyx_k_isenabled, sizeof(__pyx_k_isenabled), 0, 1, 0, 0},
   {0, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
   {0, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
-  {0, __pyx_k_new, sizeof(__pyx_k_new), 0, 0, 1, 1},
   {0, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
   {0, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {0, __pyx_k_numpy_core_multiarray_failed_to, sizeof(__pyx_k_numpy_core_multiarray_failed_to), 0, 1, 0, 0},
   {0, __pyx_k_numpy_core_umath_failed_to_impor, sizeof(__pyx_k_numpy_core_umath_failed_to_impor), 0, 1, 0, 0},
-  {0, __pyx_k_pickle, sizeof(__pyx_k_pickle), 0, 0, 1, 1},
-  {0, __pyx_k_pyx_PickleError, sizeof(__pyx_k_pyx_PickleError), 0, 0, 1, 1},
-  {0, __pyx_k_pyx_checksum, sizeof(__pyx_k_pyx_checksum), 0, 0, 1, 1},
-  {0, __pyx_k_pyx_result, sizeof(__pyx_k_pyx_result), 0, 0, 1, 1},
+  {0, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
   {0, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
-  {0, __pyx_k_pyx_type, sizeof(__pyx_k_pyx_type), 0, 0, 1, 1},
-  {0, __pyx_k_pyx_unpickle_Amalgamation, sizeof(__pyx_k_pyx_unpickle_Amalgamation), 0, 0, 1, 1},
   {0, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {0, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
   {0, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
   {0, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
   {0, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
+  {0, __pyx_k_self_fast_self_parent_cannot_be, sizeof(__pyx_k_self_fast_self_parent_cannot_be), 0, 0, 1, 0},
   {0, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
   {0, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
-  {0, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
   {0, __pyx_k_spec, sizeof(__pyx_k_spec), 0, 0, 1, 1},
-  {0, __pyx_k_state, sizeof(__pyx_k_state), 0, 0, 1, 1},
   {0, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
-  {0, __pyx_k_sys, sizeof(__pyx_k_sys), 0, 0, 1, 1},
   {0, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
-  {0, __pyx_k_update, sizeof(__pyx_k_update), 0, 0, 1, 1},
-  {0, __pyx_k_use_setstate, sizeof(__pyx_k_use_setstate), 0, 0, 1, 1},
+  {0, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   #else
-  {&__pyx_n_s_Amalgamation, __pyx_k_Amalgamation, sizeof(__pyx_k_Amalgamation), 0, 0, 1, 1},
-  {&__pyx_n_s_Amalgamation___reduce_cython, __pyx_k_Amalgamation___reduce_cython, sizeof(__pyx_k_Amalgamation___reduce_cython), 0, 0, 1, 1},
-  {&__pyx_n_s_Amalgamation___setstate_cython, __pyx_k_Amalgamation___setstate_cython, sizeof(__pyx_k_Amalgamation___setstate_cython), 0, 0, 1, 1},
+  {&__pyx_n_s_AssertionError, __pyx_k_AssertionError, sizeof(__pyx_k_AssertionError), 0, 0, 1, 1},
+  {&__pyx_kp_u_ERROR_buffer_was_not_provided, __pyx_k_ERROR_buffer_was_not_provided, sizeof(__pyx_k_ERROR_buffer_was_not_provided), 0, 1, 0, 0},
+  {&__pyx_kp_u_ERROR_fast_arr_is_too_small, __pyx_k_ERROR_fast_arr_is_too_small, sizeof(__pyx_k_ERROR_fast_arr_is_too_small), 0, 1, 0, 0},
+  {&__pyx_kp_u_ERROR_parent_arr_is_too_small, __pyx_k_ERROR_parent_arr_is_too_small, sizeof(__pyx_k_ERROR_parent_arr_is_too_small), 0, 1, 0, 0},
   {&__pyx_n_s_ImportError, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
-  {&__pyx_kp_s_Incompatible_checksums_s_vs_0xad, __pyx_k_Incompatible_checksums_s_vs_0xad, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xad), 0, 0, 1, 0},
-  {&__pyx_n_s_PickleError, __pyx_k_PickleError, sizeof(__pyx_k_PickleError), 0, 0, 1, 1},
-  {&__pyx_n_s__12, __pyx_k__12, sizeof(__pyx_k__12), 0, 0, 1, 1},
-  {&__pyx_kp_u__2, __pyx_k__2, sizeof(__pyx_k__2), 0, 1, 0, 0},
-  {&__pyx_n_s__5, __pyx_k__5, sizeof(__pyx_k__5), 0, 0, 1, 1},
+  {&__pyx_n_s_N, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
+  {&__pyx_n_s_TypeError, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
+  {&__pyx_n_s_UnionFind, __pyx_k_UnionFind, sizeof(__pyx_k_UnionFind), 0, 0, 1, 1},
+  {&__pyx_n_s_UnionFind___reduce_cython, __pyx_k_UnionFind___reduce_cython, sizeof(__pyx_k_UnionFind___reduce_cython), 0, 0, 1, 1},
+  {&__pyx_n_s_UnionFind___setstate_cython, __pyx_k_UnionFind___setstate_cython, sizeof(__pyx_k_UnionFind___setstate_cython), 0, 0, 1, 1},
+  {&__pyx_n_s__11, __pyx_k__11, sizeof(__pyx_k__11), 0, 0, 1, 1},
+  {&__pyx_n_s__4, __pyx_k__4, sizeof(__pyx_k__4), 0, 0, 1, 1},
+  {&__pyx_n_s_allocate_unionfind_pair, __pyx_k_allocate_unionfind_pair, sizeof(__pyx_k_allocate_unionfind_pair), 0, 0, 1, 1},
   {&__pyx_n_s_asyncio_coroutines, __pyx_k_asyncio_coroutines, sizeof(__pyx_k_asyncio_coroutines), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_fast, __pyx_k_buffer_fast, sizeof(__pyx_k_buffer_fast), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_parents, __pyx_k_buffer_parents, sizeof(__pyx_k_buffer_parents), 0, 0, 1, 1},
   {&__pyx_n_s_cline_in_traceback, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
-  {&__pyx_n_s_clusters, __pyx_k_clusters, sizeof(__pyx_k_clusters), 0, 0, 1, 1},
-  {&__pyx_n_s_dict, __pyx_k_dict, sizeof(__pyx_k_dict), 0, 0, 1, 1},
-  {&__pyx_n_s_dict_2, __pyx_k_dict_2, sizeof(__pyx_k_dict_2), 0, 0, 1, 1},
   {&__pyx_kp_u_disable, __pyx_k_disable, sizeof(__pyx_k_disable), 0, 1, 0, 0},
-  {&__pyx_n_s_druhg__druhg_amalgamation, __pyx_k_druhg__druhg_amalgamation, sizeof(__pyx_k_druhg__druhg_amalgamation), 0, 0, 1, 1},
+  {&__pyx_n_s_druhg__druhg_unionfind, __pyx_k_druhg__druhg_unionfind, sizeof(__pyx_k_druhg__druhg_unionfind), 0, 0, 1, 1},
+  {&__pyx_kp_s_druhg__druhg_unionfind_pyx, __pyx_k_druhg__druhg_unionfind_pyx, sizeof(__pyx_k_druhg__druhg_unionfind_pyx), 0, 0, 1, 0},
+  {&__pyx_n_s_dtype, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
   {&__pyx_kp_u_enable, __pyx_k_enable, sizeof(__pyx_k_enable), 0, 1, 0, 0},
   {&__pyx_kp_u_gc, __pyx_k_gc, sizeof(__pyx_k_gc), 0, 1, 0, 0},
-  {&__pyx_n_s_get, __pyx_k_get, sizeof(__pyx_k_get), 0, 0, 1, 1},
   {&__pyx_n_s_getstate, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
   {&__pyx_n_s_import, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {&__pyx_n_s_initializing, __pyx_k_initializing, sizeof(__pyx_k_initializing), 0, 0, 1, 1},
+  {&__pyx_n_s_intp, __pyx_k_intp, sizeof(__pyx_k_intp), 0, 0, 1, 1},
   {&__pyx_n_s_is_coroutine, __pyx_k_is_coroutine, sizeof(__pyx_k_is_coroutine), 0, 0, 1, 1},
   {&__pyx_kp_u_isenabled, __pyx_k_isenabled, sizeof(__pyx_k_isenabled), 0, 1, 0, 0},
   {&__pyx_n_s_main, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
   {&__pyx_n_s_name, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
-  {&__pyx_n_s_new, __pyx_k_new, sizeof(__pyx_k_new), 0, 0, 1, 1},
   {&__pyx_n_s_np, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
   {&__pyx_n_s_numpy, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {&__pyx_kp_u_numpy_core_multiarray_failed_to, __pyx_k_numpy_core_multiarray_failed_to, sizeof(__pyx_k_numpy_core_multiarray_failed_to), 0, 1, 0, 0},
   {&__pyx_kp_u_numpy_core_umath_failed_to_impor, __pyx_k_numpy_core_umath_failed_to_impor, sizeof(__pyx_k_numpy_core_umath_failed_to_impor), 0, 1, 0, 0},
-  {&__pyx_n_s_pickle, __pyx_k_pickle, sizeof(__pyx_k_pickle), 0, 0, 1, 1},
-  {&__pyx_n_s_pyx_PickleError, __pyx_k_pyx_PickleError, sizeof(__pyx_k_pyx_PickleError), 0, 0, 1, 1},
-  {&__pyx_n_s_pyx_checksum, __pyx_k_pyx_checksum, sizeof(__pyx_k_pyx_checksum), 0, 0, 1, 1},
-  {&__pyx_n_s_pyx_result, __pyx_k_pyx_result, sizeof(__pyx_k_pyx_result), 0, 0, 1, 1},
+  {&__pyx_n_s_print, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_state, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
-  {&__pyx_n_s_pyx_type, __pyx_k_pyx_type, sizeof(__pyx_k_pyx_type), 0, 0, 1, 1},
-  {&__pyx_n_s_pyx_unpickle_Amalgamation, __pyx_k_pyx_unpickle_Amalgamation, sizeof(__pyx_k_pyx_unpickle_Amalgamation), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_vtable, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {&__pyx_n_s_reduce, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
   {&__pyx_n_s_reduce_cython, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
   {&__pyx_n_s_reduce_ex, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
   {&__pyx_n_s_self, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
+  {&__pyx_kp_s_self_fast_self_parent_cannot_be, __pyx_k_self_fast_self_parent_cannot_be, sizeof(__pyx_k_self_fast_self_parent_cannot_be), 0, 0, 1, 0},
   {&__pyx_n_s_setstate, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
   {&__pyx_n_s_setstate_cython, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
-  {&__pyx_n_s_size, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
   {&__pyx_n_s_spec, __pyx_k_spec, sizeof(__pyx_k_spec), 0, 0, 1, 1},
-  {&__pyx_n_s_state, __pyx_k_state, sizeof(__pyx_k_state), 0, 0, 1, 1},
   {&__pyx_kp_s_stringsource, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
-  {&__pyx_n_s_sys, __pyx_k_sys, sizeof(__pyx_k_sys), 0, 0, 1, 1},
   {&__pyx_n_s_test, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
-  {&__pyx_n_s_update, __pyx_k_update, sizeof(__pyx_k_update), 0, 0, 1, 1},
-  {&__pyx_n_s_use_setstate, __pyx_k_use_setstate, sizeof(__pyx_k_use_setstate), 0, 0, 1, 1},
+  {&__pyx_n_s_zeros, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   #endif
   {0, 0, 0, 0, 0, 0, 0}
 };
 /* #### Code section: cached_builtins ### */
 static CYTHON_SMALL_CODE int __Pyx_InitCachedBuiltins(void) {
+  __pyx_builtin_print = __Pyx_GetBuiltinName(__pyx_n_s_print); if (!__pyx_builtin_print) __PYX_ERR(0, 33, __pyx_L1_error)
+  __pyx_builtin_AssertionError = __Pyx_GetBuiltinName(__pyx_n_s_AssertionError); if (!__pyx_builtin_AssertionError) __PYX_ERR(0, 57, __pyx_L1_error)
+  __pyx_builtin_TypeError = __Pyx_GetBuiltinName(__pyx_n_s_TypeError); if (!__pyx_builtin_TypeError) __PYX_ERR(1, 2, __pyx_L1_error)
   __pyx_builtin_ImportError = __Pyx_GetBuiltinName(__pyx_n_s_ImportError); if (!__pyx_builtin_ImportError) __PYX_ERR(2, 987, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: cached_constants ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);
 
-  /* "druhg/_druhg_amalgamation.pyx":48
- *         energy = dict()
- *         for elem in set(self.energies) | set(o_energies):
- *             v1 = self.energies.get(elem, (0,0.,))             # <<<<<<<<<<<<<<
- *             v2 = o_energies.get(elem, (0,0.,))
- *             energy[elem] = (v1[0]+v2[0], v1[1]+v2[1],)
+  /* "druhg/_druhg_unionfind.pyx":33
+ * 
+ *         if buffer_parents is None:
+ *             print('ERROR: buffer was not provided')             # <<<<<<<<<<<<<<
+ *             return
+ *         elif len(self.parent_arr) < 2*N:
  */
-  __pyx_tuple_ = PyTuple_Pack(2, __pyx_int_0, __pyx_float_0_); if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_ERROR_buffer_was_not_provided); if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 33, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple_);
   __Pyx_GIVEREF(__pyx_tuple_);
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":987
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
-  __pyx_tuple__3 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple__3)) __PYX_ERR(2, 987, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__3);
-  __Pyx_GIVEREF(__pyx_tuple__3);
+  __pyx_tuple__2 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(2, 987, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__2);
+  __Pyx_GIVEREF(__pyx_tuple__2);
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":993
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
-  __pyx_tuple__4 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(2, 993, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__4);
-  __Pyx_GIVEREF(__pyx_tuple__4);
+  __pyx_tuple__3 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__3)) __PYX_ERR(2, 993, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__3);
+  __Pyx_GIVEREF(__pyx_tuple__3);
+
+  /* "druhg/_druhg_unionfind.pyx":15
+ * cimport numpy as np
+ * 
+ * def allocate_unionfind_pair(np.intp_t N):             # <<<<<<<<<<<<<<
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access
+ */
+  __pyx_tuple__5 = PyTuple_Pack(3, __pyx_n_s_N, __pyx_n_s_buffer_parents, __pyx_n_s_buffer_fast); if (unlikely(!__pyx_tuple__5)) __PYX_ERR(0, 15, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__5);
+  __Pyx_GIVEREF(__pyx_tuple__5);
+  __pyx_codeobj__6 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 3, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__5, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_unionfind_pyx, __pyx_n_s_allocate_unionfind_pair, 15, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__6)) __PYX_ERR(0, 15, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     cdef tuple state
- *     cdef object _dict
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
+ * def __setstate_cython__(self, __pyx_state):
  */
-  __pyx_tuple__6 = PyTuple_Pack(4, __pyx_n_s_self, __pyx_n_s_state, __pyx_n_s_dict_2, __pyx_n_s_use_setstate); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__6);
-  __Pyx_GIVEREF(__pyx_tuple__6);
-  __pyx_codeobj__7 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__7)) __PYX_ERR(1, 1, __pyx_L1_error)
-
-  /* "(tree fragment)":16
- *     else:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)
+  __pyx_tuple__7 = PyTuple_Pack(1, __pyx_n_s_self); if (unlikely(!__pyx_tuple__7)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__7);
+  __Pyx_GIVEREF(__pyx_tuple__7);
+  __pyx_codeobj__8 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__7, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__8)) __PYX_ERR(1, 1, __pyx_L1_error)
+
+  /* "(tree fragment)":3
+ * def __reduce_cython__(self):
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_unpickle_Amalgamation__set_state(self, __pyx_state)
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  */
-  __pyx_tuple__8 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_pyx_state); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(1, 16, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__8);
-  __Pyx_GIVEREF(__pyx_tuple__8);
-  __pyx_codeobj__9 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__8, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__9)) __PYX_ERR(1, 16, __pyx_L1_error)
-
-  /* "(tree fragment)":1
- * def __pyx_unpickle_Amalgamation(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
- *     cdef object __pyx_PickleError
- *     cdef object __pyx_result
- */
-  __pyx_tuple__10 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__10)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__10);
-  __Pyx_GIVEREF(__pyx_tuple__10);
-  __pyx_codeobj__11 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__10, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Amalgamation, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__11)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__9 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_pyx_state); if (unlikely(!__pyx_tuple__9)) __PYX_ERR(1, 3, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__9);
+  __Pyx_GIVEREF(__pyx_tuple__9);
+  __pyx_codeobj__10 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__9, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 3, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__10)) __PYX_ERR(1, 3, __pyx_L1_error)
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
 /* #### Code section: init_constants ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitConstants(void) {
-  __pyx_umethod_PyDict_Type_get.type = (PyObject*)&PyDict_Type;
-  __pyx_umethod_PyDict_Type_get.method_name = &__pyx_n_s_get;
   #if CYTHON_USE_MODULE_STATE
-  if (__Pyx_InitString(__pyx_string_tab[0], &__pyx_n_s_Amalgamation) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[1], &__pyx_n_s_Amalgamation___reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[2], &__pyx_n_s_Amalgamation___setstate_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[3], &__pyx_n_s_ImportError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[4], &__pyx_kp_s_Incompatible_checksums_s_vs_0xad) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[5], &__pyx_n_s_PickleError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[6], &__pyx_n_s__12) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[7], &__pyx_kp_u__2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[8], &__pyx_n_s__5) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[9], &__pyx_n_s_asyncio_coroutines) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[10], &__pyx_n_s_cline_in_traceback) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[11], &__pyx_n_s_clusters) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[12], &__pyx_n_s_dict) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[13], &__pyx_n_s_dict_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[14], &__pyx_kp_u_disable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[15], &__pyx_n_s_druhg__druhg_amalgamation) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[16], &__pyx_kp_u_enable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[17], &__pyx_kp_u_gc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[18], &__pyx_n_s_get) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[19], &__pyx_n_s_getstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[20], &__pyx_n_s_import) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[21], &__pyx_n_s_initializing) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[22], &__pyx_n_s_is_coroutine) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[23], &__pyx_kp_u_isenabled) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[24], &__pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[25], &__pyx_n_s_name) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[26], &__pyx_n_s_new) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[27], &__pyx_n_s_np) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[28], &__pyx_n_s_numpy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[29], &__pyx_kp_u_numpy_core_multiarray_failed_to) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[30], &__pyx_kp_u_numpy_core_umath_failed_to_impor) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[31], &__pyx_n_s_pickle) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[32], &__pyx_n_s_pyx_PickleError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[33], &__pyx_n_s_pyx_checksum) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[34], &__pyx_n_s_pyx_result) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[35], &__pyx_n_s_pyx_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[36], &__pyx_n_s_pyx_type) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[37], &__pyx_n_s_pyx_unpickle_Amalgamation) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[38], &__pyx_n_s_pyx_vtable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[39], &__pyx_n_s_reduce) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[40], &__pyx_n_s_reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[41], &__pyx_n_s_reduce_ex) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[42], &__pyx_n_s_self) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[0], &__pyx_n_s_AssertionError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[1], &__pyx_kp_u_ERROR_buffer_was_not_provided) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[2], &__pyx_kp_u_ERROR_fast_arr_is_too_small) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[3], &__pyx_kp_u_ERROR_parent_arr_is_too_small) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[4], &__pyx_n_s_ImportError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[5], &__pyx_n_s_N) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[6], &__pyx_n_s_TypeError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[7], &__pyx_n_s_UnionFind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[8], &__pyx_n_s_UnionFind___reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[9], &__pyx_n_s_UnionFind___setstate_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[10], &__pyx_n_s__11) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[11], &__pyx_n_s__4) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[12], &__pyx_n_s_allocate_unionfind_pair) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[13], &__pyx_n_s_asyncio_coroutines) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[14], &__pyx_n_s_buffer_fast) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[15], &__pyx_n_s_buffer_parents) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[16], &__pyx_n_s_cline_in_traceback) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[17], &__pyx_kp_u_disable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[18], &__pyx_n_s_druhg__druhg_unionfind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[19], &__pyx_kp_s_druhg__druhg_unionfind_pyx) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[20], &__pyx_n_s_dtype) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[21], &__pyx_kp_u_enable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[22], &__pyx_kp_u_gc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[23], &__pyx_n_s_getstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[24], &__pyx_n_s_import) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[25], &__pyx_n_s_initializing) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[26], &__pyx_n_s_intp) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[27], &__pyx_n_s_is_coroutine) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[28], &__pyx_kp_u_isenabled) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[29], &__pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[30], &__pyx_n_s_name) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[31], &__pyx_n_s_np) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[32], &__pyx_n_s_numpy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[33], &__pyx_kp_u_numpy_core_multiarray_failed_to) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[34], &__pyx_kp_u_numpy_core_umath_failed_to_impor) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[35], &__pyx_n_s_print) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[36], &__pyx_n_s_pyx_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[37], &__pyx_n_s_pyx_vtable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[38], &__pyx_n_s_reduce) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[39], &__pyx_n_s_reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[40], &__pyx_n_s_reduce_ex) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[41], &__pyx_n_s_self) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[42], &__pyx_kp_s_self_fast_self_parent_cannot_be) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   if (__Pyx_InitString(__pyx_string_tab[43], &__pyx_n_s_setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   if (__Pyx_InitString(__pyx_string_tab[44], &__pyx_n_s_setstate_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[45], &__pyx_n_s_size) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[46], &__pyx_n_s_spec) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[47], &__pyx_n_s_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[48], &__pyx_kp_s_stringsource) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[49], &__pyx_n_s_sys) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[50], &__pyx_n_s_test) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[51], &__pyx_n_s_update) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[52], &__pyx_n_s_use_setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[45], &__pyx_n_s_spec) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[46], &__pyx_kp_s_stringsource) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[47], &__pyx_n_s_test) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[48], &__pyx_n_s_zeros) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #endif
   #if !CYTHON_USE_MODULE_STATE
   if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #endif
-  __pyx_float_0_ = PyFloat_FromDouble(0.); if (unlikely(!__pyx_float_0_)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_float_1_ = PyFloat_FromDouble(1.); if (unlikely(!__pyx_float_1_)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_0 = PyInt_FromLong(0); if (unlikely(!__pyx_int_0)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_int_182298202 = PyInt_FromLong(182298202L); if (unlikely(!__pyx_int_182298202)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_1 = PyInt_FromLong(1); if (unlikely(!__pyx_int_1)) __PYX_ERR(0, 1, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: init_globals ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitGlobals(void) {
@@ -6744,45 +5798,45 @@
 static int __Pyx_modinit_type_init_code(void) {
   __Pyx_RefNannyDeclarations
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_init_code", 0);
   /*--- Type init code ---*/
-  __pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation = &__pyx_vtable_5druhg_19_druhg_amalgamation_Amalgamation;
-  __pyx_vtable_5druhg_19_druhg_amalgamation_Amalgamation.merge_amalgamations = (struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *(*)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, __pyx_t_5numpy_double_t))__pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_merge_amalgamations;
-  __pyx_vtable_5druhg_19_druhg_amalgamation_Amalgamation.border_overcoming = (__pyx_t_5numpy_double_t (*)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t))__pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_border_overcoming;
-  __pyx_vtable_5druhg_19_druhg_amalgamation_Amalgamation.border_overcoming_rev = (__pyx_t_5numpy_double_t (*)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t))__pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation_border_overcoming_rev;
-  __pyx_vtable_5druhg_19_druhg_amalgamation_Amalgamation._amalgamate = (void (*)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, PyObject *))__pyx_f_5druhg_19_druhg_amalgamation_12Amalgamation__amalgamate;
+  __pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind = &__pyx_vtable_5druhg_16_druhg_unionfind_UnionFind;
+  __pyx_vtable_5druhg_16_druhg_unionfind_UnionFind.nullify = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *))__pyx_f_5druhg_16_druhg_unionfind_9UnionFind_nullify;
+  __pyx_vtable_5druhg_16_druhg_unionfind_UnionFind.mark_up = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_16_druhg_unionfind_9UnionFind_mark_up;
+  __pyx_vtable_5druhg_16_druhg_unionfind_UnionFind.is_same_parent = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_16_druhg_unionfind_9UnionFind_is_same_parent;
+  __pyx_vtable_5druhg_16_druhg_unionfind_UnionFind.__pyx_union = (void (*)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_16_druhg_unionfind_9UnionFind_union;
   #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation)) __PYX_ERR(0, 33, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation_spec, __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_16_druhg_unionfind_UnionFind_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind)) __PYX_ERR(0, 20, __pyx_L1_error)
+  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_16_druhg_unionfind_UnionFind_spec, __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
   #else
-  __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation = &__pyx_type_5druhg_19_druhg_amalgamation_Amalgamation;
+  __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = &__pyx_type_5druhg_16_druhg_unionfind_UnionFind;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   #endif
   #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
   #endif
   #if PY_MAJOR_VERSION < 3
-  __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation->tp_print = 0;
+  __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind->tp_print = 0;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation->tp_dictoffset && __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation->tp_getattro == PyObject_GenericGetAttr)) {
-    __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation->tp_getattro = __Pyx_PyObject_GenericGetAttr;
+  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind->tp_dictoffset && __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind->tp_getattro == PyObject_GenericGetAttr)) {
+    __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind->tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
   #endif
-  if (__Pyx_SetVtable(__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation, __pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  if (__Pyx_SetVtable(__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind, __pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
   #endif
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Amalgamation, (PyObject *) __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_UnionFind, (PyObject *) __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
   #endif
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
@@ -6865,31 +5919,31 @@
   return 0;
 }
 
 
 #if PY_MAJOR_VERSION >= 3
 #if CYTHON_PEP489_MULTI_PHASE_INIT
 static PyObject* __pyx_pymod_create(PyObject *spec, PyModuleDef *def); /*proto*/
-static int __pyx_pymod_exec__druhg_amalgamation(PyObject* module); /*proto*/
+static int __pyx_pymod_exec__druhg_unionfind(PyObject* module); /*proto*/
 static PyModuleDef_Slot __pyx_moduledef_slots[] = {
   {Py_mod_create, (void*)__pyx_pymod_create},
-  {Py_mod_exec, (void*)__pyx_pymod_exec__druhg_amalgamation},
+  {Py_mod_exec, (void*)__pyx_pymod_exec__druhg_unionfind},
   {0, NULL}
 };
 #endif
 
 #ifdef __cplusplus
 namespace {
   struct PyModuleDef __pyx_moduledef =
   #else
   static struct PyModuleDef __pyx_moduledef =
   #endif
   {
       PyModuleDef_HEAD_INIT,
-      "_druhg_amalgamation",
+      "_druhg_unionfind",
       0, /* m_doc */
     #if CYTHON_PEP489_MULTI_PHASE_INIT
       0, /* m_size */
     #elif CYTHON_USE_MODULE_STATE
       sizeof(__pyx_mstate), /* m_size */
     #else
       -1, /* m_size */
@@ -6929,19 +5983,19 @@
 #else
 #define __Pyx_PyMODINIT_FUNC PyObject *
 #endif
 #endif
 
 
 #if PY_MAJOR_VERSION < 3
-__Pyx_PyMODINIT_FUNC init_druhg_amalgamation(void) CYTHON_SMALL_CODE; /*proto*/
-__Pyx_PyMODINIT_FUNC init_druhg_amalgamation(void)
+__Pyx_PyMODINIT_FUNC init_druhg_unionfind(void) CYTHON_SMALL_CODE; /*proto*/
+__Pyx_PyMODINIT_FUNC init_druhg_unionfind(void)
 #else
-__Pyx_PyMODINIT_FUNC PyInit__druhg_amalgamation(void) CYTHON_SMALL_CODE; /*proto*/
-__Pyx_PyMODINIT_FUNC PyInit__druhg_amalgamation(void)
+__Pyx_PyMODINIT_FUNC PyInit__druhg_unionfind(void) CYTHON_SMALL_CODE; /*proto*/
+__Pyx_PyMODINIT_FUNC PyInit__druhg_unionfind(void)
 #if CYTHON_PEP489_MULTI_PHASE_INIT
 {
   return PyModuleDef_Init(&__pyx_moduledef);
 }
 static CYTHON_SMALL_CODE int __Pyx_check_single_interpreter(void) {
     #if PY_VERSION_HEX >= 0x030700A1
     static PY_INT64_T main_interpreter_id = -1;
@@ -7014,41 +6068,41 @@
     return module;
 bad:
     Py_XDECREF(module);
     return NULL;
 }
 
 
-static CYTHON_SMALL_CODE int __pyx_pymod_exec__druhg_amalgamation(PyObject *__pyx_pyinit_module)
+static CYTHON_SMALL_CODE int __pyx_pymod_exec__druhg_unionfind(PyObject *__pyx_pyinit_module)
 #endif
 #endif
 {
   int stringtab_initialized = 0;
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannyDeclarations
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   if (__pyx_m) {
     if (__pyx_m == __pyx_pyinit_module) return 0;
-    PyErr_SetString(PyExc_RuntimeError, "Module '_druhg_amalgamation' has already been imported. Re-initialisation is not supported.");
+    PyErr_SetString(PyExc_RuntimeError, "Module '_druhg_unionfind' has already been imported. Re-initialisation is not supported.");
     return -1;
   }
   #elif PY_MAJOR_VERSION >= 3
   if (__pyx_m) return __Pyx_NewRef(__pyx_m);
   #endif
   /*--- Module creation code ---*/
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   __pyx_m = __pyx_pyinit_module;
   Py_INCREF(__pyx_m);
   #else
   #if PY_MAJOR_VERSION < 3
-  __pyx_m = Py_InitModule4("_druhg_amalgamation", __pyx_methods, 0, 0, PYTHON_API_VERSION); Py_XINCREF(__pyx_m);
+  __pyx_m = Py_InitModule4("_druhg_unionfind", __pyx_methods, 0, 0, PYTHON_API_VERSION); Py_XINCREF(__pyx_m);
   if (unlikely(!__pyx_m)) __PYX_ERR(0, 1, __pyx_L1_error)
   #elif CYTHON_COMPILING_IN_LIMITED_API
   __pyx_t_1 = PyModule_Create(&__pyx_moduledef); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1, __pyx_L1_error)
   {
     int add_module_result = PyState_AddModule(__pyx_t_1, &__pyx_moduledef);
     Py_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     if (unlikely((add_module_result < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
@@ -7071,15 +6125,15 @@
 if (!__Pyx_RefNanny) {
   PyErr_Clear();
   __Pyx_RefNanny = __Pyx_RefNannyImportAPI("Cython.Runtime.refnanny");
   if (!__Pyx_RefNanny)
       Py_FatalError("failed to import 'refnanny' module");
 }
 #endif
-  __Pyx_RefNannySetupContext("__Pyx_PyMODINIT_FUNC PyInit__druhg_amalgamation(void)", 0);
+  __Pyx_RefNannySetupContext("__Pyx_PyMODINIT_FUNC PyInit__druhg_unionfind(void)", 0);
   if (__Pyx_check_binary_version() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #ifdef __Pxy_PyFrame_Initialize_Offsets
   __Pxy_PyFrame_Initialize_Offsets();
   #endif
   __pyx_empty_tuple = PyTuple_New(0); if (unlikely(!__pyx_empty_tuple)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_empty_bytes = PyBytes_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_bytes)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_empty_unicode = PyUnicode_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_unicode)) __PYX_ERR(0, 1, __pyx_L1_error)
@@ -7109,22 +6163,22 @@
   /*--- Initialize various global constants etc. ---*/
   if (__Pyx_InitConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   stringtab_initialized = 1;
   if (__Pyx_InitGlobals() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #if PY_MAJOR_VERSION < 3 && (__PYX_DEFAULT_STRING_ENCODING_IS_ASCII || __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT)
   if (__Pyx_init_sys_getdefaultencoding_params() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
-  if (__pyx_module_is_main_druhg___druhg_amalgamation) {
+  if (__pyx_module_is_main_druhg___druhg_unionfind) {
     if (PyObject_SetAttr(__pyx_m, __pyx_n_s_name, __pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   }
   #if PY_MAJOR_VERSION >= 3
   {
     PyObject *modules = PyImport_GetModuleDict(); if (unlikely(!modules)) __PYX_ERR(0, 1, __pyx_L1_error)
-    if (!PyDict_GetItemString(modules, "druhg._druhg_amalgamation")) {
-      if (unlikely((PyDict_SetItemString(modules, "druhg._druhg_amalgamation", __pyx_m) < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
+    if (!PyDict_GetItemString(modules, "druhg._druhg_unionfind")) {
+      if (unlikely((PyDict_SetItemString(modules, "druhg._druhg_unionfind", __pyx_m) < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
     }
   }
   #endif
   /*--- Builtin init code ---*/
   if (__Pyx_InitCachedBuiltins() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Constants init code ---*/
   if (__Pyx_InitCachedConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
@@ -7137,101 +6191,91 @@
   (void)__Pyx_modinit_variable_import_code();
   (void)__Pyx_modinit_function_import_code();
   /*--- Execution code ---*/
   #if defined(__Pyx_Generator_USED) || defined(__Pyx_Coroutine_USED)
   if (__Pyx_patch_abc() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
 
-  /* "druhg/_druhg_amalgamation.pyx":12
+  /* "druhg/_druhg_unionfind.pyx":12
  * # License: 3-clause BSD
  * 
  * import numpy as np             # <<<<<<<<<<<<<<
  * cimport numpy as np
- * import sys
+ * 
  */
   __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_numpy, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_2) < 0) __PYX_ERR(0, 12, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":14
- * import numpy as np
+  /* "druhg/_druhg_unionfind.pyx":15
  * cimport numpy as np
- * import sys             # <<<<<<<<<<<<<<
  * 
- * from libc.math cimport fabs, pow
+ * def allocate_unionfind_pair(np.intp_t N):             # <<<<<<<<<<<<<<
+ *     buffer_parents = np.zeros(2 * N, dtype=np.intp) # is used to store all the connections and to pass between phases
+ *     buffer_fast = np.zeros(N, dtype=np.intp) # is used only in the first phase for the fast access
  */
-  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_sys, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 14, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_16_druhg_unionfind_1allocate_unionfind_pair, 0, __pyx_n_s_allocate_unionfind_pair, NULL, __pyx_n_s_druhg__druhg_unionfind, __pyx_d, ((PyObject *)__pyx_codeobj__6)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 15, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sys, __pyx_t_2) < 0) __PYX_ERR(0, 14, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_allocate_unionfind_pair, __pyx_t_2) < 0) __PYX_ERR(0, 15, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     cdef tuple state
- *     cdef object _dict
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
+ * def __setstate_cython__(self, __pyx_state):
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_19_druhg_amalgamation_12Amalgamation_3__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_Amalgamation___reduce_cython, NULL, __pyx_n_s_druhg__druhg_amalgamation, __pyx_d, ((PyObject *)__pyx_codeobj__7)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_16_druhg_unionfind_9UnionFind_3__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UnionFind___reduce_cython, NULL, __pyx_n_s_druhg__druhg_unionfind, __pyx_d, ((PyObject *)__pyx_codeobj__8)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation->tp_dict, __pyx_n_s_reduce_cython, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_reduce_cython, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  PyType_Modified(__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation);
 
-  /* "(tree fragment)":16
- *     else:
- *         return __pyx_unpickle_Amalgamation, (type(self), 0xadda65a, state)
+  /* "(tree fragment)":3
+ * def __reduce_cython__(self):
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_unpickle_Amalgamation__set_state(self, __pyx_state)
- */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_19_druhg_amalgamation_12Amalgamation_5__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_Amalgamation___setstate_cython, NULL, __pyx_n_s_druhg__druhg_amalgamation, __pyx_d, ((PyObject *)__pyx_codeobj__9)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation->tp_dict, __pyx_n_s_setstate_cython, __pyx_t_2) < 0) __PYX_ERR(1, 16, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  PyType_Modified(__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation);
-
-  /* "(tree fragment)":1
- * def __pyx_unpickle_Amalgamation(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
- *     cdef object __pyx_PickleError
- *     cdef object __pyx_result
+ *     raise TypeError, "self.fast,self.parent cannot be converted to a Python object for pickling"
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_19_druhg_amalgamation_1__pyx_unpickle_Amalgamation, 0, __pyx_n_s_pyx_unpickle_Amalgamation, NULL, __pyx_n_s_druhg__druhg_amalgamation, __pyx_d, ((PyObject *)__pyx_codeobj__11)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_16_druhg_unionfind_9UnionFind_5__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UnionFind___setstate_cython, NULL, __pyx_n_s_druhg__druhg_unionfind, __pyx_d, ((PyObject *)__pyx_codeobj__10)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 3, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Amalgamation, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_setstate_cython, __pyx_t_2) < 0) __PYX_ERR(1, 3, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_amalgamation.pyx":1
+  /* "druhg/_druhg_unionfind.pyx":1
  * # cython: language_level=3             # <<<<<<<<<<<<<<
  * # cython: boundscheck=False
  * # cython: nonecheck=False
  */
   __pyx_t_2 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "libc/math.pxd":1
- * cdef extern from "<math.h>" nogil:             # <<<<<<<<<<<<<<
- *     const double M_E
- *     const double e "M_E"  # as in Python's math module
+  /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":1049
+ * 
+ * 
+ * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
+ *     """
+ *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
   /*--- Wrapped vars code ---*/
 
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_2);
   if (__pyx_m) {
     if (__pyx_d && stringtab_initialized) {
-      __Pyx_AddTraceback("init druhg._druhg_amalgamation", __pyx_clineno, __pyx_lineno, __pyx_filename);
+      __Pyx_AddTraceback("init druhg._druhg_unionfind", __pyx_clineno, __pyx_lineno, __pyx_filename);
     }
     #if !CYTHON_USE_MODULE_STATE
     Py_CLEAR(__pyx_m);
     #endif
   } else if (!PyErr_Occurred()) {
-    PyErr_SetString(PyExc_ImportError, "init druhg._druhg_amalgamation");
+    PyErr_SetString(PyExc_ImportError, "init druhg._druhg_unionfind");
   }
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   return (__pyx_m != NULL) ? 0 : -1;
   #elif PY_MAJOR_VERSION >= 3
   return __pyx_m;
@@ -7270,14 +6314,113 @@
 end:
     Py_XDECREF(p);
     Py_XDECREF(m);
     return (__Pyx_RefNannyAPIStruct *)r;
 }
 #endif
 
+/* PyErrExceptionMatches */
+#if CYTHON_FAST_THREAD_STATE
+static int __Pyx_PyErr_ExceptionMatchesTuple(PyObject *exc_type, PyObject *tuple) {
+    Py_ssize_t i, n;
+    n = PyTuple_GET_SIZE(tuple);
+#if PY_MAJOR_VERSION >= 3
+    for (i=0; i<n; i++) {
+        if (exc_type == PyTuple_GET_ITEM(tuple, i)) return 1;
+    }
+#endif
+    for (i=0; i<n; i++) {
+        if (__Pyx_PyErr_GivenExceptionMatches(exc_type, PyTuple_GET_ITEM(tuple, i))) return 1;
+    }
+    return 0;
+}
+static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err) {
+    PyObject *exc_type = tstate->curexc_type;
+    if (exc_type == err) return 1;
+    if (unlikely(!exc_type)) return 0;
+    if (unlikely(PyTuple_Check(err)))
+        return __Pyx_PyErr_ExceptionMatchesTuple(exc_type, err);
+    return __Pyx_PyErr_GivenExceptionMatches(exc_type, err);
+}
+#endif
+
+/* PyErrFetchRestore */
+#if CYTHON_FAST_THREAD_STATE
+static CYTHON_INLINE void __Pyx_ErrRestoreInState(PyThreadState *tstate, PyObject *type, PyObject *value, PyObject *tb) {
+    PyObject *tmp_type, *tmp_value, *tmp_tb;
+    tmp_type = tstate->curexc_type;
+    tmp_value = tstate->curexc_value;
+    tmp_tb = tstate->curexc_traceback;
+    tstate->curexc_type = type;
+    tstate->curexc_value = value;
+    tstate->curexc_traceback = tb;
+    Py_XDECREF(tmp_type);
+    Py_XDECREF(tmp_value);
+    Py_XDECREF(tmp_tb);
+}
+static CYTHON_INLINE void __Pyx_ErrFetchInState(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb) {
+    *type = tstate->curexc_type;
+    *value = tstate->curexc_value;
+    *tb = tstate->curexc_traceback;
+    tstate->curexc_type = 0;
+    tstate->curexc_value = 0;
+    tstate->curexc_traceback = 0;
+}
+#endif
+
+/* PyObjectGetAttrStr */
+#if CYTHON_USE_TYPE_SLOTS
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStr(PyObject* obj, PyObject* attr_name) {
+    PyTypeObject* tp = Py_TYPE(obj);
+    if (likely(tp->tp_getattro))
+        return tp->tp_getattro(obj, attr_name);
+#if PY_MAJOR_VERSION < 3
+    if (likely(tp->tp_getattr))
+        return tp->tp_getattr(obj, PyString_AS_STRING(attr_name));
+#endif
+    return PyObject_GetAttr(obj, attr_name);
+}
+#endif
+
+/* PyObjectGetAttrStrNoError */
+static void __Pyx_PyObject_GetAttrStr_ClearAttributeError(void) {
+    __Pyx_PyThreadState_declare
+    __Pyx_PyThreadState_assign
+    if (likely(__Pyx_PyErr_ExceptionMatches(PyExc_AttributeError)))
+        __Pyx_PyErr_Clear();
+}
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStrNoError(PyObject* obj, PyObject* attr_name) {
+    PyObject *result;
+#if CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_TYPE_SLOTS && PY_VERSION_HEX >= 0x030700B1
+    PyTypeObject* tp = Py_TYPE(obj);
+    if (likely(tp->tp_getattro == PyObject_GenericGetAttr)) {
+        return _PyObject_GenericGetAttrWithDict(obj, attr_name, NULL, 1);
+    }
+#endif
+    result = __Pyx_PyObject_GetAttrStr(obj, attr_name);
+    if (unlikely(!result)) {
+        __Pyx_PyObject_GetAttrStr_ClearAttributeError();
+    }
+    return result;
+}
+
+/* GetBuiltinName */
+static PyObject *__Pyx_GetBuiltinName(PyObject *name) {
+    PyObject* result = __Pyx_PyObject_GetAttrStrNoError(__pyx_b, name);
+    if (unlikely(!result) && !PyErr_Occurred()) {
+        PyErr_Format(PyExc_NameError,
+#if PY_MAJOR_VERSION >= 3
+            "name '%U' is not defined", name);
+#else
+            "name '%.200s' is not defined", PyString_AS_STRING(name));
+#endif
+    }
+    return result;
+}
+
 /* TupleAndListFromArray */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE void __Pyx_copy_object_array(PyObject *const *CYTHON_RESTRICT src, PyObject** CYTHON_RESTRICT dest, Py_ssize_t length) {
     PyObject *v;
     Py_ssize_t i;
     for (i = 0; i < length; i++) {
         v = dest[i] = src[i];
@@ -7633,98 +6776,81 @@
     }
     PyErr_Format(PyExc_TypeError,
                  "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
                  func_name, more_or_less, num_expected,
                  (num_expected == 1) ? "" : "s", num_found);
 }
 
-/* IterFinish */
-static CYTHON_INLINE int __Pyx_IterFinish(void) {
-#if CYTHON_FAST_THREAD_STATE
-    PyThreadState *tstate = __Pyx_PyThreadState_Current;
-    PyObject* exc_type = tstate->curexc_type;
-    if (unlikely(exc_type)) {
-        if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) {
-            PyObject *exc_value, *exc_tb;
-            exc_value = tstate->curexc_value;
-            exc_tb = tstate->curexc_traceback;
-            tstate->curexc_type = 0;
-            tstate->curexc_value = 0;
-            tstate->curexc_traceback = 0;
-            Py_DECREF(exc_type);
-            Py_XDECREF(exc_value);
-            Py_XDECREF(exc_tb);
-            return 0;
-        } else {
-            return -1;
-        }
-    }
-    return 0;
+/* PyDictVersioning */
+#if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj) {
+    PyObject *dict = Py_TYPE(obj)->tp_dict;
+    return likely(dict) ? __PYX_GET_DICT_VERSION(dict) : 0;
+}
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj) {
+    PyObject **dictptr = NULL;
+    Py_ssize_t offset = Py_TYPE(obj)->tp_dictoffset;
+    if (offset) {
+#if CYTHON_COMPILING_IN_CPYTHON
+        dictptr = (likely(offset > 0)) ? (PyObject **) ((char *)obj + offset) : _PyObject_GetDictPtr(obj);
 #else
-    if (unlikely(PyErr_Occurred())) {
-        if (likely(PyErr_ExceptionMatches(PyExc_StopIteration))) {
-            PyErr_Clear();
-            return 0;
-        } else {
-            return -1;
-        }
-    }
-    return 0;
+        dictptr = _PyObject_GetDictPtr(obj);
 #endif
+    }
+    return (dictptr && *dictptr) ? __PYX_GET_DICT_VERSION(*dictptr) : 0;
 }
+static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version) {
+    PyObject *dict = Py_TYPE(obj)->tp_dict;
+    if (unlikely(!dict) || unlikely(tp_dict_version != __PYX_GET_DICT_VERSION(dict)))
+        return 0;
+    return obj_dict_version == __Pyx_get_object_dict_version(obj);
+}
+#endif
 
-/* set_iter */
-static CYTHON_INLINE PyObject* __Pyx_set_iterator(PyObject* iterable, int is_set,
-                                                  Py_ssize_t* p_orig_length, int* p_source_is_set) {
-#if CYTHON_COMPILING_IN_CPYTHON
-    is_set = is_set || likely(PySet_CheckExact(iterable) || PyFrozenSet_CheckExact(iterable));
-    *p_source_is_set = is_set;
-    if (likely(is_set)) {
-        *p_orig_length = PySet_Size(iterable);
-        Py_INCREF(iterable);
-        return iterable;
-    }
-#else
-    (void)is_set;
-    *p_source_is_set = 0;
-#endif
-    *p_orig_length = 0;
-    return PyObject_GetIter(iterable);
-}
-static CYTHON_INLINE int __Pyx_set_iter_next(
-        PyObject* iter_obj, Py_ssize_t orig_length,
-        Py_ssize_t* ppos, PyObject **value,
-        int source_is_set) {
-    if (!CYTHON_COMPILING_IN_CPYTHON || unlikely(!source_is_set)) {
-        *value = PyIter_Next(iter_obj);
-        if (unlikely(!*value)) {
-            return __Pyx_IterFinish();
-        }
-        (void)orig_length;
-        (void)ppos;
-        return 1;
+/* GetModuleGlobalName */
+#if CYTHON_USE_DICT_VERSIONS
+static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value)
+#else
+static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name)
+#endif
+{
+    PyObject *result;
+#if !CYTHON_AVOID_BORROWED_REFS
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1
+    result = _PyDict_GetItem_KnownHash(__pyx_d, name, ((PyASCIIObject *) name)->hash);
+    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
+    if (likely(result)) {
+        return __Pyx_NewRef(result);
+    } else if (unlikely(PyErr_Occurred())) {
+        return NULL;
     }
-#if CYTHON_COMPILING_IN_CPYTHON
-    if (unlikely(PySet_GET_SIZE(iter_obj) != orig_length)) {
-        PyErr_SetString(
-            PyExc_RuntimeError,
-            "set changed size during iteration");
-        return -1;
+#elif CYTHON_COMPILING_IN_LIMITED_API
+    if (unlikely(!__pyx_m)) {
+        return NULL;
     }
-    {
-        Py_hash_t hash;
-        int ret = _PySet_NextEntry(iter_obj, ppos, value, &hash);
-        assert (ret != -1);
-        if (likely(ret)) {
-            Py_INCREF(*value);
-            return 1;
-        }
+    result = PyObject_GetAttr(__pyx_m, name);
+    if (likely(result)) {
+        return result;
+    }
+#else
+    result = PyDict_GetItem(__pyx_d, name);
+    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
+    if (likely(result)) {
+        return __Pyx_NewRef(result);
     }
 #endif
-    return 0;
+#else
+    result = PyObject_GetItem(__pyx_d, name);
+    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
+    if (likely(result)) {
+        return __Pyx_NewRef(result);
+    }
+    PyErr_Clear();
+#endif
+    return __Pyx_GetBuiltinName(name);
 }
 
 /* PyObjectCall */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw) {
     PyObject *result;
     ternaryfunc call = Py_TYPE(func)->tp_call;
@@ -7739,302 +6865,343 @@
             PyExc_SystemError,
             "NULL result without error in PyObject_Call");
     }
     return result;
 }
 #endif
 
-/* PyObjectGetAttrStr */
-#if CYTHON_USE_TYPE_SLOTS
-static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStr(PyObject* obj, PyObject* attr_name) {
-    PyTypeObject* tp = Py_TYPE(obj);
-    if (likely(tp->tp_getattro))
-        return tp->tp_getattro(obj, attr_name);
-#if PY_MAJOR_VERSION < 3
-    if (likely(tp->tp_getattr))
-        return tp->tp_getattr(obj, PyString_AS_STRING(attr_name));
-#endif
-    return PyObject_GetAttr(obj, attr_name);
-}
-#endif
-
-/* UnpackUnboundCMethod */
-static int __Pyx_TryUnpackUnboundCMethod(__Pyx_CachedCFunction* target) {
-    PyObject *method;
-    method = __Pyx_PyObject_GetAttrStr(target->type, *target->method_name);
-    if (unlikely(!method))
-        return -1;
-    target->method = method;
-#if CYTHON_COMPILING_IN_CPYTHON
-    #if PY_MAJOR_VERSION >= 3
-    if (likely(__Pyx_TypeCheck(method, &PyMethodDescr_Type)))
-    #endif
-    {
-        PyMethodDescrObject *descr = (PyMethodDescrObject*) method;
-        target->func = descr->d_method->ml_meth;
-        target->flag = descr->d_method->ml_flags & ~(METH_CLASS | METH_STATIC | METH_COEXIST | METH_STACKLESS);
+/* ExtTypeTest */
+static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type) {
+    __Pyx_TypeName obj_type_name;
+    __Pyx_TypeName type_name;
+    if (unlikely(!type)) {
+        PyErr_SetString(PyExc_SystemError, "Missing type object");
+        return 0;
     }
-#endif
+    if (likely(__Pyx_TypeCheck(obj, type)))
+        return 1;
+    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
+    type_name = __Pyx_PyType_GetName(type);
+    PyErr_Format(PyExc_TypeError,
+                 "Cannot convert " __Pyx_FMT_TYPENAME " to " __Pyx_FMT_TYPENAME,
+                 obj_type_name, type_name);
+    __Pyx_DECREF_TypeName(obj_type_name);
+    __Pyx_DECREF_TypeName(type_name);
     return 0;
 }
 
-/* CallUnboundCMethod1 */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg) {
-    if (likely(cfunc->func)) {
-        int flag = cfunc->flag;
-        if (flag == METH_O) {
-            return (*(cfunc->func))(self, arg);
-        } else if ((PY_VERSION_HEX >= 0x030600B1) && flag == METH_FASTCALL) {
-            if ((PY_VERSION_HEX >= 0x030700A0)) {
-                return (*(__Pyx_PyCFunctionFast)(void*)(PyCFunction)cfunc->func)(self, &arg, 1);
+/* SliceObject */
+static CYTHON_INLINE int __Pyx_PyObject_SetSlice(PyObject* obj, PyObject* value,
+        Py_ssize_t cstart, Py_ssize_t cstop,
+        PyObject** _py_start, PyObject** _py_stop, PyObject** _py_slice,
+        int has_cstart, int has_cstop, int wraparound) {
+    __Pyx_TypeName obj_type_name;
+#if CYTHON_USE_TYPE_SLOTS
+    PyMappingMethods* mp;
+#if PY_MAJOR_VERSION < 3
+    PySequenceMethods* ms = Py_TYPE(obj)->tp_as_sequence;
+    if (likely(ms && ms->sq_ass_slice)) {
+        if (!has_cstart) {
+            if (_py_start && (*_py_start != Py_None)) {
+                cstart = __Pyx_PyIndex_AsSsize_t(*_py_start);
+                if ((cstart == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
+            } else
+                cstart = 0;
+        }
+        if (!has_cstop) {
+            if (_py_stop && (*_py_stop != Py_None)) {
+                cstop = __Pyx_PyIndex_AsSsize_t(*_py_stop);
+                if ((cstop == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
+            } else
+                cstop = PY_SSIZE_T_MAX;
+        }
+        if (wraparound && unlikely((cstart < 0) | (cstop < 0)) && likely(ms->sq_length)) {
+            Py_ssize_t l = ms->sq_length(obj);
+            if (likely(l >= 0)) {
+                if (cstop < 0) {
+                    cstop += l;
+                    if (cstop < 0) cstop = 0;
+                }
+                if (cstart < 0) {
+                    cstart += l;
+                    if (cstart < 0) cstart = 0;
+                }
             } else {
-                return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, &arg, 1, NULL);
+                if (!PyErr_ExceptionMatches(PyExc_OverflowError))
+                    goto bad;
+                PyErr_Clear();
             }
-        } else if ((PY_VERSION_HEX >= 0x030700A0) && flag == (METH_FASTCALL | METH_KEYWORDS)) {
-            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, &arg, 1, NULL);
         }
+        return ms->sq_ass_slice(obj, cstart, cstop, value);
     }
-    return __Pyx__CallUnboundCMethod1(cfunc, self, arg);
-}
+#else
+    CYTHON_UNUSED_VAR(wraparound);
 #endif
-static PyObject* __Pyx__CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg){
-    PyObject *args, *result = NULL;
-    if (unlikely(!cfunc->func && !cfunc->method) && unlikely(__Pyx_TryUnpackUnboundCMethod(cfunc) < 0)) return NULL;
-#if CYTHON_COMPILING_IN_CPYTHON
-    if (cfunc->func && (cfunc->flag & METH_VARARGS)) {
-        args = PyTuple_New(1);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(arg);
-        PyTuple_SET_ITEM(args, 0, arg);
-        if (cfunc->flag & METH_KEYWORDS)
-            result = (*(PyCFunctionWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, NULL);
-        else
-            result = (*cfunc->func)(self, args);
-    } else {
-        args = PyTuple_New(2);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(self);
-        PyTuple_SET_ITEM(args, 0, self);
-        Py_INCREF(arg);
-        PyTuple_SET_ITEM(args, 1, arg);
-        result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-    }
+    mp = Py_TYPE(obj)->tp_as_mapping;
+    if (likely(mp && mp->mp_ass_subscript))
 #else
-    args = PyTuple_Pack(2, self, arg);
-    if (unlikely(!args)) goto bad;
-    result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
+    CYTHON_UNUSED_VAR(wraparound);
 #endif
-bad:
-    Py_XDECREF(args);
-    return result;
-}
-
-/* CallUnboundCMethod2 */
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030600B1
-static CYTHON_INLINE PyObject *__Pyx_CallUnboundCMethod2(__Pyx_CachedCFunction *cfunc, PyObject *self, PyObject *arg1, PyObject *arg2) {
-    if (likely(cfunc->func)) {
-        PyObject *args[2] = {arg1, arg2};
-        if (cfunc->flag == METH_FASTCALL) {
-            #if PY_VERSION_HEX >= 0x030700A0
-            return (*(__Pyx_PyCFunctionFast)(void*)(PyCFunction)cfunc->func)(self, args, 2);
-            #else
-            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, 2, NULL);
-            #endif
+    {
+        int result;
+        PyObject *py_slice, *py_start, *py_stop;
+        if (_py_slice) {
+            py_slice = *_py_slice;
+        } else {
+            PyObject* owned_start = NULL;
+            PyObject* owned_stop = NULL;
+            if (_py_start) {
+                py_start = *_py_start;
+            } else {
+                if (has_cstart) {
+                    owned_start = py_start = PyInt_FromSsize_t(cstart);
+                    if (unlikely(!py_start)) goto bad;
+                } else
+                    py_start = Py_None;
+            }
+            if (_py_stop) {
+                py_stop = *_py_stop;
+            } else {
+                if (has_cstop) {
+                    owned_stop = py_stop = PyInt_FromSsize_t(cstop);
+                    if (unlikely(!py_stop)) {
+                        Py_XDECREF(owned_start);
+                        goto bad;
+                    }
+                } else
+                    py_stop = Py_None;
+            }
+            py_slice = PySlice_New(py_start, py_stop, Py_None);
+            Py_XDECREF(owned_start);
+            Py_XDECREF(owned_stop);
+            if (unlikely(!py_slice)) goto bad;
         }
-        #if PY_VERSION_HEX >= 0x030700A0
-        if (cfunc->flag == (METH_FASTCALL | METH_KEYWORDS))
-            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, 2, NULL);
-        #endif
-    }
-    return __Pyx__CallUnboundCMethod2(cfunc, self, arg1, arg2);
-}
-#endif
-static PyObject* __Pyx__CallUnboundCMethod2(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg1, PyObject* arg2){
-    PyObject *args, *result = NULL;
-    if (unlikely(!cfunc->func && !cfunc->method) && unlikely(__Pyx_TryUnpackUnboundCMethod(cfunc) < 0)) return NULL;
-#if CYTHON_COMPILING_IN_CPYTHON
-    if (cfunc->func && (cfunc->flag & METH_VARARGS)) {
-        args = PyTuple_New(2);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(arg1);
-        PyTuple_SET_ITEM(args, 0, arg1);
-        Py_INCREF(arg2);
-        PyTuple_SET_ITEM(args, 1, arg2);
-        if (cfunc->flag & METH_KEYWORDS)
-            result = (*(PyCFunctionWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, NULL);
-        else
-            result = (*cfunc->func)(self, args);
-    } else {
-        args = PyTuple_New(3);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(self);
-        PyTuple_SET_ITEM(args, 0, self);
-        Py_INCREF(arg1);
-        PyTuple_SET_ITEM(args, 1, arg1);
-        Py_INCREF(arg2);
-        PyTuple_SET_ITEM(args, 2, arg2);
-        result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-    }
+#if CYTHON_USE_TYPE_SLOTS
+        result = mp->mp_ass_subscript(obj, py_slice, value);
 #else
-    args = PyTuple_Pack(3, self, arg1, arg2);
-    if (unlikely(!args)) goto bad;
-    result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
+        result = value ? PyObject_SetItem(obj, py_slice, value) : PyObject_DelItem(obj, py_slice);
 #endif
+        if (!_py_slice) {
+            Py_DECREF(py_slice);
+        }
+        return result;
+    }
+    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
+    PyErr_Format(PyExc_TypeError,
+        "'" __Pyx_FMT_TYPENAME "' object does not support slice %.10s",
+        obj_type_name, value ? "assignment" : "deletion");
+    __Pyx_DECREF_TypeName(obj_type_name);
 bad:
-    Py_XDECREF(args);
-    return result;
+    return -1;
 }
 
-/* dict_getitem_default */
-static PyObject* __Pyx_PyDict_GetItemDefault(PyObject* d, PyObject* key, PyObject* default_value) {
-    PyObject* value;
-#if PY_MAJOR_VERSION >= 3 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07020000)
-    value = PyDict_GetItemWithError(d, key);
-    if (unlikely(!value)) {
-        if (unlikely(PyErr_Occurred()))
-            return NULL;
-        value = default_value;
+/* PyIntCompare */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_NeObjC(PyObject *op1, PyObject *op2, long intval, long inplace) {
+    CYTHON_MAYBE_UNUSED_VAR(intval);
+    CYTHON_UNUSED_VAR(inplace);
+    if (op1 == op2) {
+        Py_RETURN_FALSE;
     }
-    Py_INCREF(value);
-    if ((1));
-#else
-    if (PyString_CheckExact(key) || PyUnicode_CheckExact(key) || PyInt_CheckExact(key)) {
-        value = PyDict_GetItem(d, key);
-        if (unlikely(!value)) {
-            value = default_value;
+    #if PY_MAJOR_VERSION < 3
+    if (likely(PyInt_CheckExact(op1))) {
+        const long b = intval;
+        long a = PyInt_AS_LONG(op1);
+        if (a != b) Py_RETURN_TRUE; else Py_RETURN_FALSE;
+    }
+    #endif
+    #if CYTHON_USE_PYLONG_INTERNALS
+    if (likely(PyLong_CheckExact(op1))) {
+        int unequal;
+        unsigned long uintval;
+        Py_ssize_t size = Py_SIZE(op1);
+        const digit* digits = ((PyLongObject*)op1)->ob_digit;
+        if (intval == 0) {
+            if (size != 0) Py_RETURN_TRUE; else Py_RETURN_FALSE;
+        } else if (intval < 0) {
+            if (size >= 0)
+                Py_RETURN_TRUE;
+            intval = -intval;
+            size = -size;
+        } else {
+            if (size <= 0)
+                Py_RETURN_TRUE;
         }
-        Py_INCREF(value);
+        uintval = (unsigned long) intval;
+#if PyLong_SHIFT * 4 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 4)) {
+            unequal = (size != 5) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[2] != ((uintval >> (2 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[3] != ((uintval >> (3 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[4] != ((uintval >> (4 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+#if PyLong_SHIFT * 3 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 3)) {
+            unequal = (size != 4) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[2] != ((uintval >> (2 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[3] != ((uintval >> (3 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+#if PyLong_SHIFT * 2 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 2)) {
+            unequal = (size != 3) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[2] != ((uintval >> (2 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+#if PyLong_SHIFT * 1 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 1)) {
+            unequal = (size != 2) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+            unequal = (size != 1) || (((unsigned long) digits[0]) != (uintval & (unsigned long) PyLong_MASK));
+        if (unequal != 0) Py_RETURN_TRUE; else Py_RETURN_FALSE;
     }
+    #endif
+    if (PyFloat_CheckExact(op1)) {
+        const long b = intval;
+#if CYTHON_COMPILING_IN_LIMITED_API
+        double a = __pyx_PyFloat_AsDouble(op1);
+#else
+        double a = PyFloat_AS_DOUBLE(op1);
 #endif
-    else {
-        if (default_value == Py_None)
-            value = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyDict_Type_get, d, key);
-        else
-            value = __Pyx_CallUnboundCMethod2(&__pyx_umethod_PyDict_Type_get, d, key, default_value);
+        if ((double)a != (double)b) Py_RETURN_TRUE; else Py_RETURN_FALSE;
     }
-    return value;
+    return (
+        PyObject_RichCompare(op1, op2, Py_NE));
 }
 
-/* GetItemInt */
-static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j) {
-    PyObject *r;
-    if (unlikely(!j)) return NULL;
-    r = PyObject_GetItem(o, j);
-    Py_DECREF(j);
-    return r;
-}
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
-                                                              CYTHON_NCP_UNUSED int wraparound,
-                                                              CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    Py_ssize_t wrapped_i = i;
-    if (wraparound & unlikely(i < 0)) {
-        wrapped_i += PyList_GET_SIZE(o);
-    }
-    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyList_GET_SIZE(o)))) {
-        PyObject *r = PyList_GET_ITEM(o, wrapped_i);
-        Py_INCREF(r);
-        return r;
+/* PyIntBinop */
+#if !CYTHON_COMPILING_IN_PYPY
+static PyObject* __Pyx_PyInt_SubtractObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check) {
+    CYTHON_MAYBE_UNUSED_VAR(intval);
+    CYTHON_MAYBE_UNUSED_VAR(inplace);
+    CYTHON_UNUSED_VAR(zerodivision_check);
+    #if PY_MAJOR_VERSION < 3
+    if (likely(PyInt_CheckExact(op1))) {
+        const long b = intval;
+        long x;
+        long a = PyInt_AS_LONG(op1);
+        
+            x = (long)((unsigned long)a - b);
+            if (likely((x^a) >= 0 || (x^~b) >= 0))
+                return PyInt_FromLong(x);
+            return PyLong_Type.tp_as_number->nb_subtract(op1, op2);
     }
-    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
-#else
-    return PySequence_GetItem(o, i);
+    #endif
+    #if CYTHON_USE_PYLONG_INTERNALS
+    if (likely(PyLong_CheckExact(op1))) {
+        const long b = intval;
+        long a, x;
+#ifdef HAVE_LONG_LONG
+        const PY_LONG_LONG llb = intval;
+        PY_LONG_LONG lla, llx;
 #endif
-}
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
-                                                              CYTHON_NCP_UNUSED int wraparound,
-                                                              CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    Py_ssize_t wrapped_i = i;
-    if (wraparound & unlikely(i < 0)) {
-        wrapped_i += PyTuple_GET_SIZE(o);
-    }
-    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyTuple_GET_SIZE(o)))) {
-        PyObject *r = PyTuple_GET_ITEM(o, wrapped_i);
-        Py_INCREF(r);
-        return r;
-    }
-    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
-#else
-    return PySequence_GetItem(o, i);
-#endif
-}
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i, int is_list,
-                                                     CYTHON_NCP_UNUSED int wraparound,
-                                                     CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
-    if (is_list || PyList_CheckExact(o)) {
-        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyList_GET_SIZE(o);
-        if ((!boundscheck) || (likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o))))) {
-            PyObject *r = PyList_GET_ITEM(o, n);
-            Py_INCREF(r);
-            return r;
-        }
-    }
-    else if (PyTuple_CheckExact(o)) {
-        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyTuple_GET_SIZE(o);
-        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyTuple_GET_SIZE(o)))) {
-            PyObject *r = PyTuple_GET_ITEM(o, n);
-            Py_INCREF(r);
-            return r;
-        }
-    } else {
-        PyMappingMethods *mm = Py_TYPE(o)->tp_as_mapping;
-        PySequenceMethods *sm = Py_TYPE(o)->tp_as_sequence;
-        if (mm && mm->mp_subscript) {
-            PyObject *r, *key = PyInt_FromSsize_t(i);
-            if (unlikely(!key)) return NULL;
-            r = mm->mp_subscript(o, key);
-            Py_DECREF(key);
-            return r;
-        }
-        if (likely(sm && sm->sq_item)) {
-            if (wraparound && unlikely(i < 0) && likely(sm->sq_length)) {
-                Py_ssize_t l = sm->sq_length(o);
-                if (likely(l >= 0)) {
-                    i += l;
-                } else {
-                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
-                        return NULL;
-                    PyErr_Clear();
-                }
+        const digit* digits = ((PyLongObject*)op1)->ob_digit;
+        const Py_ssize_t size = Py_SIZE(op1);
+        if (unlikely(size == 0)) {
+            return PyLong_FromLong(-intval);
+        }
+        if (likely(__Pyx_sst_abs(size) <= 1)) {
+            a = likely(size) ? digits[0] : 0;
+            if (size == -1) a = -a;
+        } else {
+            switch (size) {
+                case -2:
+                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
+                        a = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
+                        lla = -(PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case 2:
+                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
+                        a = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
+                        lla = (PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case -3:
+                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
+                        a = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
+                        lla = -(PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case 3:
+                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
+                        a = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
+                        lla = (PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case -4:
+                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
+                        a = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
+                        lla = -(PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case 4:
+                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
+                        a = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
+                        lla = (PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                default: return PyLong_Type.tp_as_number->nb_subtract(op1, op2);
             }
-            return sm->sq_item(o, i);
         }
+                x = a - b;
+            return PyLong_FromLong(x);
+#ifdef HAVE_LONG_LONG
+        long_long:
+                llx = lla - llb;
+            return PyLong_FromLongLong(llx);
+#endif
+        
+        
     }
+    #endif
+    if (PyFloat_CheckExact(op1)) {
+        const long b = intval;
+#if CYTHON_COMPILING_IN_LIMITED_API
+        double a = __pyx_PyFloat_AsDouble(op1);
 #else
-    if (is_list || PySequence_Check(o)) {
-        return PySequence_GetItem(o, i);
-    }
+        double a = PyFloat_AS_DOUBLE(op1);
 #endif
-    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
-}
-
-/* PyErrFetchRestore */
-#if CYTHON_FAST_THREAD_STATE
-static CYTHON_INLINE void __Pyx_ErrRestoreInState(PyThreadState *tstate, PyObject *type, PyObject *value, PyObject *tb) {
-    PyObject *tmp_type, *tmp_value, *tmp_tb;
-    tmp_type = tstate->curexc_type;
-    tmp_value = tstate->curexc_value;
-    tmp_tb = tstate->curexc_traceback;
-    tstate->curexc_type = type;
-    tstate->curexc_value = value;
-    tstate->curexc_traceback = tb;
-    Py_XDECREF(tmp_type);
-    Py_XDECREF(tmp_value);
-    Py_XDECREF(tmp_tb);
-}
-static CYTHON_INLINE void __Pyx_ErrFetchInState(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb) {
-    *type = tstate->curexc_type;
-    *value = tstate->curexc_value;
-    *tb = tstate->curexc_traceback;
-    tstate->curexc_type = 0;
-    tstate->curexc_value = 0;
-    tstate->curexc_traceback = 0;
+            double result;
+            
+            PyFPE_START_PROTECT("subtract", return NULL)
+            result = ((double)a) - (double)b;
+            PyFPE_END_PROTECT(result)
+            return PyFloat_FromDouble(result);
+    }
+    return (inplace ? PyNumber_InPlaceSubtract : PyNumber_Subtract)(op1, op2);
 }
 #endif
 
 /* WriteUnraisableException */
 static void __Pyx_WriteUnraisable(const char *name, int clineno,
                                   int lineno, const char *filename,
                                   int full_traceback, int nogil) {
@@ -8076,919 +7243,14 @@
     }
 #ifdef WITH_THREAD
     if (nogil)
         PyGILState_Release(state);
 #endif
 }
 
-/* PyFunctionFastCall */
-#if CYTHON_FAST_PYCALL && !CYTHON_VECTORCALL
-static PyObject* __Pyx_PyFunction_FastCallNoKw(PyCodeObject *co, PyObject **args, Py_ssize_t na,
-                                               PyObject *globals) {
-    PyFrameObject *f;
-    PyThreadState *tstate = __Pyx_PyThreadState_Current;
-    PyObject **fastlocals;
-    Py_ssize_t i;
-    PyObject *result;
-    assert(globals != NULL);
-    /* XXX Perhaps we should create a specialized
-       PyFrame_New() that doesn't take locals, but does
-       take builtins without sanity checking them.
-       */
-    assert(tstate != NULL);
-    f = PyFrame_New(tstate, co, globals, NULL);
-    if (f == NULL) {
-        return NULL;
-    }
-    fastlocals = __Pyx_PyFrame_GetLocalsplus(f);
-    for (i = 0; i < na; i++) {
-        Py_INCREF(*args);
-        fastlocals[i] = *args++;
-    }
-    result = PyEval_EvalFrameEx(f,0);
-    ++tstate->recursion_depth;
-    Py_DECREF(f);
-    --tstate->recursion_depth;
-    return result;
-}
-static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs) {
-    PyCodeObject *co = (PyCodeObject *)PyFunction_GET_CODE(func);
-    PyObject *globals = PyFunction_GET_GLOBALS(func);
-    PyObject *argdefs = PyFunction_GET_DEFAULTS(func);
-    PyObject *closure;
-#if PY_MAJOR_VERSION >= 3
-    PyObject *kwdefs;
-#endif
-    PyObject *kwtuple, **k;
-    PyObject **d;
-    Py_ssize_t nd;
-    Py_ssize_t nk;
-    PyObject *result;
-    assert(kwargs == NULL || PyDict_Check(kwargs));
-    nk = kwargs ? PyDict_Size(kwargs) : 0;
-    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object"))) {
-        return NULL;
-    }
-    if (
-#if PY_MAJOR_VERSION >= 3
-            co->co_kwonlyargcount == 0 &&
-#endif
-            likely(kwargs == NULL || nk == 0) &&
-            co->co_flags == (CO_OPTIMIZED | CO_NEWLOCALS | CO_NOFREE)) {
-        if (argdefs == NULL && co->co_argcount == nargs) {
-            result = __Pyx_PyFunction_FastCallNoKw(co, args, nargs, globals);
-            goto done;
-        }
-        else if (nargs == 0 && argdefs != NULL
-                 && co->co_argcount == Py_SIZE(argdefs)) {
-            /* function called with no arguments, but all parameters have
-               a default value: use default values as arguments .*/
-            args = &PyTuple_GET_ITEM(argdefs, 0);
-            result =__Pyx_PyFunction_FastCallNoKw(co, args, Py_SIZE(argdefs), globals);
-            goto done;
-        }
-    }
-    if (kwargs != NULL) {
-        Py_ssize_t pos, i;
-        kwtuple = PyTuple_New(2 * nk);
-        if (kwtuple == NULL) {
-            result = NULL;
-            goto done;
-        }
-        k = &PyTuple_GET_ITEM(kwtuple, 0);
-        pos = i = 0;
-        while (PyDict_Next(kwargs, &pos, &k[i], &k[i+1])) {
-            Py_INCREF(k[i]);
-            Py_INCREF(k[i+1]);
-            i += 2;
-        }
-        nk = i / 2;
-    }
-    else {
-        kwtuple = NULL;
-        k = NULL;
-    }
-    closure = PyFunction_GET_CLOSURE(func);
-#if PY_MAJOR_VERSION >= 3
-    kwdefs = PyFunction_GET_KW_DEFAULTS(func);
-#endif
-    if (argdefs != NULL) {
-        d = &PyTuple_GET_ITEM(argdefs, 0);
-        nd = Py_SIZE(argdefs);
-    }
-    else {
-        d = NULL;
-        nd = 0;
-    }
-#if PY_MAJOR_VERSION >= 3
-    result = PyEval_EvalCodeEx((PyObject*)co, globals, (PyObject *)NULL,
-                               args, (int)nargs,
-                               k, (int)nk,
-                               d, (int)nd, kwdefs, closure);
-#else
-    result = PyEval_EvalCodeEx(co, globals, (PyObject *)NULL,
-                               args, (int)nargs,
-                               k, (int)nk,
-                               d, (int)nd, closure);
-#endif
-    Py_XDECREF(kwtuple);
-done:
-    Py_LeaveRecursiveCall();
-    return result;
-}
-#endif
-
-/* PyObjectCallMethO */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg) {
-    PyObject *self, *result;
-    PyCFunction cfunc;
-    cfunc = PyCFunction_GET_FUNCTION(func);
-    self = PyCFunction_GET_SELF(func);
-    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
-        return NULL;
-    result = cfunc(self, arg);
-    Py_LeaveRecursiveCall();
-    if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
-        PyErr_SetString(
-            PyExc_SystemError,
-            "NULL result without error in PyObject_Call");
-    }
-    return result;
-}
-#endif
-
-/* PyObjectFastCall */
-static PyObject* __Pyx_PyObject_FastCall_fallback(PyObject *func, PyObject **args, size_t nargs, PyObject *kwargs) {
-    PyObject *argstuple;
-    PyObject *result;
-    size_t i;
-    argstuple = PyTuple_New((Py_ssize_t)nargs);
-    if (unlikely(!argstuple)) return NULL;
-    for (i = 0; i < nargs; i++) {
-        Py_INCREF(args[i]);
-        PyTuple_SET_ITEM(argstuple, (Py_ssize_t)i, args[i]);
-    }
-    result = __Pyx_PyObject_Call(func, argstuple, kwargs);
-    Py_DECREF(argstuple);
-    return result;
-}
-static CYTHON_INLINE PyObject* __Pyx_PyObject_FastCallDict(PyObject *func, PyObject **args, size_t _nargs, PyObject *kwargs) {
-    Py_ssize_t nargs = __Pyx_PyVectorcall_NARGS(_nargs);
-#if CYTHON_COMPILING_IN_CPYTHON
-    if (nargs == 0 && kwargs == NULL) {
-#ifdef __Pyx_CyFunction_USED
-        if (__Pyx_IsCyOrPyCFunction(func))
-#else
-        if (PyCFunction_Check(func))
-#endif
-        {
-            if (likely(PyCFunction_GET_FLAGS(func) & METH_NOARGS)) {
-                return __Pyx_PyObject_CallMethO(func, NULL);
-            }
-        }
-    }
-    else if (nargs == 1 && kwargs == NULL) {
-        if (PyCFunction_Check(func))
-        {
-            if (likely(PyCFunction_GET_FLAGS(func) & METH_O)) {
-                return __Pyx_PyObject_CallMethO(func, args[0]);
-            }
-        }
-    }
-#endif
-    #if PY_VERSION_HEX < 0x030800B1
-    #if CYTHON_FAST_PYCCALL
-    if (PyCFunction_Check(func)) {
-        if (kwargs) {
-            return _PyCFunction_FastCallDict(func, args, nargs, kwargs);
-        } else {
-            return _PyCFunction_FastCallKeywords(func, args, nargs, NULL);
-        }
-    }
-    #if PY_VERSION_HEX >= 0x030700A1
-    if (!kwargs && __Pyx_IS_TYPE(func, &PyMethodDescr_Type)) {
-        return _PyMethodDescr_FastCallKeywords(func, args, nargs, NULL);
-    }
-    #endif
-    #endif
-    #if CYTHON_FAST_PYCALL
-    if (PyFunction_Check(func)) {
-        return __Pyx_PyFunction_FastCallDict(func, args, nargs, kwargs);
-    }
-    #endif
-    #endif
-    #if CYTHON_VECTORCALL
-    vectorcallfunc f = _PyVectorcall_Function(func);
-    if (f) {
-        return f(func, args, (size_t)nargs, kwargs);
-    }
-    #elif defined(__Pyx_CyFunction_USED) && CYTHON_BACKPORT_VECTORCALL
-    if (__Pyx_CyFunction_CheckExact(func)) {
-        __pyx_vectorcallfunc f = __Pyx_CyFunction_func_vectorcall(func);
-        if (f) return f(func, args, (size_t)nargs, kwargs);
-    }
-    #endif
-    if (nargs == 0) {
-        return __Pyx_PyObject_Call(func, __pyx_empty_tuple, kwargs);
-    }
-    return __Pyx_PyObject_FastCall_fallback(func, args, (size_t)nargs, kwargs);
-}
-
-/* PyObjectCallNoArg */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func) {
-    PyObject *arg = NULL;
-    return __Pyx_PyObject_FastCall(func, (&arg)+1, 0 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
-}
-
-/* PyObjectCallOneArg */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg) {
-    PyObject *args[2] = {NULL, arg};
-    return __Pyx_PyObject_FastCall(func, args+1, 1 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
-}
-
-/* PyObjectGetMethod */
-static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method) {
-    PyObject *attr;
-#if CYTHON_UNPACK_METHODS && CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_PYTYPE_LOOKUP
-    __Pyx_TypeName type_name;
-    PyTypeObject *tp = Py_TYPE(obj);
-    PyObject *descr;
-    descrgetfunc f = NULL;
-    PyObject **dictptr, *dict;
-    int meth_found = 0;
-    assert (*method == NULL);
-    if (unlikely(tp->tp_getattro != PyObject_GenericGetAttr)) {
-        attr = __Pyx_PyObject_GetAttrStr(obj, name);
-        goto try_unpack;
-    }
-    if (unlikely(tp->tp_dict == NULL) && unlikely(PyType_Ready(tp) < 0)) {
-        return 0;
-    }
-    descr = _PyType_Lookup(tp, name);
-    if (likely(descr != NULL)) {
-        Py_INCREF(descr);
-#if defined(Py_TPFLAGS_METHOD_DESCRIPTOR) && Py_TPFLAGS_METHOD_DESCRIPTOR
-        if (__Pyx_PyType_HasFeature(Py_TYPE(descr), Py_TPFLAGS_METHOD_DESCRIPTOR))
-#elif PY_MAJOR_VERSION >= 3
-        #ifdef __Pyx_CyFunction_USED
-        if (likely(PyFunction_Check(descr) || __Pyx_IS_TYPE(descr, &PyMethodDescr_Type) || __Pyx_CyFunction_Check(descr)))
-        #else
-        if (likely(PyFunction_Check(descr) || __Pyx_IS_TYPE(descr, &PyMethodDescr_Type)))
-        #endif
-#else
-        #ifdef __Pyx_CyFunction_USED
-        if (likely(PyFunction_Check(descr) || __Pyx_CyFunction_Check(descr)))
-        #else
-        if (likely(PyFunction_Check(descr)))
-        #endif
-#endif
-        {
-            meth_found = 1;
-        } else {
-            f = Py_TYPE(descr)->tp_descr_get;
-            if (f != NULL && PyDescr_IsData(descr)) {
-                attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
-                Py_DECREF(descr);
-                goto try_unpack;
-            }
-        }
-    }
-    dictptr = _PyObject_GetDictPtr(obj);
-    if (dictptr != NULL && (dict = *dictptr) != NULL) {
-        Py_INCREF(dict);
-        attr = __Pyx_PyDict_GetItemStr(dict, name);
-        if (attr != NULL) {
-            Py_INCREF(attr);
-            Py_DECREF(dict);
-            Py_XDECREF(descr);
-            goto try_unpack;
-        }
-        Py_DECREF(dict);
-    }
-    if (meth_found) {
-        *method = descr;
-        return 1;
-    }
-    if (f != NULL) {
-        attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
-        Py_DECREF(descr);
-        goto try_unpack;
-    }
-    if (likely(descr != NULL)) {
-        *method = descr;
-        return 0;
-    }
-    type_name = __Pyx_PyType_GetName(tp);
-    PyErr_Format(PyExc_AttributeError,
-#if PY_MAJOR_VERSION >= 3
-                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%U'",
-                 type_name, name);
-#else
-                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%.400s'",
-                 type_name, PyString_AS_STRING(name));
-#endif
-    __Pyx_DECREF_TypeName(type_name);
-    return 0;
-#else
-    attr = __Pyx_PyObject_GetAttrStr(obj, name);
-    goto try_unpack;
-#endif
-try_unpack:
-#if CYTHON_UNPACK_METHODS
-    if (likely(attr) && PyMethod_Check(attr) && likely(PyMethod_GET_SELF(attr) == obj)) {
-        PyObject *function = PyMethod_GET_FUNCTION(attr);
-        Py_INCREF(function);
-        Py_DECREF(attr);
-        *method = function;
-        return 1;
-    }
-#endif
-    *method = attr;
-    return 0;
-}
-
-/* PyObjectCallMethod0 */
-static PyObject* __Pyx_PyObject_CallMethod0(PyObject* obj, PyObject* method_name) {
-    PyObject *method = NULL, *result = NULL;
-    int is_method = __Pyx_PyObject_GetMethod(obj, method_name, &method);
-    if (likely(is_method)) {
-        result = __Pyx_PyObject_CallOneArg(method, obj);
-        Py_DECREF(method);
-        return result;
-    }
-    if (unlikely(!method)) goto bad;
-    result = __Pyx_PyObject_CallNoArg(method);
-    Py_DECREF(method);
-bad:
-    return result;
-}
-
-/* RaiseNeedMoreValuesToUnpack */
-static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index) {
-    PyErr_Format(PyExc_ValueError,
-                 "need more than %" CYTHON_FORMAT_SSIZE_T "d value%.1s to unpack",
-                 index, (index == 1) ? "" : "s");
-}
-
-/* RaiseTooManyValuesToUnpack */
-static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected) {
-    PyErr_Format(PyExc_ValueError,
-                 "too many values to unpack (expected %" CYTHON_FORMAT_SSIZE_T "d)", expected);
-}
-
-/* UnpackItemEndCheck */
-static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected) {
-    if (unlikely(retval)) {
-        Py_DECREF(retval);
-        __Pyx_RaiseTooManyValuesError(expected);
-        return -1;
-    }
-    return __Pyx_IterFinish();
-}
-
-/* RaiseNoneIterError */
-static CYTHON_INLINE void __Pyx_RaiseNoneNotIterableError(void) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-}
-
-/* UnpackTupleError */
-static void __Pyx_UnpackTupleError(PyObject *t, Py_ssize_t index) {
-    if (t == Py_None) {
-      __Pyx_RaiseNoneNotIterableError();
-    } else if (PyTuple_GET_SIZE(t) < index) {
-      __Pyx_RaiseNeedMoreValuesError(PyTuple_GET_SIZE(t));
-    } else {
-      __Pyx_RaiseTooManyValuesError(index);
-    }
-}
-
-/* UnpackTuple2 */
-static CYTHON_INLINE int __Pyx_unpack_tuple2_exact(
-        PyObject* tuple, PyObject** pvalue1, PyObject** pvalue2, int decref_tuple) {
-    PyObject *value1 = NULL, *value2 = NULL;
-#if CYTHON_COMPILING_IN_PYPY
-    value1 = PySequence_ITEM(tuple, 0);  if (unlikely(!value1)) goto bad;
-    value2 = PySequence_ITEM(tuple, 1);  if (unlikely(!value2)) goto bad;
-#else
-    value1 = PyTuple_GET_ITEM(tuple, 0);  Py_INCREF(value1);
-    value2 = PyTuple_GET_ITEM(tuple, 1);  Py_INCREF(value2);
-#endif
-    if (decref_tuple) {
-        Py_DECREF(tuple);
-    }
-    *pvalue1 = value1;
-    *pvalue2 = value2;
-    return 0;
-#if CYTHON_COMPILING_IN_PYPY
-bad:
-    Py_XDECREF(value1);
-    Py_XDECREF(value2);
-    if (decref_tuple) { Py_XDECREF(tuple); }
-    return -1;
-#endif
-}
-static int __Pyx_unpack_tuple2_generic(PyObject* tuple, PyObject** pvalue1, PyObject** pvalue2,
-                                       int has_known_size, int decref_tuple) {
-    Py_ssize_t index;
-    PyObject *value1 = NULL, *value2 = NULL, *iter = NULL;
-    iternextfunc iternext;
-    iter = PyObject_GetIter(tuple);
-    if (unlikely(!iter)) goto bad;
-    if (decref_tuple) { Py_DECREF(tuple); tuple = NULL; }
-    iternext = __Pyx_PyObject_GetIterNextFunc(iter);
-    value1 = iternext(iter); if (unlikely(!value1)) { index = 0; goto unpacking_failed; }
-    value2 = iternext(iter); if (unlikely(!value2)) { index = 1; goto unpacking_failed; }
-    if (!has_known_size && unlikely(__Pyx_IternextUnpackEndCheck(iternext(iter), 2))) goto bad;
-    Py_DECREF(iter);
-    *pvalue1 = value1;
-    *pvalue2 = value2;
-    return 0;
-unpacking_failed:
-    if (!has_known_size && __Pyx_IterFinish() == 0)
-        __Pyx_RaiseNeedMoreValuesError(index);
-bad:
-    Py_XDECREF(iter);
-    Py_XDECREF(value1);
-    Py_XDECREF(value2);
-    if (decref_tuple) { Py_XDECREF(tuple); }
-    return -1;
-}
-
-/* dict_iter */
-static CYTHON_INLINE PyObject* __Pyx_dict_iterator(PyObject* iterable, int is_dict, PyObject* method_name,
-                                                   Py_ssize_t* p_orig_length, int* p_source_is_dict) {
-    is_dict = is_dict || likely(PyDict_CheckExact(iterable));
-    *p_source_is_dict = is_dict;
-    if (is_dict) {
-#if !CYTHON_COMPILING_IN_PYPY
-        *p_orig_length = PyDict_Size(iterable);
-        Py_INCREF(iterable);
-        return iterable;
-#elif PY_MAJOR_VERSION >= 3
-        static PyObject *py_items = NULL, *py_keys = NULL, *py_values = NULL;
-        PyObject **pp = NULL;
-        if (method_name) {
-            const char *name = PyUnicode_AsUTF8(method_name);
-            if (strcmp(name, "iteritems") == 0) pp = &py_items;
-            else if (strcmp(name, "iterkeys") == 0) pp = &py_keys;
-            else if (strcmp(name, "itervalues") == 0) pp = &py_values;
-            if (pp) {
-                if (!*pp) {
-                    *pp = PyUnicode_FromString(name + 4);
-                    if (!*pp)
-                        return NULL;
-                }
-                method_name = *pp;
-            }
-        }
-#endif
-    }
-    *p_orig_length = 0;
-    if (method_name) {
-        PyObject* iter;
-        iterable = __Pyx_PyObject_CallMethod0(iterable, method_name);
-        if (!iterable)
-            return NULL;
-#if !CYTHON_COMPILING_IN_PYPY
-        if (PyTuple_CheckExact(iterable) || PyList_CheckExact(iterable))
-            return iterable;
-#endif
-        iter = PyObject_GetIter(iterable);
-        Py_DECREF(iterable);
-        return iter;
-    }
-    return PyObject_GetIter(iterable);
-}
-static CYTHON_INLINE int __Pyx_dict_iter_next(
-        PyObject* iter_obj, CYTHON_NCP_UNUSED Py_ssize_t orig_length, CYTHON_NCP_UNUSED Py_ssize_t* ppos,
-        PyObject** pkey, PyObject** pvalue, PyObject** pitem, int source_is_dict) {
-    PyObject* next_item;
-#if !CYTHON_COMPILING_IN_PYPY
-    if (source_is_dict) {
-        PyObject *key, *value;
-        if (unlikely(orig_length != PyDict_Size(iter_obj))) {
-            PyErr_SetString(PyExc_RuntimeError, "dictionary changed size during iteration");
-            return -1;
-        }
-        if (unlikely(!PyDict_Next(iter_obj, ppos, &key, &value))) {
-            return 0;
-        }
-        if (pitem) {
-            PyObject* tuple = PyTuple_New(2);
-            if (unlikely(!tuple)) {
-                return -1;
-            }
-            Py_INCREF(key);
-            Py_INCREF(value);
-            PyTuple_SET_ITEM(tuple, 0, key);
-            PyTuple_SET_ITEM(tuple, 1, value);
-            *pitem = tuple;
-        } else {
-            if (pkey) {
-                Py_INCREF(key);
-                *pkey = key;
-            }
-            if (pvalue) {
-                Py_INCREF(value);
-                *pvalue = value;
-            }
-        }
-        return 1;
-    } else if (PyTuple_CheckExact(iter_obj)) {
-        Py_ssize_t pos = *ppos;
-        if (unlikely(pos >= PyTuple_GET_SIZE(iter_obj))) return 0;
-        *ppos = pos + 1;
-        next_item = PyTuple_GET_ITEM(iter_obj, pos);
-        Py_INCREF(next_item);
-    } else if (PyList_CheckExact(iter_obj)) {
-        Py_ssize_t pos = *ppos;
-        if (unlikely(pos >= PyList_GET_SIZE(iter_obj))) return 0;
-        *ppos = pos + 1;
-        next_item = PyList_GET_ITEM(iter_obj, pos);
-        Py_INCREF(next_item);
-    } else
-#endif
-    {
-        next_item = PyIter_Next(iter_obj);
-        if (unlikely(!next_item)) {
-            return __Pyx_IterFinish();
-        }
-    }
-    if (pitem) {
-        *pitem = next_item;
-    } else if (pkey && pvalue) {
-        if (__Pyx_unpack_tuple2(next_item, pkey, pvalue, source_is_dict, source_is_dict, 1))
-            return -1;
-    } else if (pkey) {
-        *pkey = next_item;
-    } else {
-        *pvalue = next_item;
-    }
-    return 1;
-}
-
-/* DictGetItem */
-#if PY_MAJOR_VERSION >= 3 && !CYTHON_COMPILING_IN_PYPY
-static PyObject *__Pyx_PyDict_GetItem(PyObject *d, PyObject* key) {
-    PyObject *value;
-    value = PyDict_GetItemWithError(d, key);
-    if (unlikely(!value)) {
-        if (!PyErr_Occurred()) {
-            if (unlikely(PyTuple_Check(key))) {
-                PyObject* args = PyTuple_Pack(1, key);
-                if (likely(args)) {
-                    PyErr_SetObject(PyExc_KeyError, args);
-                    Py_DECREF(args);
-                }
-            } else {
-                PyErr_SetObject(PyExc_KeyError, key);
-            }
-        }
-        return NULL;
-    }
-    Py_INCREF(value);
-    return value;
-}
-#endif
-
-/* KeywordStringCheck */
-static int __Pyx_CheckKeywordStrings(
-    PyObject *kw,
-    const char* function_name,
-    int kw_allowed)
-{
-    PyObject* key = 0;
-    Py_ssize_t pos = 0;
-#if CYTHON_COMPILING_IN_PYPY
-    if (!kw_allowed && PyDict_Next(kw, &pos, &key, 0))
-        goto invalid_keyword;
-    return 1;
-#else
-    if (CYTHON_METH_FASTCALL && likely(PyTuple_Check(kw))) {
-        if (unlikely(PyTuple_GET_SIZE(kw) == 0))
-            return 1;
-        if (!kw_allowed) {
-            key = PyTuple_GET_ITEM(kw, 0);
-            goto invalid_keyword;
-        }
-#if PY_VERSION_HEX < 0x03090000
-        for (pos = 0; pos < PyTuple_GET_SIZE(kw); pos++) {
-            key = PyTuple_GET_ITEM(kw, pos);
-            if (unlikely(!PyUnicode_Check(key)))
-                goto invalid_keyword_type;
-        }
-#endif
-        return 1;
-    }
-    while (PyDict_Next(kw, &pos, &key, 0)) {
-        #if PY_MAJOR_VERSION < 3
-        if (unlikely(!PyString_Check(key)))
-        #endif
-            if (unlikely(!PyUnicode_Check(key)))
-                goto invalid_keyword_type;
-    }
-    if (!kw_allowed && unlikely(key))
-        goto invalid_keyword;
-    return 1;
-invalid_keyword_type:
-    PyErr_Format(PyExc_TypeError,
-        "%.200s() keywords must be strings", function_name);
-    return 0;
-#endif
-invalid_keyword:
-    #if PY_MAJOR_VERSION < 3
-    PyErr_Format(PyExc_TypeError,
-        "%.200s() got an unexpected keyword argument '%.200s'",
-        function_name, PyString_AsString(key));
-    #else
-    PyErr_Format(PyExc_TypeError,
-        "%s() got an unexpected keyword argument '%U'",
-        function_name, key);
-    #endif
-    return 0;
-}
-
-/* PyErrExceptionMatches */
-#if CYTHON_FAST_THREAD_STATE
-static int __Pyx_PyErr_ExceptionMatchesTuple(PyObject *exc_type, PyObject *tuple) {
-    Py_ssize_t i, n;
-    n = PyTuple_GET_SIZE(tuple);
-#if PY_MAJOR_VERSION >= 3
-    for (i=0; i<n; i++) {
-        if (exc_type == PyTuple_GET_ITEM(tuple, i)) return 1;
-    }
-#endif
-    for (i=0; i<n; i++) {
-        if (__Pyx_PyErr_GivenExceptionMatches(exc_type, PyTuple_GET_ITEM(tuple, i))) return 1;
-    }
-    return 0;
-}
-static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err) {
-    PyObject *exc_type = tstate->curexc_type;
-    if (exc_type == err) return 1;
-    if (unlikely(!exc_type)) return 0;
-    if (unlikely(PyTuple_Check(err)))
-        return __Pyx_PyErr_ExceptionMatchesTuple(exc_type, err);
-    return __Pyx_PyErr_GivenExceptionMatches(exc_type, err);
-}
-#endif
-
-/* GetAttr3 */
-static PyObject *__Pyx_GetAttr3Default(PyObject *d) {
-    __Pyx_PyThreadState_declare
-    __Pyx_PyThreadState_assign
-    if (unlikely(!__Pyx_PyErr_ExceptionMatches(PyExc_AttributeError)))
-        return NULL;
-    __Pyx_PyErr_Clear();
-    Py_INCREF(d);
-    return d;
-}
-static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *o, PyObject *n, PyObject *d) {
-    PyObject *r;
-#if CYTHON_USE_TYPE_SLOTS
-    if (likely(PyString_Check(n))) {
-        r = __Pyx_PyObject_GetAttrStrNoError(o, n);
-        if (unlikely(!r) && likely(!PyErr_Occurred())) {
-            r = __Pyx_NewRef(d);
-        }
-        return r;
-    }
-#endif
-    r = PyObject_GetAttr(o, n);
-    return (likely(r)) ? r : __Pyx_GetAttr3Default(d);
-}
-
-/* PyObjectGetAttrStrNoError */
-static void __Pyx_PyObject_GetAttrStr_ClearAttributeError(void) {
-    __Pyx_PyThreadState_declare
-    __Pyx_PyThreadState_assign
-    if (likely(__Pyx_PyErr_ExceptionMatches(PyExc_AttributeError)))
-        __Pyx_PyErr_Clear();
-}
-static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStrNoError(PyObject* obj, PyObject* attr_name) {
-    PyObject *result;
-#if CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_TYPE_SLOTS && PY_VERSION_HEX >= 0x030700B1
-    PyTypeObject* tp = Py_TYPE(obj);
-    if (likely(tp->tp_getattro == PyObject_GenericGetAttr)) {
-        return _PyObject_GenericGetAttrWithDict(obj, attr_name, NULL, 1);
-    }
-#endif
-    result = __Pyx_PyObject_GetAttrStr(obj, attr_name);
-    if (unlikely(!result)) {
-        __Pyx_PyObject_GetAttrStr_ClearAttributeError();
-    }
-    return result;
-}
-
-/* GetBuiltinName */
-static PyObject *__Pyx_GetBuiltinName(PyObject *name) {
-    PyObject* result = __Pyx_PyObject_GetAttrStrNoError(__pyx_b, name);
-    if (unlikely(!result) && !PyErr_Occurred()) {
-        PyErr_Format(PyExc_NameError,
-#if PY_MAJOR_VERSION >= 3
-            "name '%U' is not defined", name);
-#else
-            "name '%.200s' is not defined", PyString_AS_STRING(name));
-#endif
-    }
-    return result;
-}
-
-/* PyDictVersioning */
-#if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
-static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj) {
-    PyObject *dict = Py_TYPE(obj)->tp_dict;
-    return likely(dict) ? __PYX_GET_DICT_VERSION(dict) : 0;
-}
-static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj) {
-    PyObject **dictptr = NULL;
-    Py_ssize_t offset = Py_TYPE(obj)->tp_dictoffset;
-    if (offset) {
-#if CYTHON_COMPILING_IN_CPYTHON
-        dictptr = (likely(offset > 0)) ? (PyObject **) ((char *)obj + offset) : _PyObject_GetDictPtr(obj);
-#else
-        dictptr = _PyObject_GetDictPtr(obj);
-#endif
-    }
-    return (dictptr && *dictptr) ? __PYX_GET_DICT_VERSION(*dictptr) : 0;
-}
-static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version) {
-    PyObject *dict = Py_TYPE(obj)->tp_dict;
-    if (unlikely(!dict) || unlikely(tp_dict_version != __PYX_GET_DICT_VERSION(dict)))
-        return 0;
-    return obj_dict_version == __Pyx_get_object_dict_version(obj);
-}
-#endif
-
-/* GetModuleGlobalName */
-#if CYTHON_USE_DICT_VERSIONS
-static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value)
-#else
-static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name)
-#endif
-{
-    PyObject *result;
-#if !CYTHON_AVOID_BORROWED_REFS
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1
-    result = _PyDict_GetItem_KnownHash(__pyx_d, name, ((PyASCIIObject *) name)->hash);
-    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
-    if (likely(result)) {
-        return __Pyx_NewRef(result);
-    } else if (unlikely(PyErr_Occurred())) {
-        return NULL;
-    }
-#elif CYTHON_COMPILING_IN_LIMITED_API
-    if (unlikely(!__pyx_m)) {
-        return NULL;
-    }
-    result = PyObject_GetAttr(__pyx_m, name);
-    if (likely(result)) {
-        return result;
-    }
-#else
-    result = PyDict_GetItem(__pyx_d, name);
-    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
-    if (likely(result)) {
-        return __Pyx_NewRef(result);
-    }
-#endif
-#else
-    result = PyObject_GetItem(__pyx_d, name);
-    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
-    if (likely(result)) {
-        return __Pyx_NewRef(result);
-    }
-    PyErr_Clear();
-#endif
-    return __Pyx_GetBuiltinName(name);
-}
-
-/* RaiseUnexpectedTypeError */
-static int
-__Pyx_RaiseUnexpectedTypeError(const char *expected, PyObject *obj)
-{
-    __Pyx_TypeName obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
-    PyErr_Format(PyExc_TypeError, "Expected %s, got " __Pyx_FMT_TYPENAME,
-                 expected, obj_type_name);
-    __Pyx_DECREF_TypeName(obj_type_name);
-    return 0;
-}
-
-/* Import */
-static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
-    PyObject *module = 0;
-    PyObject *empty_dict = 0;
-    PyObject *empty_list = 0;
-    #if PY_MAJOR_VERSION < 3
-    PyObject *py_import;
-    py_import = __Pyx_PyObject_GetAttrStr(__pyx_b, __pyx_n_s_import);
-    if (unlikely(!py_import))
-        goto bad;
-    if (!from_list) {
-        empty_list = PyList_New(0);
-        if (unlikely(!empty_list))
-            goto bad;
-        from_list = empty_list;
-    }
-    #endif
-    empty_dict = PyDict_New();
-    if (unlikely(!empty_dict))
-        goto bad;
-    {
-        #if PY_MAJOR_VERSION >= 3
-        if (level == -1) {
-            if ((1) && (strchr(__Pyx_MODULE_NAME, '.'))) {
-                #if CYTHON_COMPILING_IN_LIMITED_API
-                module = PyImport_ImportModuleLevelObject(
-                    name, empty_dict, empty_dict, from_list, 1);
-                #else
-                module = PyImport_ImportModuleLevelObject(
-                    name, __pyx_d, empty_dict, from_list, 1);
-                #endif
-                if (unlikely(!module)) {
-                    if (unlikely(!PyErr_ExceptionMatches(PyExc_ImportError)))
-                        goto bad;
-                    PyErr_Clear();
-                }
-            }
-            level = 0;
-        }
-        #endif
-        if (!module) {
-            #if PY_MAJOR_VERSION < 3
-            PyObject *py_level = PyInt_FromLong(level);
-            if (unlikely(!py_level))
-                goto bad;
-            module = PyObject_CallFunctionObjArgs(py_import,
-                name, __pyx_d, empty_dict, from_list, py_level, (PyObject *)NULL);
-            Py_DECREF(py_level);
-            #else
-            #if CYTHON_COMPILING_IN_LIMITED_API
-            module = PyImport_ImportModuleLevelObject(
-                name, empty_dict, empty_dict, from_list, level);
-            #else
-            module = PyImport_ImportModuleLevelObject(
-                name, __pyx_d, empty_dict, from_list, level);
-            #endif
-            #endif
-        }
-    }
-bad:
-    Py_XDECREF(empty_dict);
-    Py_XDECREF(empty_list);
-    #if PY_MAJOR_VERSION < 3
-    Py_XDECREF(py_import);
-    #endif
-    return module;
-}
-
-/* ImportFrom */
-static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name) {
-    PyObject* value = __Pyx_PyObject_GetAttrStr(module, name);
-    if (unlikely(!value) && PyErr_ExceptionMatches(PyExc_AttributeError)) {
-        const char* module_name_str = 0;
-        PyObject* module_name = 0;
-        PyObject* module_dot = 0;
-        PyObject* full_name = 0;
-        PyErr_Clear();
-        module_name_str = PyModule_GetName(module);
-        if (unlikely(!module_name_str)) { goto modbad; }
-        module_name = PyUnicode_FromString(module_name_str);
-        if (unlikely(!module_name)) { goto modbad; }
-        module_dot = PyUnicode_Concat(module_name, __pyx_kp_u__2);
-        if (unlikely(!module_dot)) { goto modbad; }
-        full_name = PyUnicode_Concat(module_dot, name);
-        if (unlikely(!full_name)) { goto modbad; }
-        #if PY_VERSION_HEX < 0x030700A1 || (CYTHON_COMPILING_IN_PYPY && PYPY_VERSION_NUM  < 0x07030400)
-        {
-            PyObject *modules = PyImport_GetModuleDict();
-            if (unlikely(!modules))
-                goto modbad;
-            value = PyObject_GetItem(modules, full_name);
-        }
-        #else
-        value = PyImport_GetModule(full_name);
-        #endif
-      modbad:
-        Py_XDECREF(full_name);
-        Py_XDECREF(module_dot);
-        Py_XDECREF(module_name);
-    }
-    if (unlikely(!value)) {
-        PyErr_Format(PyExc_ImportError,
-        #if PY_MAJOR_VERSION < 3
-            "cannot import name %.230s", PyString_AS_STRING(name));
-        #else
-            "cannot import name %S", name);
-        #endif
-    }
-    return value;
-}
-
 /* RaiseException */
 #if PY_MAJOR_VERSION < 3
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
     __Pyx_PyThreadState_declare
     CYTHON_UNUSED_VAR(cause);
     Py_XINCREF(type);
     if (!value || value == Py_None)
@@ -9140,43 +7402,69 @@
     }
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
-/* GetAttr */
-static CYTHON_INLINE PyObject *__Pyx_GetAttr(PyObject *o, PyObject *n) {
-#if CYTHON_USE_TYPE_SLOTS
-#if PY_MAJOR_VERSION >= 3
-    if (likely(PyUnicode_Check(n)))
+/* KeywordStringCheck */
+static int __Pyx_CheckKeywordStrings(
+    PyObject *kw,
+    const char* function_name,
+    int kw_allowed)
+{
+    PyObject* key = 0;
+    Py_ssize_t pos = 0;
+#if CYTHON_COMPILING_IN_PYPY
+    if (!kw_allowed && PyDict_Next(kw, &pos, &key, 0))
+        goto invalid_keyword;
+    return 1;
 #else
-    if (likely(PyString_Check(n)))
-#endif
-        return __Pyx_PyObject_GetAttrStr(o, n);
+    if (CYTHON_METH_FASTCALL && likely(PyTuple_Check(kw))) {
+        if (unlikely(PyTuple_GET_SIZE(kw) == 0))
+            return 1;
+        if (!kw_allowed) {
+            key = PyTuple_GET_ITEM(kw, 0);
+            goto invalid_keyword;
+        }
+#if PY_VERSION_HEX < 0x03090000
+        for (pos = 0; pos < PyTuple_GET_SIZE(kw); pos++) {
+            key = PyTuple_GET_ITEM(kw, pos);
+            if (unlikely(!PyUnicode_Check(key)))
+                goto invalid_keyword_type;
+        }
 #endif
-    return PyObject_GetAttr(o, n);
-}
-
-/* HasAttr */
-static CYTHON_INLINE int __Pyx_HasAttr(PyObject *o, PyObject *n) {
-    PyObject *r;
-    if (unlikely(!__Pyx_PyBaseString_Check(n))) {
-        PyErr_SetString(PyExc_TypeError,
-                        "hasattr(): attribute name must be string");
-        return -1;
-    }
-    r = __Pyx_GetAttr(o, n);
-    if (!r) {
-        PyErr_Clear();
-        return 0;
-    } else {
-        Py_DECREF(r);
         return 1;
     }
+    while (PyDict_Next(kw, &pos, &key, 0)) {
+        #if PY_MAJOR_VERSION < 3
+        if (unlikely(!PyString_Check(key)))
+        #endif
+            if (unlikely(!PyUnicode_Check(key)))
+                goto invalid_keyword_type;
+    }
+    if (!kw_allowed && unlikely(key))
+        goto invalid_keyword;
+    return 1;
+invalid_keyword_type:
+    PyErr_Format(PyExc_TypeError,
+        "%.200s() keywords must be strings", function_name);
+    return 0;
+#endif
+invalid_keyword:
+    #if PY_MAJOR_VERSION < 3
+    PyErr_Format(PyExc_TypeError,
+        "%.200s() got an unexpected keyword argument '%.200s'",
+        function_name, PyString_AsString(key));
+    #else
+    PyErr_Format(PyExc_TypeError,
+        "%s() got an unexpected keyword argument '%U'",
+        function_name, key);
+    #endif
+    return 0;
 }
 
 /* GetTopmostException */
 #if CYTHON_USE_EXC_INFO_STACK
 static _PyErr_StackItem *
 __Pyx_PyErr_GetTopmostException(PyThreadState *tstate)
 {
@@ -9374,14 +7662,357 @@
             PyType_Modified(type);
     }
 #endif
     return 0;
 }
 #endif
 
+/* PyFunctionFastCall */
+#if CYTHON_FAST_PYCALL && !CYTHON_VECTORCALL
+static PyObject* __Pyx_PyFunction_FastCallNoKw(PyCodeObject *co, PyObject **args, Py_ssize_t na,
+                                               PyObject *globals) {
+    PyFrameObject *f;
+    PyThreadState *tstate = __Pyx_PyThreadState_Current;
+    PyObject **fastlocals;
+    Py_ssize_t i;
+    PyObject *result;
+    assert(globals != NULL);
+    /* XXX Perhaps we should create a specialized
+       PyFrame_New() that doesn't take locals, but does
+       take builtins without sanity checking them.
+       */
+    assert(tstate != NULL);
+    f = PyFrame_New(tstate, co, globals, NULL);
+    if (f == NULL) {
+        return NULL;
+    }
+    fastlocals = __Pyx_PyFrame_GetLocalsplus(f);
+    for (i = 0; i < na; i++) {
+        Py_INCREF(*args);
+        fastlocals[i] = *args++;
+    }
+    result = PyEval_EvalFrameEx(f,0);
+    ++tstate->recursion_depth;
+    Py_DECREF(f);
+    --tstate->recursion_depth;
+    return result;
+}
+static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs) {
+    PyCodeObject *co = (PyCodeObject *)PyFunction_GET_CODE(func);
+    PyObject *globals = PyFunction_GET_GLOBALS(func);
+    PyObject *argdefs = PyFunction_GET_DEFAULTS(func);
+    PyObject *closure;
+#if PY_MAJOR_VERSION >= 3
+    PyObject *kwdefs;
+#endif
+    PyObject *kwtuple, **k;
+    PyObject **d;
+    Py_ssize_t nd;
+    Py_ssize_t nk;
+    PyObject *result;
+    assert(kwargs == NULL || PyDict_Check(kwargs));
+    nk = kwargs ? PyDict_Size(kwargs) : 0;
+    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object"))) {
+        return NULL;
+    }
+    if (
+#if PY_MAJOR_VERSION >= 3
+            co->co_kwonlyargcount == 0 &&
+#endif
+            likely(kwargs == NULL || nk == 0) &&
+            co->co_flags == (CO_OPTIMIZED | CO_NEWLOCALS | CO_NOFREE)) {
+        if (argdefs == NULL && co->co_argcount == nargs) {
+            result = __Pyx_PyFunction_FastCallNoKw(co, args, nargs, globals);
+            goto done;
+        }
+        else if (nargs == 0 && argdefs != NULL
+                 && co->co_argcount == Py_SIZE(argdefs)) {
+            /* function called with no arguments, but all parameters have
+               a default value: use default values as arguments .*/
+            args = &PyTuple_GET_ITEM(argdefs, 0);
+            result =__Pyx_PyFunction_FastCallNoKw(co, args, Py_SIZE(argdefs), globals);
+            goto done;
+        }
+    }
+    if (kwargs != NULL) {
+        Py_ssize_t pos, i;
+        kwtuple = PyTuple_New(2 * nk);
+        if (kwtuple == NULL) {
+            result = NULL;
+            goto done;
+        }
+        k = &PyTuple_GET_ITEM(kwtuple, 0);
+        pos = i = 0;
+        while (PyDict_Next(kwargs, &pos, &k[i], &k[i+1])) {
+            Py_INCREF(k[i]);
+            Py_INCREF(k[i+1]);
+            i += 2;
+        }
+        nk = i / 2;
+    }
+    else {
+        kwtuple = NULL;
+        k = NULL;
+    }
+    closure = PyFunction_GET_CLOSURE(func);
+#if PY_MAJOR_VERSION >= 3
+    kwdefs = PyFunction_GET_KW_DEFAULTS(func);
+#endif
+    if (argdefs != NULL) {
+        d = &PyTuple_GET_ITEM(argdefs, 0);
+        nd = Py_SIZE(argdefs);
+    }
+    else {
+        d = NULL;
+        nd = 0;
+    }
+#if PY_MAJOR_VERSION >= 3
+    result = PyEval_EvalCodeEx((PyObject*)co, globals, (PyObject *)NULL,
+                               args, (int)nargs,
+                               k, (int)nk,
+                               d, (int)nd, kwdefs, closure);
+#else
+    result = PyEval_EvalCodeEx(co, globals, (PyObject *)NULL,
+                               args, (int)nargs,
+                               k, (int)nk,
+                               d, (int)nd, closure);
+#endif
+    Py_XDECREF(kwtuple);
+done:
+    Py_LeaveRecursiveCall();
+    return result;
+}
+#endif
+
+/* PyObjectCallMethO */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg) {
+    PyObject *self, *result;
+    PyCFunction cfunc;
+    cfunc = PyCFunction_GET_FUNCTION(func);
+    self = PyCFunction_GET_SELF(func);
+    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
+        return NULL;
+    result = cfunc(self, arg);
+    Py_LeaveRecursiveCall();
+    if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
+        PyErr_SetString(
+            PyExc_SystemError,
+            "NULL result without error in PyObject_Call");
+    }
+    return result;
+}
+#endif
+
+/* PyObjectFastCall */
+static PyObject* __Pyx_PyObject_FastCall_fallback(PyObject *func, PyObject **args, size_t nargs, PyObject *kwargs) {
+    PyObject *argstuple;
+    PyObject *result;
+    size_t i;
+    argstuple = PyTuple_New((Py_ssize_t)nargs);
+    if (unlikely(!argstuple)) return NULL;
+    for (i = 0; i < nargs; i++) {
+        Py_INCREF(args[i]);
+        PyTuple_SET_ITEM(argstuple, (Py_ssize_t)i, args[i]);
+    }
+    result = __Pyx_PyObject_Call(func, argstuple, kwargs);
+    Py_DECREF(argstuple);
+    return result;
+}
+static CYTHON_INLINE PyObject* __Pyx_PyObject_FastCallDict(PyObject *func, PyObject **args, size_t _nargs, PyObject *kwargs) {
+    Py_ssize_t nargs = __Pyx_PyVectorcall_NARGS(_nargs);
+#if CYTHON_COMPILING_IN_CPYTHON
+    if (nargs == 0 && kwargs == NULL) {
+#ifdef __Pyx_CyFunction_USED
+        if (__Pyx_IsCyOrPyCFunction(func))
+#else
+        if (PyCFunction_Check(func))
+#endif
+        {
+            if (likely(PyCFunction_GET_FLAGS(func) & METH_NOARGS)) {
+                return __Pyx_PyObject_CallMethO(func, NULL);
+            }
+        }
+    }
+    else if (nargs == 1 && kwargs == NULL) {
+        if (PyCFunction_Check(func))
+        {
+            if (likely(PyCFunction_GET_FLAGS(func) & METH_O)) {
+                return __Pyx_PyObject_CallMethO(func, args[0]);
+            }
+        }
+    }
+#endif
+    #if PY_VERSION_HEX < 0x030800B1
+    #if CYTHON_FAST_PYCCALL
+    if (PyCFunction_Check(func)) {
+        if (kwargs) {
+            return _PyCFunction_FastCallDict(func, args, nargs, kwargs);
+        } else {
+            return _PyCFunction_FastCallKeywords(func, args, nargs, NULL);
+        }
+    }
+    #if PY_VERSION_HEX >= 0x030700A1
+    if (!kwargs && __Pyx_IS_TYPE(func, &PyMethodDescr_Type)) {
+        return _PyMethodDescr_FastCallKeywords(func, args, nargs, NULL);
+    }
+    #endif
+    #endif
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(func)) {
+        return __Pyx_PyFunction_FastCallDict(func, args, nargs, kwargs);
+    }
+    #endif
+    #endif
+    #if CYTHON_VECTORCALL
+    vectorcallfunc f = _PyVectorcall_Function(func);
+    if (f) {
+        return f(func, args, (size_t)nargs, kwargs);
+    }
+    #elif defined(__Pyx_CyFunction_USED) && CYTHON_BACKPORT_VECTORCALL
+    if (__Pyx_CyFunction_CheckExact(func)) {
+        __pyx_vectorcallfunc f = __Pyx_CyFunction_func_vectorcall(func);
+        if (f) return f(func, args, (size_t)nargs, kwargs);
+    }
+    #endif
+    if (nargs == 0) {
+        return __Pyx_PyObject_Call(func, __pyx_empty_tuple, kwargs);
+    }
+    return __Pyx_PyObject_FastCall_fallback(func, args, (size_t)nargs, kwargs);
+}
+
+/* PyObjectCallNoArg */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func) {
+    PyObject *arg = NULL;
+    return __Pyx_PyObject_FastCall(func, (&arg)+1, 0 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
+}
+
+/* PyObjectCallOneArg */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg) {
+    PyObject *args[2] = {NULL, arg};
+    return __Pyx_PyObject_FastCall(func, args+1, 1 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
+}
+
+/* PyObjectGetMethod */
+static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method) {
+    PyObject *attr;
+#if CYTHON_UNPACK_METHODS && CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_PYTYPE_LOOKUP
+    __Pyx_TypeName type_name;
+    PyTypeObject *tp = Py_TYPE(obj);
+    PyObject *descr;
+    descrgetfunc f = NULL;
+    PyObject **dictptr, *dict;
+    int meth_found = 0;
+    assert (*method == NULL);
+    if (unlikely(tp->tp_getattro != PyObject_GenericGetAttr)) {
+        attr = __Pyx_PyObject_GetAttrStr(obj, name);
+        goto try_unpack;
+    }
+    if (unlikely(tp->tp_dict == NULL) && unlikely(PyType_Ready(tp) < 0)) {
+        return 0;
+    }
+    descr = _PyType_Lookup(tp, name);
+    if (likely(descr != NULL)) {
+        Py_INCREF(descr);
+#if defined(Py_TPFLAGS_METHOD_DESCRIPTOR) && Py_TPFLAGS_METHOD_DESCRIPTOR
+        if (__Pyx_PyType_HasFeature(Py_TYPE(descr), Py_TPFLAGS_METHOD_DESCRIPTOR))
+#elif PY_MAJOR_VERSION >= 3
+        #ifdef __Pyx_CyFunction_USED
+        if (likely(PyFunction_Check(descr) || __Pyx_IS_TYPE(descr, &PyMethodDescr_Type) || __Pyx_CyFunction_Check(descr)))
+        #else
+        if (likely(PyFunction_Check(descr) || __Pyx_IS_TYPE(descr, &PyMethodDescr_Type)))
+        #endif
+#else
+        #ifdef __Pyx_CyFunction_USED
+        if (likely(PyFunction_Check(descr) || __Pyx_CyFunction_Check(descr)))
+        #else
+        if (likely(PyFunction_Check(descr)))
+        #endif
+#endif
+        {
+            meth_found = 1;
+        } else {
+            f = Py_TYPE(descr)->tp_descr_get;
+            if (f != NULL && PyDescr_IsData(descr)) {
+                attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
+                Py_DECREF(descr);
+                goto try_unpack;
+            }
+        }
+    }
+    dictptr = _PyObject_GetDictPtr(obj);
+    if (dictptr != NULL && (dict = *dictptr) != NULL) {
+        Py_INCREF(dict);
+        attr = __Pyx_PyDict_GetItemStr(dict, name);
+        if (attr != NULL) {
+            Py_INCREF(attr);
+            Py_DECREF(dict);
+            Py_XDECREF(descr);
+            goto try_unpack;
+        }
+        Py_DECREF(dict);
+    }
+    if (meth_found) {
+        *method = descr;
+        return 1;
+    }
+    if (f != NULL) {
+        attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
+        Py_DECREF(descr);
+        goto try_unpack;
+    }
+    if (likely(descr != NULL)) {
+        *method = descr;
+        return 0;
+    }
+    type_name = __Pyx_PyType_GetName(tp);
+    PyErr_Format(PyExc_AttributeError,
+#if PY_MAJOR_VERSION >= 3
+                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%U'",
+                 type_name, name);
+#else
+                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%.400s'",
+                 type_name, PyString_AS_STRING(name));
+#endif
+    __Pyx_DECREF_TypeName(type_name);
+    return 0;
+#else
+    attr = __Pyx_PyObject_GetAttrStr(obj, name);
+    goto try_unpack;
+#endif
+try_unpack:
+#if CYTHON_UNPACK_METHODS
+    if (likely(attr) && PyMethod_Check(attr) && likely(PyMethod_GET_SELF(attr) == obj)) {
+        PyObject *function = PyMethod_GET_FUNCTION(attr);
+        Py_INCREF(function);
+        Py_DECREF(attr);
+        *method = function;
+        return 1;
+    }
+#endif
+    *method = attr;
+    return 0;
+}
+
+/* PyObjectCallMethod0 */
+static PyObject* __Pyx_PyObject_CallMethod0(PyObject* obj, PyObject* method_name) {
+    PyObject *method = NULL, *result = NULL;
+    int is_method = __Pyx_PyObject_GetMethod(obj, method_name, &method);
+    if (likely(is_method)) {
+        result = __Pyx_PyObject_CallOneArg(method, obj);
+        Py_DECREF(method);
+        return result;
+    }
+    if (unlikely(!method)) goto bad;
+    result = __Pyx_PyObject_CallNoArg(method);
+    Py_DECREF(method);
+bad:
+    return result;
+}
+
 /* ValidateBasesTuple */
 #if CYTHON_COMPILING_IN_CPYTHON || CYTHON_COMPILING_IN_LIMITED_API || CYTHON_USE_TYPE_SPECS
 static int __Pyx_validate_bases_tuple(const char *type_name, Py_ssize_t dictoffset, PyObject *bases) {
     Py_ssize_t i, n = PyTuple_GET_SIZE(bases);
     for (i = 1; i < n; i++)
     {
         PyObject *b0 = PyTuple_GET_ITEM(bases, i);
@@ -9790,14 +8421,82 @@
     return (PyTypeObject *)result;
 bad:
     Py_XDECREF(result);
     return NULL;
 }
 #endif
 
+/* Import */
+static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
+    PyObject *module = 0;
+    PyObject *empty_dict = 0;
+    PyObject *empty_list = 0;
+    #if PY_MAJOR_VERSION < 3
+    PyObject *py_import;
+    py_import = __Pyx_PyObject_GetAttrStr(__pyx_b, __pyx_n_s_import);
+    if (unlikely(!py_import))
+        goto bad;
+    if (!from_list) {
+        empty_list = PyList_New(0);
+        if (unlikely(!empty_list))
+            goto bad;
+        from_list = empty_list;
+    }
+    #endif
+    empty_dict = PyDict_New();
+    if (unlikely(!empty_dict))
+        goto bad;
+    {
+        #if PY_MAJOR_VERSION >= 3
+        if (level == -1) {
+            if ((1) && (strchr(__Pyx_MODULE_NAME, '.'))) {
+                #if CYTHON_COMPILING_IN_LIMITED_API
+                module = PyImport_ImportModuleLevelObject(
+                    name, empty_dict, empty_dict, from_list, 1);
+                #else
+                module = PyImport_ImportModuleLevelObject(
+                    name, __pyx_d, empty_dict, from_list, 1);
+                #endif
+                if (unlikely(!module)) {
+                    if (unlikely(!PyErr_ExceptionMatches(PyExc_ImportError)))
+                        goto bad;
+                    PyErr_Clear();
+                }
+            }
+            level = 0;
+        }
+        #endif
+        if (!module) {
+            #if PY_MAJOR_VERSION < 3
+            PyObject *py_level = PyInt_FromLong(level);
+            if (unlikely(!py_level))
+                goto bad;
+            module = PyObject_CallFunctionObjArgs(py_import,
+                name, __pyx_d, empty_dict, from_list, py_level, (PyObject *)NULL);
+            Py_DECREF(py_level);
+            #else
+            #if CYTHON_COMPILING_IN_LIMITED_API
+            module = PyImport_ImportModuleLevelObject(
+                name, empty_dict, empty_dict, from_list, level);
+            #else
+            module = PyImport_ImportModuleLevelObject(
+                name, __pyx_d, empty_dict, from_list, level);
+            #endif
+            #endif
+        }
+    }
+bad:
+    Py_XDECREF(empty_dict);
+    Py_XDECREF(empty_list);
+    #if PY_MAJOR_VERSION < 3
+    Py_XDECREF(py_import);
+    #endif
+    return module;
+}
+
 /* ImportDottedModule */
 #if PY_MAJOR_VERSION >= 3
 static PyObject *__Pyx__ImportDottedModule_Error(PyObject *name, PyObject *parts_tuple, Py_ssize_t count) {
     PyObject *partial_name = NULL, *slice = NULL, *sep = NULL;
     if (unlikely(PyErr_Occurred())) {
         PyErr_Clear();
     }
@@ -9844,15 +8543,15 @@
     imported_module = PyImport_GetModule(name);
 #endif
     return imported_module;
 }
 #endif
 static PyObject *__Pyx__ImportDottedModule(PyObject *name, PyObject *parts_tuple) {
 #if PY_MAJOR_VERSION < 3
-    PyObject *module, *from_list, *star = __pyx_n_s__5;
+    PyObject *module, *from_list, *star = __pyx_n_s__4;
     CYTHON_UNUSED_VAR(parts_tuple);
     from_list = PyList_New(1);
     if (unlikely(!from_list))
         return NULL;
     Py_INCREF(star);
     PyList_SET_ITEM(from_list, 0, star);
     module = __Pyx_Import(name, from_list, 0);
@@ -11175,36 +9874,14 @@
     PyTraceBack_Here(py_frame);
 bad:
     Py_XDECREF(py_code);
     Py_XDECREF(py_frame);
 }
 #endif
 
-/* CIntFromPyVerify */
-#define __PYX_VERIFY_RETURN_INT(target_type, func_type, func_value)\
-    __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 0)
-#define __PYX_VERIFY_RETURN_INT_EXC(target_type, func_type, func_value)\
-    __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 1)
-#define __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, exc)\
-    {\
-        func_type value = func_value;\
-        if (sizeof(target_type) < sizeof(func_type)) {\
-            if (unlikely(value != (func_type) (target_type) value)) {\
-                func_type zero = 0;\
-                if (exc && unlikely(value == (func_type)-1 && PyErr_Occurred()))\
-                    return (target_type) -1;\
-                if (is_unsigned && unlikely(value < zero))\
-                    goto raise_neg_overflow;\
-                else\
-                    goto raise_overflow;\
-            }\
-        }\
-        return (target_type) value;\
-    }
-
 /* Declarations */
 #if CYTHON_CCOMPLEX
   #ifdef __cplusplus
     static CYTHON_INLINE __pyx_t_float_complex __pyx_t_float_complex_from_parts(float x, float y) {
       return ::std::complex< float >(x, y);
     }
   #else
@@ -11505,171 +10182,246 @@
             z.real = z_r * cos(z_theta);
             z.imag = z_r * sin(z_theta);
             return z;
         }
     #endif
 #endif
 
+/* FormatTypeName */
+#if CYTHON_COMPILING_IN_LIMITED_API
+static __Pyx_TypeName
+__Pyx_PyType_GetName(PyTypeObject* tp)
+{
+    PyObject *name = __Pyx_PyObject_GetAttrStr((PyObject *)tp,
+                                               __pyx_n_s_name);
+    if (unlikely(name == NULL) || unlikely(!PyUnicode_Check(name))) {
+        PyErr_Clear();
+        Py_XSETREF(name, __Pyx_NewRef(__pyx_n_s__11));
+    }
+    return name;
+}
+#endif
+
+/* CIntToPy */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const long neg_one = (long) -1, const_zero = (long) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
+    const int is_unsigned = neg_one > const_zero;
+    if (is_unsigned) {
+        if (sizeof(long) < sizeof(long)) {
+            return PyInt_FromLong((long) value);
+        } else if (sizeof(long) <= sizeof(unsigned long)) {
+            return PyLong_FromUnsignedLong((unsigned long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
+            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
+#endif
+        }
+    } else {
+        if (sizeof(long) <= sizeof(long)) {
+            return PyInt_FromLong((long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
+            return PyLong_FromLongLong((PY_LONG_LONG) value);
+#endif
+        }
+    }
+    {
+        int one = 1; int little = (int)*(unsigned char *)&one;
+        unsigned char *bytes = (unsigned char *)&value;
+        return _PyLong_FromByteArray(bytes, sizeof(long),
+                                     little, !is_unsigned);
+    }
+}
+
+/* CIntFromPyVerify */
+#define __PYX_VERIFY_RETURN_INT(target_type, func_type, func_value)\
+    __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 0)
+#define __PYX_VERIFY_RETURN_INT_EXC(target_type, func_type, func_value)\
+    __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 1)
+#define __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, exc)\
+    {\
+        func_type value = func_value;\
+        if (sizeof(target_type) < sizeof(func_type)) {\
+            if (unlikely(value != (func_type) (target_type) value)) {\
+                func_type zero = 0;\
+                if (exc && unlikely(value == (func_type)-1 && PyErr_Occurred()))\
+                    return (target_type) -1;\
+                if (is_unsigned && unlikely(value < zero))\
+                    goto raise_neg_overflow;\
+                else\
+                    goto raise_overflow;\
+            }\
+        }\
+        return (target_type) value;\
+    }
+
 /* CIntFromPy */
-static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *x) {
+static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic push
 #pragma GCC diagnostic ignored "-Wconversion"
 #endif
-    const int neg_one = (int) -1, const_zero = (int) 0;
+    const long neg_one = (long) -1, const_zero = (long) 0;
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic pop
 #endif
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
-        if ((sizeof(int) < sizeof(long))) {
-            __PYX_VERIFY_RETURN_INT(int, long, PyInt_AS_LONG(x))
+        if ((sizeof(long) < sizeof(long))) {
+            __PYX_VERIFY_RETURN_INT(long, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
             if (is_unsigned && unlikely(val < 0)) {
                 goto raise_neg_overflow;
             }
-            return (int) val;
+            return (long) val;
         }
     } else
 #endif
     if (likely(PyLong_Check(x))) {
         if (is_unsigned) {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (int) 0;
-                case  1: __PYX_VERIFY_RETURN_INT(int, digit, digits[0])
+                case  0: return (long) 0;
+                case  1: __PYX_VERIFY_RETURN_INT(long, digit, digits[0])
                 case 2:
-                    if ((8 * sizeof(int) > 1 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) > 1 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 2 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) >= 2 * PyLong_SHIFT)) {
-                            return (int) (((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) >= 2 * PyLong_SHIFT)) {
+                            return (long) (((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
                 case 3:
-                    if ((8 * sizeof(int) > 2 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) > 2 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 3 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) >= 3 * PyLong_SHIFT)) {
-                            return (int) (((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) >= 3 * PyLong_SHIFT)) {
+                            return (long) (((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
                 case 4:
-                    if ((8 * sizeof(int) > 3 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) > 3 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 4 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) >= 4 * PyLong_SHIFT)) {
-                            return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) >= 4 * PyLong_SHIFT)) {
+                            return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
             }
 #endif
 #if CYTHON_COMPILING_IN_CPYTHON
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
-                    return (int) -1;
+                    return (long) -1;
                 if (unlikely(result == 1))
                     goto raise_neg_overflow;
             }
 #endif
-            if ((sizeof(int) <= sizeof(unsigned long))) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned long, PyLong_AsUnsignedLong(x))
+            if ((sizeof(long) <= sizeof(unsigned long))) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned long, PyLong_AsUnsignedLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if ((sizeof(int) <= sizeof(unsigned PY_LONG_LONG))) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
+            } else if ((sizeof(long) <= sizeof(unsigned PY_LONG_LONG))) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
 #endif
             }
         } else {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (int) 0;
-                case -1: __PYX_VERIFY_RETURN_INT(int, sdigit, (sdigit) (-(sdigit)digits[0]))
-                case  1: __PYX_VERIFY_RETURN_INT(int,  digit, +digits[0])
+                case  0: return (long) 0;
+                case -1: __PYX_VERIFY_RETURN_INT(long, sdigit, (sdigit) (-(sdigit)digits[0]))
+                case  1: __PYX_VERIFY_RETURN_INT(long,  digit, +digits[0])
                 case -2:
-                    if ((8 * sizeof(int) - 1 > 1 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) - 1 > 1 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 2 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) - 1 > 2 * PyLong_SHIFT)) {
-                            return (int) (((int)-1)*(((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) - 1 > 2 * PyLong_SHIFT)) {
+                            return (long) (((long)-1)*(((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case 2:
-                    if ((8 * sizeof(int) > 1 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) > 1 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 2 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) - 1 > 2 * PyLong_SHIFT)) {
-                            return (int) ((((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) - 1 > 2 * PyLong_SHIFT)) {
+                            return (long) ((((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case -3:
-                    if ((8 * sizeof(int) - 1 > 2 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) - 1 > 2 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 3 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) - 1 > 3 * PyLong_SHIFT)) {
-                            return (int) (((int)-1)*(((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) - 1 > 3 * PyLong_SHIFT)) {
+                            return (long) (((long)-1)*(((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case 3:
-                    if ((8 * sizeof(int) > 2 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) > 2 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 3 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) - 1 > 3 * PyLong_SHIFT)) {
-                            return (int) ((((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) - 1 > 3 * PyLong_SHIFT)) {
+                            return (long) ((((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case -4:
-                    if ((8 * sizeof(int) - 1 > 3 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) - 1 > 3 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 4 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) - 1 > 4 * PyLong_SHIFT)) {
-                            return (int) (((int)-1)*(((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) - 1 > 4 * PyLong_SHIFT)) {
+                            return (long) (((long)-1)*(((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case 4:
-                    if ((8 * sizeof(int) > 3 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(long) > 3 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 4 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(int) - 1 > 4 * PyLong_SHIFT)) {
-                            return (int) ((((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(long) - 1 > 4 * PyLong_SHIFT)) {
+                            return (long) ((((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
             }
 #endif
-            if ((sizeof(int) <= sizeof(long))) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, long, PyLong_AsLong(x))
+            if ((sizeof(long) <= sizeof(long))) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, long, PyLong_AsLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if ((sizeof(int) <= sizeof(PY_LONG_LONG))) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, PY_LONG_LONG, PyLong_AsLongLong(x))
+            } else if ((sizeof(long) <= sizeof(PY_LONG_LONG))) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, PY_LONG_LONG, PyLong_AsLongLong(x))
 #endif
             }
         }
         {
 #if (CYTHON_COMPILING_IN_PYPY || CYTHON_COMPILING_IN_LIMITED_API) && !defined(_PyLong_AsByteArray)
             PyErr_SetString(PyExc_RuntimeError,
                             "_PyLong_AsByteArray() not available, cannot convert large numbers");
 #else
-            int val;
+            long val;
             PyObject *v = __Pyx_PyNumber_IntOrLong(x);
  #if PY_MAJOR_VERSION < 3
             if (likely(v) && !PyLong_Check(v)) {
                 PyObject *tmp = v;
                 v = PyNumber_Long(tmp);
                 Py_DECREF(tmp);
             }
@@ -11681,191 +10433,191 @@
                                               bytes, sizeof(val),
                                               is_little, !is_unsigned);
                 Py_DECREF(v);
                 if (likely(!ret))
                     return val;
             }
 #endif
-            return (int) -1;
+            return (long) -1;
         }
     } else {
-        int val;
+        long val;
         PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
-        if (!tmp) return (int) -1;
-        val = __Pyx_PyInt_As_int(tmp);
+        if (!tmp) return (long) -1;
+        val = __Pyx_PyInt_As_long(tmp);
         Py_DECREF(tmp);
         return val;
     }
 raise_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "value too large to convert to int");
-    return (int) -1;
+        "value too large to convert to long");
+    return (long) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "can't convert negative value to int");
-    return (int) -1;
+        "can't convert negative value to long");
+    return (long) -1;
 }
 
 /* CIntFromPy */
-static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
+static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *x) {
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic push
 #pragma GCC diagnostic ignored "-Wconversion"
 #endif
-    const long neg_one = (long) -1, const_zero = (long) 0;
+    const int neg_one = (int) -1, const_zero = (int) 0;
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic pop
 #endif
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
-        if ((sizeof(long) < sizeof(long))) {
-            __PYX_VERIFY_RETURN_INT(long, long, PyInt_AS_LONG(x))
+        if ((sizeof(int) < sizeof(long))) {
+            __PYX_VERIFY_RETURN_INT(int, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
             if (is_unsigned && unlikely(val < 0)) {
                 goto raise_neg_overflow;
             }
-            return (long) val;
+            return (int) val;
         }
     } else
 #endif
     if (likely(PyLong_Check(x))) {
         if (is_unsigned) {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (long) 0;
-                case  1: __PYX_VERIFY_RETURN_INT(long, digit, digits[0])
+                case  0: return (int) 0;
+                case  1: __PYX_VERIFY_RETURN_INT(int, digit, digits[0])
                 case 2:
-                    if ((8 * sizeof(long) > 1 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) > 1 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 2 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) >= 2 * PyLong_SHIFT)) {
-                            return (long) (((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) >= 2 * PyLong_SHIFT)) {
+                            return (int) (((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
                 case 3:
-                    if ((8 * sizeof(long) > 2 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) > 2 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 3 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) >= 3 * PyLong_SHIFT)) {
-                            return (long) (((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) >= 3 * PyLong_SHIFT)) {
+                            return (int) (((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
                 case 4:
-                    if ((8 * sizeof(long) > 3 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) > 3 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 4 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) >= 4 * PyLong_SHIFT)) {
-                            return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) >= 4 * PyLong_SHIFT)) {
+                            return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
             }
 #endif
 #if CYTHON_COMPILING_IN_CPYTHON
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
-                    return (long) -1;
+                    return (int) -1;
                 if (unlikely(result == 1))
                     goto raise_neg_overflow;
             }
 #endif
-            if ((sizeof(long) <= sizeof(unsigned long))) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned long, PyLong_AsUnsignedLong(x))
+            if ((sizeof(int) <= sizeof(unsigned long))) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned long, PyLong_AsUnsignedLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if ((sizeof(long) <= sizeof(unsigned PY_LONG_LONG))) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
+            } else if ((sizeof(int) <= sizeof(unsigned PY_LONG_LONG))) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
 #endif
             }
         } else {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (long) 0;
-                case -1: __PYX_VERIFY_RETURN_INT(long, sdigit, (sdigit) (-(sdigit)digits[0]))
-                case  1: __PYX_VERIFY_RETURN_INT(long,  digit, +digits[0])
+                case  0: return (int) 0;
+                case -1: __PYX_VERIFY_RETURN_INT(int, sdigit, (sdigit) (-(sdigit)digits[0]))
+                case  1: __PYX_VERIFY_RETURN_INT(int,  digit, +digits[0])
                 case -2:
-                    if ((8 * sizeof(long) - 1 > 1 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) - 1 > 1 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 2 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) - 1 > 2 * PyLong_SHIFT)) {
-                            return (long) (((long)-1)*(((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) - 1 > 2 * PyLong_SHIFT)) {
+                            return (int) (((int)-1)*(((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case 2:
-                    if ((8 * sizeof(long) > 1 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) > 1 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 2 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) - 1 > 2 * PyLong_SHIFT)) {
-                            return (long) ((((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) - 1 > 2 * PyLong_SHIFT)) {
+                            return (int) ((((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case -3:
-                    if ((8 * sizeof(long) - 1 > 2 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) - 1 > 2 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 3 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) - 1 > 3 * PyLong_SHIFT)) {
-                            return (long) (((long)-1)*(((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) - 1 > 3 * PyLong_SHIFT)) {
+                            return (int) (((int)-1)*(((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case 3:
-                    if ((8 * sizeof(long) > 2 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) > 2 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 3 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) - 1 > 3 * PyLong_SHIFT)) {
-                            return (long) ((((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) - 1 > 3 * PyLong_SHIFT)) {
+                            return (int) ((((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case -4:
-                    if ((8 * sizeof(long) - 1 > 3 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) - 1 > 3 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 4 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) - 1 > 4 * PyLong_SHIFT)) {
-                            return (long) (((long)-1)*(((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) - 1 > 4 * PyLong_SHIFT)) {
+                            return (int) (((int)-1)*(((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case 4:
-                    if ((8 * sizeof(long) > 3 * PyLong_SHIFT)) {
+                    if ((8 * sizeof(int) > 3 * PyLong_SHIFT)) {
                         if ((8 * sizeof(unsigned long) > 4 * PyLong_SHIFT)) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if ((8 * sizeof(long) - 1 > 4 * PyLong_SHIFT)) {
-                            return (long) ((((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if ((8 * sizeof(int) - 1 > 4 * PyLong_SHIFT)) {
+                            return (int) ((((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
             }
 #endif
-            if ((sizeof(long) <= sizeof(long))) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, long, PyLong_AsLong(x))
+            if ((sizeof(int) <= sizeof(long))) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, long, PyLong_AsLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if ((sizeof(long) <= sizeof(PY_LONG_LONG))) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, PY_LONG_LONG, PyLong_AsLongLong(x))
+            } else if ((sizeof(int) <= sizeof(PY_LONG_LONG))) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, PY_LONG_LONG, PyLong_AsLongLong(x))
 #endif
             }
         }
         {
 #if (CYTHON_COMPILING_IN_PYPY || CYTHON_COMPILING_IN_LIMITED_API) && !defined(_PyLong_AsByteArray)
             PyErr_SetString(PyExc_RuntimeError,
                             "_PyLong_AsByteArray() not available, cannot convert large numbers");
 #else
-            long val;
+            int val;
             PyObject *v = __Pyx_PyNumber_IntOrLong(x);
  #if PY_MAJOR_VERSION < 3
             if (likely(v) && !PyLong_Check(v)) {
                 PyObject *tmp = v;
                 v = PyNumber_Long(tmp);
                 Py_DECREF(tmp);
             }
@@ -11877,86 +10629,33 @@
                                               bytes, sizeof(val),
                                               is_little, !is_unsigned);
                 Py_DECREF(v);
                 if (likely(!ret))
                     return val;
             }
 #endif
-            return (long) -1;
+            return (int) -1;
         }
     } else {
-        long val;
+        int val;
         PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
-        if (!tmp) return (long) -1;
-        val = __Pyx_PyInt_As_long(tmp);
+        if (!tmp) return (int) -1;
+        val = __Pyx_PyInt_As_int(tmp);
         Py_DECREF(tmp);
         return val;
     }
 raise_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "value too large to convert to long");
-    return (long) -1;
+        "value too large to convert to int");
+    return (int) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "can't convert negative value to long");
-    return (long) -1;
-}
-
-/* CIntToPy */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
-#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
-#pragma GCC diagnostic push
-#pragma GCC diagnostic ignored "-Wconversion"
-#endif
-    const long neg_one = (long) -1, const_zero = (long) 0;
-#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
-#pragma GCC diagnostic pop
-#endif
-    const int is_unsigned = neg_one > const_zero;
-    if (is_unsigned) {
-        if (sizeof(long) < sizeof(long)) {
-            return PyInt_FromLong((long) value);
-        } else if (sizeof(long) <= sizeof(unsigned long)) {
-            return PyLong_FromUnsignedLong((unsigned long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
-            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
-#endif
-        }
-    } else {
-        if (sizeof(long) <= sizeof(long)) {
-            return PyInt_FromLong((long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
-            return PyLong_FromLongLong((PY_LONG_LONG) value);
-#endif
-        }
-    }
-    {
-        int one = 1; int little = (int)*(unsigned char *)&one;
-        unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(long),
-                                     little, !is_unsigned);
-    }
-}
-
-/* FormatTypeName */
-#if CYTHON_COMPILING_IN_LIMITED_API
-static __Pyx_TypeName
-__Pyx_PyType_GetName(PyTypeObject* tp)
-{
-    PyObject *name = __Pyx_PyObject_GetAttrStr((PyObject *)tp,
-                                               __pyx_n_s_name);
-    if (unlikely(name == NULL) || unlikely(!PyUnicode_Check(name))) {
-        PyErr_Clear();
-        Py_XSETREF(name, __Pyx_NewRef(__pyx_n_s__12));
-    }
-    return name;
+        "can't convert negative value to int");
+    return (int) -1;
 }
-#endif
 
 /* FastTypeChecks */
 #if CYTHON_COMPILING_IN_CPYTHON
 static int __Pyx_InBases(PyTypeObject *a, PyTypeObject *b) {
     while (a) {
         a = __Pyx_PyType_GetSlot(a, tp_base, PyTypeObject*);
         if (a == b)
```

### Comparing `druhg-1.3.0/druhg/_druhg_label.c` & `druhg-1.4.0/druhg/_druhg_label.c`

 * *Files 10% similar despite different names*

```diff
@@ -953,14 +953,15 @@
     /* Using NumPy API declarations from "numpy/__init__.cython-30.pxd" */
     
 #include "numpy/arrayobject.h"
 #include "numpy/ndarrayobject.h"
 #include "numpy/ndarraytypes.h"
 #include "numpy/arrayscalars.h"
 #include "numpy/ufuncobject.h"
+#include <math.h>
 #ifdef _OPENMP
 #include <omp.h>
 #endif /* _OPENMP */
 
 #if defined(PYREX_WITHOUT_ASSERTIONS) && !defined(CYTHON_WITHOUT_ASSERTIONS)
 #define CYTHON_WITHOUT_ASSERTIONS
 #endif
@@ -1196,19 +1197,19 @@
   #undef _Complex_I
   #define _Complex_I 1.0fj
 #endif
 
 /* #### Code section: filename_table ### */
 
 static const char *__pyx_f[] = {
-  "<stringsource>",
   "druhg\\\\_druhg_label.pyx",
   "venv\\\\lib\\\\site-packages\\\\numpy\\\\__init__.cython-30.pxd",
   "venv\\\\lib\\\\site-packages\\\\Cython\\\\Includes\\\\cpython\\\\type.pxd",
-  "druhg\\\\_druhg_amalgamation.pxd",
+  "druhg\\\\_druhg_unionfind.pxd",
+  "druhg\\\\_druhg_group.pxd",
 };
 /* #### Code section: utility_code_proto_before_types ### */
 /* BufferFormatStructs.proto */
 #define IS_UNSIGNED(type) (((type) -1) > 0)
 struct __Pyx_StructField_;
 #define __PYX_BUF_FLAGS_PACKED_STRUCT (1 << 0)
 typedef struct {
@@ -1457,16 +1458,16 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 /* #### Code section: type_declarations ### */
 
 /*--- Type declarations ---*/
-struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation;
-struct __pyx_obj_5druhg_12_druhg_label_UnionFind;
+struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind;
+struct __pyx_obj_5druhg_12_druhg_group_Group;
 
 /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":771
  * ctypedef npy_longdouble longdouble_t
  * 
  * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t
@@ -1495,101 +1496,127 @@
  * ctypedef npy_clongdouble clongdouble_t
  * 
  * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  */
 typedef npy_cdouble __pyx_t_5numpy_complex_t;
+struct __pyx_opt_args_5druhg_12_druhg_label_emerge_clusters;
 struct __pyx_opt_args_5druhg_12_druhg_label_label;
 
-/* "druhg/_druhg_label.pyx":234
+/* "druhg/_druhg_label.pyx":86
+ *     return ret_labels
  * 
+ * cdef emerge_clusters(UnionFind U, np.ndarray values_arr, np.ndarray group_arr,             # <<<<<<<<<<<<<<
+ *                      list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                      np.ndarray ranks_arr = None):
+ */
+struct __pyx_opt_args_5druhg_12_druhg_label_emerge_clusters {
+  int __pyx_n;
+  PyObject *exclude;
+  __pyx_t_5numpy_intp_t limit1;
+  __pyx_t_5numpy_intp_t limit2;
+  PyArrayObject *ranks_arr;
+};
+
+/* "druhg/_druhg_label.pyx":137
+ *     return ret_clusters
  * 
- * cpdef np.ndarray label(np.ndarray edges_arr, np.ndarray values_arr, int size = 0, list exclude = None, \             # <<<<<<<<<<<<<<
- *                        np.intp_t limit1 = 0, np.intp_t limit2 = 0, np.intp_t fix_outliers = 1, is_reciprocal = 1):
- *     """Returns cluster labels.
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,             # <<<<<<<<<<<<<<
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
  */
 struct __pyx_opt_args_5druhg_12_druhg_label_label {
   int __pyx_n;
-  int size;
+  PyArrayObject *ranks_arr;
   PyObject *exclude;
   __pyx_t_5numpy_intp_t limit1;
   __pyx_t_5numpy_intp_t limit2;
   __pyx_t_5numpy_intp_t fix_outliers;
-  PyObject *is_reciprocal;
+  PyObject *edgepairs_arr;
+  PyObject *precision;
 };
 
-/* "_druhg_amalgamation.pxd":11
- * cimport numpy as np
+/* "_druhg_unionfind.pxd":16
+ * 
  * 
- * cdef class Amalgamation (object):             # <<<<<<<<<<<<<<
+ * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
  *     cdef:
- *         np.intp_t size
+ *         np.intp_t p_size
  */
-struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation {
+struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind {
   PyObject_HEAD
-  struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_vtab;
-  __pyx_t_5numpy_intp_t size;
-  __pyx_t_5numpy_intp_t clusters;
-  PyObject *energies;
+  struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *__pyx_vtab;
+  __pyx_t_5numpy_intp_t p_size;
+  PyArrayObject *parent_arr;
+  __pyx_t_5numpy_intp_t *parent;
+  PyArrayObject *fast_arr;
+  __pyx_t_5numpy_intp_t *fast;
+  __pyx_t_5numpy_intp_t next_label;
 };
 
 
-/* "druhg/_druhg_label.pyx":23
- * from ._druhg_amalgamation cimport Amalgamation
- * 
- * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
+/* "_druhg_group.pxd":22
+ * cdef bint group_is_cluster(group, np.double_t *emerged_quantity_quality, np.double_t border)
  * 
+ * cdef class Group (object):             # <<<<<<<<<<<<<<
  *     cdef:
+ *         data
  */
-struct __pyx_obj_5druhg_12_druhg_label_UnionFind {
+struct __pyx_obj_5druhg_12_druhg_group_Group {
   PyObject_HEAD
-  struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *__pyx_vtab;
-  PyArrayObject *parent_arr;
-  __pyx_t_5numpy_intp_t *parent;
-  __pyx_t_5numpy_intp_t next_label;
-  __pyx_t_5numpy_intp_t full_size;
+  struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *__pyx_vtab;
+  PyObject *data;
+  PyObject *_Group__data_length;
 };
 
 
 
-/* "_druhg_amalgamation.pxd":11
- * cimport numpy as np
+/* "_druhg_unionfind.pxd":16
+ * 
  * 
- * cdef class Amalgamation (object):             # <<<<<<<<<<<<<<
+ * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
  *     cdef:
- *         np.intp_t size
+ *         np.intp_t p_size
  */
 
-struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation {
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *(*merge_amalgamations)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, __pyx_t_5numpy_double_t);
-  __pyx_t_5numpy_double_t (*border_overcoming)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t);
-  __pyx_t_5numpy_double_t (*border_overcoming_rev)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t, struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_double_t);
-  void (*_amalgamate)(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, PyObject *);
+struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind {
+  __pyx_t_5numpy_intp_t (*nullify)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *);
+  __pyx_t_5numpy_intp_t (*mark_up)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t);
+  __pyx_t_5numpy_intp_t (*is_same_parent)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
+  void (*__pyx_union)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
 };
-static struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation;
+static struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *__pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind;
 
 
-/* "druhg/_druhg_label.pyx":23
- * from ._druhg_amalgamation cimport Amalgamation
- * 
- * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
+/* "_druhg_group.pxd":22
+ * cdef bint group_is_cluster(group, np.double_t *emerged_quantity_quality, np.double_t border)
  * 
+ * cdef class Group (object):             # <<<<<<<<<<<<<<
  *     cdef:
+ *         data
  */
 
-struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind {
-  __pyx_t_5numpy_intp_t (*has_parent)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t);
-  __pyx_t_5numpy_intp_t (*fast_find)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t);
-  __pyx_t_5numpy_intp_t (*passive_find)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t);
-  __pyx_t_5numpy_intp_t (*passive_union)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
-  PyObject *(*discard_clusters)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t, PyObject *);
-  __pyx_t_5numpy_intp_t (*label_find)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t, PyObject *);
+struct __pyx_vtabstruct_5druhg_12_druhg_group_Group {
+  PyObject *(*assume_data)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*size)(struct __pyx_obj_5druhg_12_druhg_group_Group *);
+  PyObject *(*amount)(struct __pyx_obj_5druhg_12_druhg_group_Group *);
+  PyObject *(*limit)(struct __pyx_obj_5druhg_12_druhg_group_Group *);
+  PyObject *(*add_1)(struct __pyx_obj_5druhg_12_druhg_group_Group *, __pyx_t_5numpy_double_t);
+  PyObject *(*aggregate)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*subtract)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*add_cluster)(struct __pyx_obj_5druhg_12_druhg_group_Group *, __pyx_t_5numpy_double_t, PyObject *);
+  PyObject *(*set_like)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*coords)(struct __pyx_obj_5druhg_12_druhg_group_Group *);
+  PyObject *(*set_coords)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*assume_data_coords)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*add_coords)(struct __pyx_obj_5druhg_12_druhg_group_Group *, PyObject *);
+  PyObject *(*add_cluster_coords)(struct __pyx_obj_5druhg_12_druhg_group_Group *, __pyx_t_5numpy_double_t, PyObject *);
 };
-static struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *__pyx_vtabptr_5druhg_12_druhg_label_UnionFind;
+static struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *__pyx_vtabptr_5druhg_12_druhg_group_Group;
 /* #### Code section: utility_code_proto ### */
 
 /* --- Runtime support code (head) --- */
 /* Refnanny.proto */
 #ifndef CYTHON_REFNANNY
   #define CYTHON_REFNANNY 0
 #endif
@@ -1771,22 +1798,14 @@
     PyObject *kwds2, PyObject *values[], Py_ssize_t num_pos_args,
     const char* function_name);
 
 /* RaiseArgTupleInvalid.proto */
 static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
     Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
 
-/* PyIntBinop.proto */
-#if !CYTHON_COMPILING_IN_PYPY
-static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check);
-#else
-#define __Pyx_PyInt_AddObjC(op1, op2, intval, inplace, zerodivision_check)\
-    (inplace ? PyNumber_InPlaceAdd(op1, op2) : PyNumber_Add(op1, op2))
-#endif
-
 /* PyDictVersioning.proto */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
 #define __PYX_DICT_VERSION_INIT  ((PY_UINT64_T) -1)
 #define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
 #define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
     (version_var) = __PYX_GET_DICT_VERSION(dict);\
     (cache_var) = (value);
@@ -1826,37 +1845,59 @@
 static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value);
 #else
 #define __Pyx_GetModuleGlobalName(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
 #define __Pyx_GetModuleGlobalNameUncached(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
 static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name);
 #endif
 
-/* PyIntBinop.proto */
-#if !CYTHON_COMPILING_IN_PYPY
-static PyObject* __Pyx_PyInt_MultiplyCObj(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check);
-#else
-#define __Pyx_PyInt_MultiplyCObj(op1, op2, intval, inplace, zerodivision_check)\
-    (inplace ? PyNumber_InPlaceMultiply(op1, op2) : PyNumber_Multiply(op1, op2))
-#endif
-
 /* PyObjectCall.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
 #else
 #define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
 #endif
 
-/* ExtTypeTest.proto */
-static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type);
+/* GetItemInt.proto */
+#define __Pyx_GetItemInt(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_GetItemInt_Fast(o, (Py_ssize_t)i, is_list, wraparound, boundscheck) :\
+    (is_list ? (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL) :\
+               __Pyx_GetItemInt_Generic(o, to_py_func(i))))
+#define __Pyx_GetItemInt_List(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_GetItemInt_List_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
+    (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL))
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
+                                                              int wraparound, int boundscheck);
+#define __Pyx_GetItemInt_Tuple(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_GetItemInt_Tuple_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
+    (PyErr_SetString(PyExc_IndexError, "tuple index out of range"), (PyObject*)NULL))
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
+                                                              int wraparound, int boundscheck);
+static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j);
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i,
+                                                     int is_list, int wraparound, int boundscheck);
 
-/* pyfrozenset_new.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyFrozenSet_New(PyObject* it);
+/* UnpackUnboundCMethod.proto */
+typedef struct {
+    PyObject *type;
+    PyObject **method_name;
+    PyCFunction func;
+    PyObject *method;
+    int flag;
+} __Pyx_CachedCFunction;
 
-/* PySetContains.proto */
-static CYTHON_INLINE int __Pyx_PySet_ContainsTF(PyObject* key, PyObject* set, int eq);
+/* CallUnboundCMethod1.proto */
+static PyObject* __Pyx__CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg);
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg);
+#else
+#define __Pyx_CallUnboundCMethod1(cfunc, self, arg)  __Pyx__CallUnboundCMethod1(cfunc, self, arg)
+#endif
 
 /* ListAppend.proto */
 #if CYTHON_USE_PYLIST_INTERNALS && CYTHON_ASSUME_SAFE_MACROS
 static CYTHON_INLINE int __Pyx_PyList_Append(PyObject* list, PyObject* x) {
     PyListObject* L = (PyListObject*) list;
     Py_ssize_t len = Py_SIZE(list);
     if (likely(L->allocated > len) & likely(len > (L->allocated >> 1))) {
@@ -1867,14 +1908,53 @@
     }
     return PyList_Append(list, x);
 }
 #else
 #define __Pyx_PyList_Append(L,x) PyList_Append(L,x)
 #endif
 
+/* SetItemInt.proto */
+#define __Pyx_SetItemInt(o, i, v, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_SetItemInt_Fast(o, (Py_ssize_t)i, v, is_list, wraparound, boundscheck) :\
+    (is_list ? (PyErr_SetString(PyExc_IndexError, "list assignment index out of range"), -1) :\
+               __Pyx_SetItemInt_Generic(o, to_py_func(i), v)))
+static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v);
+static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v,
+                                               int is_list, int wraparound, int boundscheck);
+
+/* pyfrozenset_new.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyFrozenSet_New(PyObject* it);
+
+/* PySetContains.proto */
+static CYTHON_INLINE int __Pyx_PySet_ContainsTF(PyObject* key, PyObject* set, int eq);
+
+/* RaiseTooManyValuesToUnpack.proto */
+static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected);
+
+/* RaiseNeedMoreValuesToUnpack.proto */
+static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index);
+
+/* IterFinish.proto */
+static CYTHON_INLINE int __Pyx_IterFinish(void);
+
+/* UnpackItemEndCheck.proto */
+static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected);
+
+/* WriteUnraisableException.proto */
+static void __Pyx_WriteUnraisable(const char *name, int clineno,
+                                  int lineno, const char *filename,
+                                  int full_traceback, int nogil);
+
+/* PyDictContains.proto */
+static CYTHON_INLINE int __Pyx_PyDict_ContainsTF(PyObject* item, PyObject* dict, int eq) {
+    int result = PyDict_Contains(dict, item);
+    return unlikely(result < 0) ? result : (result == (eq == Py_EQ));
+}
+
 /* PyFunctionFastCall.proto */
 #if CYTHON_FAST_PYCALL
 #if !CYTHON_VECTORCALL
 #define __Pyx_PyFunction_FastCall(func, args, nargs)\
     __Pyx_PyFunction_FastCallDict((func), (args), (nargs), NULL)
 static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs);
 #endif
@@ -1899,158 +1979,29 @@
 static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg);
 #endif
 
 /* PyObjectFastCall.proto */
 #define __Pyx_PyObject_FastCall(func, args, nargs)  __Pyx_PyObject_FastCallDict(func, args, (size_t)(nargs), NULL)
 static CYTHON_INLINE PyObject* __Pyx_PyObject_FastCallDict(PyObject *func, PyObject **args, size_t nargs, PyObject *kwargs);
 
-/* PyObjectCallNoArg.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func);
+/* ExtTypeTest.proto */
+static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type);
 
 /* PyObjectCallOneArg.proto */
 static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg);
 
-/* PyObjectGetMethod.proto */
-static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method);
-
-/* PyObjectCallMethod0.proto */
-static PyObject* __Pyx_PyObject_CallMethod0(PyObject* obj, PyObject* method_name);
-
-/* pop.proto */
-static CYTHON_INLINE PyObject* __Pyx__PyObject_Pop(PyObject* L);
-#if CYTHON_USE_PYLIST_INTERNALS && CYTHON_ASSUME_SAFE_MACROS
-static CYTHON_INLINE PyObject* __Pyx_PyList_Pop(PyObject* L);
-#define __Pyx_PyObject_Pop(L) (likely(PyList_CheckExact(L)) ?\
-    __Pyx_PyList_Pop(L) : __Pyx__PyObject_Pop(L))
-#else
-#define __Pyx_PyList_Pop(L)  __Pyx__PyObject_Pop(L)
-#define __Pyx_PyObject_Pop(L)  __Pyx__PyObject_Pop(L)
-#endif
-
-/* UnpackUnboundCMethod.proto */
-typedef struct {
-    PyObject *type;
-    PyObject **method_name;
-    PyCFunction func;
-    PyObject *method;
-    int flag;
-} __Pyx_CachedCFunction;
-
-/* CallUnboundCMethod0.proto */
-static PyObject* __Pyx__CallUnboundCMethod0(__Pyx_CachedCFunction* cfunc, PyObject* self);
-#if CYTHON_COMPILING_IN_CPYTHON
-#define __Pyx_CallUnboundCMethod0(cfunc, self)\
-    (likely((cfunc)->func) ?\
-        (likely((cfunc)->flag == METH_NOARGS) ?  (*((cfunc)->func))(self, NULL) :\
-         (PY_VERSION_HEX >= 0x030600B1 && likely((cfunc)->flag == METH_FASTCALL) ?\
-            (PY_VERSION_HEX >= 0x030700A0 ?\
-                (*(__Pyx_PyCFunctionFast)(void*)(PyCFunction)(cfunc)->func)(self, &__pyx_empty_tuple, 0) :\
-                (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)(cfunc)->func)(self, &__pyx_empty_tuple, 0, NULL)) :\
-          (PY_VERSION_HEX >= 0x030700A0 && (cfunc)->flag == (METH_FASTCALL | METH_KEYWORDS) ?\
-            (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)(cfunc)->func)(self, &__pyx_empty_tuple, 0, NULL) :\
-            (likely((cfunc)->flag == (METH_VARARGS | METH_KEYWORDS)) ?  ((*(PyCFunctionWithKeywords)(void*)(PyCFunction)(cfunc)->func)(self, __pyx_empty_tuple, NULL)) :\
-               ((cfunc)->flag == METH_VARARGS ?  (*((cfunc)->func))(self, __pyx_empty_tuple) :\
-               __Pyx__CallUnboundCMethod0(cfunc, self)))))) :\
-        __Pyx__CallUnboundCMethod0(cfunc, self))
-#else
-#define __Pyx_CallUnboundCMethod0(cfunc, self)  __Pyx__CallUnboundCMethod0(cfunc, self)
-#endif
-
-/* WriteUnraisableException.proto */
-static void __Pyx_WriteUnraisable(const char *name, int clineno,
-                                  int lineno, const char *filename,
-                                  int full_traceback, int nogil);
-
-/* KeywordStringCheck.proto */
-static int __Pyx_CheckKeywordStrings(PyObject *kw, const char* function_name, int kw_allowed);
-
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
-/* GetItemInt.proto */
-#define __Pyx_GetItemInt(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_GetItemInt_Fast(o, (Py_ssize_t)i, is_list, wraparound, boundscheck) :\
-    (is_list ? (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL) :\
-               __Pyx_GetItemInt_Generic(o, to_py_func(i))))
-#define __Pyx_GetItemInt_List(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_GetItemInt_List_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
-    (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL))
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
-                                                              int wraparound, int boundscheck);
-#define __Pyx_GetItemInt_Tuple(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_GetItemInt_Tuple_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
-    (PyErr_SetString(PyExc_IndexError, "tuple index out of range"), (PyObject*)NULL))
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
-                                                              int wraparound, int boundscheck);
-static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j);
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i,
-                                                     int is_list, int wraparound, int boundscheck);
-
-/* CallUnboundCMethod1.proto */
-static PyObject* __Pyx__CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg);
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg);
-#else
-#define __Pyx_CallUnboundCMethod1(cfunc, self, arg)  __Pyx__CallUnboundCMethod1(cfunc, self, arg)
-#endif
-
-/* SetItemInt.proto */
-#define __Pyx_SetItemInt(o, i, v, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_SetItemInt_Fast(o, (Py_ssize_t)i, v, is_list, wraparound, boundscheck) :\
-    (is_list ? (PyErr_SetString(PyExc_IndexError, "list assignment index out of range"), -1) :\
-               __Pyx_SetItemInt_Generic(o, to_py_func(i), v)))
-static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v);
-static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v,
-                                               int is_list, int wraparound, int boundscheck);
-
-/* RaiseTooManyValuesToUnpack.proto */
-static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected);
-
-/* RaiseNeedMoreValuesToUnpack.proto */
-static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index);
-
-/* IterFinish.proto */
-static CYTHON_INLINE int __Pyx_IterFinish(void);
-
-/* UnpackItemEndCheck.proto */
-static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected);
-
-/* ArgTypeTest.proto */
-#define __Pyx_ArgTypeTest(obj, type, none_allowed, name, exact)\
-    ((likely(__Pyx_IS_TYPE(obj, type) | (none_allowed && (obj == Py_None)))) ? 1 :\
-        __Pyx__ArgTypeTest(obj, type, name, exact))
-static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact);
-
-/* dict_getitem_default.proto */
-static PyObject* __Pyx_PyDict_GetItemDefault(PyObject* d, PyObject* key, PyObject* default_value);
-
-/* CallUnboundCMethod2.proto */
-static PyObject* __Pyx__CallUnboundCMethod2(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg1, PyObject* arg2);
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030600B1
-static CYTHON_INLINE PyObject *__Pyx_CallUnboundCMethod2(__Pyx_CachedCFunction *cfunc, PyObject *self, PyObject *arg1, PyObject *arg2);
-#else
-#define __Pyx_CallUnboundCMethod2(cfunc, self, arg1, arg2)  __Pyx__CallUnboundCMethod2(cfunc, self, arg1, arg2)
-#endif
-
-/* py_dict_pop.proto */
-static CYTHON_INLINE PyObject *__Pyx_PyDict_Pop(PyObject *d, PyObject *key, PyObject *default_value);
-
 /* PySequenceContains.proto */
 static CYTHON_INLINE int __Pyx_PySequence_ContainsTF(PyObject* item, PyObject* seq, int eq) {
     int result = PySequence_Contains(seq, item);
     return unlikely(result < 0) ? result : (result == (eq == Py_EQ));
 }
 
-/* py_set_discard.proto */
-static CYTHON_INLINE int __Pyx_PySet_Discard(PyObject *set, PyObject *key);
-
 /* PyObject_Str.proto */
 #define __Pyx_PyObject_Str(obj)\
     (likely(PyString_CheckExact(obj)) ? __Pyx_NewRef(obj) : PyObject_Str(obj))
 
 /* UnicodeConcatInPlace.proto */
 # if CYTHON_COMPILING_IN_CPYTHON && PY_MAJOR_VERSION >= 3
     #if CYTHON_REFNANNY
@@ -2065,17 +2016,37 @@
     );
 #else
 #define __Pyx_PyUnicode_ConcatInPlace __Pyx_PyUnicode_Concat
 #endif
 #define __Pyx_PyUnicode_ConcatInPlaceSafe(left, right) ((unlikely((left) == Py_None) || unlikely((right) == Py_None)) ?\
     PyNumber_InPlaceAdd(left, right) : __Pyx_PyUnicode_ConcatInPlace(left, right))
 
+/* SliceObject.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetSlice(
+        PyObject* obj, Py_ssize_t cstart, Py_ssize_t cstop,
+        PyObject** py_start, PyObject** py_stop, PyObject** py_slice,
+        int has_cstart, int has_cstop, int wraparound);
+
 /* RaiseUnexpectedTypeError.proto */
 static int __Pyx_RaiseUnexpectedTypeError(const char *expected, PyObject *obj);
 
+/* ArgTypeTest.proto */
+#define __Pyx_ArgTypeTest(obj, type, none_allowed, name, exact)\
+    ((likely(__Pyx_IS_TYPE(obj, type) | (none_allowed && (obj == Py_None)))) ? 1 :\
+        __Pyx__ArgTypeTest(obj, type, name, exact))
+static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact);
+
+/* PyIntBinop.proto */
+#if !CYTHON_COMPILING_IN_PYPY
+static PyObject* __Pyx_PyInt_MultiplyCObj(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check);
+#else
+#define __Pyx_PyInt_MultiplyCObj(op1, op2, intval, inplace, zerodivision_check)\
+    (inplace ? PyNumber_InPlaceMultiply(op1, op2) : PyNumber_Multiply(op1, op2))
+#endif
+
 /* IsLittleEndian.proto */
 static CYTHON_INLINE int __Pyx_Is_Little_Endian(void);
 
 /* BufferFormatCheck.proto */
 static const char* __Pyx_BufFmt_CheckString(__Pyx_BufFmt_Context* ctx, const char* ts);
 static void __Pyx_BufFmt_Init(__Pyx_BufFmt_Context* ctx,
                               __Pyx_BufFmt_StackElem* stack,
@@ -2092,20 +2063,14 @@
 static CYTHON_INLINE void __Pyx_SafeReleaseBuffer(Py_buffer* info);
 static Py_ssize_t __Pyx_minusones[] = { -1, -1, -1, -1, -1, -1, -1, -1 };
 static Py_ssize_t __Pyx_zeros[] = { 0, 0, 0, 0, 0, 0, 0, 0 };
 
 /* BufferFallbackError.proto */
 static void __Pyx_RaiseBufferFallbackError(void);
 
-/* PyDictContains.proto */
-static CYTHON_INLINE int __Pyx_PyDict_ContainsTF(PyObject* item, PyObject* dict, int eq) {
-    int result = PyDict_Contains(dict, item);
-    return unlikely(result < 0) ? result : (result == (eq == Py_EQ));
-}
-
 /* DictGetItem.proto */
 #if PY_MAJOR_VERSION >= 3 && !CYTHON_COMPILING_IN_PYPY
 static PyObject *__Pyx_PyDict_GetItem(PyObject *d, PyObject* key);
 #define __Pyx_PyObject_Dict_GetItem(obj, name)\
     (likely(PyDict_CheckExact(obj)) ?\
      __Pyx_PyDict_GetItem(obj, name) : PyObject_GetItem(obj, name))
 #else
@@ -2133,77 +2098,42 @@
 #if CYTHON_FAST_THREAD_STATE
 #define __Pyx_GetException(type, value, tb)  __Pyx__GetException(__pyx_tstate, type, value, tb)
 static int __Pyx__GetException(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb);
 #else
 static int __Pyx_GetException(PyObject **type, PyObject **value, PyObject **tb);
 #endif
 
-/* IncludeStructmemberH.proto */
-#include <structmember.h>
-
-/* FixUpExtensionType.proto */
-#if CYTHON_USE_TYPE_SPECS
-static int __Pyx_fix_up_extension_type_from_spec(PyType_Spec *spec, PyTypeObject *type);
-#endif
-
-/* ValidateBasesTuple.proto */
-#if CYTHON_COMPILING_IN_CPYTHON || CYTHON_COMPILING_IN_LIMITED_API || CYTHON_USE_TYPE_SPECS
-static int __Pyx_validate_bases_tuple(const char *type_name, Py_ssize_t dictoffset, PyObject *bases);
-#endif
-
-/* PyType_Ready.proto */
-static CYTHON_UNUSED int __Pyx_PyType_Ready(PyTypeObject *t);
-
-/* PyObject_GenericGetAttrNoDict.proto */
-#if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
-static CYTHON_INLINE PyObject* __Pyx_PyObject_GenericGetAttrNoDict(PyObject* obj, PyObject* attr_name);
-#else
-#define __Pyx_PyObject_GenericGetAttrNoDict PyObject_GenericGetAttr
-#endif
-
-/* PyObject_GenericGetAttr.proto */
-#if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
-static PyObject* __Pyx_PyObject_GenericGetAttr(PyObject* obj, PyObject* attr_name);
-#else
-#define __Pyx_PyObject_GenericGetAttr PyObject_GenericGetAttr
-#endif
-
-/* SetVTable.proto */
-static int __Pyx_SetVtable(PyTypeObject* typeptr , void* vtable);
-
-/* GetVTable.proto */
-static void* __Pyx_GetVtable(PyTypeObject *type);
-
-/* MergeVTables.proto */
-#if !CYTHON_COMPILING_IN_LIMITED_API
-static int __Pyx_MergeVtables(PyTypeObject *type);
-#endif
-
-/* SetupReduce.proto */
-#if !CYTHON_COMPILING_IN_LIMITED_API
-static int __Pyx_setup_reduce(PyObject* type_obj);
-#endif
-
 /* TypeImport.proto */
 #ifndef __PYX_HAVE_RT_ImportType_proto
 #define __PYX_HAVE_RT_ImportType_proto
 enum __Pyx_ImportType_CheckSize {
    __Pyx_ImportType_CheckSize_Error = 0,
    __Pyx_ImportType_CheckSize_Warn = 1,
    __Pyx_ImportType_CheckSize_Ignore = 2
 };
 static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, enum __Pyx_ImportType_CheckSize check_size);
 #endif
 
+/* GetVTable.proto */
+static void* __Pyx_GetVtable(PyTypeObject *type);
+
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* ImportDottedModule.proto */
 static PyObject *__Pyx_ImportDottedModule(PyObject *name, PyObject *parts_tuple);
 
+/* IncludeStructmemberH.proto */
+#include <structmember.h>
+
+/* FixUpExtensionType.proto */
+#if CYTHON_USE_TYPE_SPECS
+static int __Pyx_fix_up_extension_type_from_spec(PyType_Spec *spec, PyTypeObject *type);
+#endif
+
 /* FetchCommonType.proto */
 #if !CYTHON_USE_TYPE_SPECS
 static PyTypeObject* __Pyx_FetchCommonType(PyTypeObject* type);
 #else
 static PyTypeObject* __Pyx_FetchCommonTypeFromSpec(PyObject *module, PyType_Spec *spec, PyObject *bases);
 #endif
 
@@ -2472,14 +2402,17 @@
     #endif
 #endif
 
 /* CIntFromPy.proto */
 static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);
 
 /* CIntToPy.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
+
+/* CIntToPy.proto */
 static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value);
 
 /* FormatTypeName.proto */
 #if CYTHON_COMPILING_IN_LIMITED_API
 typedef PyObject *__Pyx_TypeName;
 #define __Pyx_FMT_TYPENAME "%U"
 static __Pyx_TypeName __Pyx_PyType_GetName(PyTypeObject* tp);
@@ -2487,17 +2420,14 @@
 #else
 typedef const char *__Pyx_TypeName;
 #define __Pyx_FMT_TYPENAME "%.200s"
 #define __Pyx_PyType_GetName(tp) ((tp)->tp_name)
 #define __Pyx_DECREF_TypeName(obj)
 #endif
 
-/* CIntToPy.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
-
 /* CIntFromPy.proto */
 static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);
 
 /* FastTypeChecks.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 #define __Pyx_TypeCheck(obj, type) __Pyx_IsSubtype(Py_TYPE(obj), (PyTypeObject *)type)
 #define __Pyx_TypeCheck2(obj, type1, type2) __Pyx_IsAnySubtype2(Py_TYPE(obj), (PyTypeObject *)type1, (PyTypeObject *)type2)
@@ -2513,28 +2443,25 @@
 #endif
 #define __Pyx_PyErr_ExceptionMatches2(err1, err2)  __Pyx_PyErr_GivenExceptionMatches2(__Pyx_PyErr_Occurred(), err1, err2)
 #define __Pyx_PyException_Check(obj) __Pyx_TypeCheck(obj, PyExc_Exception)
 
 /* CheckBinaryVersion.proto */
 static int __Pyx_check_binary_version(void);
 
+/* FunctionImport.proto */
+static int __Pyx_ImportFunction(PyObject *module, const char *funcname, void (**f)(void), const char *sig);
+
 /* InitStrings.proto */
 #if CYTHON_COMPILING_IN_LIMITED_API
 static int __Pyx_InitString(__Pyx_StringTabEntry t, PyObject **str);
 #else
 static int __Pyx_InitStrings(__Pyx_StringTabEntry *t);
 #endif
 
 /* #### Code section: module_declarations ### */
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_has_parent(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n); /* proto*/
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_fast_find(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n); /* proto*/
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_passive_find(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n); /* proto*/
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_passive_union(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_aa, __pyx_t_5numpy_intp_t __pyx_v_bb); /* proto*/
-static PyObject *__pyx_f_5druhg_12_druhg_label_9UnionFind_discard_clusters(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n, PyObject *__pyx_v_clusters); /* proto*/
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_label_find(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n, PyObject *__pyx_v_clusters); /* proto*/
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_7ndarray_4base_base(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE PyArray_Descr *__pyx_f_5numpy_7ndarray_5descr_descr(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE int __pyx_f_5numpy_7ndarray_4ndim_ndim(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp *__pyx_f_5numpy_7ndarray_5shape_shape(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp *__pyx_f_5numpy_7ndarray_7strides_strides(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp __pyx_f_5numpy_7ndarray_4size_size(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE char *__pyx_f_5numpy_7ndarray_4data_data(PyArrayObject *__pyx_v_self); /* proto*/
@@ -2587,254 +2514,185 @@
 static PyTypeObject *__pyx_ptype_5numpy_floating = 0;
 static PyTypeObject *__pyx_ptype_5numpy_complexfloating = 0;
 static PyTypeObject *__pyx_ptype_5numpy_flexible = 0;
 static PyTypeObject *__pyx_ptype_5numpy_character = 0;
 static PyTypeObject *__pyx_ptype_5numpy_ufunc = 0;
 #endif
 
-/* Module declarations from "druhg._druhg_amalgamation" */
+/* Module declarations from "druhg._druhg_unionfind" */
 #if !CYTHON_USE_MODULE_STATE
-static PyTypeObject *__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation = 0;
+static PyTypeObject *__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = 0;
 #endif
 
+/* Module declarations from "libc.math" */
+#if !CYTHON_USE_MODULE_STATE
+#endif
+
+/* Module declarations from "druhg._druhg_group" */
+#if !CYTHON_USE_MODULE_STATE
+static PyTypeObject *__pyx_ptype_5druhg_12_druhg_group_Group = 0;
+#endif
+static PyObject *(*__pyx_f_5druhg_12_druhg_group_set_precision)(__pyx_t_5numpy_double_t); /*proto*/
+static int (*__pyx_f_5druhg_12_druhg_group_group_is_cluster)(PyObject *, __pyx_t_5numpy_double_t *, __pyx_t_5numpy_double_t); /*proto*/
+
 /* Module declarations from "druhg._druhg_label" */
 #if !CYTHON_USE_MODULE_STATE
-static PyTypeObject *__pyx_ptype_5druhg_12_druhg_label_UnionFind = 0;
 #endif
+static PyObject *__pyx_f_5druhg_12_druhg_label_getIndex(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t); /*proto*/
 static void __pyx_f_5druhg_12_druhg_label_fixem(PyArrayObject *, __pyx_t_5numpy_intp_t, PyArrayObject *); /*proto*/
-static PyArrayObject *__pyx_f_5druhg_12_druhg_label_label(PyArrayObject *, PyArrayObject *, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_12_druhg_label_label *__pyx_optional_args); /*proto*/
+static PyObject *__pyx_f_5druhg_12_druhg_label_mark_labels(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, PyObject *, PyArrayObject *); /*proto*/
+static PyObject *__pyx_f_5druhg_12_druhg_label_emerge_clusters(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, PyArrayObject *, PyArrayObject *, struct __pyx_opt_args_5druhg_12_druhg_label_emerge_clusters *__pyx_optional_args); /*proto*/
+static PyArrayObject *__pyx_f_5druhg_12_druhg_label_label(PyArrayObject *, PyArrayObject *, int, PyArrayObject *, PyArrayObject *, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_12_druhg_label_label *__pyx_optional_args); /*proto*/
 /* #### Code section: typeinfo ### */
 static __Pyx_TypeInfo __Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t = { "intp_t", NULL, sizeof(__pyx_t_5numpy_intp_t), { 0 }, 0, IS_UNSIGNED(__pyx_t_5numpy_intp_t) ? 'U' : 'I', IS_UNSIGNED(__pyx_t_5numpy_intp_t), 0 };
 /* #### Code section: before_global_var ### */
 #define __Pyx_MODULE_NAME "druhg._druhg_label"
 extern int __pyx_module_is_main_druhg___druhg_label;
 int __pyx_module_is_main_druhg___druhg_label = 0;
 
 /* Implementation of "druhg._druhg_label" */
 /* #### Code section: global_var ### */
-static PyObject *__pyx_builtin_TypeError;
 static PyObject *__pyx_builtin_range;
-static PyObject *__pyx_builtin_enumerate;
+static PyObject *__pyx_builtin_AssertionError;
 static PyObject *__pyx_builtin_print;
 static PyObject *__pyx_builtin_ImportError;
 /* #### Code section: string_decls ### */
-static const char __pyx_k_N[] = "N";
-static const char __pyx_k_U[] = "U";
-static const char __pyx_k_c[] = "c";
-static const char __pyx_k_d[] = "d";
-static const char __pyx_k_i[] = "i";
-static const char __pyx_k_v[] = "v";
 static const char __pyx_k__3[] = "*";
-static const char __pyx_k_e1[] = "e1";
-static const char __pyx_k_e2[] = "e2";
-static const char __pyx_k_e3[] = "e3";
-static const char __pyx_k_gc[] = "gc";
+static const char __pyx_k__9[] = "?";
 static const char __pyx_k_np[] = "np";
-static const char __pyx_k_p1[] = "p1";
-static const char __pyx_k_p2[] = "p2";
-static const char __pyx_k__14[] = "?";
-static const char __pyx_k_get[] = "get";
-static const char __pyx_k_pop[] = "pop";
 static const char __pyx_k_ceil[] = "ceil";
-static const char __pyx_k_disc[] = "disc";
+static const char __pyx_k_fill[] = "fill";
 static const char __pyx_k_intp[] = "intp";
 static const char __pyx_k_main[] = "__main__";
 static const char __pyx_k_name[] = "__name__";
 static const char __pyx_k_ones[] = "ones";
-static const char __pyx_k_self[] = "self";
 static const char __pyx_k_size[] = "size";
 static const char __pyx_k_spec[] = "__spec__";
 static const char __pyx_k_sqrt[] = "sqrt";
 static const char __pyx_k_test[] = "__test__";
-static const char __pyx_k_being[] = "being";
+static const char __pyx_k_Group[] = "Group";
 static const char __pyx_k_dtype[] = "dtype";
-static const char __pyx_k_jump1[] = "jump1";
-static const char __pyx_k_jump2[] = "jump2";
+static const char __pyx_k_empty[] = "empty";
 static const char __pyx_k_label[] = "label";
 static const char __pyx_k_numpy[] = "numpy";
 static const char __pyx_k_print[] = "print";
 static const char __pyx_k_range[] = "range";
 static const char __pyx_k_zeros[] = "zeros";
-static const char __pyx_k_being1[] = "being1";
-static const char __pyx_k_being2[] = "being2";
-static const char __pyx_k_being3[] = "being3";
-static const char __pyx_k_enable[] = "enable";
 static const char __pyx_k_import[] = "__import__";
-static const char __pyx_k_kwargs[] = "kwargs";
 static const char __pyx_k_limit1[] = "limit1";
 static const char __pyx_k_limit2[] = "limit2";
-static const char __pyx_k_reduce[] = "__reduce__";
 static const char __pyx_k_remove[] = "remove";
+static const char __pyx_k_uf_arr[] = "uf_arr";
 static const char __pyx_k_unique[] = "unique";
 static const char __pyx_k_update[] = "update";
-static const char __pyx_k_disable[] = "disable";
 static const char __pyx_k_exclude[] = "exclude";
-static const char __pyx_k_clusters[] = "clusters";
-static const char __pyx_k_getstate[] = "__getstate__";
-static const char __pyx_k_setstate[] = "__setstate__";
-static const char __pyx_k_PRECISION[] = "PRECISION";
-static const char __pyx_k_TypeError[] = "TypeError";
 static const char __pyx_k_UnionFind[] = "UnionFind";
-static const char __pyx_k_edges_arr[] = "edges_arr";
-static const char __pyx_k_enumerate[] = "enumerate";
-static const char __pyx_k_isenabled[] = "isenabled";
-static const char __pyx_k_pyx_state[] = "__pyx_state";
-static const char __pyx_k_reduce_ex[] = "__reduce_ex__";
+static const char __pyx_k_group_arr[] = "group_arr";
+static const char __pyx_k_precision[] = "precision";
+static const char __pyx_k_ranks_arr[] = "ranks_arr";
 static const char __pyx_k_pyx_vtable[] = "__pyx_vtable__";
+static const char __pyx_k_ret_labels[] = "ret_labels";
 static const char __pyx_k_values_arr[] = "values_arr";
 static const char __pyx_k_ImportError[] = "ImportError";
-static const char __pyx_k_Amalgamation[] = "Amalgamation";
+static const char __pyx_k_druhg_group[] = "_druhg_group";
 static const char __pyx_k_fix_outliers[] = "fix_outliers";
 static const char __pyx_k_initializing[] = "_initializing";
 static const char __pyx_k_is_coroutine[] = "_is_coroutine";
-static const char __pyx_k_stringsource[] = "<stringsource>";
-static const char __pyx_k_is_reciprocal[] = "is_reciprocal";
-static const char __pyx_k_reduce_cython[] = "__reduce_cython__";
-static const char __pyx_k_emerge_clusters[] = "emerge_clusters";
-static const char __pyx_k_setstate_cython[] = "__setstate_cython__";
-static const char __pyx_k_double_precision[] = "double_precision";
-static const char __pyx_k_double_precision2[] = "double_precision2";
+static const char __pyx_k_edgepairs_arr[] = "edgepairs_arr";
+static const char __pyx_k_AssertionError[] = "AssertionError";
+static const char __pyx_k_druhg_unionfind[] = "_druhg_unionfind";
 static const char __pyx_k_asyncio_coroutines[] = "asyncio.coroutines";
 static const char __pyx_k_cline_in_traceback[] = "cline_in_traceback";
 static const char __pyx_k_druhg__druhg_label[] = "druhg._druhg_label";
-static const char __pyx_k_druhg_amalgamation[] = "_druhg_amalgamation";
 static const char __pyx_k_will_not_be_formed[] = " will not be formed.";
+static const char __pyx_k_allocate_buffer_labels[] = "allocate_buffer_labels";
 static const char __pyx_k_druhg__druhg_label_pyx[] = "druhg\\_druhg_label.pyx";
 static const char __pyx_k_are_considered_as_noise[] = " are considered as noise.";
-static const char __pyx_k_UnionFind___reduce_cython[] = "UnionFind.__reduce_cython__";
-static const char __pyx_k_UnionFind___setstate_cython[] = "UnionFind.__setstate_cython__";
 static const char __pyx_k_numpy_core_multiarray_failed_to[] = "numpy.core.multiarray failed to import";
-static const char __pyx_k_self_parent_cannot_be_converted[] = "self.parent cannot be converted to a Python object for pickling";
+static const char __pyx_k_ERROR_labels_buffer_is_too_small[] = "ERROR: labels buffer is too small";
 static const char __pyx_k_label_default_value_for_limit1_i[] = "label: default value for limit1 is used, clusters below ";
 static const char __pyx_k_label_default_value_for_limit2_i[] = "label: default value for limit2 is used, clusters above ";
 static const char __pyx_k_numpy_core_umath_failed_to_impor[] = "numpy.core.umath failed to import";
 #if !CYTHON_USE_MODULE_STATE
-static PyObject *__pyx_n_s_Amalgamation;
+static PyObject *__pyx_n_s_AssertionError;
+static PyObject *__pyx_kp_u_ERROR_labels_buffer_is_too_small;
+static PyObject *__pyx_n_s_Group;
 static PyObject *__pyx_n_s_ImportError;
-static PyObject *__pyx_n_s_N;
-static PyObject *__pyx_n_s_PRECISION;
-static PyObject *__pyx_n_s_TypeError;
-static PyObject *__pyx_n_s_U;
 static PyObject *__pyx_n_s_UnionFind;
-static PyObject *__pyx_n_s_UnionFind___reduce_cython;
-static PyObject *__pyx_n_s_UnionFind___setstate_cython;
-static PyObject *__pyx_n_s__14;
 static PyObject *__pyx_n_s__3;
+static PyObject *__pyx_n_s__9;
+static PyObject *__pyx_n_s_allocate_buffer_labels;
 static PyObject *__pyx_kp_u_are_considered_as_noise;
 static PyObject *__pyx_n_s_asyncio_coroutines;
-static PyObject *__pyx_n_s_being;
-static PyObject *__pyx_n_s_being1;
-static PyObject *__pyx_n_s_being2;
-static PyObject *__pyx_n_s_being3;
-static PyObject *__pyx_n_s_c;
 static PyObject *__pyx_n_s_ceil;
 static PyObject *__pyx_n_s_cline_in_traceback;
-static PyObject *__pyx_n_s_clusters;
-static PyObject *__pyx_n_s_d;
-static PyObject *__pyx_kp_u_disable;
-static PyObject *__pyx_n_s_disc;
-static PyObject *__pyx_n_u_double_precision;
-static PyObject *__pyx_n_u_double_precision2;
 static PyObject *__pyx_n_s_druhg__druhg_label;
 static PyObject *__pyx_kp_s_druhg__druhg_label_pyx;
-static PyObject *__pyx_n_s_druhg_amalgamation;
+static PyObject *__pyx_n_s_druhg_group;
+static PyObject *__pyx_n_s_druhg_unionfind;
 static PyObject *__pyx_n_s_dtype;
-static PyObject *__pyx_n_s_e1;
-static PyObject *__pyx_n_s_e2;
-static PyObject *__pyx_n_s_e3;
-static PyObject *__pyx_n_s_edges_arr;
-static PyObject *__pyx_n_s_emerge_clusters;
-static PyObject *__pyx_kp_u_enable;
-static PyObject *__pyx_n_s_enumerate;
+static PyObject *__pyx_n_s_edgepairs_arr;
+static PyObject *__pyx_n_s_empty;
 static PyObject *__pyx_n_s_exclude;
+static PyObject *__pyx_n_s_fill;
 static PyObject *__pyx_n_s_fix_outliers;
-static PyObject *__pyx_kp_u_gc;
-static PyObject *__pyx_n_s_get;
-static PyObject *__pyx_n_s_getstate;
-static PyObject *__pyx_n_s_i;
+static PyObject *__pyx_n_s_group_arr;
 static PyObject *__pyx_n_s_import;
 static PyObject *__pyx_n_s_initializing;
 static PyObject *__pyx_n_s_intp;
 static PyObject *__pyx_n_s_is_coroutine;
-static PyObject *__pyx_n_s_is_reciprocal;
-static PyObject *__pyx_kp_u_isenabled;
-static PyObject *__pyx_n_s_jump1;
-static PyObject *__pyx_n_s_jump2;
-static PyObject *__pyx_n_s_kwargs;
 static PyObject *__pyx_n_s_label;
 static PyObject *__pyx_kp_u_label_default_value_for_limit1_i;
 static PyObject *__pyx_kp_u_label_default_value_for_limit2_i;
 static PyObject *__pyx_n_s_limit1;
 static PyObject *__pyx_n_s_limit2;
 static PyObject *__pyx_n_s_main;
 static PyObject *__pyx_n_s_name;
 static PyObject *__pyx_n_s_np;
 static PyObject *__pyx_n_s_numpy;
 static PyObject *__pyx_kp_u_numpy_core_multiarray_failed_to;
 static PyObject *__pyx_kp_u_numpy_core_umath_failed_to_impor;
 static PyObject *__pyx_n_s_ones;
-static PyObject *__pyx_n_s_p1;
-static PyObject *__pyx_n_s_p2;
-static PyObject *__pyx_n_s_pop;
+static PyObject *__pyx_n_s_precision;
 static PyObject *__pyx_n_s_print;
-static PyObject *__pyx_n_s_pyx_state;
 static PyObject *__pyx_n_s_pyx_vtable;
 static PyObject *__pyx_n_s_range;
-static PyObject *__pyx_n_s_reduce;
-static PyObject *__pyx_n_s_reduce_cython;
-static PyObject *__pyx_n_s_reduce_ex;
+static PyObject *__pyx_n_s_ranks_arr;
 static PyObject *__pyx_n_s_remove;
-static PyObject *__pyx_n_s_self;
-static PyObject *__pyx_kp_s_self_parent_cannot_be_converted;
-static PyObject *__pyx_n_s_setstate;
-static PyObject *__pyx_n_s_setstate_cython;
+static PyObject *__pyx_n_s_ret_labels;
 static PyObject *__pyx_n_s_size;
 static PyObject *__pyx_n_s_spec;
 static PyObject *__pyx_n_s_sqrt;
-static PyObject *__pyx_kp_s_stringsource;
 static PyObject *__pyx_n_s_test;
+static PyObject *__pyx_n_s_uf_arr;
 static PyObject *__pyx_n_s_unique;
 static PyObject *__pyx_n_s_update;
-static PyObject *__pyx_n_s_v;
 static PyObject *__pyx_n_s_values_arr;
 static PyObject *__pyx_kp_u_will_not_be_formed;
 static PyObject *__pyx_n_s_zeros;
 #endif
 /* #### Code section: decls ### */
-static int __pyx_pf_5druhg_12_druhg_label_9UnionFind___init__(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, PyObject *__pyx_v_N); /* proto */
-static PyObject *__pyx_pf_5druhg_12_druhg_label_9UnionFind_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_5druhg_12_druhg_label_9UnionFind_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_5druhg_12_druhg_label_emerge_clusters(CYTHON_UNUSED PyObject *__pyx_self, struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_U, PyArrayObject *__pyx_v_edges_arr, PyArrayObject *__pyx_v_values_arr, __pyx_t_5numpy_intp_t __pyx_v_limit1, __pyx_t_5numpy_intp_t __pyx_v_limit2, PyObject *__pyx_v_exclude, PyObject *__pyx_v_is_reciprocal, PyObject *__pyx_v_kwargs); /* proto */
-static PyObject *__pyx_pf_5druhg_12_druhg_label_2label(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_edges_arr, PyArrayObject *__pyx_v_values_arr, int __pyx_v_size, PyObject *__pyx_v_exclude, __pyx_t_5numpy_intp_t __pyx_v_limit1, __pyx_t_5numpy_intp_t __pyx_v_limit2, __pyx_t_5numpy_intp_t __pyx_v_fix_outliers, PyObject *__pyx_v_is_reciprocal); /* proto */
-static PyObject *__pyx_tp_new_5druhg_12_druhg_label_UnionFind(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
-static __Pyx_CachedCFunction __pyx_umethod_PyDict_Type_get = {0, 0, 0, 0, 0};
-static __Pyx_CachedCFunction __pyx_umethod_PyDict_Type_pop = {0, 0, 0, 0, 0};
-static __Pyx_CachedCFunction __pyx_umethod_PyList_Type_pop = {0, 0, 0, 0, 0};
+static PyObject *__pyx_pf_5druhg_12_druhg_label_allocate_buffer_labels(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_size); /* proto */
+static PyObject *__pyx_pf_5druhg_12_druhg_label_2label(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_values_arr, PyArrayObject *__pyx_v_uf_arr, int __pyx_v_size, PyArrayObject *__pyx_v_group_arr, PyArrayObject *__pyx_v_ret_labels, PyArrayObject *__pyx_v_ranks_arr, PyObject *__pyx_v_exclude, __pyx_t_5numpy_intp_t __pyx_v_limit1, __pyx_t_5numpy_intp_t __pyx_v_limit2, __pyx_t_5numpy_intp_t __pyx_v_fix_outliers, PyObject *__pyx_v_edgepairs_arr, PyObject *__pyx_v_precision); /* proto */
 static __Pyx_CachedCFunction __pyx_umethod_PyList_Type_remove = {0, 0, 0, 0, 0};
 static __Pyx_CachedCFunction __pyx_umethod_PySet_Type_update = {0, 0, 0, 0, 0};
 #if !CYTHON_USE_MODULE_STATE
 static PyObject *__pyx_float_0_0000001;
 static PyObject *__pyx_int_0;
 static PyObject *__pyx_int_1;
-static PyObject *__pyx_int_2;
 static PyObject *__pyx_int_neg_1;
 #endif
 #if !CYTHON_USE_MODULE_STATE
 static PyObject *__pyx_tuple_;
 static PyObject *__pyx_tuple__2;
 static PyObject *__pyx_tuple__4;
 static PyObject *__pyx_tuple__6;
 static PyObject *__pyx_tuple__8;
-static PyObject *__pyx_tuple__10;
-static PyObject *__pyx_tuple__11;
-static PyObject *__pyx_tuple__13;
 static PyObject *__pyx_codeobj__5;
 static PyObject *__pyx_codeobj__7;
-static PyObject *__pyx_codeobj__9;
-static PyObject *__pyx_codeobj__12;
 #endif
 /* #### Code section: late_includes ### */
 /* #### Code section: module_state ### */
 #if CYTHON_USE_MODULE_STATE
 typedef struct {
   PyObject *__pyx_d;
   PyObject *__pyx_b;
@@ -2860,124 +2718,83 @@
   PyTypeObject *__pyx_ptype_5numpy_unsignedinteger;
   PyTypeObject *__pyx_ptype_5numpy_inexact;
   PyTypeObject *__pyx_ptype_5numpy_floating;
   PyTypeObject *__pyx_ptype_5numpy_complexfloating;
   PyTypeObject *__pyx_ptype_5numpy_flexible;
   PyTypeObject *__pyx_ptype_5numpy_character;
   PyTypeObject *__pyx_ptype_5numpy_ufunc;
-  PyTypeObject *__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation;
-  PyTypeObject *__pyx_ptype_5druhg_12_druhg_label_UnionFind;
-  PyObject *__pyx_type_5druhg_12_druhg_label_UnionFind;
-  PyObject *__pyx_n_s_Amalgamation;
+  PyTypeObject *__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind;
+  PyTypeObject *__pyx_ptype_5druhg_12_druhg_group_Group;
+  PyObject *__pyx_n_s_AssertionError;
+  PyObject *__pyx_kp_u_ERROR_labels_buffer_is_too_small;
+  PyObject *__pyx_n_s_Group;
   PyObject *__pyx_n_s_ImportError;
-  PyObject *__pyx_n_s_N;
-  PyObject *__pyx_n_s_PRECISION;
-  PyObject *__pyx_n_s_TypeError;
-  PyObject *__pyx_n_s_U;
   PyObject *__pyx_n_s_UnionFind;
-  PyObject *__pyx_n_s_UnionFind___reduce_cython;
-  PyObject *__pyx_n_s_UnionFind___setstate_cython;
-  PyObject *__pyx_n_s__14;
   PyObject *__pyx_n_s__3;
+  PyObject *__pyx_n_s__9;
+  PyObject *__pyx_n_s_allocate_buffer_labels;
   PyObject *__pyx_kp_u_are_considered_as_noise;
   PyObject *__pyx_n_s_asyncio_coroutines;
-  PyObject *__pyx_n_s_being;
-  PyObject *__pyx_n_s_being1;
-  PyObject *__pyx_n_s_being2;
-  PyObject *__pyx_n_s_being3;
-  PyObject *__pyx_n_s_c;
   PyObject *__pyx_n_s_ceil;
   PyObject *__pyx_n_s_cline_in_traceback;
-  PyObject *__pyx_n_s_clusters;
-  PyObject *__pyx_n_s_d;
-  PyObject *__pyx_kp_u_disable;
-  PyObject *__pyx_n_s_disc;
-  PyObject *__pyx_n_u_double_precision;
-  PyObject *__pyx_n_u_double_precision2;
   PyObject *__pyx_n_s_druhg__druhg_label;
   PyObject *__pyx_kp_s_druhg__druhg_label_pyx;
-  PyObject *__pyx_n_s_druhg_amalgamation;
+  PyObject *__pyx_n_s_druhg_group;
+  PyObject *__pyx_n_s_druhg_unionfind;
   PyObject *__pyx_n_s_dtype;
-  PyObject *__pyx_n_s_e1;
-  PyObject *__pyx_n_s_e2;
-  PyObject *__pyx_n_s_e3;
-  PyObject *__pyx_n_s_edges_arr;
-  PyObject *__pyx_n_s_emerge_clusters;
-  PyObject *__pyx_kp_u_enable;
-  PyObject *__pyx_n_s_enumerate;
+  PyObject *__pyx_n_s_edgepairs_arr;
+  PyObject *__pyx_n_s_empty;
   PyObject *__pyx_n_s_exclude;
+  PyObject *__pyx_n_s_fill;
   PyObject *__pyx_n_s_fix_outliers;
-  PyObject *__pyx_kp_u_gc;
-  PyObject *__pyx_n_s_get;
-  PyObject *__pyx_n_s_getstate;
-  PyObject *__pyx_n_s_i;
+  PyObject *__pyx_n_s_group_arr;
   PyObject *__pyx_n_s_import;
   PyObject *__pyx_n_s_initializing;
   PyObject *__pyx_n_s_intp;
   PyObject *__pyx_n_s_is_coroutine;
-  PyObject *__pyx_n_s_is_reciprocal;
-  PyObject *__pyx_kp_u_isenabled;
-  PyObject *__pyx_n_s_jump1;
-  PyObject *__pyx_n_s_jump2;
-  PyObject *__pyx_n_s_kwargs;
   PyObject *__pyx_n_s_label;
   PyObject *__pyx_kp_u_label_default_value_for_limit1_i;
   PyObject *__pyx_kp_u_label_default_value_for_limit2_i;
   PyObject *__pyx_n_s_limit1;
   PyObject *__pyx_n_s_limit2;
   PyObject *__pyx_n_s_main;
   PyObject *__pyx_n_s_name;
   PyObject *__pyx_n_s_np;
   PyObject *__pyx_n_s_numpy;
   PyObject *__pyx_kp_u_numpy_core_multiarray_failed_to;
   PyObject *__pyx_kp_u_numpy_core_umath_failed_to_impor;
   PyObject *__pyx_n_s_ones;
-  PyObject *__pyx_n_s_p1;
-  PyObject *__pyx_n_s_p2;
-  PyObject *__pyx_n_s_pop;
+  PyObject *__pyx_n_s_precision;
   PyObject *__pyx_n_s_print;
-  PyObject *__pyx_n_s_pyx_state;
   PyObject *__pyx_n_s_pyx_vtable;
   PyObject *__pyx_n_s_range;
-  PyObject *__pyx_n_s_reduce;
-  PyObject *__pyx_n_s_reduce_cython;
-  PyObject *__pyx_n_s_reduce_ex;
+  PyObject *__pyx_n_s_ranks_arr;
   PyObject *__pyx_n_s_remove;
-  PyObject *__pyx_n_s_self;
-  PyObject *__pyx_kp_s_self_parent_cannot_be_converted;
-  PyObject *__pyx_n_s_setstate;
-  PyObject *__pyx_n_s_setstate_cython;
+  PyObject *__pyx_n_s_ret_labels;
   PyObject *__pyx_n_s_size;
   PyObject *__pyx_n_s_spec;
   PyObject *__pyx_n_s_sqrt;
-  PyObject *__pyx_kp_s_stringsource;
   PyObject *__pyx_n_s_test;
+  PyObject *__pyx_n_s_uf_arr;
   PyObject *__pyx_n_s_unique;
   PyObject *__pyx_n_s_update;
-  PyObject *__pyx_n_s_v;
   PyObject *__pyx_n_s_values_arr;
   PyObject *__pyx_kp_u_will_not_be_formed;
   PyObject *__pyx_n_s_zeros;
   PyObject *__pyx_float_0_0000001;
   PyObject *__pyx_int_0;
   PyObject *__pyx_int_1;
-  PyObject *__pyx_int_2;
   PyObject *__pyx_int_neg_1;
   PyObject *__pyx_tuple_;
   PyObject *__pyx_tuple__2;
   PyObject *__pyx_tuple__4;
   PyObject *__pyx_tuple__6;
   PyObject *__pyx_tuple__8;
-  PyObject *__pyx_tuple__10;
-  PyObject *__pyx_tuple__11;
-  PyObject *__pyx_tuple__13;
   PyObject *__pyx_codeobj__5;
   PyObject *__pyx_codeobj__7;
-  PyObject *__pyx_codeobj__9;
-  PyObject *__pyx_codeobj__12;
 } __pyx_mstate;
 
 #ifdef __cplusplus
 namespace {
   extern struct PyModuleDef __pyx_moduledef;
 } /* anonymous namespace */
 #else
@@ -3019,124 +2836,83 @@
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_unsignedinteger);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_inexact);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_floating);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_complexfloating);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_flexible);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_character);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_ufunc);
-  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation);
-  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_12_druhg_label_UnionFind);
-  Py_CLEAR(clear_module_state->__pyx_type_5druhg_12_druhg_label_UnionFind);
-  Py_CLEAR(clear_module_state->__pyx_n_s_Amalgamation);
+  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind);
+  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_12_druhg_group_Group);
+  Py_CLEAR(clear_module_state->__pyx_n_s_AssertionError);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_labels_buffer_is_too_small);
+  Py_CLEAR(clear_module_state->__pyx_n_s_Group);
   Py_CLEAR(clear_module_state->__pyx_n_s_ImportError);
-  Py_CLEAR(clear_module_state->__pyx_n_s_N);
-  Py_CLEAR(clear_module_state->__pyx_n_s_PRECISION);
-  Py_CLEAR(clear_module_state->__pyx_n_s_TypeError);
-  Py_CLEAR(clear_module_state->__pyx_n_s_U);
   Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind);
-  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind___reduce_cython);
-  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind___setstate_cython);
-  Py_CLEAR(clear_module_state->__pyx_n_s__14);
   Py_CLEAR(clear_module_state->__pyx_n_s__3);
+  Py_CLEAR(clear_module_state->__pyx_n_s__9);
+  Py_CLEAR(clear_module_state->__pyx_n_s_allocate_buffer_labels);
   Py_CLEAR(clear_module_state->__pyx_kp_u_are_considered_as_noise);
   Py_CLEAR(clear_module_state->__pyx_n_s_asyncio_coroutines);
-  Py_CLEAR(clear_module_state->__pyx_n_s_being);
-  Py_CLEAR(clear_module_state->__pyx_n_s_being1);
-  Py_CLEAR(clear_module_state->__pyx_n_s_being2);
-  Py_CLEAR(clear_module_state->__pyx_n_s_being3);
-  Py_CLEAR(clear_module_state->__pyx_n_s_c);
   Py_CLEAR(clear_module_state->__pyx_n_s_ceil);
   Py_CLEAR(clear_module_state->__pyx_n_s_cline_in_traceback);
-  Py_CLEAR(clear_module_state->__pyx_n_s_clusters);
-  Py_CLEAR(clear_module_state->__pyx_n_s_d);
-  Py_CLEAR(clear_module_state->__pyx_kp_u_disable);
-  Py_CLEAR(clear_module_state->__pyx_n_s_disc);
-  Py_CLEAR(clear_module_state->__pyx_n_u_double_precision);
-  Py_CLEAR(clear_module_state->__pyx_n_u_double_precision2);
   Py_CLEAR(clear_module_state->__pyx_n_s_druhg__druhg_label);
   Py_CLEAR(clear_module_state->__pyx_kp_s_druhg__druhg_label_pyx);
-  Py_CLEAR(clear_module_state->__pyx_n_s_druhg_amalgamation);
+  Py_CLEAR(clear_module_state->__pyx_n_s_druhg_group);
+  Py_CLEAR(clear_module_state->__pyx_n_s_druhg_unionfind);
   Py_CLEAR(clear_module_state->__pyx_n_s_dtype);
-  Py_CLEAR(clear_module_state->__pyx_n_s_e1);
-  Py_CLEAR(clear_module_state->__pyx_n_s_e2);
-  Py_CLEAR(clear_module_state->__pyx_n_s_e3);
-  Py_CLEAR(clear_module_state->__pyx_n_s_edges_arr);
-  Py_CLEAR(clear_module_state->__pyx_n_s_emerge_clusters);
-  Py_CLEAR(clear_module_state->__pyx_kp_u_enable);
-  Py_CLEAR(clear_module_state->__pyx_n_s_enumerate);
+  Py_CLEAR(clear_module_state->__pyx_n_s_edgepairs_arr);
+  Py_CLEAR(clear_module_state->__pyx_n_s_empty);
   Py_CLEAR(clear_module_state->__pyx_n_s_exclude);
+  Py_CLEAR(clear_module_state->__pyx_n_s_fill);
   Py_CLEAR(clear_module_state->__pyx_n_s_fix_outliers);
-  Py_CLEAR(clear_module_state->__pyx_kp_u_gc);
-  Py_CLEAR(clear_module_state->__pyx_n_s_get);
-  Py_CLEAR(clear_module_state->__pyx_n_s_getstate);
-  Py_CLEAR(clear_module_state->__pyx_n_s_i);
+  Py_CLEAR(clear_module_state->__pyx_n_s_group_arr);
   Py_CLEAR(clear_module_state->__pyx_n_s_import);
   Py_CLEAR(clear_module_state->__pyx_n_s_initializing);
   Py_CLEAR(clear_module_state->__pyx_n_s_intp);
   Py_CLEAR(clear_module_state->__pyx_n_s_is_coroutine);
-  Py_CLEAR(clear_module_state->__pyx_n_s_is_reciprocal);
-  Py_CLEAR(clear_module_state->__pyx_kp_u_isenabled);
-  Py_CLEAR(clear_module_state->__pyx_n_s_jump1);
-  Py_CLEAR(clear_module_state->__pyx_n_s_jump2);
-  Py_CLEAR(clear_module_state->__pyx_n_s_kwargs);
   Py_CLEAR(clear_module_state->__pyx_n_s_label);
   Py_CLEAR(clear_module_state->__pyx_kp_u_label_default_value_for_limit1_i);
   Py_CLEAR(clear_module_state->__pyx_kp_u_label_default_value_for_limit2_i);
   Py_CLEAR(clear_module_state->__pyx_n_s_limit1);
   Py_CLEAR(clear_module_state->__pyx_n_s_limit2);
   Py_CLEAR(clear_module_state->__pyx_n_s_main);
   Py_CLEAR(clear_module_state->__pyx_n_s_name);
   Py_CLEAR(clear_module_state->__pyx_n_s_np);
   Py_CLEAR(clear_module_state->__pyx_n_s_numpy);
   Py_CLEAR(clear_module_state->__pyx_kp_u_numpy_core_multiarray_failed_to);
   Py_CLEAR(clear_module_state->__pyx_kp_u_numpy_core_umath_failed_to_impor);
   Py_CLEAR(clear_module_state->__pyx_n_s_ones);
-  Py_CLEAR(clear_module_state->__pyx_n_s_p1);
-  Py_CLEAR(clear_module_state->__pyx_n_s_p2);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pop);
+  Py_CLEAR(clear_module_state->__pyx_n_s_precision);
   Py_CLEAR(clear_module_state->__pyx_n_s_print);
-  Py_CLEAR(clear_module_state->__pyx_n_s_pyx_state);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_vtable);
   Py_CLEAR(clear_module_state->__pyx_n_s_range);
-  Py_CLEAR(clear_module_state->__pyx_n_s_reduce);
-  Py_CLEAR(clear_module_state->__pyx_n_s_reduce_cython);
-  Py_CLEAR(clear_module_state->__pyx_n_s_reduce_ex);
+  Py_CLEAR(clear_module_state->__pyx_n_s_ranks_arr);
   Py_CLEAR(clear_module_state->__pyx_n_s_remove);
-  Py_CLEAR(clear_module_state->__pyx_n_s_self);
-  Py_CLEAR(clear_module_state->__pyx_kp_s_self_parent_cannot_be_converted);
-  Py_CLEAR(clear_module_state->__pyx_n_s_setstate);
-  Py_CLEAR(clear_module_state->__pyx_n_s_setstate_cython);
+  Py_CLEAR(clear_module_state->__pyx_n_s_ret_labels);
   Py_CLEAR(clear_module_state->__pyx_n_s_size);
   Py_CLEAR(clear_module_state->__pyx_n_s_spec);
   Py_CLEAR(clear_module_state->__pyx_n_s_sqrt);
-  Py_CLEAR(clear_module_state->__pyx_kp_s_stringsource);
   Py_CLEAR(clear_module_state->__pyx_n_s_test);
+  Py_CLEAR(clear_module_state->__pyx_n_s_uf_arr);
   Py_CLEAR(clear_module_state->__pyx_n_s_unique);
   Py_CLEAR(clear_module_state->__pyx_n_s_update);
-  Py_CLEAR(clear_module_state->__pyx_n_s_v);
   Py_CLEAR(clear_module_state->__pyx_n_s_values_arr);
   Py_CLEAR(clear_module_state->__pyx_kp_u_will_not_be_formed);
   Py_CLEAR(clear_module_state->__pyx_n_s_zeros);
   Py_CLEAR(clear_module_state->__pyx_float_0_0000001);
   Py_CLEAR(clear_module_state->__pyx_int_0);
   Py_CLEAR(clear_module_state->__pyx_int_1);
-  Py_CLEAR(clear_module_state->__pyx_int_2);
   Py_CLEAR(clear_module_state->__pyx_int_neg_1);
   Py_CLEAR(clear_module_state->__pyx_tuple_);
   Py_CLEAR(clear_module_state->__pyx_tuple__2);
   Py_CLEAR(clear_module_state->__pyx_tuple__4);
   Py_CLEAR(clear_module_state->__pyx_tuple__6);
   Py_CLEAR(clear_module_state->__pyx_tuple__8);
-  Py_CLEAR(clear_module_state->__pyx_tuple__10);
-  Py_CLEAR(clear_module_state->__pyx_tuple__11);
-  Py_CLEAR(clear_module_state->__pyx_tuple__13);
   Py_CLEAR(clear_module_state->__pyx_codeobj__5);
   Py_CLEAR(clear_module_state->__pyx_codeobj__7);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__9);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__12);
   return 0;
 }
 #endif
 /* #### Code section: module_state_traverse ### */
 #if CYTHON_USE_MODULE_STATE
 static int __pyx_m_traverse(PyObject *m, visitproc visit, void *arg) {
   __pyx_mstate *traverse_module_state = __pyx_mstate(m);
@@ -3165,124 +2941,83 @@
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_unsignedinteger);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_inexact);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_floating);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_complexfloating);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_flexible);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_character);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_ufunc);
-  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation);
-  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_12_druhg_label_UnionFind);
-  Py_VISIT(traverse_module_state->__pyx_type_5druhg_12_druhg_label_UnionFind);
-  Py_VISIT(traverse_module_state->__pyx_n_s_Amalgamation);
+  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind);
+  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_12_druhg_group_Group);
+  Py_VISIT(traverse_module_state->__pyx_n_s_AssertionError);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_labels_buffer_is_too_small);
+  Py_VISIT(traverse_module_state->__pyx_n_s_Group);
   Py_VISIT(traverse_module_state->__pyx_n_s_ImportError);
-  Py_VISIT(traverse_module_state->__pyx_n_s_N);
-  Py_VISIT(traverse_module_state->__pyx_n_s_PRECISION);
-  Py_VISIT(traverse_module_state->__pyx_n_s_TypeError);
-  Py_VISIT(traverse_module_state->__pyx_n_s_U);
   Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind);
-  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind___reduce_cython);
-  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind___setstate_cython);
-  Py_VISIT(traverse_module_state->__pyx_n_s__14);
   Py_VISIT(traverse_module_state->__pyx_n_s__3);
+  Py_VISIT(traverse_module_state->__pyx_n_s__9);
+  Py_VISIT(traverse_module_state->__pyx_n_s_allocate_buffer_labels);
   Py_VISIT(traverse_module_state->__pyx_kp_u_are_considered_as_noise);
   Py_VISIT(traverse_module_state->__pyx_n_s_asyncio_coroutines);
-  Py_VISIT(traverse_module_state->__pyx_n_s_being);
-  Py_VISIT(traverse_module_state->__pyx_n_s_being1);
-  Py_VISIT(traverse_module_state->__pyx_n_s_being2);
-  Py_VISIT(traverse_module_state->__pyx_n_s_being3);
-  Py_VISIT(traverse_module_state->__pyx_n_s_c);
   Py_VISIT(traverse_module_state->__pyx_n_s_ceil);
   Py_VISIT(traverse_module_state->__pyx_n_s_cline_in_traceback);
-  Py_VISIT(traverse_module_state->__pyx_n_s_clusters);
-  Py_VISIT(traverse_module_state->__pyx_n_s_d);
-  Py_VISIT(traverse_module_state->__pyx_kp_u_disable);
-  Py_VISIT(traverse_module_state->__pyx_n_s_disc);
-  Py_VISIT(traverse_module_state->__pyx_n_u_double_precision);
-  Py_VISIT(traverse_module_state->__pyx_n_u_double_precision2);
   Py_VISIT(traverse_module_state->__pyx_n_s_druhg__druhg_label);
   Py_VISIT(traverse_module_state->__pyx_kp_s_druhg__druhg_label_pyx);
-  Py_VISIT(traverse_module_state->__pyx_n_s_druhg_amalgamation);
+  Py_VISIT(traverse_module_state->__pyx_n_s_druhg_group);
+  Py_VISIT(traverse_module_state->__pyx_n_s_druhg_unionfind);
   Py_VISIT(traverse_module_state->__pyx_n_s_dtype);
-  Py_VISIT(traverse_module_state->__pyx_n_s_e1);
-  Py_VISIT(traverse_module_state->__pyx_n_s_e2);
-  Py_VISIT(traverse_module_state->__pyx_n_s_e3);
-  Py_VISIT(traverse_module_state->__pyx_n_s_edges_arr);
-  Py_VISIT(traverse_module_state->__pyx_n_s_emerge_clusters);
-  Py_VISIT(traverse_module_state->__pyx_kp_u_enable);
-  Py_VISIT(traverse_module_state->__pyx_n_s_enumerate);
+  Py_VISIT(traverse_module_state->__pyx_n_s_edgepairs_arr);
+  Py_VISIT(traverse_module_state->__pyx_n_s_empty);
   Py_VISIT(traverse_module_state->__pyx_n_s_exclude);
+  Py_VISIT(traverse_module_state->__pyx_n_s_fill);
   Py_VISIT(traverse_module_state->__pyx_n_s_fix_outliers);
-  Py_VISIT(traverse_module_state->__pyx_kp_u_gc);
-  Py_VISIT(traverse_module_state->__pyx_n_s_get);
-  Py_VISIT(traverse_module_state->__pyx_n_s_getstate);
-  Py_VISIT(traverse_module_state->__pyx_n_s_i);
+  Py_VISIT(traverse_module_state->__pyx_n_s_group_arr);
   Py_VISIT(traverse_module_state->__pyx_n_s_import);
   Py_VISIT(traverse_module_state->__pyx_n_s_initializing);
   Py_VISIT(traverse_module_state->__pyx_n_s_intp);
   Py_VISIT(traverse_module_state->__pyx_n_s_is_coroutine);
-  Py_VISIT(traverse_module_state->__pyx_n_s_is_reciprocal);
-  Py_VISIT(traverse_module_state->__pyx_kp_u_isenabled);
-  Py_VISIT(traverse_module_state->__pyx_n_s_jump1);
-  Py_VISIT(traverse_module_state->__pyx_n_s_jump2);
-  Py_VISIT(traverse_module_state->__pyx_n_s_kwargs);
   Py_VISIT(traverse_module_state->__pyx_n_s_label);
   Py_VISIT(traverse_module_state->__pyx_kp_u_label_default_value_for_limit1_i);
   Py_VISIT(traverse_module_state->__pyx_kp_u_label_default_value_for_limit2_i);
   Py_VISIT(traverse_module_state->__pyx_n_s_limit1);
   Py_VISIT(traverse_module_state->__pyx_n_s_limit2);
   Py_VISIT(traverse_module_state->__pyx_n_s_main);
   Py_VISIT(traverse_module_state->__pyx_n_s_name);
   Py_VISIT(traverse_module_state->__pyx_n_s_np);
   Py_VISIT(traverse_module_state->__pyx_n_s_numpy);
   Py_VISIT(traverse_module_state->__pyx_kp_u_numpy_core_multiarray_failed_to);
   Py_VISIT(traverse_module_state->__pyx_kp_u_numpy_core_umath_failed_to_impor);
   Py_VISIT(traverse_module_state->__pyx_n_s_ones);
-  Py_VISIT(traverse_module_state->__pyx_n_s_p1);
-  Py_VISIT(traverse_module_state->__pyx_n_s_p2);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pop);
+  Py_VISIT(traverse_module_state->__pyx_n_s_precision);
   Py_VISIT(traverse_module_state->__pyx_n_s_print);
-  Py_VISIT(traverse_module_state->__pyx_n_s_pyx_state);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_vtable);
   Py_VISIT(traverse_module_state->__pyx_n_s_range);
-  Py_VISIT(traverse_module_state->__pyx_n_s_reduce);
-  Py_VISIT(traverse_module_state->__pyx_n_s_reduce_cython);
-  Py_VISIT(traverse_module_state->__pyx_n_s_reduce_ex);
+  Py_VISIT(traverse_module_state->__pyx_n_s_ranks_arr);
   Py_VISIT(traverse_module_state->__pyx_n_s_remove);
-  Py_VISIT(traverse_module_state->__pyx_n_s_self);
-  Py_VISIT(traverse_module_state->__pyx_kp_s_self_parent_cannot_be_converted);
-  Py_VISIT(traverse_module_state->__pyx_n_s_setstate);
-  Py_VISIT(traverse_module_state->__pyx_n_s_setstate_cython);
+  Py_VISIT(traverse_module_state->__pyx_n_s_ret_labels);
   Py_VISIT(traverse_module_state->__pyx_n_s_size);
   Py_VISIT(traverse_module_state->__pyx_n_s_spec);
   Py_VISIT(traverse_module_state->__pyx_n_s_sqrt);
-  Py_VISIT(traverse_module_state->__pyx_kp_s_stringsource);
   Py_VISIT(traverse_module_state->__pyx_n_s_test);
+  Py_VISIT(traverse_module_state->__pyx_n_s_uf_arr);
   Py_VISIT(traverse_module_state->__pyx_n_s_unique);
   Py_VISIT(traverse_module_state->__pyx_n_s_update);
-  Py_VISIT(traverse_module_state->__pyx_n_s_v);
   Py_VISIT(traverse_module_state->__pyx_n_s_values_arr);
   Py_VISIT(traverse_module_state->__pyx_kp_u_will_not_be_formed);
   Py_VISIT(traverse_module_state->__pyx_n_s_zeros);
   Py_VISIT(traverse_module_state->__pyx_float_0_0000001);
   Py_VISIT(traverse_module_state->__pyx_int_0);
   Py_VISIT(traverse_module_state->__pyx_int_1);
-  Py_VISIT(traverse_module_state->__pyx_int_2);
   Py_VISIT(traverse_module_state->__pyx_int_neg_1);
   Py_VISIT(traverse_module_state->__pyx_tuple_);
   Py_VISIT(traverse_module_state->__pyx_tuple__2);
   Py_VISIT(traverse_module_state->__pyx_tuple__4);
   Py_VISIT(traverse_module_state->__pyx_tuple__6);
   Py_VISIT(traverse_module_state->__pyx_tuple__8);
-  Py_VISIT(traverse_module_state->__pyx_tuple__10);
-  Py_VISIT(traverse_module_state->__pyx_tuple__11);
-  Py_VISIT(traverse_module_state->__pyx_tuple__13);
   Py_VISIT(traverse_module_state->__pyx_codeobj__5);
   Py_VISIT(traverse_module_state->__pyx_codeobj__7);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__9);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__12);
   return 0;
 }
 #endif
 /* #### Code section: module_state_defines ### */
 #if CYTHON_USE_MODULE_STATE
 #define __pyx_d __pyx_mstate_global->__pyx_d
 #define __pyx_b __pyx_mstate_global->__pyx_b
@@ -3308,1280 +3043,295 @@
 #define __pyx_ptype_5numpy_unsignedinteger __pyx_mstate_global->__pyx_ptype_5numpy_unsignedinteger
 #define __pyx_ptype_5numpy_inexact __pyx_mstate_global->__pyx_ptype_5numpy_inexact
 #define __pyx_ptype_5numpy_floating __pyx_mstate_global->__pyx_ptype_5numpy_floating
 #define __pyx_ptype_5numpy_complexfloating __pyx_mstate_global->__pyx_ptype_5numpy_complexfloating
 #define __pyx_ptype_5numpy_flexible __pyx_mstate_global->__pyx_ptype_5numpy_flexible
 #define __pyx_ptype_5numpy_character __pyx_mstate_global->__pyx_ptype_5numpy_character
 #define __pyx_ptype_5numpy_ufunc __pyx_mstate_global->__pyx_ptype_5numpy_ufunc
-#define __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation __pyx_mstate_global->__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation
-#define __pyx_ptype_5druhg_12_druhg_label_UnionFind __pyx_mstate_global->__pyx_ptype_5druhg_12_druhg_label_UnionFind
-#define __pyx_type_5druhg_12_druhg_label_UnionFind __pyx_mstate_global->__pyx_type_5druhg_12_druhg_label_UnionFind
-#define __pyx_n_s_Amalgamation __pyx_mstate_global->__pyx_n_s_Amalgamation
+#define __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind __pyx_mstate_global->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind
+#define __pyx_ptype_5druhg_12_druhg_group_Group __pyx_mstate_global->__pyx_ptype_5druhg_12_druhg_group_Group
+#define __pyx_n_s_AssertionError __pyx_mstate_global->__pyx_n_s_AssertionError
+#define __pyx_kp_u_ERROR_labels_buffer_is_too_small __pyx_mstate_global->__pyx_kp_u_ERROR_labels_buffer_is_too_small
+#define __pyx_n_s_Group __pyx_mstate_global->__pyx_n_s_Group
 #define __pyx_n_s_ImportError __pyx_mstate_global->__pyx_n_s_ImportError
-#define __pyx_n_s_N __pyx_mstate_global->__pyx_n_s_N
-#define __pyx_n_s_PRECISION __pyx_mstate_global->__pyx_n_s_PRECISION
-#define __pyx_n_s_TypeError __pyx_mstate_global->__pyx_n_s_TypeError
-#define __pyx_n_s_U __pyx_mstate_global->__pyx_n_s_U
 #define __pyx_n_s_UnionFind __pyx_mstate_global->__pyx_n_s_UnionFind
-#define __pyx_n_s_UnionFind___reduce_cython __pyx_mstate_global->__pyx_n_s_UnionFind___reduce_cython
-#define __pyx_n_s_UnionFind___setstate_cython __pyx_mstate_global->__pyx_n_s_UnionFind___setstate_cython
-#define __pyx_n_s__14 __pyx_mstate_global->__pyx_n_s__14
 #define __pyx_n_s__3 __pyx_mstate_global->__pyx_n_s__3
+#define __pyx_n_s__9 __pyx_mstate_global->__pyx_n_s__9
+#define __pyx_n_s_allocate_buffer_labels __pyx_mstate_global->__pyx_n_s_allocate_buffer_labels
 #define __pyx_kp_u_are_considered_as_noise __pyx_mstate_global->__pyx_kp_u_are_considered_as_noise
 #define __pyx_n_s_asyncio_coroutines __pyx_mstate_global->__pyx_n_s_asyncio_coroutines
-#define __pyx_n_s_being __pyx_mstate_global->__pyx_n_s_being
-#define __pyx_n_s_being1 __pyx_mstate_global->__pyx_n_s_being1
-#define __pyx_n_s_being2 __pyx_mstate_global->__pyx_n_s_being2
-#define __pyx_n_s_being3 __pyx_mstate_global->__pyx_n_s_being3
-#define __pyx_n_s_c __pyx_mstate_global->__pyx_n_s_c
 #define __pyx_n_s_ceil __pyx_mstate_global->__pyx_n_s_ceil
 #define __pyx_n_s_cline_in_traceback __pyx_mstate_global->__pyx_n_s_cline_in_traceback
-#define __pyx_n_s_clusters __pyx_mstate_global->__pyx_n_s_clusters
-#define __pyx_n_s_d __pyx_mstate_global->__pyx_n_s_d
-#define __pyx_kp_u_disable __pyx_mstate_global->__pyx_kp_u_disable
-#define __pyx_n_s_disc __pyx_mstate_global->__pyx_n_s_disc
-#define __pyx_n_u_double_precision __pyx_mstate_global->__pyx_n_u_double_precision
-#define __pyx_n_u_double_precision2 __pyx_mstate_global->__pyx_n_u_double_precision2
 #define __pyx_n_s_druhg__druhg_label __pyx_mstate_global->__pyx_n_s_druhg__druhg_label
 #define __pyx_kp_s_druhg__druhg_label_pyx __pyx_mstate_global->__pyx_kp_s_druhg__druhg_label_pyx
-#define __pyx_n_s_druhg_amalgamation __pyx_mstate_global->__pyx_n_s_druhg_amalgamation
+#define __pyx_n_s_druhg_group __pyx_mstate_global->__pyx_n_s_druhg_group
+#define __pyx_n_s_druhg_unionfind __pyx_mstate_global->__pyx_n_s_druhg_unionfind
 #define __pyx_n_s_dtype __pyx_mstate_global->__pyx_n_s_dtype
-#define __pyx_n_s_e1 __pyx_mstate_global->__pyx_n_s_e1
-#define __pyx_n_s_e2 __pyx_mstate_global->__pyx_n_s_e2
-#define __pyx_n_s_e3 __pyx_mstate_global->__pyx_n_s_e3
-#define __pyx_n_s_edges_arr __pyx_mstate_global->__pyx_n_s_edges_arr
-#define __pyx_n_s_emerge_clusters __pyx_mstate_global->__pyx_n_s_emerge_clusters
-#define __pyx_kp_u_enable __pyx_mstate_global->__pyx_kp_u_enable
-#define __pyx_n_s_enumerate __pyx_mstate_global->__pyx_n_s_enumerate
+#define __pyx_n_s_edgepairs_arr __pyx_mstate_global->__pyx_n_s_edgepairs_arr
+#define __pyx_n_s_empty __pyx_mstate_global->__pyx_n_s_empty
 #define __pyx_n_s_exclude __pyx_mstate_global->__pyx_n_s_exclude
+#define __pyx_n_s_fill __pyx_mstate_global->__pyx_n_s_fill
 #define __pyx_n_s_fix_outliers __pyx_mstate_global->__pyx_n_s_fix_outliers
-#define __pyx_kp_u_gc __pyx_mstate_global->__pyx_kp_u_gc
-#define __pyx_n_s_get __pyx_mstate_global->__pyx_n_s_get
-#define __pyx_n_s_getstate __pyx_mstate_global->__pyx_n_s_getstate
-#define __pyx_n_s_i __pyx_mstate_global->__pyx_n_s_i
+#define __pyx_n_s_group_arr __pyx_mstate_global->__pyx_n_s_group_arr
 #define __pyx_n_s_import __pyx_mstate_global->__pyx_n_s_import
 #define __pyx_n_s_initializing __pyx_mstate_global->__pyx_n_s_initializing
 #define __pyx_n_s_intp __pyx_mstate_global->__pyx_n_s_intp
 #define __pyx_n_s_is_coroutine __pyx_mstate_global->__pyx_n_s_is_coroutine
-#define __pyx_n_s_is_reciprocal __pyx_mstate_global->__pyx_n_s_is_reciprocal
-#define __pyx_kp_u_isenabled __pyx_mstate_global->__pyx_kp_u_isenabled
-#define __pyx_n_s_jump1 __pyx_mstate_global->__pyx_n_s_jump1
-#define __pyx_n_s_jump2 __pyx_mstate_global->__pyx_n_s_jump2
-#define __pyx_n_s_kwargs __pyx_mstate_global->__pyx_n_s_kwargs
 #define __pyx_n_s_label __pyx_mstate_global->__pyx_n_s_label
 #define __pyx_kp_u_label_default_value_for_limit1_i __pyx_mstate_global->__pyx_kp_u_label_default_value_for_limit1_i
 #define __pyx_kp_u_label_default_value_for_limit2_i __pyx_mstate_global->__pyx_kp_u_label_default_value_for_limit2_i
 #define __pyx_n_s_limit1 __pyx_mstate_global->__pyx_n_s_limit1
 #define __pyx_n_s_limit2 __pyx_mstate_global->__pyx_n_s_limit2
 #define __pyx_n_s_main __pyx_mstate_global->__pyx_n_s_main
 #define __pyx_n_s_name __pyx_mstate_global->__pyx_n_s_name
 #define __pyx_n_s_np __pyx_mstate_global->__pyx_n_s_np
 #define __pyx_n_s_numpy __pyx_mstate_global->__pyx_n_s_numpy
 #define __pyx_kp_u_numpy_core_multiarray_failed_to __pyx_mstate_global->__pyx_kp_u_numpy_core_multiarray_failed_to
 #define __pyx_kp_u_numpy_core_umath_failed_to_impor __pyx_mstate_global->__pyx_kp_u_numpy_core_umath_failed_to_impor
 #define __pyx_n_s_ones __pyx_mstate_global->__pyx_n_s_ones
-#define __pyx_n_s_p1 __pyx_mstate_global->__pyx_n_s_p1
-#define __pyx_n_s_p2 __pyx_mstate_global->__pyx_n_s_p2
-#define __pyx_n_s_pop __pyx_mstate_global->__pyx_n_s_pop
+#define __pyx_n_s_precision __pyx_mstate_global->__pyx_n_s_precision
 #define __pyx_n_s_print __pyx_mstate_global->__pyx_n_s_print
-#define __pyx_n_s_pyx_state __pyx_mstate_global->__pyx_n_s_pyx_state
 #define __pyx_n_s_pyx_vtable __pyx_mstate_global->__pyx_n_s_pyx_vtable
 #define __pyx_n_s_range __pyx_mstate_global->__pyx_n_s_range
-#define __pyx_n_s_reduce __pyx_mstate_global->__pyx_n_s_reduce
-#define __pyx_n_s_reduce_cython __pyx_mstate_global->__pyx_n_s_reduce_cython
-#define __pyx_n_s_reduce_ex __pyx_mstate_global->__pyx_n_s_reduce_ex
+#define __pyx_n_s_ranks_arr __pyx_mstate_global->__pyx_n_s_ranks_arr
 #define __pyx_n_s_remove __pyx_mstate_global->__pyx_n_s_remove
-#define __pyx_n_s_self __pyx_mstate_global->__pyx_n_s_self
-#define __pyx_kp_s_self_parent_cannot_be_converted __pyx_mstate_global->__pyx_kp_s_self_parent_cannot_be_converted
-#define __pyx_n_s_setstate __pyx_mstate_global->__pyx_n_s_setstate
-#define __pyx_n_s_setstate_cython __pyx_mstate_global->__pyx_n_s_setstate_cython
+#define __pyx_n_s_ret_labels __pyx_mstate_global->__pyx_n_s_ret_labels
 #define __pyx_n_s_size __pyx_mstate_global->__pyx_n_s_size
 #define __pyx_n_s_spec __pyx_mstate_global->__pyx_n_s_spec
 #define __pyx_n_s_sqrt __pyx_mstate_global->__pyx_n_s_sqrt
-#define __pyx_kp_s_stringsource __pyx_mstate_global->__pyx_kp_s_stringsource
 #define __pyx_n_s_test __pyx_mstate_global->__pyx_n_s_test
+#define __pyx_n_s_uf_arr __pyx_mstate_global->__pyx_n_s_uf_arr
 #define __pyx_n_s_unique __pyx_mstate_global->__pyx_n_s_unique
 #define __pyx_n_s_update __pyx_mstate_global->__pyx_n_s_update
-#define __pyx_n_s_v __pyx_mstate_global->__pyx_n_s_v
 #define __pyx_n_s_values_arr __pyx_mstate_global->__pyx_n_s_values_arr
 #define __pyx_kp_u_will_not_be_formed __pyx_mstate_global->__pyx_kp_u_will_not_be_formed
 #define __pyx_n_s_zeros __pyx_mstate_global->__pyx_n_s_zeros
 #define __pyx_float_0_0000001 __pyx_mstate_global->__pyx_float_0_0000001
 #define __pyx_int_0 __pyx_mstate_global->__pyx_int_0
 #define __pyx_int_1 __pyx_mstate_global->__pyx_int_1
-#define __pyx_int_2 __pyx_mstate_global->__pyx_int_2
 #define __pyx_int_neg_1 __pyx_mstate_global->__pyx_int_neg_1
 #define __pyx_tuple_ __pyx_mstate_global->__pyx_tuple_
 #define __pyx_tuple__2 __pyx_mstate_global->__pyx_tuple__2
 #define __pyx_tuple__4 __pyx_mstate_global->__pyx_tuple__4
 #define __pyx_tuple__6 __pyx_mstate_global->__pyx_tuple__6
 #define __pyx_tuple__8 __pyx_mstate_global->__pyx_tuple__8
-#define __pyx_tuple__10 __pyx_mstate_global->__pyx_tuple__10
-#define __pyx_tuple__11 __pyx_mstate_global->__pyx_tuple__11
-#define __pyx_tuple__13 __pyx_mstate_global->__pyx_tuple__13
 #define __pyx_codeobj__5 __pyx_mstate_global->__pyx_codeobj__5
 #define __pyx_codeobj__7 __pyx_mstate_global->__pyx_codeobj__7
-#define __pyx_codeobj__9 __pyx_mstate_global->__pyx_codeobj__9
-#define __pyx_codeobj__12 __pyx_mstate_global->__pyx_codeobj__12
 #endif
 /* #### Code section: module_code ### */
 
-/* "druhg/_druhg_label.pyx":32
- *         np.intp_t full_size
+/* "druhg/_druhg_label.pyx":27
+ * from ._druhg_group cimport Group
+ * 
+ * def allocate_buffer_labels(np.intp_t size):             # <<<<<<<<<<<<<<
+ *     return np.empty(size, dtype=np.intp)
  * 
- *     def __init__(self, N):             # <<<<<<<<<<<<<<
- *         self.full_size = N
- *         self.next_label = N + 1
  */
 
 /* Python wrapper */
-static int __pyx_pw_5druhg_12_druhg_label_9UnionFind_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_5druhg_12_druhg_label_9UnionFind_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_N = 0;
+static PyObject *__pyx_pw_5druhg_12_druhg_label_1allocate_buffer_labels(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+); /*proto*/
+static PyMethodDef __pyx_mdef_5druhg_12_druhg_label_1allocate_buffer_labels = {"allocate_buffer_labels", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_1allocate_buffer_labels, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_12_druhg_label_1allocate_buffer_labels(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+) {
+  __pyx_t_5numpy_intp_t __pyx_v_size;
+  #if !CYTHON_METH_FASTCALL
   CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  #endif
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  int __pyx_r;
+  PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
+  __Pyx_RefNannySetupContext("allocate_buffer_labels (wrapper)", 0);
   {
     #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,0};
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_size,0};
     #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_size,0};
     #endif
     PyObject* values[1] = {0};
     if (__pyx_kwds) {
       Py_ssize_t kw_args;
       switch (__pyx_nargs) {
-        case  1: values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
+        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
-      kw_args = __Pyx_NumKwargs_VARARGS(__pyx_kwds);
+      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_N)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 32, __pyx_L3_error)
+        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_size)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 27, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(1, 32, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "allocate_buffer_labels") < 0)) __PYX_ERR(0, 27, __pyx_L3_error)
       }
     } else if (unlikely(__pyx_nargs != 1)) {
       goto __pyx_L5_argtuple_error;
     } else {
-      values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
+      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
     }
-    __pyx_v_N = values[0];
+    __pyx_v_size = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_size == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 27, __pyx_L3_error)
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 1, 1, 1, __pyx_nargs); __PYX_ERR(1, 32, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("allocate_buffer_labels", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 27, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_label.UnionFind.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_label.allocate_buffer_labels", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
-  return -1;
+  return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_12_druhg_label_9UnionFind___init__(((struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)__pyx_v_self), __pyx_v_N);
+  __pyx_r = __pyx_pf_5druhg_12_druhg_label_allocate_buffer_labels(__pyx_self, __pyx_v_size);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_5druhg_12_druhg_label_9UnionFind___init__(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, PyObject *__pyx_v_N) {
-  int __pyx_r;
+static PyObject *__pyx_pf_5druhg_12_druhg_label_allocate_buffer_labels(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_size) {
+  PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  __pyx_t_5numpy_intp_t __pyx_t_1;
+  PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__init__", 0);
+  __Pyx_RefNannySetupContext("allocate_buffer_labels", 0);
 
-  /* "druhg/_druhg_label.pyx":33
+  /* "druhg/_druhg_label.pyx":28
  * 
- *     def __init__(self, N):
- *         self.full_size = N             # <<<<<<<<<<<<<<
- *         self.next_label = N + 1
+ * def allocate_buffer_labels(np.intp_t size):
+ *     return np.empty(size, dtype=np.intp)             # <<<<<<<<<<<<<<
  * 
+ * cdef getIndex(UnionFind U, np.intp_t p):
  */
-  __pyx_t_1 = __Pyx_PyIndex_AsSsize_t(__pyx_v_N); if (unlikely((__pyx_t_1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 33, __pyx_L1_error)
-  __pyx_v_self->full_size = __pyx_t_1;
-
-  /* "druhg/_druhg_label.pyx":34
- *     def __init__(self, N):
- *         self.full_size = N
- *         self.next_label = N + 1             # <<<<<<<<<<<<<<
- * 
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)
- */
-  __pyx_t_2 = __Pyx_PyInt_AddObjC(__pyx_v_N, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 34, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 34, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_v_self->next_label = __pyx_t_1;
-
-  /* "druhg/_druhg_label.pyx":36
- *         self.next_label = N + 1
- * 
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)             # <<<<<<<<<<<<<<
- *         self.parent = (<np.intp_t *> self.parent_arr.data)
- * 
- */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 36, __pyx_L1_error)
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 28, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 28, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 36, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 28, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 28, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyInt_MultiplyCObj(__pyx_int_2, __pyx_v_N, 2, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 36, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 36, __pyx_L1_error)
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 28, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 28, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_2);
-  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
-  __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 36, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 36, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 28, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_intp); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 36, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(1, 36, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 36, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 28, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 28, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 36, __pyx_L1_error)
-  __Pyx_GIVEREF(__pyx_t_6);
-  __Pyx_GOTREF((PyObject *)__pyx_v_self->parent_arr);
-  __Pyx_DECREF((PyObject *)__pyx_v_self->parent_arr);
-  __pyx_v_self->parent_arr = ((PyArrayObject *)__pyx_t_6);
-  __pyx_t_6 = 0;
-
-  /* "druhg/_druhg_label.pyx":37
- * 
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)
- *         self.parent = (<np.intp_t *> self.parent_arr.data)             # <<<<<<<<<<<<<<
- * 
- *         # self._fill_structure(edges_arr, num_edges)
- */
-  __pyx_t_6 = ((PyObject *)__pyx_v_self->parent_arr);
-  __Pyx_INCREF(__pyx_t_6);
-  __pyx_v_self->parent = ((__pyx_t_5numpy_intp_t *)__pyx_f_5numpy_7ndarray_4data_data(((PyArrayObject *)__pyx_t_6)));
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_r = __pyx_t_5;
+  __pyx_t_5 = 0;
+  goto __pyx_L0;
 
-  /* "druhg/_druhg_label.pyx":32
- *         np.intp_t full_size
+  /* "druhg/_druhg_label.pyx":27
+ * from ._druhg_group cimport Group
+ * 
+ * def allocate_buffer_labels(np.intp_t size):             # <<<<<<<<<<<<<<
+ *     return np.empty(size, dtype=np.intp)
  * 
- *     def __init__(self, N):             # <<<<<<<<<<<<<<
- *         self.full_size = N
- *         self.next_label = N + 1
  */
 
   /* function exit code */
-  __pyx_r = 0;
-  goto __pyx_L0;
   __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_AddTraceback("druhg._druhg_label.UnionFind.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = -1;
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_label.pyx":41
- *         # self._fill_structure(edges_arr, num_edges)
- * 
- *     cdef np.intp_t has_parent(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         return self.parent[n]
- * 
- */
-
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_has_parent(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n) {
-  __pyx_t_5numpy_intp_t __pyx_r;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("has_parent", 0);
-
-  /* "druhg/_druhg_label.pyx":42
- * 
- *     cdef np.intp_t has_parent(self, np.intp_t n):
- *         return self.parent[n]             # <<<<<<<<<<<<<<
- * 
- *     cdef np.intp_t fast_find(self, np.intp_t n):
- */
-  __pyx_r = (__pyx_v_self->parent[__pyx_v_n]);
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_label.pyx":41
- *         # self._fill_structure(edges_arr, num_edges)
- * 
- *     cdef np.intp_t has_parent(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         return self.parent[n]
- * 
- */
-
-  /* function exit code */
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_label.pyx":44
- *         return self.parent[n]
- * 
- *     cdef np.intp_t fast_find(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp
- * 
- */
-
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_fast_find(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n) {
-  __pyx_t_5numpy_intp_t __pyx_v_p;
-  __pyx_t_5numpy_intp_t __pyx_v_temp;
-  __pyx_t_5numpy_intp_t __pyx_r;
-  __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  __Pyx_RefNannySetupContext("fast_find", 0);
-
-  /* "druhg/_druhg_label.pyx":47
- *         cdef np.intp_t p, temp
- * 
- *         p = self.parent[n]             # <<<<<<<<<<<<<<
- *         if p == 0:
- *             return n
- */
-  __pyx_v_p = (__pyx_v_self->parent[__pyx_v_n]);
-
-  /* "druhg/_druhg_label.pyx":48
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return n
- *         while self.parent[p] != 0:
- */
-  __pyx_t_1 = ((__pyx_v_p == 0) != 0);
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_label.pyx":49
- *         p = self.parent[n]
- *         if p == 0:
- *             return n             # <<<<<<<<<<<<<<
- *         while self.parent[p] != 0:
- *             p = self.parent[p]
- */
-    __pyx_r = __pyx_v_n;
-    goto __pyx_L0;
-
-    /* "druhg/_druhg_label.pyx":48
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return n
- *         while self.parent[p] != 0:
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":50
- *         if p == 0:
- *             return n
- *         while self.parent[p] != 0:             # <<<<<<<<<<<<<<
- *             p = self.parent[p]
- * 
- */
-  while (1) {
-    __pyx_t_1 = (((__pyx_v_self->parent[__pyx_v_p]) != 0) != 0);
-    if (!__pyx_t_1) break;
-
-    /* "druhg/_druhg_label.pyx":51
- *             return n
- *         while self.parent[p] != 0:
- *             p = self.parent[p]             # <<<<<<<<<<<<<<
- * 
- *         # label up to the root
- */
-    __pyx_v_p = (__pyx_v_self->parent[__pyx_v_p]);
-  }
-
-  /* "druhg/_druhg_label.pyx":54
- * 
- *         # label up to the root
- *         while p != n:             # <<<<<<<<<<<<<<
- *             temp = self.parent[n]
- *             self.parent[n] = p
- */
-  while (1) {
-    __pyx_t_1 = ((__pyx_v_p != __pyx_v_n) != 0);
-    if (!__pyx_t_1) break;
-
-    /* "druhg/_druhg_label.pyx":55
- *         # label up to the root
- *         while p != n:
- *             temp = self.parent[n]             # <<<<<<<<<<<<<<
- *             self.parent[n] = p
- *             n = temp
- */
-    __pyx_v_temp = (__pyx_v_self->parent[__pyx_v_n]);
-
-    /* "druhg/_druhg_label.pyx":56
- *         while p != n:
- *             temp = self.parent[n]
- *             self.parent[n] = p             # <<<<<<<<<<<<<<
- *             n = temp
- * 
- */
-    (__pyx_v_self->parent[__pyx_v_n]) = __pyx_v_p;
-
-    /* "druhg/_druhg_label.pyx":57
- *             temp = self.parent[n]
- *             self.parent[n] = p
- *             n = temp             # <<<<<<<<<<<<<<
- * 
- *         return p
- */
-    __pyx_v_n = __pyx_v_temp;
-  }
-
-  /* "druhg/_druhg_label.pyx":59
- *             n = temp
- * 
- *         return p             # <<<<<<<<<<<<<<
- * 
- *     cdef np.intp_t passive_find(self, np.intp_t n):
- */
-  __pyx_r = __pyx_v_p;
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_label.pyx":44
- *         return self.parent[n]
- * 
- *     cdef np.intp_t fast_find(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp
- * 
- */
-
-  /* function exit code */
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_label.pyx":61
- *         return p
- * 
- *     cdef np.intp_t passive_find(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp
- * 
- */
-
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_passive_find(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n) {
-  __pyx_t_5numpy_intp_t __pyx_v_p;
-  __pyx_t_5numpy_intp_t __pyx_r;
-  __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  __Pyx_RefNannySetupContext("passive_find", 0);
-
-  /* "druhg/_druhg_label.pyx":64
- *         cdef np.intp_t p, temp
- * 
- *         p = self.parent[n]             # <<<<<<<<<<<<<<
- *         if p == 0:
- *             return n
- */
-  __pyx_v_p = (__pyx_v_self->parent[__pyx_v_n]);
-
-  /* "druhg/_druhg_label.pyx":65
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return n
- *         while self.parent[p] != 0:
- */
-  __pyx_t_1 = ((__pyx_v_p == 0) != 0);
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_label.pyx":66
- *         p = self.parent[n]
- *         if p == 0:
- *             return n             # <<<<<<<<<<<<<<
- *         while self.parent[p] != 0:
- *             p = self.parent[p]
- */
-    __pyx_r = __pyx_v_n;
-    goto __pyx_L0;
-
-    /* "druhg/_druhg_label.pyx":65
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return n
- *         while self.parent[p] != 0:
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":67
- *         if p == 0:
- *             return n
- *         while self.parent[p] != 0:             # <<<<<<<<<<<<<<
- *             p = self.parent[p]
- * 
- */
-  while (1) {
-    __pyx_t_1 = (((__pyx_v_self->parent[__pyx_v_p]) != 0) != 0);
-    if (!__pyx_t_1) break;
-
-    /* "druhg/_druhg_label.pyx":68
- *             return n
- *         while self.parent[p] != 0:
- *             p = self.parent[p]             # <<<<<<<<<<<<<<
- * 
- *         return p
- */
-    __pyx_v_p = (__pyx_v_self->parent[__pyx_v_p]);
-  }
-
-  /* "druhg/_druhg_label.pyx":70
- *             p = self.parent[p]
- * 
- *         return p             # <<<<<<<<<<<<<<
- * 
- *     cdef np.intp_t passive_union(self, np.intp_t aa, np.intp_t bb):
- */
-  __pyx_r = __pyx_v_p;
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_label.pyx":61
- *         return p
- * 
- *     cdef np.intp_t passive_find(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp
- * 
- */
-
-  /* function exit code */
+  __Pyx_AddTraceback("druhg._druhg_label.allocate_buffer_labels", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
   __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_label.pyx":72
- *         return p
- * 
- *     cdef np.intp_t passive_union(self, np.intp_t aa, np.intp_t bb):             # <<<<<<<<<<<<<<
- *         # aa, bb = self.fast_find(aa), self.fast_find(bb)
- *         cdef np.intp_t ret
- */
-
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_passive_union(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_aa, __pyx_t_5numpy_intp_t __pyx_v_bb) {
-  __pyx_t_5numpy_intp_t __pyx_v_ret;
-  __pyx_t_5numpy_intp_t __pyx_r;
-  __Pyx_RefNannyDeclarations
-  __pyx_t_5numpy_intp_t __pyx_t_1;
-  __Pyx_RefNannySetupContext("passive_union", 0);
-
-  /* "druhg/_druhg_label.pyx":76
- *         cdef np.intp_t ret
- * 
- *         ret = self.next_label             # <<<<<<<<<<<<<<
- *         self.parent[aa] = self.parent[bb] = ret
- *         self.next_label += 1
- */
-  __pyx_t_1 = __pyx_v_self->next_label;
-  __pyx_v_ret = __pyx_t_1;
-
-  /* "druhg/_druhg_label.pyx":77
+/* "druhg/_druhg_label.pyx":30
+ *     return np.empty(size, dtype=np.intp)
  * 
- *         ret = self.next_label
- *         self.parent[aa] = self.parent[bb] = ret             # <<<<<<<<<<<<<<
- *         self.next_label += 1
- *         return ret
- */
-  (__pyx_v_self->parent[__pyx_v_aa]) = __pyx_v_ret;
-  (__pyx_v_self->parent[__pyx_v_bb]) = __pyx_v_ret;
-
-  /* "druhg/_druhg_label.pyx":78
- *         ret = self.next_label
- *         self.parent[aa] = self.parent[bb] = ret
- *         self.next_label += 1             # <<<<<<<<<<<<<<
- *         return ret
- * 
- */
-  __pyx_v_self->next_label = (__pyx_v_self->next_label + 1);
-
-  /* "druhg/_druhg_label.pyx":79
- *         self.parent[aa] = self.parent[bb] = ret
- *         self.next_label += 1
- *         return ret             # <<<<<<<<<<<<<<
- * 
- *     cdef list discard_clusters(self, np.intp_t n, set clusters):
- */
-  __pyx_r = __pyx_v_ret;
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_label.pyx":72
- *         return p
- * 
- *     cdef np.intp_t passive_union(self, np.intp_t aa, np.intp_t bb):             # <<<<<<<<<<<<<<
- *         # aa, bb = self.fast_find(aa), self.fast_find(bb)
- *         cdef np.intp_t ret
- */
-
-  /* function exit code */
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_label.pyx":81
- *         return ret
+ * cdef getIndex(UnionFind U, np.intp_t p):             # <<<<<<<<<<<<<<
+ *     return p - U.p_size - 1
  * 
- *     cdef list discard_clusters(self, np.intp_t n, set clusters):             # <<<<<<<<<<<<<<
- *         cdef:
- *             np.intp_t p, temp
  */
 
-static PyObject *__pyx_f_5druhg_12_druhg_label_9UnionFind_discard_clusters(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n, PyObject *__pyx_v_clusters) {
-  __pyx_t_5numpy_intp_t __pyx_v_p;
-  PyObject *__pyx_v_ret = 0;
+static PyObject *__pyx_f_5druhg_12_druhg_label_getIndex(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_U, __pyx_t_5numpy_intp_t __pyx_v_p) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
-  int __pyx_t_2;
-  int __pyx_t_3;
-  int __pyx_t_4;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("discard_clusters", 0);
-
-  /* "druhg/_druhg_label.pyx":86
- *             list ret
- * 
- *         ret = []             # <<<<<<<<<<<<<<
- *         p = self.parent[n]
- *         if p == 0:
- */
-  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 86, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_v_ret = ((PyObject*)__pyx_t_1);
-  __pyx_t_1 = 0;
-
-  /* "druhg/_druhg_label.pyx":87
- * 
- *         ret = []
- *         p = self.parent[n]             # <<<<<<<<<<<<<<
- *         if p == 0:
- *             return ret
- */
-  __pyx_v_p = (__pyx_v_self->parent[__pyx_v_n]);
-
-  /* "druhg/_druhg_label.pyx":88
- *         ret = []
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return ret
- *         while self.parent[p] != 0:
- */
-  __pyx_t_2 = ((__pyx_v_p == 0) != 0);
-  if (__pyx_t_2) {
-
-    /* "druhg/_druhg_label.pyx":89
- *         p = self.parent[n]
- *         if p == 0:
- *             return ret             # <<<<<<<<<<<<<<
- *         while self.parent[p] != 0:
- *             if p in clusters:
- */
-    __Pyx_XDECREF(__pyx_r);
-    __Pyx_INCREF(__pyx_v_ret);
-    __pyx_r = __pyx_v_ret;
-    goto __pyx_L0;
-
-    /* "druhg/_druhg_label.pyx":88
- *         ret = []
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return ret
- *         while self.parent[p] != 0:
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":90
- *         if p == 0:
- *             return ret
- *         while self.parent[p] != 0:             # <<<<<<<<<<<<<<
- *             if p in clusters:
- *                 ret.append(p)
- */
-  while (1) {
-    __pyx_t_2 = (((__pyx_v_self->parent[__pyx_v_p]) != 0) != 0);
-    if (!__pyx_t_2) break;
-
-    /* "druhg/_druhg_label.pyx":91
- *             return ret
- *         while self.parent[p] != 0:
- *             if p in clusters:             # <<<<<<<<<<<<<<
- *                 ret.append(p)
- *             p = self.parent[p]
- */
-    __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 91, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    if (unlikely(__pyx_v_clusters == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-      __PYX_ERR(1, 91, __pyx_L1_error)
-    }
-    __pyx_t_2 = (__Pyx_PySet_ContainsTF(__pyx_t_1, __pyx_v_clusters, Py_EQ)); if (unlikely((__pyx_t_2 < 0))) __PYX_ERR(1, 91, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_3 = (__pyx_t_2 != 0);
-    if (__pyx_t_3) {
-
-      /* "druhg/_druhg_label.pyx":92
- *         while self.parent[p] != 0:
- *             if p in clusters:
- *                 ret.append(p)             # <<<<<<<<<<<<<<
- *             p = self.parent[p]
- *         if ret:
- */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 92, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_4 = __Pyx_PyList_Append(__pyx_v_ret, __pyx_t_1); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 92, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-      /* "druhg/_druhg_label.pyx":91
- *             return ret
- *         while self.parent[p] != 0:
- *             if p in clusters:             # <<<<<<<<<<<<<<
- *                 ret.append(p)
- *             p = self.parent[p]
- */
-    }
-
-    /* "druhg/_druhg_label.pyx":93
- *             if p in clusters:
- *                 ret.append(p)
- *             p = self.parent[p]             # <<<<<<<<<<<<<<
- *         if ret:
- *             ret.pop()
- */
-    __pyx_v_p = (__pyx_v_self->parent[__pyx_v_p]);
-  }
-
-  /* "druhg/_druhg_label.pyx":94
- *                 ret.append(p)
- *             p = self.parent[p]
- *         if ret:             # <<<<<<<<<<<<<<
- *             ret.pop()
- *         return ret
- */
-  __pyx_t_3 = (PyList_GET_SIZE(__pyx_v_ret) != 0);
-  if (__pyx_t_3) {
-
-    /* "druhg/_druhg_label.pyx":95
- *             p = self.parent[p]
- *         if ret:
- *             ret.pop()             # <<<<<<<<<<<<<<
- *         return ret
- * 
- */
-    __pyx_t_1 = __Pyx_PyList_Pop(__pyx_v_ret); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 95, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-    /* "druhg/_druhg_label.pyx":94
- *                 ret.append(p)
- *             p = self.parent[p]
- *         if ret:             # <<<<<<<<<<<<<<
- *             ret.pop()
- *         return ret
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":96
- *         if ret:
- *             ret.pop()
- *         return ret             # <<<<<<<<<<<<<<
- * 
- *     cdef np.intp_t label_find(self, np.intp_t n, set clusters):
- */
-  __Pyx_XDECREF(__pyx_r);
-  __Pyx_INCREF(__pyx_v_ret);
-  __pyx_r = __pyx_v_ret;
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_label.pyx":81
- *         return ret
- * 
- *     cdef list discard_clusters(self, np.intp_t n, set clusters):             # <<<<<<<<<<<<<<
- *         cdef:
- *             np.intp_t p, temp
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("druhg._druhg_label.UnionFind.discard_clusters", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = 0;
-  __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_ret);
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_label.pyx":98
- *         return ret
- * 
- *     cdef np.intp_t label_find(self, np.intp_t n, set clusters):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp, label
- * 
- */
-
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_12_druhg_label_9UnionFind_label_find(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n, PyObject *__pyx_v_clusters) {
-  __pyx_t_5numpy_intp_t __pyx_v_p;
-  __pyx_t_5numpy_intp_t __pyx_v_temp;
-  __pyx_t_5numpy_intp_t __pyx_v_label;
-  __pyx_t_5numpy_intp_t __pyx_r;
-  __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  int __pyx_t_3;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("label_find", 0);
+  __Pyx_RefNannySetupContext("getIndex", 0);
 
-  /* "druhg/_druhg_label.pyx":101
- *         cdef np.intp_t p, temp, label
- * 
- *         label = -1             # <<<<<<<<<<<<<<
- * 
- *         p = self.parent[n]
- */
-  __pyx_v_label = -1L;
-
-  /* "druhg/_druhg_label.pyx":103
- *         label = -1
- * 
- *         p = self.parent[n]             # <<<<<<<<<<<<<<
- *         if p == 0:
- *             return label
- */
-  __pyx_v_p = (__pyx_v_self->parent[__pyx_v_n]);
-
-  /* "druhg/_druhg_label.pyx":104
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return label
- * 
- */
-  __pyx_t_1 = ((__pyx_v_p == 0) != 0);
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_label.pyx":105
- *         p = self.parent[n]
- *         if p == 0:
- *             return label             # <<<<<<<<<<<<<<
- * 
- *         if p in clusters:
- */
-    __pyx_r = __pyx_v_label;
-    goto __pyx_L0;
-
-    /* "druhg/_druhg_label.pyx":104
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return label
- * 
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":107
- *             return label
- * 
- *         if p in clusters:             # <<<<<<<<<<<<<<
- *             label = p
- *         while self.parent[p] != 0:
- */
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 107, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  if (unlikely(__pyx_v_clusters == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-    __PYX_ERR(1, 107, __pyx_L1_error)
-  }
-  __pyx_t_1 = (__Pyx_PySet_ContainsTF(__pyx_t_2, __pyx_v_clusters, Py_EQ)); if (unlikely((__pyx_t_1 < 0))) __PYX_ERR(1, 107, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_3 = (__pyx_t_1 != 0);
-  if (__pyx_t_3) {
-
-    /* "druhg/_druhg_label.pyx":108
- * 
- *         if p in clusters:
- *             label = p             # <<<<<<<<<<<<<<
- *         while self.parent[p] != 0:
- *             p = self.parent[p]
- */
-    __pyx_v_label = __pyx_v_p;
-
-    /* "druhg/_druhg_label.pyx":107
- *             return label
- * 
- *         if p in clusters:             # <<<<<<<<<<<<<<
- *             label = p
- *         while self.parent[p] != 0:
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":109
- *         if p in clusters:
- *             label = p
- *         while self.parent[p] != 0:             # <<<<<<<<<<<<<<
- *             p = self.parent[p]
- *             if p in clusters:
- */
-  while (1) {
-    __pyx_t_3 = (((__pyx_v_self->parent[__pyx_v_p]) != 0) != 0);
-    if (!__pyx_t_3) break;
-
-    /* "druhg/_druhg_label.pyx":110
- *             label = p
- *         while self.parent[p] != 0:
- *             p = self.parent[p]             # <<<<<<<<<<<<<<
- *             if p in clusters:
- *                 label = p
- */
-    __pyx_v_p = (__pyx_v_self->parent[__pyx_v_p]);
-
-    /* "druhg/_druhg_label.pyx":111
- *         while self.parent[p] != 0:
- *             p = self.parent[p]
- *             if p in clusters:             # <<<<<<<<<<<<<<
- *                 label = p
- *         if label >= 0:
- */
-    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 111, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    if (unlikely(__pyx_v_clusters == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-      __PYX_ERR(1, 111, __pyx_L1_error)
-    }
-    __pyx_t_3 = (__Pyx_PySet_ContainsTF(__pyx_t_2, __pyx_v_clusters, Py_EQ)); if (unlikely((__pyx_t_3 < 0))) __PYX_ERR(1, 111, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_1 = (__pyx_t_3 != 0);
-    if (__pyx_t_1) {
-
-      /* "druhg/_druhg_label.pyx":112
- *             p = self.parent[p]
- *             if p in clusters:
- *                 label = p             # <<<<<<<<<<<<<<
- *         if label >= 0:
- *             while label != n:
- */
-      __pyx_v_label = __pyx_v_p;
-
-      /* "druhg/_druhg_label.pyx":111
- *         while self.parent[p] != 0:
- *             p = self.parent[p]
- *             if p in clusters:             # <<<<<<<<<<<<<<
- *                 label = p
- *         if label >= 0:
- */
-    }
-  }
-
-  /* "druhg/_druhg_label.pyx":113
- *             if p in clusters:
- *                 label = p
- *         if label >= 0:             # <<<<<<<<<<<<<<
- *             while label != n:
- *                 temp = self.parent[n]
- */
-  __pyx_t_1 = ((__pyx_v_label >= 0) != 0);
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_label.pyx":114
- *                 label = p
- *         if label >= 0:
- *             while label != n:             # <<<<<<<<<<<<<<
- *                 temp = self.parent[n]
- *                 self.parent[n] = label
- */
-    while (1) {
-      __pyx_t_1 = ((__pyx_v_label != __pyx_v_n) != 0);
-      if (!__pyx_t_1) break;
-
-      /* "druhg/_druhg_label.pyx":115
- *         if label >= 0:
- *             while label != n:
- *                 temp = self.parent[n]             # <<<<<<<<<<<<<<
- *                 self.parent[n] = label
- *                 n = temp
- */
-      __pyx_v_temp = (__pyx_v_self->parent[__pyx_v_n]);
-
-      /* "druhg/_druhg_label.pyx":116
- *             while label != n:
- *                 temp = self.parent[n]
- *                 self.parent[n] = label             # <<<<<<<<<<<<<<
- *                 n = temp
- *         return label
- */
-      (__pyx_v_self->parent[__pyx_v_n]) = __pyx_v_label;
-
-      /* "druhg/_druhg_label.pyx":117
- *                 temp = self.parent[n]
- *                 self.parent[n] = label
- *                 n = temp             # <<<<<<<<<<<<<<
- *         return label
+  /* "druhg/_druhg_label.pyx":31
  * 
- */
-      __pyx_v_n = __pyx_v_temp;
-    }
-
-    /* "druhg/_druhg_label.pyx":113
- *             if p in clusters:
- *                 label = p
- *         if label >= 0:             # <<<<<<<<<<<<<<
- *             while label != n:
- *                 temp = self.parent[n]
- */
-  }
-
-  /* "druhg/_druhg_label.pyx":118
- *                 self.parent[n] = label
- *                 n = temp
- *         return label             # <<<<<<<<<<<<<<
+ * cdef getIndex(UnionFind U, np.intp_t p):
+ *     return p - U.p_size - 1             # <<<<<<<<<<<<<<
  * 
  * cdef void fixem(np.ndarray edges_arr, np.intp_t num_edges, np.ndarray result):
  */
-  __pyx_r = __pyx_v_label;
+  __Pyx_XDECREF(__pyx_r);
+  __pyx_t_1 = PyInt_FromSsize_t(((__pyx_v_p - __pyx_v_U->p_size) - 1)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 31, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_r = __pyx_t_1;
+  __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_label.pyx":98
- *         return ret
+  /* "druhg/_druhg_label.pyx":30
+ *     return np.empty(size, dtype=np.intp)
  * 
- *     cdef np.intp_t label_find(self, np.intp_t n, set clusters):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp, label
+ * cdef getIndex(UnionFind U, np.intp_t p):             # <<<<<<<<<<<<<<
+ *     return p - U.p_size - 1
  * 
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_WriteUnraisable("druhg._druhg_label.UnionFind.label_find", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("druhg._druhg_label.getIndex", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_5druhg_12_druhg_label_9UnionFind_3__reduce_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_12_druhg_label_9UnionFind_3__reduce_cython__ = {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_9UnionFind_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_12_druhg_label_9UnionFind_3__reduce_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-) {
-  #if !CYTHON_METH_FASTCALL
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  #endif
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  if (unlikely(__pyx_nargs > 0)) {
-    __Pyx_RaiseArgtupleInvalid("__reduce_cython__", 1, 0, 0, __pyx_nargs); return NULL;}
-  if (unlikely(__pyx_kwds) && __Pyx_NumKwargs_FASTCALL(__pyx_kwds) && unlikely(!__Pyx_CheckKeywordStrings(__pyx_kwds, "__reduce_cython__", 0))) return NULL;
-  __pyx_r = __pyx_pf_5druhg_12_druhg_label_9UnionFind_2__reduce_cython__(((struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)__pyx_v_self));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_5druhg_12_druhg_label_9UnionFind_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
-
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-  __Pyx_Raise(__pyx_builtin_TypeError, __pyx_kp_s_self_parent_cannot_be_converted, 0, 0);
-  __PYX_ERR(0, 2, __pyx_L1_error)
-
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_AddTraceback("druhg._druhg_label.UnionFind.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_5druhg_12_druhg_label_9UnionFind_5__setstate_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_12_druhg_label_9UnionFind_5__setstate_cython__ = {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_9UnionFind_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_12_druhg_label_9UnionFind_5__setstate_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-) {
-  CYTHON_UNUSED PyObject *__pyx_v___pyx_state = 0;
-  #if !CYTHON_METH_FASTCALL
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  #endif
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  {
-    #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_state,0};
-    #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_state,0};
-    #endif
-    PyObject* values[1] = {0};
-    if (__pyx_kwds) {
-      Py_ssize_t kw_args;
-      switch (__pyx_nargs) {
-        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-        CYTHON_FALLTHROUGH;
-        case  0: break;
-        default: goto __pyx_L5_argtuple_error;
-      }
-      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
-      switch (__pyx_nargs) {
-        case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_pyx_state)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 3, __pyx_L3_error)
-        else goto __pyx_L5_argtuple_error;
-      }
-      if (unlikely(kw_args > 0)) {
-        const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__setstate_cython__") < 0)) __PYX_ERR(0, 3, __pyx_L3_error)
-      }
-    } else if (unlikely(__pyx_nargs != 1)) {
-      goto __pyx_L5_argtuple_error;
-    } else {
-      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-    }
-    __pyx_v___pyx_state = values[0];
-  }
-  goto __pyx_L4_argument_unpacking_done;
-  __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__setstate_cython__", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 3, __pyx_L3_error)
-  __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_label.UnionFind.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __Pyx_RefNannyFinishContext();
-  return NULL;
-  __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_12_druhg_label_9UnionFind_4__setstate_cython__(((struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)__pyx_v_self), __pyx_v___pyx_state);
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_5druhg_12_druhg_label_9UnionFind_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
-
-  /* "(tree fragment)":4
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"             # <<<<<<<<<<<<<<
- */
-  __Pyx_Raise(__pyx_builtin_TypeError, __pyx_kp_s_self_parent_cannot_be_converted, 0, 0);
-  __PYX_ERR(0, 4, __pyx_L1_error)
-
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_AddTraceback("druhg._druhg_label.UnionFind.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_label.pyx":120
- *         return label
+/* "druhg/_druhg_label.pyx":33
+ *     return p - U.p_size - 1
  * 
  * cdef void fixem(np.ndarray edges_arr, np.intp_t num_edges, np.ndarray result):             # <<<<<<<<<<<<<<
  *     cdef:
  *         np.intp_t p, a, b, dontstop
  */
 
 static void __pyx_f_5druhg_12_druhg_label_fixem(PyArrayObject *__pyx_v_edges_arr, __pyx_t_5numpy_intp_t __pyx_v_num_edges, PyArrayObject *__pyx_v_result) {
@@ -4612,527 +3362,526 @@
   PyObject *(*__pyx_t_14)(PyObject *);
   int __pyx_t_15;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("fixem", 0);
 
-  /* "druhg/_druhg_label.pyx":126
+  /* "druhg/_druhg_label.pyx":39
  *         list new_path, restart
  * 
  *     new_results = set()             # <<<<<<<<<<<<<<
  *     new_path = []
  *     restart = []
  */
-  __pyx_t_1 = PySet_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 126, __pyx_L1_error)
+  __pyx_t_1 = PySet_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 39, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_v_new_results = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_label.pyx":127
+  /* "druhg/_druhg_label.pyx":40
  * 
  *     new_results = set()
  *     new_path = []             # <<<<<<<<<<<<<<
  *     restart = []
  *     for p in range(0, num_edges):
  */
-  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 127, __pyx_L1_error)
+  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_v_new_path = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_label.pyx":128
+  /* "druhg/_druhg_label.pyx":41
  *     new_results = set()
  *     new_path = []
  *     restart = []             # <<<<<<<<<<<<<<
  *     for p in range(0, num_edges):
  *         a, b = edges_arr[2*p], edges_arr[2*p + 1]
  */
-  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 128, __pyx_L1_error)
+  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 41, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_v_restart = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_label.pyx":129
+  /* "druhg/_druhg_label.pyx":42
  *     new_path = []
  *     restart = []
  *     for p in range(0, num_edges):             # <<<<<<<<<<<<<<
  *         a, b = edges_arr[2*p], edges_arr[2*p + 1]
  *         if result[a] < 0 and result[b] < 0:
  */
   __pyx_t_2 = __pyx_v_num_edges;
   __pyx_t_3 = __pyx_t_2;
   for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
     __pyx_v_p = __pyx_t_4;
 
-    /* "druhg/_druhg_label.pyx":130
+    /* "druhg/_druhg_label.pyx":43
  *     restart = []
  *     for p in range(0, num_edges):
  *         a, b = edges_arr[2*p], edges_arr[2*p + 1]             # <<<<<<<<<<<<<<
  *         if result[a] < 0 and result[b] < 0:
  *             new_results.update([a,b])
  */
     __pyx_t_5 = (2 * __pyx_v_p);
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_edges_arr), __pyx_t_5, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 130, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_edges_arr), __pyx_t_5, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 43, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_5 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 130, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_5 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 43, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_t_6 = ((2 * __pyx_v_p) + 1);
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_edges_arr), __pyx_t_6, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 130, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_edges_arr), __pyx_t_6, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 43, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 130, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 43, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_v_a = __pyx_t_5;
     __pyx_v_b = __pyx_t_6;
 
-    /* "druhg/_druhg_label.pyx":131
+    /* "druhg/_druhg_label.pyx":44
  *     for p in range(0, num_edges):
  *         a, b = edges_arr[2*p], edges_arr[2*p + 1]
  *         if result[a] < 0 and result[b] < 0:             # <<<<<<<<<<<<<<
  *             new_results.update([a,b])
  *             new_path.append((a,b))
  */
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 131, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_8 = PyObject_RichCompare(__pyx_t_1, __pyx_int_0, Py_LT); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 131, __pyx_L1_error)
+    __pyx_t_8 = PyObject_RichCompare(__pyx_t_1, __pyx_int_0, Py_LT); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely((__pyx_t_9 < 0))) __PYX_ERR(1, 131, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely((__pyx_t_9 < 0))) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     if (__pyx_t_9) {
     } else {
       __pyx_t_7 = __pyx_t_9;
       goto __pyx_L6_bool_binop_done;
     }
-    __pyx_t_8 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 131, __pyx_L1_error)
+    __pyx_t_8 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
-    __pyx_t_1 = PyObject_RichCompare(__pyx_t_8, __pyx_int_0, Py_LT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 131, __pyx_L1_error)
+    __pyx_t_1 = PyObject_RichCompare(__pyx_t_8, __pyx_int_0, Py_LT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_9 < 0))) __PYX_ERR(1, 131, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_9 < 0))) __PYX_ERR(0, 44, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_t_7 = __pyx_t_9;
     __pyx_L6_bool_binop_done:;
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_label.pyx":132
+      /* "druhg/_druhg_label.pyx":45
  *         a, b = edges_arr[2*p], edges_arr[2*p + 1]
  *         if result[a] < 0 and result[b] < 0:
  *             new_results.update([a,b])             # <<<<<<<<<<<<<<
  *             new_path.append((a,b))
  *             continue
  */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 132, __pyx_L1_error)
+      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 45, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 132, __pyx_L1_error)
+      __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 45, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
-      __pyx_t_10 = PyList_New(2); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 132, __pyx_L1_error)
+      __pyx_t_10 = PyList_New(2); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 45, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
       __Pyx_GIVEREF(__pyx_t_1);
       PyList_SET_ITEM(__pyx_t_10, 0, __pyx_t_1);
       __Pyx_GIVEREF(__pyx_t_8);
       PyList_SET_ITEM(__pyx_t_10, 1, __pyx_t_8);
       __pyx_t_1 = 0;
       __pyx_t_8 = 0;
-      __pyx_t_8 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PySet_Type_update, __pyx_v_new_results, __pyx_t_10); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 132, __pyx_L1_error)
+      __pyx_t_8 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PySet_Type_update, __pyx_v_new_results, __pyx_t_10); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 45, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-      /* "druhg/_druhg_label.pyx":133
+      /* "druhg/_druhg_label.pyx":46
  *         if result[a] < 0 and result[b] < 0:
  *             new_results.update([a,b])
  *             new_path.append((a,b))             # <<<<<<<<<<<<<<
  *             continue
  *         elif result[b] < 0:
  */
-      __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 133, __pyx_L1_error)
+      __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 46, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
-      __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 133, __pyx_L1_error)
+      __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 46, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 133, __pyx_L1_error)
+      __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       __Pyx_GIVEREF(__pyx_t_8);
       PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_8);
       __Pyx_GIVEREF(__pyx_t_10);
       PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_10);
       __pyx_t_8 = 0;
       __pyx_t_10 = 0;
-      __pyx_t_11 = __Pyx_PyList_Append(__pyx_v_new_path, __pyx_t_1); if (unlikely(__pyx_t_11 == ((int)-1))) __PYX_ERR(1, 133, __pyx_L1_error)
+      __pyx_t_11 = __Pyx_PyList_Append(__pyx_v_new_path, __pyx_t_1); if (unlikely(__pyx_t_11 == ((int)-1))) __PYX_ERR(0, 46, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-      /* "druhg/_druhg_label.pyx":134
+      /* "druhg/_druhg_label.pyx":47
  *             new_results.update([a,b])
  *             new_path.append((a,b))
  *             continue             # <<<<<<<<<<<<<<
  *         elif result[b] < 0:
  *             a,b = b,a
  */
       goto __pyx_L3_continue;
 
-      /* "druhg/_druhg_label.pyx":131
+      /* "druhg/_druhg_label.pyx":44
  *     for p in range(0, num_edges):
  *         a, b = edges_arr[2*p], edges_arr[2*p + 1]
  *         if result[a] < 0 and result[b] < 0:             # <<<<<<<<<<<<<<
  *             new_results.update([a,b])
  *             new_path.append((a,b))
  */
     }
 
-    /* "druhg/_druhg_label.pyx":135
+    /* "druhg/_druhg_label.pyx":48
  *             new_path.append((a,b))
  *             continue
  *         elif result[b] < 0:             # <<<<<<<<<<<<<<
  *             a,b = b,a
  *         elif result[a] >= 0:
  */
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 135, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 48, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_10 = PyObject_RichCompare(__pyx_t_1, __pyx_int_0, Py_LT); __Pyx_XGOTREF(__pyx_t_10); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 135, __pyx_L1_error)
+    __pyx_t_10 = PyObject_RichCompare(__pyx_t_1, __pyx_int_0, Py_LT); __Pyx_XGOTREF(__pyx_t_10); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 48, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_t_10); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(1, 135, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_t_10); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(0, 48, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_label.pyx":136
+      /* "druhg/_druhg_label.pyx":49
  *             continue
  *         elif result[b] < 0:
  *             a,b = b,a             # <<<<<<<<<<<<<<
  *         elif result[a] >= 0:
  *             continue
  */
       __pyx_t_6 = __pyx_v_b;
       __pyx_t_5 = __pyx_v_a;
       __pyx_v_a = __pyx_t_6;
       __pyx_v_b = __pyx_t_5;
 
-      /* "druhg/_druhg_label.pyx":135
+      /* "druhg/_druhg_label.pyx":48
  *             new_path.append((a,b))
  *             continue
  *         elif result[b] < 0:             # <<<<<<<<<<<<<<
  *             a,b = b,a
  *         elif result[a] >= 0:
  */
       goto __pyx_L5;
     }
 
-    /* "druhg/_druhg_label.pyx":137
+    /* "druhg/_druhg_label.pyx":50
  *         elif result[b] < 0:
  *             a,b = b,a
  *         elif result[a] >= 0:             # <<<<<<<<<<<<<<
  *             continue
  *         res = result[b]
  */
-    __pyx_t_10 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 137, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 50, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_1 = PyObject_RichCompare(__pyx_t_10, __pyx_int_0, Py_GE); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 137, __pyx_L1_error)
+    __pyx_t_1 = PyObject_RichCompare(__pyx_t_10, __pyx_int_0, Py_GE); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 50, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(1, 137, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(0, 50, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_label.pyx":138
+      /* "druhg/_druhg_label.pyx":51
  *             a,b = b,a
  *         elif result[a] >= 0:
  *             continue             # <<<<<<<<<<<<<<
  *         res = result[b]
  *         result[a] = res
  */
       goto __pyx_L3_continue;
 
-      /* "druhg/_druhg_label.pyx":137
+      /* "druhg/_druhg_label.pyx":50
  *         elif result[b] < 0:
  *             a,b = b,a
  *         elif result[a] >= 0:             # <<<<<<<<<<<<<<
  *             continue
  *         res = result[b]
  */
     }
     __pyx_L5:;
 
-    /* "druhg/_druhg_label.pyx":139
+    /* "druhg/_druhg_label.pyx":52
  *         elif result[a] >= 0:
  *             continue
  *         res = result[b]             # <<<<<<<<<<<<<<
  *         result[a] = res
  *         if a in new_results:
  */
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 139, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 52, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_XDECREF_SET(__pyx_v_res, __pyx_t_1);
     __pyx_t_1 = 0;
 
-    /* "druhg/_druhg_label.pyx":140
+    /* "druhg/_druhg_label.pyx":53
  *             continue
  *         res = result[b]
  *         result[a] = res             # <<<<<<<<<<<<<<
  *         if a in new_results:
- *             links = set([a])
+ *             links = set(a)
  */
-    if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_v_res, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(1, 140, __pyx_L1_error)
+    if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_v_res, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 53, __pyx_L1_error)
 
-    /* "druhg/_druhg_label.pyx":141
+    /* "druhg/_druhg_label.pyx":54
  *         res = result[b]
  *         result[a] = res
  *         if a in new_results:             # <<<<<<<<<<<<<<
- *             links = set([a])
+ *             links = set(a)
  *             dontstop = 1
  */
-    __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 141, __pyx_L1_error)
+    __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 54, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_7 = (__Pyx_PySet_ContainsTF(__pyx_t_1, __pyx_v_new_results, Py_EQ)); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(1, 141, __pyx_L1_error)
+    __pyx_t_7 = (__Pyx_PySet_ContainsTF(__pyx_t_1, __pyx_v_new_results, Py_EQ)); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(0, 54, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_t_9 = (__pyx_t_7 != 0);
     if (__pyx_t_9) {
 
-      /* "druhg/_druhg_label.pyx":142
+      /* "druhg/_druhg_label.pyx":55
  *         result[a] = res
  *         if a in new_results:
- *             links = set([a])             # <<<<<<<<<<<<<<
+ *             links = set(a)             # <<<<<<<<<<<<<<
  *             dontstop = 1
  *             while dontstop:
  */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 142, __pyx_L1_error)
+      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 55, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_10 = PySet_New(0); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 142, __pyx_L1_error)
+      __pyx_t_10 = PySet_New(__pyx_t_1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 55, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      if (PySet_Add(__pyx_t_10, __pyx_t_1) < 0) __PYX_ERR(1, 142, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       __Pyx_XDECREF_SET(__pyx_v_links, ((PyObject*)__pyx_t_10));
       __pyx_t_10 = 0;
 
-      /* "druhg/_druhg_label.pyx":143
+      /* "druhg/_druhg_label.pyx":56
  *         if a in new_results:
- *             links = set([a])
+ *             links = set(a)
  *             dontstop = 1             # <<<<<<<<<<<<<<
  *             while dontstop:
  *                 dontstop = 0
  */
       __pyx_v_dontstop = 1;
 
-      /* "druhg/_druhg_label.pyx":144
- *             links = set([a])
+      /* "druhg/_druhg_label.pyx":57
+ *             links = set(a)
  *             dontstop = 1
  *             while dontstop:             # <<<<<<<<<<<<<<
  *                 dontstop = 0
  *                 for path in list(new_path):
  */
       while (1) {
         __pyx_t_9 = (__pyx_v_dontstop != 0);
         if (!__pyx_t_9) break;
 
-        /* "druhg/_druhg_label.pyx":145
+        /* "druhg/_druhg_label.pyx":58
  *             dontstop = 1
  *             while dontstop:
  *                 dontstop = 0             # <<<<<<<<<<<<<<
  *                 for path in list(new_path):
  *                     a, b = path
  */
         __pyx_v_dontstop = 0;
 
-        /* "druhg/_druhg_label.pyx":146
+        /* "druhg/_druhg_label.pyx":59
  *             while dontstop:
  *                 dontstop = 0
  *                 for path in list(new_path):             # <<<<<<<<<<<<<<
  *                     a, b = path
  *                     if a in links or b in links:
  */
-        __pyx_t_10 = PySequence_List(__pyx_v_new_path); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 146, __pyx_L1_error)
+        __pyx_t_10 = PySequence_List(__pyx_v_new_path); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 59, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_10);
         __pyx_t_1 = __pyx_t_10; __Pyx_INCREF(__pyx_t_1); __pyx_t_12 = 0;
         __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
         for (;;) {
           if (__pyx_t_12 >= PyList_GET_SIZE(__pyx_t_1)) break;
           #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-          __pyx_t_10 = PyList_GET_ITEM(__pyx_t_1, __pyx_t_12); __Pyx_INCREF(__pyx_t_10); __pyx_t_12++; if (unlikely((0 < 0))) __PYX_ERR(1, 146, __pyx_L1_error)
+          __pyx_t_10 = PyList_GET_ITEM(__pyx_t_1, __pyx_t_12); __Pyx_INCREF(__pyx_t_10); __pyx_t_12++; if (unlikely((0 < 0))) __PYX_ERR(0, 59, __pyx_L1_error)
           #else
-          __pyx_t_10 = PySequence_ITEM(__pyx_t_1, __pyx_t_12); __pyx_t_12++; if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 146, __pyx_L1_error)
+          __pyx_t_10 = PySequence_ITEM(__pyx_t_1, __pyx_t_12); __pyx_t_12++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 59, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_10);
           #endif
           __Pyx_XDECREF_SET(__pyx_v_path, __pyx_t_10);
           __pyx_t_10 = 0;
 
-          /* "druhg/_druhg_label.pyx":147
+          /* "druhg/_druhg_label.pyx":60
  *                 dontstop = 0
  *                 for path in list(new_path):
  *                     a, b = path             # <<<<<<<<<<<<<<
  *                     if a in links or b in links:
  *                         result[a] = result[b] = res
  */
           if ((likely(PyTuple_CheckExact(__pyx_v_path))) || (PyList_CheckExact(__pyx_v_path))) {
             PyObject* sequence = __pyx_v_path;
             Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
             if (unlikely(size != 2)) {
               if (size > 2) __Pyx_RaiseTooManyValuesError(2);
               else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-              __PYX_ERR(1, 147, __pyx_L1_error)
+              __PYX_ERR(0, 60, __pyx_L1_error)
             }
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
             if (likely(PyTuple_CheckExact(sequence))) {
               __pyx_t_10 = PyTuple_GET_ITEM(sequence, 0); 
               __pyx_t_8 = PyTuple_GET_ITEM(sequence, 1); 
             } else {
               __pyx_t_10 = PyList_GET_ITEM(sequence, 0); 
               __pyx_t_8 = PyList_GET_ITEM(sequence, 1); 
             }
             __Pyx_INCREF(__pyx_t_10);
             __Pyx_INCREF(__pyx_t_8);
             #else
-            __pyx_t_10 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 147, __pyx_L1_error)
+            __pyx_t_10 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 60, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_10);
-            __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 147, __pyx_L1_error)
+            __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 60, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_8);
             #endif
           } else {
             Py_ssize_t index = -1;
-            __pyx_t_13 = PyObject_GetIter(__pyx_v_path); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 147, __pyx_L1_error)
+            __pyx_t_13 = PyObject_GetIter(__pyx_v_path); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 60, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_13);
             __pyx_t_14 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_13);
             index = 0; __pyx_t_10 = __pyx_t_14(__pyx_t_13); if (unlikely(!__pyx_t_10)) goto __pyx_L13_unpacking_failed;
             __Pyx_GOTREF(__pyx_t_10);
             index = 1; __pyx_t_8 = __pyx_t_14(__pyx_t_13); if (unlikely(!__pyx_t_8)) goto __pyx_L13_unpacking_failed;
             __Pyx_GOTREF(__pyx_t_8);
-            if (__Pyx_IternextUnpackEndCheck(__pyx_t_14(__pyx_t_13), 2) < 0) __PYX_ERR(1, 147, __pyx_L1_error)
+            if (__Pyx_IternextUnpackEndCheck(__pyx_t_14(__pyx_t_13), 2) < 0) __PYX_ERR(0, 60, __pyx_L1_error)
             __pyx_t_14 = NULL;
             __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
             goto __pyx_L14_unpacking_done;
             __pyx_L13_unpacking_failed:;
             __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
             __pyx_t_14 = NULL;
             if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-            __PYX_ERR(1, 147, __pyx_L1_error)
+            __PYX_ERR(0, 60, __pyx_L1_error)
             __pyx_L14_unpacking_done:;
           }
-          __pyx_t_5 = __Pyx_PyIndex_AsSsize_t(__pyx_t_10); if (unlikely((__pyx_t_5 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 147, __pyx_L1_error)
+          __pyx_t_5 = __Pyx_PyIndex_AsSsize_t(__pyx_t_10); if (unlikely((__pyx_t_5 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 60, __pyx_L1_error)
           __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-          __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_8); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 147, __pyx_L1_error)
+          __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_8); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 60, __pyx_L1_error)
           __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
           __pyx_v_a = __pyx_t_5;
           __pyx_v_b = __pyx_t_6;
 
-          /* "druhg/_druhg_label.pyx":148
+          /* "druhg/_druhg_label.pyx":61
  *                 for path in list(new_path):
  *                     a, b = path
  *                     if a in links or b in links:             # <<<<<<<<<<<<<<
  *                         result[a] = result[b] = res
  *                         # print ('new_r', a, b, res)
  */
-          __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 148, __pyx_L1_error)
+          __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 61, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_8);
-          __pyx_t_7 = (__Pyx_PySet_ContainsTF(__pyx_t_8, __pyx_v_links, Py_EQ)); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(1, 148, __pyx_L1_error)
+          __pyx_t_7 = (__Pyx_PySet_ContainsTF(__pyx_t_8, __pyx_v_links, Py_EQ)); if (unlikely((__pyx_t_7 < 0))) __PYX_ERR(0, 61, __pyx_L1_error)
           __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
           __pyx_t_15 = (__pyx_t_7 != 0);
           if (!__pyx_t_15) {
           } else {
             __pyx_t_9 = __pyx_t_15;
             goto __pyx_L16_bool_binop_done;
           }
-          __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 148, __pyx_L1_error)
+          __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 61, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_8);
-          __pyx_t_15 = (__Pyx_PySet_ContainsTF(__pyx_t_8, __pyx_v_links, Py_EQ)); if (unlikely((__pyx_t_15 < 0))) __PYX_ERR(1, 148, __pyx_L1_error)
+          __pyx_t_15 = (__Pyx_PySet_ContainsTF(__pyx_t_8, __pyx_v_links, Py_EQ)); if (unlikely((__pyx_t_15 < 0))) __PYX_ERR(0, 61, __pyx_L1_error)
           __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
           __pyx_t_7 = (__pyx_t_15 != 0);
           __pyx_t_9 = __pyx_t_7;
           __pyx_L16_bool_binop_done:;
           if (__pyx_t_9) {
 
-            /* "druhg/_druhg_label.pyx":149
+            /* "druhg/_druhg_label.pyx":62
  *                     a, b = path
  *                     if a in links or b in links:
  *                         result[a] = result[b] = res             # <<<<<<<<<<<<<<
  *                         # print ('new_r', a, b, res)
  *                         links.update([a,b])
  */
-            if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_v_res, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(1, 149, __pyx_L1_error)
-            if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_v_res, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(1, 149, __pyx_L1_error)
+            if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_result), __pyx_v_a, __pyx_v_res, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 62, __pyx_L1_error)
+            if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_result), __pyx_v_b, __pyx_v_res, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 62, __pyx_L1_error)
 
-            /* "druhg/_druhg_label.pyx":151
+            /* "druhg/_druhg_label.pyx":64
  *                         result[a] = result[b] = res
  *                         # print ('new_r', a, b, res)
  *                         links.update([a,b])             # <<<<<<<<<<<<<<
  *                         new_path.remove(path)
  *                         dontstop = 1
  */
-            __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 151, __pyx_L1_error)
+            __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 64, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_8);
-            __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 151, __pyx_L1_error)
+            __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 64, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_10);
-            __pyx_t_13 = PyList_New(2); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 151, __pyx_L1_error)
+            __pyx_t_13 = PyList_New(2); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 64, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_13);
             __Pyx_GIVEREF(__pyx_t_8);
             PyList_SET_ITEM(__pyx_t_13, 0, __pyx_t_8);
             __Pyx_GIVEREF(__pyx_t_10);
             PyList_SET_ITEM(__pyx_t_13, 1, __pyx_t_10);
             __pyx_t_8 = 0;
             __pyx_t_10 = 0;
-            __pyx_t_10 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PySet_Type_update, __pyx_v_links, __pyx_t_13); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 151, __pyx_L1_error)
+            __pyx_t_10 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PySet_Type_update, __pyx_v_links, __pyx_t_13); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 64, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_10);
             __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
             __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-            /* "druhg/_druhg_label.pyx":152
+            /* "druhg/_druhg_label.pyx":65
  *                         # print ('new_r', a, b, res)
  *                         links.update([a,b])
  *                         new_path.remove(path)             # <<<<<<<<<<<<<<
  *                         dontstop = 1
  * 
  */
-            __pyx_t_10 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyList_Type_remove, __pyx_v_new_path, __pyx_v_path); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 152, __pyx_L1_error)
+            __pyx_t_10 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyList_Type_remove, __pyx_v_new_path, __pyx_v_path); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 65, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_10);
             __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-            /* "druhg/_druhg_label.pyx":153
+            /* "druhg/_druhg_label.pyx":66
  *                         links.update([a,b])
  *                         new_path.remove(path)
  *                         dontstop = 1             # <<<<<<<<<<<<<<
  * 
  *     return
  */
             __pyx_v_dontstop = 1;
 
-            /* "druhg/_druhg_label.pyx":148
+            /* "druhg/_druhg_label.pyx":61
  *                 for path in list(new_path):
  *                     a, b = path
  *                     if a in links or b in links:             # <<<<<<<<<<<<<<
  *                         result[a] = result[b] = res
  *                         # print ('new_r', a, b, res)
  */
           }
 
-          /* "druhg/_druhg_label.pyx":146
+          /* "druhg/_druhg_label.pyx":59
  *             while dontstop:
  *                 dontstop = 0
  *                 for path in list(new_path):             # <<<<<<<<<<<<<<
  *                     a, b = path
  *                     if a in links or b in links:
  */
         }
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       }
 
-      /* "druhg/_druhg_label.pyx":141
+      /* "druhg/_druhg_label.pyx":54
  *         res = result[b]
  *         result[a] = res
  *         if a in new_results:             # <<<<<<<<<<<<<<
- *             links = set([a])
+ *             links = set(a)
  *             dontstop = 1
  */
     }
     __pyx_L3_continue:;
   }
 
-  /* "druhg/_druhg_label.pyx":155
+  /* "druhg/_druhg_label.pyx":68
  *                         dontstop = 1
  * 
  *     return             # <<<<<<<<<<<<<<
  * 
- * def emerge_clusters(UnionFind U, np.ndarray edges_arr, np.ndarray values_arr, np.intp_t limit1, np.intp_t limit2, \
+ * cdef mark_labels(UnionFind U, dict clusters, np.ndarray ret_labels):
  */
   goto __pyx_L0;
 
-  /* "druhg/_druhg_label.pyx":120
- *         return label
+  /* "druhg/_druhg_label.pyx":33
+ *     return p - U.p_size - 1
  * 
  * cdef void fixem(np.ndarray edges_arr, np.intp_t num_edges, np.ndarray result):             # <<<<<<<<<<<<<<
  *     cdef:
  *         np.intp_t p, a, b, dontstop
  */
 
   /* function exit code */
@@ -5148,1051 +3897,983 @@
   __Pyx_XDECREF(__pyx_v_new_path);
   __Pyx_XDECREF(__pyx_v_restart);
   __Pyx_XDECREF(__pyx_v_res);
   __Pyx_XDECREF(__pyx_v_path);
   __Pyx_RefNannyFinishContext();
 }
 
-/* "druhg/_druhg_label.pyx":157
+/* "druhg/_druhg_label.pyx":70
  *     return
  * 
- * def emerge_clusters(UnionFind U, np.ndarray edges_arr, np.ndarray values_arr, np.intp_t limit1, np.intp_t limit2, \             # <<<<<<<<<<<<<<
- *                     list exclude, is_reciprocal = 1, **kwargs):
- * 
+ * cdef mark_labels(UnionFind U, dict clusters, np.ndarray ret_labels):             # <<<<<<<<<<<<<<
+ *     cdef np.intp_t i, p, pp, label
+ *     i = U.p_size
  */
 
-/* Python wrapper */
-static PyObject *__pyx_pw_5druhg_12_druhg_label_1emerge_clusters(PyObject *__pyx_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_12_druhg_label_1emerge_clusters = {"emerge_clusters", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_1emerge_clusters, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_12_druhg_label_1emerge_clusters(PyObject *__pyx_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-) {
-  struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_U = 0;
-  PyArrayObject *__pyx_v_edges_arr = 0;
-  PyArrayObject *__pyx_v_values_arr = 0;
-  __pyx_t_5numpy_intp_t __pyx_v_limit1;
-  __pyx_t_5numpy_intp_t __pyx_v_limit2;
-  PyObject *__pyx_v_exclude = 0;
-  PyObject *__pyx_v_is_reciprocal = 0;
-  PyObject *__pyx_v_kwargs = 0;
-  #if !CYTHON_METH_FASTCALL
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  #endif
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
+static PyObject *__pyx_f_5druhg_12_druhg_label_mark_labels(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_U, PyObject *__pyx_v_clusters, PyArrayObject *__pyx_v_ret_labels) {
+  __pyx_t_5numpy_intp_t __pyx_v_i;
+  __pyx_t_5numpy_intp_t __pyx_v_p;
+  __pyx_t_5numpy_intp_t __pyx_v_pp;
+  __pyx_t_5numpy_intp_t __pyx_v_label;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  __pyx_t_5numpy_intp_t __pyx_t_1;
+  int __pyx_t_2;
+  PyObject *__pyx_t_3 = NULL;
+  int __pyx_t_4;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("emerge_clusters (wrapper)", 0);
-  __pyx_v_kwargs = PyDict_New(); if (unlikely(!__pyx_v_kwargs)) return NULL;
-  __Pyx_GOTREF(__pyx_v_kwargs);
-  {
-    #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_U,&__pyx_n_s_edges_arr,&__pyx_n_s_values_arr,&__pyx_n_s_limit1,&__pyx_n_s_limit2,&__pyx_n_s_exclude,&__pyx_n_s_is_reciprocal,0};
-    #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_U,&__pyx_n_s_edges_arr,&__pyx_n_s_values_arr,&__pyx_n_s_limit1,&__pyx_n_s_limit2,&__pyx_n_s_exclude,&__pyx_n_s_is_reciprocal,0};
-    #endif
-    PyObject* values[7] = {0,0,0,0,0,0,0};
-    values[6] = ((PyObject *)((PyObject *)__pyx_int_1));
-    if (__pyx_kwds) {
-      Py_ssize_t kw_args;
-      switch (__pyx_nargs) {
-        case  7: values[6] = __Pyx_Arg_FASTCALL(__pyx_args, 6);
-        CYTHON_FALLTHROUGH;
-        case  6: values[5] = __Pyx_Arg_FASTCALL(__pyx_args, 5);
-        CYTHON_FALLTHROUGH;
-        case  5: values[4] = __Pyx_Arg_FASTCALL(__pyx_args, 4);
-        CYTHON_FALLTHROUGH;
-        case  4: values[3] = __Pyx_Arg_FASTCALL(__pyx_args, 3);
-        CYTHON_FALLTHROUGH;
-        case  3: values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
-        case  2: values[1] = __Pyx_Arg_FASTCALL(__pyx_args, 1);
-        CYTHON_FALLTHROUGH;
-        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-        CYTHON_FALLTHROUGH;
-        case  0: break;
-        default: goto __pyx_L5_argtuple_error;
-      }
-      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
-      switch (__pyx_nargs) {
-        case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_U)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        else goto __pyx_L5_argtuple_error;
-        CYTHON_FALLTHROUGH;
-        case  1:
-        if (likely((values[1] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_edges_arr)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("emerge_clusters", 0, 6, 7, 1); __PYX_ERR(1, 157, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  2:
-        if (likely((values[2] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_values_arr)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("emerge_clusters", 0, 6, 7, 2); __PYX_ERR(1, 157, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  3:
-        if (likely((values[3] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_limit1)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("emerge_clusters", 0, 6, 7, 3); __PYX_ERR(1, 157, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  4:
-        if (likely((values[4] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_limit2)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("emerge_clusters", 0, 6, 7, 4); __PYX_ERR(1, 157, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  5:
-        if (likely((values[5] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_exclude)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        else {
-          __Pyx_RaiseArgtupleInvalid("emerge_clusters", 0, 6, 7, 5); __PYX_ERR(1, 157, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  6:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_is_reciprocal);
-          if (value) { values[6] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-        }
-      }
-      if (unlikely(kw_args > 0)) {
-        const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, __pyx_v_kwargs, values + 0, kwd_pos_args, "emerge_clusters") < 0)) __PYX_ERR(1, 157, __pyx_L3_error)
+  __Pyx_RefNannySetupContext("mark_labels", 0);
+
+  /* "druhg/_druhg_label.pyx":72
+ * cdef mark_labels(UnionFind U, dict clusters, np.ndarray ret_labels):
+ *     cdef np.intp_t i, p, pp, label
+ *     i = U.p_size             # <<<<<<<<<<<<<<
+ *     while i:
+ *         i -= 1
+ */
+  __pyx_t_1 = __pyx_v_U->p_size;
+  __pyx_v_i = __pyx_t_1;
+
+  /* "druhg/_druhg_label.pyx":73
+ *     cdef np.intp_t i, p, pp, label
+ *     i = U.p_size
+ *     while i:             # <<<<<<<<<<<<<<
+ *         i -= 1
+ *         p = U.parent[i]
+ */
+  while (1) {
+    __pyx_t_2 = (__pyx_v_i != 0);
+    if (!__pyx_t_2) break;
+
+    /* "druhg/_druhg_label.pyx":74
+ *     i = U.p_size
+ *     while i:
+ *         i -= 1             # <<<<<<<<<<<<<<
+ *         p = U.parent[i]
+ *         label = -1
+ */
+    __pyx_v_i = (__pyx_v_i - 1);
+
+    /* "druhg/_druhg_label.pyx":75
+ *     while i:
+ *         i -= 1
+ *         p = U.parent[i]             # <<<<<<<<<<<<<<
+ *         label = -1
+ *         while p != 0:
+ */
+    __pyx_v_p = (__pyx_v_U->parent[__pyx_v_i]);
+
+    /* "druhg/_druhg_label.pyx":76
+ *         i -= 1
+ *         p = U.parent[i]
+ *         label = -1             # <<<<<<<<<<<<<<
+ *         while p != 0:
+ *             pp = getIndex(U,p)
+ */
+    __pyx_v_label = -1L;
+
+    /* "druhg/_druhg_label.pyx":77
+ *         p = U.parent[i]
+ *         label = -1
+ *         while p != 0:             # <<<<<<<<<<<<<<
+ *             pp = getIndex(U,p)
+ *             if pp in clusters:
+ */
+    while (1) {
+      __pyx_t_2 = ((__pyx_v_p != 0) != 0);
+      if (!__pyx_t_2) break;
+
+      /* "druhg/_druhg_label.pyx":78
+ *         label = -1
+ *         while p != 0:
+ *             pp = getIndex(U,p)             # <<<<<<<<<<<<<<
+ *             if pp in clusters:
+ *                 label = pp
+ */
+      __pyx_t_3 = __pyx_f_5druhg_12_druhg_label_getIndex(__pyx_v_U, __pyx_v_p); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 78, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __pyx_t_1 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 78, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __pyx_v_pp = __pyx_t_1;
+
+      /* "druhg/_druhg_label.pyx":79
+ *         while p != 0:
+ *             pp = getIndex(U,p)
+ *             if pp in clusters:             # <<<<<<<<<<<<<<
+ *                 label = pp
+ *                 # break # can't break - the dict contains subclusters
+ */
+      __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_pp); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 79, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      if (unlikely(__pyx_v_clusters == Py_None)) {
+        PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
+        __PYX_ERR(0, 79, __pyx_L1_error)
       }
-    } else {
-      switch (__pyx_nargs) {
-        case  7: values[6] = __Pyx_Arg_FASTCALL(__pyx_args, 6);
-        CYTHON_FALLTHROUGH;
-        case  6: values[5] = __Pyx_Arg_FASTCALL(__pyx_args, 5);
-        values[4] = __Pyx_Arg_FASTCALL(__pyx_args, 4);
-        values[3] = __Pyx_Arg_FASTCALL(__pyx_args, 3);
-        values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
-        values[1] = __Pyx_Arg_FASTCALL(__pyx_args, 1);
-        values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-        break;
-        default: goto __pyx_L5_argtuple_error;
+      __pyx_t_2 = (__Pyx_PyDict_ContainsTF(__pyx_t_3, __pyx_v_clusters, Py_EQ)); if (unlikely((__pyx_t_2 < 0))) __PYX_ERR(0, 79, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __pyx_t_4 = (__pyx_t_2 != 0);
+      if (__pyx_t_4) {
+
+        /* "druhg/_druhg_label.pyx":80
+ *             pp = getIndex(U,p)
+ *             if pp in clusters:
+ *                 label = pp             # <<<<<<<<<<<<<<
+ *                 # break # can't break - the dict contains subclusters
+ *             p = U.parent[p]
+ */
+        __pyx_v_label = __pyx_v_pp;
+
+        /* "druhg/_druhg_label.pyx":79
+ *         while p != 0:
+ *             pp = getIndex(U,p)
+ *             if pp in clusters:             # <<<<<<<<<<<<<<
+ *                 label = pp
+ *                 # break # can't break - the dict contains subclusters
+ */
       }
+
+      /* "druhg/_druhg_label.pyx":82
+ *                 label = pp
+ *                 # break # can't break - the dict contains subclusters
+ *             p = U.parent[p]             # <<<<<<<<<<<<<<
+ *         ret_labels[i] = label
+ *     return ret_labels
+ */
+      __pyx_v_p = (__pyx_v_U->parent[__pyx_v_p]);
     }
-    __pyx_v_U = ((struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)values[0]);
-    __pyx_v_edges_arr = ((PyArrayObject *)values[1]);
-    __pyx_v_values_arr = ((PyArrayObject *)values[2]);
-    __pyx_v_limit1 = __Pyx_PyIndex_AsSsize_t(values[3]); if (unlikely((__pyx_v_limit1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-    __pyx_v_limit2 = __Pyx_PyIndex_AsSsize_t(values[4]); if (unlikely((__pyx_v_limit2 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 157, __pyx_L3_error)
-    __pyx_v_exclude = ((PyObject*)values[5]);
-    __pyx_v_is_reciprocal = values[6];
+
+    /* "druhg/_druhg_label.pyx":83
+ *                 # break # can't break - the dict contains subclusters
+ *             p = U.parent[p]
+ *         ret_labels[i] = label             # <<<<<<<<<<<<<<
+ *     return ret_labels
+ * 
+ */
+    __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_label); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 83, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_ret_labels), __pyx_v_i, __pyx_t_3, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 83, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   }
-  goto __pyx_L4_argument_unpacking_done;
-  __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("emerge_clusters", 0, 6, 7, __pyx_nargs); __PYX_ERR(1, 157, __pyx_L3_error)
-  __pyx_L3_error:;
-  __Pyx_DECREF(__pyx_v_kwargs); __pyx_v_kwargs = 0;
-  __Pyx_AddTraceback("druhg._druhg_label.emerge_clusters", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __Pyx_RefNannyFinishContext();
-  return NULL;
-  __pyx_L4_argument_unpacking_done:;
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_U), __pyx_ptype_5druhg_12_druhg_label_UnionFind, 1, "U", 0))) __PYX_ERR(1, 157, __pyx_L1_error)
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_edges_arr), __pyx_ptype_5numpy_ndarray, 1, "edges_arr", 0))) __PYX_ERR(1, 157, __pyx_L1_error)
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_values_arr), __pyx_ptype_5numpy_ndarray, 1, "values_arr", 0))) __PYX_ERR(1, 157, __pyx_L1_error)
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_exclude), (&PyList_Type), 1, "exclude", 1))) __PYX_ERR(1, 158, __pyx_L1_error)
-  __pyx_r = __pyx_pf_5druhg_12_druhg_label_emerge_clusters(__pyx_self, __pyx_v_U, __pyx_v_edges_arr, __pyx_v_values_arr, __pyx_v_limit1, __pyx_v_limit2, __pyx_v_exclude, __pyx_v_is_reciprocal, __pyx_v_kwargs);
 
-  /* function exit code */
+  /* "druhg/_druhg_label.pyx":84
+ *             p = U.parent[p]
+ *         ret_labels[i] = label
+ *     return ret_labels             # <<<<<<<<<<<<<<
+ * 
+ * cdef emerge_clusters(UnionFind U, np.ndarray values_arr, np.ndarray group_arr,
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_INCREF((PyObject *)__pyx_v_ret_labels);
+  __pyx_r = ((PyObject *)__pyx_v_ret_labels);
   goto __pyx_L0;
+
+  /* "druhg/_druhg_label.pyx":70
+ *     return
+ * 
+ * cdef mark_labels(UnionFind U, dict clusters, np.ndarray ret_labels):             # <<<<<<<<<<<<<<
+ *     cdef np.intp_t i, p, pp, label
+ *     i = U.p_size
+ */
+
+  /* function exit code */
   __pyx_L1_error:;
-  __pyx_r = NULL;
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_AddTraceback("druhg._druhg_label.mark_labels", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = 0;
   __pyx_L0:;
-  __Pyx_DECREF(__pyx_v_kwargs);
+  __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_12_druhg_label_emerge_clusters(CYTHON_UNUSED PyObject *__pyx_self, struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_U, PyArrayObject *__pyx_v_edges_arr, PyArrayObject *__pyx_v_values_arr, __pyx_t_5numpy_intp_t __pyx_v_limit1, __pyx_t_5numpy_intp_t __pyx_v_limit2, PyObject *__pyx_v_exclude, PyObject *__pyx_v_is_reciprocal, PyObject *__pyx_v_kwargs) {
-  __pyx_t_5numpy_intp_t __pyx_v_e1;
-  __pyx_t_5numpy_intp_t __pyx_v_e2;
-  __pyx_t_5numpy_intp_t __pyx_v_e3;
-  __pyx_t_5numpy_intp_t __pyx_v_p1;
-  __pyx_t_5numpy_intp_t __pyx_v_p2;
+/* "druhg/_druhg_label.pyx":86
+ *     return ret_labels
+ * 
+ * cdef emerge_clusters(UnionFind U, np.ndarray values_arr, np.ndarray group_arr,             # <<<<<<<<<<<<<<
+ *                      list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                      np.ndarray ranks_arr = None):
+ */
+
+static PyObject *__pyx_f_5druhg_12_druhg_label_emerge_clusters(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_U, PyArrayObject *__pyx_v_values_arr, PyArrayObject *__pyx_v_group_arr, struct __pyx_opt_args_5druhg_12_druhg_label_emerge_clusters *__pyx_optional_args) {
+
+  /* "druhg/_druhg_label.pyx":87
+ * 
+ * cdef emerge_clusters(UnionFind U, np.ndarray values_arr, np.ndarray group_arr,
+ *                      list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,             # <<<<<<<<<<<<<<
+ *                      np.ndarray ranks_arr = None):
+ *     cdef:
+ */
+  PyObject *__pyx_v_exclude = ((PyObject*)Py_None);
+  __pyx_t_5numpy_intp_t __pyx_v_limit1 = ((__pyx_t_5numpy_intp_t)0);
+  __pyx_t_5numpy_intp_t __pyx_v_limit2 = ((__pyx_t_5numpy_intp_t)0);
+
+  /* "druhg/_druhg_label.pyx":88
+ * cdef emerge_clusters(UnionFind U, np.ndarray values_arr, np.ndarray group_arr,
+ *                      list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                      np.ndarray ranks_arr = None):             # <<<<<<<<<<<<<<
+ *     cdef:
+ *         np.intp_t p, i, cluster_size, loop_size, \
+ */
+  PyArrayObject *__pyx_v_ranks_arr = ((PyArrayObject *)Py_None);
+  __pyx_t_5numpy_intp_t __pyx_v_p;
   __pyx_t_5numpy_intp_t __pyx_v_i;
-  __pyx_t_5numpy_intp_t __pyx_v_c;
+  __pyx_t_5numpy_intp_t __pyx_v_cluster_size;
+  __pyx_t_5numpy_intp_t __pyx_v_has_ranks;
   __pyx_t_5numpy_double_t __pyx_v_v;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_being = 0;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_being1 = 0;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_being2 = 0;
-  struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *__pyx_v_being3 = 0;
-  __pyx_t_5numpy_double_t __pyx_v_jump1;
-  __pyx_t_5numpy_double_t __pyx_v_jump2;
-  PyObject *__pyx_v_disc = 0;
-  PyObject *__pyx_v_d = 0;
-  PyObject *__pyx_v_clusters = 0;
-  __pyx_t_5numpy_double_t __pyx_v_PRECISION;
+  __pyx_t_5numpy_double_t __pyx_v_limit;
+  PyObject *__pyx_v_ret_clusters = 0;
+  struct __pyx_obj_5druhg_12_druhg_group_Group *__pyx_v_p_group = NULL;
+  __pyx_t_5numpy_intp_t __pyx_v_loop_size1;
+  __pyx_t_5numpy_intp_t __pyx_v_loop_size2;
+  __pyx_t_5numpy_intp_t __pyx_v_u;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
-  __pyx_t_5numpy_double_t __pyx_t_3;
-  __pyx_t_5numpy_intp_t __pyx_t_4;
-  Py_ssize_t __pyx_t_5;
-  PyObject *(*__pyx_t_6)(PyObject *);
+  int __pyx_t_2;
+  int __pyx_t_3;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  int __pyx_t_6;
   __pyx_t_5numpy_intp_t __pyx_t_7;
   __pyx_t_5numpy_intp_t __pyx_t_8;
-  PyObject *__pyx_t_9 = NULL;
-  int __pyx_t_10;
-  int __pyx_t_11;
+  __pyx_t_5numpy_intp_t __pyx_t_9;
+  __pyx_t_5numpy_intp_t __pyx_t_10;
+  __pyx_t_5numpy_double_t __pyx_t_11;
   int __pyx_t_12;
-  int __pyx_t_13;
-  Py_ssize_t __pyx_t_14;
+  PyObject *__pyx_t_13 = NULL;
+  PyObject *__pyx_t_14 = NULL;
+  PyObject *__pyx_t_15 = NULL;
+  PyObject *__pyx_t_16 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("emerge_clusters", 0);
+  if (__pyx_optional_args) {
+    if (__pyx_optional_args->__pyx_n > 0) {
+      __pyx_v_exclude = __pyx_optional_args->exclude;
+      if (__pyx_optional_args->__pyx_n > 1) {
+        __pyx_v_limit1 = __pyx_optional_args->limit1;
+        if (__pyx_optional_args->__pyx_n > 2) {
+          __pyx_v_limit2 = __pyx_optional_args->limit2;
+          if (__pyx_optional_args->__pyx_n > 3) {
+            __pyx_v_ranks_arr = __pyx_optional_args->ranks_arr;
+          }
+        }
+      }
+    }
+  }
+  __Pyx_INCREF((PyObject *)__pyx_v_ranks_arr);
 
-  /* "druhg/_druhg_label.pyx":171
- *         np.double_t PRECISION
- * 
- *     PRECISION = kwargs.get('double_precision2', kwargs.get('double_precision', 0.0000001)) # this is only relevant if distances between datapoints are super small             # <<<<<<<<<<<<<<
- *     # extras = kwargs.get('extras_arr', None)
- * 
+  /* "druhg/_druhg_label.pyx":92
+ *         np.intp_t p, i, cluster_size, loop_size, \
+ *             has_ranks
+ *         np.double_t v, limit = 0.             # <<<<<<<<<<<<<<
+ *         dict ret_clusters = {}
+ *     has_ranks = 1
+ */
+  __pyx_v_limit = 0.;
+
+  /* "druhg/_druhg_label.pyx":93
+ *             has_ranks
+ *         np.double_t v, limit = 0.
+ *         dict ret_clusters = {}             # <<<<<<<<<<<<<<
+ *     has_ranks = 1
+ *     if ranks_arr is None:
  */
-  __pyx_t_1 = __Pyx_PyDict_GetItemDefault(__pyx_v_kwargs, __pyx_n_u_double_precision, __pyx_float_0_0000001); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 171, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 93, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyDict_GetItemDefault(__pyx_v_kwargs, __pyx_n_u_double_precision2, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 171, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_3 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(1, 171, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_v_PRECISION = __pyx_t_3;
-
-  /* "druhg/_druhg_label.pyx":174
- *     # extras = kwargs.get('extras_arr', None)
- * 
- *     being = Amalgamation()             # <<<<<<<<<<<<<<
- *     being1 = being
- *     being2 = being
- */
-  __pyx_t_2 = __Pyx_PyObject_CallNoArg(((PyObject *)__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 174, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_v_being = ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_2);
-  __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_label.pyx":175
- * 
- *     being = Amalgamation()
- *     being1 = being             # <<<<<<<<<<<<<<
- *     being2 = being
- * 
- */
-  __Pyx_INCREF((PyObject *)__pyx_v_being);
-  __pyx_v_being1 = __pyx_v_being;
+  __pyx_v_ret_clusters = ((PyObject*)__pyx_t_1);
+  __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_label.pyx":176
- *     being = Amalgamation()
- *     being1 = being
- *     being2 = being             # <<<<<<<<<<<<<<
- * 
- *     d = {}
+  /* "druhg/_druhg_label.pyx":94
+ *         np.double_t v, limit = 0.
+ *         dict ret_clusters = {}
+ *     has_ranks = 1             # <<<<<<<<<<<<<<
+ *     if ranks_arr is None:
+ *         has_ranks = 0
+ */
+  __pyx_v_has_ranks = 1;
+
+  /* "druhg/_druhg_label.pyx":95
+ *         dict ret_clusters = {}
+ *     has_ranks = 1
+ *     if ranks_arr is None:             # <<<<<<<<<<<<<<
+ *         has_ranks = 0
+ *         ranks_arr = np.zeros(1)
  */
-  __Pyx_INCREF((PyObject *)__pyx_v_being);
-  __pyx_v_being2 = __pyx_v_being;
+  __pyx_t_2 = (((PyObject *)__pyx_v_ranks_arr) == Py_None);
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
 
-  /* "druhg/_druhg_label.pyx":178
- *     being2 = being
- * 
- *     d = {}             # <<<<<<<<<<<<<<
- *     clusters = set()
+    /* "druhg/_druhg_label.pyx":96
+ *     has_ranks = 1
+ *     if ranks_arr is None:
+ *         has_ranks = 0             # <<<<<<<<<<<<<<
+ *         ranks_arr = np.zeros(1)
  * 
  */
-  __pyx_t_2 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_v_d = ((PyObject*)__pyx_t_2);
-  __pyx_t_2 = 0;
+    __pyx_v_has_ranks = 0;
 
-  /* "druhg/_druhg_label.pyx":179
- * 
- *     d = {}
- *     clusters = set()             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_label.pyx":97
+ *     if ranks_arr is None:
+ *         has_ranks = 0
+ *         ranks_arr = np.zeros(1)             # <<<<<<<<<<<<<<
  * 
- *     for i, v in enumerate(values_arr):
+ *     p_group = Group(group_arr[0]) # helper
  */
-  __pyx_t_2 = PySet_New(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 179, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_v_clusters = ((PyObject*)__pyx_t_2);
-  __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_label.pyx":181
- *     clusters = set()
- * 
- *     for i, v in enumerate(values_arr):             # <<<<<<<<<<<<<<
- *         e1, e2 = edges_arr[2*i], edges_arr[2*i+1]
- *         # print ('edges', e1, e2)
- */
-  __pyx_t_4 = 0;
-  if (likely(PyList_CheckExact(((PyObject *)__pyx_v_values_arr))) || PyTuple_CheckExact(((PyObject *)__pyx_v_values_arr))) {
-    __pyx_t_2 = ((PyObject *)__pyx_v_values_arr); __Pyx_INCREF(__pyx_t_2); __pyx_t_5 = 0;
-    __pyx_t_6 = NULL;
-  } else {
-    __pyx_t_5 = -1; __pyx_t_2 = PyObject_GetIter(((PyObject *)__pyx_v_values_arr)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 181, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_6 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_2); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 181, __pyx_L1_error)
-  }
-  for (;;) {
-    if (likely(!__pyx_t_6)) {
-      if (likely(PyList_CheckExact(__pyx_t_2))) {
-        if (__pyx_t_5 >= PyList_GET_SIZE(__pyx_t_2)) break;
-        #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_1 = PyList_GET_ITEM(__pyx_t_2, __pyx_t_5); __Pyx_INCREF(__pyx_t_1); __pyx_t_5++; if (unlikely((0 < 0))) __PYX_ERR(1, 181, __pyx_L1_error)
-        #else
-        __pyx_t_1 = PySequence_ITEM(__pyx_t_2, __pyx_t_5); __pyx_t_5++; if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 181, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_1);
-        #endif
-      } else {
-        if (__pyx_t_5 >= PyTuple_GET_SIZE(__pyx_t_2)) break;
-        #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_1 = PyTuple_GET_ITEM(__pyx_t_2, __pyx_t_5); __Pyx_INCREF(__pyx_t_1); __pyx_t_5++; if (unlikely((0 < 0))) __PYX_ERR(1, 181, __pyx_L1_error)
-        #else
-        __pyx_t_1 = PySequence_ITEM(__pyx_t_2, __pyx_t_5); __pyx_t_5++; if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 181, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_1);
-        #endif
-      }
-    } else {
-      __pyx_t_1 = __pyx_t_6(__pyx_t_2);
-      if (unlikely(!__pyx_t_1)) {
-        PyObject* exc_type = PyErr_Occurred();
-        if (exc_type) {
-          if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(1, 181, __pyx_L1_error)
-        }
-        break;
+    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 97, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 97, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = NULL;
+    __pyx_t_6 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
+      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
+      if (likely(__pyx_t_4)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+        __Pyx_INCREF(__pyx_t_4);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_5, function);
+        __pyx_t_6 = 1;
       }
+    }
+    {
+      PyObject *__pyx_callargs[2] = {__pyx_t_4, __pyx_int_1};
+      __pyx_t_1 = __Pyx_PyObject_FastCall(__pyx_t_5, __pyx_callargs+1-__pyx_t_6, 1+__pyx_t_6);
+      __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+      if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 97, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     }
-    __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(1, 181, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_v_v = __pyx_t_3;
-    __pyx_v_i = __pyx_t_4;
-    __pyx_t_4 = (__pyx_t_4 + 1);
-
-    /* "druhg/_druhg_label.pyx":182
- * 
- *     for i, v in enumerate(values_arr):
- *         e1, e2 = edges_arr[2*i], edges_arr[2*i+1]             # <<<<<<<<<<<<<<
- *         # print ('edges', e1, e2)
- *         p1, p2 = U.passive_find(e1), U.passive_find(e2)
- */
-    __pyx_t_7 = (2 * __pyx_v_i);
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_edges_arr), __pyx_t_7, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 182, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_7 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_7 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 182, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_8 = ((2 * __pyx_v_i) + 1);
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_edges_arr), __pyx_t_8, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 182, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_8 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_8 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 182, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_v_e1 = __pyx_t_7;
-    __pyx_v_e2 = __pyx_t_8;
-
-    /* "druhg/_druhg_label.pyx":184
- *         e1, e2 = edges_arr[2*i], edges_arr[2*i+1]
- *         # print ('edges', e1, e2)
- *         p1, p2 = U.passive_find(e1), U.passive_find(e2)             # <<<<<<<<<<<<<<
- *         being1, being2 = being, being
- * 
- */
-    __pyx_t_8 = ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->passive_find(__pyx_v_U, __pyx_v_e1);
-    __pyx_t_7 = ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->passive_find(__pyx_v_U, __pyx_v_e2);
-    __pyx_v_p1 = __pyx_t_8;
-    __pyx_v_p2 = __pyx_t_7;
-
-    /* "druhg/_druhg_label.pyx":185
- *         # print ('edges', e1, e2)
- *         p1, p2 = U.passive_find(e1), U.passive_find(e2)
- *         being1, being2 = being, being             # <<<<<<<<<<<<<<
- * 
- *         if U.has_parent(e1):
- */
-    __pyx_t_1 = ((PyObject *)__pyx_v_being);
-    __Pyx_INCREF(__pyx_t_1);
-    __pyx_t_9 = ((PyObject *)__pyx_v_being);
-    __Pyx_INCREF(__pyx_t_9);
-    __Pyx_DECREF_SET(__pyx_v_being1, ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_1));
+    if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 97, __pyx_L1_error)
+    __Pyx_DECREF_SET(__pyx_v_ranks_arr, ((PyArrayObject *)__pyx_t_1));
     __pyx_t_1 = 0;
-    __Pyx_XDECREF_SET(__pyx_v_being2, ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_9));
-    __pyx_t_9 = 0;
 
-    /* "druhg/_druhg_label.pyx":187
- *         being1, being2 = being, being
- * 
- *         if U.has_parent(e1):             # <<<<<<<<<<<<<<
- *             being1 = d.pop(p1)
- *         if U.has_parent(e2):
- */
-    __pyx_t_10 = (((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->has_parent(__pyx_v_U, __pyx_v_e1) != 0);
-    if (__pyx_t_10) {
-
-      /* "druhg/_druhg_label.pyx":188
- * 
- *         if U.has_parent(e1):
- *             being1 = d.pop(p1)             # <<<<<<<<<<<<<<
- *         if U.has_parent(e2):
- *             being2 = d.pop(p2)
+    /* "druhg/_druhg_label.pyx":95
+ *         dict ret_clusters = {}
+ *     has_ranks = 1
+ *     if ranks_arr is None:             # <<<<<<<<<<<<<<
+ *         has_ranks = 0
+ *         ranks_arr = np.zeros(1)
  */
-      __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_p1); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 188, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_1 = __Pyx_PyDict_Pop(__pyx_v_d, __pyx_t_9, ((PyObject *)NULL)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 188, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation))))) __PYX_ERR(1, 188, __pyx_L1_error)
-      __Pyx_DECREF_SET(__pyx_v_being1, ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_1));
-      __pyx_t_1 = 0;
+  }
 
-      /* "druhg/_druhg_label.pyx":187
- *         being1, being2 = being, being
+  /* "druhg/_druhg_label.pyx":99
+ *         ranks_arr = np.zeros(1)
  * 
- *         if U.has_parent(e1):             # <<<<<<<<<<<<<<
- *             being1 = d.pop(p1)
- *         if U.has_parent(e2):
- */
-    }
-
-    /* "druhg/_druhg_label.pyx":189
- *         if U.has_parent(e1):
- *             being1 = d.pop(p1)
- *         if U.has_parent(e2):             # <<<<<<<<<<<<<<
- *             being2 = d.pop(p2)
+ *     p_group = Group(group_arr[0]) # helper             # <<<<<<<<<<<<<<
  * 
+ *     loop_size1, loop_size2 = U.p_size, U.p_size * 2
  */
-    __pyx_t_10 = (((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->has_parent(__pyx_v_U, __pyx_v_e2) != 0);
-    if (__pyx_t_10) {
+  __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = __Pyx_PyObject_CallOneArg(((PyObject *)__pyx_ptype_5druhg_12_druhg_group_Group), __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 99, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v_p_group = ((struct __pyx_obj_5druhg_12_druhg_group_Group *)__pyx_t_5);
+  __pyx_t_5 = 0;
 
-      /* "druhg/_druhg_label.pyx":190
- *             being1 = d.pop(p1)
- *         if U.has_parent(e2):
- *             being2 = d.pop(p2)             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_label.pyx":101
+ *     p_group = Group(group_arr[0]) # helper
  * 
- *         if is_reciprocal:
+ *     loop_size1, loop_size2 = U.p_size, U.p_size * 2             # <<<<<<<<<<<<<<
+ *     for u in range(loop_size1):
+ *         p = U.parent[u]
+ */
+  __pyx_t_7 = __pyx_v_U->p_size;
+  __pyx_t_8 = (__pyx_v_U->p_size * 2);
+  __pyx_v_loop_size1 = __pyx_t_7;
+  __pyx_v_loop_size2 = __pyx_t_8;
+
+  /* "druhg/_druhg_label.pyx":102
+ * 
+ *     loop_size1, loop_size2 = U.p_size, U.p_size * 2
+ *     for u in range(loop_size1):             # <<<<<<<<<<<<<<
+ *         p = U.parent[u]
+ *         if p == 0:
  */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 190, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_9 = __Pyx_PyDict_Pop(__pyx_v_d, __pyx_t_1, ((PyObject *)NULL)); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 190, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      if (!(likely(((__pyx_t_9) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_9, __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation))))) __PYX_ERR(1, 190, __pyx_L1_error)
-      __Pyx_DECREF_SET(__pyx_v_being2, ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_9));
-      __pyx_t_9 = 0;
-
-      /* "druhg/_druhg_label.pyx":189
- *         if U.has_parent(e1):
- *             being1 = d.pop(p1)
- *         if U.has_parent(e2):             # <<<<<<<<<<<<<<
- *             being2 = d.pop(p2)
- * 
+  __pyx_t_8 = __pyx_v_loop_size1;
+  __pyx_t_7 = __pyx_t_8;
+  for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_7; __pyx_t_9+=1) {
+    __pyx_v_u = __pyx_t_9;
+
+    /* "druhg/_druhg_label.pyx":103
+ *     loop_size1, loop_size2 = U.p_size, U.p_size * 2
+ *     for u in range(loop_size1):
+ *         p = U.parent[u]             # <<<<<<<<<<<<<<
+ *         if p == 0:
+ *             continue
  */
-    }
+    __pyx_v_p = (__pyx_v_U->parent[__pyx_v_u]);
 
-    /* "druhg/_druhg_label.pyx":192
- *             being2 = d.pop(p2)
- * 
- *         if is_reciprocal:             # <<<<<<<<<<<<<<
- *             jump1 = being1.border_overcoming_rev(v, being2, PRECISION)
- *             jump2 = being2.border_overcoming_rev(v, being1, PRECISION)
+    /* "druhg/_druhg_label.pyx":104
+ *     for u in range(loop_size1):
+ *         p = U.parent[u]
+ *         if p == 0:             # <<<<<<<<<<<<<<
+ *             continue
+ *         assert p >= U.p_size
  */
-    __pyx_t_10 = __Pyx_PyObject_IsTrue(__pyx_v_is_reciprocal); if (unlikely((__pyx_t_10 < 0))) __PYX_ERR(1, 192, __pyx_L1_error)
-    if (__pyx_t_10) {
+    __pyx_t_3 = ((__pyx_v_p == 0) != 0);
+    if (__pyx_t_3) {
 
-      /* "druhg/_druhg_label.pyx":193
- * 
- *         if is_reciprocal:
- *             jump1 = being1.border_overcoming_rev(v, being2, PRECISION)             # <<<<<<<<<<<<<<
- *             jump2 = being2.border_overcoming_rev(v, being1, PRECISION)
- *         else:
+      /* "druhg/_druhg_label.pyx":105
+ *         p = U.parent[u]
+ *         if p == 0:
+ *             continue             # <<<<<<<<<<<<<<
+ *         assert p >= U.p_size
+ *         p = getIndex(U, p)
  */
-      __pyx_v_jump1 = ((struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_being1->__pyx_vtab)->border_overcoming_rev(__pyx_v_being1, __pyx_v_v, __pyx_v_being2, __pyx_v_PRECISION);
+      goto __pyx_L4_continue;
 
-      /* "druhg/_druhg_label.pyx":194
- *         if is_reciprocal:
- *             jump1 = being1.border_overcoming_rev(v, being2, PRECISION)
- *             jump2 = being2.border_overcoming_rev(v, being1, PRECISION)             # <<<<<<<<<<<<<<
- *         else:
- *             jump1 = being1.border_overcoming(v, being2, PRECISION)
+      /* "druhg/_druhg_label.pyx":104
+ *     for u in range(loop_size1):
+ *         p = U.parent[u]
+ *         if p == 0:             # <<<<<<<<<<<<<<
+ *             continue
+ *         assert p >= U.p_size
  */
-      __pyx_v_jump2 = ((struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_being2->__pyx_vtab)->border_overcoming_rev(__pyx_v_being2, __pyx_v_v, __pyx_v_being1, __pyx_v_PRECISION);
+    }
 
-      /* "druhg/_druhg_label.pyx":192
- *             being2 = d.pop(p2)
- * 
- *         if is_reciprocal:             # <<<<<<<<<<<<<<
- *             jump1 = being1.border_overcoming_rev(v, being2, PRECISION)
- *             jump2 = being2.border_overcoming_rev(v, being1, PRECISION)
- */
-      goto __pyx_L7;
+    /* "druhg/_druhg_label.pyx":106
+ *         if p == 0:
+ *             continue
+ *         assert p >= U.p_size             # <<<<<<<<<<<<<<
+ *         p = getIndex(U, p)
+ *         assert p < U.p_size
+ */
+    #ifndef CYTHON_WITHOUT_ASSERTIONS
+    if (unlikely(!Py_OptimizeFlag)) {
+      __pyx_t_3 = ((__pyx_v_p >= __pyx_v_U->p_size) != 0);
+      if (unlikely(!__pyx_t_3)) {
+        __Pyx_Raise(__pyx_builtin_AssertionError, 0, 0, 0);
+        __PYX_ERR(0, 106, __pyx_L1_error)
+      }
     }
+    #else
+    if ((1)); else __PYX_ERR(0, 106, __pyx_L1_error)
+    #endif
 
-    /* "druhg/_druhg_label.pyx":196
- *             jump2 = being2.border_overcoming_rev(v, being1, PRECISION)
- *         else:
- *             jump1 = being1.border_overcoming(v, being2, PRECISION)             # <<<<<<<<<<<<<<
- *             jump2 = being2.border_overcoming(v, being1, PRECISION)
- * 
+    /* "druhg/_druhg_label.pyx":107
+ *             continue
+ *         assert p >= U.p_size
+ *         p = getIndex(U, p)             # <<<<<<<<<<<<<<
+ *         assert p < U.p_size
+ *         v = values_arr[p]
  */
-    /*else*/ {
-      __pyx_v_jump1 = ((struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_being1->__pyx_vtab)->border_overcoming(__pyx_v_being1, __pyx_v_v, __pyx_v_being2, __pyx_v_PRECISION);
+    __pyx_t_5 = __pyx_f_5druhg_12_druhg_label_getIndex(__pyx_v_U, __pyx_v_p); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 107, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_10 = __Pyx_PyIndex_AsSsize_t(__pyx_t_5); if (unlikely((__pyx_t_10 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 107, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_v_p = __pyx_t_10;
 
-      /* "druhg/_druhg_label.pyx":197
- *         else:
- *             jump1 = being1.border_overcoming(v, being2, PRECISION)
- *             jump2 = being2.border_overcoming(v, being1, PRECISION)             # <<<<<<<<<<<<<<
- * 
- * # TODO:    ?
- */
-      __pyx_v_jump2 = ((struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_being2->__pyx_vtab)->border_overcoming(__pyx_v_being2, __pyx_v_v, __pyx_v_being1, __pyx_v_PRECISION);
+    /* "druhg/_druhg_label.pyx":108
+ *         assert p >= U.p_size
+ *         p = getIndex(U, p)
+ *         assert p < U.p_size             # <<<<<<<<<<<<<<
+ *         v = values_arr[p]
+ *         # first ever node connection
+ */
+    #ifndef CYTHON_WITHOUT_ASSERTIONS
+    if (unlikely(!Py_OptimizeFlag)) {
+      __pyx_t_3 = ((__pyx_v_p < __pyx_v_U->p_size) != 0);
+      if (unlikely(!__pyx_t_3)) {
+        __Pyx_Raise(__pyx_builtin_AssertionError, 0, 0, 0);
+        __PYX_ERR(0, 108, __pyx_L1_error)
+      }
     }
-    __pyx_L7:;
+    #else
+    if ((1)); else __PYX_ERR(0, 108, __pyx_L1_error)
+    #endif
 
-    /* "druhg/_druhg_label.pyx":201
- * # TODO:    ?
- * 
- *         if being1.size > 1 \             # <<<<<<<<<<<<<<
- *             and jump1 >= 0 \
- *             and limit1 < being1.size < limit2 \
+    /* "druhg/_druhg_label.pyx":109
+ *         p = getIndex(U, p)
+ *         assert p < U.p_size
+ *         v = values_arr[p]             # <<<<<<<<<<<<<<
+ *         # first ever node connection
+ *         p_group.assume_data(group_arr[p])
  */
-    __pyx_t_11 = ((__pyx_v_being1->size > 1) != 0);
-    if (__pyx_t_11) {
-    } else {
-      __pyx_t_10 = __pyx_t_11;
-      goto __pyx_L9_bool_binop_done;
-    }
+    __pyx_t_5 = __Pyx_GetItemInt(((PyObject *)__pyx_v_values_arr), __pyx_v_p, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 109, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_11 = __pyx_PyFloat_AsDouble(__pyx_t_5); if (unlikely((__pyx_t_11 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 109, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_v_v = __pyx_t_11;
 
-    /* "druhg/_druhg_label.pyx":202
+    /* "druhg/_druhg_label.pyx":111
+ *         v = values_arr[p]
+ *         # first ever node connection
+ *         p_group.assume_data(group_arr[p])             # <<<<<<<<<<<<<<
+ *         p_group.add_1(v)
  * 
- *         if being1.size > 1 \
- *             and jump1 >= 0 \             # <<<<<<<<<<<<<<
- *             and limit1 < being1.size < limit2 \
- *             and p1 not in exclude:
  */
-    __pyx_t_11 = ((__pyx_v_jump1 >= 0.0) != 0);
-    if (__pyx_t_11) {
-    } else {
-      __pyx_t_10 = __pyx_t_11;
-      goto __pyx_L9_bool_binop_done;
-    }
-
-    /* "druhg/_druhg_label.pyx":203
- *         if being1.size > 1 \
- *             and jump1 >= 0 \
- *             and limit1 < being1.size < limit2 \             # <<<<<<<<<<<<<<
- *             and p1 not in exclude:
- *             clusters.add(p1)
- */
-    __pyx_t_11 = (__pyx_v_limit1 < __pyx_v_being1->size);
-    if (__pyx_t_11) {
-      __pyx_t_11 = (__pyx_v_being1->size < __pyx_v_limit2);
-    }
-    __pyx_t_12 = (__pyx_t_11 != 0);
-    if (__pyx_t_12) {
-    } else {
-      __pyx_t_10 = __pyx_t_12;
-      goto __pyx_L9_bool_binop_done;
-    }
+    __pyx_t_5 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_p, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 111, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_1 = ((struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *)__pyx_v_p_group->__pyx_vtab)->assume_data(__pyx_v_p_group, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 111, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-    /* "druhg/_druhg_label.pyx":204
- *             and jump1 >= 0 \
- *             and limit1 < being1.size < limit2 \
- *             and p1 not in exclude:             # <<<<<<<<<<<<<<
- *             clusters.add(p1)
- * 
- */
-    __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_p1); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 204, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_12 = (__Pyx_PySequence_ContainsTF(__pyx_t_9, __pyx_v_exclude, Py_NE)); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(1, 204, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_t_11 = (__pyx_t_12 != 0);
-    __pyx_t_10 = __pyx_t_11;
-    __pyx_L9_bool_binop_done:;
-
-    /* "druhg/_druhg_label.pyx":201
- * # TODO:    ?
- * 
- *         if being1.size > 1 \             # <<<<<<<<<<<<<<
- *             and jump1 >= 0 \
- *             and limit1 < being1.size < limit2 \
- */
-    if (__pyx_t_10) {
-
-      /* "druhg/_druhg_label.pyx":205
- *             and limit1 < being1.size < limit2 \
- *             and p1 not in exclude:
- *             clusters.add(p1)             # <<<<<<<<<<<<<<
- * 
- *         if being2.size > 1 \
- */
-      __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_p1); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 205, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_13 = PySet_Add(__pyx_v_clusters, __pyx_t_9); if (unlikely(__pyx_t_13 == ((int)-1))) __PYX_ERR(1, 205, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-      /* "druhg/_druhg_label.pyx":201
- * # TODO:    ?
- * 
- *         if being1.size > 1 \             # <<<<<<<<<<<<<<
- *             and jump1 >= 0 \
- *             and limit1 < being1.size < limit2 \
+    /* "druhg/_druhg_label.pyx":112
+ *         # first ever node connection
+ *         p_group.assume_data(group_arr[p])
+ *         p_group.add_1(v)             # <<<<<<<<<<<<<<
+ * 
+ *     for u in range(loop_size1, loop_size2):
  */
-    }
+    __pyx_t_1 = ((struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *)__pyx_v_p_group->__pyx_vtab)->add_1(__pyx_v_p_group, __pyx_v_v); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 112, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_L4_continue:;
+  }
 
-    /* "druhg/_druhg_label.pyx":207
- *             clusters.add(p1)
+  /* "druhg/_druhg_label.pyx":114
+ *         p_group.add_1(v)
  * 
- *         if being2.size > 1 \             # <<<<<<<<<<<<<<
- *             and jump2 >= 0 \
- *             and limit1 < being2.size < limit2 \
+ *     for u in range(loop_size1, loop_size2):             # <<<<<<<<<<<<<<
+ *         p = U.parent[u]
+ *         if p == 0:
  */
-    __pyx_t_11 = ((__pyx_v_being2->size > 1) != 0);
-    if (__pyx_t_11) {
-    } else {
-      __pyx_t_10 = __pyx_t_11;
-      goto __pyx_L14_bool_binop_done;
-    }
+  __pyx_t_8 = __pyx_v_loop_size2;
+  __pyx_t_7 = __pyx_t_8;
+  for (__pyx_t_9 = __pyx_v_loop_size1; __pyx_t_9 < __pyx_t_7; __pyx_t_9+=1) {
+    __pyx_v_u = __pyx_t_9;
 
-    /* "druhg/_druhg_label.pyx":208
+    /* "druhg/_druhg_label.pyx":115
  * 
- *         if being2.size > 1 \
- *             and jump2 >= 0 \             # <<<<<<<<<<<<<<
- *             and limit1 < being2.size < limit2 \
- *             and p2 not in exclude:
+ *     for u in range(loop_size1, loop_size2):
+ *         p = U.parent[u]             # <<<<<<<<<<<<<<
+ *         if p == 0:
+ *             continue
  */
-    __pyx_t_11 = ((__pyx_v_jump2 >= 0.0) != 0);
-    if (__pyx_t_11) {
-    } else {
-      __pyx_t_10 = __pyx_t_11;
-      goto __pyx_L14_bool_binop_done;
-    }
-
-    /* "druhg/_druhg_label.pyx":209
- *         if being2.size > 1 \
- *             and jump2 >= 0 \
- *             and limit1 < being2.size < limit2 \             # <<<<<<<<<<<<<<
- *             and p2 not in exclude:
- *             clusters.add(p2)
- */
-    __pyx_t_11 = (__pyx_v_limit1 < __pyx_v_being2->size);
-    if (__pyx_t_11) {
-      __pyx_t_11 = (__pyx_v_being2->size < __pyx_v_limit2);
-    }
-    __pyx_t_12 = (__pyx_t_11 != 0);
-    if (__pyx_t_12) {
-    } else {
-      __pyx_t_10 = __pyx_t_12;
-      goto __pyx_L14_bool_binop_done;
-    }
-
-    /* "druhg/_druhg_label.pyx":210
- *             and jump2 >= 0 \
- *             and limit1 < being2.size < limit2 \
- *             and p2 not in exclude:             # <<<<<<<<<<<<<<
- *             clusters.add(p2)
- * 
- */
-    __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_p2); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 210, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_12 = (__Pyx_PySequence_ContainsTF(__pyx_t_9, __pyx_v_exclude, Py_NE)); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(1, 210, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_t_11 = (__pyx_t_12 != 0);
-    __pyx_t_10 = __pyx_t_11;
-    __pyx_L14_bool_binop_done:;
+    __pyx_v_p = (__pyx_v_U->parent[__pyx_v_u]);
 
-    /* "druhg/_druhg_label.pyx":207
- *             clusters.add(p1)
- * 
- *         if being2.size > 1 \             # <<<<<<<<<<<<<<
- *             and jump2 >= 0 \
- *             and limit1 < being2.size < limit2 \
+    /* "druhg/_druhg_label.pyx":116
+ *     for u in range(loop_size1, loop_size2):
+ *         p = U.parent[u]
+ *         if p == 0:             # <<<<<<<<<<<<<<
+ *             continue
+ *         p = getIndex(U, p)
  */
-    if (__pyx_t_10) {
+    __pyx_t_3 = ((__pyx_v_p == 0) != 0);
+    if (__pyx_t_3) {
 
-      /* "druhg/_druhg_label.pyx":211
- *             and limit1 < being2.size < limit2 \
- *             and p2 not in exclude:
- *             clusters.add(p2)             # <<<<<<<<<<<<<<
- * 
- *         being3 = being1.merge_amalgamations(v, being2, jump1, jump2)
+      /* "druhg/_druhg_label.pyx":117
+ *         p = U.parent[u]
+ *         if p == 0:
+ *             continue             # <<<<<<<<<<<<<<
+ *         p = getIndex(U, p)
+ *         p_group.assume_data(group_arr[p])
  */
-      __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_p2); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 211, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_13 = PySet_Add(__pyx_v_clusters, __pyx_t_9); if (unlikely(__pyx_t_13 == ((int)-1))) __PYX_ERR(1, 211, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      goto __pyx_L7_continue;
 
-      /* "druhg/_druhg_label.pyx":207
- *             clusters.add(p1)
- * 
- *         if being2.size > 1 \             # <<<<<<<<<<<<<<
- *             and jump2 >= 0 \
- *             and limit1 < being2.size < limit2 \
+      /* "druhg/_druhg_label.pyx":116
+ *     for u in range(loop_size1, loop_size2):
+ *         p = U.parent[u]
+ *         if p == 0:             # <<<<<<<<<<<<<<
+ *             continue
+ *         p = getIndex(U, p)
  */
     }
 
-    /* "druhg/_druhg_label.pyx":213
- *             clusters.add(p2)
- * 
- *         being3 = being1.merge_amalgamations(v, being2, jump1, jump2)             # <<<<<<<<<<<<<<
- * 
- *         e3 = U.passive_union(U.passive_find(e1), U.passive_find(e2))
+    /* "druhg/_druhg_label.pyx":118
+ *         if p == 0:
+ *             continue
+ *         p = getIndex(U, p)             # <<<<<<<<<<<<<<
+ *         p_group.assume_data(group_arr[p])
+ *         v = values_arr[p]
  */
-    __pyx_t_9 = ((PyObject *)((struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_v_being1->__pyx_vtab)->merge_amalgamations(__pyx_v_being1, __pyx_v_v, __pyx_v_being2, __pyx_v_jump1, __pyx_v_jump2)); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 213, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_XDECREF_SET(__pyx_v_being3, ((struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation *)__pyx_t_9));
-    __pyx_t_9 = 0;
+    __pyx_t_1 = __pyx_f_5druhg_12_druhg_label_getIndex(__pyx_v_U, __pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 118, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_10 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_10 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 118, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_v_p = __pyx_t_10;
 
-    /* "druhg/_druhg_label.pyx":215
- *         being3 = being1.merge_amalgamations(v, being2, jump1, jump2)
+    /* "druhg/_druhg_label.pyx":119
+ *             continue
+ *         p = getIndex(U, p)
+ *         p_group.assume_data(group_arr[p])             # <<<<<<<<<<<<<<
+ *         v = values_arr[p]
  * 
- *         e3 = U.passive_union(U.passive_find(e1), U.passive_find(e2))             # <<<<<<<<<<<<<<
- *         # print(p1,p2,e3)
- *         d[e3] = being3
  */
-    __pyx_v_e3 = ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->passive_union(__pyx_v_U, ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->passive_find(__pyx_v_U, __pyx_v_e1), ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->passive_find(__pyx_v_U, __pyx_v_e2));
-
-    /* "druhg/_druhg_label.pyx":217
- *         e3 = U.passive_union(U.passive_find(e1), U.passive_find(e2))
- *         # print(p1,p2,e3)
- *         d[e3] = being3             # <<<<<<<<<<<<<<
- *         if being2 != being:
- *             del being2
- */
-    __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_e3); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 217, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    if (unlikely((PyDict_SetItem(__pyx_v_d, __pyx_t_9, ((PyObject *)__pyx_v_being3)) < 0))) __PYX_ERR(1, 217, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_p, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 119, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = ((struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *)__pyx_v_p_group->__pyx_vtab)->assume_data(__pyx_v_p_group, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 119, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-    /* "druhg/_druhg_label.pyx":218
- *         # print(p1,p2,e3)
- *         d[e3] = being3
- *         if being2 != being:             # <<<<<<<<<<<<<<
- *             del being2
+    /* "druhg/_druhg_label.pyx":120
+ *         p = getIndex(U, p)
+ *         p_group.assume_data(group_arr[p])
+ *         v = values_arr[p]             # <<<<<<<<<<<<<<
  * 
+ *         i = getIndex(U, u)
  */
-    __pyx_t_9 = PyObject_RichCompare(((PyObject *)__pyx_v_being2), ((PyObject *)__pyx_v_being), Py_NE); __Pyx_XGOTREF(__pyx_t_9); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 218, __pyx_L1_error)
-    __pyx_t_10 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely((__pyx_t_10 < 0))) __PYX_ERR(1, 218, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    if (__pyx_t_10) {
+    __pyx_t_5 = __Pyx_GetItemInt(((PyObject *)__pyx_v_values_arr), __pyx_v_p, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 120, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_11 = __pyx_PyFloat_AsDouble(__pyx_t_5); if (unlikely((__pyx_t_11 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 120, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_v_v = __pyx_t_11;
 
-      /* "druhg/_druhg_label.pyx":219
- *         d[e3] = being3
- *         if being2 != being:
- *             del being2             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_label.pyx":122
+ *         v = values_arr[p]
  * 
- *         disc = U.discard_clusters(e1, clusters)
- */
-      __Pyx_DECREF((PyObject *)__pyx_v_being2); __pyx_v_being2 = 0;
-
-      /* "druhg/_druhg_label.pyx":218
- *         # print(p1,p2,e3)
- *         d[e3] = being3
- *         if being2 != being:             # <<<<<<<<<<<<<<
- *             del being2
+ *         i = getIndex(U, u)             # <<<<<<<<<<<<<<
  * 
+ *         if not group_is_cluster(group_arr[i], &limit, v):
  */
-    }
+    __pyx_t_5 = __pyx_f_5druhg_12_druhg_label_getIndex(__pyx_v_U, __pyx_v_u); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_10 = __Pyx_PyIndex_AsSsize_t(__pyx_t_5); if (unlikely((__pyx_t_10 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_v_i = __pyx_t_10;
 
-    /* "druhg/_druhg_label.pyx":221
- *             del being2
+    /* "druhg/_druhg_label.pyx":124
+ *         i = getIndex(U, u)
  * 
- *         disc = U.discard_clusters(e1, clusters)             # <<<<<<<<<<<<<<
- *         for c in disc:
- *             clusters.discard(c)
+ *         if not group_is_cluster(group_arr[i], &limit, v):             # <<<<<<<<<<<<<<
+ *             p_group.aggregate(group_arr[i])
+ *             continue
  */
-    __pyx_t_9 = ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->discard_clusters(__pyx_v_U, __pyx_v_e1, __pyx_v_clusters); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 221, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_XDECREF_SET(__pyx_v_disc, ((PyObject*)__pyx_t_9));
-    __pyx_t_9 = 0;
+    __pyx_t_5 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 124, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_3 = ((!(__pyx_f_5druhg_12_druhg_group_group_is_cluster(__pyx_t_5, (&__pyx_v_limit), __pyx_v_v) != 0)) != 0);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (__pyx_t_3) {
 
-    /* "druhg/_druhg_label.pyx":222
+      /* "druhg/_druhg_label.pyx":125
+ * 
+ *         if not group_is_cluster(group_arr[i], &limit, v):
+ *             p_group.aggregate(group_arr[i])             # <<<<<<<<<<<<<<
+ *             continue
  * 
- *         disc = U.discard_clusters(e1, clusters)
- *         for c in disc:             # <<<<<<<<<<<<<<
- *             clusters.discard(c)
- *         disc = U.discard_clusters(e2, clusters)
  */
-    if (unlikely(__pyx_v_disc == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-      __PYX_ERR(1, 222, __pyx_L1_error)
-    }
-    __pyx_t_9 = __pyx_v_disc; __Pyx_INCREF(__pyx_t_9); __pyx_t_14 = 0;
-    for (;;) {
-      if (__pyx_t_14 >= PyList_GET_SIZE(__pyx_t_9)) break;
-      #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-      __pyx_t_1 = PyList_GET_ITEM(__pyx_t_9, __pyx_t_14); __Pyx_INCREF(__pyx_t_1); __pyx_t_14++; if (unlikely((0 < 0))) __PYX_ERR(1, 222, __pyx_L1_error)
-      #else
-      __pyx_t_1 = PySequence_ITEM(__pyx_t_9, __pyx_t_14); __pyx_t_14++; if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 222, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 125, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_1 = ((struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *)__pyx_v_p_group->__pyx_vtab)->aggregate(__pyx_v_p_group, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 125, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      #endif
-      __pyx_t_7 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_7 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 222, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_v_c = __pyx_t_7;
 
-      /* "druhg/_druhg_label.pyx":223
- *         disc = U.discard_clusters(e1, clusters)
- *         for c in disc:
- *             clusters.discard(c)             # <<<<<<<<<<<<<<
- *         disc = U.discard_clusters(e2, clusters)
- *         for c in disc:
+      /* "druhg/_druhg_label.pyx":126
+ *         if not group_is_cluster(group_arr[i], &limit, v):
+ *             p_group.aggregate(group_arr[i])
+ *             continue             # <<<<<<<<<<<<<<
+ * 
+ *         p_group.add_cluster(limit, group_arr[i])
  */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_c); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 223, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_13 = __Pyx_PySet_Discard(__pyx_v_clusters, __pyx_t_1); if (unlikely(__pyx_t_13 == ((int)-1))) __PYX_ERR(1, 223, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      goto __pyx_L7_continue;
 
-      /* "druhg/_druhg_label.pyx":222
+      /* "druhg/_druhg_label.pyx":124
+ *         i = getIndex(U, u)
  * 
- *         disc = U.discard_clusters(e1, clusters)
- *         for c in disc:             # <<<<<<<<<<<<<<
- *             clusters.discard(c)
- *         disc = U.discard_clusters(e2, clusters)
- */
-    }
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-    /* "druhg/_druhg_label.pyx":224
- *         for c in disc:
- *             clusters.discard(c)
- *         disc = U.discard_clusters(e2, clusters)             # <<<<<<<<<<<<<<
- *         for c in disc:
- *             clusters.discard(c)
- */
-    __pyx_t_9 = ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->discard_clusters(__pyx_v_U, __pyx_v_e2, __pyx_v_clusters); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 224, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF_SET(__pyx_v_disc, ((PyObject*)__pyx_t_9));
-    __pyx_t_9 = 0;
-
-    /* "druhg/_druhg_label.pyx":225
- *             clusters.discard(c)
- *         disc = U.discard_clusters(e2, clusters)
- *         for c in disc:             # <<<<<<<<<<<<<<
- *             clusters.discard(c)
- * 
- */
-    if (unlikely(__pyx_v_disc == Py_None)) {
-      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-      __PYX_ERR(1, 225, __pyx_L1_error)
-    }
-    __pyx_t_9 = __pyx_v_disc; __Pyx_INCREF(__pyx_t_9); __pyx_t_14 = 0;
-    for (;;) {
-      if (__pyx_t_14 >= PyList_GET_SIZE(__pyx_t_9)) break;
-      #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-      __pyx_t_1 = PyList_GET_ITEM(__pyx_t_9, __pyx_t_14); __Pyx_INCREF(__pyx_t_1); __pyx_t_14++; if (unlikely((0 < 0))) __PYX_ERR(1, 225, __pyx_L1_error)
-      #else
-      __pyx_t_1 = PySequence_ITEM(__pyx_t_9, __pyx_t_14); __pyx_t_14++; if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 225, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      #endif
-      __pyx_t_7 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_7 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 225, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_v_c = __pyx_t_7;
+ *         if not group_is_cluster(group_arr[i], &limit, v):             # <<<<<<<<<<<<<<
+ *             p_group.aggregate(group_arr[i])
+ *             continue
+ */
+    }
 
-      /* "druhg/_druhg_label.pyx":226
- *         disc = U.discard_clusters(e2, clusters)
- *         for c in disc:
- *             clusters.discard(c)             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_label.pyx":128
+ *             continue
  * 
- *         U.label_find(e1, clusters)
+ *         p_group.add_cluster(limit, group_arr[i])             # <<<<<<<<<<<<<<
+ *         cluster_size = group_arr[i][0]
+ *         if limit1 < cluster_size < limit2 \
  */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_c); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 226, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_13 = __Pyx_PySet_Discard(__pyx_v_clusters, __pyx_t_1); if (unlikely(__pyx_t_13 == ((int)-1))) __PYX_ERR(1, 226, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 128, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = ((struct __pyx_vtabstruct_5druhg_12_druhg_group_Group *)__pyx_v_p_group->__pyx_vtab)->add_cluster(__pyx_v_p_group, __pyx_v_limit, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 128, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-      /* "druhg/_druhg_label.pyx":225
- *             clusters.discard(c)
- *         disc = U.discard_clusters(e2, clusters)
- *         for c in disc:             # <<<<<<<<<<<<<<
- *             clusters.discard(c)
+    /* "druhg/_druhg_label.pyx":129
  * 
+ *         p_group.add_cluster(limit, group_arr[i])
+ *         cluster_size = group_arr[i][0]             # <<<<<<<<<<<<<<
+ *         if limit1 < cluster_size < limit2 \
+ *                 and i not in exclude: #
  */
+    __pyx_t_5 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 129, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 129, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_10 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_10 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 129, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_v_cluster_size = __pyx_t_10;
+
+    /* "druhg/_druhg_label.pyx":130
+ *         p_group.add_cluster(limit, group_arr[i])
+ *         cluster_size = group_arr[i][0]
+ *         if limit1 < cluster_size < limit2 \             # <<<<<<<<<<<<<<
+ *                 and i not in exclude: #
+ *             # TODO: should we include subclusters?
+ */
+    __pyx_t_2 = (__pyx_v_limit1 < __pyx_v_cluster_size);
+    if (__pyx_t_2) {
+      __pyx_t_2 = (__pyx_v_cluster_size < __pyx_v_limit2);
+    }
+    __pyx_t_12 = (__pyx_t_2 != 0);
+    if (__pyx_t_12) {
+    } else {
+      __pyx_t_3 = __pyx_t_12;
+      goto __pyx_L12_bool_binop_done;
     }
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
 
-    /* "druhg/_druhg_label.pyx":228
- *             clusters.discard(c)
- * 
- *         U.label_find(e1, clusters)             # <<<<<<<<<<<<<<
- *         U.label_find(e2, clusters)
- * 
+    /* "druhg/_druhg_label.pyx":131
+ *         cluster_size = group_arr[i][0]
+ *         if limit1 < cluster_size < limit2 \
+ *                 and i not in exclude: #             # <<<<<<<<<<<<<<
+ *             # TODO: should we include subclusters?
+ *             ret_clusters[i] = (i, cluster_size, limit, group_arr[i][2], v, ranks_arr[has_ranks * p])
  */
-    (void)(((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->label_find(__pyx_v_U, __pyx_v_e1, __pyx_v_clusters));
+    __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 131, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_12 = (__Pyx_PySequence_ContainsTF(__pyx_t_1, __pyx_v_exclude, Py_NE)); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 131, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_2 = (__pyx_t_12 != 0);
+    __pyx_t_3 = __pyx_t_2;
+    __pyx_L12_bool_binop_done:;
 
-    /* "druhg/_druhg_label.pyx":229
- * 
- *         U.label_find(e1, clusters)
- *         U.label_find(e2, clusters)             # <<<<<<<<<<<<<<
- * 
- *     return clusters
+    /* "druhg/_druhg_label.pyx":130
+ *         p_group.add_cluster(limit, group_arr[i])
+ *         cluster_size = group_arr[i][0]
+ *         if limit1 < cluster_size < limit2 \             # <<<<<<<<<<<<<<
+ *                 and i not in exclude: #
+ *             # TODO: should we include subclusters?
  */
-    (void)(((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->label_find(__pyx_v_U, __pyx_v_e2, __pyx_v_clusters));
+    if (__pyx_t_3) {
 
-    /* "druhg/_druhg_label.pyx":181
- *     clusters = set()
+      /* "druhg/_druhg_label.pyx":133
+ *                 and i not in exclude: #
+ *             # TODO: should we include subclusters?
+ *             ret_clusters[i] = (i, cluster_size, limit, group_arr[i][2], v, ranks_arr[has_ranks * p])             # <<<<<<<<<<<<<<
  * 
- *     for i, v in enumerate(values_arr):             # <<<<<<<<<<<<<<
- *         e1, e2 = edges_arr[2*i], edges_arr[2*i+1]
- *         # print ('edges', e1, e2)
+ *     return ret_clusters
  */
+      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_1);
+      __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_cluster_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_limit); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_13 = __Pyx_GetItemInt(((PyObject *)__pyx_v_group_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_13);
+      __pyx_t_14 = __Pyx_GetItemInt(__pyx_t_13, 2, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_14);
+      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      __pyx_t_13 = PyFloat_FromDouble(__pyx_v_v); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_13);
+      __pyx_t_10 = (__pyx_v_has_ranks * __pyx_v_p);
+      __pyx_t_15 = __Pyx_GetItemInt(((PyObject *)__pyx_v_ranks_arr), __pyx_t_10, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_15);
+      __pyx_t_16 = PyTuple_New(6); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_16);
+      __Pyx_GIVEREF(__pyx_t_1);
+      PyTuple_SET_ITEM(__pyx_t_16, 0, __pyx_t_1);
+      __Pyx_GIVEREF(__pyx_t_5);
+      PyTuple_SET_ITEM(__pyx_t_16, 1, __pyx_t_5);
+      __Pyx_GIVEREF(__pyx_t_4);
+      PyTuple_SET_ITEM(__pyx_t_16, 2, __pyx_t_4);
+      __Pyx_GIVEREF(__pyx_t_14);
+      PyTuple_SET_ITEM(__pyx_t_16, 3, __pyx_t_14);
+      __Pyx_GIVEREF(__pyx_t_13);
+      PyTuple_SET_ITEM(__pyx_t_16, 4, __pyx_t_13);
+      __Pyx_GIVEREF(__pyx_t_15);
+      PyTuple_SET_ITEM(__pyx_t_16, 5, __pyx_t_15);
+      __pyx_t_1 = 0;
+      __pyx_t_5 = 0;
+      __pyx_t_4 = 0;
+      __pyx_t_14 = 0;
+      __pyx_t_13 = 0;
+      __pyx_t_15 = 0;
+      __pyx_t_15 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_15);
+      if (unlikely((PyDict_SetItem(__pyx_v_ret_clusters, __pyx_t_15, __pyx_t_16) < 0))) __PYX_ERR(0, 133, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+      __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
+
+      /* "druhg/_druhg_label.pyx":130
+ *         p_group.add_cluster(limit, group_arr[i])
+ *         cluster_size = group_arr[i][0]
+ *         if limit1 < cluster_size < limit2 \             # <<<<<<<<<<<<<<
+ *                 and i not in exclude: #
+ *             # TODO: should we include subclusters?
+ */
+    }
+    __pyx_L7_continue:;
   }
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_label.pyx":231
- *         U.label_find(e2, clusters)
- * 
- *     return clusters             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_label.pyx":135
+ *             ret_clusters[i] = (i, cluster_size, limit, group_arr[i][2], v, ranks_arr[has_ranks * p])
  * 
+ *     return ret_clusters             # <<<<<<<<<<<<<<
  * 
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,
  */
   __Pyx_XDECREF(__pyx_r);
-  __Pyx_INCREF(__pyx_v_clusters);
-  __pyx_r = __pyx_v_clusters;
+  __Pyx_INCREF(__pyx_v_ret_clusters);
+  __pyx_r = __pyx_v_ret_clusters;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_label.pyx":157
- *     return
- * 
- * def emerge_clusters(UnionFind U, np.ndarray edges_arr, np.ndarray values_arr, np.intp_t limit1, np.intp_t limit2, \             # <<<<<<<<<<<<<<
- *                     list exclude, is_reciprocal = 1, **kwargs):
+  /* "druhg/_druhg_label.pyx":86
+ *     return ret_labels
  * 
+ * cdef emerge_clusters(UnionFind U, np.ndarray values_arr, np.ndarray group_arr,             # <<<<<<<<<<<<<<
+ *                      list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                      np.ndarray ranks_arr = None):
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_13);
+  __Pyx_XDECREF(__pyx_t_14);
+  __Pyx_XDECREF(__pyx_t_15);
+  __Pyx_XDECREF(__pyx_t_16);
   __Pyx_AddTraceback("druhg._druhg_label.emerge_clusters", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
+  __pyx_r = 0;
   __pyx_L0:;
-  __Pyx_XDECREF((PyObject *)__pyx_v_being);
-  __Pyx_XDECREF((PyObject *)__pyx_v_being1);
-  __Pyx_XDECREF((PyObject *)__pyx_v_being2);
-  __Pyx_XDECREF((PyObject *)__pyx_v_being3);
-  __Pyx_XDECREF(__pyx_v_disc);
-  __Pyx_XDECREF(__pyx_v_d);
-  __Pyx_XDECREF(__pyx_v_clusters);
+  __Pyx_XDECREF(__pyx_v_ret_clusters);
+  __Pyx_XDECREF((PyObject *)__pyx_v_p_group);
+  __Pyx_XDECREF((PyObject *)__pyx_v_ranks_arr);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_label.pyx":234
- * 
+/* "druhg/_druhg_label.pyx":137
+ *     return ret_clusters
  * 
- * cpdef np.ndarray label(np.ndarray edges_arr, np.ndarray values_arr, int size = 0, list exclude = None, \             # <<<<<<<<<<<<<<
- *                        np.intp_t limit1 = 0, np.intp_t limit2 = 0, np.intp_t fix_outliers = 1, is_reciprocal = 1):
- *     """Returns cluster labels.
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,             # <<<<<<<<<<<<<<
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
  */
 
 static PyObject *__pyx_pw_5druhg_12_druhg_label_3label(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyArrayObject *__pyx_f_5druhg_12_druhg_label_label(PyArrayObject *__pyx_v_edges_arr, PyArrayObject *__pyx_v_values_arr, CYTHON_UNUSED int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_12_druhg_label_label *__pyx_optional_args) {
-  int __pyx_v_size = ((int)0);
+static PyArrayObject *__pyx_f_5druhg_12_druhg_label_label(PyArrayObject *__pyx_v_values_arr, PyArrayObject *__pyx_v_uf_arr, int __pyx_v_size, PyArrayObject *__pyx_v_group_arr, PyArrayObject *__pyx_v_ret_labels, CYTHON_UNUSED int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_12_druhg_label_label *__pyx_optional_args) {
+
+  /* "druhg/_druhg_label.pyx":139
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,             # <<<<<<<<<<<<<<
+ *                        list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                        np.intp_t fix_outliers = 0, edgepairs_arr=None,
+ */
+  PyArrayObject *__pyx_v_ranks_arr = ((PyArrayObject *)Py_None);
+
+  /* "druhg/_druhg_label.pyx":140
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
+ *                        list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,             # <<<<<<<<<<<<<<
+ *                        np.intp_t fix_outliers = 0, edgepairs_arr=None,
+ *                        precision=0.0000001):
+ */
   PyObject *__pyx_v_exclude = ((PyObject*)Py_None);
   __pyx_t_5numpy_intp_t __pyx_v_limit1 = ((__pyx_t_5numpy_intp_t)0);
   __pyx_t_5numpy_intp_t __pyx_v_limit2 = ((__pyx_t_5numpy_intp_t)0);
-  __pyx_t_5numpy_intp_t __pyx_v_fix_outliers = ((__pyx_t_5numpy_intp_t)1);
-  PyObject *__pyx_v_is_reciprocal = ((PyObject *)__pyx_int_1);
-  PyObject *__pyx_v_clusters = 0;
-  int __pyx_v_i;
-  PyArrayObject *__pyx_v_result_arr = 0;
-  __pyx_t_5numpy_intp_t *__pyx_v_result;
-  struct __pyx_obj_5druhg_12_druhg_label_UnionFind *__pyx_v_U = NULL;
+  __pyx_t_5numpy_intp_t __pyx_v_fix_outliers = ((__pyx_t_5numpy_intp_t)0);
+
+  /* "druhg/_druhg_label.pyx":141
+ *                        np.ndarray ranks_arr=None,
+ *                        list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                        np.intp_t fix_outliers = 0, edgepairs_arr=None,             # <<<<<<<<<<<<<<
+ *                        precision=0.0000001):
+ *     """Returns cluster labels and clusters densities.
+ */
+  PyObject *__pyx_v_edgepairs_arr = ((PyObject *)Py_None);
+  PyObject *__pyx_v_precision = ((PyObject *)__pyx_float_0_0000001);
+  PyObject *__pyx_v_ret_clusters = 0;
+  struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *__pyx_v_U = NULL;
   PyArrayObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
   int __pyx_t_8;
   __pyx_t_5numpy_intp_t __pyx_t_9;
-  Py_ssize_t __pyx_t_10;
-  int __pyx_t_11;
+  int __pyx_t_10;
+  __pyx_t_5numpy_double_t __pyx_t_11;
+  Py_ssize_t __pyx_t_12;
+  int __pyx_t_13;
+  struct __pyx_opt_args_5druhg_12_druhg_label_emerge_clusters __pyx_t_14;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("label", 0);
   if (__pyx_optional_args) {
     if (__pyx_optional_args->__pyx_n > 0) {
-      __pyx_v_size = __pyx_optional_args->size;
+      __pyx_v_ranks_arr = __pyx_optional_args->ranks_arr;
       if (__pyx_optional_args->__pyx_n > 1) {
         __pyx_v_exclude = __pyx_optional_args->exclude;
         if (__pyx_optional_args->__pyx_n > 2) {
           __pyx_v_limit1 = __pyx_optional_args->limit1;
           if (__pyx_optional_args->__pyx_n > 3) {
             __pyx_v_limit2 = __pyx_optional_args->limit2;
             if (__pyx_optional_args->__pyx_n > 4) {
               __pyx_v_fix_outliers = __pyx_optional_args->fix_outliers;
               if (__pyx_optional_args->__pyx_n > 5) {
-                __pyx_v_is_reciprocal = __pyx_optional_args->is_reciprocal;
+                __pyx_v_edgepairs_arr = __pyx_optional_args->edgepairs_arr;
+                if (__pyx_optional_args->__pyx_n > 6) {
+                  __pyx_v_precision = __pyx_optional_args->precision;
+                }
               }
             }
           }
         }
       }
     }
   }
+  __Pyx_INCREF((PyObject *)__pyx_v_ret_labels);
   __Pyx_INCREF(__pyx_v_exclude);
+  __Pyx_INCREF(__pyx_v_precision);
 
-  /* "druhg/_druhg_label.pyx":288
- * 
+  /* "druhg/_druhg_label.pyx":198
+ *         int i
  * 
  *     if limit1 <= 0:             # <<<<<<<<<<<<<<
  *         limit1 = int(np.ceil(np.sqrt(size)))
  *         print ('label: default value for limit1 is used, clusters below '+str(limit1)+' are considered as noise.')
  */
   __pyx_t_1 = ((__pyx_v_limit1 <= 0) != 0);
   if (__pyx_t_1) {
 
-    /* "druhg/_druhg_label.pyx":289
+    /* "druhg/_druhg_label.pyx":199
  * 
  *     if limit1 <= 0:
  *         limit1 = int(np.ceil(np.sqrt(size)))             # <<<<<<<<<<<<<<
  *         print ('label: default value for limit1 is used, clusters below '+str(limit1)+' are considered as noise.')
  * 
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 289, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_ceil); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 289, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_ceil); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 289, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 289, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 289, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __pyx_t_7 = NULL;
     __pyx_t_8 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_6))) {
       __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_6);
       if (likely(__pyx_t_7)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
@@ -6203,15 +4884,15 @@
       }
     }
     {
       PyObject *__pyx_callargs[2] = {__pyx_t_7, __pyx_t_5};
       __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_6, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
       __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 289, __pyx_L1_error)
+      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 199, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     }
     __pyx_t_6 = NULL;
     __pyx_t_8 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
@@ -6224,462 +4905,564 @@
       }
     }
     {
       PyObject *__pyx_callargs[2] = {__pyx_t_6, __pyx_t_3};
       __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_4, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 289, __pyx_L1_error)
+      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 199, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     }
-    __pyx_t_4 = __Pyx_PyNumber_Int(__pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 289, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyNumber_Int(__pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_9 = __Pyx_PyIndex_AsSsize_t(__pyx_t_4); if (unlikely((__pyx_t_9 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 289, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyIndex_AsSsize_t(__pyx_t_4); if (unlikely((__pyx_t_9 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 199, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __pyx_v_limit1 = __pyx_t_9;
 
-    /* "druhg/_druhg_label.pyx":290
+    /* "druhg/_druhg_label.pyx":200
  *     if limit1 <= 0:
  *         limit1 = int(np.ceil(np.sqrt(size)))
  *         print ('label: default value for limit1 is used, clusters below '+str(limit1)+' are considered as noise.')             # <<<<<<<<<<<<<<
  * 
  *     if limit2 <= 0:
  */
-    __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_limit1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 290, __pyx_L1_error)
+    __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_limit1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 200, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_2 = __Pyx_PyObject_Str(__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 290, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_Str(__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 200, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = PyNumber_Add(__pyx_kp_u_label_default_value_for_limit1_i, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 290, __pyx_L1_error)
+    __pyx_t_4 = PyNumber_Add(__pyx_kp_u_label_default_value_for_limit1_i, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 200, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_4, __pyx_kp_u_are_considered_as_noise); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 290, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_4, __pyx_kp_u_are_considered_as_noise); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 200, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 290, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 200, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_label.pyx":288
- * 
+    /* "druhg/_druhg_label.pyx":198
+ *         int i
  * 
  *     if limit1 <= 0:             # <<<<<<<<<<<<<<
  *         limit1 = int(np.ceil(np.sqrt(size)))
  *         print ('label: default value for limit1 is used, clusters below '+str(limit1)+' are considered as noise.')
  */
   }
 
-  /* "druhg/_druhg_label.pyx":292
+  /* "druhg/_druhg_label.pyx":202
  *         print ('label: default value for limit1 is used, clusters below '+str(limit1)+' are considered as noise.')
  * 
  *     if limit2 <= 0:             # <<<<<<<<<<<<<<
  *         limit2 = size
  *         print ('label: default value for limit2 is used, clusters above '+str(limit2)+' will not be formed.')
  */
   __pyx_t_1 = ((__pyx_v_limit2 <= 0) != 0);
   if (__pyx_t_1) {
 
-    /* "druhg/_druhg_label.pyx":293
+    /* "druhg/_druhg_label.pyx":203
  * 
  *     if limit2 <= 0:
  *         limit2 = size             # <<<<<<<<<<<<<<
  *         print ('label: default value for limit2 is used, clusters above '+str(limit2)+' will not be formed.')
  * 
  */
     __pyx_v_limit2 = __pyx_v_size;
 
-    /* "druhg/_druhg_label.pyx":294
+    /* "druhg/_druhg_label.pyx":204
  *     if limit2 <= 0:
  *         limit2 = size
  *         print ('label: default value for limit2 is used, clusters above '+str(limit2)+' will not be formed.')             # <<<<<<<<<<<<<<
  * 
- *     if size == 0:
+ *     # this is only relevant if distances between datapoints are super small
  */
-    __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_limit2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 294, __pyx_L1_error)
+    __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_limit2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 204, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_2 = __Pyx_PyObject_Str(__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 294, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_Str(__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 204, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = PyNumber_Add(__pyx_kp_u_label_default_value_for_limit2_i, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 294, __pyx_L1_error)
+    __pyx_t_4 = PyNumber_Add(__pyx_kp_u_label_default_value_for_limit2_i, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 204, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_4, __pyx_kp_u_will_not_be_formed); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 294, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_4, __pyx_kp_u_will_not_be_formed); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 204, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 294, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 204, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_label.pyx":292
+    /* "druhg/_druhg_label.pyx":202
  *         print ('label: default value for limit1 is used, clusters below '+str(limit1)+' are considered as noise.')
  * 
  *     if limit2 <= 0:             # <<<<<<<<<<<<<<
  *         limit2 = size
  *         print ('label: default value for limit2 is used, clusters above '+str(limit2)+' will not be formed.')
  */
   }
 
-  /* "druhg/_druhg_label.pyx":296
- *         print ('label: default value for limit2 is used, clusters above '+str(limit2)+' will not be formed.')
+  /* "druhg/_druhg_label.pyx":207
+ * 
+ *     # this is only relevant if distances between datapoints are super small
+ *     if precision is None:             # <<<<<<<<<<<<<<
+ *         precision = 0.0000001
+ *     set_precision(precision)
+ */
+  __pyx_t_1 = (__pyx_v_precision == Py_None);
+  __pyx_t_10 = (__pyx_t_1 != 0);
+  if (__pyx_t_10) {
+
+    /* "druhg/_druhg_label.pyx":208
+ *     # this is only relevant if distances between datapoints are super small
+ *     if precision is None:
+ *         precision = 0.0000001             # <<<<<<<<<<<<<<
+ *     set_precision(precision)
+ * 
+ */
+    __Pyx_INCREF(__pyx_float_0_0000001);
+    __Pyx_DECREF_SET(__pyx_v_precision, __pyx_float_0_0000001);
+
+    /* "druhg/_druhg_label.pyx":207
+ * 
+ *     # this is only relevant if distances between datapoints are super small
+ *     if precision is None:             # <<<<<<<<<<<<<<
+ *         precision = 0.0000001
+ *     set_precision(precision)
+ */
+  }
+
+  /* "druhg/_druhg_label.pyx":209
+ *     if precision is None:
+ *         precision = 0.0000001
+ *     set_precision(precision)             # <<<<<<<<<<<<<<
+ * 
+ *     if size == 0:
+ */
+  __pyx_t_11 = __pyx_PyFloat_AsDouble(__pyx_v_precision); if (unlikely((__pyx_t_11 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 209, __pyx_L1_error)
+  __pyx_t_4 = __pyx_f_5druhg_12_druhg_group_set_precision(__pyx_t_11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 209, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+  /* "druhg/_druhg_label.pyx":211
+ *     set_precision(precision)
  * 
  *     if size == 0:             # <<<<<<<<<<<<<<
- *         size = int(len(edges_arr)/2 + 1)
+ *         size = int((len(uf_arr)+1)/2)
  * 
  */
-  __pyx_t_1 = ((__pyx_v_size == 0) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_10 = ((__pyx_v_size == 0) != 0);
+  if (__pyx_t_10) {
 
-    /* "druhg/_druhg_label.pyx":297
+    /* "druhg/_druhg_label.pyx":212
  * 
  *     if size == 0:
- *         size = int(len(edges_arr)/2 + 1)             # <<<<<<<<<<<<<<
+ *         size = int((len(uf_arr)+1)/2)             # <<<<<<<<<<<<<<
  * 
  *     if not exclude:
  */
-    __pyx_t_10 = PyObject_Length(((PyObject *)__pyx_v_edges_arr)); if (unlikely(__pyx_t_10 == ((Py_ssize_t)-1))) __PYX_ERR(1, 297, __pyx_L1_error)
-    __pyx_v_size = ((int)((__pyx_t_10 / 2) + 1));
+    __pyx_t_12 = PyObject_Length(((PyObject *)__pyx_v_uf_arr)); if (unlikely(__pyx_t_12 == ((Py_ssize_t)-1))) __PYX_ERR(0, 212, __pyx_L1_error)
+    __pyx_v_size = ((int)((__pyx_t_12 + 1) / 2));
 
-    /* "druhg/_druhg_label.pyx":296
- *         print ('label: default value for limit2 is used, clusters above '+str(limit2)+' will not be formed.')
+    /* "druhg/_druhg_label.pyx":211
+ *     set_precision(precision)
  * 
  *     if size == 0:             # <<<<<<<<<<<<<<
- *         size = int(len(edges_arr)/2 + 1)
+ *         size = int((len(uf_arr)+1)/2)
  * 
  */
   }
 
-  /* "druhg/_druhg_label.pyx":299
- *         size = int(len(edges_arr)/2 + 1)
+  /* "druhg/_druhg_label.pyx":214
+ *         size = int((len(uf_arr)+1)/2)
  * 
  *     if not exclude:             # <<<<<<<<<<<<<<
  *         exclude = []
  * 
  */
-  __pyx_t_1 = (__pyx_v_exclude != Py_None)&&(PyList_GET_SIZE(__pyx_v_exclude) != 0);
-  __pyx_t_11 = ((!__pyx_t_1) != 0);
-  if (__pyx_t_11) {
+  __pyx_t_10 = (__pyx_v_exclude != Py_None)&&(PyList_GET_SIZE(__pyx_v_exclude) != 0);
+  __pyx_t_1 = ((!__pyx_t_10) != 0);
+  if (__pyx_t_1) {
 
-    /* "druhg/_druhg_label.pyx":300
+    /* "druhg/_druhg_label.pyx":215
  * 
  *     if not exclude:
  *         exclude = []             # <<<<<<<<<<<<<<
  * 
- *     result_arr = -1*np.ones(size, dtype=np.intp)
+ *     if ret_labels is not None and len(ret_labels) < size:
  */
-    __pyx_t_4 = PyList_New(0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 300, __pyx_L1_error)
+    __pyx_t_4 = PyList_New(0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 215, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF_SET(__pyx_v_exclude, ((PyObject*)__pyx_t_4));
     __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_label.pyx":299
- *         size = int(len(edges_arr)/2 + 1)
+    /* "druhg/_druhg_label.pyx":214
+ *         size = int((len(uf_arr)+1)/2)
  * 
  *     if not exclude:             # <<<<<<<<<<<<<<
  *         exclude = []
  * 
  */
   }
 
-  /* "druhg/_druhg_label.pyx":302
+  /* "druhg/_druhg_label.pyx":217
  *         exclude = []
  * 
- *     result_arr = -1*np.ones(size, dtype=np.intp)             # <<<<<<<<<<<<<<
- *     result = (<np.intp_t *> result_arr.data)
- * 
- */
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_ones); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_4);
-  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
-  __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_intp); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyInt_MultiplyCObj(__pyx_int_neg_1, __pyx_t_5, -1L, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 302, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 302, __pyx_L1_error)
-  __pyx_v_result_arr = ((PyArrayObject *)__pyx_t_4);
-  __pyx_t_4 = 0;
+ *     if ret_labels is not None and len(ret_labels) < size:             # <<<<<<<<<<<<<<
+ *         print('ERROR: labels buffer is too small', len(ret_labels), size)
+ *         return
+ */
+  __pyx_t_10 = (((PyObject *)__pyx_v_ret_labels) != Py_None);
+  __pyx_t_13 = (__pyx_t_10 != 0);
+  if (__pyx_t_13) {
+  } else {
+    __pyx_t_1 = __pyx_t_13;
+    goto __pyx_L9_bool_binop_done;
+  }
+  __pyx_t_12 = PyObject_Length(((PyObject *)__pyx_v_ret_labels)); if (unlikely(__pyx_t_12 == ((Py_ssize_t)-1))) __PYX_ERR(0, 217, __pyx_L1_error)
+  __pyx_t_13 = ((__pyx_t_12 < __pyx_v_size) != 0);
+  __pyx_t_1 = __pyx_t_13;
+  __pyx_L9_bool_binop_done:;
+  if (__pyx_t_1) {
 
-  /* "druhg/_druhg_label.pyx":303
+    /* "druhg/_druhg_label.pyx":218
  * 
- *     result_arr = -1*np.ones(size, dtype=np.intp)
- *     result = (<np.intp_t *> result_arr.data)             # <<<<<<<<<<<<<<
+ *     if ret_labels is not None and len(ret_labels) < size:
+ *         print('ERROR: labels buffer is too small', len(ret_labels), size)             # <<<<<<<<<<<<<<
+ *         return
  * 
- *     U = UnionFind(size)
  */
-  __pyx_v_result = ((__pyx_t_5numpy_intp_t *)__pyx_f_5numpy_7ndarray_4data_data(__pyx_v_result_arr));
+    __pyx_t_12 = PyObject_Length(((PyObject *)__pyx_v_ret_labels)); if (unlikely(__pyx_t_12 == ((Py_ssize_t)-1))) __PYX_ERR(0, 218, __pyx_L1_error)
+    __pyx_t_4 = PyInt_FromSsize_t(__pyx_t_12); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_INCREF(__pyx_kp_u_ERROR_labels_buffer_is_too_small);
+    __Pyx_GIVEREF(__pyx_kp_u_ERROR_labels_buffer_is_too_small);
+    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_kp_u_ERROR_labels_buffer_is_too_small);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_4);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_3, 2, __pyx_t_2);
+    __pyx_t_4 = 0;
+    __pyx_t_2 = 0;
+    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_label.pyx":305
- *     result = (<np.intp_t *> result_arr.data)
+    /* "druhg/_druhg_label.pyx":219
+ *     if ret_labels is not None and len(ret_labels) < size:
+ *         print('ERROR: labels buffer is too small', len(ret_labels), size)
+ *         return             # <<<<<<<<<<<<<<
  * 
- *     U = UnionFind(size)             # <<<<<<<<<<<<<<
- *     clusters = emerge_clusters(U, edges_arr, values_arr, limit1, limit2, exclude, is_reciprocal)
+ *     group_arr[:size].fill(0)
+ */
+    __Pyx_XDECREF((PyObject *)__pyx_r);
+    __pyx_r = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None);
+    goto __pyx_L0;
+
+    /* "druhg/_druhg_label.pyx":217
+ *         exclude = []
  * 
+ *     if ret_labels is not None and len(ret_labels) < size:             # <<<<<<<<<<<<<<
+ *         print('ERROR: labels buffer is too small', len(ret_labels), size)
+ *         return
  */
-  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 305, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = __Pyx_PyObject_CallOneArg(((PyObject *)__pyx_ptype_5druhg_12_druhg_label_UnionFind), __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 305, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_v_U = ((struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)__pyx_t_5);
-  __pyx_t_5 = 0;
+  }
 
-  /* "druhg/_druhg_label.pyx":306
+  /* "druhg/_druhg_label.pyx":221
+ *         return
  * 
- *     U = UnionFind(size)
- *     clusters = emerge_clusters(U, edges_arr, values_arr, limit1, limit2, exclude, is_reciprocal)             # <<<<<<<<<<<<<<
+ *     group_arr[:size].fill(0)             # <<<<<<<<<<<<<<
  * 
- *     i = size
+ *     U = UnionFind(size, uf_arr)
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_emerge_clusters); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 306, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_limit1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 306, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_group_arr), 0, __pyx_v_size, NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 221, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_limit2); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 306, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_6 = NULL;
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_fill); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 221, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = NULL;
   __pyx_t_8 = 0;
-  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
-    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
-    if (likely(__pyx_t_6)) {
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_3)) {
       PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(__pyx_t_3);
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_4, function);
       __pyx_t_8 = 1;
     }
   }
   {
-    PyObject *__pyx_callargs[8] = {__pyx_t_6, ((PyObject *)__pyx_v_U), ((PyObject *)__pyx_v_edges_arr), ((PyObject *)__pyx_v_values_arr), __pyx_t_3, __pyx_t_2, __pyx_v_exclude, __pyx_v_is_reciprocal};
-    __pyx_t_5 = __Pyx_PyObject_FastCall(__pyx_t_4, __pyx_callargs+1-__pyx_t_8, 7+__pyx_t_8);
-    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 306, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
+    PyObject *__pyx_callargs[2] = {__pyx_t_3, __pyx_int_0};
+    __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_4, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
+    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 221, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   }
-  if (!(likely(PySet_CheckExact(__pyx_t_5))||((__pyx_t_5) == Py_None) || __Pyx_RaiseUnexpectedTypeError("set", __pyx_t_5))) __PYX_ERR(1, 306, __pyx_L1_error)
-  __pyx_v_clusters = ((PyObject*)__pyx_t_5);
-  __pyx_t_5 = 0;
-
-  /* "druhg/_druhg_label.pyx":308
- *     clusters = emerge_clusters(U, edges_arr, values_arr, limit1, limit2, exclude, is_reciprocal)
- * 
- *     i = size             # <<<<<<<<<<<<<<
- *     while i:
- *         i -= 1
- */
-  __pyx_v_i = __pyx_v_size;
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_label.pyx":309
+  /* "druhg/_druhg_label.pyx":223
+ *     group_arr[:size].fill(0)
  * 
- *     i = size
- *     while i:             # <<<<<<<<<<<<<<
- *         i -= 1
- *         result[i] = U.label_find(i, clusters)
+ *     U = UnionFind(size, uf_arr)             # <<<<<<<<<<<<<<
+ *     ret_clusters = emerge_clusters(U, values_arr, group_arr,
+ *                    exclude, limit1, limit2,
  */
-  while (1) {
-    __pyx_t_11 = (__pyx_v_i != 0);
-    if (!__pyx_t_11) break;
+  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 223, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 223, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_GIVEREF(__pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
+  __Pyx_INCREF((PyObject *)__pyx_v_uf_arr);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_uf_arr);
+  PyTuple_SET_ITEM(__pyx_t_4, 1, ((PyObject *)__pyx_v_uf_arr));
+  __pyx_t_2 = 0;
+  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind), __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 223, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_v_U = ((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)__pyx_t_2);
+  __pyx_t_2 = 0;
 
-    /* "druhg/_druhg_label.pyx":310
- *     i = size
- *     while i:
- *         i -= 1             # <<<<<<<<<<<<<<
- *         result[i] = U.label_find(i, clusters)
+  /* "druhg/_druhg_label.pyx":224
  * 
- */
-    __pyx_v_i = (__pyx_v_i - 1);
+ *     U = UnionFind(size, uf_arr)
+ *     ret_clusters = emerge_clusters(U, values_arr, group_arr,             # <<<<<<<<<<<<<<
+ *                    exclude, limit1, limit2,
+ *                    ranks_arr)
+ */
+  __pyx_t_14.__pyx_n = 4;
+  __pyx_t_14.exclude = __pyx_v_exclude;
+  __pyx_t_14.limit1 = __pyx_v_limit1;
+  __pyx_t_14.limit2 = __pyx_v_limit2;
+  __pyx_t_14.ranks_arr = __pyx_v_ranks_arr;
+  __pyx_t_2 = __pyx_f_5druhg_12_druhg_label_emerge_clusters(__pyx_v_U, __pyx_v_values_arr, __pyx_v_group_arr, &__pyx_t_14); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 224, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (!(likely(PyDict_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("dict", __pyx_t_2))) __PYX_ERR(0, 224, __pyx_L1_error)
+  __pyx_v_ret_clusters = ((PyObject*)__pyx_t_2);
+  __pyx_t_2 = 0;
 
-    /* "druhg/_druhg_label.pyx":311
- *     while i:
- *         i -= 1
- *         result[i] = U.label_find(i, clusters)             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_label.pyx":227
+ *                    exclude, limit1, limit2,
+ *                    ranks_arr)
+ *     ret_labels = mark_labels(U, ret_clusters, ret_labels)             # <<<<<<<<<<<<<<
  * 
- *     if fix_outliers != 0 and len(np.unique(result_arr))>1:
+ *     if fix_outliers != 0 and len(np.unique(ret_labels))>1 and edgepairs_arr is not None:
  */
-    (__pyx_v_result[__pyx_v_i]) = ((struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind *)__pyx_v_U->__pyx_vtab)->label_find(__pyx_v_U, __pyx_v_i, __pyx_v_clusters);
-  }
+  __pyx_t_2 = __pyx_f_5druhg_12_druhg_label_mark_labels(__pyx_v_U, __pyx_v_ret_clusters, __pyx_v_ret_labels); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 227, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 227, __pyx_L1_error)
+  __Pyx_DECREF_SET(__pyx_v_ret_labels, ((PyArrayObject *)__pyx_t_2));
+  __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_label.pyx":313
- *         result[i] = U.label_find(i, clusters)
+  /* "druhg/_druhg_label.pyx":229
+ *     ret_labels = mark_labels(U, ret_clusters, ret_labels)
  * 
- *     if fix_outliers != 0 and len(np.unique(result_arr))>1:             # <<<<<<<<<<<<<<
- *         fixem(edges_arr, len(values_arr), result_arr)
+ *     if fix_outliers != 0 and len(np.unique(ret_labels))>1 and edgepairs_arr is not None:             # <<<<<<<<<<<<<<
+ *         fixem(edgepairs_arr, size, ret_labels) # only possible through edgepairs
  * 
  */
-  __pyx_t_1 = ((__pyx_v_fix_outliers != 0) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_13 = ((__pyx_v_fix_outliers != 0) != 0);
+  if (__pyx_t_13) {
   } else {
-    __pyx_t_11 = __pyx_t_1;
-    goto __pyx_L10_bool_binop_done;
+    __pyx_t_1 = __pyx_t_13;
+    goto __pyx_L12_bool_binop_done;
   }
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 313, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 229, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_unique); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 313, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_unique); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 229, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __pyx_t_4 = NULL;
   __pyx_t_8 = 0;
-  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
     if (likely(__pyx_t_4)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
       __Pyx_INCREF(__pyx_t_4);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
       __pyx_t_8 = 1;
     }
   }
   {
-    PyObject *__pyx_callargs[2] = {__pyx_t_4, ((PyObject *)__pyx_v_result_arr)};
-    __pyx_t_5 = __Pyx_PyObject_FastCall(__pyx_t_2, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
+    PyObject *__pyx_callargs[2] = {__pyx_t_4, ((PyObject *)__pyx_v_ret_labels)};
+    __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
     __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 313, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 229, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   }
-  __pyx_t_10 = PyObject_Length(__pyx_t_5); if (unlikely(__pyx_t_10 == ((Py_ssize_t)-1))) __PYX_ERR(1, 313, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __pyx_t_1 = ((__pyx_t_10 > 1) != 0);
-  __pyx_t_11 = __pyx_t_1;
-  __pyx_L10_bool_binop_done:;
-  if (__pyx_t_11) {
+  __pyx_t_12 = PyObject_Length(__pyx_t_2); if (unlikely(__pyx_t_12 == ((Py_ssize_t)-1))) __PYX_ERR(0, 229, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_13 = ((__pyx_t_12 > 1) != 0);
+  if (__pyx_t_13) {
+  } else {
+    __pyx_t_1 = __pyx_t_13;
+    goto __pyx_L12_bool_binop_done;
+  }
+  __pyx_t_13 = (__pyx_v_edgepairs_arr != Py_None);
+  __pyx_t_10 = (__pyx_t_13 != 0);
+  __pyx_t_1 = __pyx_t_10;
+  __pyx_L12_bool_binop_done:;
+  if (__pyx_t_1) {
 
-    /* "druhg/_druhg_label.pyx":314
+    /* "druhg/_druhg_label.pyx":230
  * 
- *     if fix_outliers != 0 and len(np.unique(result_arr))>1:
- *         fixem(edges_arr, len(values_arr), result_arr)             # <<<<<<<<<<<<<<
+ *     if fix_outliers != 0 and len(np.unique(ret_labels))>1 and edgepairs_arr is not None:
+ *         fixem(edgepairs_arr, size, ret_labels) # only possible through edgepairs             # <<<<<<<<<<<<<<
  * 
- *     return result_arr
+ *     return ret_labels
  */
-    __pyx_t_10 = PyObject_Length(((PyObject *)__pyx_v_values_arr)); if (unlikely(__pyx_t_10 == ((Py_ssize_t)-1))) __PYX_ERR(1, 314, __pyx_L1_error)
-    __pyx_f_5druhg_12_druhg_label_fixem(__pyx_v_edges_arr, __pyx_t_10, __pyx_v_result_arr);
+    if (!(likely(((__pyx_v_edgepairs_arr) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_edgepairs_arr, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 230, __pyx_L1_error)
+    __pyx_f_5druhg_12_druhg_label_fixem(((PyArrayObject *)__pyx_v_edgepairs_arr), __pyx_v_size, __pyx_v_ret_labels);
 
-    /* "druhg/_druhg_label.pyx":313
- *         result[i] = U.label_find(i, clusters)
+    /* "druhg/_druhg_label.pyx":229
+ *     ret_labels = mark_labels(U, ret_clusters, ret_labels)
  * 
- *     if fix_outliers != 0 and len(np.unique(result_arr))>1:             # <<<<<<<<<<<<<<
- *         fixem(edges_arr, len(values_arr), result_arr)
+ *     if fix_outliers != 0 and len(np.unique(ret_labels))>1 and edgepairs_arr is not None:             # <<<<<<<<<<<<<<
+ *         fixem(edgepairs_arr, size, ret_labels) # only possible through edgepairs
  * 
  */
   }
 
-  /* "druhg/_druhg_label.pyx":316
- *         fixem(edges_arr, len(values_arr), result_arr)
+  /* "druhg/_druhg_label.pyx":232
+ *         fixem(edgepairs_arr, size, ret_labels) # only possible through edgepairs
  * 
- *     return result_arr             # <<<<<<<<<<<<<<
+ *     return ret_labels             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __Pyx_XDECREF((PyObject *)__pyx_r);
-  __Pyx_INCREF((PyObject *)__pyx_v_result_arr);
-  __pyx_r = __pyx_v_result_arr;
+  __Pyx_INCREF((PyObject *)__pyx_v_ret_labels);
+  __pyx_r = __pyx_v_ret_labels;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_label.pyx":234
- * 
+  /* "druhg/_druhg_label.pyx":137
+ *     return ret_clusters
  * 
- * cpdef np.ndarray label(np.ndarray edges_arr, np.ndarray values_arr, int size = 0, list exclude = None, \             # <<<<<<<<<<<<<<
- *                        np.intp_t limit1 = 0, np.intp_t limit2 = 0, np.intp_t fix_outliers = 1, is_reciprocal = 1):
- *     """Returns cluster labels.
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,             # <<<<<<<<<<<<<<
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
   __Pyx_XDECREF(__pyx_t_6);
   __Pyx_XDECREF(__pyx_t_7);
   __Pyx_AddTraceback("druhg._druhg_label.label", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_clusters);
-  __Pyx_XDECREF((PyObject *)__pyx_v_result_arr);
+  __Pyx_XDECREF(__pyx_v_ret_clusters);
   __Pyx_XDECREF((PyObject *)__pyx_v_U);
+  __Pyx_XDECREF((PyObject *)__pyx_v_ret_labels);
   __Pyx_XDECREF(__pyx_v_exclude);
+  __Pyx_XDECREF(__pyx_v_precision);
   __Pyx_XGIVEREF((PyObject *)__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* Python wrapper */
 static PyObject *__pyx_pw_5druhg_12_druhg_label_3label(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-PyDoc_STRVAR(__pyx_doc_5druhg_12_druhg_label_2label, "Returns cluster labels.\n    \n    Uses the results of DRUHG MST-tree algorithm(edges and values).\n    Marks data-points with corresponding parent index of a cluster.\n    Exclude list breaks passed clusters by their parent index.\n    The parameters `limit1` and 'limit2' allows the clustering to declare noise points.\n    Outliers-noise marked by -1.\n\n    Parameters\n    ----------\n    edges_arr : ndarray\n        Edgepair nodes of mst.\n    \n    values_arr : ndarray\n        Edge values.\n        \n    size : int\n        Amount of nodes.\n        \n    exclude : list\n        Clusters with parent-index from this list will not be formed. \n    \n    limit1 : int, optional (default=sqrt(size))\n        Clusters that are smaller than this limit treated as noise. \n        Use 1 to find True outliers.\n        \n    limit2 : int, optional (default=size)\n        Clusters with size OVER this limit treated as noise. \n        Use it to break down big clusters.\n \n    fix_outliers: int, optional (default=0)\n        All outliers will be assigned to the nearest cluster.\n\n    is_reciprocal: int, optional (default=1)\n        The formula turns upside down.\n\n    Returns\n    -------\n\n    labels : array [size]\n       An array of cluster labels, one per data-point. Unclustered points get\n       the label -1.\n    ");
+PyDoc_STRVAR(__pyx_doc_5druhg_12_druhg_label_2label, "Returns cluster labels and clusters densities.\n    \n    Uses the results of DRUHG MST-tree algorithm(edges and values).\n    Marks data-points with corresponding parent index of a cluster.\n    Exclude list breaks passed clusters by their parent index.\n    The parameters `limit1` and 'limit2' allows the clustering to declare noise points.\n    Outliers-noise marked by -1.\n\n    Parameters\n    ----------\n    edges_arr : ndarray\n        Edgepair nodes of mst.\n    \n    values_arr : ndarray\n        Edge values two for each edge.\n\n    ranks_arr : ndarray\n        Edge ranks one for each edge.\n        \n    size : int\n        Amount of nodes.\n        \n    exclude : list\n        Clusters with parent-index from this list will not be formed. \n    \n    limit1 : int, optional (default=sqrt(size))\n        Clusters that are smaller than this limit treated as noise. \n        Use 1 to find True outliers.\n        \n    limit2 : int, optional (default=size)\n        Clusters with size OVER this limit treated as noise. \n        Use it to break down big clusters.\n \n    fix_outliers: int, optional (default=0)\n        All outliers will be assigned to the nearest cluster. Need to pass mst(edgepairs).\n    \n    edgepairs_arr: array, optional (default=None)\n        Used with fix_outliers.\n\n    Returns\n    -------\n\n    labels : array [size]\n       An array of cluster labels, one per data-point. Unclustered points get\n       the label -1.\n       \n    clusters : dictionary\n        A dictionary: keys - labels, values - tuples (distance, rank).   \n       \n    ");
 static PyMethodDef __pyx_mdef_5druhg_12_druhg_label_3label = {"label", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_3label, __Pyx_METH_FASTCALL|METH_KEYWORDS, __pyx_doc_5druhg_12_druhg_label_2label};
 static PyObject *__pyx_pw_5druhg_12_druhg_label_3label(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
-  PyArrayObject *__pyx_v_edges_arr = 0;
   PyArrayObject *__pyx_v_values_arr = 0;
+  PyArrayObject *__pyx_v_uf_arr = 0;
   int __pyx_v_size;
+  PyArrayObject *__pyx_v_group_arr = 0;
+  PyArrayObject *__pyx_v_ret_labels = 0;
+  PyArrayObject *__pyx_v_ranks_arr = 0;
   PyObject *__pyx_v_exclude = 0;
   __pyx_t_5numpy_intp_t __pyx_v_limit1;
   __pyx_t_5numpy_intp_t __pyx_v_limit2;
   __pyx_t_5numpy_intp_t __pyx_v_fix_outliers;
-  PyObject *__pyx_v_is_reciprocal = 0;
+  PyObject *__pyx_v_edgepairs_arr = 0;
+  PyObject *__pyx_v_precision = 0;
   #if !CYTHON_METH_FASTCALL
   CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
   #endif
   CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("label (wrapper)", 0);
   {
     #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_edges_arr,&__pyx_n_s_values_arr,&__pyx_n_s_size,&__pyx_n_s_exclude,&__pyx_n_s_limit1,&__pyx_n_s_limit2,&__pyx_n_s_fix_outliers,&__pyx_n_s_is_reciprocal,0};
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_values_arr,&__pyx_n_s_uf_arr,&__pyx_n_s_size,&__pyx_n_s_group_arr,&__pyx_n_s_ret_labels,&__pyx_n_s_ranks_arr,&__pyx_n_s_exclude,&__pyx_n_s_limit1,&__pyx_n_s_limit2,&__pyx_n_s_fix_outliers,&__pyx_n_s_edgepairs_arr,&__pyx_n_s_precision,0};
     #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_edges_arr,&__pyx_n_s_values_arr,&__pyx_n_s_size,&__pyx_n_s_exclude,&__pyx_n_s_limit1,&__pyx_n_s_limit2,&__pyx_n_s_fix_outliers,&__pyx_n_s_is_reciprocal,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_values_arr,&__pyx_n_s_uf_arr,&__pyx_n_s_size,&__pyx_n_s_group_arr,&__pyx_n_s_ret_labels,&__pyx_n_s_ranks_arr,&__pyx_n_s_exclude,&__pyx_n_s_limit1,&__pyx_n_s_limit2,&__pyx_n_s_fix_outliers,&__pyx_n_s_edgepairs_arr,&__pyx_n_s_precision,0};
     #endif
-    PyObject* values[8] = {0,0,0,0,0,0,0,0};
-    values[3] = ((PyObject*)Py_None);
-    values[7] = ((PyObject *)__pyx_int_1);
+    PyObject* values[12] = {0,0,0,0,0,0,0,0,0,0,0,0};
+
+    /* "druhg/_druhg_label.pyx":139
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,             # <<<<<<<<<<<<<<
+ *                        list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                        np.intp_t fix_outliers = 0, edgepairs_arr=None,
+ */
+    values[5] = (PyObject *)((PyArrayObject *)Py_None);
+
+    /* "druhg/_druhg_label.pyx":140
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
+ *                        list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,             # <<<<<<<<<<<<<<
+ *                        np.intp_t fix_outliers = 0, edgepairs_arr=None,
+ *                        precision=0.0000001):
+ */
+    values[6] = ((PyObject*)Py_None);
+
+    /* "druhg/_druhg_label.pyx":141
+ *                        np.ndarray ranks_arr=None,
+ *                        list exclude = None, np.intp_t limit1 = 0, np.intp_t limit2 = 0,
+ *                        np.intp_t fix_outliers = 0, edgepairs_arr=None,             # <<<<<<<<<<<<<<
+ *                        precision=0.0000001):
+ *     """Returns cluster labels and clusters densities.
+ */
+    values[10] = ((PyObject *)Py_None);
+    values[11] = ((PyObject *)__pyx_float_0_0000001);
     if (__pyx_kwds) {
       Py_ssize_t kw_args;
       switch (__pyx_nargs) {
+        case 12: values[11] = __Pyx_Arg_FASTCALL(__pyx_args, 11);
+        CYTHON_FALLTHROUGH;
+        case 11: values[10] = __Pyx_Arg_FASTCALL(__pyx_args, 10);
+        CYTHON_FALLTHROUGH;
+        case 10: values[9] = __Pyx_Arg_FASTCALL(__pyx_args, 9);
+        CYTHON_FALLTHROUGH;
+        case  9: values[8] = __Pyx_Arg_FASTCALL(__pyx_args, 8);
+        CYTHON_FALLTHROUGH;
         case  8: values[7] = __Pyx_Arg_FASTCALL(__pyx_args, 7);
         CYTHON_FALLTHROUGH;
         case  7: values[6] = __Pyx_Arg_FASTCALL(__pyx_args, 6);
         CYTHON_FALLTHROUGH;
         case  6: values[5] = __Pyx_Arg_FASTCALL(__pyx_args, 5);
         CYTHON_FALLTHROUGH;
         case  5: values[4] = __Pyx_Arg_FASTCALL(__pyx_args, 4);
@@ -6694,156 +5477,201 @@
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_edges_arr)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_values_arr)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_values_arr)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+        if (likely((values[1] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_uf_arr)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
         else {
-          __Pyx_RaiseArgtupleInvalid("label", 0, 2, 8, 1); __PYX_ERR(1, 234, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("label", 0, 5, 12, 1); __PYX_ERR(0, 137, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_size);
-          if (value) { values[2] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+        if (likely((values[2] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_size)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("label", 0, 5, 12, 2); __PYX_ERR(0, 137, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_exclude);
-          if (value) { values[3] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+        if (likely((values[3] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_group_arr)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("label", 0, 5, 12, 3); __PYX_ERR(0, 137, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  4:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_limit1);
-          if (value) { values[4] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+        if (likely((values[4] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_ret_labels)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("label", 0, 5, 12, 4); __PYX_ERR(0, 137, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  5:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_limit2);
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_ranks_arr);
           if (value) { values[5] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  6:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_fix_outliers);
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_exclude);
           if (value) { values[6] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  7:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_is_reciprocal);
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_limit1);
           if (value) { values[7] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  8:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_limit2);
+          if (value) { values[8] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  9:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_fix_outliers);
+          if (value) { values[9] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case 10:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_edgepairs_arr);
+          if (value) { values[10] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case 11:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_precision);
+          if (value) { values[11] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "label") < 0)) __PYX_ERR(1, 234, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "label") < 0)) __PYX_ERR(0, 137, __pyx_L3_error)
       }
     } else {
       switch (__pyx_nargs) {
+        case 12: values[11] = __Pyx_Arg_FASTCALL(__pyx_args, 11);
+        CYTHON_FALLTHROUGH;
+        case 11: values[10] = __Pyx_Arg_FASTCALL(__pyx_args, 10);
+        CYTHON_FALLTHROUGH;
+        case 10: values[9] = __Pyx_Arg_FASTCALL(__pyx_args, 9);
+        CYTHON_FALLTHROUGH;
+        case  9: values[8] = __Pyx_Arg_FASTCALL(__pyx_args, 8);
+        CYTHON_FALLTHROUGH;
         case  8: values[7] = __Pyx_Arg_FASTCALL(__pyx_args, 7);
         CYTHON_FALLTHROUGH;
         case  7: values[6] = __Pyx_Arg_FASTCALL(__pyx_args, 6);
         CYTHON_FALLTHROUGH;
         case  6: values[5] = __Pyx_Arg_FASTCALL(__pyx_args, 5);
         CYTHON_FALLTHROUGH;
         case  5: values[4] = __Pyx_Arg_FASTCALL(__pyx_args, 4);
-        CYTHON_FALLTHROUGH;
-        case  4: values[3] = __Pyx_Arg_FASTCALL(__pyx_args, 3);
-        CYTHON_FALLTHROUGH;
-        case  3: values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
-        case  2: values[1] = __Pyx_Arg_FASTCALL(__pyx_args, 1);
+        values[3] = __Pyx_Arg_FASTCALL(__pyx_args, 3);
+        values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
+        values[1] = __Pyx_Arg_FASTCALL(__pyx_args, 1);
         values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_edges_arr = ((PyArrayObject *)values[0]);
-    __pyx_v_values_arr = ((PyArrayObject *)values[1]);
-    if (values[2]) {
-      __pyx_v_size = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 234, __pyx_L3_error)
-    } else {
-      __pyx_v_size = ((int)0);
-    }
-    __pyx_v_exclude = ((PyObject*)values[3]);
-    if (values[4]) {
-      __pyx_v_limit1 = __Pyx_PyIndex_AsSsize_t(values[4]); if (unlikely((__pyx_v_limit1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 235, __pyx_L3_error)
+    __pyx_v_values_arr = ((PyArrayObject *)values[0]);
+    __pyx_v_uf_arr = ((PyArrayObject *)values[1]);
+    __pyx_v_size = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 137, __pyx_L3_error)
+    __pyx_v_group_arr = ((PyArrayObject *)values[3]);
+    __pyx_v_ret_labels = ((PyArrayObject *)values[4]);
+    __pyx_v_ranks_arr = ((PyArrayObject *)values[5]);
+    __pyx_v_exclude = ((PyObject*)values[6]);
+    if (values[7]) {
+      __pyx_v_limit1 = __Pyx_PyIndex_AsSsize_t(values[7]); if (unlikely((__pyx_v_limit1 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 140, __pyx_L3_error)
     } else {
       __pyx_v_limit1 = ((__pyx_t_5numpy_intp_t)0);
     }
-    if (values[5]) {
-      __pyx_v_limit2 = __Pyx_PyIndex_AsSsize_t(values[5]); if (unlikely((__pyx_v_limit2 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 235, __pyx_L3_error)
+    if (values[8]) {
+      __pyx_v_limit2 = __Pyx_PyIndex_AsSsize_t(values[8]); if (unlikely((__pyx_v_limit2 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 140, __pyx_L3_error)
     } else {
       __pyx_v_limit2 = ((__pyx_t_5numpy_intp_t)0);
     }
-    if (values[6]) {
-      __pyx_v_fix_outliers = __Pyx_PyIndex_AsSsize_t(values[6]); if (unlikely((__pyx_v_fix_outliers == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 235, __pyx_L3_error)
+    if (values[9]) {
+      __pyx_v_fix_outliers = __Pyx_PyIndex_AsSsize_t(values[9]); if (unlikely((__pyx_v_fix_outliers == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 141, __pyx_L3_error)
     } else {
-      __pyx_v_fix_outliers = ((__pyx_t_5numpy_intp_t)1);
+      __pyx_v_fix_outliers = ((__pyx_t_5numpy_intp_t)0);
     }
-    __pyx_v_is_reciprocal = values[7];
+    __pyx_v_edgepairs_arr = values[10];
+    __pyx_v_precision = values[11];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("label", 0, 2, 8, __pyx_nargs); __PYX_ERR(1, 234, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("label", 0, 5, 12, __pyx_nargs); __PYX_ERR(0, 137, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_label.label", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_edges_arr), __pyx_ptype_5numpy_ndarray, 1, "edges_arr", 0))) __PYX_ERR(1, 234, __pyx_L1_error)
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_values_arr), __pyx_ptype_5numpy_ndarray, 1, "values_arr", 0))) __PYX_ERR(1, 234, __pyx_L1_error)
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_exclude), (&PyList_Type), 1, "exclude", 1))) __PYX_ERR(1, 234, __pyx_L1_error)
-  __pyx_r = __pyx_pf_5druhg_12_druhg_label_2label(__pyx_self, __pyx_v_edges_arr, __pyx_v_values_arr, __pyx_v_size, __pyx_v_exclude, __pyx_v_limit1, __pyx_v_limit2, __pyx_v_fix_outliers, __pyx_v_is_reciprocal);
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_values_arr), __pyx_ptype_5numpy_ndarray, 1, "values_arr", 0))) __PYX_ERR(0, 137, __pyx_L1_error)
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_uf_arr), __pyx_ptype_5numpy_ndarray, 1, "uf_arr", 0))) __PYX_ERR(0, 137, __pyx_L1_error)
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_group_arr), __pyx_ptype_5numpy_ndarray, 1, "group_arr", 0))) __PYX_ERR(0, 138, __pyx_L1_error)
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_ret_labels), __pyx_ptype_5numpy_ndarray, 1, "ret_labels", 0))) __PYX_ERR(0, 138, __pyx_L1_error)
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_ranks_arr), __pyx_ptype_5numpy_ndarray, 1, "ranks_arr", 0))) __PYX_ERR(0, 139, __pyx_L1_error)
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_exclude), (&PyList_Type), 1, "exclude", 1))) __PYX_ERR(0, 140, __pyx_L1_error)
+  __pyx_r = __pyx_pf_5druhg_12_druhg_label_2label(__pyx_self, __pyx_v_values_arr, __pyx_v_uf_arr, __pyx_v_size, __pyx_v_group_arr, __pyx_v_ret_labels, __pyx_v_ranks_arr, __pyx_v_exclude, __pyx_v_limit1, __pyx_v_limit2, __pyx_v_fix_outliers, __pyx_v_edgepairs_arr, __pyx_v_precision);
+
+  /* "druhg/_druhg_label.pyx":137
+ *     return ret_clusters
+ * 
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,             # <<<<<<<<<<<<<<
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
+ */
 
   /* function exit code */
   goto __pyx_L0;
   __pyx_L1_error:;
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_12_druhg_label_2label(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_edges_arr, PyArrayObject *__pyx_v_values_arr, int __pyx_v_size, PyObject *__pyx_v_exclude, __pyx_t_5numpy_intp_t __pyx_v_limit1, __pyx_t_5numpy_intp_t __pyx_v_limit2, __pyx_t_5numpy_intp_t __pyx_v_fix_outliers, PyObject *__pyx_v_is_reciprocal) {
+static PyObject *__pyx_pf_5druhg_12_druhg_label_2label(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_values_arr, PyArrayObject *__pyx_v_uf_arr, int __pyx_v_size, PyArrayObject *__pyx_v_group_arr, PyArrayObject *__pyx_v_ret_labels, PyArrayObject *__pyx_v_ranks_arr, PyObject *__pyx_v_exclude, __pyx_t_5numpy_intp_t __pyx_v_limit1, __pyx_t_5numpy_intp_t __pyx_v_limit2, __pyx_t_5numpy_intp_t __pyx_v_fix_outliers, PyObject *__pyx_v_edgepairs_arr, PyObject *__pyx_v_precision) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   struct __pyx_opt_args_5druhg_12_druhg_label_label __pyx_t_2;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("label", 0);
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_2.__pyx_n = 6;
-  __pyx_t_2.size = __pyx_v_size;
+  __pyx_t_2.__pyx_n = 7;
+  __pyx_t_2.ranks_arr = __pyx_v_ranks_arr;
   __pyx_t_2.exclude = __pyx_v_exclude;
   __pyx_t_2.limit1 = __pyx_v_limit1;
   __pyx_t_2.limit2 = __pyx_v_limit2;
   __pyx_t_2.fix_outliers = __pyx_v_fix_outliers;
-  __pyx_t_2.is_reciprocal = __pyx_v_is_reciprocal;
-  __pyx_t_1 = ((PyObject *)__pyx_f_5druhg_12_druhg_label_label(__pyx_v_edges_arr, __pyx_v_values_arr, 0, &__pyx_t_2)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 234, __pyx_L1_error)
+  __pyx_t_2.edgepairs_arr = __pyx_v_edgepairs_arr;
+  __pyx_t_2.precision = __pyx_v_precision;
+  __pyx_t_1 = ((PyObject *)__pyx_f_5druhg_12_druhg_label_label(__pyx_v_values_arr, __pyx_v_uf_arr, __pyx_v_size, __pyx_v_group_arr, __pyx_v_ret_labels, 0, &__pyx_t_2)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 137, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
@@ -6852,15 +5680,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_label.pyx":319
+/* "druhg/_druhg_label.pyx":235
  * 
  * 
  * cdef np.ndarray pretty(np.ndarray labels_arr):             # <<<<<<<<<<<<<<
  *     """ Relabels to pretty positive integers.
  *     """
  */
 
@@ -6895,52 +5723,52 @@
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("pretty", 0);
   __pyx_pybuffer_result_arr.pybuffer.buf = NULL;
   __pyx_pybuffer_result_arr.refcount = 0;
   __pyx_pybuffernd_result_arr.data = NULL;
   __pyx_pybuffernd_result_arr.rcbuffer = &__pyx_pybuffer_result_arr;
 
-  /* "druhg/_druhg_label.pyx":327
+  /* "druhg/_druhg_label.pyx":243
  *     cdef np.intp_t* result
  * 
  *     result_arr = -1*np.ones(len(labels_arr), dtype=np.intp)             # <<<<<<<<<<<<<<
  *     result = (<np.intp_t *> result_arr.data)
  * 
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_ones); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_ones); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_3 = PyObject_Length(((PyObject *)__pyx_v_labels_arr)); if (unlikely(__pyx_t_3 == ((Py_ssize_t)-1))) __PYX_ERR(1, 327, __pyx_L1_error)
-  __pyx_t_1 = PyInt_FromSsize_t(__pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_3 = PyObject_Length(((PyObject *)__pyx_v_labels_arr)); if (unlikely(__pyx_t_3 == ((Py_ssize_t)-1))) __PYX_ERR(0, 243, __pyx_L1_error)
+  __pyx_t_1 = PyInt_FromSsize_t(__pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
   __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_intp); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_intp); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(1, 327, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyInt_MultiplyCObj(__pyx_int_neg_1, __pyx_t_6, -1L, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 327, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_MultiplyCObj(__pyx_int_neg_1, __pyx_t_6, -1L, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 243, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 327, __pyx_L1_error)
+  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 243, __pyx_L1_error)
   __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_result_arr.rcbuffer->pybuffer);
     __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_result_arr.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
     if (unlikely(__pyx_t_8 < 0)) {
       PyErr_Fetch(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
@@ -6949,191 +5777,191 @@
         __Pyx_RaiseBufferFallbackError();
       } else {
         PyErr_Restore(__pyx_t_9, __pyx_t_10, __pyx_t_11);
       }
       __pyx_t_9 = __pyx_t_10 = __pyx_t_11 = 0;
     }
     __pyx_pybuffernd_result_arr.diminfo[0].strides = __pyx_pybuffernd_result_arr.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_result_arr.diminfo[0].shape = __pyx_pybuffernd_result_arr.rcbuffer->pybuffer.shape[0];
-    if (unlikely((__pyx_t_8 < 0))) __PYX_ERR(1, 327, __pyx_L1_error)
+    if (unlikely((__pyx_t_8 < 0))) __PYX_ERR(0, 243, __pyx_L1_error)
   }
   __pyx_t_7 = 0;
   __pyx_v_result_arr = ((PyArrayObject *)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_label.pyx":328
+  /* "druhg/_druhg_label.pyx":244
  * 
  *     result_arr = -1*np.ones(len(labels_arr), dtype=np.intp)
  *     result = (<np.intp_t *> result_arr.data)             # <<<<<<<<<<<<<<
  * 
  *     converter = {-1: -1}
  */
   __pyx_v_result = ((__pyx_t_5numpy_intp_t *)__pyx_f_5numpy_7ndarray_4data_data(((PyArrayObject *)__pyx_v_result_arr)));
 
-  /* "druhg/_druhg_label.pyx":330
+  /* "druhg/_druhg_label.pyx":246
  *     result = (<np.intp_t *> result_arr.data)
  * 
  *     converter = {-1: -1}             # <<<<<<<<<<<<<<
  *     max_label = 0
  *     i = len(labels_arr)
  */
-  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 330, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 246, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_t_1, __pyx_int_neg_1, __pyx_int_neg_1) < 0) __PYX_ERR(1, 330, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_1, __pyx_int_neg_1, __pyx_int_neg_1) < 0) __PYX_ERR(0, 246, __pyx_L1_error)
   __pyx_v_converter = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_label.pyx":331
+  /* "druhg/_druhg_label.pyx":247
  * 
  *     converter = {-1: -1}
  *     max_label = 0             # <<<<<<<<<<<<<<
  *     i = len(labels_arr)
  *     while i:
  */
   __pyx_v_max_label = 0;
 
-  /* "druhg/_druhg_label.pyx":332
+  /* "druhg/_druhg_label.pyx":248
  *     converter = {-1: -1}
  *     max_label = 0
  *     i = len(labels_arr)             # <<<<<<<<<<<<<<
  *     while i:
  *         i -= 1
  */
-  __pyx_t_3 = PyObject_Length(((PyObject *)__pyx_v_labels_arr)); if (unlikely(__pyx_t_3 == ((Py_ssize_t)-1))) __PYX_ERR(1, 332, __pyx_L1_error)
+  __pyx_t_3 = PyObject_Length(((PyObject *)__pyx_v_labels_arr)); if (unlikely(__pyx_t_3 == ((Py_ssize_t)-1))) __PYX_ERR(0, 248, __pyx_L1_error)
   __pyx_v_i = __pyx_t_3;
 
-  /* "druhg/_druhg_label.pyx":333
+  /* "druhg/_druhg_label.pyx":249
  *     max_label = 0
  *     i = len(labels_arr)
  *     while i:             # <<<<<<<<<<<<<<
  *         i -= 1
  *         p = labels_arr[i]
  */
   while (1) {
     __pyx_t_12 = (__pyx_v_i != 0);
     if (!__pyx_t_12) break;
 
-    /* "druhg/_druhg_label.pyx":334
+    /* "druhg/_druhg_label.pyx":250
  *     i = len(labels_arr)
  *     while i:
  *         i -= 1             # <<<<<<<<<<<<<<
  *         p = labels_arr[i]
  *         if p in converter:
  */
     __pyx_v_i = (__pyx_v_i - 1);
 
-    /* "druhg/_druhg_label.pyx":335
+    /* "druhg/_druhg_label.pyx":251
  *     while i:
  *         i -= 1
  *         p = labels_arr[i]             # <<<<<<<<<<<<<<
  *         if p in converter:
  *             label = converter[p]
  */
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_labels_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 335, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_labels_arr), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 251, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_13 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_13 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 335, __pyx_L1_error)
+    __pyx_t_13 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_13 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 251, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_v_p = __pyx_t_13;
 
-    /* "druhg/_druhg_label.pyx":336
+    /* "druhg/_druhg_label.pyx":252
  *         i -= 1
  *         p = labels_arr[i]
  *         if p in converter:             # <<<<<<<<<<<<<<
  *             label = converter[p]
  *         else:
  */
-    __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 336, __pyx_L1_error)
+    __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 252, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_12 = (__Pyx_PyDict_ContainsTF(__pyx_t_1, __pyx_v_converter, Py_EQ)); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(1, 336, __pyx_L1_error)
+    __pyx_t_12 = (__Pyx_PyDict_ContainsTF(__pyx_t_1, __pyx_v_converter, Py_EQ)); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 252, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_t_14 = (__pyx_t_12 != 0);
     if (__pyx_t_14) {
 
-      /* "druhg/_druhg_label.pyx":337
+      /* "druhg/_druhg_label.pyx":253
  *         p = labels_arr[i]
  *         if p in converter:
  *             label = converter[p]             # <<<<<<<<<<<<<<
  *         else:
  *             label = max_label
  */
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 337, __pyx_L1_error)
+      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 253, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_6 = __Pyx_PyDict_GetItem(__pyx_v_converter, __pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 337, __pyx_L1_error)
+      __pyx_t_6 = __Pyx_PyDict_GetItem(__pyx_v_converter, __pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 253, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_t_13 = __Pyx_PyIndex_AsSsize_t(__pyx_t_6); if (unlikely((__pyx_t_13 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 337, __pyx_L1_error)
+      __pyx_t_13 = __Pyx_PyIndex_AsSsize_t(__pyx_t_6); if (unlikely((__pyx_t_13 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 253, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
       __pyx_v_label = __pyx_t_13;
 
-      /* "druhg/_druhg_label.pyx":336
+      /* "druhg/_druhg_label.pyx":252
  *         i -= 1
  *         p = labels_arr[i]
  *         if p in converter:             # <<<<<<<<<<<<<<
  *             label = converter[p]
  *         else:
  */
       goto __pyx_L5;
     }
 
-    /* "druhg/_druhg_label.pyx":339
+    /* "druhg/_druhg_label.pyx":255
  *             label = converter[p]
  *         else:
  *             label = max_label             # <<<<<<<<<<<<<<
  *             converter[p] = max_label
  *             max_label += 1
  */
     /*else*/ {
       __pyx_v_label = __pyx_v_max_label;
 
-      /* "druhg/_druhg_label.pyx":340
+      /* "druhg/_druhg_label.pyx":256
  *         else:
  *             label = max_label
  *             converter[p] = max_label             # <<<<<<<<<<<<<<
  *             max_label += 1
  *         result[i] = label
  */
-      __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_max_label); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 340, __pyx_L1_error)
+      __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_max_label); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 256, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 340, __pyx_L1_error)
+      __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_p); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 256, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      if (unlikely((PyDict_SetItem(__pyx_v_converter, __pyx_t_1, __pyx_t_6) < 0))) __PYX_ERR(1, 340, __pyx_L1_error)
+      if (unlikely((PyDict_SetItem(__pyx_v_converter, __pyx_t_1, __pyx_t_6) < 0))) __PYX_ERR(0, 256, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
 
-      /* "druhg/_druhg_label.pyx":341
+      /* "druhg/_druhg_label.pyx":257
  *             label = max_label
  *             converter[p] = max_label
  *             max_label += 1             # <<<<<<<<<<<<<<
  *         result[i] = label
  * 
  */
       __pyx_v_max_label = (__pyx_v_max_label + 1);
     }
     __pyx_L5:;
 
-    /* "druhg/_druhg_label.pyx":342
+    /* "druhg/_druhg_label.pyx":258
  *             converter[p] = max_label
  *             max_label += 1
  *         result[i] = label             # <<<<<<<<<<<<<<
  * 
  *     return result_arr
  */
     (__pyx_v_result[__pyx_v_i]) = __pyx_v_label;
   }
 
-  /* "druhg/_druhg_label.pyx":344
+  /* "druhg/_druhg_label.pyx":260
  *         result[i] = label
  * 
  *     return result_arr             # <<<<<<<<<<<<<<
  */
   __Pyx_XDECREF((PyObject *)__pyx_r);
   __Pyx_INCREF((PyObject *)__pyx_v_result_arr);
   __pyx_r = ((PyArrayObject *)__pyx_v_result_arr);
   goto __pyx_L0;
 
-  /* "druhg/_druhg_label.pyx":319
+  /* "druhg/_druhg_label.pyx":235
  * 
  * 
  * cdef np.ndarray pretty(np.ndarray labels_arr):             # <<<<<<<<<<<<<<
  *     """ Relabels to pretty positive integers.
  *     """
  */
 
@@ -7430,15 +6258,15 @@
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  *     return PyArray_MultiIterNew(1, <void*>a)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 778, __pyx_L1_error)
+  __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 778, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":777
  * ctypedef npy_cdouble     complex_t
@@ -7480,15 +6308,15 @@
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 781, __pyx_L1_error)
+  __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 781, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":780
  *     return PyArray_MultiIterNew(1, <void*>a)
@@ -7530,15 +6358,15 @@
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 784, __pyx_L1_error)
+  __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 784, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":783
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
@@ -7580,15 +6408,15 @@
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 787, __pyx_L1_error)
+  __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 787, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":786
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
@@ -7630,15 +6458,15 @@
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)             # <<<<<<<<<<<<<<
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 790, __pyx_L1_error)
+  __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 790, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":789
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
@@ -7899,15 +6727,15 @@
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":985
  * cdef inline int import_array() except -1:
  *     try:
  *         __pyx_import_array()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")
  */
-      __pyx_t_4 = _import_array(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(2, 985, __pyx_L3_error)
+      __pyx_t_4 = _import_array(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 985, __pyx_L3_error)
 
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":984
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
@@ -7925,31 +6753,31 @@
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
-      if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(2, 986, __pyx_L5_except_error)
+      if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 986, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":987
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 987, __pyx_L5_except_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 987, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __PYX_ERR(2, 987, __pyx_L5_except_error)
+      __PYX_ERR(1, 987, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
     /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":984
  * # Cython code.
  * cdef inline int import_array() except -1:
@@ -8031,15 +6859,15 @@
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":991
  * cdef inline int import_umath() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
-      __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(2, 991, __pyx_L3_error)
+      __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 991, __pyx_L3_error)
 
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":990
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
@@ -8057,31 +6885,31 @@
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
-      if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(2, 992, __pyx_L5_except_error)
+      if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 992, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":993
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 993, __pyx_L5_except_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 993, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __PYX_ERR(2, 993, __pyx_L5_except_error)
+      __PYX_ERR(1, 993, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
     /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":990
  * 
  * cdef inline int import_umath() except -1:
@@ -8163,15 +6991,15 @@
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":997
  * cdef inline int import_ufunc() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
-      __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(2, 997, __pyx_L3_error)
+      __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 997, __pyx_L3_error)
 
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":996
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
@@ -8189,31 +7017,31 @@
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
-      if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(2, 998, __pyx_L5_except_error)
+      if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 998, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
       /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":999
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(2, 999, __pyx_L5_except_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 999, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __PYX_ERR(2, 999, __pyx_L5_except_error)
+      __PYX_ERR(1, 999, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
     /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":996
  * 
  * cdef inline int import_ufunc() except -1:
@@ -8421,170 +7249,14 @@
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
-static struct __pyx_vtabstruct_5druhg_12_druhg_label_UnionFind __pyx_vtable_5druhg_12_druhg_label_UnionFind;
-
-static PyObject *__pyx_tp_new_5druhg_12_druhg_label_UnionFind(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
-  struct __pyx_obj_5druhg_12_druhg_label_UnionFind *p;
-  PyObject *o;
-  #if CYTHON_COMPILING_IN_LIMITED_API
-  allocfunc alloc_func = (allocfunc)PyType_GetSlot(t, Py_tp_alloc);
-  o = alloc_func(t, 0);
-  #else
-  if (likely(!__Pyx_PyType_HasFeature(t, Py_TPFLAGS_IS_ABSTRACT))) {
-    o = (*t->tp_alloc)(t, 0);
-  } else {
-    o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
-  }
-  if (unlikely(!o)) return 0;
-  #endif
-  p = ((struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)o);
-  p->__pyx_vtab = __pyx_vtabptr_5druhg_12_druhg_label_UnionFind;
-  p->parent_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
-  return o;
-}
-
-static void __pyx_tp_dealloc_5druhg_12_druhg_label_UnionFind(PyObject *o) {
-  struct __pyx_obj_5druhg_12_druhg_label_UnionFind *p = (struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)o;
-  #if CYTHON_USE_TP_FINALIZE
-  if (unlikely((PY_VERSION_HEX >= 0x03080000 || __Pyx_PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE)) && __Pyx_PyObject_GetSlot(o, tp_finalize, destructor)) && !_PyGC_FINALIZED(o)) {
-    if (__Pyx_PyObject_GetSlot(o, tp_dealloc, destructor) == __pyx_tp_dealloc_5druhg_12_druhg_label_UnionFind) {
-      if (PyObject_CallFinalizerFromDealloc(o)) return;
-    }
-  }
-  #endif
-  PyObject_GC_UnTrack(o);
-  Py_CLEAR(p->parent_arr);
-  (*Py_TYPE(o)->tp_free)(o);
-}
-
-static int __pyx_tp_traverse_5druhg_12_druhg_label_UnionFind(PyObject *o, visitproc v, void *a) {
-  int e;
-  struct __pyx_obj_5druhg_12_druhg_label_UnionFind *p = (struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)o;
-  if (p->parent_arr) {
-    e = (*v)(((PyObject *)p->parent_arr), a); if (e) return e;
-  }
-  return 0;
-}
-
-static int __pyx_tp_clear_5druhg_12_druhg_label_UnionFind(PyObject *o) {
-  PyObject* tmp;
-  struct __pyx_obj_5druhg_12_druhg_label_UnionFind *p = (struct __pyx_obj_5druhg_12_druhg_label_UnionFind *)o;
-  tmp = ((PyObject*)p->parent_arr);
-  p->parent_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  return 0;
-}
-
-static PyMethodDef __pyx_methods_5druhg_12_druhg_label_UnionFind[] = {
-  {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_9UnionFind_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
-  {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_12_druhg_label_9UnionFind_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
-  {0, 0, 0, 0}
-};
-#if CYTHON_USE_TYPE_SPECS
-static PyType_Slot __pyx_type_5druhg_12_druhg_label_UnionFind_slots[] = {
-  {Py_tp_dealloc, (void *)__pyx_tp_dealloc_5druhg_12_druhg_label_UnionFind},
-  {Py_tp_traverse, (void *)__pyx_tp_traverse_5druhg_12_druhg_label_UnionFind},
-  {Py_tp_clear, (void *)__pyx_tp_clear_5druhg_12_druhg_label_UnionFind},
-  {Py_tp_methods, (void *)__pyx_methods_5druhg_12_druhg_label_UnionFind},
-  {Py_tp_init, (void *)__pyx_pw_5druhg_12_druhg_label_9UnionFind_1__init__},
-  {Py_tp_new, (void *)__pyx_tp_new_5druhg_12_druhg_label_UnionFind},
-  {0, 0},
-};
-static PyType_Spec __pyx_type_5druhg_12_druhg_label_UnionFind_spec = {
-  "druhg._druhg_label.UnionFind",
-  sizeof(struct __pyx_obj_5druhg_12_druhg_label_UnionFind),
-  0,
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC,
-  __pyx_type_5druhg_12_druhg_label_UnionFind_slots,
-};
-#else
-
-static PyTypeObject __pyx_type_5druhg_12_druhg_label_UnionFind = {
-  PyVarObject_HEAD_INIT(0, 0)
-  "druhg._druhg_label.""UnionFind", /*tp_name*/
-  sizeof(struct __pyx_obj_5druhg_12_druhg_label_UnionFind), /*tp_basicsize*/
-  0, /*tp_itemsize*/
-  __pyx_tp_dealloc_5druhg_12_druhg_label_UnionFind, /*tp_dealloc*/
-  #if PY_VERSION_HEX < 0x030800b4
-  0, /*tp_print*/
-  #endif
-  #if PY_VERSION_HEX >= 0x030800b4
-  0, /*tp_vectorcall_offset*/
-  #endif
-  0, /*tp_getattr*/
-  0, /*tp_setattr*/
-  #if PY_MAJOR_VERSION < 3
-  0, /*tp_compare*/
-  #endif
-  #if PY_MAJOR_VERSION >= 3
-  0, /*tp_as_async*/
-  #endif
-  0, /*tp_repr*/
-  0, /*tp_as_number*/
-  0, /*tp_as_sequence*/
-  0, /*tp_as_mapping*/
-  0, /*tp_hash*/
-  0, /*tp_call*/
-  0, /*tp_str*/
-  0, /*tp_getattro*/
-  0, /*tp_setattro*/
-  0, /*tp_as_buffer*/
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
-  0, /*tp_doc*/
-  __pyx_tp_traverse_5druhg_12_druhg_label_UnionFind, /*tp_traverse*/
-  __pyx_tp_clear_5druhg_12_druhg_label_UnionFind, /*tp_clear*/
-  0, /*tp_richcompare*/
-  0, /*tp_weaklistoffset*/
-  0, /*tp_iter*/
-  0, /*tp_iternext*/
-  __pyx_methods_5druhg_12_druhg_label_UnionFind, /*tp_methods*/
-  0, /*tp_members*/
-  0, /*tp_getset*/
-  0, /*tp_base*/
-  0, /*tp_dict*/
-  0, /*tp_descr_get*/
-  0, /*tp_descr_set*/
-  #if !CYTHON_USE_TYPE_SPECS
-  0, /*tp_dictoffset*/
-  #endif
-  __pyx_pw_5druhg_12_druhg_label_9UnionFind_1__init__, /*tp_init*/
-  0, /*tp_alloc*/
-  __pyx_tp_new_5druhg_12_druhg_label_UnionFind, /*tp_new*/
-  0, /*tp_free*/
-  0, /*tp_is_gc*/
-  0, /*tp_bases*/
-  0, /*tp_mro*/
-  0, /*tp_cache*/
-  0, /*tp_subclasses*/
-  0, /*tp_weaklist*/
-  0, /*tp_del*/
-  0, /*tp_version_tag*/
-  #if PY_VERSION_HEX >= 0x030400a1
-  #if CYTHON_USE_TP_FINALIZE
-  0, /*tp_finalize*/
-  #else
-  NULL, /*tp_finalize*/
-  #endif
-  #endif
-  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
-  0, /*tp_vectorcall*/
-  #endif
-  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
-  0, /*tp_print*/
-  #endif
-  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
-  0, /*tp_pypy_flags*/
-  #endif
-};
-#endif
 
 static PyMethodDef __pyx_methods[] = {
   {0, 0, 0, 0}
 };
 #ifndef CYTHON_SMALL_CODE
 #if defined(__clang__)
     #define CYTHON_SMALL_CODE
@@ -8594,205 +7266,136 @@
     #define CYTHON_SMALL_CODE
 #endif
 #endif
 /* #### Code section: pystring_table ### */
 
 static __Pyx_StringTabEntry __pyx_string_tab[] = {
   #if CYTHON_USE_MODULE_STATE
-  {0, __pyx_k_Amalgamation, sizeof(__pyx_k_Amalgamation), 0, 0, 1, 1},
+  {0, __pyx_k_AssertionError, sizeof(__pyx_k_AssertionError), 0, 0, 1, 1},
+  {0, __pyx_k_ERROR_labels_buffer_is_too_small, sizeof(__pyx_k_ERROR_labels_buffer_is_too_small), 0, 1, 0, 0},
+  {0, __pyx_k_Group, sizeof(__pyx_k_Group), 0, 0, 1, 1},
   {0, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
-  {0, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
-  {0, __pyx_k_PRECISION, sizeof(__pyx_k_PRECISION), 0, 0, 1, 1},
-  {0, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
-  {0, __pyx_k_U, sizeof(__pyx_k_U), 0, 0, 1, 1},
   {0, __pyx_k_UnionFind, sizeof(__pyx_k_UnionFind), 0, 0, 1, 1},
-  {0, __pyx_k_UnionFind___reduce_cython, sizeof(__pyx_k_UnionFind___reduce_cython), 0, 0, 1, 1},
-  {0, __pyx_k_UnionFind___setstate_cython, sizeof(__pyx_k_UnionFind___setstate_cython), 0, 0, 1, 1},
-  {0, __pyx_k__14, sizeof(__pyx_k__14), 0, 0, 1, 1},
   {0, __pyx_k__3, sizeof(__pyx_k__3), 0, 0, 1, 1},
+  {0, __pyx_k__9, sizeof(__pyx_k__9), 0, 0, 1, 1},
+  {0, __pyx_k_allocate_buffer_labels, sizeof(__pyx_k_allocate_buffer_labels), 0, 0, 1, 1},
   {0, __pyx_k_are_considered_as_noise, sizeof(__pyx_k_are_considered_as_noise), 0, 1, 0, 0},
   {0, __pyx_k_asyncio_coroutines, sizeof(__pyx_k_asyncio_coroutines), 0, 0, 1, 1},
-  {0, __pyx_k_being, sizeof(__pyx_k_being), 0, 0, 1, 1},
-  {0, __pyx_k_being1, sizeof(__pyx_k_being1), 0, 0, 1, 1},
-  {0, __pyx_k_being2, sizeof(__pyx_k_being2), 0, 0, 1, 1},
-  {0, __pyx_k_being3, sizeof(__pyx_k_being3), 0, 0, 1, 1},
-  {0, __pyx_k_c, sizeof(__pyx_k_c), 0, 0, 1, 1},
   {0, __pyx_k_ceil, sizeof(__pyx_k_ceil), 0, 0, 1, 1},
   {0, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
-  {0, __pyx_k_clusters, sizeof(__pyx_k_clusters), 0, 0, 1, 1},
-  {0, __pyx_k_d, sizeof(__pyx_k_d), 0, 0, 1, 1},
-  {0, __pyx_k_disable, sizeof(__pyx_k_disable), 0, 1, 0, 0},
-  {0, __pyx_k_disc, sizeof(__pyx_k_disc), 0, 0, 1, 1},
-  {0, __pyx_k_double_precision, sizeof(__pyx_k_double_precision), 0, 1, 0, 1},
-  {0, __pyx_k_double_precision2, sizeof(__pyx_k_double_precision2), 0, 1, 0, 1},
   {0, __pyx_k_druhg__druhg_label, sizeof(__pyx_k_druhg__druhg_label), 0, 0, 1, 1},
   {0, __pyx_k_druhg__druhg_label_pyx, sizeof(__pyx_k_druhg__druhg_label_pyx), 0, 0, 1, 0},
-  {0, __pyx_k_druhg_amalgamation, sizeof(__pyx_k_druhg_amalgamation), 0, 0, 1, 1},
+  {0, __pyx_k_druhg_group, sizeof(__pyx_k_druhg_group), 0, 0, 1, 1},
+  {0, __pyx_k_druhg_unionfind, sizeof(__pyx_k_druhg_unionfind), 0, 0, 1, 1},
   {0, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
-  {0, __pyx_k_e1, sizeof(__pyx_k_e1), 0, 0, 1, 1},
-  {0, __pyx_k_e2, sizeof(__pyx_k_e2), 0, 0, 1, 1},
-  {0, __pyx_k_e3, sizeof(__pyx_k_e3), 0, 0, 1, 1},
-  {0, __pyx_k_edges_arr, sizeof(__pyx_k_edges_arr), 0, 0, 1, 1},
-  {0, __pyx_k_emerge_clusters, sizeof(__pyx_k_emerge_clusters), 0, 0, 1, 1},
-  {0, __pyx_k_enable, sizeof(__pyx_k_enable), 0, 1, 0, 0},
-  {0, __pyx_k_enumerate, sizeof(__pyx_k_enumerate), 0, 0, 1, 1},
+  {0, __pyx_k_edgepairs_arr, sizeof(__pyx_k_edgepairs_arr), 0, 0, 1, 1},
+  {0, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
   {0, __pyx_k_exclude, sizeof(__pyx_k_exclude), 0, 0, 1, 1},
+  {0, __pyx_k_fill, sizeof(__pyx_k_fill), 0, 0, 1, 1},
   {0, __pyx_k_fix_outliers, sizeof(__pyx_k_fix_outliers), 0, 0, 1, 1},
-  {0, __pyx_k_gc, sizeof(__pyx_k_gc), 0, 1, 0, 0},
-  {0, __pyx_k_get, sizeof(__pyx_k_get), 0, 0, 1, 1},
-  {0, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
-  {0, __pyx_k_i, sizeof(__pyx_k_i), 0, 0, 1, 1},
+  {0, __pyx_k_group_arr, sizeof(__pyx_k_group_arr), 0, 0, 1, 1},
   {0, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {0, __pyx_k_initializing, sizeof(__pyx_k_initializing), 0, 0, 1, 1},
   {0, __pyx_k_intp, sizeof(__pyx_k_intp), 0, 0, 1, 1},
   {0, __pyx_k_is_coroutine, sizeof(__pyx_k_is_coroutine), 0, 0, 1, 1},
-  {0, __pyx_k_is_reciprocal, sizeof(__pyx_k_is_reciprocal), 0, 0, 1, 1},
-  {0, __pyx_k_isenabled, sizeof(__pyx_k_isenabled), 0, 1, 0, 0},
-  {0, __pyx_k_jump1, sizeof(__pyx_k_jump1), 0, 0, 1, 1},
-  {0, __pyx_k_jump2, sizeof(__pyx_k_jump2), 0, 0, 1, 1},
-  {0, __pyx_k_kwargs, sizeof(__pyx_k_kwargs), 0, 0, 1, 1},
   {0, __pyx_k_label, sizeof(__pyx_k_label), 0, 0, 1, 1},
   {0, __pyx_k_label_default_value_for_limit1_i, sizeof(__pyx_k_label_default_value_for_limit1_i), 0, 1, 0, 0},
   {0, __pyx_k_label_default_value_for_limit2_i, sizeof(__pyx_k_label_default_value_for_limit2_i), 0, 1, 0, 0},
   {0, __pyx_k_limit1, sizeof(__pyx_k_limit1), 0, 0, 1, 1},
   {0, __pyx_k_limit2, sizeof(__pyx_k_limit2), 0, 0, 1, 1},
   {0, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
   {0, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
   {0, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
   {0, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {0, __pyx_k_numpy_core_multiarray_failed_to, sizeof(__pyx_k_numpy_core_multiarray_failed_to), 0, 1, 0, 0},
   {0, __pyx_k_numpy_core_umath_failed_to_impor, sizeof(__pyx_k_numpy_core_umath_failed_to_impor), 0, 1, 0, 0},
   {0, __pyx_k_ones, sizeof(__pyx_k_ones), 0, 0, 1, 1},
-  {0, __pyx_k_p1, sizeof(__pyx_k_p1), 0, 0, 1, 1},
-  {0, __pyx_k_p2, sizeof(__pyx_k_p2), 0, 0, 1, 1},
-  {0, __pyx_k_pop, sizeof(__pyx_k_pop), 0, 0, 1, 1},
+  {0, __pyx_k_precision, sizeof(__pyx_k_precision), 0, 0, 1, 1},
   {0, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
-  {0, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
   {0, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {0, __pyx_k_range, sizeof(__pyx_k_range), 0, 0, 1, 1},
-  {0, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
-  {0, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
-  {0, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
+  {0, __pyx_k_ranks_arr, sizeof(__pyx_k_ranks_arr), 0, 0, 1, 1},
   {0, __pyx_k_remove, sizeof(__pyx_k_remove), 0, 0, 1, 1},
-  {0, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
-  {0, __pyx_k_self_parent_cannot_be_converted, sizeof(__pyx_k_self_parent_cannot_be_converted), 0, 0, 1, 0},
-  {0, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
-  {0, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
+  {0, __pyx_k_ret_labels, sizeof(__pyx_k_ret_labels), 0, 0, 1, 1},
   {0, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
   {0, __pyx_k_spec, sizeof(__pyx_k_spec), 0, 0, 1, 1},
   {0, __pyx_k_sqrt, sizeof(__pyx_k_sqrt), 0, 0, 1, 1},
-  {0, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
   {0, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
+  {0, __pyx_k_uf_arr, sizeof(__pyx_k_uf_arr), 0, 0, 1, 1},
   {0, __pyx_k_unique, sizeof(__pyx_k_unique), 0, 0, 1, 1},
   {0, __pyx_k_update, sizeof(__pyx_k_update), 0, 0, 1, 1},
-  {0, __pyx_k_v, sizeof(__pyx_k_v), 0, 0, 1, 1},
   {0, __pyx_k_values_arr, sizeof(__pyx_k_values_arr), 0, 0, 1, 1},
   {0, __pyx_k_will_not_be_formed, sizeof(__pyx_k_will_not_be_formed), 0, 1, 0, 0},
   {0, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   #else
-  {&__pyx_n_s_Amalgamation, __pyx_k_Amalgamation, sizeof(__pyx_k_Amalgamation), 0, 0, 1, 1},
+  {&__pyx_n_s_AssertionError, __pyx_k_AssertionError, sizeof(__pyx_k_AssertionError), 0, 0, 1, 1},
+  {&__pyx_kp_u_ERROR_labels_buffer_is_too_small, __pyx_k_ERROR_labels_buffer_is_too_small, sizeof(__pyx_k_ERROR_labels_buffer_is_too_small), 0, 1, 0, 0},
+  {&__pyx_n_s_Group, __pyx_k_Group, sizeof(__pyx_k_Group), 0, 0, 1, 1},
   {&__pyx_n_s_ImportError, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
-  {&__pyx_n_s_N, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
-  {&__pyx_n_s_PRECISION, __pyx_k_PRECISION, sizeof(__pyx_k_PRECISION), 0, 0, 1, 1},
-  {&__pyx_n_s_TypeError, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
-  {&__pyx_n_s_U, __pyx_k_U, sizeof(__pyx_k_U), 0, 0, 1, 1},
   {&__pyx_n_s_UnionFind, __pyx_k_UnionFind, sizeof(__pyx_k_UnionFind), 0, 0, 1, 1},
-  {&__pyx_n_s_UnionFind___reduce_cython, __pyx_k_UnionFind___reduce_cython, sizeof(__pyx_k_UnionFind___reduce_cython), 0, 0, 1, 1},
-  {&__pyx_n_s_UnionFind___setstate_cython, __pyx_k_UnionFind___setstate_cython, sizeof(__pyx_k_UnionFind___setstate_cython), 0, 0, 1, 1},
-  {&__pyx_n_s__14, __pyx_k__14, sizeof(__pyx_k__14), 0, 0, 1, 1},
   {&__pyx_n_s__3, __pyx_k__3, sizeof(__pyx_k__3), 0, 0, 1, 1},
+  {&__pyx_n_s__9, __pyx_k__9, sizeof(__pyx_k__9), 0, 0, 1, 1},
+  {&__pyx_n_s_allocate_buffer_labels, __pyx_k_allocate_buffer_labels, sizeof(__pyx_k_allocate_buffer_labels), 0, 0, 1, 1},
   {&__pyx_kp_u_are_considered_as_noise, __pyx_k_are_considered_as_noise, sizeof(__pyx_k_are_considered_as_noise), 0, 1, 0, 0},
   {&__pyx_n_s_asyncio_coroutines, __pyx_k_asyncio_coroutines, sizeof(__pyx_k_asyncio_coroutines), 0, 0, 1, 1},
-  {&__pyx_n_s_being, __pyx_k_being, sizeof(__pyx_k_being), 0, 0, 1, 1},
-  {&__pyx_n_s_being1, __pyx_k_being1, sizeof(__pyx_k_being1), 0, 0, 1, 1},
-  {&__pyx_n_s_being2, __pyx_k_being2, sizeof(__pyx_k_being2), 0, 0, 1, 1},
-  {&__pyx_n_s_being3, __pyx_k_being3, sizeof(__pyx_k_being3), 0, 0, 1, 1},
-  {&__pyx_n_s_c, __pyx_k_c, sizeof(__pyx_k_c), 0, 0, 1, 1},
   {&__pyx_n_s_ceil, __pyx_k_ceil, sizeof(__pyx_k_ceil), 0, 0, 1, 1},
   {&__pyx_n_s_cline_in_traceback, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
-  {&__pyx_n_s_clusters, __pyx_k_clusters, sizeof(__pyx_k_clusters), 0, 0, 1, 1},
-  {&__pyx_n_s_d, __pyx_k_d, sizeof(__pyx_k_d), 0, 0, 1, 1},
-  {&__pyx_kp_u_disable, __pyx_k_disable, sizeof(__pyx_k_disable), 0, 1, 0, 0},
-  {&__pyx_n_s_disc, __pyx_k_disc, sizeof(__pyx_k_disc), 0, 0, 1, 1},
-  {&__pyx_n_u_double_precision, __pyx_k_double_precision, sizeof(__pyx_k_double_precision), 0, 1, 0, 1},
-  {&__pyx_n_u_double_precision2, __pyx_k_double_precision2, sizeof(__pyx_k_double_precision2), 0, 1, 0, 1},
   {&__pyx_n_s_druhg__druhg_label, __pyx_k_druhg__druhg_label, sizeof(__pyx_k_druhg__druhg_label), 0, 0, 1, 1},
   {&__pyx_kp_s_druhg__druhg_label_pyx, __pyx_k_druhg__druhg_label_pyx, sizeof(__pyx_k_druhg__druhg_label_pyx), 0, 0, 1, 0},
-  {&__pyx_n_s_druhg_amalgamation, __pyx_k_druhg_amalgamation, sizeof(__pyx_k_druhg_amalgamation), 0, 0, 1, 1},
+  {&__pyx_n_s_druhg_group, __pyx_k_druhg_group, sizeof(__pyx_k_druhg_group), 0, 0, 1, 1},
+  {&__pyx_n_s_druhg_unionfind, __pyx_k_druhg_unionfind, sizeof(__pyx_k_druhg_unionfind), 0, 0, 1, 1},
   {&__pyx_n_s_dtype, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
-  {&__pyx_n_s_e1, __pyx_k_e1, sizeof(__pyx_k_e1), 0, 0, 1, 1},
-  {&__pyx_n_s_e2, __pyx_k_e2, sizeof(__pyx_k_e2), 0, 0, 1, 1},
-  {&__pyx_n_s_e3, __pyx_k_e3, sizeof(__pyx_k_e3), 0, 0, 1, 1},
-  {&__pyx_n_s_edges_arr, __pyx_k_edges_arr, sizeof(__pyx_k_edges_arr), 0, 0, 1, 1},
-  {&__pyx_n_s_emerge_clusters, __pyx_k_emerge_clusters, sizeof(__pyx_k_emerge_clusters), 0, 0, 1, 1},
-  {&__pyx_kp_u_enable, __pyx_k_enable, sizeof(__pyx_k_enable), 0, 1, 0, 0},
-  {&__pyx_n_s_enumerate, __pyx_k_enumerate, sizeof(__pyx_k_enumerate), 0, 0, 1, 1},
+  {&__pyx_n_s_edgepairs_arr, __pyx_k_edgepairs_arr, sizeof(__pyx_k_edgepairs_arr), 0, 0, 1, 1},
+  {&__pyx_n_s_empty, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
   {&__pyx_n_s_exclude, __pyx_k_exclude, sizeof(__pyx_k_exclude), 0, 0, 1, 1},
+  {&__pyx_n_s_fill, __pyx_k_fill, sizeof(__pyx_k_fill), 0, 0, 1, 1},
   {&__pyx_n_s_fix_outliers, __pyx_k_fix_outliers, sizeof(__pyx_k_fix_outliers), 0, 0, 1, 1},
-  {&__pyx_kp_u_gc, __pyx_k_gc, sizeof(__pyx_k_gc), 0, 1, 0, 0},
-  {&__pyx_n_s_get, __pyx_k_get, sizeof(__pyx_k_get), 0, 0, 1, 1},
-  {&__pyx_n_s_getstate, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
-  {&__pyx_n_s_i, __pyx_k_i, sizeof(__pyx_k_i), 0, 0, 1, 1},
+  {&__pyx_n_s_group_arr, __pyx_k_group_arr, sizeof(__pyx_k_group_arr), 0, 0, 1, 1},
   {&__pyx_n_s_import, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {&__pyx_n_s_initializing, __pyx_k_initializing, sizeof(__pyx_k_initializing), 0, 0, 1, 1},
   {&__pyx_n_s_intp, __pyx_k_intp, sizeof(__pyx_k_intp), 0, 0, 1, 1},
   {&__pyx_n_s_is_coroutine, __pyx_k_is_coroutine, sizeof(__pyx_k_is_coroutine), 0, 0, 1, 1},
-  {&__pyx_n_s_is_reciprocal, __pyx_k_is_reciprocal, sizeof(__pyx_k_is_reciprocal), 0, 0, 1, 1},
-  {&__pyx_kp_u_isenabled, __pyx_k_isenabled, sizeof(__pyx_k_isenabled), 0, 1, 0, 0},
-  {&__pyx_n_s_jump1, __pyx_k_jump1, sizeof(__pyx_k_jump1), 0, 0, 1, 1},
-  {&__pyx_n_s_jump2, __pyx_k_jump2, sizeof(__pyx_k_jump2), 0, 0, 1, 1},
-  {&__pyx_n_s_kwargs, __pyx_k_kwargs, sizeof(__pyx_k_kwargs), 0, 0, 1, 1},
   {&__pyx_n_s_label, __pyx_k_label, sizeof(__pyx_k_label), 0, 0, 1, 1},
   {&__pyx_kp_u_label_default_value_for_limit1_i, __pyx_k_label_default_value_for_limit1_i, sizeof(__pyx_k_label_default_value_for_limit1_i), 0, 1, 0, 0},
   {&__pyx_kp_u_label_default_value_for_limit2_i, __pyx_k_label_default_value_for_limit2_i, sizeof(__pyx_k_label_default_value_for_limit2_i), 0, 1, 0, 0},
   {&__pyx_n_s_limit1, __pyx_k_limit1, sizeof(__pyx_k_limit1), 0, 0, 1, 1},
   {&__pyx_n_s_limit2, __pyx_k_limit2, sizeof(__pyx_k_limit2), 0, 0, 1, 1},
   {&__pyx_n_s_main, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
   {&__pyx_n_s_name, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
   {&__pyx_n_s_np, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
   {&__pyx_n_s_numpy, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {&__pyx_kp_u_numpy_core_multiarray_failed_to, __pyx_k_numpy_core_multiarray_failed_to, sizeof(__pyx_k_numpy_core_multiarray_failed_to), 0, 1, 0, 0},
   {&__pyx_kp_u_numpy_core_umath_failed_to_impor, __pyx_k_numpy_core_umath_failed_to_impor, sizeof(__pyx_k_numpy_core_umath_failed_to_impor), 0, 1, 0, 0},
   {&__pyx_n_s_ones, __pyx_k_ones, sizeof(__pyx_k_ones), 0, 0, 1, 1},
-  {&__pyx_n_s_p1, __pyx_k_p1, sizeof(__pyx_k_p1), 0, 0, 1, 1},
-  {&__pyx_n_s_p2, __pyx_k_p2, sizeof(__pyx_k_p2), 0, 0, 1, 1},
-  {&__pyx_n_s_pop, __pyx_k_pop, sizeof(__pyx_k_pop), 0, 0, 1, 1},
+  {&__pyx_n_s_precision, __pyx_k_precision, sizeof(__pyx_k_precision), 0, 0, 1, 1},
   {&__pyx_n_s_print, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
-  {&__pyx_n_s_pyx_state, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_vtable, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {&__pyx_n_s_range, __pyx_k_range, sizeof(__pyx_k_range), 0, 0, 1, 1},
-  {&__pyx_n_s_reduce, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
-  {&__pyx_n_s_reduce_cython, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
-  {&__pyx_n_s_reduce_ex, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
+  {&__pyx_n_s_ranks_arr, __pyx_k_ranks_arr, sizeof(__pyx_k_ranks_arr), 0, 0, 1, 1},
   {&__pyx_n_s_remove, __pyx_k_remove, sizeof(__pyx_k_remove), 0, 0, 1, 1},
-  {&__pyx_n_s_self, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
-  {&__pyx_kp_s_self_parent_cannot_be_converted, __pyx_k_self_parent_cannot_be_converted, sizeof(__pyx_k_self_parent_cannot_be_converted), 0, 0, 1, 0},
-  {&__pyx_n_s_setstate, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
-  {&__pyx_n_s_setstate_cython, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
+  {&__pyx_n_s_ret_labels, __pyx_k_ret_labels, sizeof(__pyx_k_ret_labels), 0, 0, 1, 1},
   {&__pyx_n_s_size, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
   {&__pyx_n_s_spec, __pyx_k_spec, sizeof(__pyx_k_spec), 0, 0, 1, 1},
   {&__pyx_n_s_sqrt, __pyx_k_sqrt, sizeof(__pyx_k_sqrt), 0, 0, 1, 1},
-  {&__pyx_kp_s_stringsource, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
   {&__pyx_n_s_test, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
+  {&__pyx_n_s_uf_arr, __pyx_k_uf_arr, sizeof(__pyx_k_uf_arr), 0, 0, 1, 1},
   {&__pyx_n_s_unique, __pyx_k_unique, sizeof(__pyx_k_unique), 0, 0, 1, 1},
   {&__pyx_n_s_update, __pyx_k_update, sizeof(__pyx_k_update), 0, 0, 1, 1},
-  {&__pyx_n_s_v, __pyx_k_v, sizeof(__pyx_k_v), 0, 0, 1, 1},
   {&__pyx_n_s_values_arr, __pyx_k_values_arr, sizeof(__pyx_k_values_arr), 0, 0, 1, 1},
   {&__pyx_kp_u_will_not_be_formed, __pyx_k_will_not_be_formed, sizeof(__pyx_k_will_not_be_formed), 0, 1, 0, 0},
   {&__pyx_n_s_zeros, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   #endif
   {0, 0, 0, 0, 0, 0, 0}
 };
 /* #### Code section: cached_builtins ### */
 static CYTHON_SMALL_CODE int __Pyx_InitCachedBuiltins(void) {
-  __pyx_builtin_TypeError = __Pyx_GetBuiltinName(__pyx_n_s_TypeError); if (!__pyx_builtin_TypeError) __PYX_ERR(0, 2, __pyx_L1_error)
-  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(1, 129, __pyx_L1_error)
-  __pyx_builtin_enumerate = __Pyx_GetBuiltinName(__pyx_n_s_enumerate); if (!__pyx_builtin_enumerate) __PYX_ERR(1, 181, __pyx_L1_error)
-  __pyx_builtin_print = __Pyx_GetBuiltinName(__pyx_n_s_print); if (!__pyx_builtin_print) __PYX_ERR(1, 290, __pyx_L1_error)
-  __pyx_builtin_ImportError = __Pyx_GetBuiltinName(__pyx_n_s_ImportError); if (!__pyx_builtin_ImportError) __PYX_ERR(2, 987, __pyx_L1_error)
+  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_builtin_AssertionError = __Pyx_GetBuiltinName(__pyx_n_s_AssertionError); if (!__pyx_builtin_AssertionError) __PYX_ERR(0, 106, __pyx_L1_error)
+  __pyx_builtin_print = __Pyx_GetBuiltinName(__pyx_n_s_print); if (!__pyx_builtin_print) __PYX_ERR(0, 200, __pyx_L1_error)
+  __pyx_builtin_ImportError = __Pyx_GetBuiltinName(__pyx_n_s_ImportError); if (!__pyx_builtin_ImportError) __PYX_ERR(1, 987, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: cached_constants ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
@@ -8802,198 +7405,133 @@
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":987
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
-  __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple_)) __PYX_ERR(2, 987, __pyx_L1_error)
+  __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple_)) __PYX_ERR(1, 987, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple_);
   __Pyx_GIVEREF(__pyx_tuple_);
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":993
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
-  __pyx_tuple__2 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(2, 993, __pyx_L1_error)
+  __pyx_tuple__2 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(1, 993, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__2);
   __Pyx_GIVEREF(__pyx_tuple__2);
 
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
+  /* "druhg/_druhg_label.pyx":27
+ * from ._druhg_group cimport Group
+ * 
+ * def allocate_buffer_labels(np.intp_t size):             # <<<<<<<<<<<<<<
+ *     return np.empty(size, dtype=np.intp)
+ * 
  */
-  __pyx_tuple__4 = PyTuple_Pack(1, __pyx_n_s_self); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_tuple__4 = PyTuple_Pack(1, __pyx_n_s_size); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(0, 27, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__4);
   __Pyx_GIVEREF(__pyx_tuple__4);
-  __pyx_codeobj__5 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__4, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__5)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_codeobj__5 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__4, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_label_pyx, __pyx_n_s_allocate_buffer_labels, 27, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__5)) __PYX_ERR(0, 27, __pyx_L1_error)
 
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
+  /* "druhg/_druhg_label.pyx":137
+ *     return ret_clusters
+ * 
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,             # <<<<<<<<<<<<<<
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
  */
-  __pyx_tuple__6 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_pyx_state); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 3, __pyx_L1_error)
+  __pyx_tuple__6 = PyTuple_Pack(12, __pyx_n_s_values_arr, __pyx_n_s_uf_arr, __pyx_n_s_size, __pyx_n_s_group_arr, __pyx_n_s_ret_labels, __pyx_n_s_ranks_arr, __pyx_n_s_exclude, __pyx_n_s_limit1, __pyx_n_s_limit2, __pyx_n_s_fix_outliers, __pyx_n_s_edgepairs_arr, __pyx_n_s_precision); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 137, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__6);
   __Pyx_GIVEREF(__pyx_tuple__6);
-  __pyx_codeobj__7 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 3, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__7)) __PYX_ERR(0, 3, __pyx_L1_error)
-
-  /* "druhg/_druhg_label.pyx":157
- *     return
- * 
- * def emerge_clusters(UnionFind U, np.ndarray edges_arr, np.ndarray values_arr, np.intp_t limit1, np.intp_t limit2, \             # <<<<<<<<<<<<<<
- *                     list exclude, is_reciprocal = 1, **kwargs):
- * 
- */
-  __pyx_tuple__8 = PyTuple_Pack(26, __pyx_n_s_U, __pyx_n_s_edges_arr, __pyx_n_s_values_arr, __pyx_n_s_limit1, __pyx_n_s_limit2, __pyx_n_s_exclude, __pyx_n_s_is_reciprocal, __pyx_n_s_kwargs, __pyx_n_s_e1, __pyx_n_s_e2, __pyx_n_s_e3, __pyx_n_s_p1, __pyx_n_s_p2, __pyx_n_s_i, __pyx_n_s_c, __pyx_n_s_v, __pyx_n_s_being, __pyx_n_s_being1, __pyx_n_s_being2, __pyx_n_s_being3, __pyx_n_s_jump1, __pyx_n_s_jump2, __pyx_n_s_disc, __pyx_n_s_d, __pyx_n_s_clusters, __pyx_n_s_PRECISION); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(1, 157, __pyx_L1_error)
+  __pyx_codeobj__7 = (PyObject*)__Pyx_PyCode_New(12, 0, 0, 12, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_label_pyx, __pyx_n_s_label, 137, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__7)) __PYX_ERR(0, 137, __pyx_L1_error)
+  __pyx_tuple__8 = PyTuple_Pack(7, Py_None, Py_None, __pyx_int_0, __pyx_int_0, __pyx_int_0, Py_None, __pyx_float_0_0000001); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(0, 137, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__8);
   __Pyx_GIVEREF(__pyx_tuple__8);
-  __pyx_codeobj__9 = (PyObject*)__Pyx_PyCode_New(7, 0, 0, 26, 0, CO_OPTIMIZED|CO_NEWLOCALS|CO_VARKEYWORDS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__8, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_label_pyx, __pyx_n_s_emerge_clusters, 157, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__9)) __PYX_ERR(1, 157, __pyx_L1_error)
-  __pyx_tuple__10 = PyTuple_Pack(1, ((PyObject *)__pyx_int_1)); if (unlikely(!__pyx_tuple__10)) __PYX_ERR(1, 157, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__10);
-  __Pyx_GIVEREF(__pyx_tuple__10);
-
-  /* "druhg/_druhg_label.pyx":234
- * 
- * 
- * cpdef np.ndarray label(np.ndarray edges_arr, np.ndarray values_arr, int size = 0, list exclude = None, \             # <<<<<<<<<<<<<<
- *                        np.intp_t limit1 = 0, np.intp_t limit2 = 0, np.intp_t fix_outliers = 1, is_reciprocal = 1):
- *     """Returns cluster labels.
- */
-  __pyx_tuple__11 = PyTuple_Pack(8, __pyx_n_s_edges_arr, __pyx_n_s_values_arr, __pyx_n_s_size, __pyx_n_s_exclude, __pyx_n_s_limit1, __pyx_n_s_limit2, __pyx_n_s_fix_outliers, __pyx_n_s_is_reciprocal); if (unlikely(!__pyx_tuple__11)) __PYX_ERR(1, 234, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__11);
-  __Pyx_GIVEREF(__pyx_tuple__11);
-  __pyx_codeobj__12 = (PyObject*)__Pyx_PyCode_New(8, 0, 0, 8, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__11, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_label_pyx, __pyx_n_s_label, 234, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__12)) __PYX_ERR(1, 234, __pyx_L1_error)
-  __pyx_tuple__13 = PyTuple_Pack(6, __pyx_int_0, Py_None, __pyx_int_0, __pyx_int_0, __pyx_int_1, __pyx_int_1); if (unlikely(!__pyx_tuple__13)) __PYX_ERR(1, 234, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__13);
-  __Pyx_GIVEREF(__pyx_tuple__13);
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
 /* #### Code section: init_constants ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitConstants(void) {
-  __pyx_umethod_PyDict_Type_get.type = (PyObject*)&PyDict_Type;
-  __pyx_umethod_PyDict_Type_get.method_name = &__pyx_n_s_get;
-  __pyx_umethod_PyDict_Type_pop.type = (PyObject*)&PyDict_Type;
-  __pyx_umethod_PyDict_Type_pop.method_name = &__pyx_n_s_pop;
-  __pyx_umethod_PyList_Type_pop.type = (PyObject*)&PyList_Type;
-  __pyx_umethod_PyList_Type_pop.method_name = &__pyx_n_s_pop;
   __pyx_umethod_PyList_Type_remove.type = (PyObject*)&PyList_Type;
   __pyx_umethod_PyList_Type_remove.method_name = &__pyx_n_s_remove;
   __pyx_umethod_PySet_Type_update.type = (PyObject*)&PySet_Type;
   __pyx_umethod_PySet_Type_update.method_name = &__pyx_n_s_update;
   #if CYTHON_USE_MODULE_STATE
-  if (__Pyx_InitString(__pyx_string_tab[0], &__pyx_n_s_Amalgamation) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[1], &__pyx_n_s_ImportError) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[2], &__pyx_n_s_N) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[3], &__pyx_n_s_PRECISION) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[4], &__pyx_n_s_TypeError) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[5], &__pyx_n_s_U) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[6], &__pyx_n_s_UnionFind) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[7], &__pyx_n_s_UnionFind___reduce_cython) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[8], &__pyx_n_s_UnionFind___setstate_cython) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[9], &__pyx_n_s__14) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[10], &__pyx_n_s__3) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[11], &__pyx_kp_u_are_considered_as_noise) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[12], &__pyx_n_s_asyncio_coroutines) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[13], &__pyx_n_s_being) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[14], &__pyx_n_s_being1) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[15], &__pyx_n_s_being2) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[16], &__pyx_n_s_being3) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[17], &__pyx_n_s_c) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[18], &__pyx_n_s_ceil) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[19], &__pyx_n_s_cline_in_traceback) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[20], &__pyx_n_s_clusters) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[21], &__pyx_n_s_d) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[22], &__pyx_kp_u_disable) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[23], &__pyx_n_s_disc) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[24], &__pyx_n_u_double_precision) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[25], &__pyx_n_u_double_precision2) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[26], &__pyx_n_s_druhg__druhg_label) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[27], &__pyx_kp_s_druhg__druhg_label_pyx) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[28], &__pyx_n_s_druhg_amalgamation) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[29], &__pyx_n_s_dtype) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[30], &__pyx_n_s_e1) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[31], &__pyx_n_s_e2) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[32], &__pyx_n_s_e3) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[33], &__pyx_n_s_edges_arr) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[34], &__pyx_n_s_emerge_clusters) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[35], &__pyx_kp_u_enable) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[36], &__pyx_n_s_enumerate) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[37], &__pyx_n_s_exclude) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[38], &__pyx_n_s_fix_outliers) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[39], &__pyx_kp_u_gc) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[40], &__pyx_n_s_get) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[41], &__pyx_n_s_getstate) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[42], &__pyx_n_s_i) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[43], &__pyx_n_s_import) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[44], &__pyx_n_s_initializing) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[45], &__pyx_n_s_intp) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[46], &__pyx_n_s_is_coroutine) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[47], &__pyx_n_s_is_reciprocal) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[48], &__pyx_kp_u_isenabled) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[49], &__pyx_n_s_jump1) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[50], &__pyx_n_s_jump2) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[51], &__pyx_n_s_kwargs) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[52], &__pyx_n_s_label) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[53], &__pyx_kp_u_label_default_value_for_limit1_i) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[54], &__pyx_kp_u_label_default_value_for_limit2_i) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[55], &__pyx_n_s_limit1) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[56], &__pyx_n_s_limit2) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[57], &__pyx_n_s_main) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[58], &__pyx_n_s_name) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[59], &__pyx_n_s_np) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[60], &__pyx_n_s_numpy) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[61], &__pyx_kp_u_numpy_core_multiarray_failed_to) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[62], &__pyx_kp_u_numpy_core_umath_failed_to_impor) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[63], &__pyx_n_s_ones) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[64], &__pyx_n_s_p1) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[65], &__pyx_n_s_p2) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[66], &__pyx_n_s_pop) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[67], &__pyx_n_s_print) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[68], &__pyx_n_s_pyx_state) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[69], &__pyx_n_s_pyx_vtable) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[70], &__pyx_n_s_range) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[71], &__pyx_n_s_reduce) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[72], &__pyx_n_s_reduce_cython) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[73], &__pyx_n_s_reduce_ex) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[74], &__pyx_n_s_remove) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[75], &__pyx_n_s_self) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[76], &__pyx_kp_s_self_parent_cannot_be_converted) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[77], &__pyx_n_s_setstate) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[78], &__pyx_n_s_setstate_cython) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[79], &__pyx_n_s_size) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[80], &__pyx_n_s_spec) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[81], &__pyx_n_s_sqrt) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[82], &__pyx_kp_s_stringsource) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[83], &__pyx_n_s_test) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[84], &__pyx_n_s_unique) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[85], &__pyx_n_s_update) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[86], &__pyx_n_s_v) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[87], &__pyx_n_s_values_arr) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[88], &__pyx_kp_u_will_not_be_formed) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[89], &__pyx_n_s_zeros) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[0], &__pyx_n_s_AssertionError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[1], &__pyx_kp_u_ERROR_labels_buffer_is_too_small) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[2], &__pyx_n_s_Group) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[3], &__pyx_n_s_ImportError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[4], &__pyx_n_s_UnionFind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[5], &__pyx_n_s__3) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[6], &__pyx_n_s__9) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[7], &__pyx_n_s_allocate_buffer_labels) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[8], &__pyx_kp_u_are_considered_as_noise) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[9], &__pyx_n_s_asyncio_coroutines) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[10], &__pyx_n_s_ceil) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[11], &__pyx_n_s_cline_in_traceback) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[12], &__pyx_n_s_druhg__druhg_label) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[13], &__pyx_kp_s_druhg__druhg_label_pyx) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[14], &__pyx_n_s_druhg_group) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[15], &__pyx_n_s_druhg_unionfind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[16], &__pyx_n_s_dtype) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[17], &__pyx_n_s_edgepairs_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[18], &__pyx_n_s_empty) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[19], &__pyx_n_s_exclude) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[20], &__pyx_n_s_fill) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[21], &__pyx_n_s_fix_outliers) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[22], &__pyx_n_s_group_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[23], &__pyx_n_s_import) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[24], &__pyx_n_s_initializing) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[25], &__pyx_n_s_intp) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[26], &__pyx_n_s_is_coroutine) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[27], &__pyx_n_s_label) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[28], &__pyx_kp_u_label_default_value_for_limit1_i) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[29], &__pyx_kp_u_label_default_value_for_limit2_i) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[30], &__pyx_n_s_limit1) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[31], &__pyx_n_s_limit2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[32], &__pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[33], &__pyx_n_s_name) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[34], &__pyx_n_s_np) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[35], &__pyx_n_s_numpy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[36], &__pyx_kp_u_numpy_core_multiarray_failed_to) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[37], &__pyx_kp_u_numpy_core_umath_failed_to_impor) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[38], &__pyx_n_s_ones) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[39], &__pyx_n_s_precision) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[40], &__pyx_n_s_print) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[41], &__pyx_n_s_pyx_vtable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[42], &__pyx_n_s_range) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[43], &__pyx_n_s_ranks_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[44], &__pyx_n_s_remove) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[45], &__pyx_n_s_ret_labels) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[46], &__pyx_n_s_size) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[47], &__pyx_n_s_spec) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[48], &__pyx_n_s_sqrt) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[49], &__pyx_n_s_test) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[50], &__pyx_n_s_uf_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[51], &__pyx_n_s_unique) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[52], &__pyx_n_s_update) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[53], &__pyx_n_s_values_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[54], &__pyx_kp_u_will_not_be_formed) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[55], &__pyx_n_s_zeros) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #endif
   #if !CYTHON_USE_MODULE_STATE
-  if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
+  if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #endif
-  __pyx_float_0_0000001 = PyFloat_FromDouble(0.0000001); if (unlikely(!__pyx_float_0_0000001)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_int_0 = PyInt_FromLong(0); if (unlikely(!__pyx_int_0)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_int_1 = PyInt_FromLong(1); if (unlikely(!__pyx_int_1)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_int_2 = PyInt_FromLong(2); if (unlikely(!__pyx_int_2)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_int_neg_1 = PyInt_FromLong(-1); if (unlikely(!__pyx_int_neg_1)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_float_0_0000001 = PyFloat_FromDouble(0.0000001); if (unlikely(!__pyx_float_0_0000001)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_0 = PyInt_FromLong(0); if (unlikely(!__pyx_int_0)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_1 = PyInt_FromLong(1); if (unlikely(!__pyx_int_1)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_neg_1 = PyInt_FromLong(-1); if (unlikely(!__pyx_int_neg_1)) __PYX_ERR(0, 1, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: init_globals ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitGlobals(void) {
@@ -9006,20 +7544,20 @@
  */
 #ifdef NPY_FEATURE_VERSION
 #if !NO_IMPORT_ARRAY
 if (unlikely(_import_array() == -1)) {
     PyErr_SetString(PyExc_ImportError, "numpy.core.multiarray failed to import "
     "(auto-generated because you didn't call 'numpy.import_array()' after cimporting numpy; "
     "use '<void>numpy._import_array' to disable if you are certain you don't need it).");
-    __PYX_ERR(1, 18, __pyx_L1_error);
+    __PYX_ERR(0, 18, __pyx_L1_error);
 }
 #endif
 #endif
 
-if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L1_error)
+if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 1, __pyx_L1_error)
 
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: init_module ### */
 
@@ -9053,119 +7591,85 @@
   /*--- Function export code ---*/
   __Pyx_RefNannyFinishContext();
   return 0;
 }
 
 static int __Pyx_modinit_type_init_code(void) {
   __Pyx_RefNannyDeclarations
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_init_code", 0);
   /*--- Type init code ---*/
-  __pyx_vtabptr_5druhg_12_druhg_label_UnionFind = &__pyx_vtable_5druhg_12_druhg_label_UnionFind;
-  __pyx_vtable_5druhg_12_druhg_label_UnionFind.has_parent = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_12_druhg_label_9UnionFind_has_parent;
-  __pyx_vtable_5druhg_12_druhg_label_UnionFind.fast_find = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_12_druhg_label_9UnionFind_fast_find;
-  __pyx_vtable_5druhg_12_druhg_label_UnionFind.passive_find = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_12_druhg_label_9UnionFind_passive_find;
-  __pyx_vtable_5druhg_12_druhg_label_UnionFind.passive_union = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_12_druhg_label_9UnionFind_passive_union;
-  __pyx_vtable_5druhg_12_druhg_label_UnionFind.discard_clusters = (PyObject *(*)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t, PyObject *))__pyx_f_5druhg_12_druhg_label_9UnionFind_discard_clusters;
-  __pyx_vtable_5druhg_12_druhg_label_UnionFind.label_find = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_12_druhg_label_UnionFind *, __pyx_t_5numpy_intp_t, PyObject *))__pyx_f_5druhg_12_druhg_label_9UnionFind_label_find;
-  #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_12_druhg_label_UnionFind = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_12_druhg_label_UnionFind_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_12_druhg_label_UnionFind)) __PYX_ERR(1, 23, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_12_druhg_label_UnionFind_spec, __pyx_ptype_5druhg_12_druhg_label_UnionFind) < 0) __PYX_ERR(1, 23, __pyx_L1_error)
-  #else
-  __pyx_ptype_5druhg_12_druhg_label_UnionFind = &__pyx_type_5druhg_12_druhg_label_UnionFind;
-  #endif
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  #endif
-  #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_12_druhg_label_UnionFind) < 0) __PYX_ERR(1, 23, __pyx_L1_error)
-  #endif
-  #if PY_MAJOR_VERSION < 3
-  __pyx_ptype_5druhg_12_druhg_label_UnionFind->tp_print = 0;
-  #endif
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_12_druhg_label_UnionFind->tp_dictoffset && __pyx_ptype_5druhg_12_druhg_label_UnionFind->tp_getattro == PyObject_GenericGetAttr)) {
-    __pyx_ptype_5druhg_12_druhg_label_UnionFind->tp_getattro = __Pyx_PyObject_GenericGetAttr;
-  }
-  #endif
-  if (__Pyx_SetVtable(__pyx_ptype_5druhg_12_druhg_label_UnionFind, __pyx_vtabptr_5druhg_12_druhg_label_UnionFind) < 0) __PYX_ERR(1, 23, __pyx_L1_error)
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_12_druhg_label_UnionFind) < 0) __PYX_ERR(1, 23, __pyx_L1_error)
-  #endif
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_UnionFind, (PyObject *) __pyx_ptype_5druhg_12_druhg_label_UnionFind) < 0) __PYX_ERR(1, 23, __pyx_L1_error)
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_12_druhg_label_UnionFind) < 0) __PYX_ERR(1, 23, __pyx_L1_error)
-  #endif
   __Pyx_RefNannyFinishContext();
   return 0;
-  __pyx_L1_error:;
-  __Pyx_RefNannyFinishContext();
-  return -1;
 }
 
 static int __Pyx_modinit_type_import_code(void) {
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
-  __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(3, 9, __pyx_L1_error)
+  __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
   #if defined(PYPY_VERSION_NUM) && PYPY_VERSION_NUM < 0x050B0000
   sizeof(PyTypeObject),
   #elif CYTHON_COMPILING_IN_LIMITED_API
   sizeof(PyTypeObject),
   #else
   sizeof(PyHeapTypeObject),
   #endif
   __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(3, 9, __pyx_L1_error)
+   if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = PyImport_ImportModule("numpy"); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 203, __pyx_L1_error)
+  __pyx_t_1 = PyImport_ImportModule("numpy"); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 203, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(2, 203, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 203, __pyx_L1_error)
   __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(2, 226, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 226, __pyx_L1_error)
   __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(2, 230, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 230, __pyx_L1_error)
   __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(2, 239, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
   __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_generic) __PYX_ERR(2, 813, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 813, __pyx_L1_error)
   __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_number) __PYX_ERR(2, 815, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 815, __pyx_L1_error)
   __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_integer) __PYX_ERR(2, 817, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 817, __pyx_L1_error)
   __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(2, 819, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 819, __pyx_L1_error)
   __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(2, 821, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 821, __pyx_L1_error)
   __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(2, 823, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 823, __pyx_L1_error)
   __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_floating) __PYX_ERR(2, 825, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 825, __pyx_L1_error)
   __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(2, 827, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 827, __pyx_L1_error)
   __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(2, 829, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 829, __pyx_L1_error)
   __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_character) __PYX_ERR(2, 831, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 831, __pyx_L1_error)
   __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(2, 869, __pyx_L1_error)
+   if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 869, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = PyImport_ImportModule("druhg._druhg_amalgamation"); if (unlikely(!__pyx_t_1)) __PYX_ERR(4, 11, __pyx_L1_error)
+  __pyx_t_1 = PyImport_ImportModule("druhg._druhg_unionfind"); if (unlikely(!__pyx_t_1)) __PYX_ERR(3, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation = __Pyx_ImportType(__pyx_t_1, "druhg._druhg_amalgamation", "Amalgamation", sizeof(struct __pyx_obj_5druhg_19_druhg_amalgamation_Amalgamation), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation) __PYX_ERR(4, 11, __pyx_L1_error)
-  __pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation = (struct __pyx_vtabstruct_5druhg_19_druhg_amalgamation_Amalgamation*)__Pyx_GetVtable(__pyx_ptype_5druhg_19_druhg_amalgamation_Amalgamation); if (unlikely(!__pyx_vtabptr_5druhg_19_druhg_amalgamation_Amalgamation)) __PYX_ERR(4, 11, __pyx_L1_error)
+  __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = __Pyx_ImportType(__pyx_t_1, "druhg._druhg_unionfind", "UnionFind", sizeof(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind), __Pyx_ImportType_CheckSize_Warn);
+   if (!__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) __PYX_ERR(3, 16, __pyx_L1_error)
+  __pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind = (struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind*)__Pyx_GetVtable(__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind); if (unlikely(!__pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind)) __PYX_ERR(3, 16, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyImport_ImportModule("druhg._druhg_group"); if (unlikely(!__pyx_t_1)) __PYX_ERR(4, 22, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_ptype_5druhg_12_druhg_group_Group = __Pyx_ImportType(__pyx_t_1, "druhg._druhg_group", "Group", sizeof(struct __pyx_obj_5druhg_12_druhg_group_Group), __Pyx_ImportType_CheckSize_Warn);
+   if (!__pyx_ptype_5druhg_12_druhg_group_Group) __PYX_ERR(4, 22, __pyx_L1_error)
+  __pyx_vtabptr_5druhg_12_druhg_group_Group = (struct __pyx_vtabstruct_5druhg_12_druhg_group_Group*)__Pyx_GetVtable(__pyx_ptype_5druhg_12_druhg_group_Group); if (unlikely(!__pyx_vtabptr_5druhg_12_druhg_group_Group)) __PYX_ERR(4, 22, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_RefNannyFinishContext();
   return -1;
@@ -9177,18 +7681,31 @@
   /*--- Variable import code ---*/
   __Pyx_RefNannyFinishContext();
   return 0;
 }
 
 static int __Pyx_modinit_function_import_code(void) {
   __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_function_import_code", 0);
   /*--- Function import code ---*/
+  __pyx_t_1 = PyImport_ImportModule("druhg._druhg_group"); if (!__pyx_t_1) __PYX_ERR(0, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  if (__Pyx_ImportFunction(__pyx_t_1, "set_precision", (void (**)(void))&__pyx_f_5druhg_12_druhg_group_set_precision, "PyObject *(__pyx_t_5numpy_double_t)") < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  if (__Pyx_ImportFunction(__pyx_t_1, "group_is_cluster", (void (**)(void))&__pyx_f_5druhg_12_druhg_group_group_is_cluster, "int (PyObject *, __pyx_t_5numpy_double_t *, __pyx_t_5numpy_double_t)") < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_RefNannyFinishContext();
+  return -1;
 }
 
 
 #if PY_MAJOR_VERSION >= 3
 #if CYTHON_PEP489_MULTI_PHASE_INIT
 static PyObject* __pyx_pymod_create(PyObject *spec, PyModuleDef *def); /*proto*/
 static int __pyx_pymod_exec__druhg_label(PyObject* module); /*proto*/
@@ -9364,202 +7881,195 @@
   /*--- Module creation code ---*/
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   __pyx_m = __pyx_pyinit_module;
   Py_INCREF(__pyx_m);
   #else
   #if PY_MAJOR_VERSION < 3
   __pyx_m = Py_InitModule4("_druhg_label", __pyx_methods, 0, 0, PYTHON_API_VERSION); Py_XINCREF(__pyx_m);
-  if (unlikely(!__pyx_m)) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (unlikely(!__pyx_m)) __PYX_ERR(0, 1, __pyx_L1_error)
   #elif CYTHON_COMPILING_IN_LIMITED_API
-  __pyx_t_1 = PyModule_Create(&__pyx_moduledef); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_1 = PyModule_Create(&__pyx_moduledef); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1, __pyx_L1_error)
   {
     int add_module_result = PyState_AddModule(__pyx_t_1, &__pyx_moduledef);
     Py_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    if (unlikely((add_module_result < 0))) __PYX_ERR(1, 1, __pyx_L1_error)
+    if (unlikely((add_module_result < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
   }
   #else
   __pyx_m = PyModule_Create(&__pyx_moduledef);
-  if (unlikely(!__pyx_m)) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (unlikely(!__pyx_m)) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #endif
   CYTHON_UNUSED_VAR(__pyx_t_1);
-  __pyx_d = PyModule_GetDict(__pyx_m); if (unlikely(!__pyx_d)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_d = PyModule_GetDict(__pyx_m); if (unlikely(!__pyx_d)) __PYX_ERR(0, 1, __pyx_L1_error)
   Py_INCREF(__pyx_d);
-  __pyx_b = PyImport_AddModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_b)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_b = PyImport_AddModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_b)) __PYX_ERR(0, 1, __pyx_L1_error)
   Py_INCREF(__pyx_b);
-  __pyx_cython_runtime = PyImport_AddModule((char *) "cython_runtime"); if (unlikely(!__pyx_cython_runtime)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_cython_runtime = PyImport_AddModule((char *) "cython_runtime"); if (unlikely(!__pyx_cython_runtime)) __PYX_ERR(0, 1, __pyx_L1_error)
   Py_INCREF(__pyx_cython_runtime);
-  if (PyObject_SetAttrString(__pyx_m, "__builtins__", __pyx_b) < 0) __PYX_ERR(1, 1, __pyx_L1_error);
+  if (PyObject_SetAttrString(__pyx_m, "__builtins__", __pyx_b) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #if CYTHON_REFNANNY
 __Pyx_RefNanny = __Pyx_RefNannyImportAPI("refnanny");
 if (!__Pyx_RefNanny) {
   PyErr_Clear();
   __Pyx_RefNanny = __Pyx_RefNannyImportAPI("Cython.Runtime.refnanny");
   if (!__Pyx_RefNanny)
       Py_FatalError("failed to import 'refnanny' module");
 }
 #endif
   __Pyx_RefNannySetupContext("__Pyx_PyMODINIT_FUNC PyInit__druhg_label(void)", 0);
-  if (__Pyx_check_binary_version() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_check_binary_version() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #ifdef __Pxy_PyFrame_Initialize_Offsets
   __Pxy_PyFrame_Initialize_Offsets();
   #endif
-  __pyx_empty_tuple = PyTuple_New(0); if (unlikely(!__pyx_empty_tuple)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_empty_bytes = PyBytes_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_bytes)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_empty_unicode = PyUnicode_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_unicode)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_empty_tuple = PyTuple_New(0); if (unlikely(!__pyx_empty_tuple)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_empty_bytes = PyBytes_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_bytes)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_empty_unicode = PyUnicode_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_unicode)) __PYX_ERR(0, 1, __pyx_L1_error)
   #ifdef __Pyx_CyFunction_USED
-  if (__pyx_CyFunction_init(__pyx_m) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__pyx_CyFunction_init(__pyx_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #ifdef __Pyx_FusedFunction_USED
-  if (__pyx_FusedFunction_init(__pyx_m) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__pyx_FusedFunction_init(__pyx_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #ifdef __Pyx_Coroutine_USED
-  if (__pyx_Coroutine_init(__pyx_m) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__pyx_Coroutine_init(__pyx_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #ifdef __Pyx_Generator_USED
-  if (__pyx_Generator_init(__pyx_m) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__pyx_Generator_init(__pyx_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #ifdef __Pyx_AsyncGen_USED
-  if (__pyx_AsyncGen_init(__pyx_m) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__pyx_AsyncGen_init(__pyx_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #ifdef __Pyx_StopAsyncIteration_USED
-  if (__pyx_StopAsyncIteration_init(__pyx_m) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__pyx_StopAsyncIteration_init(__pyx_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   /*--- Library function declarations ---*/
   /*--- Threads initialization code ---*/
   #if defined(WITH_THREAD) && PY_VERSION_HEX < 0x030700F0 && defined(__PYX_FORCE_INIT_THREADS) && __PYX_FORCE_INIT_THREADS
   PyEval_InitThreads();
   #endif
   /*--- Initialize various global constants etc. ---*/
-  if (__Pyx_InitConstants() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_InitConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   stringtab_initialized = 1;
-  if (__Pyx_InitGlobals() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_InitGlobals() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #if PY_MAJOR_VERSION < 3 && (__PYX_DEFAULT_STRING_ENCODING_IS_ASCII || __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT)
-  if (__Pyx_init_sys_getdefaultencoding_params() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_init_sys_getdefaultencoding_params() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   if (__pyx_module_is_main_druhg___druhg_label) {
-    if (PyObject_SetAttr(__pyx_m, __pyx_n_s_name, __pyx_n_s_main) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+    if (PyObject_SetAttr(__pyx_m, __pyx_n_s_name, __pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   }
   #if PY_MAJOR_VERSION >= 3
   {
-    PyObject *modules = PyImport_GetModuleDict(); if (unlikely(!modules)) __PYX_ERR(1, 1, __pyx_L1_error)
+    PyObject *modules = PyImport_GetModuleDict(); if (unlikely(!modules)) __PYX_ERR(0, 1, __pyx_L1_error)
     if (!PyDict_GetItemString(modules, "druhg._druhg_label")) {
-      if (unlikely((PyDict_SetItemString(modules, "druhg._druhg_label", __pyx_m) < 0))) __PYX_ERR(1, 1, __pyx_L1_error)
+      if (unlikely((PyDict_SetItemString(modules, "druhg._druhg_label", __pyx_m) < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
     }
   }
   #endif
   /*--- Builtin init code ---*/
-  if (__Pyx_InitCachedBuiltins() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_InitCachedBuiltins() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Constants init code ---*/
-  if (__Pyx_InitCachedConstants() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_InitCachedConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Global type/function init code ---*/
   (void)__Pyx_modinit_global_init_code();
   (void)__Pyx_modinit_variable_export_code();
   (void)__Pyx_modinit_function_export_code();
-  if (unlikely((__Pyx_modinit_type_init_code() < 0))) __PYX_ERR(1, 1, __pyx_L1_error)
-  if (unlikely((__Pyx_modinit_type_import_code() < 0))) __PYX_ERR(1, 1, __pyx_L1_error)
+  (void)__Pyx_modinit_type_init_code();
+  if (unlikely((__Pyx_modinit_type_import_code() < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
   (void)__Pyx_modinit_variable_import_code();
-  (void)__Pyx_modinit_function_import_code();
+  if (unlikely((__Pyx_modinit_function_import_code() < 0))) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Execution code ---*/
   #if defined(__Pyx_Generator_USED) || defined(__Pyx_Coroutine_USED)
-  if (__Pyx_patch_abc() < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  if (__Pyx_patch_abc() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
 
   /* "druhg/_druhg_label.pyx":17
  * # License: 3-clause BSD
  * 
  * import numpy as np             # <<<<<<<<<<<<<<
  * cimport numpy as np
  * 
  */
-  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_numpy, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 17, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_numpy, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 17, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_2) < 0) __PYX_ERR(1, 17, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_2) < 0) __PYX_ERR(0, 17, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "druhg/_druhg_label.pyx":20
  * cimport numpy as np
  * 
- * from ._druhg_amalgamation import Amalgamation             # <<<<<<<<<<<<<<
- * from ._druhg_amalgamation cimport Amalgamation
+ * from ._druhg_unionfind import UnionFind             # <<<<<<<<<<<<<<
+ * from ._druhg_unionfind cimport UnionFind
  * 
  */
-  __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 20, __pyx_L1_error)
+  __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 20, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_INCREF(__pyx_n_s_Amalgamation);
-  __Pyx_GIVEREF(__pyx_n_s_Amalgamation);
-  PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_Amalgamation);
-  __pyx_t_3 = __Pyx_Import(__pyx_n_s_druhg_amalgamation, __pyx_t_2, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 20, __pyx_L1_error)
+  __Pyx_INCREF(__pyx_n_s_UnionFind);
+  __Pyx_GIVEREF(__pyx_n_s_UnionFind);
+  PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_UnionFind);
+  __pyx_t_3 = __Pyx_Import(__pyx_n_s_druhg_unionfind, __pyx_t_2, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 20, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-  __pyx_t_3 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_12_druhg_label_9UnionFind_3__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UnionFind___reduce_cython, NULL, __pyx_n_s_druhg__druhg_label, __pyx_d, ((PyObject *)__pyx_codeobj__5)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_reduce_cython, __pyx_t_3) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
+  /* "druhg/_druhg_label.pyx":24
+ * 
+ * from ._druhg_group cimport group_is_cluster, set_precision
+ * from ._druhg_group import Group             # <<<<<<<<<<<<<<
+ * from ._druhg_group cimport Group
+ * 
  */
-  __pyx_t_3 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_12_druhg_label_9UnionFind_5__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UnionFind___setstate_cython, NULL, __pyx_n_s_druhg__druhg_label, __pyx_d, ((PyObject *)__pyx_codeobj__7)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 3, __pyx_L1_error)
+  __pyx_t_3 = PyList_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 24, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_setstate_cython, __pyx_t_3) < 0) __PYX_ERR(0, 3, __pyx_L1_error)
+  __Pyx_INCREF(__pyx_n_s_Group);
+  __Pyx_GIVEREF(__pyx_n_s_Group);
+  PyList_SET_ITEM(__pyx_t_3, 0, __pyx_n_s_Group);
+  __pyx_t_2 = __Pyx_Import(__pyx_n_s_druhg_group, __pyx_t_3, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 24, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_label.pyx":157
- *     return
+  /* "druhg/_druhg_label.pyx":27
+ * from ._druhg_group cimport Group
  * 
- * def emerge_clusters(UnionFind U, np.ndarray edges_arr, np.ndarray values_arr, np.intp_t limit1, np.intp_t limit2, \             # <<<<<<<<<<<<<<
- *                     list exclude, is_reciprocal = 1, **kwargs):
+ * def allocate_buffer_labels(np.intp_t size):             # <<<<<<<<<<<<<<
+ *     return np.empty(size, dtype=np.intp)
  * 
  */
-  __pyx_t_3 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_12_druhg_label_1emerge_clusters, 0, __pyx_n_s_emerge_clusters, NULL, __pyx_n_s_druhg__druhg_label, __pyx_d, ((PyObject *)__pyx_codeobj__9)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 157, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_3, __pyx_tuple__10);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_emerge_clusters, __pyx_t_3) < 0) __PYX_ERR(1, 157, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_12_druhg_label_1allocate_buffer_labels, 0, __pyx_n_s_allocate_buffer_labels, NULL, __pyx_n_s_druhg__druhg_label, __pyx_d, ((PyObject *)__pyx_codeobj__5)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 27, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_allocate_buffer_labels, __pyx_t_2) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_label.pyx":234
- * 
+  /* "druhg/_druhg_label.pyx":137
+ *     return ret_clusters
  * 
- * cpdef np.ndarray label(np.ndarray edges_arr, np.ndarray values_arr, int size = 0, list exclude = None, \             # <<<<<<<<<<<<<<
- *                        np.intp_t limit1 = 0, np.intp_t limit2 = 0, np.intp_t fix_outliers = 1, is_reciprocal = 1):
- *     """Returns cluster labels.
+ * cpdef np.ndarray label(np.ndarray values_arr, np.ndarray uf_arr, int size,             # <<<<<<<<<<<<<<
+ *                        np.ndarray group_arr, np.ndarray ret_labels,
+ *                        np.ndarray ranks_arr=None,
  */
-  __pyx_t_3 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_12_druhg_label_3label, 0, __pyx_n_s_label, NULL, __pyx_n_s_druhg__druhg_label, __pyx_d, ((PyObject *)__pyx_codeobj__12)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 234, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_3, __pyx_tuple__13);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_label, __pyx_t_3) < 0) __PYX_ERR(1, 234, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_12_druhg_label_3label, 0, __pyx_n_s_label, NULL, __pyx_n_s_druhg__druhg_label, __pyx_d, ((PyObject *)__pyx_codeobj__7)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 137, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_2, __pyx_tuple__8);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_label, __pyx_t_2) < 0) __PYX_ERR(0, 137, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "druhg/_druhg_label.pyx":1
  * # cython: language_level=3             # <<<<<<<<<<<<<<
  * # cython: boundscheck=False
  * # cython: nonecheck=False
  */
-  __pyx_t_3 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_3) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_2 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":1049
- * 
- * 
- * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
- *     """
- *     returns the unit part of the dtype for a numpy datetime64 object.
+  /* "libc/math.pxd":1
+ * cdef extern from "<math.h>" nogil:             # <<<<<<<<<<<<<<
+ *     const double M_E
+ *     const double e "M_E"  # as in Python's math module
  */
 
   /*--- Wrapped vars code ---*/
 
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_2);
@@ -10077,148 +8587,14 @@
     }
     PyErr_Format(PyExc_TypeError,
                  "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
                  func_name, more_or_less, num_expected,
                  (num_expected == 1) ? "" : "s", num_found);
 }
 
-/* PyIntBinop */
-#if !CYTHON_COMPILING_IN_PYPY
-static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check) {
-    CYTHON_MAYBE_UNUSED_VAR(intval);
-    CYTHON_MAYBE_UNUSED_VAR(inplace);
-    CYTHON_UNUSED_VAR(zerodivision_check);
-    #if PY_MAJOR_VERSION < 3
-    if (likely(PyInt_CheckExact(op1))) {
-        const long b = intval;
-        long x;
-        long a = PyInt_AS_LONG(op1);
-        
-            x = (long)((unsigned long)a + b);
-            if (likely((x^a) >= 0 || (x^b) >= 0))
-                return PyInt_FromLong(x);
-            return PyLong_Type.tp_as_number->nb_add(op1, op2);
-    }
-    #endif
-    #if CYTHON_USE_PYLONG_INTERNALS
-    if (likely(PyLong_CheckExact(op1))) {
-        const long b = intval;
-        long a, x;
-#ifdef HAVE_LONG_LONG
-        const PY_LONG_LONG llb = intval;
-        PY_LONG_LONG lla, llx;
-#endif
-        const digit* digits = ((PyLongObject*)op1)->ob_digit;
-        const Py_ssize_t size = Py_SIZE(op1);
-        if (unlikely(size == 0)) {
-            return __Pyx_NewRef(op2);
-        }
-        if (likely(__Pyx_sst_abs(size) <= 1)) {
-            a = likely(size) ? digits[0] : 0;
-            if (size == -1) a = -a;
-        } else {
-            switch (size) {
-                case -2:
-                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
-                        a = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
-                        lla = -(PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case 2:
-                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
-                        a = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
-                        lla = (PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case -3:
-                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
-                        a = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
-                        lla = -(PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case 3:
-                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
-                        a = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
-                        lla = (PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case -4:
-                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
-                        a = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
-                        lla = -(PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case 4:
-                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
-                        a = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
-                        lla = (PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                default: return PyLong_Type.tp_as_number->nb_add(op1, op2);
-            }
-        }
-                x = a + b;
-            return PyLong_FromLong(x);
-#ifdef HAVE_LONG_LONG
-        long_long:
-                llx = lla + llb;
-            return PyLong_FromLongLong(llx);
-#endif
-        
-        
-    }
-    #endif
-    if (PyFloat_CheckExact(op1)) {
-        const long b = intval;
-#if CYTHON_COMPILING_IN_LIMITED_API
-        double a = __pyx_PyFloat_AsDouble(op1);
-#else
-        double a = PyFloat_AS_DOUBLE(op1);
-#endif
-            double result;
-            
-            PyFPE_START_PROTECT("add", return NULL)
-            result = ((double)a) + (double)b;
-            PyFPE_END_PROTECT(result)
-            return PyFloat_FromDouble(result);
-    }
-    return (inplace ? PyNumber_InPlaceAdd : PyNumber_Add)(op1, op2);
-}
-#endif
-
 /* PyDictVersioning */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
 static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj) {
     PyObject *dict = Py_TYPE(obj)->tp_dict;
     return likely(dict) ? __PYX_GET_DICT_VERSION(dict) : 0;
 }
 static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj) {
@@ -10280,161 +8656,14 @@
         return __Pyx_NewRef(result);
     }
     PyErr_Clear();
 #endif
     return __Pyx_GetBuiltinName(name);
 }
 
-/* PyIntBinop */
-#if !CYTHON_COMPILING_IN_PYPY
-static PyObject* __Pyx_PyInt_MultiplyCObj(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check) {
-    CYTHON_MAYBE_UNUSED_VAR(intval);
-    CYTHON_MAYBE_UNUSED_VAR(inplace);
-    CYTHON_UNUSED_VAR(zerodivision_check);
-    #if PY_MAJOR_VERSION < 3
-    if (likely(PyInt_CheckExact(op2))) {
-        const long a = intval;
-        long b = PyInt_AS_LONG(op2);
-        
-#ifdef HAVE_LONG_LONG
-            if (sizeof(PY_LONG_LONG) > sizeof(long)) {
-                PY_LONG_LONG result = (PY_LONG_LONG)a * (PY_LONG_LONG)b;
-                return (result >= LONG_MIN && result <= LONG_MAX) ?
-                    PyInt_FromLong((long)result) : PyLong_FromLongLong(result);
-            }
-#endif
-#if CYTHON_USE_TYPE_SLOTS
-            return PyInt_Type.tp_as_number->nb_multiply(op1, op2);
-#else
-            return PyNumber_Multiply(op1, op2);
-#endif
-    }
-    #endif
-    #if CYTHON_USE_PYLONG_INTERNALS
-    if (likely(PyLong_CheckExact(op2))) {
-        const long a = intval;
-        long b, x;
-#ifdef HAVE_LONG_LONG
-        const PY_LONG_LONG lla = intval;
-        PY_LONG_LONG llb, llx;
-#endif
-        const digit* digits = ((PyLongObject*)op2)->ob_digit;
-        const Py_ssize_t size = Py_SIZE(op2);
-        if (unlikely(size == 0)) {
-            return __Pyx_NewRef(op2);
-        }
-        if (likely(__Pyx_sst_abs(size) <= 1)) {
-            b = likely(size) ? digits[0] : 0;
-            if (size == -1) b = -b;
-        } else {
-            switch (size) {
-                case -2:
-                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT+30) {
-                        b = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT+30) {
-                        llb = -(PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case 2:
-                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT+30) {
-                        b = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT+30) {
-                        llb = (PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case -3:
-                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT+30) {
-                        b = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT+30) {
-                        llb = -(PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case 3:
-                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT+30) {
-                        b = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT+30) {
-                        llb = (PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case -4:
-                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT+30) {
-                        b = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT+30) {
-                        llb = -(PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                case 4:
-                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT+30) {
-                        b = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
-                        break;
-                    #ifdef HAVE_LONG_LONG
-                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT+30) {
-                        llb = (PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
-                        goto long_long;
-                    #endif
-                    }
-                    CYTHON_FALLTHROUGH;
-                default: return PyLong_Type.tp_as_number->nb_multiply(op1, op2);
-            }
-        }
-                (void)a; (void)b;
-                #ifdef HAVE_LONG_LONG
-                llb = b;
-                goto long_long;
-                #else
-                return PyLong_Type.tp_as_number->nb_multiply(op1, op2);
-                #endif
-            return PyLong_FromLong(x);
-#ifdef HAVE_LONG_LONG
-        long_long:
-                llx = lla * llb;
-            return PyLong_FromLongLong(llx);
-#endif
-        
-        
-    }
-    #endif
-    if (PyFloat_CheckExact(op2)) {
-        const long a = intval;
-#if CYTHON_COMPILING_IN_LIMITED_API
-        double b = __pyx_PyFloat_AsDouble(op2);
-#else
-        double b = PyFloat_AS_DOUBLE(op2);
-#endif
-            double result;
-            
-            PyFPE_START_PROTECT("multiply", return NULL)
-            result = ((double)a) * (double)b;
-            PyFPE_END_PROTECT(result)
-            return PyFloat_FromDouble(result);
-    }
-    return (inplace ? PyNumber_InPlaceMultiply : PyNumber_Multiply)(op1, op2);
-}
-#endif
-
 /* PyObjectCall */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw) {
     PyObject *result;
     ternaryfunc call = Py_TYPE(func)->tp_call;
     if (unlikely(!call))
         return PyObject_Call(func, arg, kw);
@@ -10447,34 +8676,239 @@
             PyExc_SystemError,
             "NULL result without error in PyObject_Call");
     }
     return result;
 }
 #endif
 
-/* ExtTypeTest */
-static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type) {
-    __Pyx_TypeName obj_type_name;
-    __Pyx_TypeName type_name;
-    if (unlikely(!type)) {
-        PyErr_SetString(PyExc_SystemError, "Missing type object");
-        return 0;
+/* GetItemInt */
+static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j) {
+    PyObject *r;
+    if (unlikely(!j)) return NULL;
+    r = PyObject_GetItem(o, j);
+    Py_DECREF(j);
+    return r;
+}
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
+                                                              CYTHON_NCP_UNUSED int wraparound,
+                                                              CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
+    Py_ssize_t wrapped_i = i;
+    if (wraparound & unlikely(i < 0)) {
+        wrapped_i += PyList_GET_SIZE(o);
     }
-    if (likely(__Pyx_TypeCheck(obj, type)))
-        return 1;
-    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
-    type_name = __Pyx_PyType_GetName(type);
-    PyErr_Format(PyExc_TypeError,
-                 "Cannot convert " __Pyx_FMT_TYPENAME " to " __Pyx_FMT_TYPENAME,
-                 obj_type_name, type_name);
-    __Pyx_DECREF_TypeName(obj_type_name);
-    __Pyx_DECREF_TypeName(type_name);
+    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyList_GET_SIZE(o)))) {
+        PyObject *r = PyList_GET_ITEM(o, wrapped_i);
+        Py_INCREF(r);
+        return r;
+    }
+    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
+#else
+    return PySequence_GetItem(o, i);
+#endif
+}
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
+                                                              CYTHON_NCP_UNUSED int wraparound,
+                                                              CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
+    Py_ssize_t wrapped_i = i;
+    if (wraparound & unlikely(i < 0)) {
+        wrapped_i += PyTuple_GET_SIZE(o);
+    }
+    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyTuple_GET_SIZE(o)))) {
+        PyObject *r = PyTuple_GET_ITEM(o, wrapped_i);
+        Py_INCREF(r);
+        return r;
+    }
+    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
+#else
+    return PySequence_GetItem(o, i);
+#endif
+}
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i, int is_list,
+                                                     CYTHON_NCP_UNUSED int wraparound,
+                                                     CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
+    if (is_list || PyList_CheckExact(o)) {
+        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyList_GET_SIZE(o);
+        if ((!boundscheck) || (likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o))))) {
+            PyObject *r = PyList_GET_ITEM(o, n);
+            Py_INCREF(r);
+            return r;
+        }
+    }
+    else if (PyTuple_CheckExact(o)) {
+        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyTuple_GET_SIZE(o);
+        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyTuple_GET_SIZE(o)))) {
+            PyObject *r = PyTuple_GET_ITEM(o, n);
+            Py_INCREF(r);
+            return r;
+        }
+    } else {
+        PyMappingMethods *mm = Py_TYPE(o)->tp_as_mapping;
+        PySequenceMethods *sm = Py_TYPE(o)->tp_as_sequence;
+        if (mm && mm->mp_subscript) {
+            PyObject *r, *key = PyInt_FromSsize_t(i);
+            if (unlikely(!key)) return NULL;
+            r = mm->mp_subscript(o, key);
+            Py_DECREF(key);
+            return r;
+        }
+        if (likely(sm && sm->sq_item)) {
+            if (wraparound && unlikely(i < 0) && likely(sm->sq_length)) {
+                Py_ssize_t l = sm->sq_length(o);
+                if (likely(l >= 0)) {
+                    i += l;
+                } else {
+                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
+                        return NULL;
+                    PyErr_Clear();
+                }
+            }
+            return sm->sq_item(o, i);
+        }
+    }
+#else
+    if (is_list || PySequence_Check(o)) {
+        return PySequence_GetItem(o, i);
+    }
+#endif
+    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
+}
+
+/* UnpackUnboundCMethod */
+static int __Pyx_TryUnpackUnboundCMethod(__Pyx_CachedCFunction* target) {
+    PyObject *method;
+    method = __Pyx_PyObject_GetAttrStr(target->type, *target->method_name);
+    if (unlikely(!method))
+        return -1;
+    target->method = method;
+#if CYTHON_COMPILING_IN_CPYTHON
+    #if PY_MAJOR_VERSION >= 3
+    if (likely(__Pyx_TypeCheck(method, &PyMethodDescr_Type)))
+    #endif
+    {
+        PyMethodDescrObject *descr = (PyMethodDescrObject*) method;
+        target->func = descr->d_method->ml_meth;
+        target->flag = descr->d_method->ml_flags & ~(METH_CLASS | METH_STATIC | METH_COEXIST | METH_STACKLESS);
+    }
+#endif
     return 0;
 }
 
+/* CallUnboundCMethod1 */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg) {
+    if (likely(cfunc->func)) {
+        int flag = cfunc->flag;
+        if (flag == METH_O) {
+            return (*(cfunc->func))(self, arg);
+        } else if ((PY_VERSION_HEX >= 0x030600B1) && flag == METH_FASTCALL) {
+            if ((PY_VERSION_HEX >= 0x030700A0)) {
+                return (*(__Pyx_PyCFunctionFast)(void*)(PyCFunction)cfunc->func)(self, &arg, 1);
+            } else {
+                return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, &arg, 1, NULL);
+            }
+        } else if ((PY_VERSION_HEX >= 0x030700A0) && flag == (METH_FASTCALL | METH_KEYWORDS)) {
+            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, &arg, 1, NULL);
+        }
+    }
+    return __Pyx__CallUnboundCMethod1(cfunc, self, arg);
+}
+#endif
+static PyObject* __Pyx__CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg){
+    PyObject *args, *result = NULL;
+    if (unlikely(!cfunc->func && !cfunc->method) && unlikely(__Pyx_TryUnpackUnboundCMethod(cfunc) < 0)) return NULL;
+#if CYTHON_COMPILING_IN_CPYTHON
+    if (cfunc->func && (cfunc->flag & METH_VARARGS)) {
+        args = PyTuple_New(1);
+        if (unlikely(!args)) goto bad;
+        Py_INCREF(arg);
+        PyTuple_SET_ITEM(args, 0, arg);
+        if (cfunc->flag & METH_KEYWORDS)
+            result = (*(PyCFunctionWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, NULL);
+        else
+            result = (*cfunc->func)(self, args);
+    } else {
+        args = PyTuple_New(2);
+        if (unlikely(!args)) goto bad;
+        Py_INCREF(self);
+        PyTuple_SET_ITEM(args, 0, self);
+        Py_INCREF(arg);
+        PyTuple_SET_ITEM(args, 1, arg);
+        result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
+    }
+#else
+    args = PyTuple_Pack(2, self, arg);
+    if (unlikely(!args)) goto bad;
+    result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
+#endif
+bad:
+    Py_XDECREF(args);
+    return result;
+}
+
+/* SetItemInt */
+static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v) {
+    int r;
+    if (unlikely(!j)) return -1;
+    r = PyObject_SetItem(o, j, v);
+    Py_DECREF(j);
+    return r;
+}
+static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v, int is_list,
+                                               CYTHON_NCP_UNUSED int wraparound, CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
+    if (is_list || PyList_CheckExact(o)) {
+        Py_ssize_t n = (!wraparound) ? i : ((likely(i >= 0)) ? i : i + PyList_GET_SIZE(o));
+        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o)))) {
+            PyObject* old = PyList_GET_ITEM(o, n);
+            Py_INCREF(v);
+            PyList_SET_ITEM(o, n, v);
+            Py_DECREF(old);
+            return 1;
+        }
+    } else {
+        PyMappingMethods *mm = Py_TYPE(o)->tp_as_mapping;
+        PySequenceMethods *sm = Py_TYPE(o)->tp_as_sequence;
+        if (mm && mm->mp_ass_subscript) {
+            int r;
+            PyObject *key = PyInt_FromSsize_t(i);
+            if (unlikely(!key)) return -1;
+            r = mm->mp_ass_subscript(o, key, v);
+            Py_DECREF(key);
+            return r;
+        }
+        if (likely(sm && sm->sq_ass_item)) {
+            if (wraparound && unlikely(i < 0) && likely(sm->sq_length)) {
+                Py_ssize_t l = sm->sq_length(o);
+                if (likely(l >= 0)) {
+                    i += l;
+                } else {
+                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
+                        return -1;
+                    PyErr_Clear();
+                }
+            }
+            return sm->sq_ass_item(o, i, v);
+        }
+    }
+#else
+#if CYTHON_COMPILING_IN_PYPY
+    if (is_list || (PySequence_Check(o) && !PyDict_Check(o)))
+#else
+    if (is_list || PySequence_Check(o))
+#endif
+    {
+        return PySequence_SetItem(o, i, v);
+    }
+#endif
+    return __Pyx_SetItemInt_Generic(o, PyInt_FromSsize_t(i), v);
+}
+
 /* pyfrozenset_new */
 static CYTHON_INLINE PyObject* __Pyx_PyFrozenSet_New(PyObject* it) {
     if (it) {
         PyObject* result;
 #if CYTHON_COMPILING_IN_PYPY
         PyObject* args;
         args = PyTuple_Pack(1, it);
@@ -10521,14 +8955,118 @@
     int result = PySet_Contains(set, key);
     if (unlikely(result < 0)) {
         result = __Pyx_PySet_ContainsUnhashable(set, key);
     }
     return unlikely(result < 0) ? result : (result == (eq == Py_EQ));
 }
 
+/* RaiseTooManyValuesToUnpack */
+static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected) {
+    PyErr_Format(PyExc_ValueError,
+                 "too many values to unpack (expected %" CYTHON_FORMAT_SSIZE_T "d)", expected);
+}
+
+/* RaiseNeedMoreValuesToUnpack */
+static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index) {
+    PyErr_Format(PyExc_ValueError,
+                 "need more than %" CYTHON_FORMAT_SSIZE_T "d value%.1s to unpack",
+                 index, (index == 1) ? "" : "s");
+}
+
+/* IterFinish */
+static CYTHON_INLINE int __Pyx_IterFinish(void) {
+#if CYTHON_FAST_THREAD_STATE
+    PyThreadState *tstate = __Pyx_PyThreadState_Current;
+    PyObject* exc_type = tstate->curexc_type;
+    if (unlikely(exc_type)) {
+        if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) {
+            PyObject *exc_value, *exc_tb;
+            exc_value = tstate->curexc_value;
+            exc_tb = tstate->curexc_traceback;
+            tstate->curexc_type = 0;
+            tstate->curexc_value = 0;
+            tstate->curexc_traceback = 0;
+            Py_DECREF(exc_type);
+            Py_XDECREF(exc_value);
+            Py_XDECREF(exc_tb);
+            return 0;
+        } else {
+            return -1;
+        }
+    }
+    return 0;
+#else
+    if (unlikely(PyErr_Occurred())) {
+        if (likely(PyErr_ExceptionMatches(PyExc_StopIteration))) {
+            PyErr_Clear();
+            return 0;
+        } else {
+            return -1;
+        }
+    }
+    return 0;
+#endif
+}
+
+/* UnpackItemEndCheck */
+static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected) {
+    if (unlikely(retval)) {
+        Py_DECREF(retval);
+        __Pyx_RaiseTooManyValuesError(expected);
+        return -1;
+    }
+    return __Pyx_IterFinish();
+}
+
+/* WriteUnraisableException */
+static void __Pyx_WriteUnraisable(const char *name, int clineno,
+                                  int lineno, const char *filename,
+                                  int full_traceback, int nogil) {
+    PyObject *old_exc, *old_val, *old_tb;
+    PyObject *ctx;
+    __Pyx_PyThreadState_declare
+#ifdef WITH_THREAD
+    PyGILState_STATE state;
+    if (nogil)
+        state = PyGILState_Ensure();
+#ifdef _MSC_VER
+    else state = (PyGILState_STATE)-1;
+#endif
+#endif
+    CYTHON_UNUSED_VAR(clineno);
+    CYTHON_UNUSED_VAR(lineno);
+    CYTHON_UNUSED_VAR(filename);
+    CYTHON_MAYBE_UNUSED_VAR(nogil);
+    __Pyx_PyThreadState_assign
+    __Pyx_ErrFetch(&old_exc, &old_val, &old_tb);
+    if (full_traceback) {
+        Py_XINCREF(old_exc);
+        Py_XINCREF(old_val);
+        Py_XINCREF(old_tb);
+        __Pyx_ErrRestore(old_exc, old_val, old_tb);
+        PyErr_PrintEx(1);
+    }
+    #if PY_MAJOR_VERSION < 3
+    ctx = PyString_FromString(name);
+    #else
+    ctx = PyUnicode_FromString(name);
+    #endif
+    __Pyx_ErrRestore(old_exc, old_val, old_tb);
+    if (!ctx) {
+        PyErr_WriteUnraisable(Py_None);
+    } else {
+        PyErr_WriteUnraisable(ctx);
+        Py_DECREF(ctx);
+    }
+#ifdef WITH_THREAD
+    if (nogil)
+        PyGILState_Release(state);
+#endif
+}
+
 /* PyFunctionFastCall */
 #if CYTHON_FAST_PYCALL && !CYTHON_VECTORCALL
 static PyObject* __Pyx_PyFunction_FastCallNoKw(PyCodeObject *co, PyObject **args, Py_ssize_t na,
                                                PyObject *globals) {
     PyFrameObject *f;
     PyThreadState *tstate = __Pyx_PyThreadState_Current;
     PyObject **fastlocals;
@@ -10735,300 +9273,38 @@
     #endif
     if (nargs == 0) {
         return __Pyx_PyObject_Call(func, __pyx_empty_tuple, kwargs);
     }
     return __Pyx_PyObject_FastCall_fallback(func, args, (size_t)nargs, kwargs);
 }
 
-/* PyObjectCallNoArg */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func) {
-    PyObject *arg = NULL;
-    return __Pyx_PyObject_FastCall(func, (&arg)+1, 0 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
-}
-
-/* PyObjectCallOneArg */
-static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg) {
-    PyObject *args[2] = {NULL, arg};
-    return __Pyx_PyObject_FastCall(func, args+1, 1 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
-}
-
-/* PyObjectGetMethod */
-static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method) {
-    PyObject *attr;
-#if CYTHON_UNPACK_METHODS && CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_PYTYPE_LOOKUP
+/* ExtTypeTest */
+static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type) {
+    __Pyx_TypeName obj_type_name;
     __Pyx_TypeName type_name;
-    PyTypeObject *tp = Py_TYPE(obj);
-    PyObject *descr;
-    descrgetfunc f = NULL;
-    PyObject **dictptr, *dict;
-    int meth_found = 0;
-    assert (*method == NULL);
-    if (unlikely(tp->tp_getattro != PyObject_GenericGetAttr)) {
-        attr = __Pyx_PyObject_GetAttrStr(obj, name);
-        goto try_unpack;
-    }
-    if (unlikely(tp->tp_dict == NULL) && unlikely(PyType_Ready(tp) < 0)) {
+    if (unlikely(!type)) {
+        PyErr_SetString(PyExc_SystemError, "Missing type object");
         return 0;
     }
-    descr = _PyType_Lookup(tp, name);
-    if (likely(descr != NULL)) {
-        Py_INCREF(descr);
-#if defined(Py_TPFLAGS_METHOD_DESCRIPTOR) && Py_TPFLAGS_METHOD_DESCRIPTOR
-        if (__Pyx_PyType_HasFeature(Py_TYPE(descr), Py_TPFLAGS_METHOD_DESCRIPTOR))
-#elif PY_MAJOR_VERSION >= 3
-        #ifdef __Pyx_CyFunction_USED
-        if (likely(PyFunction_Check(descr) || __Pyx_IS_TYPE(descr, &PyMethodDescr_Type) || __Pyx_CyFunction_Check(descr)))
-        #else
-        if (likely(PyFunction_Check(descr) || __Pyx_IS_TYPE(descr, &PyMethodDescr_Type)))
-        #endif
-#else
-        #ifdef __Pyx_CyFunction_USED
-        if (likely(PyFunction_Check(descr) || __Pyx_CyFunction_Check(descr)))
-        #else
-        if (likely(PyFunction_Check(descr)))
-        #endif
-#endif
-        {
-            meth_found = 1;
-        } else {
-            f = Py_TYPE(descr)->tp_descr_get;
-            if (f != NULL && PyDescr_IsData(descr)) {
-                attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
-                Py_DECREF(descr);
-                goto try_unpack;
-            }
-        }
-    }
-    dictptr = _PyObject_GetDictPtr(obj);
-    if (dictptr != NULL && (dict = *dictptr) != NULL) {
-        Py_INCREF(dict);
-        attr = __Pyx_PyDict_GetItemStr(dict, name);
-        if (attr != NULL) {
-            Py_INCREF(attr);
-            Py_DECREF(dict);
-            Py_XDECREF(descr);
-            goto try_unpack;
-        }
-        Py_DECREF(dict);
-    }
-    if (meth_found) {
-        *method = descr;
+    if (likely(__Pyx_TypeCheck(obj, type)))
         return 1;
-    }
-    if (f != NULL) {
-        attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
-        Py_DECREF(descr);
-        goto try_unpack;
-    }
-    if (likely(descr != NULL)) {
-        *method = descr;
-        return 0;
-    }
-    type_name = __Pyx_PyType_GetName(tp);
-    PyErr_Format(PyExc_AttributeError,
-#if PY_MAJOR_VERSION >= 3
-                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%U'",
-                 type_name, name);
-#else
-                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%.400s'",
-                 type_name, PyString_AS_STRING(name));
-#endif
+    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
+    type_name = __Pyx_PyType_GetName(type);
+    PyErr_Format(PyExc_TypeError,
+                 "Cannot convert " __Pyx_FMT_TYPENAME " to " __Pyx_FMT_TYPENAME,
+                 obj_type_name, type_name);
+    __Pyx_DECREF_TypeName(obj_type_name);
     __Pyx_DECREF_TypeName(type_name);
     return 0;
-#else
-    attr = __Pyx_PyObject_GetAttrStr(obj, name);
-    goto try_unpack;
-#endif
-try_unpack:
-#if CYTHON_UNPACK_METHODS
-    if (likely(attr) && PyMethod_Check(attr) && likely(PyMethod_GET_SELF(attr) == obj)) {
-        PyObject *function = PyMethod_GET_FUNCTION(attr);
-        Py_INCREF(function);
-        Py_DECREF(attr);
-        *method = function;
-        return 1;
-    }
-#endif
-    *method = attr;
-    return 0;
-}
-
-/* PyObjectCallMethod0 */
-static PyObject* __Pyx_PyObject_CallMethod0(PyObject* obj, PyObject* method_name) {
-    PyObject *method = NULL, *result = NULL;
-    int is_method = __Pyx_PyObject_GetMethod(obj, method_name, &method);
-    if (likely(is_method)) {
-        result = __Pyx_PyObject_CallOneArg(method, obj);
-        Py_DECREF(method);
-        return result;
-    }
-    if (unlikely(!method)) goto bad;
-    result = __Pyx_PyObject_CallNoArg(method);
-    Py_DECREF(method);
-bad:
-    return result;
-}
-
-/* UnpackUnboundCMethod */
-static int __Pyx_TryUnpackUnboundCMethod(__Pyx_CachedCFunction* target) {
-    PyObject *method;
-    method = __Pyx_PyObject_GetAttrStr(target->type, *target->method_name);
-    if (unlikely(!method))
-        return -1;
-    target->method = method;
-#if CYTHON_COMPILING_IN_CPYTHON
-    #if PY_MAJOR_VERSION >= 3
-    if (likely(__Pyx_TypeCheck(method, &PyMethodDescr_Type)))
-    #endif
-    {
-        PyMethodDescrObject *descr = (PyMethodDescrObject*) method;
-        target->func = descr->d_method->ml_meth;
-        target->flag = descr->d_method->ml_flags & ~(METH_CLASS | METH_STATIC | METH_COEXIST | METH_STACKLESS);
-    }
-#endif
-    return 0;
-}
-
-/* CallUnboundCMethod0 */
-static PyObject* __Pyx__CallUnboundCMethod0(__Pyx_CachedCFunction* cfunc, PyObject* self) {
-    PyObject *args, *result = NULL;
-    if (unlikely(!cfunc->method) && unlikely(__Pyx_TryUnpackUnboundCMethod(cfunc) < 0)) return NULL;
-#if CYTHON_ASSUME_SAFE_MACROS
-    args = PyTuple_New(1);
-    if (unlikely(!args)) goto bad;
-    Py_INCREF(self);
-    PyTuple_SET_ITEM(args, 0, self);
-#else
-    args = PyTuple_Pack(1, self);
-    if (unlikely(!args)) goto bad;
-#endif
-    result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-    Py_DECREF(args);
-bad:
-    return result;
-}
-
-/* pop */
-static CYTHON_INLINE PyObject* __Pyx__PyObject_Pop(PyObject* L) {
-    if (__Pyx_IS_TYPE(L, &PySet_Type)) {
-        return PySet_Pop(L);
-    }
-    return __Pyx_PyObject_CallMethod0(L, __pyx_n_s_pop);
-}
-#if CYTHON_USE_PYLIST_INTERNALS && CYTHON_ASSUME_SAFE_MACROS
-static CYTHON_INLINE PyObject* __Pyx_PyList_Pop(PyObject* L) {
-    if (likely(PyList_GET_SIZE(L) > (((PyListObject*)L)->allocated >> 1))) {
-        __Pyx_SET_SIZE(L, Py_SIZE(L) - 1);
-        return PyList_GET_ITEM(L, PyList_GET_SIZE(L));
-    }
-    return __Pyx_CallUnboundCMethod0(&__pyx_umethod_PyList_Type_pop, L);
 }
-#endif
 
-/* WriteUnraisableException */
-static void __Pyx_WriteUnraisable(const char *name, int clineno,
-                                  int lineno, const char *filename,
-                                  int full_traceback, int nogil) {
-    PyObject *old_exc, *old_val, *old_tb;
-    PyObject *ctx;
-    __Pyx_PyThreadState_declare
-#ifdef WITH_THREAD
-    PyGILState_STATE state;
-    if (nogil)
-        state = PyGILState_Ensure();
-#ifdef _MSC_VER
-    else state = (PyGILState_STATE)-1;
-#endif
-#endif
-    CYTHON_UNUSED_VAR(clineno);
-    CYTHON_UNUSED_VAR(lineno);
-    CYTHON_UNUSED_VAR(filename);
-    CYTHON_MAYBE_UNUSED_VAR(nogil);
-    __Pyx_PyThreadState_assign
-    __Pyx_ErrFetch(&old_exc, &old_val, &old_tb);
-    if (full_traceback) {
-        Py_XINCREF(old_exc);
-        Py_XINCREF(old_val);
-        Py_XINCREF(old_tb);
-        __Pyx_ErrRestore(old_exc, old_val, old_tb);
-        PyErr_PrintEx(1);
-    }
-    #if PY_MAJOR_VERSION < 3
-    ctx = PyString_FromString(name);
-    #else
-    ctx = PyUnicode_FromString(name);
-    #endif
-    __Pyx_ErrRestore(old_exc, old_val, old_tb);
-    if (!ctx) {
-        PyErr_WriteUnraisable(Py_None);
-    } else {
-        PyErr_WriteUnraisable(ctx);
-        Py_DECREF(ctx);
-    }
-#ifdef WITH_THREAD
-    if (nogil)
-        PyGILState_Release(state);
-#endif
-}
-
-/* KeywordStringCheck */
-static int __Pyx_CheckKeywordStrings(
-    PyObject *kw,
-    const char* function_name,
-    int kw_allowed)
-{
-    PyObject* key = 0;
-    Py_ssize_t pos = 0;
-#if CYTHON_COMPILING_IN_PYPY
-    if (!kw_allowed && PyDict_Next(kw, &pos, &key, 0))
-        goto invalid_keyword;
-    return 1;
-#else
-    if (CYTHON_METH_FASTCALL && likely(PyTuple_Check(kw))) {
-        if (unlikely(PyTuple_GET_SIZE(kw) == 0))
-            return 1;
-        if (!kw_allowed) {
-            key = PyTuple_GET_ITEM(kw, 0);
-            goto invalid_keyword;
-        }
-#if PY_VERSION_HEX < 0x03090000
-        for (pos = 0; pos < PyTuple_GET_SIZE(kw); pos++) {
-            key = PyTuple_GET_ITEM(kw, pos);
-            if (unlikely(!PyUnicode_Check(key)))
-                goto invalid_keyword_type;
-        }
-#endif
-        return 1;
-    }
-    while (PyDict_Next(kw, &pos, &key, 0)) {
-        #if PY_MAJOR_VERSION < 3
-        if (unlikely(!PyString_Check(key)))
-        #endif
-            if (unlikely(!PyUnicode_Check(key)))
-                goto invalid_keyword_type;
-    }
-    if (!kw_allowed && unlikely(key))
-        goto invalid_keyword;
-    return 1;
-invalid_keyword_type:
-    PyErr_Format(PyExc_TypeError,
-        "%.200s() keywords must be strings", function_name);
-    return 0;
-#endif
-invalid_keyword:
-    #if PY_MAJOR_VERSION < 3
-    PyErr_Format(PyExc_TypeError,
-        "%.200s() got an unexpected keyword argument '%.200s'",
-        function_name, PyString_AsString(key));
-    #else
-    PyErr_Format(PyExc_TypeError,
-        "%s() got an unexpected keyword argument '%U'",
-        function_name, key);
-    #endif
-    return 0;
+/* PyObjectCallOneArg */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg) {
+    PyObject *args[2] = {NULL, arg};
+    return __Pyx_PyObject_FastCall(func, args+1, 1 | __Pyx_PY_VECTORCALL_ARGUMENTS_OFFSET);
 }
 
 /* RaiseException */
 #if PY_MAJOR_VERSION < 3
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
     __Pyx_PyThreadState_declare
     CYTHON_UNUSED_VAR(cause);
@@ -11182,428 +9458,14 @@
     }
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
-/* GetItemInt */
-static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j) {
-    PyObject *r;
-    if (unlikely(!j)) return NULL;
-    r = PyObject_GetItem(o, j);
-    Py_DECREF(j);
-    return r;
-}
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
-                                                              CYTHON_NCP_UNUSED int wraparound,
-                                                              CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    Py_ssize_t wrapped_i = i;
-    if (wraparound & unlikely(i < 0)) {
-        wrapped_i += PyList_GET_SIZE(o);
-    }
-    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyList_GET_SIZE(o)))) {
-        PyObject *r = PyList_GET_ITEM(o, wrapped_i);
-        Py_INCREF(r);
-        return r;
-    }
-    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
-#else
-    return PySequence_GetItem(o, i);
-#endif
-}
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
-                                                              CYTHON_NCP_UNUSED int wraparound,
-                                                              CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    Py_ssize_t wrapped_i = i;
-    if (wraparound & unlikely(i < 0)) {
-        wrapped_i += PyTuple_GET_SIZE(o);
-    }
-    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyTuple_GET_SIZE(o)))) {
-        PyObject *r = PyTuple_GET_ITEM(o, wrapped_i);
-        Py_INCREF(r);
-        return r;
-    }
-    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
-#else
-    return PySequence_GetItem(o, i);
-#endif
-}
-static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i, int is_list,
-                                                     CYTHON_NCP_UNUSED int wraparound,
-                                                     CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
-    if (is_list || PyList_CheckExact(o)) {
-        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyList_GET_SIZE(o);
-        if ((!boundscheck) || (likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o))))) {
-            PyObject *r = PyList_GET_ITEM(o, n);
-            Py_INCREF(r);
-            return r;
-        }
-    }
-    else if (PyTuple_CheckExact(o)) {
-        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyTuple_GET_SIZE(o);
-        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyTuple_GET_SIZE(o)))) {
-            PyObject *r = PyTuple_GET_ITEM(o, n);
-            Py_INCREF(r);
-            return r;
-        }
-    } else {
-        PyMappingMethods *mm = Py_TYPE(o)->tp_as_mapping;
-        PySequenceMethods *sm = Py_TYPE(o)->tp_as_sequence;
-        if (mm && mm->mp_subscript) {
-            PyObject *r, *key = PyInt_FromSsize_t(i);
-            if (unlikely(!key)) return NULL;
-            r = mm->mp_subscript(o, key);
-            Py_DECREF(key);
-            return r;
-        }
-        if (likely(sm && sm->sq_item)) {
-            if (wraparound && unlikely(i < 0) && likely(sm->sq_length)) {
-                Py_ssize_t l = sm->sq_length(o);
-                if (likely(l >= 0)) {
-                    i += l;
-                } else {
-                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
-                        return NULL;
-                    PyErr_Clear();
-                }
-            }
-            return sm->sq_item(o, i);
-        }
-    }
-#else
-    if (is_list || PySequence_Check(o)) {
-        return PySequence_GetItem(o, i);
-    }
-#endif
-    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
-}
-
-/* CallUnboundCMethod1 */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg) {
-    if (likely(cfunc->func)) {
-        int flag = cfunc->flag;
-        if (flag == METH_O) {
-            return (*(cfunc->func))(self, arg);
-        } else if ((PY_VERSION_HEX >= 0x030600B1) && flag == METH_FASTCALL) {
-            if ((PY_VERSION_HEX >= 0x030700A0)) {
-                return (*(__Pyx_PyCFunctionFast)(void*)(PyCFunction)cfunc->func)(self, &arg, 1);
-            } else {
-                return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, &arg, 1, NULL);
-            }
-        } else if ((PY_VERSION_HEX >= 0x030700A0) && flag == (METH_FASTCALL | METH_KEYWORDS)) {
-            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, &arg, 1, NULL);
-        }
-    }
-    return __Pyx__CallUnboundCMethod1(cfunc, self, arg);
-}
-#endif
-static PyObject* __Pyx__CallUnboundCMethod1(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg){
-    PyObject *args, *result = NULL;
-    if (unlikely(!cfunc->func && !cfunc->method) && unlikely(__Pyx_TryUnpackUnboundCMethod(cfunc) < 0)) return NULL;
-#if CYTHON_COMPILING_IN_CPYTHON
-    if (cfunc->func && (cfunc->flag & METH_VARARGS)) {
-        args = PyTuple_New(1);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(arg);
-        PyTuple_SET_ITEM(args, 0, arg);
-        if (cfunc->flag & METH_KEYWORDS)
-            result = (*(PyCFunctionWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, NULL);
-        else
-            result = (*cfunc->func)(self, args);
-    } else {
-        args = PyTuple_New(2);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(self);
-        PyTuple_SET_ITEM(args, 0, self);
-        Py_INCREF(arg);
-        PyTuple_SET_ITEM(args, 1, arg);
-        result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-    }
-#else
-    args = PyTuple_Pack(2, self, arg);
-    if (unlikely(!args)) goto bad;
-    result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-#endif
-bad:
-    Py_XDECREF(args);
-    return result;
-}
-
-/* SetItemInt */
-static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v) {
-    int r;
-    if (unlikely(!j)) return -1;
-    r = PyObject_SetItem(o, j, v);
-    Py_DECREF(j);
-    return r;
-}
-static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v, int is_list,
-                                               CYTHON_NCP_UNUSED int wraparound, CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
-    if (is_list || PyList_CheckExact(o)) {
-        Py_ssize_t n = (!wraparound) ? i : ((likely(i >= 0)) ? i : i + PyList_GET_SIZE(o));
-        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o)))) {
-            PyObject* old = PyList_GET_ITEM(o, n);
-            Py_INCREF(v);
-            PyList_SET_ITEM(o, n, v);
-            Py_DECREF(old);
-            return 1;
-        }
-    } else {
-        PyMappingMethods *mm = Py_TYPE(o)->tp_as_mapping;
-        PySequenceMethods *sm = Py_TYPE(o)->tp_as_sequence;
-        if (mm && mm->mp_ass_subscript) {
-            int r;
-            PyObject *key = PyInt_FromSsize_t(i);
-            if (unlikely(!key)) return -1;
-            r = mm->mp_ass_subscript(o, key, v);
-            Py_DECREF(key);
-            return r;
-        }
-        if (likely(sm && sm->sq_ass_item)) {
-            if (wraparound && unlikely(i < 0) && likely(sm->sq_length)) {
-                Py_ssize_t l = sm->sq_length(o);
-                if (likely(l >= 0)) {
-                    i += l;
-                } else {
-                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
-                        return -1;
-                    PyErr_Clear();
-                }
-            }
-            return sm->sq_ass_item(o, i, v);
-        }
-    }
-#else
-#if CYTHON_COMPILING_IN_PYPY
-    if (is_list || (PySequence_Check(o) && !PyDict_Check(o)))
-#else
-    if (is_list || PySequence_Check(o))
-#endif
-    {
-        return PySequence_SetItem(o, i, v);
-    }
-#endif
-    return __Pyx_SetItemInt_Generic(o, PyInt_FromSsize_t(i), v);
-}
-
-/* RaiseTooManyValuesToUnpack */
-static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected) {
-    PyErr_Format(PyExc_ValueError,
-                 "too many values to unpack (expected %" CYTHON_FORMAT_SSIZE_T "d)", expected);
-}
-
-/* RaiseNeedMoreValuesToUnpack */
-static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index) {
-    PyErr_Format(PyExc_ValueError,
-                 "need more than %" CYTHON_FORMAT_SSIZE_T "d value%.1s to unpack",
-                 index, (index == 1) ? "" : "s");
-}
-
-/* IterFinish */
-static CYTHON_INLINE int __Pyx_IterFinish(void) {
-#if CYTHON_FAST_THREAD_STATE
-    PyThreadState *tstate = __Pyx_PyThreadState_Current;
-    PyObject* exc_type = tstate->curexc_type;
-    if (unlikely(exc_type)) {
-        if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) {
-            PyObject *exc_value, *exc_tb;
-            exc_value = tstate->curexc_value;
-            exc_tb = tstate->curexc_traceback;
-            tstate->curexc_type = 0;
-            tstate->curexc_value = 0;
-            tstate->curexc_traceback = 0;
-            Py_DECREF(exc_type);
-            Py_XDECREF(exc_value);
-            Py_XDECREF(exc_tb);
-            return 0;
-        } else {
-            return -1;
-        }
-    }
-    return 0;
-#else
-    if (unlikely(PyErr_Occurred())) {
-        if (likely(PyErr_ExceptionMatches(PyExc_StopIteration))) {
-            PyErr_Clear();
-            return 0;
-        } else {
-            return -1;
-        }
-    }
-    return 0;
-#endif
-}
-
-/* UnpackItemEndCheck */
-static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected) {
-    if (unlikely(retval)) {
-        Py_DECREF(retval);
-        __Pyx_RaiseTooManyValuesError(expected);
-        return -1;
-    }
-    return __Pyx_IterFinish();
-}
-
-/* ArgTypeTest */
-static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact)
-{
-    __Pyx_TypeName type_name;
-    __Pyx_TypeName obj_type_name;
-    if (unlikely(!type)) {
-        PyErr_SetString(PyExc_SystemError, "Missing type object");
-        return 0;
-    }
-    else if (exact) {
-        #if PY_MAJOR_VERSION == 2
-        if ((type == &PyBaseString_Type) && likely(__Pyx_PyBaseString_CheckExact(obj))) return 1;
-        #endif
-    }
-    else {
-        if (likely(__Pyx_TypeCheck(obj, type))) return 1;
-    }
-    type_name = __Pyx_PyType_GetName(type);
-    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
-    PyErr_Format(PyExc_TypeError,
-        "Argument '%.200s' has incorrect type (expected " __Pyx_FMT_TYPENAME
-        ", got " __Pyx_FMT_TYPENAME ")", name, type_name, obj_type_name);
-    __Pyx_DECREF_TypeName(type_name);
-    __Pyx_DECREF_TypeName(obj_type_name);
-    return 0;
-}
-
-/* CallUnboundCMethod2 */
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030600B1
-static CYTHON_INLINE PyObject *__Pyx_CallUnboundCMethod2(__Pyx_CachedCFunction *cfunc, PyObject *self, PyObject *arg1, PyObject *arg2) {
-    if (likely(cfunc->func)) {
-        PyObject *args[2] = {arg1, arg2};
-        if (cfunc->flag == METH_FASTCALL) {
-            #if PY_VERSION_HEX >= 0x030700A0
-            return (*(__Pyx_PyCFunctionFast)(void*)(PyCFunction)cfunc->func)(self, args, 2);
-            #else
-            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, 2, NULL);
-            #endif
-        }
-        #if PY_VERSION_HEX >= 0x030700A0
-        if (cfunc->flag == (METH_FASTCALL | METH_KEYWORDS))
-            return (*(__Pyx_PyCFunctionFastWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, 2, NULL);
-        #endif
-    }
-    return __Pyx__CallUnboundCMethod2(cfunc, self, arg1, arg2);
-}
-#endif
-static PyObject* __Pyx__CallUnboundCMethod2(__Pyx_CachedCFunction* cfunc, PyObject* self, PyObject* arg1, PyObject* arg2){
-    PyObject *args, *result = NULL;
-    if (unlikely(!cfunc->func && !cfunc->method) && unlikely(__Pyx_TryUnpackUnboundCMethod(cfunc) < 0)) return NULL;
-#if CYTHON_COMPILING_IN_CPYTHON
-    if (cfunc->func && (cfunc->flag & METH_VARARGS)) {
-        args = PyTuple_New(2);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(arg1);
-        PyTuple_SET_ITEM(args, 0, arg1);
-        Py_INCREF(arg2);
-        PyTuple_SET_ITEM(args, 1, arg2);
-        if (cfunc->flag & METH_KEYWORDS)
-            result = (*(PyCFunctionWithKeywords)(void*)(PyCFunction)cfunc->func)(self, args, NULL);
-        else
-            result = (*cfunc->func)(self, args);
-    } else {
-        args = PyTuple_New(3);
-        if (unlikely(!args)) goto bad;
-        Py_INCREF(self);
-        PyTuple_SET_ITEM(args, 0, self);
-        Py_INCREF(arg1);
-        PyTuple_SET_ITEM(args, 1, arg1);
-        Py_INCREF(arg2);
-        PyTuple_SET_ITEM(args, 2, arg2);
-        result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-    }
-#else
-    args = PyTuple_Pack(3, self, arg1, arg2);
-    if (unlikely(!args)) goto bad;
-    result = __Pyx_PyObject_Call(cfunc->method, args, NULL);
-#endif
-bad:
-    Py_XDECREF(args);
-    return result;
-}
-
-/* dict_getitem_default */
-static PyObject* __Pyx_PyDict_GetItemDefault(PyObject* d, PyObject* key, PyObject* default_value) {
-    PyObject* value;
-#if PY_MAJOR_VERSION >= 3 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07020000)
-    value = PyDict_GetItemWithError(d, key);
-    if (unlikely(!value)) {
-        if (unlikely(PyErr_Occurred()))
-            return NULL;
-        value = default_value;
-    }
-    Py_INCREF(value);
-    if ((1));
-#else
-    if (PyString_CheckExact(key) || PyUnicode_CheckExact(key) || PyInt_CheckExact(key)) {
-        value = PyDict_GetItem(d, key);
-        if (unlikely(!value)) {
-            value = default_value;
-        }
-        Py_INCREF(value);
-    }
-#endif
-    else {
-        if (default_value == Py_None)
-            value = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyDict_Type_get, d, key);
-        else
-            value = __Pyx_CallUnboundCMethod2(&__pyx_umethod_PyDict_Type_get, d, key, default_value);
-    }
-    return value;
-}
-
-/* py_dict_pop */
-static CYTHON_INLINE PyObject *__Pyx_PyDict_Pop(PyObject *d, PyObject *key, PyObject *default_value) {
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX > 0x030600B3
-    if ((1)) {
-        return _PyDict_Pop(d, key, default_value);
-    } else
-#endif
-    if (default_value) {
-        return __Pyx_CallUnboundCMethod2(&__pyx_umethod_PyDict_Type_pop, d, key, default_value);
-    } else {
-        return __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyDict_Type_pop, d, key);
-    }
-}
-
-/* py_set_discard_unhashable */
-static int __Pyx_PySet_DiscardUnhashable(PyObject *set, PyObject *key) {
-    PyObject *tmpkey;
-    int rv;
-    if (likely(!PySet_Check(key) || !PyErr_ExceptionMatches(PyExc_TypeError)))
-        return -1;
-    PyErr_Clear();
-    tmpkey = __Pyx_PyFrozenSet_New(key);
-    if (tmpkey == NULL)
-        return -1;
-    rv = PySet_Discard(set, tmpkey);
-    Py_DECREF(tmpkey);
-    return rv;
-}
-
-/* py_set_discard */
-static CYTHON_INLINE int __Pyx_PySet_Discard(PyObject *set, PyObject *key) {
-    int found = PySet_Discard(set, key);
-    if (unlikely(found < 0)) {
-        found = __Pyx_PySet_DiscardUnhashable(set, key);
-    }
-    return found;
-}
-
 /* UnicodeConcatInPlace */
 # if CYTHON_COMPILING_IN_CPYTHON && PY_MAJOR_VERSION >= 3
 static int
 __Pyx_unicode_modifiable(PyObject *unicode)
 {
     if (Py_REFCNT(unicode) != 1)
         return 0;
@@ -11654,25 +9516,303 @@
         return *p_left;
     } else {
         return __Pyx_PyUnicode_Concat(left, right);
     }
   }
 #endif
 
+/* SliceObject */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetSlice(PyObject* obj,
+        Py_ssize_t cstart, Py_ssize_t cstop,
+        PyObject** _py_start, PyObject** _py_stop, PyObject** _py_slice,
+        int has_cstart, int has_cstop, int wraparound) {
+    __Pyx_TypeName obj_type_name;
+#if CYTHON_USE_TYPE_SLOTS
+    PyMappingMethods* mp;
+#if PY_MAJOR_VERSION < 3
+    PySequenceMethods* ms = Py_TYPE(obj)->tp_as_sequence;
+    if (likely(ms && ms->sq_slice)) {
+        if (!has_cstart) {
+            if (_py_start && (*_py_start != Py_None)) {
+                cstart = __Pyx_PyIndex_AsSsize_t(*_py_start);
+                if ((cstart == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
+            } else
+                cstart = 0;
+        }
+        if (!has_cstop) {
+            if (_py_stop && (*_py_stop != Py_None)) {
+                cstop = __Pyx_PyIndex_AsSsize_t(*_py_stop);
+                if ((cstop == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
+            } else
+                cstop = PY_SSIZE_T_MAX;
+        }
+        if (wraparound && unlikely((cstart < 0) | (cstop < 0)) && likely(ms->sq_length)) {
+            Py_ssize_t l = ms->sq_length(obj);
+            if (likely(l >= 0)) {
+                if (cstop < 0) {
+                    cstop += l;
+                    if (cstop < 0) cstop = 0;
+                }
+                if (cstart < 0) {
+                    cstart += l;
+                    if (cstart < 0) cstart = 0;
+                }
+            } else {
+                if (!PyErr_ExceptionMatches(PyExc_OverflowError))
+                    goto bad;
+                PyErr_Clear();
+            }
+        }
+        return ms->sq_slice(obj, cstart, cstop);
+    }
+#else
+    CYTHON_UNUSED_VAR(wraparound);
+#endif
+    mp = Py_TYPE(obj)->tp_as_mapping;
+    if (likely(mp && mp->mp_subscript))
+#else
+    CYTHON_UNUSED_VAR(wraparound);
+#endif
+    {
+        PyObject* result;
+        PyObject *py_slice, *py_start, *py_stop;
+        if (_py_slice) {
+            py_slice = *_py_slice;
+        } else {
+            PyObject* owned_start = NULL;
+            PyObject* owned_stop = NULL;
+            if (_py_start) {
+                py_start = *_py_start;
+            } else {
+                if (has_cstart) {
+                    owned_start = py_start = PyInt_FromSsize_t(cstart);
+                    if (unlikely(!py_start)) goto bad;
+                } else
+                    py_start = Py_None;
+            }
+            if (_py_stop) {
+                py_stop = *_py_stop;
+            } else {
+                if (has_cstop) {
+                    owned_stop = py_stop = PyInt_FromSsize_t(cstop);
+                    if (unlikely(!py_stop)) {
+                        Py_XDECREF(owned_start);
+                        goto bad;
+                    }
+                } else
+                    py_stop = Py_None;
+            }
+            py_slice = PySlice_New(py_start, py_stop, Py_None);
+            Py_XDECREF(owned_start);
+            Py_XDECREF(owned_stop);
+            if (unlikely(!py_slice)) goto bad;
+        }
+#if CYTHON_USE_TYPE_SLOTS
+        result = mp->mp_subscript(obj, py_slice);
+#else
+        result = PyObject_GetItem(obj, py_slice);
+#endif
+        if (!_py_slice) {
+            Py_DECREF(py_slice);
+        }
+        return result;
+    }
+    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
+    PyErr_Format(PyExc_TypeError,
+        "'" __Pyx_FMT_TYPENAME "' object is unsliceable", obj_type_name);
+    __Pyx_DECREF_TypeName(obj_type_name);
+bad:
+    return NULL;
+}
+
 /* RaiseUnexpectedTypeError */
 static int
 __Pyx_RaiseUnexpectedTypeError(const char *expected, PyObject *obj)
 {
     __Pyx_TypeName obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
     PyErr_Format(PyExc_TypeError, "Expected %s, got " __Pyx_FMT_TYPENAME,
                  expected, obj_type_name);
     __Pyx_DECREF_TypeName(obj_type_name);
     return 0;
 }
 
+/* ArgTypeTest */
+static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact)
+{
+    __Pyx_TypeName type_name;
+    __Pyx_TypeName obj_type_name;
+    if (unlikely(!type)) {
+        PyErr_SetString(PyExc_SystemError, "Missing type object");
+        return 0;
+    }
+    else if (exact) {
+        #if PY_MAJOR_VERSION == 2
+        if ((type == &PyBaseString_Type) && likely(__Pyx_PyBaseString_CheckExact(obj))) return 1;
+        #endif
+    }
+    else {
+        if (likely(__Pyx_TypeCheck(obj, type))) return 1;
+    }
+    type_name = __Pyx_PyType_GetName(type);
+    obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
+    PyErr_Format(PyExc_TypeError,
+        "Argument '%.200s' has incorrect type (expected " __Pyx_FMT_TYPENAME
+        ", got " __Pyx_FMT_TYPENAME ")", name, type_name, obj_type_name);
+    __Pyx_DECREF_TypeName(type_name);
+    __Pyx_DECREF_TypeName(obj_type_name);
+    return 0;
+}
+
+/* PyIntBinop */
+#if !CYTHON_COMPILING_IN_PYPY
+static PyObject* __Pyx_PyInt_MultiplyCObj(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check) {
+    CYTHON_MAYBE_UNUSED_VAR(intval);
+    CYTHON_MAYBE_UNUSED_VAR(inplace);
+    CYTHON_UNUSED_VAR(zerodivision_check);
+    #if PY_MAJOR_VERSION < 3
+    if (likely(PyInt_CheckExact(op2))) {
+        const long a = intval;
+        long b = PyInt_AS_LONG(op2);
+        
+#ifdef HAVE_LONG_LONG
+            if (sizeof(PY_LONG_LONG) > sizeof(long)) {
+                PY_LONG_LONG result = (PY_LONG_LONG)a * (PY_LONG_LONG)b;
+                return (result >= LONG_MIN && result <= LONG_MAX) ?
+                    PyInt_FromLong((long)result) : PyLong_FromLongLong(result);
+            }
+#endif
+#if CYTHON_USE_TYPE_SLOTS
+            return PyInt_Type.tp_as_number->nb_multiply(op1, op2);
+#else
+            return PyNumber_Multiply(op1, op2);
+#endif
+    }
+    #endif
+    #if CYTHON_USE_PYLONG_INTERNALS
+    if (likely(PyLong_CheckExact(op2))) {
+        const long a = intval;
+        long b, x;
+#ifdef HAVE_LONG_LONG
+        const PY_LONG_LONG lla = intval;
+        PY_LONG_LONG llb, llx;
+#endif
+        const digit* digits = ((PyLongObject*)op2)->ob_digit;
+        const Py_ssize_t size = Py_SIZE(op2);
+        if (unlikely(size == 0)) {
+            return __Pyx_NewRef(op2);
+        }
+        if (likely(__Pyx_sst_abs(size) <= 1)) {
+            b = likely(size) ? digits[0] : 0;
+            if (size == -1) b = -b;
+        } else {
+            switch (size) {
+                case -2:
+                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT+30) {
+                        b = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT+30) {
+                        llb = -(PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case 2:
+                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT+30) {
+                        b = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT+30) {
+                        llb = (PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case -3:
+                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT+30) {
+                        b = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT+30) {
+                        llb = -(PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case 3:
+                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT+30) {
+                        b = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT+30) {
+                        llb = (PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case -4:
+                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT+30) {
+                        b = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT+30) {
+                        llb = -(PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                case 4:
+                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT+30) {
+                        b = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
+                        break;
+                    #ifdef HAVE_LONG_LONG
+                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT+30) {
+                        llb = (PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
+                        goto long_long;
+                    #endif
+                    }
+                    CYTHON_FALLTHROUGH;
+                default: return PyLong_Type.tp_as_number->nb_multiply(op1, op2);
+            }
+        }
+                (void)a; (void)b;
+                #ifdef HAVE_LONG_LONG
+                llb = b;
+                goto long_long;
+                #else
+                return PyLong_Type.tp_as_number->nb_multiply(op1, op2);
+                #endif
+            return PyLong_FromLong(x);
+#ifdef HAVE_LONG_LONG
+        long_long:
+                llx = lla * llb;
+            return PyLong_FromLongLong(llx);
+#endif
+        
+        
+    }
+    #endif
+    if (PyFloat_CheckExact(op2)) {
+        const long a = intval;
+#if CYTHON_COMPILING_IN_LIMITED_API
+        double b = __pyx_PyFloat_AsDouble(op2);
+#else
+        double b = PyFloat_AS_DOUBLE(op2);
+#endif
+            double result;
+            
+            PyFPE_START_PROTECT("multiply", return NULL)
+            result = ((double)a) * (double)b;
+            PyFPE_END_PROTECT(result)
+            return PyFloat_FromDouble(result);
+    }
+    return (inplace ? PyNumber_InPlaceMultiply : PyNumber_Multiply)(op1, op2);
+}
+#endif
+
 /* IsLittleEndian */
 static CYTHON_INLINE int __Pyx_Is_Little_Endian(void)
 {
   union {
     uint32_t u32;
     uint8_t u8[4];
   } S;
@@ -12387,442 +10527,14 @@
     *tb = 0;
     Py_XDECREF(local_type);
     Py_XDECREF(local_value);
     Py_XDECREF(local_tb);
     return -1;
 }
 
-/* FixUpExtensionType */
-  #if CYTHON_USE_TYPE_SPECS
-static int __Pyx_fix_up_extension_type_from_spec(PyType_Spec *spec, PyTypeObject *type) {
-#if PY_VERSION_HEX > 0x030900B1 || CYTHON_COMPILING_IN_LIMITED_API
-    (void) spec;
-    (void) type;
-#else
-    const PyType_Slot *slot = spec->slots;
-    while (slot && slot->slot && slot->slot != Py_tp_members)
-        slot++;
-    if (slot && slot->slot == Py_tp_members) {
-        int changed = 0;
-#if !(PY_VERSION_HEX <= 0x030900b1 && CYTHON_COMPILING_IN_CPYTHON)
-        const
-#endif
-            PyMemberDef *memb = (PyMemberDef*) slot->pfunc;
-        while (memb && memb->name) {
-            if (memb->name[0] == '_' && memb->name[1] == '_') {
-#if PY_VERSION_HEX < 0x030900b1
-                if (strcmp(memb->name, "__weaklistoffset__") == 0) {
-                    assert(memb->type == T_PYSSIZET);
-                    assert(memb->flags == READONLY);
-                    type->tp_weaklistoffset = memb->offset;
-                    changed = 1;
-                }
-                else if (strcmp(memb->name, "__dictoffset__") == 0) {
-                    assert(memb->type == T_PYSSIZET);
-                    assert(memb->flags == READONLY);
-                    type->tp_dictoffset = memb->offset;
-                    changed = 1;
-                }
-#if CYTHON_METH_FASTCALL
-                else if (strcmp(memb->name, "__vectorcalloffset__") == 0) {
-                    assert(memb->type == T_PYSSIZET);
-                    assert(memb->flags == READONLY);
-#if PY_VERSION_HEX >= 0x030800b4
-                    type->tp_vectorcall_offset = memb->offset;
-#else
-                    type->tp_print = (printfunc) memb->offset;
-#endif
-                    changed = 1;
-                }
-#endif
-#else
-                if ((0));
-#endif
-#if PY_VERSION_HEX <= 0x030900b1 && CYTHON_COMPILING_IN_CPYTHON
-                else if (strcmp(memb->name, "__module__") == 0) {
-                    PyObject *descr;
-                    assert(memb->type == T_OBJECT);
-                    assert(memb->flags == 0 || memb->flags == READONLY);
-                    descr = PyDescr_NewMember(type, memb);
-                    if (unlikely(!descr))
-                        return -1;
-                    if (unlikely(PyDict_SetItem(type->tp_dict, PyDescr_NAME(descr), descr) < 0)) {
-                        Py_DECREF(descr);
-                        return -1;
-                    }
-                    Py_DECREF(descr);
-                    changed = 1;
-                }
-#endif
-            }
-            memb++;
-        }
-        if (changed)
-            PyType_Modified(type);
-    }
-#endif
-    return 0;
-}
-#endif
-
-/* ValidateBasesTuple */
-  #if CYTHON_COMPILING_IN_CPYTHON || CYTHON_COMPILING_IN_LIMITED_API || CYTHON_USE_TYPE_SPECS
-static int __Pyx_validate_bases_tuple(const char *type_name, Py_ssize_t dictoffset, PyObject *bases) {
-    Py_ssize_t i, n = PyTuple_GET_SIZE(bases);
-    for (i = 1; i < n; i++)
-    {
-        PyObject *b0 = PyTuple_GET_ITEM(bases, i);
-        PyTypeObject *b;
-#if PY_MAJOR_VERSION < 3
-        if (PyClass_Check(b0))
-        {
-            PyErr_Format(PyExc_TypeError, "base class '%.200s' is an old-style class",
-                         PyString_AS_STRING(((PyClassObject*)b0)->cl_name));
-            return -1;
-        }
-#endif
-        b = (PyTypeObject*) b0;
-        if (!__Pyx_PyType_HasFeature(b, Py_TPFLAGS_HEAPTYPE))
-        {
-            __Pyx_TypeName b_name = __Pyx_PyType_GetName(b);
-            PyErr_Format(PyExc_TypeError,
-                "base class '" __Pyx_FMT_TYPENAME "' is not a heap type", b_name);
-            __Pyx_DECREF_TypeName(b_name);
-            return -1;
-        }
-        if (dictoffset == 0 && b->tp_dictoffset)
-        {
-            __Pyx_TypeName b_name = __Pyx_PyType_GetName(b);
-            PyErr_Format(PyExc_TypeError,
-                "extension type '%.200s' has no __dict__ slot, "
-                "but base type '" __Pyx_FMT_TYPENAME "' has: "
-                "either add 'cdef dict __dict__' to the extension type "
-                "or add '__slots__ = [...]' to the base type",
-                type_name, b_name);
-            __Pyx_DECREF_TypeName(b_name);
-            return -1;
-        }
-    }
-    return 0;
-}
-#endif
-
-/* PyType_Ready */
-  static int __Pyx_PyType_Ready(PyTypeObject *t) {
-#if CYTHON_USE_TYPE_SPECS || !(CYTHON_COMPILING_IN_CPYTHON || CYTHON_COMPILING_IN_LIMITED_API) || defined(PYSTON_MAJOR_VERSION)
-    (void)__Pyx_PyObject_CallMethod0;
-#if CYTHON_USE_TYPE_SPECS
-    (void)__Pyx_validate_bases_tuple;
-#endif
-    return PyType_Ready(t);
-#else
-    int r;
-    PyObject *bases = __Pyx_PyType_GetSlot(t, tp_bases, PyObject*);
-    if (bases && unlikely(__Pyx_validate_bases_tuple(t->tp_name, t->tp_dictoffset, bases) == -1))
-        return -1;
-#if PY_VERSION_HEX >= 0x03050000 && !defined(PYSTON_MAJOR_VERSION)
-    {
-        int gc_was_enabled;
-    #if PY_VERSION_HEX >= 0x030A00b1
-        gc_was_enabled = PyGC_Disable();
-        (void)__Pyx_PyObject_CallMethod0;
-    #else
-        PyObject *ret, *py_status;
-        PyObject *gc = NULL;
-        #if PY_VERSION_HEX >= 0x030700a1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM+0 >= 0x07030400)
-        gc = PyImport_GetModule(__pyx_kp_u_gc);
-        #endif
-        if (unlikely(!gc)) gc = PyImport_Import(__pyx_kp_u_gc);
-        if (unlikely(!gc)) return -1;
-        py_status = __Pyx_PyObject_CallMethod0(gc, __pyx_kp_u_isenabled);
-        if (unlikely(!py_status)) {
-            Py_DECREF(gc);
-            return -1;
-        }
-        gc_was_enabled = __Pyx_PyObject_IsTrue(py_status);
-        Py_DECREF(py_status);
-        if (gc_was_enabled > 0) {
-            ret = __Pyx_PyObject_CallMethod0(gc, __pyx_kp_u_disable);
-            if (unlikely(!ret)) {
-                Py_DECREF(gc);
-                return -1;
-            }
-            Py_DECREF(ret);
-        } else if (unlikely(gc_was_enabled == -1)) {
-            Py_DECREF(gc);
-            return -1;
-        }
-    #endif
-        t->tp_flags |= Py_TPFLAGS_HEAPTYPE;
-#else
-        (void)__Pyx_PyObject_CallMethod0;
-#endif
-    r = PyType_Ready(t);
-#if PY_VERSION_HEX >= 0x03050000 && !defined(PYSTON_MAJOR_VERSION)
-        t->tp_flags &= ~Py_TPFLAGS_HEAPTYPE;
-    #if PY_VERSION_HEX >= 0x030A00b1
-        if (gc_was_enabled)
-            PyGC_Enable();
-    #else
-        if (gc_was_enabled) {
-            PyObject *tp, *v, *tb;
-            PyErr_Fetch(&tp, &v, &tb);
-            ret = __Pyx_PyObject_CallMethod0(gc, __pyx_kp_u_enable);
-            if (likely(ret || r == -1)) {
-                Py_XDECREF(ret);
-                PyErr_Restore(tp, v, tb);
-            } else {
-                Py_XDECREF(tp);
-                Py_XDECREF(v);
-                Py_XDECREF(tb);
-                r = -1;
-            }
-        }
-        Py_DECREF(gc);
-    #endif
-    }
-#endif
-    return r;
-#endif
-}
-
-/* PyObject_GenericGetAttrNoDict */
-  #if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
-static PyObject *__Pyx_RaiseGenericGetAttributeError(PyTypeObject *tp, PyObject *attr_name) {
-    __Pyx_TypeName type_name = __Pyx_PyType_GetName(tp);
-    PyErr_Format(PyExc_AttributeError,
-#if PY_MAJOR_VERSION >= 3
-                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%U'",
-                 type_name, attr_name);
-#else
-                 "'" __Pyx_FMT_TYPENAME "' object has no attribute '%.400s'",
-                 type_name, PyString_AS_STRING(attr_name));
-#endif
-    __Pyx_DECREF_TypeName(type_name);
-    return NULL;
-}
-static CYTHON_INLINE PyObject* __Pyx_PyObject_GenericGetAttrNoDict(PyObject* obj, PyObject* attr_name) {
-    PyObject *descr;
-    PyTypeObject *tp = Py_TYPE(obj);
-    if (unlikely(!PyString_Check(attr_name))) {
-        return PyObject_GenericGetAttr(obj, attr_name);
-    }
-    assert(!tp->tp_dictoffset);
-    descr = _PyType_Lookup(tp, attr_name);
-    if (unlikely(!descr)) {
-        return __Pyx_RaiseGenericGetAttributeError(tp, attr_name);
-    }
-    Py_INCREF(descr);
-    #if PY_MAJOR_VERSION < 3
-    if (likely(PyType_HasFeature(Py_TYPE(descr), Py_TPFLAGS_HAVE_CLASS)))
-    #endif
-    {
-        descrgetfunc f = Py_TYPE(descr)->tp_descr_get;
-        if (unlikely(f)) {
-            PyObject *res = f(descr, obj, (PyObject *)tp);
-            Py_DECREF(descr);
-            return res;
-        }
-    }
-    return descr;
-}
-#endif
-
-/* PyObject_GenericGetAttr */
-  #if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
-static PyObject* __Pyx_PyObject_GenericGetAttr(PyObject* obj, PyObject* attr_name) {
-    if (unlikely(Py_TYPE(obj)->tp_dictoffset)) {
-        return PyObject_GenericGetAttr(obj, attr_name);
-    }
-    return __Pyx_PyObject_GenericGetAttrNoDict(obj, attr_name);
-}
-#endif
-
-/* SetVTable */
-  static int __Pyx_SetVtable(PyTypeObject *type, void *vtable) {
-    PyObject *ob = PyCapsule_New(vtable, 0, 0);
-    if (unlikely(!ob))
-        goto bad;
-#if CYTHON_COMPILING_IN_LIMITED_API
-    if (unlikely(PyObject_SetAttr((PyObject *) type, __pyx_n_s_pyx_vtable, ob) < 0))
-#else
-    if (unlikely(PyDict_SetItem(type->tp_dict, __pyx_n_s_pyx_vtable, ob) < 0))
-#endif
-        goto bad;
-    Py_DECREF(ob);
-    return 0;
-bad:
-    Py_XDECREF(ob);
-    return -1;
-}
-
-/* GetVTable */
-  static void* __Pyx_GetVtable(PyTypeObject *type) {
-    void* ptr;
-#if CYTHON_COMPILING_IN_LIMITED_API
-    PyObject *ob = PyObject_GetAttr((PyObject *)type, __pyx_n_s_pyx_vtable);
-#else
-    PyObject *ob = PyObject_GetItem(type->tp_dict, __pyx_n_s_pyx_vtable);
-#endif
-    if (!ob)
-        goto bad;
-    ptr = PyCapsule_GetPointer(ob, 0);
-    if (!ptr && !PyErr_Occurred())
-        PyErr_SetString(PyExc_RuntimeError, "invalid vtable found for imported type");
-    Py_DECREF(ob);
-    return ptr;
-bad:
-    Py_XDECREF(ob);
-    return NULL;
-}
-
-/* MergeVTables */
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-static int __Pyx_MergeVtables(PyTypeObject *type) {
-    int i;
-    void** base_vtables;
-    __Pyx_TypeName tp_base_name;
-    __Pyx_TypeName base_name;
-    void* unknown = (void*)-1;
-    PyObject* bases = type->tp_bases;
-    int base_depth = 0;
-    {
-        PyTypeObject* base = type->tp_base;
-        while (base) {
-            base_depth += 1;
-            base = base->tp_base;
-        }
-    }
-    base_vtables = (void**) malloc(sizeof(void*) * (size_t)(base_depth + 1));
-    base_vtables[0] = unknown;
-    for (i = 1; i < PyTuple_GET_SIZE(bases); i++) {
-        void* base_vtable = __Pyx_GetVtable(((PyTypeObject*)PyTuple_GET_ITEM(bases, i)));
-        if (base_vtable != NULL) {
-            int j;
-            PyTypeObject* base = type->tp_base;
-            for (j = 0; j < base_depth; j++) {
-                if (base_vtables[j] == unknown) {
-                    base_vtables[j] = __Pyx_GetVtable(base);
-                    base_vtables[j + 1] = unknown;
-                }
-                if (base_vtables[j] == base_vtable) {
-                    break;
-                } else if (base_vtables[j] == NULL) {
-                    goto bad;
-                }
-                base = base->tp_base;
-            }
-        }
-    }
-    PyErr_Clear();
-    free(base_vtables);
-    return 0;
-bad:
-    tp_base_name = __Pyx_PyType_GetName(type->tp_base);
-    base_name = __Pyx_PyType_GetName((PyTypeObject*)PyTuple_GET_ITEM(bases, i));
-    PyErr_Format(PyExc_TypeError,
-        "multiple bases have vtable conflict: '" __Pyx_FMT_TYPENAME "' and '" __Pyx_FMT_TYPENAME "'", tp_base_name, base_name);
-    __Pyx_DECREF_TypeName(tp_base_name);
-    __Pyx_DECREF_TypeName(base_name);
-    free(base_vtables);
-    return -1;
-}
-#endif
-
-/* SetupReduce */
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-static int __Pyx_setup_reduce_is_named(PyObject* meth, PyObject* name) {
-  int ret;
-  PyObject *name_attr;
-  name_attr = __Pyx_PyObject_GetAttrStrNoError(meth, __pyx_n_s_name);
-  if (likely(name_attr)) {
-      ret = PyObject_RichCompareBool(name_attr, name, Py_EQ);
-  } else {
-      ret = -1;
-  }
-  if (unlikely(ret < 0)) {
-      PyErr_Clear();
-      ret = 0;
-  }
-  Py_XDECREF(name_attr);
-  return ret;
-}
-static int __Pyx_setup_reduce(PyObject* type_obj) {
-    int ret = 0;
-    PyObject *object_reduce = NULL;
-    PyObject *object_reduce_ex = NULL;
-    PyObject *reduce = NULL;
-    PyObject *reduce_ex = NULL;
-    PyObject *reduce_cython = NULL;
-    PyObject *setstate = NULL;
-    PyObject *setstate_cython = NULL;
-#if CYTHON_USE_PYTYPE_LOOKUP
-    if (_PyType_Lookup((PyTypeObject*)type_obj, __pyx_n_s_getstate)) goto __PYX_GOOD;
-#else
-    if (PyObject_HasAttr(type_obj, __pyx_n_s_getstate)) goto __PYX_GOOD;
-#endif
-#if CYTHON_USE_PYTYPE_LOOKUP
-    object_reduce_ex = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto __PYX_BAD;
-#else
-    object_reduce_ex = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto __PYX_BAD;
-#endif
-    reduce_ex = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce_ex); if (unlikely(!reduce_ex)) goto __PYX_BAD;
-    if (reduce_ex == object_reduce_ex) {
-#if CYTHON_USE_PYTYPE_LOOKUP
-        object_reduce = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto __PYX_BAD;
-#else
-        object_reduce = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto __PYX_BAD;
-#endif
-        reduce = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce); if (unlikely(!reduce)) goto __PYX_BAD;
-        if (reduce == object_reduce || __Pyx_setup_reduce_is_named(reduce, __pyx_n_s_reduce_cython)) {
-            reduce_cython = __Pyx_PyObject_GetAttrStrNoError(type_obj, __pyx_n_s_reduce_cython);
-            if (likely(reduce_cython)) {
-                ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce, reduce_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
-                ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
-            } else if (reduce == object_reduce || PyErr_Occurred()) {
-                goto __PYX_BAD;
-            }
-            setstate = __Pyx_PyObject_GetAttrStrNoError(type_obj, __pyx_n_s_setstate);
-            if (!setstate) PyErr_Clear();
-            if (!setstate || __Pyx_setup_reduce_is_named(setstate, __pyx_n_s_setstate_cython)) {
-                setstate_cython = __Pyx_PyObject_GetAttrStrNoError(type_obj, __pyx_n_s_setstate_cython);
-                if (likely(setstate_cython)) {
-                    ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate, setstate_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
-                    ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
-                } else if (!setstate || PyErr_Occurred()) {
-                    goto __PYX_BAD;
-                }
-            }
-            PyType_Modified((PyTypeObject*)type_obj);
-        }
-    }
-    goto __PYX_GOOD;
-__PYX_BAD:
-    if (!PyErr_Occurred()) {
-        __Pyx_TypeName type_obj_name =
-            __Pyx_PyType_GetName((PyTypeObject*)type_obj);
-        PyErr_Format(PyExc_RuntimeError,
-            "Unable to initialize pickling for " __Pyx_FMT_TYPENAME, type_obj_name);
-        __Pyx_DECREF_TypeName(type_obj_name);
-    }
-    ret = -1;
-__PYX_GOOD:
-#if !CYTHON_USE_PYTYPE_LOOKUP
-    Py_XDECREF(object_reduce);
-    Py_XDECREF(object_reduce_ex);
-#endif
-    Py_XDECREF(reduce);
-    Py_XDECREF(reduce_ex);
-    Py_XDECREF(reduce_cython);
-    Py_XDECREF(setstate);
-    Py_XDECREF(setstate_cython);
-    return ret;
-}
-#endif
-
 /* TypeImport */
   #ifndef __PYX_HAVE_RT_ImportType
 #define __PYX_HAVE_RT_ImportType
 static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
     size_t size, enum __Pyx_ImportType_CheckSize check_size)
 {
     PyObject *result = 0;
@@ -12876,14 +10588,34 @@
     return (PyTypeObject *)result;
 bad:
     Py_XDECREF(result);
     return NULL;
 }
 #endif
 
+/* GetVTable */
+  static void* __Pyx_GetVtable(PyTypeObject *type) {
+    void* ptr;
+#if CYTHON_COMPILING_IN_LIMITED_API
+    PyObject *ob = PyObject_GetAttr((PyObject *)type, __pyx_n_s_pyx_vtable);
+#else
+    PyObject *ob = PyObject_GetItem(type->tp_dict, __pyx_n_s_pyx_vtable);
+#endif
+    if (!ob)
+        goto bad;
+    ptr = PyCapsule_GetPointer(ob, 0);
+    if (!ptr && !PyErr_Occurred())
+        PyErr_SetString(PyExc_RuntimeError, "invalid vtable found for imported type");
+    Py_DECREF(ob);
+    return ptr;
+bad:
+    Py_XDECREF(ob);
+    return NULL;
+}
+
 /* Import */
   static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
     PyObject *module = 0;
     PyObject *empty_dict = 0;
     PyObject *empty_list = 0;
     #if PY_MAJOR_VERSION < 3
     PyObject *py_import;
@@ -13066,14 +10798,87 @@
     } else if (PyErr_Occurred()) {
         PyErr_Clear();
     }
 #endif
     return __Pyx__ImportDottedModule(name, parts_tuple);
 }
 
+/* FixUpExtensionType */
+  #if CYTHON_USE_TYPE_SPECS
+static int __Pyx_fix_up_extension_type_from_spec(PyType_Spec *spec, PyTypeObject *type) {
+#if PY_VERSION_HEX > 0x030900B1 || CYTHON_COMPILING_IN_LIMITED_API
+    (void) spec;
+    (void) type;
+#else
+    const PyType_Slot *slot = spec->slots;
+    while (slot && slot->slot && slot->slot != Py_tp_members)
+        slot++;
+    if (slot && slot->slot == Py_tp_members) {
+        int changed = 0;
+#if !(PY_VERSION_HEX <= 0x030900b1 && CYTHON_COMPILING_IN_CPYTHON)
+        const
+#endif
+            PyMemberDef *memb = (PyMemberDef*) slot->pfunc;
+        while (memb && memb->name) {
+            if (memb->name[0] == '_' && memb->name[1] == '_') {
+#if PY_VERSION_HEX < 0x030900b1
+                if (strcmp(memb->name, "__weaklistoffset__") == 0) {
+                    assert(memb->type == T_PYSSIZET);
+                    assert(memb->flags == READONLY);
+                    type->tp_weaklistoffset = memb->offset;
+                    changed = 1;
+                }
+                else if (strcmp(memb->name, "__dictoffset__") == 0) {
+                    assert(memb->type == T_PYSSIZET);
+                    assert(memb->flags == READONLY);
+                    type->tp_dictoffset = memb->offset;
+                    changed = 1;
+                }
+#if CYTHON_METH_FASTCALL
+                else if (strcmp(memb->name, "__vectorcalloffset__") == 0) {
+                    assert(memb->type == T_PYSSIZET);
+                    assert(memb->flags == READONLY);
+#if PY_VERSION_HEX >= 0x030800b4
+                    type->tp_vectorcall_offset = memb->offset;
+#else
+                    type->tp_print = (printfunc) memb->offset;
+#endif
+                    changed = 1;
+                }
+#endif
+#else
+                if ((0));
+#endif
+#if PY_VERSION_HEX <= 0x030900b1 && CYTHON_COMPILING_IN_CPYTHON
+                else if (strcmp(memb->name, "__module__") == 0) {
+                    PyObject *descr;
+                    assert(memb->type == T_OBJECT);
+                    assert(memb->flags == 0 || memb->flags == READONLY);
+                    descr = PyDescr_NewMember(type, memb);
+                    if (unlikely(!descr))
+                        return -1;
+                    if (unlikely(PyDict_SetItem(type->tp_dict, PyDescr_NAME(descr), descr) < 0)) {
+                        Py_DECREF(descr);
+                        return -1;
+                    }
+                    Py_DECREF(descr);
+                    changed = 1;
+                }
+#endif
+            }
+            memb++;
+        }
+        if (changed)
+            PyType_Modified(type);
+    }
+#endif
+    return 0;
+}
+#endif
+
 /* FetchCommonType */
   static PyObject *__Pyx_FetchSharedCythonABIModule(void) {
     PyObject *abi_module = PyImport_AddModule((char*) __PYX_ABI_MODULE_NAME);
     if (!abi_module) return NULL;
     Py_INCREF(abi_module);
     return abi_module;
 }
@@ -14881,104 +12686,104 @@
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
         "can't convert negative value to int");
     return (int) -1;
 }
 
 /* CIntToPy */
-  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value) {
+  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic push
 #pragma GCC diagnostic ignored "-Wconversion"
 #endif
-    const int neg_one = (int) -1, const_zero = (int) 0;
+    const long neg_one = (long) -1, const_zero = (long) 0;
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic pop
 #endif
     const int is_unsigned = neg_one > const_zero;
     if (is_unsigned) {
-        if (sizeof(int) < sizeof(long)) {
+        if (sizeof(long) < sizeof(long)) {
             return PyInt_FromLong((long) value);
-        } else if (sizeof(int) <= sizeof(unsigned long)) {
+        } else if (sizeof(long) <= sizeof(unsigned long)) {
             return PyLong_FromUnsignedLong((unsigned long) value);
 #ifdef HAVE_LONG_LONG
-        } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
+        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
             return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
 #endif
         }
     } else {
-        if (sizeof(int) <= sizeof(long)) {
+        if (sizeof(long) <= sizeof(long)) {
             return PyInt_FromLong((long) value);
 #ifdef HAVE_LONG_LONG
-        } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
+        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
             return PyLong_FromLongLong((PY_LONG_LONG) value);
 #endif
         }
     }
     {
         int one = 1; int little = (int)*(unsigned char *)&one;
         unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(int),
+        return _PyLong_FromByteArray(bytes, sizeof(long),
                                      little, !is_unsigned);
     }
 }
 
-/* FormatTypeName */
-  #if CYTHON_COMPILING_IN_LIMITED_API
-static __Pyx_TypeName
-__Pyx_PyType_GetName(PyTypeObject* tp)
-{
-    PyObject *name = __Pyx_PyObject_GetAttrStr((PyObject *)tp,
-                                               __pyx_n_s_name);
-    if (unlikely(name == NULL) || unlikely(!PyUnicode_Check(name))) {
-        PyErr_Clear();
-        Py_XSETREF(name, __Pyx_NewRef(__pyx_n_s__14));
-    }
-    return name;
-}
-#endif
-
 /* CIntToPy */
-  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
+  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value) {
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic push
 #pragma GCC diagnostic ignored "-Wconversion"
 #endif
-    const long neg_one = (long) -1, const_zero = (long) 0;
+    const int neg_one = (int) -1, const_zero = (int) 0;
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic pop
 #endif
     const int is_unsigned = neg_one > const_zero;
     if (is_unsigned) {
-        if (sizeof(long) < sizeof(long)) {
+        if (sizeof(int) < sizeof(long)) {
             return PyInt_FromLong((long) value);
-        } else if (sizeof(long) <= sizeof(unsigned long)) {
+        } else if (sizeof(int) <= sizeof(unsigned long)) {
             return PyLong_FromUnsignedLong((unsigned long) value);
 #ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
+        } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
             return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
 #endif
         }
     } else {
-        if (sizeof(long) <= sizeof(long)) {
+        if (sizeof(int) <= sizeof(long)) {
             return PyInt_FromLong((long) value);
 #ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
+        } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
             return PyLong_FromLongLong((PY_LONG_LONG) value);
 #endif
         }
     }
     {
         int one = 1; int little = (int)*(unsigned char *)&one;
         unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(long),
+        return _PyLong_FromByteArray(bytes, sizeof(int),
                                      little, !is_unsigned);
     }
 }
 
+/* FormatTypeName */
+  #if CYTHON_COMPILING_IN_LIMITED_API
+static __Pyx_TypeName
+__Pyx_PyType_GetName(PyTypeObject* tp)
+{
+    PyObject *name = __Pyx_PyObject_GetAttrStr((PyObject *)tp,
+                                               __pyx_n_s_name);
+    if (unlikely(name == NULL) || unlikely(!PyUnicode_Check(name))) {
+        PyErr_Clear();
+        Py_XSETREF(name, __Pyx_NewRef(__pyx_n_s__9));
+    }
+    return name;
+}
+#endif
+
 /* CIntFromPy */
   static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
 #ifdef __Pyx_HAS_GCC_DIAGNOSTIC
 #pragma GCC diagnostic push
 #pragma GCC diagnostic ignored "-Wconversion"
 #endif
     const long neg_one = (long) -1, const_zero = (long) 0;
@@ -15299,14 +13104,52 @@
                       "does not match runtime version %s",
                       ctversion, __Pyx_MODULE_NAME, rtversion);
         return PyErr_WarnEx(NULL, message, 1);
     }
     return 0;
 }
 
+/* FunctionImport */
+  #ifndef __PYX_HAVE_RT_ImportFunction
+#define __PYX_HAVE_RT_ImportFunction
+static int __Pyx_ImportFunction(PyObject *module, const char *funcname, void (**f)(void), const char *sig) {
+    PyObject *d = 0;
+    PyObject *cobj = 0;
+    union {
+        void (*fp)(void);
+        void *p;
+    } tmp;
+    d = PyObject_GetAttrString(module, (char *)"__pyx_capi__");
+    if (!d)
+        goto bad;
+    cobj = PyDict_GetItemString(d, funcname);
+    if (!cobj) {
+        PyErr_Format(PyExc_ImportError,
+            "%.200s does not export expected C function %.200s",
+                PyModule_GetName(module), funcname);
+        goto bad;
+    }
+    if (!PyCapsule_IsValid(cobj, sig)) {
+        PyErr_Format(PyExc_TypeError,
+            "C function %.200s.%.200s has wrong signature (expected %.500s, got %.500s)",
+             PyModule_GetName(module), funcname, sig, PyCapsule_GetName(cobj));
+        goto bad;
+    }
+    tmp.p = PyCapsule_GetPointer(cobj, sig);
+    *f = tmp.fp;
+    if (!(*f))
+        goto bad;
+    Py_DECREF(d);
+    return 0;
+bad:
+    Py_XDECREF(d);
+    return -1;
+}
+#endif
+
 /* InitStrings */
   #if PY_MAJOR_VERSION >= 3
 static int __Pyx_InitString(__Pyx_StringTabEntry t, PyObject **str) {
     if (t.is_unicode | t.is_str) {
         if (t.intern) {
             *str = PyUnicode_InternFromString(t.s);
         } else if (t.encoding) {
```

### Comparing `druhg-1.3.0/druhg/_druhg_tree.c` & `druhg-1.4.0/druhg/_druhg_tree.c`

 * *Files 3% similar despite different names*

```diff
@@ -1201,14 +1201,15 @@
 /* #### Code section: filename_table ### */
 
 static const char *__pyx_f[] = {
   "druhg\\\\_druhg_tree.pyx",
   "<stringsource>",
   "venv\\\\lib\\\\site-packages\\\\numpy\\\\__init__.cython-30.pxd",
   "venv\\\\lib\\\\site-packages\\\\Cython\\\\Includes\\\\cpython\\\\type.pxd",
+  "druhg\\\\_druhg_unionfind.pxd",
 };
 /* #### Code section: utility_code_proto_before_types ### */
 /* BufferFormatStructs.proto */
 #define IS_UNSIGNED(type) (((type) -1) > 0)
 struct __Pyx_StructField_;
 #define __PYX_BUF_FLAGS_PACKED_STRUCT (1 << 0)
 typedef struct {
@@ -1457,17 +1458,17 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 /* #### Code section: type_declarations ### */
 
 /*--- Type declarations ---*/
+struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind;
 struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse;
 struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric;
-struct __pyx_obj_5druhg_11_druhg_tree_UnionFind;
 struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity;
 struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges;
 struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr;
 
 /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":771
  * ctypedef npy_longdouble longdouble_t
  * 
@@ -1508,96 +1509,100 @@
 struct __pyx_opt_args_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query;
 
 /* "druhg/_druhg_tree.pxd":4
  * cimport numpy as np
  * 
  * cdef struct Relation:             # <<<<<<<<<<<<<<
  *     np.double_t reciprocity
- *     # np.double_t upper_bound
+ *     np.intp_t endpoint
  */
 struct __pyx_t_5druhg_11_druhg_tree_Relation {
   __pyx_t_5numpy_double_t reciprocity;
-  __pyx_t_5numpy_intp_t target;
-  __pyx_t_5numpy_double_t dia_dis;
+  __pyx_t_5numpy_intp_t endpoint;
+  __pyx_t_5numpy_intp_t max_rank;
+  __pyx_t_5numpy_intp_t skip_first;
 };
 
-/* "druhg/_druhg_tree.pyx":35
+/* "druhg/_druhg_tree.pyx":48
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         # TODO: actually we need to consider replacing INF with something else.
  *         # Reciprocity of absent link is not the same as the INF. Do reciprocity with graphs!
  */
 struct __pyx_opt_args_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_query {
   int __pyx_n;
   PyObject *dualtree;
   PyObject *breadth_first;
 };
 
-/* "druhg/_druhg_tree.pyx":81
+/* "druhg/_druhg_tree.pyx":94
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         cdef np.ndarray[np.double_t, ndim=2] knn_dist
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  */
 struct __pyx_opt_args_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query {
   int __pyx_n;
   PyObject *dualtree;
   PyObject *breadth_first;
 };
 
-/* "druhg/_druhg_tree.pyx":27
- * from joblib import Parallel, delayed
+/* "_druhg_unionfind.pxd":16
+ * 
+ * 
+ * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
+ *     cdef:
+ *         np.intp_t p_size
+ */
+struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind {
+  PyObject_HEAD
+  struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *__pyx_vtab;
+  __pyx_t_5numpy_intp_t p_size;
+  PyArrayObject *parent_arr;
+  __pyx_t_5numpy_intp_t *parent;
+  PyArrayObject *fast_arr;
+  __pyx_t_5numpy_intp_t *fast;
+  __pyx_t_5numpy_intp_t next_label;
+};
+
+
+/* "druhg/_druhg_tree.pyx":40
+ *     return np.empty((num_points - 1), dtype=np.intp)
  * 
  * cdef class PairwiseDistanceTreeSparse(object):             # <<<<<<<<<<<<<<
  *     cdef object data_arr
  *     cdef int data_size
  */
 struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse {
   PyObject_HEAD
   struct __pyx_vtabstruct_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_vtab;
   PyObject *data_arr;
   int data_size;
 };
 
 
-/* "druhg/_druhg_tree.pyx":73
+/* "druhg/_druhg_tree.pyx":86
  *         return knn_dist, knn_indices
  * 
  * cdef class PairwiseDistanceTreeGeneric(object):             # <<<<<<<<<<<<<<
  *     cdef object data_arr
  *     cdef int data_size
  */
 struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric {
   PyObject_HEAD
   struct __pyx_vtabstruct_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_vtab;
   PyObject *data_arr;
   int data_size;
 };
 
 
-/* "druhg/_druhg_tree.pyx":101
- *         return knn_dist, knn_indices
+/* "druhg/_druhg_tree.pyx":115
  * 
- * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
- *     cdef:
- *         np.ndarray parent_arr
- */
-struct __pyx_obj_5druhg_11_druhg_tree_UnionFind {
-  PyObject_HEAD
-  struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *__pyx_vtab;
-  PyArrayObject *parent_arr;
-  __pyx_t_5numpy_intp_t *parent;
-  __pyx_t_5numpy_intp_t next_label;
-};
-
-
-/* "druhg/_druhg_tree.pyx":140
- *         return
  * 
  * cdef class UniversalReciprocity (object):             # <<<<<<<<<<<<<<
  *     """Constructs DRUHG spanning tree and marks parents of clusters
  * 
  */
 struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity {
   PyObject_HEAD
@@ -1605,36 +1610,39 @@
   PyObject *tree;
   PyObject *dist_tree;
   __pyx_t_5numpy_double_t PRECISION;
   __pyx_t_5numpy_intp_t num_points;
   __pyx_t_5numpy_intp_t num_features;
   __pyx_t_5numpy_intp_t max_neighbors_search;
   __pyx_t_5numpy_intp_t n_jobs;
-  struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *U;
+  struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *U;
   __pyx_t_5numpy_intp_t result_edges;
-  PyArrayObject *result_value_arr;
+  PyArrayObject *result_values_arr;
   PyArrayObject *result_pairs_arr;
+  PyArrayObject *result_rank_arr;
+  PyArrayObject *knn_d;
+  PyArrayObject *knn_i;
 };
 
 
-/* "druhg/_druhg_tree.pyx":482
- * 
+/* "druhg/_druhg_tree.pyx":341
+ *         return res
  * 
- *     cdef _compute_tree_edges(self, is_slow):             # <<<<<<<<<<<<<<
+ *     cdef _compute_tree_edges(self):             # <<<<<<<<<<<<<<
  *         # DRUHG
  *         # computes DRUHG Spanning Tree
  */
 struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges {
   PyObject_HEAD
   PyObject *__pyx_v_datasets;
   struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self;
 };
 
 
-/* "druhg/_druhg_tree.pyx":509
+/* "druhg/_druhg_tree.pyx":368
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)
  *                 (points,             # <<<<<<<<<<<<<<
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  */
 struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr {
@@ -1643,74 +1651,74 @@
   PyObject *__pyx_v_points;
   PyObject *__pyx_t_0;
   Py_ssize_t __pyx_t_1;
 };
 
 
 
-/* "druhg/_druhg_tree.pyx":27
- * from joblib import Parallel, delayed
+/* "_druhg_unionfind.pxd":16
+ * 
+ * 
+ * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
+ *     cdef:
+ *         np.intp_t p_size
+ */
+
+struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind {
+  __pyx_t_5numpy_intp_t (*nullify)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *);
+  __pyx_t_5numpy_intp_t (*mark_up)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t);
+  __pyx_t_5numpy_intp_t (*is_same_parent)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
+  void (*__pyx_union)(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
+};
+static struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *__pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind;
+
+
+/* "druhg/_druhg_tree.pyx":40
+ *     return np.empty((num_points - 1), dtype=np.intp)
  * 
  * cdef class PairwiseDistanceTreeSparse(object):             # <<<<<<<<<<<<<<
  *     cdef object data_arr
  *     cdef int data_size
  */
 
 struct __pyx_vtabstruct_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse {
   PyObject *(*query)(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *, PyObject *, PyObject *, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_query *__pyx_optional_args);
 };
 static struct __pyx_vtabstruct_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse;
 
 
-/* "druhg/_druhg_tree.pyx":73
+/* "druhg/_druhg_tree.pyx":86
  *         return knn_dist, knn_indices
  * 
  * cdef class PairwiseDistanceTreeGeneric(object):             # <<<<<<<<<<<<<<
  *     cdef object data_arr
  *     cdef int data_size
  */
 
 struct __pyx_vtabstruct_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric {
   PyObject *(*query)(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *, PyObject *, PyObject *, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query *__pyx_optional_args);
 };
 static struct __pyx_vtabstruct_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric;
 
 
-/* "druhg/_druhg_tree.pyx":101
- *         return knn_dist, knn_indices
+/* "druhg/_druhg_tree.pyx":115
  * 
- * cdef class UnionFind (object):             # <<<<<<<<<<<<<<
- *     cdef:
- *         np.ndarray parent_arr
- */
-
-struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind {
-  __pyx_t_5numpy_intp_t (*fast_find)(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *, __pyx_t_5numpy_intp_t);
-  void (*__pyx_union)(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
-};
-static struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *__pyx_vtabptr_5druhg_11_druhg_tree_UnionFind;
-
-
-/* "druhg/_druhg_tree.pyx":140
- *         return
  * 
  * cdef class UniversalReciprocity (object):             # <<<<<<<<<<<<<<
  *     """Constructs DRUHG spanning tree and marks parents of clusters
  * 
  */
 
 struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity {
   PyObject *(*get_tree)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, int __pyx_skip_dispatch);
-  PyObject *(*get_extras)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, int __pyx_skip_dispatch);
-  void (*result_add_edge_debug)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, struct __pyx_t_5druhg_11_druhg_tree_Relation *);
-  void (*result_add_edge)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_double_t);
+  PyObject *(*get_buffers)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, int __pyx_skip_dispatch);
+  void (*result_write)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_double_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t);
   int (*_pure_reciprocity)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *, __pyx_t_5numpy_intp_t *);
-  int (*_evaluate_reciprocity_slow)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *);
-  int (*_evaluate_reciprocity_fast)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *);
-  PyObject *(*_compute_tree_edges)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, PyObject *);
+  int (*_evaluate_reciprocity)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *);
+  PyObject *(*_compute_tree_edges)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *);
 };
 static struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_vtabptr_5druhg_11_druhg_tree_UniversalReciprocity;
 /* #### Code section: utility_code_proto ### */
 
 /* --- Runtime support code (head) --- */
 /* Refnanny.proto */
 #ifndef CYTHON_REFNANNY
@@ -1881,27 +1889,27 @@
 #define __Pyx_ArgsSlice_VARARGS(args, start, stop) __Pyx_PyTuple_FromArray(&__Pyx_Arg_VARARGS(args, start), stop - start)
 #define __Pyx_ArgsSlice_FASTCALL(args, start, stop) __Pyx_PyTuple_FromArray(&__Pyx_Arg_FASTCALL(args, start), stop - start)
 #else
 #define __Pyx_ArgsSlice_VARARGS(args, start, stop) PyTuple_GetSlice(args, start, stop)
 #define __Pyx_ArgsSlice_FASTCALL(args, start, stop) PyTuple_GetSlice(args, start, stop)
 #endif
 
-/* RaiseArgTupleInvalid.proto */
-static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
-    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
-
 /* RaiseDoubleKeywords.proto */
 static void __Pyx_RaiseDoubleKeywordsError(const char* func_name, PyObject* kw_name);
 
 /* ParseKeywords.proto */
 static int __Pyx_ParseOptionalKeywords(PyObject *kwds, PyObject *const *kwvalues,
     PyObject **argnames[],
     PyObject *kwds2, PyObject *values[], Py_ssize_t num_pos_args,
     const char* function_name);
 
+/* RaiseArgTupleInvalid.proto */
+static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
+    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
+
 /* PyDictVersioning.proto */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
 #define __PYX_DICT_VERSION_INIT  ((PY_UINT64_T) -1)
 #define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
 #define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
     (version_var) = __PYX_GET_DICT_VERSION(dict);\
     (cache_var) = (value);
@@ -1920,14 +1928,42 @@
 static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version);
 #else
 #define __PYX_GET_DICT_VERSION(dict)  (0)
 #define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)
 #define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP)  (VAR) = (LOOKUP);
 #endif
 
+/* GetModuleGlobalName.proto */
+#if CYTHON_USE_DICT_VERSIONS
+#define __Pyx_GetModuleGlobalName(var, name)  {\
+    static PY_UINT64_T __pyx_dict_version = 0;\
+    static PyObject *__pyx_dict_cached_value = NULL;\
+    (var) = (likely(__pyx_dict_version == __PYX_GET_DICT_VERSION(__pyx_d))) ?\
+        (likely(__pyx_dict_cached_value) ? __Pyx_NewRef(__pyx_dict_cached_value) : __Pyx_GetBuiltinName(name)) :\
+        __Pyx__GetModuleGlobalName(name, &__pyx_dict_version, &__pyx_dict_cached_value);\
+}
+#define __Pyx_GetModuleGlobalNameUncached(var, name)  {\
+    PY_UINT64_T __pyx_dict_version;\
+    PyObject *__pyx_dict_cached_value;\
+    (var) = __Pyx__GetModuleGlobalName(name, &__pyx_dict_version, &__pyx_dict_cached_value);\
+}
+static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value);
+#else
+#define __Pyx_GetModuleGlobalName(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
+#define __Pyx_GetModuleGlobalNameUncached(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
+static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name);
+#endif
+
+/* PyObjectCall.proto */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
+#else
+#define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
+#endif
+
 /* PyFunctionFastCall.proto */
 #if CYTHON_FAST_PYCALL
 #if !CYTHON_VECTORCALL
 #define __Pyx_PyFunction_FastCall(func, args, nargs)\
     __Pyx_PyFunction_FastCallDict((func), (args), (nargs), NULL)
 static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs);
 #endif
@@ -1943,54 +1979,26 @@
     ((void)__Pyx_BUILD_ASSERT_EXPR(sizeof(PyFrameObject) == offsetof(PyFrameObject, f_localsplus) + Py_MEMBER_SIZE(PyFrameObject, f_localsplus)),\
      (void)(__pyx_pyframe_localsplus_offset = ((size_t)PyFrame_Type.tp_basicsize) - Py_MEMBER_SIZE(PyFrameObject, f_localsplus)))
   #define __Pyx_PyFrame_GetLocalsplus(frame)\
     (assert(__pyx_pyframe_localsplus_offset), (PyObject **)(((char *)(frame)) + __pyx_pyframe_localsplus_offset))
 #endif // !CYTHON_VECTORCALL
 #endif
 
-/* PyObjectCall.proto */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
-#else
-#define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
-#endif
-
 /* PyObjectCallMethO.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg);
 #endif
 
 /* PyObjectFastCall.proto */
 #define __Pyx_PyObject_FastCall(func, args, nargs)  __Pyx_PyObject_FastCallDict(func, args, (size_t)(nargs), NULL)
 static CYTHON_INLINE PyObject* __Pyx_PyObject_FastCallDict(PyObject *func, PyObject **args, size_t nargs, PyObject *kwargs);
 
 /* RaiseUnexpectedTypeError.proto */
 static int __Pyx_RaiseUnexpectedTypeError(const char *expected, PyObject *obj);
 
-/* GetModuleGlobalName.proto */
-#if CYTHON_USE_DICT_VERSIONS
-#define __Pyx_GetModuleGlobalName(var, name)  {\
-    static PY_UINT64_T __pyx_dict_version = 0;\
-    static PyObject *__pyx_dict_cached_value = NULL;\
-    (var) = (likely(__pyx_dict_version == __PYX_GET_DICT_VERSION(__pyx_d))) ?\
-        (likely(__pyx_dict_cached_value) ? __Pyx_NewRef(__pyx_dict_cached_value) : __Pyx_GetBuiltinName(name)) :\
-        __Pyx__GetModuleGlobalName(name, &__pyx_dict_version, &__pyx_dict_cached_value);\
-}
-#define __Pyx_GetModuleGlobalNameUncached(var, name)  {\
-    PY_UINT64_T __pyx_dict_version;\
-    PyObject *__pyx_dict_cached_value;\
-    (var) = __Pyx__GetModuleGlobalName(name, &__pyx_dict_version, &__pyx_dict_cached_value);\
-}
-static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value);
-#else
-#define __Pyx_GetModuleGlobalName(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
-#define __Pyx_GetModuleGlobalNameUncached(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
-static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name);
-#endif
-
 /* PyIntBinop.proto */
 #if !CYTHON_COMPILING_IN_PYPY
 static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check);
 #else
 #define __Pyx_PyInt_AddObjC(op1, op2, intval, inplace, zerodivision_check)\
     (inplace ? PyNumber_InPlaceAdd(op1, op2) : PyNumber_Add(op1, op2))
 #endif
@@ -2074,17 +2082,14 @@
 
 /* KeywordStringCheck.proto */
 static int __Pyx_CheckKeywordStrings(PyObject *kw, const char* function_name, int kw_allowed);
 
 /* GetAttr3.proto */
 static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *, PyObject *, PyObject *);
 
-/* RaiseException.proto */
-static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
-
 /* dict_getitem_default.proto */
 static PyObject* __Pyx_PyDict_GetItemDefault(PyObject* d, PyObject* key, PyObject* default_value);
 
 /* UnpackUnboundCMethod.proto */
 typedef struct {
     PyObject *type;
     PyObject **method_name;
@@ -2178,14 +2183,17 @@
     );
 #else
 #define __Pyx_PyUnicode_ConcatInPlace __Pyx_PyUnicode_Concat
 #endif
 #define __Pyx_PyUnicode_ConcatInPlaceSafe(left, right) ((unlikely((left) == Py_None) || unlikely((right) == Py_None)) ?\
     PyNumber_InPlaceAdd(left, right) : __Pyx_PyUnicode_ConcatInPlace(left, right))
 
+/* RaiseException.proto */
+static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
+
 /* SliceObject.proto */
 static CYTHON_INLINE PyObject* __Pyx_PyObject_GetSlice(
         PyObject* obj, Py_ssize_t cstart, Py_ssize_t cstop,
         PyObject** py_start, PyObject** py_stop, PyObject** py_slice,
         int has_cstart, int has_cstop, int wraparound);
 
 /* WriteUnraisableException.proto */
@@ -2237,14 +2245,17 @@
     }
     return PyList_Append(list, x);
 }
 #else
 #define __Pyx_ListComp_Append(L,x) PyList_Append(L,x)
 #endif
 
+/* PyIntCompare.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_NeObjC(PyObject *op1, PyObject *op2, long intval, long inplace);
+
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* ImportFrom.proto */
 static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name);
 
 /* GetAttr.proto */
@@ -2743,24 +2754,20 @@
 #else
 static int __Pyx_InitStrings(__Pyx_StringTabEntry *t);
 #endif
 
 /* #### Code section: module_declarations ### */
 static PyObject *__pyx_f_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_query(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_d, PyObject *__pyx_v_k, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_query *__pyx_optional_args); /* proto*/
 static PyObject *__pyx_f_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_d, PyObject *__pyx_v_k, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query *__pyx_optional_args); /* proto*/
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_11_druhg_tree_9UnionFind_fast_find(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n); /* proto*/
-static void __pyx_f_5druhg_11_druhg_tree_9UnionFind_union(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_aa, __pyx_t_5numpy_intp_t __pyx_v_bb); /* proto*/
 static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_tree(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, int __pyx_skip_dispatch); /* proto*/
-static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_extras(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, int __pyx_skip_dispatch); /* proto*/
-static void __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_add_edge_debug(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_a, __pyx_t_5numpy_intp_t __pyx_v_b, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel); /* proto*/
-static void __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_add_edge(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_a, __pyx_t_5numpy_intp_t __pyx_v_b, __pyx_t_5numpy_double_t __pyx_v_v); /* proto*/
+static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_buffers(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, int __pyx_skip_dispatch); /* proto*/
+static void __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_write(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_double_t __pyx_v_v, __pyx_t_5numpy_intp_t __pyx_v_a, __pyx_t_5numpy_intp_t __pyx_v_b, __pyx_t_5numpy_intp_t __pyx_v_r); /* proto*/
 static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__pure_reciprocity(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel, __pyx_t_5numpy_intp_t *__pyx_v_infinitesimal); /* proto*/
-static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity_slow(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel); /* proto*/
-static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity_fast(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel); /* proto*/
-static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__compute_tree_edges(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_is_slow); /* proto*/
+static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel); /* proto*/
+static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__compute_tree_edges(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto*/
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_7ndarray_4base_base(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE PyArray_Descr *__pyx_f_5numpy_7ndarray_5descr_descr(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE int __pyx_f_5numpy_7ndarray_4ndim_ndim(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp *__pyx_f_5numpy_7ndarray_5shape_shape(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp *__pyx_f_5numpy_7ndarray_7strides_strides(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE npy_intp __pyx_f_5numpy_7ndarray_4size_size(PyArrayObject *__pyx_v_self); /* proto*/
 static CYTHON_INLINE char *__pyx_f_5numpy_7ndarray_4data_data(PyArrayObject *__pyx_v_self); /* proto*/
@@ -2813,23 +2820,27 @@
 static PyTypeObject *__pyx_ptype_5numpy_floating = 0;
 static PyTypeObject *__pyx_ptype_5numpy_complexfloating = 0;
 static PyTypeObject *__pyx_ptype_5numpy_flexible = 0;
 static PyTypeObject *__pyx_ptype_5numpy_character = 0;
 static PyTypeObject *__pyx_ptype_5numpy_ufunc = 0;
 #endif
 
+/* Module declarations from "druhg._druhg_unionfind" */
+#if !CYTHON_USE_MODULE_STATE
+static PyTypeObject *__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = 0;
+#endif
+
 /* Module declarations from "libc.math" */
 #if !CYTHON_USE_MODULE_STATE
 #endif
 
 /* Module declarations from "druhg._druhg_tree" */
 #if !CYTHON_USE_MODULE_STATE
 static PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse = 0;
 static PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric = 0;
-static PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_UnionFind = 0;
 static PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity = 0;
 static PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges = 0;
 static PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr = 0;
 #endif
 static __pyx_t_5numpy_double_t __pyx_v_5druhg_11_druhg_tree_INF;
 static PyObject *__pyx_f_5druhg_11_druhg_tree___pyx_unpickle_PairwiseDistanceTreeSparse__set_state(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *, PyObject *); /*proto*/
 static PyObject *__pyx_f_5druhg_11_druhg_tree___pyx_unpickle_PairwiseDistanceTreeGeneric__set_state(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *, PyObject *); /*proto*/
@@ -2841,27 +2852,26 @@
 #define __Pyx_MODULE_NAME "druhg._druhg_tree"
 extern int __pyx_module_is_main_druhg___druhg_tree;
 int __pyx_module_is_main_druhg___druhg_tree = 0;
 
 /* Implementation of "druhg._druhg_tree" */
 /* #### Code section: global_var ### */
 static PyObject *__pyx_builtin_print;
-static PyObject *__pyx_builtin_TypeError;
 static PyObject *__pyx_builtin_ValueError;
 static PyObject *__pyx_builtin_range;
 static PyObject *__pyx_builtin_ImportError;
 /* #### Code section: string_decls ### */
 static const char __pyx_k_N[] = "N";
 static const char __pyx_k_d[] = "d";
 static const char __pyx_k_k[] = "k";
 static const char __pyx_k__2[] = ".";
 static const char __pyx_k__5[] = "*";
 static const char __pyx_k_gc[] = "gc";
 static const char __pyx_k_np[] = "np";
-static const char __pyx_k__27[] = "?";
+static const char __pyx_k__29[] = "?";
 static const char __pyx_k_get[] = "get";
 static const char __pyx_k_max[] = "max";
 static const char __pyx_k_new[] = "__new__";
 static const char __pyx_k_sys[] = "sys";
 static const char __pyx_k_args[] = "args";
 static const char __pyx_k_data[] = "data";
 static const char __pyx_k_dict[] = "__dict__";
@@ -2875,289 +2885,328 @@
 static const char __pyx_k_test[] = "__test__";
 static const char __pyx_k_tree[] = "tree";
 static const char __pyx_k_close[] = "close";
 static const char __pyx_k_dtype[] = "dtype";
 static const char __pyx_k_empty[] = "empty";
 static const char __pyx_k_heapq[] = "heapq";
 static const char __pyx_k_items[] = "items";
+static const char __pyx_k_merge[] = "merge";
 static const char __pyx_k_numpy[] = "numpy";
 static const char __pyx_k_print[] = "print";
 static const char __pyx_k_query[] = "query";
 static const char __pyx_k_range[] = "range";
 static const char __pyx_k_shape[] = "shape";
 static const char __pyx_k_state[] = "state";
 static const char __pyx_k_throw[] = "throw";
 static const char __pyx_k_zeros[] = "zeros";
 static const char __pyx_k_KDTree[] = "KDTree";
 static const char __pyx_k_astype[] = "astype";
 static const char __pyx_k_bisect[] = "bisect";
 static const char __pyx_k_dict_2[] = "_dict";
+static const char __pyx_k_double[] = "double";
 static const char __pyx_k_enable[] = "enable";
 static const char __pyx_k_getrow[] = "getrow";
 static const char __pyx_k_import[] = "__import__";
 static const char __pyx_k_joblib[] = "joblib";
 static const char __pyx_k_metric[] = "metric";
 static const char __pyx_k_n_jobs[] = "n_jobs";
 static const char __pyx_k_pickle[] = "pickle";
 static const char __pyx_k_reduce[] = "__reduce__";
 static const char __pyx_k_update[] = "update";
 static const char __pyx_k_vstack[] = "vstack";
 static const char __pyx_k_argsort[] = "argsort";
 static const char __pyx_k_asarray[] = "asarray";
+static const char __pyx_k_cyheapq[] = "_cyheapq";
 static const char __pyx_k_delayed[] = "delayed";
 static const char __pyx_k_disable[] = "disable";
 static const char __pyx_k_genexpr[] = "genexpr";
 static const char __pyx_k_heappop[] = "heappop";
 static const char __pyx_k_heapq_2[] = "_heapq";
 static const char __pyx_k_indices[] = "indices";
-static const char __pyx_k_is_slow[] = "is_slow";
 static const char __pyx_k_BallTree[] = "BallTree";
 static const char __pyx_k_Parallel[] = "Parallel";
 static const char __pyx_k_dualtree[] = "dualtree";
+static const char __pyx_k_endpoint[] = "endpoint";
 static const char __pyx_k_get_tree[] = "get_tree";
 static const char __pyx_k_getstate[] = "__getstate__";
 static const char __pyx_k_heappush[] = "heappush";
+static const char __pyx_k_max_rank[] = "max_rank";
 static const char __pyx_k_pyx_type[] = "__pyx_type";
 static const char __pyx_k_setstate[] = "__setstate__";
-static const char __pyx_k_TypeError[] = "TypeError";
 static const char __pyx_k_UnionFind[] = "UnionFind";
 static const char __pyx_k_algorithm[] = "algorithm";
+static const char __pyx_k_buffer_uf[] = "buffer_uf";
 static const char __pyx_k_euclidean[] = "euclidean";
 static const char __pyx_k_isenabled[] = "isenabled";
 static const char __pyx_k_leaf_size[] = "leaf_size";
 static const char __pyx_k_parameter[] = ") parameter.";
 static const char __pyx_k_pyx_state[] = "__pyx_state";
 static const char __pyx_k_reduce_ex[] = "__reduce_ex__";
 static const char __pyx_k_ValueError[] = "ValueError";
 static const char __pyx_k_float_info[] = "float_info";
-static const char __pyx_k_get_extras[] = "get_extras";
+static const char __pyx_k_num_points[] = "num_points";
 static const char __pyx_k_pyx_result[] = "__pyx_result";
 static const char __pyx_k_pyx_vtable[] = "__pyx_vtable__";
+static const char __pyx_k_skip_first[] = "skip_first";
 static const char __pyx_k_ImportError[] = "ImportError";
 static const char __pyx_k_PickleError[] = "PickleError";
+static const char __pyx_k_buffer_fast[] = "buffer_fast";
+static const char __pyx_k_get_buffers[] = "get_buffers";
+static const char __pyx_k_heapq_merge[] = "heapq_merge";
+static const char __pyx_k_reciprocity[] = "reciprocity";
+static const char __pyx_k_buffer_ranks[] = "buffer_ranks";
 static const char __pyx_k_initializing[] = "_initializing";
 static const char __pyx_k_is_coroutine[] = "_is_coroutine";
 static const char __pyx_k_is_not_valid[] = " is not valid";
 static const char __pyx_k_pyx_checksum[] = "__pyx_checksum";
 static const char __pyx_k_stringsource[] = "<stringsource>";
 static const char __pyx_k_use_setstate[] = "use_setstate";
 static const char __pyx_k_breadth_first[] = "breadth_first";
+static const char __pyx_k_buffer_values[] = "buffer_values";
 static const char __pyx_k_class_getitem[] = "__class_getitem__";
 static const char __pyx_k_reduce_cython[] = "__reduce_cython__";
 static const char __pyx_k_Some_distances[] = "Some distances(";
 static const char __pyx_k_A_lot_of_values[] = "A lot of values(";
 static const char __pyx_k_algorithm_value[] = "algorithm value ";
+static const char __pyx_k_druhg_unionfind[] = "_druhg_unionfind";
 static const char __pyx_k_pyx_PickleError[] = "__pyx_PickleError";
 static const char __pyx_k_setstate_cython[] = "__setstate_cython__";
+static const char __pyx_k_buffer_edgepairs[] = "buffer_edgepairs";
 static const char __pyx_k_double_precision[] = "double_precision";
 static const char __pyx_k_Two_subjects_only[] = "Two subjects only";
 static const char __pyx_k_druhg__druhg_tree[] = "druhg._druhg_tree";
 static const char __pyx_k_sklearn_neighbors[] = "sklearn.neighbors";
 static const char __pyx_k_asyncio_coroutines[] = "asyncio.coroutines";
 static const char __pyx_k_cline_in_traceback[] = "cline_in_traceback";
-static const char __pyx_k_result_extras1_arr[] = "result_extras1_arr";
-static const char __pyx_k_result_extras2_arr[] = "result_extras2_arr";
 static const char __pyx_k_for_a_better_result[] = " for a better result.";
 static const char __pyx_k_UniversalReciprocity[] = "UniversalReciprocity";
 static const char __pyx_k_max_neighbors_search[] = "max_neighbors_search";
+static const char __pyx_k_allocate_buffer_ranks[] = "allocate_buffer_ranks";
 static const char __pyx_k_druhg__druhg_tree_pyx[] = "druhg\\_druhg_tree.pyx";
-static const char __pyx_k_UnionFind___reduce_cython[] = "UnionFind.__reduce_cython__";
+static const char __pyx_k_allocate_buffer_values[] = "allocate_buffer_values";
+static const char __pyx_k_not_connected_edges_of[] = " not connected edges of";
+static const char __pyx_k_allocate_buffer_edgepairs[] = "allocate_buffer_edgepairs";
 static const char __pyx_k_PairwiseDistanceTreeSparse[] = "PairwiseDistanceTreeSparse";
 static const char __pyx_k_PairwiseDistanceTreeGeneric[] = "PairwiseDistanceTreeGeneric";
-static const char __pyx_k_UnionFind___setstate_cython[] = "UnionFind.__setstate_cython__";
 static const char __pyx_k_UniversalReciprocity_get_tree[] = "UniversalReciprocity.get_tree";
 static const char __pyx_k_pyx_unpickle_PairwiseDistanceT[] = "__pyx_unpickle_PairwiseDistanceTreeSparse";
 static const char __pyx_k_pyx_unpickle_UniversalReciproc[] = "__pyx_unpickle_UniversalReciprocity";
+static const char __pyx_k_ERROR_ranks_buffer_is_too_small[] = "ERROR: ranks buffer is too small";
+static const char __pyx_k_It_is_a_forest_Try_increasing_m[] = ". It is a forest. Try increasing max_neighbors(max_ranking) value ";
 static const char __pyx_k_UniversalReciprocity___setstate[] = "UniversalReciprocity.__setstate_cython__";
-static const char __pyx_k_UniversalReciprocity_get_extras[] = "UniversalReciprocity.get_extras";
 static const char __pyx_k_are_smaller_than_self_PRECISION[] = ") are smaller than self.PRECISION (";
 static const char __pyx_k_are_the_same_Try_increasing_max[] = ") are the same. Try increasing max_neighbors_search(";
+static const char __pyx_k_edges_with_the_max_rank_Try_inc[] = " edges with the max rank. Try increasing max_neighbors(max_ranking) value ";
 static const char __pyx_k_level_Try_decreasing_double_pre[] = ") level. Try decreasing double_precision parameter.";
-static const char __pyx_k_not_connected_edges_It_is_a_for[] = " not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value ";
 static const char __pyx_k_numpy_core_multiarray_failed_to[] = "numpy.core.multiarray failed to import";
-static const char __pyx_k_self_parent_cannot_be_converted[] = "self.parent cannot be converted to a Python object for pickling";
 static const char __pyx_k_Attention_Sparse_matrix_has_an_e[] = "Attention!: Sparse matrix has an edge that forms a loop! They were zeroed.";
 static const char __pyx_k_Distances_cannot_be_negative_Exi[] = "Distances cannot be negative! Exiting. ";
+static const char __pyx_k_ERROR_edgepairs_buffer_is_too_sm[] = "ERROR: edgepairs buffer is too small";
+static const char __pyx_k_ERROR_values_buffer_is_too_small[] = "ERROR: values buffer is too small";
 static const char __pyx_k_Incompatible_checksums_s_vs_0x14[] = "Incompatible checksums (%s vs 0x147f899 = (data_arr, data_size))";
-static const char __pyx_k_Incompatible_checksums_s_vs_0xdf[] = "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))";
+static const char __pyx_k_Incompatible_checksums_s_vs_0xc3[] = "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))";
 static const char __pyx_k_PairwiseDistanceTreeGeneric___re[] = "PairwiseDistanceTreeGeneric.__reduce_cython__";
 static const char __pyx_k_PairwiseDistanceTreeGeneric___se[] = "PairwiseDistanceTreeGeneric.__setstate_cython__";
 static const char __pyx_k_PairwiseDistanceTreeGeneric_quer[] = "PairwiseDistanceTreeGeneric.query";
 static const char __pyx_k_PairwiseDistanceTreeSparse___red[] = "PairwiseDistanceTreeSparse.__reduce_cython__";
 static const char __pyx_k_PairwiseDistanceTreeSparse___set[] = "PairwiseDistanceTreeSparse.__setstate_cython__";
 static const char __pyx_k_PairwiseDistanceTreeSparse_query[] = "PairwiseDistanceTreeSparse.query";
 static const char __pyx_k_UniversalReciprocity___reduce_cy[] = "UniversalReciprocity.__reduce_cython__";
 static const char __pyx_k_UniversalReciprocity__compute_tr[] = "UniversalReciprocity._compute_tree_edges.<locals>.genexpr";
+static const char __pyx_k_UniversalReciprocity_get_buffers[] = "UniversalReciprocity.get_buffers";
 static const char __pyx_k_numpy_core_umath_failed_to_impor[] = "numpy.core.umath failed to import";
+static const char __pyx_k_or_pick_the_square_mode_not_avai[] = "or pick the square mode (not available).";
 static const char __pyx_k_pyx_unpickle_PairwiseDistanceT_2[] = "__pyx_unpickle_PairwiseDistanceTreeGeneric";
 #if !CYTHON_USE_MODULE_STATE
 static PyObject *__pyx_kp_u_A_lot_of_values;
 static PyObject *__pyx_kp_u_Attention_Sparse_matrix_has_an_e;
 static PyObject *__pyx_n_s_BallTree;
 static PyObject *__pyx_kp_u_Distances_cannot_be_negative_Exi;
+static PyObject *__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm;
+static PyObject *__pyx_kp_u_ERROR_ranks_buffer_is_too_small;
+static PyObject *__pyx_kp_u_ERROR_values_buffer_is_too_small;
 static PyObject *__pyx_n_s_ImportError;
 static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0x14;
-static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xdf;
+static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xc3;
+static PyObject *__pyx_kp_u_It_is_a_forest_Try_increasing_m;
 static PyObject *__pyx_n_s_KDTree;
 static PyObject *__pyx_n_s_N;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric___re;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric___se;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric_quer;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeSparse;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeSparse___red;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeSparse___set;
 static PyObject *__pyx_n_s_PairwiseDistanceTreeSparse_query;
 static PyObject *__pyx_n_s_Parallel;
 static PyObject *__pyx_n_s_PickleError;
 static PyObject *__pyx_kp_u_Some_distances;
 static PyObject *__pyx_kp_u_Two_subjects_only;
-static PyObject *__pyx_n_s_TypeError;
 static PyObject *__pyx_n_s_UnionFind;
-static PyObject *__pyx_n_s_UnionFind___reduce_cython;
-static PyObject *__pyx_n_s_UnionFind___setstate_cython;
 static PyObject *__pyx_n_s_UniversalReciprocity;
 static PyObject *__pyx_n_s_UniversalReciprocity___reduce_cy;
 static PyObject *__pyx_n_s_UniversalReciprocity___setstate;
 static PyObject *__pyx_n_s_UniversalReciprocity__compute_tr;
-static PyObject *__pyx_n_s_UniversalReciprocity_get_extras;
+static PyObject *__pyx_n_s_UniversalReciprocity_get_buffers;
 static PyObject *__pyx_n_s_UniversalReciprocity_get_tree;
 static PyObject *__pyx_n_s_ValueError;
 static PyObject *__pyx_kp_u__2;
-static PyObject *__pyx_n_s__27;
+static PyObject *__pyx_n_s__29;
 static PyObject *__pyx_n_s__5;
 static PyObject *__pyx_n_s_algorithm;
 static PyObject *__pyx_kp_u_algorithm_value;
+static PyObject *__pyx_n_s_allocate_buffer_edgepairs;
+static PyObject *__pyx_n_s_allocate_buffer_ranks;
+static PyObject *__pyx_n_s_allocate_buffer_values;
 static PyObject *__pyx_kp_u_are_smaller_than_self_PRECISION;
 static PyObject *__pyx_kp_u_are_the_same_Try_increasing_max;
 static PyObject *__pyx_n_s_args;
 static PyObject *__pyx_n_s_argsort;
 static PyObject *__pyx_n_s_asarray;
 static PyObject *__pyx_n_s_astype;
 static PyObject *__pyx_n_s_asyncio_coroutines;
 static PyObject *__pyx_n_s_bisect;
 static PyObject *__pyx_n_s_breadth_first;
+static PyObject *__pyx_n_s_buffer_edgepairs;
+static PyObject *__pyx_n_s_buffer_fast;
+static PyObject *__pyx_n_s_buffer_ranks;
+static PyObject *__pyx_n_s_buffer_uf;
+static PyObject *__pyx_n_s_buffer_values;
 static PyObject *__pyx_n_s_class_getitem;
 static PyObject *__pyx_n_s_cline_in_traceback;
 static PyObject *__pyx_n_s_close;
+static PyObject *__pyx_n_s_cyheapq;
 static PyObject *__pyx_n_s_d;
 static PyObject *__pyx_n_s_data;
 static PyObject *__pyx_n_s_delayed;
 static PyObject *__pyx_n_s_dict;
 static PyObject *__pyx_n_s_dict_2;
 static PyObject *__pyx_kp_u_disable;
+static PyObject *__pyx_n_s_double;
 static PyObject *__pyx_n_u_double_precision;
 static PyObject *__pyx_n_s_druhg__druhg_tree;
 static PyObject *__pyx_kp_s_druhg__druhg_tree_pyx;
+static PyObject *__pyx_n_s_druhg_unionfind;
 static PyObject *__pyx_n_s_dtype;
 static PyObject *__pyx_n_s_dualtree;
+static PyObject *__pyx_kp_u_edges_with_the_max_rank_Try_inc;
 static PyObject *__pyx_n_s_empty;
 static PyObject *__pyx_kp_u_enable;
+static PyObject *__pyx_n_s_endpoint;
 static PyObject *__pyx_n_u_euclidean;
 static PyObject *__pyx_n_s_float_info;
 static PyObject *__pyx_kp_u_for_a_better_result;
 static PyObject *__pyx_kp_u_gc;
 static PyObject *__pyx_n_s_genexpr;
 static PyObject *__pyx_n_s_get;
-static PyObject *__pyx_n_s_get_extras;
+static PyObject *__pyx_n_s_get_buffers;
 static PyObject *__pyx_n_s_get_tree;
 static PyObject *__pyx_n_s_getrow;
 static PyObject *__pyx_n_s_getstate;
 static PyObject *__pyx_n_s_heappop;
 static PyObject *__pyx_n_s_heappush;
 static PyObject *__pyx_n_s_heapq;
 static PyObject *__pyx_n_s_heapq_2;
+static PyObject *__pyx_n_s_heapq_merge;
 static PyObject *__pyx_n_s_import;
 static PyObject *__pyx_n_s_indices;
 static PyObject *__pyx_n_s_initializing;
 static PyObject *__pyx_n_s_intp;
 static PyObject *__pyx_n_s_is_coroutine;
 static PyObject *__pyx_kp_u_is_not_valid;
-static PyObject *__pyx_n_s_is_slow;
 static PyObject *__pyx_kp_u_isenabled;
 static PyObject *__pyx_n_s_items;
 static PyObject *__pyx_n_s_joblib;
 static PyObject *__pyx_n_s_k;
 static PyObject *__pyx_n_s_leaf_size;
 static PyObject *__pyx_kp_u_level_Try_decreasing_double_pre;
 static PyObject *__pyx_n_s_main;
 static PyObject *__pyx_n_s_max;
 static PyObject *__pyx_n_s_max_neighbors_search;
+static PyObject *__pyx_n_s_max_rank;
+static PyObject *__pyx_n_s_merge;
 static PyObject *__pyx_n_s_metric;
 static PyObject *__pyx_n_s_n_jobs;
 static PyObject *__pyx_n_s_name;
 static PyObject *__pyx_n_s_new;
-static PyObject *__pyx_kp_u_not_connected_edges_It_is_a_for;
+static PyObject *__pyx_kp_u_not_connected_edges_of;
 static PyObject *__pyx_n_s_np;
+static PyObject *__pyx_n_s_num_points;
 static PyObject *__pyx_n_s_numpy;
 static PyObject *__pyx_kp_s_numpy_core_multiarray_failed_to;
 static PyObject *__pyx_kp_s_numpy_core_umath_failed_to_impor;
 static PyObject *__pyx_n_s_ones;
+static PyObject *__pyx_kp_u_or_pick_the_square_mode_not_avai;
 static PyObject *__pyx_kp_u_parameter;
 static PyObject *__pyx_n_s_pickle;
 static PyObject *__pyx_n_s_print;
 static PyObject *__pyx_n_s_pyx_PickleError;
 static PyObject *__pyx_n_s_pyx_checksum;
 static PyObject *__pyx_n_s_pyx_result;
 static PyObject *__pyx_n_s_pyx_state;
 static PyObject *__pyx_n_s_pyx_type;
 static PyObject *__pyx_n_s_pyx_unpickle_PairwiseDistanceT;
 static PyObject *__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2;
 static PyObject *__pyx_n_s_pyx_unpickle_UniversalReciproc;
 static PyObject *__pyx_n_s_pyx_vtable;
 static PyObject *__pyx_n_s_query;
 static PyObject *__pyx_n_s_range;
+static PyObject *__pyx_n_s_reciprocity;
 static PyObject *__pyx_n_s_reduce;
 static PyObject *__pyx_n_s_reduce_cython;
 static PyObject *__pyx_n_s_reduce_ex;
-static PyObject *__pyx_n_s_result_extras1_arr;
-static PyObject *__pyx_n_s_result_extras2_arr;
 static PyObject *__pyx_n_s_self;
-static PyObject *__pyx_kp_s_self_parent_cannot_be_converted;
 static PyObject *__pyx_n_s_send;
 static PyObject *__pyx_n_s_setstate;
 static PyObject *__pyx_n_s_setstate_cython;
 static PyObject *__pyx_n_s_shape;
+static PyObject *__pyx_n_s_skip_first;
 static PyObject *__pyx_n_s_sklearn_neighbors;
 static PyObject *__pyx_n_s_spec;
 static PyObject *__pyx_n_s_state;
 static PyObject *__pyx_kp_s_stringsource;
 static PyObject *__pyx_n_s_sys;
 static PyObject *__pyx_n_s_test;
 static PyObject *__pyx_n_s_throw;
 static PyObject *__pyx_n_s_tree;
 static PyObject *__pyx_n_s_update;
 static PyObject *__pyx_n_s_use_setstate;
 static PyObject *__pyx_n_s_vstack;
 static PyObject *__pyx_n_s_zeros;
 #endif
 /* #### Code section: decls ### */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_allocate_buffer_values(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_num_points); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_2allocate_buffer_edgepairs(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_num_points); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_4allocate_buffer_ranks(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_num_points); /* proto */
 static int __pyx_pf_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse___init__(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_v_self, PyObject *__pyx_v_N, PyObject *__pyx_v_d); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_2query(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_v_self, PyObject *__pyx_v_d, PyObject *__pyx_v_k, PyObject *__pyx_v_dualtree, PyObject *__pyx_v_breadth_first); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_4__reduce_cython__(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_6__setstate_cython__(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
 static int __pyx_pf_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric___init__(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_v_self, PyObject *__pyx_v_N, PyObject *__pyx_v_d); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_2query(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_v_self, PyObject *__pyx_v_d, PyObject *__pyx_v_k, PyObject *__pyx_v_dualtree, PyObject *__pyx_v_breadth_first); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_4__reduce_cython__(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_6__setstate_cython__(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
-static int __pyx_pf_5druhg_11_druhg_tree_9UnionFind___init__(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_N); /* proto */
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_9UnionFind_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_9UnionFind_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
-static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity___init__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_algorithm, PyObject *__pyx_v_tree, PyObject *__pyx_v_max_neighbors_search, PyObject *__pyx_v_metric, PyObject *__pyx_v_leaf_size, PyObject *__pyx_v_n_jobs, PyObject *__pyx_v_is_slow, PyObject *__pyx_v_kwargs); /* proto */
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity___init__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_algorithm, PyObject *__pyx_v_tree, PyObject *__pyx_v_buffer_uf, PyObject *__pyx_v_buffer_fast, PyObject *__pyx_v_buffer_values, PyObject *__pyx_v_max_neighbors_search, PyObject *__pyx_v_metric, PyObject *__pyx_v_leaf_size, PyObject *__pyx_v_n_jobs, PyObject *__pyx_v_buffer_ranks, PyObject *__pyx_v_buffer_edgepairs, PyObject *__pyx_v_kwargs); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_2get_tree(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_4get_extras(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_4get_buffers(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_genexpr(PyObject *__pyx_self); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d___get__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_2__set__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_value); /* proto */
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_4__del__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i___get__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_2__set__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_value); /* proto */
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_4__del__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_6__reduce_cython__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_8__setstate_cython__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_5druhg_11_druhg_tree___pyx_unpickle_PairwiseDistanceTreeSparse(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_2__pyx_unpickle_PairwiseDistanceTreeGeneric(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_4__pyx_unpickle_UniversalReciprocity(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_6__pyx_unpickle_PairwiseDistanceTreeSparse(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_8__pyx_unpickle_PairwiseDistanceTreeGeneric(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_10__pyx_unpickle_UniversalReciprocity(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
 static PyObject *__pyx_tp_new_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
-static PyObject *__pyx_tp_new_5druhg_11_druhg_tree_UnionFind(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_5druhg_11_druhg_tree_UniversalReciprocity(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static __Pyx_CachedCFunction __pyx_umethod_PyDict_Type_get = {0, 0, 0, 0, 0};
 #if !CYTHON_USE_MODULE_STATE
 static PyObject *__pyx_float_0_;
 static PyObject *__pyx_float_0_0000001;
@@ -3166,42 +3215,43 @@
 static PyObject *__pyx_int_2;
 static PyObject *__pyx_int_3;
 static PyObject *__pyx_int_4;
 static PyObject *__pyx_int_16;
 static PyObject *__pyx_int_20;
 static PyObject *__pyx_int_16384;
 static PyObject *__pyx_int_21493913;
-static PyObject *__pyx_int_234627805;
-static PyObject *__pyx_int_neg_1;
+static PyObject *__pyx_int_204757032;
 #endif
 #if !CYTHON_USE_MODULE_STATE
 static PyObject *__pyx_tuple_;
 static PyObject *__pyx_tuple__3;
 static PyObject *__pyx_tuple__4;
 static PyObject *__pyx_tuple__6;
-static PyObject *__pyx_tuple__8;
-static PyObject *__pyx_tuple__9;
-static PyObject *__pyx_tuple__11;
-static PyObject *__pyx_tuple__16;
-static PyObject *__pyx_tuple__23;
+static PyObject *__pyx_tuple__10;
+static PyObject *__pyx_tuple__12;
+static PyObject *__pyx_tuple__13;
+static PyObject *__pyx_tuple__15;
+static PyObject *__pyx_tuple__20;
+static PyObject *__pyx_tuple__25;
 static PyObject *__pyx_codeobj__7;
-static PyObject *__pyx_codeobj__10;
-static PyObject *__pyx_codeobj__12;
-static PyObject *__pyx_codeobj__13;
+static PyObject *__pyx_codeobj__8;
+static PyObject *__pyx_codeobj__9;
+static PyObject *__pyx_codeobj__11;
 static PyObject *__pyx_codeobj__14;
-static PyObject *__pyx_codeobj__15;
+static PyObject *__pyx_codeobj__16;
 static PyObject *__pyx_codeobj__17;
 static PyObject *__pyx_codeobj__18;
 static PyObject *__pyx_codeobj__19;
-static PyObject *__pyx_codeobj__20;
 static PyObject *__pyx_codeobj__21;
 static PyObject *__pyx_codeobj__22;
+static PyObject *__pyx_codeobj__23;
 static PyObject *__pyx_codeobj__24;
-static PyObject *__pyx_codeobj__25;
 static PyObject *__pyx_codeobj__26;
+static PyObject *__pyx_codeobj__27;
+static PyObject *__pyx_codeobj__28;
 #endif
 /* #### Code section: late_includes ### */
 /* #### Code section: module_state ### */
 #if CYTHON_USE_MODULE_STATE
 typedef struct {
   PyObject *__pyx_d;
   PyObject *__pyx_b;
@@ -3227,153 +3277,169 @@
   PyTypeObject *__pyx_ptype_5numpy_unsignedinteger;
   PyTypeObject *__pyx_ptype_5numpy_inexact;
   PyTypeObject *__pyx_ptype_5numpy_floating;
   PyTypeObject *__pyx_ptype_5numpy_complexfloating;
   PyTypeObject *__pyx_ptype_5numpy_flexible;
   PyTypeObject *__pyx_ptype_5numpy_character;
   PyTypeObject *__pyx_ptype_5numpy_ufunc;
+  PyTypeObject *__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind;
   PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse;
   PyObject *__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse;
   PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric;
   PyObject *__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric;
-  PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_UnionFind;
-  PyObject *__pyx_type_5druhg_11_druhg_tree_UnionFind;
   PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity;
   PyObject *__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity;
   PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges;
   PyObject *__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges;
   PyTypeObject *__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr;
   PyObject *__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr;
   PyObject *__pyx_kp_u_A_lot_of_values;
   PyObject *__pyx_kp_u_Attention_Sparse_matrix_has_an_e;
   PyObject *__pyx_n_s_BallTree;
   PyObject *__pyx_kp_u_Distances_cannot_be_negative_Exi;
+  PyObject *__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm;
+  PyObject *__pyx_kp_u_ERROR_ranks_buffer_is_too_small;
+  PyObject *__pyx_kp_u_ERROR_values_buffer_is_too_small;
   PyObject *__pyx_n_s_ImportError;
   PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0x14;
-  PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xdf;
+  PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xc3;
+  PyObject *__pyx_kp_u_It_is_a_forest_Try_increasing_m;
   PyObject *__pyx_n_s_KDTree;
   PyObject *__pyx_n_s_N;
   PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric;
   PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric___re;
   PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric___se;
   PyObject *__pyx_n_s_PairwiseDistanceTreeGeneric_quer;
   PyObject *__pyx_n_s_PairwiseDistanceTreeSparse;
   PyObject *__pyx_n_s_PairwiseDistanceTreeSparse___red;
   PyObject *__pyx_n_s_PairwiseDistanceTreeSparse___set;
   PyObject *__pyx_n_s_PairwiseDistanceTreeSparse_query;
   PyObject *__pyx_n_s_Parallel;
   PyObject *__pyx_n_s_PickleError;
   PyObject *__pyx_kp_u_Some_distances;
   PyObject *__pyx_kp_u_Two_subjects_only;
-  PyObject *__pyx_n_s_TypeError;
   PyObject *__pyx_n_s_UnionFind;
-  PyObject *__pyx_n_s_UnionFind___reduce_cython;
-  PyObject *__pyx_n_s_UnionFind___setstate_cython;
   PyObject *__pyx_n_s_UniversalReciprocity;
   PyObject *__pyx_n_s_UniversalReciprocity___reduce_cy;
   PyObject *__pyx_n_s_UniversalReciprocity___setstate;
   PyObject *__pyx_n_s_UniversalReciprocity__compute_tr;
-  PyObject *__pyx_n_s_UniversalReciprocity_get_extras;
+  PyObject *__pyx_n_s_UniversalReciprocity_get_buffers;
   PyObject *__pyx_n_s_UniversalReciprocity_get_tree;
   PyObject *__pyx_n_s_ValueError;
   PyObject *__pyx_kp_u__2;
-  PyObject *__pyx_n_s__27;
+  PyObject *__pyx_n_s__29;
   PyObject *__pyx_n_s__5;
   PyObject *__pyx_n_s_algorithm;
   PyObject *__pyx_kp_u_algorithm_value;
+  PyObject *__pyx_n_s_allocate_buffer_edgepairs;
+  PyObject *__pyx_n_s_allocate_buffer_ranks;
+  PyObject *__pyx_n_s_allocate_buffer_values;
   PyObject *__pyx_kp_u_are_smaller_than_self_PRECISION;
   PyObject *__pyx_kp_u_are_the_same_Try_increasing_max;
   PyObject *__pyx_n_s_args;
   PyObject *__pyx_n_s_argsort;
   PyObject *__pyx_n_s_asarray;
   PyObject *__pyx_n_s_astype;
   PyObject *__pyx_n_s_asyncio_coroutines;
   PyObject *__pyx_n_s_bisect;
   PyObject *__pyx_n_s_breadth_first;
+  PyObject *__pyx_n_s_buffer_edgepairs;
+  PyObject *__pyx_n_s_buffer_fast;
+  PyObject *__pyx_n_s_buffer_ranks;
+  PyObject *__pyx_n_s_buffer_uf;
+  PyObject *__pyx_n_s_buffer_values;
   PyObject *__pyx_n_s_class_getitem;
   PyObject *__pyx_n_s_cline_in_traceback;
   PyObject *__pyx_n_s_close;
+  PyObject *__pyx_n_s_cyheapq;
   PyObject *__pyx_n_s_d;
   PyObject *__pyx_n_s_data;
   PyObject *__pyx_n_s_delayed;
   PyObject *__pyx_n_s_dict;
   PyObject *__pyx_n_s_dict_2;
   PyObject *__pyx_kp_u_disable;
+  PyObject *__pyx_n_s_double;
   PyObject *__pyx_n_u_double_precision;
   PyObject *__pyx_n_s_druhg__druhg_tree;
   PyObject *__pyx_kp_s_druhg__druhg_tree_pyx;
+  PyObject *__pyx_n_s_druhg_unionfind;
   PyObject *__pyx_n_s_dtype;
   PyObject *__pyx_n_s_dualtree;
+  PyObject *__pyx_kp_u_edges_with_the_max_rank_Try_inc;
   PyObject *__pyx_n_s_empty;
   PyObject *__pyx_kp_u_enable;
+  PyObject *__pyx_n_s_endpoint;
   PyObject *__pyx_n_u_euclidean;
   PyObject *__pyx_n_s_float_info;
   PyObject *__pyx_kp_u_for_a_better_result;
   PyObject *__pyx_kp_u_gc;
   PyObject *__pyx_n_s_genexpr;
   PyObject *__pyx_n_s_get;
-  PyObject *__pyx_n_s_get_extras;
+  PyObject *__pyx_n_s_get_buffers;
   PyObject *__pyx_n_s_get_tree;
   PyObject *__pyx_n_s_getrow;
   PyObject *__pyx_n_s_getstate;
   PyObject *__pyx_n_s_heappop;
   PyObject *__pyx_n_s_heappush;
   PyObject *__pyx_n_s_heapq;
   PyObject *__pyx_n_s_heapq_2;
+  PyObject *__pyx_n_s_heapq_merge;
   PyObject *__pyx_n_s_import;
   PyObject *__pyx_n_s_indices;
   PyObject *__pyx_n_s_initializing;
   PyObject *__pyx_n_s_intp;
   PyObject *__pyx_n_s_is_coroutine;
   PyObject *__pyx_kp_u_is_not_valid;
-  PyObject *__pyx_n_s_is_slow;
   PyObject *__pyx_kp_u_isenabled;
   PyObject *__pyx_n_s_items;
   PyObject *__pyx_n_s_joblib;
   PyObject *__pyx_n_s_k;
   PyObject *__pyx_n_s_leaf_size;
   PyObject *__pyx_kp_u_level_Try_decreasing_double_pre;
   PyObject *__pyx_n_s_main;
   PyObject *__pyx_n_s_max;
   PyObject *__pyx_n_s_max_neighbors_search;
+  PyObject *__pyx_n_s_max_rank;
+  PyObject *__pyx_n_s_merge;
   PyObject *__pyx_n_s_metric;
   PyObject *__pyx_n_s_n_jobs;
   PyObject *__pyx_n_s_name;
   PyObject *__pyx_n_s_new;
-  PyObject *__pyx_kp_u_not_connected_edges_It_is_a_for;
+  PyObject *__pyx_kp_u_not_connected_edges_of;
   PyObject *__pyx_n_s_np;
+  PyObject *__pyx_n_s_num_points;
   PyObject *__pyx_n_s_numpy;
   PyObject *__pyx_kp_s_numpy_core_multiarray_failed_to;
   PyObject *__pyx_kp_s_numpy_core_umath_failed_to_impor;
   PyObject *__pyx_n_s_ones;
+  PyObject *__pyx_kp_u_or_pick_the_square_mode_not_avai;
   PyObject *__pyx_kp_u_parameter;
   PyObject *__pyx_n_s_pickle;
   PyObject *__pyx_n_s_print;
   PyObject *__pyx_n_s_pyx_PickleError;
   PyObject *__pyx_n_s_pyx_checksum;
   PyObject *__pyx_n_s_pyx_result;
   PyObject *__pyx_n_s_pyx_state;
   PyObject *__pyx_n_s_pyx_type;
   PyObject *__pyx_n_s_pyx_unpickle_PairwiseDistanceT;
   PyObject *__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2;
   PyObject *__pyx_n_s_pyx_unpickle_UniversalReciproc;
   PyObject *__pyx_n_s_pyx_vtable;
   PyObject *__pyx_n_s_query;
   PyObject *__pyx_n_s_range;
+  PyObject *__pyx_n_s_reciprocity;
   PyObject *__pyx_n_s_reduce;
   PyObject *__pyx_n_s_reduce_cython;
   PyObject *__pyx_n_s_reduce_ex;
-  PyObject *__pyx_n_s_result_extras1_arr;
-  PyObject *__pyx_n_s_result_extras2_arr;
   PyObject *__pyx_n_s_self;
-  PyObject *__pyx_kp_s_self_parent_cannot_be_converted;
   PyObject *__pyx_n_s_send;
   PyObject *__pyx_n_s_setstate;
   PyObject *__pyx_n_s_setstate_cython;
   PyObject *__pyx_n_s_shape;
+  PyObject *__pyx_n_s_skip_first;
   PyObject *__pyx_n_s_sklearn_neighbors;
   PyObject *__pyx_n_s_spec;
   PyObject *__pyx_n_s_state;
   PyObject *__pyx_kp_s_stringsource;
   PyObject *__pyx_n_s_sys;
   PyObject *__pyx_n_s_test;
   PyObject *__pyx_n_s_throw;
@@ -3389,40 +3455,41 @@
   PyObject *__pyx_int_2;
   PyObject *__pyx_int_3;
   PyObject *__pyx_int_4;
   PyObject *__pyx_int_16;
   PyObject *__pyx_int_20;
   PyObject *__pyx_int_16384;
   PyObject *__pyx_int_21493913;
-  PyObject *__pyx_int_234627805;
-  PyObject *__pyx_int_neg_1;
+  PyObject *__pyx_int_204757032;
   PyObject *__pyx_tuple_;
   PyObject *__pyx_tuple__3;
   PyObject *__pyx_tuple__4;
   PyObject *__pyx_tuple__6;
-  PyObject *__pyx_tuple__8;
-  PyObject *__pyx_tuple__9;
-  PyObject *__pyx_tuple__11;
-  PyObject *__pyx_tuple__16;
-  PyObject *__pyx_tuple__23;
+  PyObject *__pyx_tuple__10;
+  PyObject *__pyx_tuple__12;
+  PyObject *__pyx_tuple__13;
+  PyObject *__pyx_tuple__15;
+  PyObject *__pyx_tuple__20;
+  PyObject *__pyx_tuple__25;
   PyObject *__pyx_codeobj__7;
-  PyObject *__pyx_codeobj__10;
-  PyObject *__pyx_codeobj__12;
-  PyObject *__pyx_codeobj__13;
+  PyObject *__pyx_codeobj__8;
+  PyObject *__pyx_codeobj__9;
+  PyObject *__pyx_codeobj__11;
   PyObject *__pyx_codeobj__14;
-  PyObject *__pyx_codeobj__15;
+  PyObject *__pyx_codeobj__16;
   PyObject *__pyx_codeobj__17;
   PyObject *__pyx_codeobj__18;
   PyObject *__pyx_codeobj__19;
-  PyObject *__pyx_codeobj__20;
   PyObject *__pyx_codeobj__21;
   PyObject *__pyx_codeobj__22;
+  PyObject *__pyx_codeobj__23;
   PyObject *__pyx_codeobj__24;
-  PyObject *__pyx_codeobj__25;
   PyObject *__pyx_codeobj__26;
+  PyObject *__pyx_codeobj__27;
+  PyObject *__pyx_codeobj__28;
 } __pyx_mstate;
 
 #ifdef __cplusplus
 namespace {
   extern struct PyModuleDef __pyx_moduledef;
 } /* anonymous namespace */
 #else
@@ -3464,153 +3531,169 @@
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_unsignedinteger);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_inexact);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_floating);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_complexfloating);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_flexible);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_character);
   Py_CLEAR(clear_module_state->__pyx_ptype_5numpy_ufunc);
+  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind);
   Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
   Py_CLEAR(clear_module_state->__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
   Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
   Py_CLEAR(clear_module_state->__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
-  Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_11_druhg_tree_UnionFind);
-  Py_CLEAR(clear_module_state->__pyx_type_5druhg_11_druhg_tree_UnionFind);
   Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity);
   Py_CLEAR(clear_module_state->__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity);
   Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges);
   Py_CLEAR(clear_module_state->__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges);
   Py_CLEAR(clear_module_state->__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr);
   Py_CLEAR(clear_module_state->__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr);
   Py_CLEAR(clear_module_state->__pyx_kp_u_A_lot_of_values);
   Py_CLEAR(clear_module_state->__pyx_kp_u_Attention_Sparse_matrix_has_an_e);
   Py_CLEAR(clear_module_state->__pyx_n_s_BallTree);
   Py_CLEAR(clear_module_state->__pyx_kp_u_Distances_cannot_be_negative_Exi);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_ranks_buffer_is_too_small);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_ERROR_values_buffer_is_too_small);
   Py_CLEAR(clear_module_state->__pyx_n_s_ImportError);
   Py_CLEAR(clear_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0x14);
-  Py_CLEAR(clear_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0xdf);
+  Py_CLEAR(clear_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0xc3);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_It_is_a_forest_Try_increasing_m);
   Py_CLEAR(clear_module_state->__pyx_n_s_KDTree);
   Py_CLEAR(clear_module_state->__pyx_n_s_N);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric___re);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric___se);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric_quer);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeSparse);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeSparse___red);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeSparse___set);
   Py_CLEAR(clear_module_state->__pyx_n_s_PairwiseDistanceTreeSparse_query);
   Py_CLEAR(clear_module_state->__pyx_n_s_Parallel);
   Py_CLEAR(clear_module_state->__pyx_n_s_PickleError);
   Py_CLEAR(clear_module_state->__pyx_kp_u_Some_distances);
   Py_CLEAR(clear_module_state->__pyx_kp_u_Two_subjects_only);
-  Py_CLEAR(clear_module_state->__pyx_n_s_TypeError);
   Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind);
-  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind___reduce_cython);
-  Py_CLEAR(clear_module_state->__pyx_n_s_UnionFind___setstate_cython);
   Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity);
   Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity___reduce_cy);
   Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity___setstate);
   Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity__compute_tr);
-  Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity_get_extras);
+  Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity_get_buffers);
   Py_CLEAR(clear_module_state->__pyx_n_s_UniversalReciprocity_get_tree);
   Py_CLEAR(clear_module_state->__pyx_n_s_ValueError);
   Py_CLEAR(clear_module_state->__pyx_kp_u__2);
-  Py_CLEAR(clear_module_state->__pyx_n_s__27);
+  Py_CLEAR(clear_module_state->__pyx_n_s__29);
   Py_CLEAR(clear_module_state->__pyx_n_s__5);
   Py_CLEAR(clear_module_state->__pyx_n_s_algorithm);
   Py_CLEAR(clear_module_state->__pyx_kp_u_algorithm_value);
+  Py_CLEAR(clear_module_state->__pyx_n_s_allocate_buffer_edgepairs);
+  Py_CLEAR(clear_module_state->__pyx_n_s_allocate_buffer_ranks);
+  Py_CLEAR(clear_module_state->__pyx_n_s_allocate_buffer_values);
   Py_CLEAR(clear_module_state->__pyx_kp_u_are_smaller_than_self_PRECISION);
   Py_CLEAR(clear_module_state->__pyx_kp_u_are_the_same_Try_increasing_max);
   Py_CLEAR(clear_module_state->__pyx_n_s_args);
   Py_CLEAR(clear_module_state->__pyx_n_s_argsort);
   Py_CLEAR(clear_module_state->__pyx_n_s_asarray);
   Py_CLEAR(clear_module_state->__pyx_n_s_astype);
   Py_CLEAR(clear_module_state->__pyx_n_s_asyncio_coroutines);
   Py_CLEAR(clear_module_state->__pyx_n_s_bisect);
   Py_CLEAR(clear_module_state->__pyx_n_s_breadth_first);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_edgepairs);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_fast);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_ranks);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_uf);
+  Py_CLEAR(clear_module_state->__pyx_n_s_buffer_values);
   Py_CLEAR(clear_module_state->__pyx_n_s_class_getitem);
   Py_CLEAR(clear_module_state->__pyx_n_s_cline_in_traceback);
   Py_CLEAR(clear_module_state->__pyx_n_s_close);
+  Py_CLEAR(clear_module_state->__pyx_n_s_cyheapq);
   Py_CLEAR(clear_module_state->__pyx_n_s_d);
   Py_CLEAR(clear_module_state->__pyx_n_s_data);
   Py_CLEAR(clear_module_state->__pyx_n_s_delayed);
   Py_CLEAR(clear_module_state->__pyx_n_s_dict);
   Py_CLEAR(clear_module_state->__pyx_n_s_dict_2);
   Py_CLEAR(clear_module_state->__pyx_kp_u_disable);
+  Py_CLEAR(clear_module_state->__pyx_n_s_double);
   Py_CLEAR(clear_module_state->__pyx_n_u_double_precision);
   Py_CLEAR(clear_module_state->__pyx_n_s_druhg__druhg_tree);
   Py_CLEAR(clear_module_state->__pyx_kp_s_druhg__druhg_tree_pyx);
+  Py_CLEAR(clear_module_state->__pyx_n_s_druhg_unionfind);
   Py_CLEAR(clear_module_state->__pyx_n_s_dtype);
   Py_CLEAR(clear_module_state->__pyx_n_s_dualtree);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_edges_with_the_max_rank_Try_inc);
   Py_CLEAR(clear_module_state->__pyx_n_s_empty);
   Py_CLEAR(clear_module_state->__pyx_kp_u_enable);
+  Py_CLEAR(clear_module_state->__pyx_n_s_endpoint);
   Py_CLEAR(clear_module_state->__pyx_n_u_euclidean);
   Py_CLEAR(clear_module_state->__pyx_n_s_float_info);
   Py_CLEAR(clear_module_state->__pyx_kp_u_for_a_better_result);
   Py_CLEAR(clear_module_state->__pyx_kp_u_gc);
   Py_CLEAR(clear_module_state->__pyx_n_s_genexpr);
   Py_CLEAR(clear_module_state->__pyx_n_s_get);
-  Py_CLEAR(clear_module_state->__pyx_n_s_get_extras);
+  Py_CLEAR(clear_module_state->__pyx_n_s_get_buffers);
   Py_CLEAR(clear_module_state->__pyx_n_s_get_tree);
   Py_CLEAR(clear_module_state->__pyx_n_s_getrow);
   Py_CLEAR(clear_module_state->__pyx_n_s_getstate);
   Py_CLEAR(clear_module_state->__pyx_n_s_heappop);
   Py_CLEAR(clear_module_state->__pyx_n_s_heappush);
   Py_CLEAR(clear_module_state->__pyx_n_s_heapq);
   Py_CLEAR(clear_module_state->__pyx_n_s_heapq_2);
+  Py_CLEAR(clear_module_state->__pyx_n_s_heapq_merge);
   Py_CLEAR(clear_module_state->__pyx_n_s_import);
   Py_CLEAR(clear_module_state->__pyx_n_s_indices);
   Py_CLEAR(clear_module_state->__pyx_n_s_initializing);
   Py_CLEAR(clear_module_state->__pyx_n_s_intp);
   Py_CLEAR(clear_module_state->__pyx_n_s_is_coroutine);
   Py_CLEAR(clear_module_state->__pyx_kp_u_is_not_valid);
-  Py_CLEAR(clear_module_state->__pyx_n_s_is_slow);
   Py_CLEAR(clear_module_state->__pyx_kp_u_isenabled);
   Py_CLEAR(clear_module_state->__pyx_n_s_items);
   Py_CLEAR(clear_module_state->__pyx_n_s_joblib);
   Py_CLEAR(clear_module_state->__pyx_n_s_k);
   Py_CLEAR(clear_module_state->__pyx_n_s_leaf_size);
   Py_CLEAR(clear_module_state->__pyx_kp_u_level_Try_decreasing_double_pre);
   Py_CLEAR(clear_module_state->__pyx_n_s_main);
   Py_CLEAR(clear_module_state->__pyx_n_s_max);
   Py_CLEAR(clear_module_state->__pyx_n_s_max_neighbors_search);
+  Py_CLEAR(clear_module_state->__pyx_n_s_max_rank);
+  Py_CLEAR(clear_module_state->__pyx_n_s_merge);
   Py_CLEAR(clear_module_state->__pyx_n_s_metric);
   Py_CLEAR(clear_module_state->__pyx_n_s_n_jobs);
   Py_CLEAR(clear_module_state->__pyx_n_s_name);
   Py_CLEAR(clear_module_state->__pyx_n_s_new);
-  Py_CLEAR(clear_module_state->__pyx_kp_u_not_connected_edges_It_is_a_for);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_not_connected_edges_of);
   Py_CLEAR(clear_module_state->__pyx_n_s_np);
+  Py_CLEAR(clear_module_state->__pyx_n_s_num_points);
   Py_CLEAR(clear_module_state->__pyx_n_s_numpy);
   Py_CLEAR(clear_module_state->__pyx_kp_s_numpy_core_multiarray_failed_to);
   Py_CLEAR(clear_module_state->__pyx_kp_s_numpy_core_umath_failed_to_impor);
   Py_CLEAR(clear_module_state->__pyx_n_s_ones);
+  Py_CLEAR(clear_module_state->__pyx_kp_u_or_pick_the_square_mode_not_avai);
   Py_CLEAR(clear_module_state->__pyx_kp_u_parameter);
   Py_CLEAR(clear_module_state->__pyx_n_s_pickle);
   Py_CLEAR(clear_module_state->__pyx_n_s_print);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_PickleError);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_checksum);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_result);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_state);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_type);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_unpickle_PairwiseDistanceT);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_unpickle_UniversalReciproc);
   Py_CLEAR(clear_module_state->__pyx_n_s_pyx_vtable);
   Py_CLEAR(clear_module_state->__pyx_n_s_query);
   Py_CLEAR(clear_module_state->__pyx_n_s_range);
+  Py_CLEAR(clear_module_state->__pyx_n_s_reciprocity);
   Py_CLEAR(clear_module_state->__pyx_n_s_reduce);
   Py_CLEAR(clear_module_state->__pyx_n_s_reduce_cython);
   Py_CLEAR(clear_module_state->__pyx_n_s_reduce_ex);
-  Py_CLEAR(clear_module_state->__pyx_n_s_result_extras1_arr);
-  Py_CLEAR(clear_module_state->__pyx_n_s_result_extras2_arr);
   Py_CLEAR(clear_module_state->__pyx_n_s_self);
-  Py_CLEAR(clear_module_state->__pyx_kp_s_self_parent_cannot_be_converted);
   Py_CLEAR(clear_module_state->__pyx_n_s_send);
   Py_CLEAR(clear_module_state->__pyx_n_s_setstate);
   Py_CLEAR(clear_module_state->__pyx_n_s_setstate_cython);
   Py_CLEAR(clear_module_state->__pyx_n_s_shape);
+  Py_CLEAR(clear_module_state->__pyx_n_s_skip_first);
   Py_CLEAR(clear_module_state->__pyx_n_s_sklearn_neighbors);
   Py_CLEAR(clear_module_state->__pyx_n_s_spec);
   Py_CLEAR(clear_module_state->__pyx_n_s_state);
   Py_CLEAR(clear_module_state->__pyx_kp_s_stringsource);
   Py_CLEAR(clear_module_state->__pyx_n_s_sys);
   Py_CLEAR(clear_module_state->__pyx_n_s_test);
   Py_CLEAR(clear_module_state->__pyx_n_s_throw);
@@ -3626,40 +3709,41 @@
   Py_CLEAR(clear_module_state->__pyx_int_2);
   Py_CLEAR(clear_module_state->__pyx_int_3);
   Py_CLEAR(clear_module_state->__pyx_int_4);
   Py_CLEAR(clear_module_state->__pyx_int_16);
   Py_CLEAR(clear_module_state->__pyx_int_20);
   Py_CLEAR(clear_module_state->__pyx_int_16384);
   Py_CLEAR(clear_module_state->__pyx_int_21493913);
-  Py_CLEAR(clear_module_state->__pyx_int_234627805);
-  Py_CLEAR(clear_module_state->__pyx_int_neg_1);
+  Py_CLEAR(clear_module_state->__pyx_int_204757032);
   Py_CLEAR(clear_module_state->__pyx_tuple_);
   Py_CLEAR(clear_module_state->__pyx_tuple__3);
   Py_CLEAR(clear_module_state->__pyx_tuple__4);
   Py_CLEAR(clear_module_state->__pyx_tuple__6);
-  Py_CLEAR(clear_module_state->__pyx_tuple__8);
-  Py_CLEAR(clear_module_state->__pyx_tuple__9);
-  Py_CLEAR(clear_module_state->__pyx_tuple__11);
-  Py_CLEAR(clear_module_state->__pyx_tuple__16);
-  Py_CLEAR(clear_module_state->__pyx_tuple__23);
+  Py_CLEAR(clear_module_state->__pyx_tuple__10);
+  Py_CLEAR(clear_module_state->__pyx_tuple__12);
+  Py_CLEAR(clear_module_state->__pyx_tuple__13);
+  Py_CLEAR(clear_module_state->__pyx_tuple__15);
+  Py_CLEAR(clear_module_state->__pyx_tuple__20);
+  Py_CLEAR(clear_module_state->__pyx_tuple__25);
   Py_CLEAR(clear_module_state->__pyx_codeobj__7);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__10);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__12);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__13);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__8);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__9);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__11);
   Py_CLEAR(clear_module_state->__pyx_codeobj__14);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__15);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__16);
   Py_CLEAR(clear_module_state->__pyx_codeobj__17);
   Py_CLEAR(clear_module_state->__pyx_codeobj__18);
   Py_CLEAR(clear_module_state->__pyx_codeobj__19);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__20);
   Py_CLEAR(clear_module_state->__pyx_codeobj__21);
   Py_CLEAR(clear_module_state->__pyx_codeobj__22);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__23);
   Py_CLEAR(clear_module_state->__pyx_codeobj__24);
-  Py_CLEAR(clear_module_state->__pyx_codeobj__25);
   Py_CLEAR(clear_module_state->__pyx_codeobj__26);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__27);
+  Py_CLEAR(clear_module_state->__pyx_codeobj__28);
   return 0;
 }
 #endif
 /* #### Code section: module_state_traverse ### */
 #if CYTHON_USE_MODULE_STATE
 static int __pyx_m_traverse(PyObject *m, visitproc visit, void *arg) {
   __pyx_mstate *traverse_module_state = __pyx_mstate(m);
@@ -3688,153 +3772,169 @@
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_unsignedinteger);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_inexact);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_floating);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_complexfloating);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_flexible);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_character);
   Py_VISIT(traverse_module_state->__pyx_ptype_5numpy_ufunc);
+  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind);
   Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
   Py_VISIT(traverse_module_state->__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
   Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
   Py_VISIT(traverse_module_state->__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
-  Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_11_druhg_tree_UnionFind);
-  Py_VISIT(traverse_module_state->__pyx_type_5druhg_11_druhg_tree_UnionFind);
   Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity);
   Py_VISIT(traverse_module_state->__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity);
   Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges);
   Py_VISIT(traverse_module_state->__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges);
   Py_VISIT(traverse_module_state->__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr);
   Py_VISIT(traverse_module_state->__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr);
   Py_VISIT(traverse_module_state->__pyx_kp_u_A_lot_of_values);
   Py_VISIT(traverse_module_state->__pyx_kp_u_Attention_Sparse_matrix_has_an_e);
   Py_VISIT(traverse_module_state->__pyx_n_s_BallTree);
   Py_VISIT(traverse_module_state->__pyx_kp_u_Distances_cannot_be_negative_Exi);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_ranks_buffer_is_too_small);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_ERROR_values_buffer_is_too_small);
   Py_VISIT(traverse_module_state->__pyx_n_s_ImportError);
   Py_VISIT(traverse_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0x14);
-  Py_VISIT(traverse_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0xdf);
+  Py_VISIT(traverse_module_state->__pyx_kp_s_Incompatible_checksums_s_vs_0xc3);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_It_is_a_forest_Try_increasing_m);
   Py_VISIT(traverse_module_state->__pyx_n_s_KDTree);
   Py_VISIT(traverse_module_state->__pyx_n_s_N);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric___re);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric___se);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeGeneric_quer);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeSparse);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeSparse___red);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeSparse___set);
   Py_VISIT(traverse_module_state->__pyx_n_s_PairwiseDistanceTreeSparse_query);
   Py_VISIT(traverse_module_state->__pyx_n_s_Parallel);
   Py_VISIT(traverse_module_state->__pyx_n_s_PickleError);
   Py_VISIT(traverse_module_state->__pyx_kp_u_Some_distances);
   Py_VISIT(traverse_module_state->__pyx_kp_u_Two_subjects_only);
-  Py_VISIT(traverse_module_state->__pyx_n_s_TypeError);
   Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind);
-  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind___reduce_cython);
-  Py_VISIT(traverse_module_state->__pyx_n_s_UnionFind___setstate_cython);
   Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity);
   Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity___reduce_cy);
   Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity___setstate);
   Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity__compute_tr);
-  Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity_get_extras);
+  Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity_get_buffers);
   Py_VISIT(traverse_module_state->__pyx_n_s_UniversalReciprocity_get_tree);
   Py_VISIT(traverse_module_state->__pyx_n_s_ValueError);
   Py_VISIT(traverse_module_state->__pyx_kp_u__2);
-  Py_VISIT(traverse_module_state->__pyx_n_s__27);
+  Py_VISIT(traverse_module_state->__pyx_n_s__29);
   Py_VISIT(traverse_module_state->__pyx_n_s__5);
   Py_VISIT(traverse_module_state->__pyx_n_s_algorithm);
   Py_VISIT(traverse_module_state->__pyx_kp_u_algorithm_value);
+  Py_VISIT(traverse_module_state->__pyx_n_s_allocate_buffer_edgepairs);
+  Py_VISIT(traverse_module_state->__pyx_n_s_allocate_buffer_ranks);
+  Py_VISIT(traverse_module_state->__pyx_n_s_allocate_buffer_values);
   Py_VISIT(traverse_module_state->__pyx_kp_u_are_smaller_than_self_PRECISION);
   Py_VISIT(traverse_module_state->__pyx_kp_u_are_the_same_Try_increasing_max);
   Py_VISIT(traverse_module_state->__pyx_n_s_args);
   Py_VISIT(traverse_module_state->__pyx_n_s_argsort);
   Py_VISIT(traverse_module_state->__pyx_n_s_asarray);
   Py_VISIT(traverse_module_state->__pyx_n_s_astype);
   Py_VISIT(traverse_module_state->__pyx_n_s_asyncio_coroutines);
   Py_VISIT(traverse_module_state->__pyx_n_s_bisect);
   Py_VISIT(traverse_module_state->__pyx_n_s_breadth_first);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_edgepairs);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_fast);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_ranks);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_uf);
+  Py_VISIT(traverse_module_state->__pyx_n_s_buffer_values);
   Py_VISIT(traverse_module_state->__pyx_n_s_class_getitem);
   Py_VISIT(traverse_module_state->__pyx_n_s_cline_in_traceback);
   Py_VISIT(traverse_module_state->__pyx_n_s_close);
+  Py_VISIT(traverse_module_state->__pyx_n_s_cyheapq);
   Py_VISIT(traverse_module_state->__pyx_n_s_d);
   Py_VISIT(traverse_module_state->__pyx_n_s_data);
   Py_VISIT(traverse_module_state->__pyx_n_s_delayed);
   Py_VISIT(traverse_module_state->__pyx_n_s_dict);
   Py_VISIT(traverse_module_state->__pyx_n_s_dict_2);
   Py_VISIT(traverse_module_state->__pyx_kp_u_disable);
+  Py_VISIT(traverse_module_state->__pyx_n_s_double);
   Py_VISIT(traverse_module_state->__pyx_n_u_double_precision);
   Py_VISIT(traverse_module_state->__pyx_n_s_druhg__druhg_tree);
   Py_VISIT(traverse_module_state->__pyx_kp_s_druhg__druhg_tree_pyx);
+  Py_VISIT(traverse_module_state->__pyx_n_s_druhg_unionfind);
   Py_VISIT(traverse_module_state->__pyx_n_s_dtype);
   Py_VISIT(traverse_module_state->__pyx_n_s_dualtree);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_edges_with_the_max_rank_Try_inc);
   Py_VISIT(traverse_module_state->__pyx_n_s_empty);
   Py_VISIT(traverse_module_state->__pyx_kp_u_enable);
+  Py_VISIT(traverse_module_state->__pyx_n_s_endpoint);
   Py_VISIT(traverse_module_state->__pyx_n_u_euclidean);
   Py_VISIT(traverse_module_state->__pyx_n_s_float_info);
   Py_VISIT(traverse_module_state->__pyx_kp_u_for_a_better_result);
   Py_VISIT(traverse_module_state->__pyx_kp_u_gc);
   Py_VISIT(traverse_module_state->__pyx_n_s_genexpr);
   Py_VISIT(traverse_module_state->__pyx_n_s_get);
-  Py_VISIT(traverse_module_state->__pyx_n_s_get_extras);
+  Py_VISIT(traverse_module_state->__pyx_n_s_get_buffers);
   Py_VISIT(traverse_module_state->__pyx_n_s_get_tree);
   Py_VISIT(traverse_module_state->__pyx_n_s_getrow);
   Py_VISIT(traverse_module_state->__pyx_n_s_getstate);
   Py_VISIT(traverse_module_state->__pyx_n_s_heappop);
   Py_VISIT(traverse_module_state->__pyx_n_s_heappush);
   Py_VISIT(traverse_module_state->__pyx_n_s_heapq);
   Py_VISIT(traverse_module_state->__pyx_n_s_heapq_2);
+  Py_VISIT(traverse_module_state->__pyx_n_s_heapq_merge);
   Py_VISIT(traverse_module_state->__pyx_n_s_import);
   Py_VISIT(traverse_module_state->__pyx_n_s_indices);
   Py_VISIT(traverse_module_state->__pyx_n_s_initializing);
   Py_VISIT(traverse_module_state->__pyx_n_s_intp);
   Py_VISIT(traverse_module_state->__pyx_n_s_is_coroutine);
   Py_VISIT(traverse_module_state->__pyx_kp_u_is_not_valid);
-  Py_VISIT(traverse_module_state->__pyx_n_s_is_slow);
   Py_VISIT(traverse_module_state->__pyx_kp_u_isenabled);
   Py_VISIT(traverse_module_state->__pyx_n_s_items);
   Py_VISIT(traverse_module_state->__pyx_n_s_joblib);
   Py_VISIT(traverse_module_state->__pyx_n_s_k);
   Py_VISIT(traverse_module_state->__pyx_n_s_leaf_size);
   Py_VISIT(traverse_module_state->__pyx_kp_u_level_Try_decreasing_double_pre);
   Py_VISIT(traverse_module_state->__pyx_n_s_main);
   Py_VISIT(traverse_module_state->__pyx_n_s_max);
   Py_VISIT(traverse_module_state->__pyx_n_s_max_neighbors_search);
+  Py_VISIT(traverse_module_state->__pyx_n_s_max_rank);
+  Py_VISIT(traverse_module_state->__pyx_n_s_merge);
   Py_VISIT(traverse_module_state->__pyx_n_s_metric);
   Py_VISIT(traverse_module_state->__pyx_n_s_n_jobs);
   Py_VISIT(traverse_module_state->__pyx_n_s_name);
   Py_VISIT(traverse_module_state->__pyx_n_s_new);
-  Py_VISIT(traverse_module_state->__pyx_kp_u_not_connected_edges_It_is_a_for);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_not_connected_edges_of);
   Py_VISIT(traverse_module_state->__pyx_n_s_np);
+  Py_VISIT(traverse_module_state->__pyx_n_s_num_points);
   Py_VISIT(traverse_module_state->__pyx_n_s_numpy);
   Py_VISIT(traverse_module_state->__pyx_kp_s_numpy_core_multiarray_failed_to);
   Py_VISIT(traverse_module_state->__pyx_kp_s_numpy_core_umath_failed_to_impor);
   Py_VISIT(traverse_module_state->__pyx_n_s_ones);
+  Py_VISIT(traverse_module_state->__pyx_kp_u_or_pick_the_square_mode_not_avai);
   Py_VISIT(traverse_module_state->__pyx_kp_u_parameter);
   Py_VISIT(traverse_module_state->__pyx_n_s_pickle);
   Py_VISIT(traverse_module_state->__pyx_n_s_print);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_PickleError);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_checksum);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_result);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_state);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_type);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_unpickle_PairwiseDistanceT);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_unpickle_UniversalReciproc);
   Py_VISIT(traverse_module_state->__pyx_n_s_pyx_vtable);
   Py_VISIT(traverse_module_state->__pyx_n_s_query);
   Py_VISIT(traverse_module_state->__pyx_n_s_range);
+  Py_VISIT(traverse_module_state->__pyx_n_s_reciprocity);
   Py_VISIT(traverse_module_state->__pyx_n_s_reduce);
   Py_VISIT(traverse_module_state->__pyx_n_s_reduce_cython);
   Py_VISIT(traverse_module_state->__pyx_n_s_reduce_ex);
-  Py_VISIT(traverse_module_state->__pyx_n_s_result_extras1_arr);
-  Py_VISIT(traverse_module_state->__pyx_n_s_result_extras2_arr);
   Py_VISIT(traverse_module_state->__pyx_n_s_self);
-  Py_VISIT(traverse_module_state->__pyx_kp_s_self_parent_cannot_be_converted);
   Py_VISIT(traverse_module_state->__pyx_n_s_send);
   Py_VISIT(traverse_module_state->__pyx_n_s_setstate);
   Py_VISIT(traverse_module_state->__pyx_n_s_setstate_cython);
   Py_VISIT(traverse_module_state->__pyx_n_s_shape);
+  Py_VISIT(traverse_module_state->__pyx_n_s_skip_first);
   Py_VISIT(traverse_module_state->__pyx_n_s_sklearn_neighbors);
   Py_VISIT(traverse_module_state->__pyx_n_s_spec);
   Py_VISIT(traverse_module_state->__pyx_n_s_state);
   Py_VISIT(traverse_module_state->__pyx_kp_s_stringsource);
   Py_VISIT(traverse_module_state->__pyx_n_s_sys);
   Py_VISIT(traverse_module_state->__pyx_n_s_test);
   Py_VISIT(traverse_module_state->__pyx_n_s_throw);
@@ -3850,40 +3950,41 @@
   Py_VISIT(traverse_module_state->__pyx_int_2);
   Py_VISIT(traverse_module_state->__pyx_int_3);
   Py_VISIT(traverse_module_state->__pyx_int_4);
   Py_VISIT(traverse_module_state->__pyx_int_16);
   Py_VISIT(traverse_module_state->__pyx_int_20);
   Py_VISIT(traverse_module_state->__pyx_int_16384);
   Py_VISIT(traverse_module_state->__pyx_int_21493913);
-  Py_VISIT(traverse_module_state->__pyx_int_234627805);
-  Py_VISIT(traverse_module_state->__pyx_int_neg_1);
+  Py_VISIT(traverse_module_state->__pyx_int_204757032);
   Py_VISIT(traverse_module_state->__pyx_tuple_);
   Py_VISIT(traverse_module_state->__pyx_tuple__3);
   Py_VISIT(traverse_module_state->__pyx_tuple__4);
   Py_VISIT(traverse_module_state->__pyx_tuple__6);
-  Py_VISIT(traverse_module_state->__pyx_tuple__8);
-  Py_VISIT(traverse_module_state->__pyx_tuple__9);
-  Py_VISIT(traverse_module_state->__pyx_tuple__11);
-  Py_VISIT(traverse_module_state->__pyx_tuple__16);
-  Py_VISIT(traverse_module_state->__pyx_tuple__23);
+  Py_VISIT(traverse_module_state->__pyx_tuple__10);
+  Py_VISIT(traverse_module_state->__pyx_tuple__12);
+  Py_VISIT(traverse_module_state->__pyx_tuple__13);
+  Py_VISIT(traverse_module_state->__pyx_tuple__15);
+  Py_VISIT(traverse_module_state->__pyx_tuple__20);
+  Py_VISIT(traverse_module_state->__pyx_tuple__25);
   Py_VISIT(traverse_module_state->__pyx_codeobj__7);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__10);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__12);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__13);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__8);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__9);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__11);
   Py_VISIT(traverse_module_state->__pyx_codeobj__14);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__15);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__16);
   Py_VISIT(traverse_module_state->__pyx_codeobj__17);
   Py_VISIT(traverse_module_state->__pyx_codeobj__18);
   Py_VISIT(traverse_module_state->__pyx_codeobj__19);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__20);
   Py_VISIT(traverse_module_state->__pyx_codeobj__21);
   Py_VISIT(traverse_module_state->__pyx_codeobj__22);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__23);
   Py_VISIT(traverse_module_state->__pyx_codeobj__24);
-  Py_VISIT(traverse_module_state->__pyx_codeobj__25);
   Py_VISIT(traverse_module_state->__pyx_codeobj__26);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__27);
+  Py_VISIT(traverse_module_state->__pyx_codeobj__28);
   return 0;
 }
 #endif
 /* #### Code section: module_state_defines ### */
 #if CYTHON_USE_MODULE_STATE
 #define __pyx_d __pyx_mstate_global->__pyx_d
 #define __pyx_b __pyx_mstate_global->__pyx_b
@@ -3909,153 +4010,169 @@
 #define __pyx_ptype_5numpy_unsignedinteger __pyx_mstate_global->__pyx_ptype_5numpy_unsignedinteger
 #define __pyx_ptype_5numpy_inexact __pyx_mstate_global->__pyx_ptype_5numpy_inexact
 #define __pyx_ptype_5numpy_floating __pyx_mstate_global->__pyx_ptype_5numpy_floating
 #define __pyx_ptype_5numpy_complexfloating __pyx_mstate_global->__pyx_ptype_5numpy_complexfloating
 #define __pyx_ptype_5numpy_flexible __pyx_mstate_global->__pyx_ptype_5numpy_flexible
 #define __pyx_ptype_5numpy_character __pyx_mstate_global->__pyx_ptype_5numpy_character
 #define __pyx_ptype_5numpy_ufunc __pyx_mstate_global->__pyx_ptype_5numpy_ufunc
+#define __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind __pyx_mstate_global->__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind
 #define __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse __pyx_mstate_global->__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse
 #define __pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse __pyx_mstate_global->__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse
 #define __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric __pyx_mstate_global->__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric
 #define __pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric __pyx_mstate_global->__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric
-#define __pyx_ptype_5druhg_11_druhg_tree_UnionFind __pyx_mstate_global->__pyx_ptype_5druhg_11_druhg_tree_UnionFind
-#define __pyx_type_5druhg_11_druhg_tree_UnionFind __pyx_mstate_global->__pyx_type_5druhg_11_druhg_tree_UnionFind
 #define __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity __pyx_mstate_global->__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity
 #define __pyx_type_5druhg_11_druhg_tree_UniversalReciprocity __pyx_mstate_global->__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity
 #define __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges __pyx_mstate_global->__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges
 #define __pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges __pyx_mstate_global->__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges
 #define __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr __pyx_mstate_global->__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr
 #define __pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr __pyx_mstate_global->__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr
 #define __pyx_kp_u_A_lot_of_values __pyx_mstate_global->__pyx_kp_u_A_lot_of_values
 #define __pyx_kp_u_Attention_Sparse_matrix_has_an_e __pyx_mstate_global->__pyx_kp_u_Attention_Sparse_matrix_has_an_e
 #define __pyx_n_s_BallTree __pyx_mstate_global->__pyx_n_s_BallTree
 #define __pyx_kp_u_Distances_cannot_be_negative_Exi __pyx_mstate_global->__pyx_kp_u_Distances_cannot_be_negative_Exi
+#define __pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm __pyx_mstate_global->__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm
+#define __pyx_kp_u_ERROR_ranks_buffer_is_too_small __pyx_mstate_global->__pyx_kp_u_ERROR_ranks_buffer_is_too_small
+#define __pyx_kp_u_ERROR_values_buffer_is_too_small __pyx_mstate_global->__pyx_kp_u_ERROR_values_buffer_is_too_small
 #define __pyx_n_s_ImportError __pyx_mstate_global->__pyx_n_s_ImportError
 #define __pyx_kp_s_Incompatible_checksums_s_vs_0x14 __pyx_mstate_global->__pyx_kp_s_Incompatible_checksums_s_vs_0x14
-#define __pyx_kp_s_Incompatible_checksums_s_vs_0xdf __pyx_mstate_global->__pyx_kp_s_Incompatible_checksums_s_vs_0xdf
+#define __pyx_kp_s_Incompatible_checksums_s_vs_0xc3 __pyx_mstate_global->__pyx_kp_s_Incompatible_checksums_s_vs_0xc3
+#define __pyx_kp_u_It_is_a_forest_Try_increasing_m __pyx_mstate_global->__pyx_kp_u_It_is_a_forest_Try_increasing_m
 #define __pyx_n_s_KDTree __pyx_mstate_global->__pyx_n_s_KDTree
 #define __pyx_n_s_N __pyx_mstate_global->__pyx_n_s_N
 #define __pyx_n_s_PairwiseDistanceTreeGeneric __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeGeneric
 #define __pyx_n_s_PairwiseDistanceTreeGeneric___re __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeGeneric___re
 #define __pyx_n_s_PairwiseDistanceTreeGeneric___se __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeGeneric___se
 #define __pyx_n_s_PairwiseDistanceTreeGeneric_quer __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeGeneric_quer
 #define __pyx_n_s_PairwiseDistanceTreeSparse __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeSparse
 #define __pyx_n_s_PairwiseDistanceTreeSparse___red __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeSparse___red
 #define __pyx_n_s_PairwiseDistanceTreeSparse___set __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeSparse___set
 #define __pyx_n_s_PairwiseDistanceTreeSparse_query __pyx_mstate_global->__pyx_n_s_PairwiseDistanceTreeSparse_query
 #define __pyx_n_s_Parallel __pyx_mstate_global->__pyx_n_s_Parallel
 #define __pyx_n_s_PickleError __pyx_mstate_global->__pyx_n_s_PickleError
 #define __pyx_kp_u_Some_distances __pyx_mstate_global->__pyx_kp_u_Some_distances
 #define __pyx_kp_u_Two_subjects_only __pyx_mstate_global->__pyx_kp_u_Two_subjects_only
-#define __pyx_n_s_TypeError __pyx_mstate_global->__pyx_n_s_TypeError
 #define __pyx_n_s_UnionFind __pyx_mstate_global->__pyx_n_s_UnionFind
-#define __pyx_n_s_UnionFind___reduce_cython __pyx_mstate_global->__pyx_n_s_UnionFind___reduce_cython
-#define __pyx_n_s_UnionFind___setstate_cython __pyx_mstate_global->__pyx_n_s_UnionFind___setstate_cython
 #define __pyx_n_s_UniversalReciprocity __pyx_mstate_global->__pyx_n_s_UniversalReciprocity
 #define __pyx_n_s_UniversalReciprocity___reduce_cy __pyx_mstate_global->__pyx_n_s_UniversalReciprocity___reduce_cy
 #define __pyx_n_s_UniversalReciprocity___setstate __pyx_mstate_global->__pyx_n_s_UniversalReciprocity___setstate
 #define __pyx_n_s_UniversalReciprocity__compute_tr __pyx_mstate_global->__pyx_n_s_UniversalReciprocity__compute_tr
-#define __pyx_n_s_UniversalReciprocity_get_extras __pyx_mstate_global->__pyx_n_s_UniversalReciprocity_get_extras
+#define __pyx_n_s_UniversalReciprocity_get_buffers __pyx_mstate_global->__pyx_n_s_UniversalReciprocity_get_buffers
 #define __pyx_n_s_UniversalReciprocity_get_tree __pyx_mstate_global->__pyx_n_s_UniversalReciprocity_get_tree
 #define __pyx_n_s_ValueError __pyx_mstate_global->__pyx_n_s_ValueError
 #define __pyx_kp_u__2 __pyx_mstate_global->__pyx_kp_u__2
-#define __pyx_n_s__27 __pyx_mstate_global->__pyx_n_s__27
+#define __pyx_n_s__29 __pyx_mstate_global->__pyx_n_s__29
 #define __pyx_n_s__5 __pyx_mstate_global->__pyx_n_s__5
 #define __pyx_n_s_algorithm __pyx_mstate_global->__pyx_n_s_algorithm
 #define __pyx_kp_u_algorithm_value __pyx_mstate_global->__pyx_kp_u_algorithm_value
+#define __pyx_n_s_allocate_buffer_edgepairs __pyx_mstate_global->__pyx_n_s_allocate_buffer_edgepairs
+#define __pyx_n_s_allocate_buffer_ranks __pyx_mstate_global->__pyx_n_s_allocate_buffer_ranks
+#define __pyx_n_s_allocate_buffer_values __pyx_mstate_global->__pyx_n_s_allocate_buffer_values
 #define __pyx_kp_u_are_smaller_than_self_PRECISION __pyx_mstate_global->__pyx_kp_u_are_smaller_than_self_PRECISION
 #define __pyx_kp_u_are_the_same_Try_increasing_max __pyx_mstate_global->__pyx_kp_u_are_the_same_Try_increasing_max
 #define __pyx_n_s_args __pyx_mstate_global->__pyx_n_s_args
 #define __pyx_n_s_argsort __pyx_mstate_global->__pyx_n_s_argsort
 #define __pyx_n_s_asarray __pyx_mstate_global->__pyx_n_s_asarray
 #define __pyx_n_s_astype __pyx_mstate_global->__pyx_n_s_astype
 #define __pyx_n_s_asyncio_coroutines __pyx_mstate_global->__pyx_n_s_asyncio_coroutines
 #define __pyx_n_s_bisect __pyx_mstate_global->__pyx_n_s_bisect
 #define __pyx_n_s_breadth_first __pyx_mstate_global->__pyx_n_s_breadth_first
+#define __pyx_n_s_buffer_edgepairs __pyx_mstate_global->__pyx_n_s_buffer_edgepairs
+#define __pyx_n_s_buffer_fast __pyx_mstate_global->__pyx_n_s_buffer_fast
+#define __pyx_n_s_buffer_ranks __pyx_mstate_global->__pyx_n_s_buffer_ranks
+#define __pyx_n_s_buffer_uf __pyx_mstate_global->__pyx_n_s_buffer_uf
+#define __pyx_n_s_buffer_values __pyx_mstate_global->__pyx_n_s_buffer_values
 #define __pyx_n_s_class_getitem __pyx_mstate_global->__pyx_n_s_class_getitem
 #define __pyx_n_s_cline_in_traceback __pyx_mstate_global->__pyx_n_s_cline_in_traceback
 #define __pyx_n_s_close __pyx_mstate_global->__pyx_n_s_close
+#define __pyx_n_s_cyheapq __pyx_mstate_global->__pyx_n_s_cyheapq
 #define __pyx_n_s_d __pyx_mstate_global->__pyx_n_s_d
 #define __pyx_n_s_data __pyx_mstate_global->__pyx_n_s_data
 #define __pyx_n_s_delayed __pyx_mstate_global->__pyx_n_s_delayed
 #define __pyx_n_s_dict __pyx_mstate_global->__pyx_n_s_dict
 #define __pyx_n_s_dict_2 __pyx_mstate_global->__pyx_n_s_dict_2
 #define __pyx_kp_u_disable __pyx_mstate_global->__pyx_kp_u_disable
+#define __pyx_n_s_double __pyx_mstate_global->__pyx_n_s_double
 #define __pyx_n_u_double_precision __pyx_mstate_global->__pyx_n_u_double_precision
 #define __pyx_n_s_druhg__druhg_tree __pyx_mstate_global->__pyx_n_s_druhg__druhg_tree
 #define __pyx_kp_s_druhg__druhg_tree_pyx __pyx_mstate_global->__pyx_kp_s_druhg__druhg_tree_pyx
+#define __pyx_n_s_druhg_unionfind __pyx_mstate_global->__pyx_n_s_druhg_unionfind
 #define __pyx_n_s_dtype __pyx_mstate_global->__pyx_n_s_dtype
 #define __pyx_n_s_dualtree __pyx_mstate_global->__pyx_n_s_dualtree
+#define __pyx_kp_u_edges_with_the_max_rank_Try_inc __pyx_mstate_global->__pyx_kp_u_edges_with_the_max_rank_Try_inc
 #define __pyx_n_s_empty __pyx_mstate_global->__pyx_n_s_empty
 #define __pyx_kp_u_enable __pyx_mstate_global->__pyx_kp_u_enable
+#define __pyx_n_s_endpoint __pyx_mstate_global->__pyx_n_s_endpoint
 #define __pyx_n_u_euclidean __pyx_mstate_global->__pyx_n_u_euclidean
 #define __pyx_n_s_float_info __pyx_mstate_global->__pyx_n_s_float_info
 #define __pyx_kp_u_for_a_better_result __pyx_mstate_global->__pyx_kp_u_for_a_better_result
 #define __pyx_kp_u_gc __pyx_mstate_global->__pyx_kp_u_gc
 #define __pyx_n_s_genexpr __pyx_mstate_global->__pyx_n_s_genexpr
 #define __pyx_n_s_get __pyx_mstate_global->__pyx_n_s_get
-#define __pyx_n_s_get_extras __pyx_mstate_global->__pyx_n_s_get_extras
+#define __pyx_n_s_get_buffers __pyx_mstate_global->__pyx_n_s_get_buffers
 #define __pyx_n_s_get_tree __pyx_mstate_global->__pyx_n_s_get_tree
 #define __pyx_n_s_getrow __pyx_mstate_global->__pyx_n_s_getrow
 #define __pyx_n_s_getstate __pyx_mstate_global->__pyx_n_s_getstate
 #define __pyx_n_s_heappop __pyx_mstate_global->__pyx_n_s_heappop
 #define __pyx_n_s_heappush __pyx_mstate_global->__pyx_n_s_heappush
 #define __pyx_n_s_heapq __pyx_mstate_global->__pyx_n_s_heapq
 #define __pyx_n_s_heapq_2 __pyx_mstate_global->__pyx_n_s_heapq_2
+#define __pyx_n_s_heapq_merge __pyx_mstate_global->__pyx_n_s_heapq_merge
 #define __pyx_n_s_import __pyx_mstate_global->__pyx_n_s_import
 #define __pyx_n_s_indices __pyx_mstate_global->__pyx_n_s_indices
 #define __pyx_n_s_initializing __pyx_mstate_global->__pyx_n_s_initializing
 #define __pyx_n_s_intp __pyx_mstate_global->__pyx_n_s_intp
 #define __pyx_n_s_is_coroutine __pyx_mstate_global->__pyx_n_s_is_coroutine
 #define __pyx_kp_u_is_not_valid __pyx_mstate_global->__pyx_kp_u_is_not_valid
-#define __pyx_n_s_is_slow __pyx_mstate_global->__pyx_n_s_is_slow
 #define __pyx_kp_u_isenabled __pyx_mstate_global->__pyx_kp_u_isenabled
 #define __pyx_n_s_items __pyx_mstate_global->__pyx_n_s_items
 #define __pyx_n_s_joblib __pyx_mstate_global->__pyx_n_s_joblib
 #define __pyx_n_s_k __pyx_mstate_global->__pyx_n_s_k
 #define __pyx_n_s_leaf_size __pyx_mstate_global->__pyx_n_s_leaf_size
 #define __pyx_kp_u_level_Try_decreasing_double_pre __pyx_mstate_global->__pyx_kp_u_level_Try_decreasing_double_pre
 #define __pyx_n_s_main __pyx_mstate_global->__pyx_n_s_main
 #define __pyx_n_s_max __pyx_mstate_global->__pyx_n_s_max
 #define __pyx_n_s_max_neighbors_search __pyx_mstate_global->__pyx_n_s_max_neighbors_search
+#define __pyx_n_s_max_rank __pyx_mstate_global->__pyx_n_s_max_rank
+#define __pyx_n_s_merge __pyx_mstate_global->__pyx_n_s_merge
 #define __pyx_n_s_metric __pyx_mstate_global->__pyx_n_s_metric
 #define __pyx_n_s_n_jobs __pyx_mstate_global->__pyx_n_s_n_jobs
 #define __pyx_n_s_name __pyx_mstate_global->__pyx_n_s_name
 #define __pyx_n_s_new __pyx_mstate_global->__pyx_n_s_new
-#define __pyx_kp_u_not_connected_edges_It_is_a_for __pyx_mstate_global->__pyx_kp_u_not_connected_edges_It_is_a_for
+#define __pyx_kp_u_not_connected_edges_of __pyx_mstate_global->__pyx_kp_u_not_connected_edges_of
 #define __pyx_n_s_np __pyx_mstate_global->__pyx_n_s_np
+#define __pyx_n_s_num_points __pyx_mstate_global->__pyx_n_s_num_points
 #define __pyx_n_s_numpy __pyx_mstate_global->__pyx_n_s_numpy
 #define __pyx_kp_s_numpy_core_multiarray_failed_to __pyx_mstate_global->__pyx_kp_s_numpy_core_multiarray_failed_to
 #define __pyx_kp_s_numpy_core_umath_failed_to_impor __pyx_mstate_global->__pyx_kp_s_numpy_core_umath_failed_to_impor
 #define __pyx_n_s_ones __pyx_mstate_global->__pyx_n_s_ones
+#define __pyx_kp_u_or_pick_the_square_mode_not_avai __pyx_mstate_global->__pyx_kp_u_or_pick_the_square_mode_not_avai
 #define __pyx_kp_u_parameter __pyx_mstate_global->__pyx_kp_u_parameter
 #define __pyx_n_s_pickle __pyx_mstate_global->__pyx_n_s_pickle
 #define __pyx_n_s_print __pyx_mstate_global->__pyx_n_s_print
 #define __pyx_n_s_pyx_PickleError __pyx_mstate_global->__pyx_n_s_pyx_PickleError
 #define __pyx_n_s_pyx_checksum __pyx_mstate_global->__pyx_n_s_pyx_checksum
 #define __pyx_n_s_pyx_result __pyx_mstate_global->__pyx_n_s_pyx_result
 #define __pyx_n_s_pyx_state __pyx_mstate_global->__pyx_n_s_pyx_state
 #define __pyx_n_s_pyx_type __pyx_mstate_global->__pyx_n_s_pyx_type
 #define __pyx_n_s_pyx_unpickle_PairwiseDistanceT __pyx_mstate_global->__pyx_n_s_pyx_unpickle_PairwiseDistanceT
 #define __pyx_n_s_pyx_unpickle_PairwiseDistanceT_2 __pyx_mstate_global->__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2
 #define __pyx_n_s_pyx_unpickle_UniversalReciproc __pyx_mstate_global->__pyx_n_s_pyx_unpickle_UniversalReciproc
 #define __pyx_n_s_pyx_vtable __pyx_mstate_global->__pyx_n_s_pyx_vtable
 #define __pyx_n_s_query __pyx_mstate_global->__pyx_n_s_query
 #define __pyx_n_s_range __pyx_mstate_global->__pyx_n_s_range
+#define __pyx_n_s_reciprocity __pyx_mstate_global->__pyx_n_s_reciprocity
 #define __pyx_n_s_reduce __pyx_mstate_global->__pyx_n_s_reduce
 #define __pyx_n_s_reduce_cython __pyx_mstate_global->__pyx_n_s_reduce_cython
 #define __pyx_n_s_reduce_ex __pyx_mstate_global->__pyx_n_s_reduce_ex
-#define __pyx_n_s_result_extras1_arr __pyx_mstate_global->__pyx_n_s_result_extras1_arr
-#define __pyx_n_s_result_extras2_arr __pyx_mstate_global->__pyx_n_s_result_extras2_arr
 #define __pyx_n_s_self __pyx_mstate_global->__pyx_n_s_self
-#define __pyx_kp_s_self_parent_cannot_be_converted __pyx_mstate_global->__pyx_kp_s_self_parent_cannot_be_converted
 #define __pyx_n_s_send __pyx_mstate_global->__pyx_n_s_send
 #define __pyx_n_s_setstate __pyx_mstate_global->__pyx_n_s_setstate
 #define __pyx_n_s_setstate_cython __pyx_mstate_global->__pyx_n_s_setstate_cython
 #define __pyx_n_s_shape __pyx_mstate_global->__pyx_n_s_shape
+#define __pyx_n_s_skip_first __pyx_mstate_global->__pyx_n_s_skip_first
 #define __pyx_n_s_sklearn_neighbors __pyx_mstate_global->__pyx_n_s_sklearn_neighbors
 #define __pyx_n_s_spec __pyx_mstate_global->__pyx_n_s_spec
 #define __pyx_n_s_state __pyx_mstate_global->__pyx_n_s_state
 #define __pyx_kp_s_stringsource __pyx_mstate_global->__pyx_kp_s_stringsource
 #define __pyx_n_s_sys __pyx_mstate_global->__pyx_n_s_sys
 #define __pyx_n_s_test __pyx_mstate_global->__pyx_n_s_test
 #define __pyx_n_s_throw __pyx_mstate_global->__pyx_n_s_throw
@@ -4071,44 +4188,516 @@
 #define __pyx_int_2 __pyx_mstate_global->__pyx_int_2
 #define __pyx_int_3 __pyx_mstate_global->__pyx_int_3
 #define __pyx_int_4 __pyx_mstate_global->__pyx_int_4
 #define __pyx_int_16 __pyx_mstate_global->__pyx_int_16
 #define __pyx_int_20 __pyx_mstate_global->__pyx_int_20
 #define __pyx_int_16384 __pyx_mstate_global->__pyx_int_16384
 #define __pyx_int_21493913 __pyx_mstate_global->__pyx_int_21493913
-#define __pyx_int_234627805 __pyx_mstate_global->__pyx_int_234627805
-#define __pyx_int_neg_1 __pyx_mstate_global->__pyx_int_neg_1
+#define __pyx_int_204757032 __pyx_mstate_global->__pyx_int_204757032
 #define __pyx_tuple_ __pyx_mstate_global->__pyx_tuple_
 #define __pyx_tuple__3 __pyx_mstate_global->__pyx_tuple__3
 #define __pyx_tuple__4 __pyx_mstate_global->__pyx_tuple__4
 #define __pyx_tuple__6 __pyx_mstate_global->__pyx_tuple__6
-#define __pyx_tuple__8 __pyx_mstate_global->__pyx_tuple__8
-#define __pyx_tuple__9 __pyx_mstate_global->__pyx_tuple__9
-#define __pyx_tuple__11 __pyx_mstate_global->__pyx_tuple__11
-#define __pyx_tuple__16 __pyx_mstate_global->__pyx_tuple__16
-#define __pyx_tuple__23 __pyx_mstate_global->__pyx_tuple__23
+#define __pyx_tuple__10 __pyx_mstate_global->__pyx_tuple__10
+#define __pyx_tuple__12 __pyx_mstate_global->__pyx_tuple__12
+#define __pyx_tuple__13 __pyx_mstate_global->__pyx_tuple__13
+#define __pyx_tuple__15 __pyx_mstate_global->__pyx_tuple__15
+#define __pyx_tuple__20 __pyx_mstate_global->__pyx_tuple__20
+#define __pyx_tuple__25 __pyx_mstate_global->__pyx_tuple__25
 #define __pyx_codeobj__7 __pyx_mstate_global->__pyx_codeobj__7
-#define __pyx_codeobj__10 __pyx_mstate_global->__pyx_codeobj__10
-#define __pyx_codeobj__12 __pyx_mstate_global->__pyx_codeobj__12
-#define __pyx_codeobj__13 __pyx_mstate_global->__pyx_codeobj__13
+#define __pyx_codeobj__8 __pyx_mstate_global->__pyx_codeobj__8
+#define __pyx_codeobj__9 __pyx_mstate_global->__pyx_codeobj__9
+#define __pyx_codeobj__11 __pyx_mstate_global->__pyx_codeobj__11
 #define __pyx_codeobj__14 __pyx_mstate_global->__pyx_codeobj__14
-#define __pyx_codeobj__15 __pyx_mstate_global->__pyx_codeobj__15
+#define __pyx_codeobj__16 __pyx_mstate_global->__pyx_codeobj__16
 #define __pyx_codeobj__17 __pyx_mstate_global->__pyx_codeobj__17
 #define __pyx_codeobj__18 __pyx_mstate_global->__pyx_codeobj__18
 #define __pyx_codeobj__19 __pyx_mstate_global->__pyx_codeobj__19
-#define __pyx_codeobj__20 __pyx_mstate_global->__pyx_codeobj__20
 #define __pyx_codeobj__21 __pyx_mstate_global->__pyx_codeobj__21
 #define __pyx_codeobj__22 __pyx_mstate_global->__pyx_codeobj__22
+#define __pyx_codeobj__23 __pyx_mstate_global->__pyx_codeobj__23
 #define __pyx_codeobj__24 __pyx_mstate_global->__pyx_codeobj__24
-#define __pyx_codeobj__25 __pyx_mstate_global->__pyx_codeobj__25
 #define __pyx_codeobj__26 __pyx_mstate_global->__pyx_codeobj__26
+#define __pyx_codeobj__27 __pyx_mstate_global->__pyx_codeobj__27
+#define __pyx_codeobj__28 __pyx_mstate_global->__pyx_codeobj__28
 #endif
 /* #### Code section: module_code ### */
 
-/* "druhg/_druhg_tree.pyx":31
+/* "druhg/_druhg_tree.pyx":33
+ * from joblib import Parallel, delayed
+ * 
+ * def allocate_buffer_values(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_1allocate_buffer_values(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+); /*proto*/
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_1allocate_buffer_values = {"allocate_buffer_values", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_1allocate_buffer_values, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_1allocate_buffer_values(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+) {
+  __pyx_t_5numpy_intp_t __pyx_v_num_points;
+  #if !CYTHON_METH_FASTCALL
+  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
+  #endif
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("allocate_buffer_values (wrapper)", 0);
+  {
+    #if CYTHON_USE_MODULE_STATE
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_num_points,0};
+    #else
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_num_points,0};
+    #endif
+    PyObject* values[1] = {0};
+    if (__pyx_kwds) {
+      Py_ssize_t kw_args;
+      switch (__pyx_nargs) {
+        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
+      switch (__pyx_nargs) {
+        case  0:
+        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_num_points)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 33, __pyx_L3_error)
+        else goto __pyx_L5_argtuple_error;
+      }
+      if (unlikely(kw_args > 0)) {
+        const Py_ssize_t kwd_pos_args = __pyx_nargs;
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "allocate_buffer_values") < 0)) __PYX_ERR(0, 33, __pyx_L3_error)
+      }
+    } else if (unlikely(__pyx_nargs != 1)) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+    }
+    __pyx_v_num_points = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_num_points == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 33, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("allocate_buffer_values", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 33, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("druhg._druhg_tree.allocate_buffer_values", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_allocate_buffer_values(__pyx_self, __pyx_v_num_points);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_allocate_buffer_values(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_num_points) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("allocate_buffer_values", 0);
+
+  /* "druhg/_druhg_tree.pyx":34
+ * 
+ * def allocate_buffer_values(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.double)             # <<<<<<<<<<<<<<
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyInt_FromSsize_t((__pyx_v_num_points - 1)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_double); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 34, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_r = __pyx_t_5;
+  __pyx_t_5 = 0;
+  goto __pyx_L0;
+
+  /* "druhg/_druhg_tree.pyx":33
+ * from joblib import Parallel, delayed
+ * 
+ * def allocate_buffer_values(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_AddTraceback("druhg._druhg_tree.allocate_buffer_values", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "druhg/_druhg_tree.pyx":35
+ * def allocate_buffer_values(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_3allocate_buffer_edgepairs(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+); /*proto*/
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_3allocate_buffer_edgepairs = {"allocate_buffer_edgepairs", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_3allocate_buffer_edgepairs, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_3allocate_buffer_edgepairs(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+) {
+  __pyx_t_5numpy_intp_t __pyx_v_num_points;
+  #if !CYTHON_METH_FASTCALL
+  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
+  #endif
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("allocate_buffer_edgepairs (wrapper)", 0);
+  {
+    #if CYTHON_USE_MODULE_STATE
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_num_points,0};
+    #else
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_num_points,0};
+    #endif
+    PyObject* values[1] = {0};
+    if (__pyx_kwds) {
+      Py_ssize_t kw_args;
+      switch (__pyx_nargs) {
+        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
+      switch (__pyx_nargs) {
+        case  0:
+        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_num_points)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 35, __pyx_L3_error)
+        else goto __pyx_L5_argtuple_error;
+      }
+      if (unlikely(kw_args > 0)) {
+        const Py_ssize_t kwd_pos_args = __pyx_nargs;
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "allocate_buffer_edgepairs") < 0)) __PYX_ERR(0, 35, __pyx_L3_error)
+      }
+    } else if (unlikely(__pyx_nargs != 1)) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+    }
+    __pyx_v_num_points = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_num_points == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 35, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("allocate_buffer_edgepairs", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 35, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("druhg._druhg_tree.allocate_buffer_edgepairs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_2allocate_buffer_edgepairs(__pyx_self, __pyx_v_num_points);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_2allocate_buffer_edgepairs(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_num_points) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("allocate_buffer_edgepairs", 0);
+
+  /* "druhg/_druhg_tree.pyx":36
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)             # <<<<<<<<<<<<<<
+ * def allocate_buffer_ranks(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.intp)
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyInt_FromSsize_t(((__pyx_v_num_points * 2) - 2)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 36, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_r = __pyx_t_5;
+  __pyx_t_5 = 0;
+  goto __pyx_L0;
+
+  /* "druhg/_druhg_tree.pyx":35
+ * def allocate_buffer_values(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_AddTraceback("druhg._druhg_tree.allocate_buffer_edgepairs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "druhg/_druhg_tree.pyx":37
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.intp)
+ * 
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_5allocate_buffer_ranks(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+); /*proto*/
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_5allocate_buffer_ranks = {"allocate_buffer_ranks", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_5allocate_buffer_ranks, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_5allocate_buffer_ranks(PyObject *__pyx_self, 
+#if CYTHON_METH_FASTCALL
+PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
+#else
+PyObject *__pyx_args, PyObject *__pyx_kwds
+#endif
+) {
+  __pyx_t_5numpy_intp_t __pyx_v_num_points;
+  #if !CYTHON_METH_FASTCALL
+  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
+  #endif
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("allocate_buffer_ranks (wrapper)", 0);
+  {
+    #if CYTHON_USE_MODULE_STATE
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_num_points,0};
+    #else
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_num_points,0};
+    #endif
+    PyObject* values[1] = {0};
+    if (__pyx_kwds) {
+      Py_ssize_t kw_args;
+      switch (__pyx_nargs) {
+        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
+      switch (__pyx_nargs) {
+        case  0:
+        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_num_points)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 37, __pyx_L3_error)
+        else goto __pyx_L5_argtuple_error;
+      }
+      if (unlikely(kw_args > 0)) {
+        const Py_ssize_t kwd_pos_args = __pyx_nargs;
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "allocate_buffer_ranks") < 0)) __PYX_ERR(0, 37, __pyx_L3_error)
+      }
+    } else if (unlikely(__pyx_nargs != 1)) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
+    }
+    __pyx_v_num_points = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_num_points == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 37, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("allocate_buffer_ranks", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 37, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("druhg._druhg_tree.allocate_buffer_ranks", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_4allocate_buffer_ranks(__pyx_self, __pyx_v_num_points);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_4allocate_buffer_ranks(CYTHON_UNUSED PyObject *__pyx_self, __pyx_t_5numpy_intp_t __pyx_v_num_points) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("allocate_buffer_ranks", 0);
+
+  /* "druhg/_druhg_tree.pyx":38
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.intp)             # <<<<<<<<<<<<<<
+ * 
+ * cdef class PairwiseDistanceTreeSparse(object):
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyInt_FromSsize_t((__pyx_v_num_points - 1)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 38, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_r = __pyx_t_5;
+  __pyx_t_5 = 0;
+  goto __pyx_L0;
+
+  /* "druhg/_druhg_tree.pyx":37
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.intp)
+ * 
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_AddTraceback("druhg._druhg_tree.allocate_buffer_ranks", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "druhg/_druhg_tree.pyx":44
  *     cdef int data_size
  * 
  *     def __init__(self, N, d):             # <<<<<<<<<<<<<<
  *         self.data_size = N
  *         self.data_arr = d
  */
 
@@ -4142,40 +4731,40 @@
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_VARARGS(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
         if (likely((values[0] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_N)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 31, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 44, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_d)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 31, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 44, __pyx_L3_error)
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, 1); __PYX_ERR(0, 31, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, 1); __PYX_ERR(0, 44, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 31, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 44, __pyx_L3_error)
       }
     } else if (unlikely(__pyx_nargs != 2)) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
       values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
     }
     __pyx_v_N = values[0];
     __pyx_v_d = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, __pyx_nargs); __PYX_ERR(0, 31, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, __pyx_nargs); __PYX_ERR(0, 44, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.PairwiseDistanceTreeSparse.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse___init__(((struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *)__pyx_v_self), __pyx_v_N, __pyx_v_d);
 
@@ -4189,38 +4778,38 @@
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "druhg/_druhg_tree.pyx":32
+  /* "druhg/_druhg_tree.pyx":45
  * 
  *     def __init__(self, N, d):
  *         self.data_size = N             # <<<<<<<<<<<<<<
  *         self.data_arr = d
  * 
  */
-  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_N); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 32, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_N); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 45, __pyx_L1_error)
   __pyx_v_self->data_size = __pyx_t_1;
 
-  /* "druhg/_druhg_tree.pyx":33
+  /* "druhg/_druhg_tree.pyx":46
  *     def __init__(self, N, d):
  *         self.data_size = N
  *         self.data_arr = d             # <<<<<<<<<<<<<<
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):
  */
   __Pyx_INCREF(__pyx_v_d);
   __Pyx_GIVEREF(__pyx_v_d);
   __Pyx_GOTREF(__pyx_v_self->data_arr);
   __Pyx_DECREF(__pyx_v_self->data_arr);
   __pyx_v_self->data_arr = __pyx_v_d;
 
-  /* "druhg/_druhg_tree.pyx":31
+  /* "druhg/_druhg_tree.pyx":44
  *     cdef int data_size
  * 
  *     def __init__(self, N, d):             # <<<<<<<<<<<<<<
  *         self.data_size = N
  *         self.data_arr = d
  */
 
@@ -4231,15 +4820,15 @@
   __Pyx_AddTraceback("druhg._druhg_tree.PairwiseDistanceTreeSparse.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":35
+/* "druhg/_druhg_tree.pyx":48
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         # TODO: actually we need to consider replacing INF with something else.
  *         # Reciprocity of absent link is not the same as the INF. Do reciprocity with graphs!
  */
 
@@ -4307,15 +4896,15 @@
   /* Check if overridden in Python */
   else if (unlikely((Py_TYPE(((PyObject *)__pyx_v_self))->tp_dictoffset != 0) || __Pyx_PyType_HasFeature(Py_TYPE(((PyObject *)__pyx_v_self)), (Py_TPFLAGS_IS_ABSTRACT | Py_TPFLAGS_HEAPTYPE)))) {
     #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     static PY_UINT64_T __pyx_tp_dict_version = __PYX_DICT_VERSION_INIT, __pyx_obj_dict_version = __PYX_DICT_VERSION_INIT;
     if (unlikely(!__Pyx_object_dict_version_matches(((PyObject *)__pyx_v_self), __pyx_tp_dict_version, __pyx_obj_dict_version))) {
       PY_UINT64_T __pyx_typedict_guard = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
       #endif
-      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_query); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 35, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_query); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 48, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       #ifdef __Pyx_CyFunction_USED
       if (!__Pyx_IsCyOrPyCFunction(__pyx_t_1)
       #else
       if (!PyCFunction_Check(__pyx_t_1)
       #endif
               || (PyCFunction_GET_FUNCTION(__pyx_t_1) != (PyCFunction)(void*)__pyx_pw_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_3query)) {
@@ -4333,19 +4922,19 @@
             __pyx_t_5 = 1;
           }
         }
         {
           PyObject *__pyx_callargs[5] = {__pyx_t_4, __pyx_v_d, __pyx_v_k, __pyx_v_dualtree, __pyx_v_breadth_first};
           __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 4+__pyx_t_5);
           __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 35, __pyx_L1_error)
+          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 48, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         }
-        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 35, __pyx_L1_error)
+        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 48, __pyx_L1_error)
         __pyx_r = ((PyObject*)__pyx_t_2);
         __pyx_t_2 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         goto __pyx_L0;
       }
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
       __pyx_tp_dict_version = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
@@ -4356,33 +4945,33 @@
       #endif
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     }
     #endif
   }
 
-  /* "druhg/_druhg_tree.pyx":41
+  /* "druhg/_druhg_tree.pyx":54
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  * 
  *         knn_dist = INF*np.ones((self.data_size, k+1))             # <<<<<<<<<<<<<<
  *         knn_indices = np.zeros((self.data_size, k+1), dtype=np.intp)
  * 
  */
-  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_5druhg_11_druhg_tree_INF); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_5druhg_11_druhg_tree_INF); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_ones); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_ones); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_6 = __Pyx_PyInt_AddObjC(__pyx_v_k, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyInt_AddObjC(__pyx_v_k, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
   __Pyx_GIVEREF(__pyx_t_3);
   PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_6);
   PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_t_6);
   __pyx_t_3 = 0;
   __pyx_t_6 = 0;
@@ -4399,23 +4988,23 @@
     }
   }
   {
     PyObject *__pyx_callargs[2] = {__pyx_t_6, __pyx_t_7};
     __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_4, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
     __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 41, __pyx_L1_error)
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 54, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   }
-  __pyx_t_4 = PyNumber_Multiply(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_4 = PyNumber_Multiply(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 54, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 41, __pyx_L1_error)
+  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 54, __pyx_L1_error)
   __pyx_t_8 = ((PyArrayObject *)__pyx_t_4);
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
     __pyx_t_5 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
     if (unlikely(__pyx_t_5 < 0)) {
       PyErr_Fetch(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
@@ -4424,64 +5013,64 @@
         __Pyx_RaiseBufferFallbackError();
       } else {
         PyErr_Restore(__pyx_t_9, __pyx_t_10, __pyx_t_11);
       }
       __pyx_t_9 = __pyx_t_10 = __pyx_t_11 = 0;
     }
     __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
-    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 41, __pyx_L1_error)
+    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 54, __pyx_L1_error)
   }
   __pyx_t_8 = 0;
   __pyx_v_knn_dist = ((PyArrayObject *)__pyx_t_4);
   __pyx_t_4 = 0;
 
-  /* "druhg/_druhg_tree.pyx":42
+  /* "druhg/_druhg_tree.pyx":55
  * 
  *         knn_dist = INF*np.ones((self.data_size, k+1))
  *         knn_indices = np.zeros((self.data_size, k+1), dtype=np.intp)             # <<<<<<<<<<<<<<
  * 
  *         warning = 0
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_1 = __Pyx_PyInt_AddObjC(__pyx_v_k, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_AddObjC(__pyx_v_k, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
   __Pyx_GIVEREF(__pyx_t_4);
   PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_4);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_t_1);
   __pyx_t_4 = 0;
   __pyx_t_1 = 0;
-  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_7);
   PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_7);
   __pyx_t_7 = 0;
-  __pyx_t_7 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(0, 42, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 42, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 42, __pyx_L1_error)
+  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 55, __pyx_L1_error)
   __pyx_t_12 = ((PyArrayObject *)__pyx_t_6);
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
     __pyx_t_5 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_t_12, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
     if (unlikely(__pyx_t_5 < 0)) {
       PyErr_Fetch(&__pyx_t_11, &__pyx_t_10, &__pyx_t_9);
@@ -4490,73 +5079,73 @@
         __Pyx_RaiseBufferFallbackError();
       } else {
         PyErr_Restore(__pyx_t_11, __pyx_t_10, __pyx_t_9);
       }
       __pyx_t_11 = __pyx_t_10 = __pyx_t_9 = 0;
     }
     __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
-    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 42, __pyx_L1_error)
+    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 55, __pyx_L1_error)
   }
   __pyx_t_12 = 0;
   __pyx_v_knn_indices = ((PyArrayObject *)__pyx_t_6);
   __pyx_t_6 = 0;
 
-  /* "druhg/_druhg_tree.pyx":44
+  /* "druhg/_druhg_tree.pyx":57
  *         knn_indices = np.zeros((self.data_size, k+1), dtype=np.intp)
  * 
  *         warning = 0             # <<<<<<<<<<<<<<
  * 
  *         i = self.data_size
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_v_warning = __pyx_int_0;
 
-  /* "druhg/_druhg_tree.pyx":46
+  /* "druhg/_druhg_tree.pyx":59
  *         warning = 0
  * 
  *         i = self.data_size             # <<<<<<<<<<<<<<
  *         while i:
  *             i -= 1
  */
-  __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 59, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __pyx_v_i = __pyx_t_6;
   __pyx_t_6 = 0;
 
-  /* "druhg/_druhg_tree.pyx":47
+  /* "druhg/_druhg_tree.pyx":60
  * 
  *         i = self.data_size
  *         while i:             # <<<<<<<<<<<<<<
  *             i -= 1
  *             row = self.data_arr.getrow(i)
  */
   while (1) {
-    __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_i); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 47, __pyx_L1_error)
+    __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_i); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 60, __pyx_L1_error)
     if (!__pyx_t_13) break;
 
-    /* "druhg/_druhg_tree.pyx":48
+    /* "druhg/_druhg_tree.pyx":61
  *         i = self.data_size
  *         while i:
  *             i -= 1             # <<<<<<<<<<<<<<
  *             row = self.data_arr.getrow(i)
  *             idx, data = row.indices, row.data
  */
-    __pyx_t_6 = __Pyx_PyInt_SubtractObjC(__pyx_v_i, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 48, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyInt_SubtractObjC(__pyx_v_i, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 61, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_DECREF_SET(__pyx_v_i, __pyx_t_6);
     __pyx_t_6 = 0;
 
-    /* "druhg/_druhg_tree.pyx":49
+    /* "druhg/_druhg_tree.pyx":62
  *         while i:
  *             i -= 1
  *             row = self.data_arr.getrow(i)             # <<<<<<<<<<<<<<
  *             idx, data = row.indices, row.data
  *             sorted = np.argsort(data)
  */
-    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->data_arr, __pyx_n_s_getrow); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 49, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->data_arr, __pyx_n_s_getrow); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 62, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __pyx_t_1 = NULL;
     __pyx_t_5 = 0;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_7))) {
       __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_7);
       if (likely(__pyx_t_1)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
@@ -4566,47 +5155,47 @@
         __pyx_t_5 = 1;
       }
     }
     {
       PyObject *__pyx_callargs[2] = {__pyx_t_1, __pyx_v_i};
       __pyx_t_6 = __Pyx_PyObject_FastCall(__pyx_t_7, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
       __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-      if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 49, __pyx_L1_error)
+      if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 62, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     }
     __Pyx_XDECREF_SET(__pyx_v_row, __pyx_t_6);
     __pyx_t_6 = 0;
 
-    /* "druhg/_druhg_tree.pyx":50
+    /* "druhg/_druhg_tree.pyx":63
  *             i -= 1
  *             row = self.data_arr.getrow(i)
  *             idx, data = row.indices, row.data             # <<<<<<<<<<<<<<
  *             sorted = np.argsort(data)
  *             j = min(k,len(idx))
  */
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_row, __pyx_n_s_indices); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 50, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_row, __pyx_n_s_indices); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 63, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_row, __pyx_n_s_data); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 50, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_row, __pyx_n_s_data); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 63, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_XDECREF_SET(__pyx_v_idx, __pyx_t_6);
     __pyx_t_6 = 0;
     __Pyx_XDECREF_SET(__pyx_v_data, __pyx_t_7);
     __pyx_t_7 = 0;
 
-    /* "druhg/_druhg_tree.pyx":51
+    /* "druhg/_druhg_tree.pyx":64
  *             row = self.data_arr.getrow(i)
  *             idx, data = row.indices, row.data
  *             sorted = np.argsort(data)             # <<<<<<<<<<<<<<
  *             j = min(k,len(idx))
  *             if idx[sorted[0]] != i:
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 51, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 64, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_argsort); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 51, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_argsort); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 64, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     __pyx_t_6 = NULL;
     __pyx_t_5 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
       __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
       if (likely(__pyx_t_6)) {
@@ -4617,305 +5206,305 @@
         __pyx_t_5 = 1;
       }
     }
     {
       PyObject *__pyx_callargs[2] = {__pyx_t_6, __pyx_v_data};
       __pyx_t_7 = __Pyx_PyObject_FastCall(__pyx_t_1, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-      if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 51, __pyx_L1_error)
+      if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 64, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_7);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     }
     __Pyx_XDECREF_SET(__pyx_v_sorted, __pyx_t_7);
     __pyx_t_7 = 0;
 
-    /* "druhg/_druhg_tree.pyx":52
+    /* "druhg/_druhg_tree.pyx":65
  *             idx, data = row.indices, row.data
  *             sorted = np.argsort(data)
  *             j = min(k,len(idx))             # <<<<<<<<<<<<<<
  *             if idx[sorted[0]] != i:
  *                 while j:
  */
-    __pyx_t_14 = PyObject_Length(__pyx_v_idx); if (unlikely(__pyx_t_14 == ((Py_ssize_t)-1))) __PYX_ERR(0, 52, __pyx_L1_error)
+    __pyx_t_14 = PyObject_Length(__pyx_v_idx); if (unlikely(__pyx_t_14 == ((Py_ssize_t)-1))) __PYX_ERR(0, 65, __pyx_L1_error)
     __Pyx_INCREF(__pyx_v_k);
     __pyx_t_7 = __pyx_v_k;
-    __pyx_t_6 = PyInt_FromSsize_t(__pyx_t_14); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 52, __pyx_L1_error)
+    __pyx_t_6 = PyInt_FromSsize_t(__pyx_t_14); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 65, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_2 = PyObject_RichCompare(__pyx_t_6, __pyx_t_7, Py_LT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 52, __pyx_L1_error)
+    __pyx_t_2 = PyObject_RichCompare(__pyx_t_6, __pyx_t_7, Py_LT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 65, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 52, __pyx_L1_error)
+    __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 65, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     if (__pyx_t_13) {
-      __pyx_t_2 = PyInt_FromSsize_t(__pyx_t_14); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 52, __pyx_L1_error)
+      __pyx_t_2 = PyInt_FromSsize_t(__pyx_t_14); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 65, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __pyx_t_1 = __pyx_t_2;
       __pyx_t_2 = 0;
     } else {
       __Pyx_INCREF(__pyx_t_7);
       __pyx_t_1 = __pyx_t_7;
     }
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     __pyx_t_7 = __pyx_t_1;
     __Pyx_INCREF(__pyx_t_7);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF_SET(__pyx_v_j, __pyx_t_7);
     __pyx_t_7 = 0;
 
-    /* "druhg/_druhg_tree.pyx":53
+    /* "druhg/_druhg_tree.pyx":66
  *             sorted = np.argsort(data)
  *             j = min(k,len(idx))
  *             if idx[sorted[0]] != i:             # <<<<<<<<<<<<<<
  *                 while j:
  *                     j -= 1
  */
-    __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_sorted, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 53, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_sorted, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 66, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_idx, __pyx_t_7); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 53, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_idx, __pyx_t_7); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 66, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __pyx_t_7 = PyObject_RichCompare(__pyx_t_1, __pyx_v_i, Py_NE); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 53, __pyx_L1_error)
+    __pyx_t_7 = PyObject_RichCompare(__pyx_t_1, __pyx_v_i, Py_NE); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 66, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 53, __pyx_L1_error)
+    __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 66, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     if (__pyx_t_13) {
 
-      /* "druhg/_druhg_tree.pyx":54
+      /* "druhg/_druhg_tree.pyx":67
  *             j = min(k,len(idx))
  *             if idx[sorted[0]] != i:
  *                 while j:             # <<<<<<<<<<<<<<
  *                     j -= 1
  *                     knn_dist[i][j+1] = data[sorted[j]]
  */
       while (1) {
-        __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_j); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 54, __pyx_L1_error)
+        __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_j); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 67, __pyx_L1_error)
         if (!__pyx_t_13) break;
 
-        /* "druhg/_druhg_tree.pyx":55
+        /* "druhg/_druhg_tree.pyx":68
  *             if idx[sorted[0]] != i:
  *                 while j:
  *                     j -= 1             # <<<<<<<<<<<<<<
  *                     knn_dist[i][j+1] = data[sorted[j]]
  *                     knn_indices[i][j+1] = idx[sorted[j]]
  */
-        __pyx_t_7 = __Pyx_PyInt_SubtractObjC(__pyx_v_j, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 55, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyInt_SubtractObjC(__pyx_v_j, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 68, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         __Pyx_DECREF_SET(__pyx_v_j, __pyx_t_7);
         __pyx_t_7 = 0;
 
-        /* "druhg/_druhg_tree.pyx":56
+        /* "druhg/_druhg_tree.pyx":69
  *                 while j:
  *                     j -= 1
  *                     knn_dist[i][j+1] = data[sorted[j]]             # <<<<<<<<<<<<<<
  *                     knn_indices[i][j+1] = idx[sorted[j]]
  *             else:
  */
-        __pyx_t_7 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 56, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 69, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_data, __pyx_t_7); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 56, __pyx_L1_error)
+        __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_data, __pyx_t_7); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 69, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_1);
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        __pyx_t_7 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 56, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 69, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_2 = __Pyx_PyInt_AddObjC(__pyx_v_j, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 56, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyInt_AddObjC(__pyx_v_j, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 69, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
-        if (unlikely((PyObject_SetItem(__pyx_t_7, __pyx_t_2, __pyx_t_1) < 0))) __PYX_ERR(0, 56, __pyx_L1_error)
+        if (unlikely((PyObject_SetItem(__pyx_t_7, __pyx_t_2, __pyx_t_1) < 0))) __PYX_ERR(0, 69, __pyx_L1_error)
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-        /* "druhg/_druhg_tree.pyx":57
+        /* "druhg/_druhg_tree.pyx":70
  *                     j -= 1
  *                     knn_dist[i][j+1] = data[sorted[j]]
  *                     knn_indices[i][j+1] = idx[sorted[j]]             # <<<<<<<<<<<<<<
  *             else:
  *                 # edge loops itself
  */
-        __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 57, __pyx_L1_error)
+        __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 70, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_1);
-        __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_v_idx, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 57, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_v_idx, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 70, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-        __pyx_t_1 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 57, __pyx_L1_error)
+        __pyx_t_1 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 70, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_1);
-        __pyx_t_7 = __Pyx_PyInt_AddObjC(__pyx_v_j, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 57, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyInt_AddObjC(__pyx_v_j, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 70, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        if (unlikely((PyObject_SetItem(__pyx_t_1, __pyx_t_7, __pyx_t_2) < 0))) __PYX_ERR(0, 57, __pyx_L1_error)
+        if (unlikely((PyObject_SetItem(__pyx_t_1, __pyx_t_7, __pyx_t_2) < 0))) __PYX_ERR(0, 70, __pyx_L1_error)
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       }
 
-      /* "druhg/_druhg_tree.pyx":53
+      /* "druhg/_druhg_tree.pyx":66
  *             sorted = np.argsort(data)
  *             j = min(k,len(idx))
  *             if idx[sorted[0]] != i:             # <<<<<<<<<<<<<<
  *                 while j:
  *                     j -= 1
  */
       goto __pyx_L5;
     }
 
-    /* "druhg/_druhg_tree.pyx":60
+    /* "druhg/_druhg_tree.pyx":73
  *             else:
  *                 # edge loops itself
  *                 warning += 1             # <<<<<<<<<<<<<<
  *                 while j:
  *                     j -= 1
  */
     /*else*/ {
-      __pyx_t_2 = __Pyx_PyInt_AddObjC(__pyx_v_warning, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 60, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyInt_AddObjC(__pyx_v_warning, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 73, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF_SET(__pyx_v_warning, __pyx_t_2);
       __pyx_t_2 = 0;
 
-      /* "druhg/_druhg_tree.pyx":61
+      /* "druhg/_druhg_tree.pyx":74
  *                 # edge loops itself
  *                 warning += 1
  *                 while j:             # <<<<<<<<<<<<<<
  *                     j -= 1
  *                     knn_dist[i][j] = data[sorted[j]]
  */
       while (1) {
-        __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_j); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 61, __pyx_L1_error)
+        __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_j); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 74, __pyx_L1_error)
         if (!__pyx_t_13) break;
 
-        /* "druhg/_druhg_tree.pyx":62
+        /* "druhg/_druhg_tree.pyx":75
  *                 warning += 1
  *                 while j:
  *                     j -= 1             # <<<<<<<<<<<<<<
  *                     knn_dist[i][j] = data[sorted[j]]
  *                     knn_indices[i][j] = idx[sorted[j]]
  */
-        __pyx_t_2 = __Pyx_PyInt_SubtractObjC(__pyx_v_j, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 62, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyInt_SubtractObjC(__pyx_v_j, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 75, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         __Pyx_DECREF_SET(__pyx_v_j, __pyx_t_2);
         __pyx_t_2 = 0;
 
-        /* "druhg/_druhg_tree.pyx":63
+        /* "druhg/_druhg_tree.pyx":76
  *                 while j:
  *                     j -= 1
  *                     knn_dist[i][j] = data[sorted[j]]             # <<<<<<<<<<<<<<
  *                     knn_indices[i][j] = idx[sorted[j]]
  * 
  */
-        __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 63, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 76, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_7 = __Pyx_PyObject_GetItem(__pyx_v_data, __pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 63, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyObject_GetItem(__pyx_v_data, __pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 76, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __pyx_t_2 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 63, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 76, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
-        if (unlikely((PyObject_SetItem(__pyx_t_2, __pyx_v_j, __pyx_t_7) < 0))) __PYX_ERR(0, 63, __pyx_L1_error)
+        if (unlikely((PyObject_SetItem(__pyx_t_2, __pyx_v_j, __pyx_t_7) < 0))) __PYX_ERR(0, 76, __pyx_L1_error)
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-        /* "druhg/_druhg_tree.pyx":64
+        /* "druhg/_druhg_tree.pyx":77
  *                     j -= 1
  *                     knn_dist[i][j] = data[sorted[j]]
  *                     knn_indices[i][j] = idx[sorted[j]]             # <<<<<<<<<<<<<<
  * 
  *             knn_dist[i][0], knn_indices[i][0] = 0., i # have to add itself. Edge to itself have to be zero!
  */
-        __pyx_t_7 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 64, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 77, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_v_idx, __pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 64, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_v_idx, __pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 77, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        __pyx_t_7 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 64, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 77, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        if (unlikely((PyObject_SetItem(__pyx_t_7, __pyx_v_j, __pyx_t_2) < 0))) __PYX_ERR(0, 64, __pyx_L1_error)
+        if (unlikely((PyObject_SetItem(__pyx_t_7, __pyx_v_j, __pyx_t_2) < 0))) __PYX_ERR(0, 77, __pyx_L1_error)
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       }
     }
     __pyx_L5:;
 
-    /* "druhg/_druhg_tree.pyx":66
+    /* "druhg/_druhg_tree.pyx":79
  *                     knn_indices[i][j] = idx[sorted[j]]
  * 
  *             knn_dist[i][0], knn_indices[i][0] = 0., i # have to add itself. Edge to itself have to be zero!             # <<<<<<<<<<<<<<
  * 
  *         if warning:
  */
     __pyx_t_2 = __pyx_float_0_;
     __Pyx_INCREF(__pyx_t_2);
     __pyx_t_7 = __pyx_v_i;
     __Pyx_INCREF(__pyx_t_7);
-    __pyx_t_1 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 66, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 79, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    if (unlikely((__Pyx_SetItemInt(__pyx_t_1, 0, __pyx_t_2, long, 1, __Pyx_PyInt_From_long, 0, 0, 0) < 0))) __PYX_ERR(0, 66, __pyx_L1_error)
+    if (unlikely((__Pyx_SetItemInt(__pyx_t_1, 0, __pyx_t_2, long, 1, __Pyx_PyInt_From_long, 0, 0, 0) < 0))) __PYX_ERR(0, 79, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 66, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 79, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    if (unlikely((__Pyx_SetItemInt(__pyx_t_2, 0, __pyx_t_7, long, 1, __Pyx_PyInt_From_long, 0, 0, 0) < 0))) __PYX_ERR(0, 66, __pyx_L1_error)
+    if (unlikely((__Pyx_SetItemInt(__pyx_t_2, 0, __pyx_t_7, long, 1, __Pyx_PyInt_From_long, 0, 0, 0) < 0))) __PYX_ERR(0, 79, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
   }
 
-  /* "druhg/_druhg_tree.pyx":68
+  /* "druhg/_druhg_tree.pyx":81
  *             knn_dist[i][0], knn_indices[i][0] = 0., i # have to add itself. Edge to itself have to be zero!
  * 
  *         if warning:             # <<<<<<<<<<<<<<
  *             print ('Attention!: Sparse matrix has an edge that forms a loop! They were zeroed.', warning)
  * 
  */
-  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_warning); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 68, __pyx_L1_error)
+  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_v_warning); if (unlikely((__pyx_t_13 < 0))) __PYX_ERR(0, 81, __pyx_L1_error)
   if (__pyx_t_13) {
 
-    /* "druhg/_druhg_tree.pyx":69
+    /* "druhg/_druhg_tree.pyx":82
  * 
  *         if warning:
  *             print ('Attention!: Sparse matrix has an edge that forms a loop! They were zeroed.', warning)             # <<<<<<<<<<<<<<
  * 
  *         return knn_dist, knn_indices
  */
-    __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 69, __pyx_L1_error)
+    __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 82, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_INCREF(__pyx_kp_u_Attention_Sparse_matrix_has_an_e);
     __Pyx_GIVEREF(__pyx_kp_u_Attention_Sparse_matrix_has_an_e);
     PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_kp_u_Attention_Sparse_matrix_has_an_e);
     __Pyx_INCREF(__pyx_v_warning);
     __Pyx_GIVEREF(__pyx_v_warning);
     PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_v_warning);
-    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_7, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 69, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_7, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 82, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-    /* "druhg/_druhg_tree.pyx":68
+    /* "druhg/_druhg_tree.pyx":81
  *             knn_dist[i][0], knn_indices[i][0] = 0., i # have to add itself. Edge to itself have to be zero!
  * 
  *         if warning:             # <<<<<<<<<<<<<<
  *             print ('Attention!: Sparse matrix has an edge that forms a loop! They were zeroed.', warning)
  * 
  */
   }
 
-  /* "druhg/_druhg_tree.pyx":71
+  /* "druhg/_druhg_tree.pyx":84
  *             print ('Attention!: Sparse matrix has an edge that forms a loop! They were zeroed.', warning)
  * 
  *         return knn_dist, knn_indices             # <<<<<<<<<<<<<<
  * 
  * cdef class PairwiseDistanceTreeGeneric(object):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 71, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 84, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_INCREF((PyObject *)__pyx_v_knn_dist);
   __Pyx_GIVEREF((PyObject *)__pyx_v_knn_dist);
   PyTuple_SET_ITEM(__pyx_t_2, 0, ((PyObject *)__pyx_v_knn_dist));
   __Pyx_INCREF((PyObject *)__pyx_v_knn_indices);
   __Pyx_GIVEREF((PyObject *)__pyx_v_knn_indices);
   PyTuple_SET_ITEM(__pyx_t_2, 1, ((PyObject *)__pyx_v_knn_indices));
   __pyx_r = ((PyObject*)__pyx_t_2);
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_tree.pyx":35
+  /* "druhg/_druhg_tree.pyx":48
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         # TODO: actually we need to consider replacing INF with something else.
  *         # Reciprocity of absent link is not the same as the INF. Do reciprocity with graphs!
  */
 
@@ -5008,41 +5597,41 @@
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
         if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_d)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 35, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 48, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_k)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 35, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 48, __pyx_L3_error)
         else {
-          __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, 1); __PYX_ERR(0, 35, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, 1); __PYX_ERR(0, 48, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_dualtree);
           if (value) { values[2] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 35, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 48, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_breadth_first);
           if (value) { values[3] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 35, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 48, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "query") < 0)) __PYX_ERR(0, 35, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "query") < 0)) __PYX_ERR(0, 48, __pyx_L3_error)
       }
     } else {
       switch (__pyx_nargs) {
         case  4: values[3] = __Pyx_Arg_FASTCALL(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
         case  3: values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
@@ -5055,15 +5644,15 @@
     __pyx_v_d = values[0];
     __pyx_v_k = values[1];
     __pyx_v_dualtree = values[2];
     __pyx_v_breadth_first = values[3];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, __pyx_nargs); __PYX_ERR(0, 35, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, __pyx_nargs); __PYX_ERR(0, 48, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.PairwiseDistanceTreeSparse.query", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_2query(((struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *)__pyx_v_self), __pyx_v_d, __pyx_v_k, __pyx_v_dualtree, __pyx_v_breadth_first);
 
@@ -5081,15 +5670,15 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("query", 0);
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_2.__pyx_n = 2;
   __pyx_t_2.dualtree = __pyx_v_dualtree;
   __pyx_t_2.breadth_first = __pyx_v_breadth_first;
-  __pyx_t_1 = __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->query(__pyx_v_self, __pyx_v_d, __pyx_v_k, 1, &__pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 35, __pyx_L1_error)
+  __pyx_t_1 = __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->query(__pyx_v_self, __pyx_v_d, __pyx_v_k, 1, &__pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 48, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
@@ -5478,15 +6067,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":77
+/* "druhg/_druhg_tree.pyx":90
  *     cdef int data_size
  * 
  *     def __init__(self, N, d):             # <<<<<<<<<<<<<<
  *         self.data_size = N
  *         self.data_arr = d
  */
 
@@ -5520,40 +6109,40 @@
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_VARARGS(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
         if (likely((values[0] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_N)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 77, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 90, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_d)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 77, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 90, __pyx_L3_error)
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, 1); __PYX_ERR(0, 77, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, 1); __PYX_ERR(0, 90, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 77, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 90, __pyx_L3_error)
       }
     } else if (unlikely(__pyx_nargs != 2)) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
       values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
     }
     __pyx_v_N = values[0];
     __pyx_v_d = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, __pyx_nargs); __PYX_ERR(0, 77, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 1, 2, 2, __pyx_nargs); __PYX_ERR(0, 90, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.PairwiseDistanceTreeGeneric.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric___init__(((struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *)__pyx_v_self), __pyx_v_N, __pyx_v_d);
 
@@ -5567,38 +6156,38 @@
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "druhg/_druhg_tree.pyx":78
+  /* "druhg/_druhg_tree.pyx":91
  * 
  *     def __init__(self, N, d):
  *         self.data_size = N             # <<<<<<<<<<<<<<
  *         self.data_arr = d
  * 
  */
-  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_N); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 78, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_N); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 91, __pyx_L1_error)
   __pyx_v_self->data_size = __pyx_t_1;
 
-  /* "druhg/_druhg_tree.pyx":79
+  /* "druhg/_druhg_tree.pyx":92
  *     def __init__(self, N, d):
  *         self.data_size = N
  *         self.data_arr = d             # <<<<<<<<<<<<<<
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):
  */
   __Pyx_INCREF(__pyx_v_d);
   __Pyx_GIVEREF(__pyx_v_d);
   __Pyx_GOTREF(__pyx_v_self->data_arr);
   __Pyx_DECREF(__pyx_v_self->data_arr);
   __pyx_v_self->data_arr = __pyx_v_d;
 
-  /* "druhg/_druhg_tree.pyx":77
+  /* "druhg/_druhg_tree.pyx":90
  *     cdef int data_size
  * 
  *     def __init__(self, N, d):             # <<<<<<<<<<<<<<
  *         self.data_size = N
  *         self.data_arr = d
  */
 
@@ -5609,15 +6198,15 @@
   __Pyx_AddTraceback("druhg._druhg_tree.PairwiseDistanceTreeGeneric.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":81
+/* "druhg/_druhg_tree.pyx":94
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         cdef np.ndarray[np.double_t, ndim=2] knn_dist
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  */
 
@@ -5680,15 +6269,15 @@
   /* Check if overridden in Python */
   else if (unlikely((Py_TYPE(((PyObject *)__pyx_v_self))->tp_dictoffset != 0) || __Pyx_PyType_HasFeature(Py_TYPE(((PyObject *)__pyx_v_self)), (Py_TPFLAGS_IS_ABSTRACT | Py_TPFLAGS_HEAPTYPE)))) {
     #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     static PY_UINT64_T __pyx_tp_dict_version = __PYX_DICT_VERSION_INIT, __pyx_obj_dict_version = __PYX_DICT_VERSION_INIT;
     if (unlikely(!__Pyx_object_dict_version_matches(((PyObject *)__pyx_v_self), __pyx_tp_dict_version, __pyx_obj_dict_version))) {
       PY_UINT64_T __pyx_typedict_guard = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
       #endif
-      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_query); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 81, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_query); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 94, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       #ifdef __Pyx_CyFunction_USED
       if (!__Pyx_IsCyOrPyCFunction(__pyx_t_1)
       #else
       if (!PyCFunction_Check(__pyx_t_1)
       #endif
               || (PyCFunction_GET_FUNCTION(__pyx_t_1) != (PyCFunction)(void*)__pyx_pw_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_3query)) {
@@ -5706,19 +6295,19 @@
             __pyx_t_5 = 1;
           }
         }
         {
           PyObject *__pyx_callargs[5] = {__pyx_t_4, __pyx_v_d, __pyx_v_k, __pyx_v_dualtree, __pyx_v_breadth_first};
           __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 4+__pyx_t_5);
           __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 81, __pyx_L1_error)
+          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 94, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         }
-        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 81, __pyx_L1_error)
+        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 94, __pyx_L1_error)
         __pyx_r = ((PyObject*)__pyx_t_2);
         __pyx_t_2 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         goto __pyx_L0;
       }
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
       __pyx_tp_dict_version = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
@@ -5729,29 +6318,29 @@
       #endif
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     }
     #endif
   }
 
-  /* "druhg/_druhg_tree.pyx":85
+  /* "druhg/_druhg_tree.pyx":98
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  * 
  *         knn_dist = np.zeros((self.data_size, k))             # <<<<<<<<<<<<<<
  *         knn_indices = np.zeros((self.data_size, k), dtype=np.intp)
  * 
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 85, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 98, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 85, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 98, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 85, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 98, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 85, __pyx_L1_error)
+  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 98, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
   __Pyx_INCREF(__pyx_v_k);
   __Pyx_GIVEREF(__pyx_v_k);
   PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_v_k);
   __pyx_t_2 = 0;
@@ -5768,19 +6357,19 @@
     }
   }
   {
     PyObject *__pyx_callargs[2] = {__pyx_t_2, __pyx_t_4};
     __pyx_t_1 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 85, __pyx_L1_error)
+    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 98, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   }
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 85, __pyx_L1_error)
+  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 98, __pyx_L1_error)
   __pyx_t_6 = ((PyArrayObject *)__pyx_t_1);
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
     __pyx_t_5 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
     if (unlikely(__pyx_t_5 < 0)) {
       PyErr_Fetch(&__pyx_t_7, &__pyx_t_8, &__pyx_t_9);
@@ -5789,62 +6378,62 @@
         __Pyx_RaiseBufferFallbackError();
       } else {
         PyErr_Restore(__pyx_t_7, __pyx_t_8, __pyx_t_9);
       }
       __pyx_t_7 = __pyx_t_8 = __pyx_t_9 = 0;
     }
     __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
-    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 85, __pyx_L1_error)
+    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 98, __pyx_L1_error)
   }
   __pyx_t_6 = 0;
   __pyx_v_knn_dist = ((PyArrayObject *)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_tree.pyx":86
+  /* "druhg/_druhg_tree.pyx":99
  * 
  *         knn_dist = np.zeros((self.data_size, k))
  *         knn_indices = np.zeros((self.data_size, k), dtype=np.intp)             # <<<<<<<<<<<<<<
  * 
  *         i = self.data_size
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
   __Pyx_INCREF(__pyx_v_k);
   __Pyx_GIVEREF(__pyx_v_k);
   PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_v_k);
   __pyx_t_1 = 0;
-  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_4);
   PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4);
   __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_intp); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_intp); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_10);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_10) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_10) < 0) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-  __pyx_t_10 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 86, __pyx_L1_error)
+  __pyx_t_10 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 99, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_10);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (!(likely(((__pyx_t_10) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_10, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 86, __pyx_L1_error)
+  if (!(likely(((__pyx_t_10) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_10, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 99, __pyx_L1_error)
   __pyx_t_11 = ((PyArrayObject *)__pyx_t_10);
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
     __pyx_t_5 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_t_11, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
     if (unlikely(__pyx_t_5 < 0)) {
       PyErr_Fetch(&__pyx_t_9, &__pyx_t_8, &__pyx_t_7);
@@ -5853,77 +6442,77 @@
         __Pyx_RaiseBufferFallbackError();
       } else {
         PyErr_Restore(__pyx_t_9, __pyx_t_8, __pyx_t_7);
       }
       __pyx_t_9 = __pyx_t_8 = __pyx_t_7 = 0;
     }
     __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
-    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 86, __pyx_L1_error)
+    if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 99, __pyx_L1_error)
   }
   __pyx_t_11 = 0;
   __pyx_v_knn_indices = ((PyArrayObject *)__pyx_t_10);
   __pyx_t_10 = 0;
 
-  /* "druhg/_druhg_tree.pyx":88
+  /* "druhg/_druhg_tree.pyx":101
  *         knn_indices = np.zeros((self.data_size, k), dtype=np.intp)
  * 
  *         i = self.data_size             # <<<<<<<<<<<<<<
  *         while i:
  *             i -= 1
  */
-  __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 88, __pyx_L1_error)
+  __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_self->data_size); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 101, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_10);
   __pyx_v_i = __pyx_t_10;
   __pyx_t_10 = 0;
 
-  /* "druhg/_druhg_tree.pyx":89
+  /* "druhg/_druhg_tree.pyx":102
  * 
  *         i = self.data_size
  *         while i:             # <<<<<<<<<<<<<<
  *             i -= 1
  *             row = self.data_arr[i]
  */
   while (1) {
-    __pyx_t_12 = __Pyx_PyObject_IsTrue(__pyx_v_i); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 89, __pyx_L1_error)
+    __pyx_t_12 = __Pyx_PyObject_IsTrue(__pyx_v_i); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 102, __pyx_L1_error)
     if (!__pyx_t_12) break;
 
-    /* "druhg/_druhg_tree.pyx":90
+    /* "druhg/_druhg_tree.pyx":103
  *         i = self.data_size
  *         while i:
  *             i -= 1             # <<<<<<<<<<<<<<
  *             row = self.data_arr[i]
  *             sorted = np.argsort(row)
  */
-    __pyx_t_10 = __Pyx_PyInt_SubtractObjC(__pyx_v_i, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 90, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_PyInt_SubtractObjC(__pyx_v_i, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 103, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
     __Pyx_DECREF_SET(__pyx_v_i, __pyx_t_10);
     __pyx_t_10 = 0;
 
-    /* "druhg/_druhg_tree.pyx":91
+    /* "druhg/_druhg_tree.pyx":104
  *         while i:
  *             i -= 1
  *             row = self.data_arr[i]             # <<<<<<<<<<<<<<
  *             sorted = np.argsort(row)
  *             j = k
  */
-    __pyx_t_10 = __Pyx_PyObject_GetItem(__pyx_v_self->data_arr, __pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 91, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_PyObject_GetItem(__pyx_v_self->data_arr, __pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 104, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
     __Pyx_XDECREF_SET(__pyx_v_row, __pyx_t_10);
     __pyx_t_10 = 0;
 
-    /* "druhg/_druhg_tree.pyx":92
+    /* "druhg/_druhg_tree.pyx":105
  *             i -= 1
  *             row = self.data_arr[i]
  *             sorted = np.argsort(row)             # <<<<<<<<<<<<<<
  *             j = k
  *             while j:
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 92, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 105, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_argsort); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 92, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_argsort); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 105, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __pyx_t_4 = NULL;
     __pyx_t_5 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
       __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
       if (likely(__pyx_t_4)) {
@@ -5934,110 +6523,110 @@
         __pyx_t_5 = 1;
       }
     }
     {
       PyObject *__pyx_callargs[2] = {__pyx_t_4, __pyx_v_row};
       __pyx_t_10 = __Pyx_PyObject_FastCall(__pyx_t_1, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
       __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-      if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 92, __pyx_L1_error)
+      if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 105, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     }
     __Pyx_XDECREF_SET(__pyx_v_sorted, __pyx_t_10);
     __pyx_t_10 = 0;
 
-    /* "druhg/_druhg_tree.pyx":93
+    /* "druhg/_druhg_tree.pyx":106
  *             row = self.data_arr[i]
  *             sorted = np.argsort(row)
  *             j = k             # <<<<<<<<<<<<<<
  *             while j:
  *                 j -= 1
  */
     __Pyx_INCREF(__pyx_v_k);
     __Pyx_XDECREF_SET(__pyx_v_j, __pyx_v_k);
 
-    /* "druhg/_druhg_tree.pyx":94
+    /* "druhg/_druhg_tree.pyx":107
  *             sorted = np.argsort(row)
  *             j = k
  *             while j:             # <<<<<<<<<<<<<<
  *                 j -= 1
  *                 knn_dist[i][j] = row[sorted[j]]
  */
     while (1) {
-      __pyx_t_12 = __Pyx_PyObject_IsTrue(__pyx_v_j); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 94, __pyx_L1_error)
+      __pyx_t_12 = __Pyx_PyObject_IsTrue(__pyx_v_j); if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 107, __pyx_L1_error)
       if (!__pyx_t_12) break;
 
-      /* "druhg/_druhg_tree.pyx":95
+      /* "druhg/_druhg_tree.pyx":108
  *             j = k
  *             while j:
  *                 j -= 1             # <<<<<<<<<<<<<<
  *                 knn_dist[i][j] = row[sorted[j]]
  *                 knn_indices[i][j] = sorted[j]
  */
-      __pyx_t_10 = __Pyx_PyInt_SubtractObjC(__pyx_v_j, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 95, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyInt_SubtractObjC(__pyx_v_j, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 108, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
       __Pyx_DECREF_SET(__pyx_v_j, __pyx_t_10);
       __pyx_t_10 = 0;
 
-      /* "druhg/_druhg_tree.pyx":96
+      /* "druhg/_druhg_tree.pyx":109
  *             while j:
  *                 j -= 1
  *                 knn_dist[i][j] = row[sorted[j]]             # <<<<<<<<<<<<<<
  *                 knn_indices[i][j] = sorted[j]
  * 
  */
-      __pyx_t_10 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 96, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 109, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_row, __pyx_t_10); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 96, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_row, __pyx_t_10); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 109, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __pyx_t_10 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 96, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_dist), __pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 109, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      if (unlikely((PyObject_SetItem(__pyx_t_10, __pyx_v_j, __pyx_t_1) < 0))) __PYX_ERR(0, 96, __pyx_L1_error)
+      if (unlikely((PyObject_SetItem(__pyx_t_10, __pyx_v_j, __pyx_t_1) < 0))) __PYX_ERR(0, 109, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-      /* "druhg/_druhg_tree.pyx":97
+      /* "druhg/_druhg_tree.pyx":110
  *                 j -= 1
  *                 knn_dist[i][j] = row[sorted[j]]
  *                 knn_indices[i][j] = sorted[j]             # <<<<<<<<<<<<<<
  * 
  *         return knn_dist, knn_indices
  */
-      __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 97, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_sorted, __pyx_v_j); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 110, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_10 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 97, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_knn_indices), __pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 110, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      if (unlikely((PyObject_SetItem(__pyx_t_10, __pyx_v_j, __pyx_t_1) < 0))) __PYX_ERR(0, 97, __pyx_L1_error)
+      if (unlikely((PyObject_SetItem(__pyx_t_10, __pyx_v_j, __pyx_t_1) < 0))) __PYX_ERR(0, 110, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     }
   }
 
-  /* "druhg/_druhg_tree.pyx":99
+  /* "druhg/_druhg_tree.pyx":112
  *                 knn_indices[i][j] = sorted[j]
  * 
  *         return knn_dist, knn_indices             # <<<<<<<<<<<<<<
  * 
- * cdef class UnionFind (object):
+ * 
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 112, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF((PyObject *)__pyx_v_knn_dist);
   __Pyx_GIVEREF((PyObject *)__pyx_v_knn_dist);
   PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_knn_dist));
   __Pyx_INCREF((PyObject *)__pyx_v_knn_indices);
   __Pyx_GIVEREF((PyObject *)__pyx_v_knn_indices);
   PyTuple_SET_ITEM(__pyx_t_1, 1, ((PyObject *)__pyx_v_knn_indices));
   __pyx_r = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_tree.pyx":81
+  /* "druhg/_druhg_tree.pyx":94
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         cdef np.ndarray[np.double_t, ndim=2] knn_dist
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  */
 
@@ -6126,41 +6715,41 @@
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
         if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_d)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 81, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 94, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_k)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 81, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 94, __pyx_L3_error)
         else {
-          __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, 1); __PYX_ERR(0, 81, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, 1); __PYX_ERR(0, 94, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_dualtree);
           if (value) { values[2] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 81, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 94, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_breadth_first);
           if (value) { values[3] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 81, __pyx_L3_error)
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 94, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "query") < 0)) __PYX_ERR(0, 81, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "query") < 0)) __PYX_ERR(0, 94, __pyx_L3_error)
       }
     } else {
       switch (__pyx_nargs) {
         case  4: values[3] = __Pyx_Arg_FASTCALL(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
         case  3: values[2] = __Pyx_Arg_FASTCALL(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
@@ -6173,15 +6762,15 @@
     __pyx_v_d = values[0];
     __pyx_v_k = values[1];
     __pyx_v_dualtree = values[2];
     __pyx_v_breadth_first = values[3];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, __pyx_nargs); __PYX_ERR(0, 81, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("query", 0, 2, 4, __pyx_nargs); __PYX_ERR(0, 94, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.PairwiseDistanceTreeGeneric.query", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_2query(((struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *)__pyx_v_self), __pyx_v_d, __pyx_v_k, __pyx_v_dualtree, __pyx_v_breadth_first);
 
@@ -6199,15 +6788,15 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("query", 0);
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_2.__pyx_n = 2;
   __pyx_t_2.dualtree = __pyx_v_dualtree;
   __pyx_t_2.breadth_first = __pyx_v_breadth_first;
-  __pyx_t_1 = __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->query(__pyx_v_self, __pyx_v_d, __pyx_v_k, 1, &__pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 81, __pyx_L1_error)
+  __pyx_t_1 = __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->query(__pyx_v_self, __pyx_v_d, __pyx_v_k, 1, &__pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 94, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
@@ -6596,615 +7185,79 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":108
- *         np.intp_t next_label
+/* "druhg/_druhg_tree.pyx":169
+ *         public np.ndarray knn_i
  * 
- *     def __init__(self, np.intp_t N):             # <<<<<<<<<<<<<<
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)
- *         self.parent = (<np.intp_t *> self.parent_arr.data)
- */
-
-/* Python wrapper */
-static int __pyx_pw_5druhg_11_druhg_tree_9UnionFind_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_5druhg_11_druhg_tree_9UnionFind_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  __pyx_t_5numpy_intp_t __pyx_v_N;
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  int __pyx_r;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
-  {
-    #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,0};
-    #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_N,0};
-    #endif
-    PyObject* values[1] = {0};
-    if (__pyx_kwds) {
-      Py_ssize_t kw_args;
-      switch (__pyx_nargs) {
-        case  1: values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
-        CYTHON_FALLTHROUGH;
-        case  0: break;
-        default: goto __pyx_L5_argtuple_error;
-      }
-      kw_args = __Pyx_NumKwargs_VARARGS(__pyx_kwds);
-      switch (__pyx_nargs) {
-        case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_N)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 108, __pyx_L3_error)
-        else goto __pyx_L5_argtuple_error;
-      }
-      if (unlikely(kw_args > 0)) {
-        const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 108, __pyx_L3_error)
-      }
-    } else if (unlikely(__pyx_nargs != 1)) {
-      goto __pyx_L5_argtuple_error;
-    } else {
-      values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
-    }
-    __pyx_v_N = __Pyx_PyIndex_AsSsize_t(values[0]); if (unlikely((__pyx_v_N == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 108, __pyx_L3_error)
-  }
-  goto __pyx_L4_argument_unpacking_done;
-  __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 1, 1, 1, __pyx_nargs); __PYX_ERR(0, 108, __pyx_L3_error)
-  __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_tree.UnionFind.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __Pyx_RefNannyFinishContext();
-  return -1;
-  __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_9UnionFind___init__(((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self), __pyx_v_N);
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static int __pyx_pf_5druhg_11_druhg_tree_9UnionFind___init__(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_N) {
-  int __pyx_r;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  PyObject *__pyx_t_4 = NULL;
-  PyObject *__pyx_t_5 = NULL;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__init__", 0);
-
-  /* "druhg/_druhg_tree.pyx":109
- * 
- *     def __init__(self, np.intp_t N):
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)             # <<<<<<<<<<<<<<
- *         self.parent = (<np.intp_t *> self.parent_arr.data)
- *         self.next_label = N + 1
- */
-  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = PyInt_FromSsize_t((2 * __pyx_v_N)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_1);
-  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
-  __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_intp); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GIVEREF(__pyx_t_5);
-  __Pyx_GOTREF((PyObject *)__pyx_v_self->parent_arr);
-  __Pyx_DECREF((PyObject *)__pyx_v_self->parent_arr);
-  __pyx_v_self->parent_arr = ((PyArrayObject *)__pyx_t_5);
-  __pyx_t_5 = 0;
-
-  /* "druhg/_druhg_tree.pyx":110
- *     def __init__(self, np.intp_t N):
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)
- *         self.parent = (<np.intp_t *> self.parent_arr.data)             # <<<<<<<<<<<<<<
- *         self.next_label = N + 1
- * 
- */
-  __pyx_t_5 = ((PyObject *)__pyx_v_self->parent_arr);
-  __Pyx_INCREF(__pyx_t_5);
-  __pyx_v_self->parent = ((__pyx_t_5numpy_intp_t *)__pyx_f_5numpy_7ndarray_4data_data(((PyArrayObject *)__pyx_t_5)));
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-
-  /* "druhg/_druhg_tree.pyx":111
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)
- *         self.parent = (<np.intp_t *> self.parent_arr.data)
- *         self.next_label = N + 1             # <<<<<<<<<<<<<<
- * 
- *     cdef np.intp_t fast_find(self, np.intp_t n):
- */
-  __pyx_v_self->next_label = (__pyx_v_N + 1);
-
-  /* "druhg/_druhg_tree.pyx":108
- *         np.intp_t next_label
- * 
- *     def __init__(self, np.intp_t N):             # <<<<<<<<<<<<<<
- *         self.parent_arr = np.zeros(2 * N, dtype=np.intp)
- *         self.parent = (<np.intp_t *> self.parent_arr.data)
- */
-
-  /* function exit code */
-  __pyx_r = 0;
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_4);
-  __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_AddTraceback("druhg._druhg_tree.UnionFind.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = -1;
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_tree.pyx":113
- *         self.next_label = N + 1
- * 
- *     cdef np.intp_t fast_find(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp
- * 
- */
-
-static __pyx_t_5numpy_intp_t __pyx_f_5druhg_11_druhg_tree_9UnionFind_fast_find(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_n) {
-  __pyx_t_5numpy_intp_t __pyx_v_p;
-  __pyx_t_5numpy_intp_t __pyx_v_temp;
-  __pyx_t_5numpy_intp_t __pyx_r;
-  __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  __Pyx_RefNannySetupContext("fast_find", 0);
-
-  /* "druhg/_druhg_tree.pyx":116
- *         cdef np.intp_t p, temp
- * 
- *         p = self.parent[n]             # <<<<<<<<<<<<<<
- *         if p == 0:
- *             return n
- */
-  __pyx_v_p = (__pyx_v_self->parent[__pyx_v_n]);
-
-  /* "druhg/_druhg_tree.pyx":117
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return n
- *         while self.parent[p] != 0:
- */
-  __pyx_t_1 = ((__pyx_v_p == 0) != 0);
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_tree.pyx":118
- *         p = self.parent[n]
- *         if p == 0:
- *             return n             # <<<<<<<<<<<<<<
- *         while self.parent[p] != 0:
- *             p = self.parent[p]
- */
-    __pyx_r = __pyx_v_n;
-    goto __pyx_L0;
-
-    /* "druhg/_druhg_tree.pyx":117
- * 
- *         p = self.parent[n]
- *         if p == 0:             # <<<<<<<<<<<<<<
- *             return n
- *         while self.parent[p] != 0:
- */
-  }
-
-  /* "druhg/_druhg_tree.pyx":119
- *         if p == 0:
- *             return n
- *         while self.parent[p] != 0:             # <<<<<<<<<<<<<<
- *             p = self.parent[p]
- * 
- */
-  while (1) {
-    __pyx_t_1 = (((__pyx_v_self->parent[__pyx_v_p]) != 0) != 0);
-    if (!__pyx_t_1) break;
-
-    /* "druhg/_druhg_tree.pyx":120
- *             return n
- *         while self.parent[p] != 0:
- *             p = self.parent[p]             # <<<<<<<<<<<<<<
- * 
- *         # label up to the root
- */
-    __pyx_v_p = (__pyx_v_self->parent[__pyx_v_p]);
-  }
-
-  /* "druhg/_druhg_tree.pyx":123
- * 
- *         # label up to the root
- *         while p != n:             # <<<<<<<<<<<<<<
- *             temp = self.parent[n]
- *             self.parent[n] = p
- */
-  while (1) {
-    __pyx_t_1 = ((__pyx_v_p != __pyx_v_n) != 0);
-    if (!__pyx_t_1) break;
-
-    /* "druhg/_druhg_tree.pyx":124
- *         # label up to the root
- *         while p != n:
- *             temp = self.parent[n]             # <<<<<<<<<<<<<<
- *             self.parent[n] = p
- *             n = temp
- */
-    __pyx_v_temp = (__pyx_v_self->parent[__pyx_v_n]);
-
-    /* "druhg/_druhg_tree.pyx":125
- *         while p != n:
- *             temp = self.parent[n]
- *             self.parent[n] = p             # <<<<<<<<<<<<<<
- *             n = temp
- * 
- */
-    (__pyx_v_self->parent[__pyx_v_n]) = __pyx_v_p;
-
-    /* "druhg/_druhg_tree.pyx":126
- *             temp = self.parent[n]
- *             self.parent[n] = p
- *             n = temp             # <<<<<<<<<<<<<<
- * 
- *         return p
- */
-    __pyx_v_n = __pyx_v_temp;
-  }
-
-  /* "druhg/_druhg_tree.pyx":128
- *             n = temp
- * 
- *         return p             # <<<<<<<<<<<<<<
- * 
- *     # cdef np.intp_t is_cluster(self, np.intp_t n):
- */
-  __pyx_r = __pyx_v_p;
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_tree.pyx":113
- *         self.next_label = N + 1
- * 
- *     cdef np.intp_t fast_find(self, np.intp_t n):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t p, temp
- * 
- */
-
-  /* function exit code */
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_tree.pyx":133
- *     #     return self.parent[n]
- * 
- *     cdef void union(self, np.intp_t aa, np.intp_t bb):             # <<<<<<<<<<<<<<
- *         aa, bb = self.fast_find(aa), self.fast_find(bb)
- * 
- */
-
-static void __pyx_f_5druhg_11_druhg_tree_9UnionFind_union(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_aa, __pyx_t_5numpy_intp_t __pyx_v_bb) {
-  __Pyx_RefNannyDeclarations
-  __pyx_t_5numpy_intp_t __pyx_t_1;
-  __pyx_t_5numpy_intp_t __pyx_t_2;
-  __Pyx_RefNannySetupContext("union", 0);
-
-  /* "druhg/_druhg_tree.pyx":134
- * 
- *     cdef void union(self, np.intp_t aa, np.intp_t bb):
- *         aa, bb = self.fast_find(aa), self.fast_find(bb)             # <<<<<<<<<<<<<<
- * 
- *         self.parent[aa] = self.parent[bb] = self.next_label
- */
-  __pyx_t_1 = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->__pyx_vtab)->fast_find(__pyx_v_self, __pyx_v_aa);
-  __pyx_t_2 = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->__pyx_vtab)->fast_find(__pyx_v_self, __pyx_v_bb);
-  __pyx_v_aa = __pyx_t_1;
-  __pyx_v_bb = __pyx_t_2;
-
-  /* "druhg/_druhg_tree.pyx":136
- *         aa, bb = self.fast_find(aa), self.fast_find(bb)
- * 
- *         self.parent[aa] = self.parent[bb] = self.next_label             # <<<<<<<<<<<<<<
- *         self.next_label += 1
- *         return
- */
-  __pyx_t_2 = __pyx_v_self->next_label;
-  (__pyx_v_self->parent[__pyx_v_aa]) = __pyx_t_2;
-  (__pyx_v_self->parent[__pyx_v_bb]) = __pyx_t_2;
-
-  /* "druhg/_druhg_tree.pyx":137
- * 
- *         self.parent[aa] = self.parent[bb] = self.next_label
- *         self.next_label += 1             # <<<<<<<<<<<<<<
- *         return
- * 
- */
-  __pyx_v_self->next_label = (__pyx_v_self->next_label + 1);
-
-  /* "druhg/_druhg_tree.pyx":138
- *         self.parent[aa] = self.parent[bb] = self.next_label
- *         self.next_label += 1
- *         return             # <<<<<<<<<<<<<<
- * 
- * cdef class UniversalReciprocity (object):
- */
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_tree.pyx":133
- *     #     return self.parent[n]
- * 
- *     cdef void union(self, np.intp_t aa, np.intp_t bb):             # <<<<<<<<<<<<<<
- *         aa, bb = self.fast_find(aa), self.fast_find(bb)
- * 
- */
-
-  /* function exit code */
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-}
-
-/* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_9UnionFind_3__reduce_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_9UnionFind_3__reduce_cython__ = {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_9UnionFind_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_9UnionFind_3__reduce_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-) {
-  #if !CYTHON_METH_FASTCALL
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  #endif
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  if (unlikely(__pyx_nargs > 0)) {
-    __Pyx_RaiseArgtupleInvalid("__reduce_cython__", 1, 0, 0, __pyx_nargs); return NULL;}
-  if (unlikely(__pyx_kwds) && __Pyx_NumKwargs_FASTCALL(__pyx_kwds) && unlikely(!__Pyx_CheckKeywordStrings(__pyx_kwds, "__reduce_cython__", 0))) return NULL;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_9UnionFind_2__reduce_cython__(((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_9UnionFind_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
-
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-  __Pyx_Raise(__pyx_builtin_TypeError, __pyx_kp_s_self_parent_cannot_be_converted, 0, 0);
-  __PYX_ERR(1, 2, __pyx_L1_error)
-
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_AddTraceback("druhg._druhg_tree.UnionFind.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_9UnionFind_5__setstate_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_9UnionFind_5__setstate_cython__ = {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_9UnionFind_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_9UnionFind_5__setstate_cython__(PyObject *__pyx_v_self, 
-#if CYTHON_METH_FASTCALL
-PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
-#else
-PyObject *__pyx_args, PyObject *__pyx_kwds
-#endif
-) {
-  CYTHON_UNUSED PyObject *__pyx_v___pyx_state = 0;
-  #if !CYTHON_METH_FASTCALL
-  CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
-  #endif
-  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  {
-    #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_state,0};
-    #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_state,0};
-    #endif
-    PyObject* values[1] = {0};
-    if (__pyx_kwds) {
-      Py_ssize_t kw_args;
-      switch (__pyx_nargs) {
-        case  1: values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-        CYTHON_FALLTHROUGH;
-        case  0: break;
-        default: goto __pyx_L5_argtuple_error;
-      }
-      kw_args = __Pyx_NumKwargs_FASTCALL(__pyx_kwds);
-      switch (__pyx_nargs) {
-        case  0:
-        if (likely((values[0] = __Pyx_GetKwValue_FASTCALL(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_pyx_state)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 3, __pyx_L3_error)
-        else goto __pyx_L5_argtuple_error;
-      }
-      if (unlikely(kw_args > 0)) {
-        const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, 0, values + 0, kwd_pos_args, "__setstate_cython__") < 0)) __PYX_ERR(1, 3, __pyx_L3_error)
-      }
-    } else if (unlikely(__pyx_nargs != 1)) {
-      goto __pyx_L5_argtuple_error;
-    } else {
-      values[0] = __Pyx_Arg_FASTCALL(__pyx_args, 0);
-    }
-    __pyx_v___pyx_state = values[0];
-  }
-  goto __pyx_L4_argument_unpacking_done;
-  __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__setstate_cython__", 1, 1, 1, __pyx_nargs); __PYX_ERR(1, 3, __pyx_L3_error)
-  __pyx_L3_error:;
-  __Pyx_AddTraceback("druhg._druhg_tree.UnionFind.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __Pyx_RefNannyFinishContext();
-  return NULL;
-  __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_9UnionFind_4__setstate_cython__(((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self), __pyx_v___pyx_state);
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_9UnionFind_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
-
-  /* "(tree fragment)":4
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"             # <<<<<<<<<<<<<<
- */
-  __Pyx_Raise(__pyx_builtin_TypeError, __pyx_kp_s_self_parent_cannot_be_converted, 0, 0);
-  __PYX_ERR(1, 4, __pyx_L1_error)
-
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_AddTraceback("druhg._druhg_tree.UnionFind.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_tree.pyx":192
- *         # np.ndarray result_extras2_arr # to extract everything else
- * 
- *     def __init__(self, algorithm, tree, max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4, is_slow=0, **kwargs):             # <<<<<<<<<<<<<<
- * 
- *         self.PRECISION = kwargs.get('double_precision', 0.0000001) # this is only relevant if distances between datapoints are super small
+ *     def __init__(self, algorithm, tree,             # <<<<<<<<<<<<<<
+ *                  buffer_uf, buffer_fast, buffer_values,
+ *                  max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4,
  */
 
 /* Python wrapper */
 static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_algorithm = 0;
   PyObject *__pyx_v_tree = 0;
+  PyObject *__pyx_v_buffer_uf = 0;
+  PyObject *__pyx_v_buffer_fast = 0;
+  PyObject *__pyx_v_buffer_values = 0;
   PyObject *__pyx_v_max_neighbors_search = 0;
   PyObject *__pyx_v_metric = 0;
   PyObject *__pyx_v_leaf_size = 0;
   PyObject *__pyx_v_n_jobs = 0;
-  PyObject *__pyx_v_is_slow = 0;
+  PyObject *__pyx_v_buffer_ranks = 0;
+  PyObject *__pyx_v_buffer_edgepairs = 0;
   PyObject *__pyx_v_kwargs = 0;
   CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
   CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   __pyx_v_kwargs = PyDict_New(); if (unlikely(!__pyx_v_kwargs)) return -1;
   __Pyx_GOTREF(__pyx_v_kwargs);
   {
     #if CYTHON_USE_MODULE_STATE
-    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_algorithm,&__pyx_n_s_tree,&__pyx_n_s_max_neighbors_search,&__pyx_n_s_metric,&__pyx_n_s_leaf_size,&__pyx_n_s_n_jobs,&__pyx_n_s_is_slow,0};
+    PyObject **__pyx_pyargnames[] = {&__pyx_n_s_algorithm,&__pyx_n_s_tree,&__pyx_n_s_buffer_uf,&__pyx_n_s_buffer_fast,&__pyx_n_s_buffer_values,&__pyx_n_s_max_neighbors_search,&__pyx_n_s_metric,&__pyx_n_s_leaf_size,&__pyx_n_s_n_jobs,&__pyx_n_s_buffer_ranks,&__pyx_n_s_buffer_edgepairs,0};
     #else
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_algorithm,&__pyx_n_s_tree,&__pyx_n_s_max_neighbors_search,&__pyx_n_s_metric,&__pyx_n_s_leaf_size,&__pyx_n_s_n_jobs,&__pyx_n_s_is_slow,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_algorithm,&__pyx_n_s_tree,&__pyx_n_s_buffer_uf,&__pyx_n_s_buffer_fast,&__pyx_n_s_buffer_values,&__pyx_n_s_max_neighbors_search,&__pyx_n_s_metric,&__pyx_n_s_leaf_size,&__pyx_n_s_n_jobs,&__pyx_n_s_buffer_ranks,&__pyx_n_s_buffer_edgepairs,0};
     #endif
-    PyObject* values[7] = {0,0,0,0,0,0,0};
-    values[2] = ((PyObject *)__pyx_int_16);
-    values[3] = ((PyObject *)__pyx_n_u_euclidean);
-    values[4] = ((PyObject *)__pyx_int_20);
-    values[5] = ((PyObject *)__pyx_int_4);
-    values[6] = ((PyObject *)__pyx_int_0);
+    PyObject* values[11] = {0,0,0,0,0,0,0,0,0,0,0};
+    values[5] = ((PyObject *)__pyx_int_16);
+    values[6] = ((PyObject *)__pyx_n_u_euclidean);
+    values[7] = ((PyObject *)__pyx_int_20);
+    values[8] = ((PyObject *)__pyx_int_4);
+
+    /* "druhg/_druhg_tree.pyx":172
+ *                  buffer_uf, buffer_fast, buffer_values,
+ *                  max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4,
+ *                  buffer_ranks=None, buffer_edgepairs=None,             # <<<<<<<<<<<<<<
+ *                  **kwargs):
+ * 
+ */
+    values[9] = ((PyObject *)Py_None);
+    values[10] = ((PyObject *)Py_None);
     if (__pyx_kwds) {
       Py_ssize_t kw_args;
       switch (__pyx_nargs) {
+        case 11: values[10] = __Pyx_Arg_VARARGS(__pyx_args, 10);
+        CYTHON_FALLTHROUGH;
+        case 10: values[9] = __Pyx_Arg_VARARGS(__pyx_args, 9);
+        CYTHON_FALLTHROUGH;
+        case  9: values[8] = __Pyx_Arg_VARARGS(__pyx_args, 8);
+        CYTHON_FALLTHROUGH;
+        case  8: values[7] = __Pyx_Arg_VARARGS(__pyx_args, 7);
+        CYTHON_FALLTHROUGH;
         case  7: values[6] = __Pyx_Arg_VARARGS(__pyx_args, 6);
         CYTHON_FALLTHROUGH;
         case  6: values[5] = __Pyx_Arg_VARARGS(__pyx_args, 5);
         CYTHON_FALLTHROUGH;
         case  5: values[4] = __Pyx_Arg_VARARGS(__pyx_args, 4);
         CYTHON_FALLTHROUGH;
         case  4: values[3] = __Pyx_Arg_VARARGS(__pyx_args, 3);
@@ -7218,648 +7271,889 @@
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = __Pyx_NumKwargs_VARARGS(__pyx_kwds);
       switch (__pyx_nargs) {
         case  0:
         if (likely((values[0] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_algorithm)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_tree)) != 0)) kw_args--;
-        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 7, 1); __PYX_ERR(0, 192, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 5, 11, 1); __PYX_ERR(0, 169, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
+        if (likely((values[2] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_uf)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 5, 11, 2); __PYX_ERR(0, 169, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  3:
+        if (likely((values[3] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_fast)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 5, 11, 3); __PYX_ERR(0, 169, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  4:
+        if (likely((values[4] = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_values)) != 0)) kw_args--;
+        else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 5, 11, 4); __PYX_ERR(0, 169, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  5:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_max_neighbors_search);
-          if (value) { values[2] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+          if (value) { values[5] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
-        case  3:
+        case  6:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_metric);
-          if (value) { values[3] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+          if (value) { values[6] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
-        case  4:
+        case  7:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_leaf_size);
-          if (value) { values[4] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+          if (value) { values[7] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
-        case  5:
+        case  8:
         if (kw_args > 0) {
           PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_n_jobs);
-          if (value) { values[5] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+          if (value) { values[8] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
-        case  6:
+        case  9:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_is_slow);
-          if (value) { values[6] = value; kw_args--; }
-          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 192, __pyx_L3_error)
+          PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_ranks);
+          if (value) { values[9] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case 10:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_GetKwValue_VARARGS(__pyx_kwds, __pyx_kwvalues, __pyx_n_s_buffer_edgepairs);
+          if (value) { values[10] = value; kw_args--; }
+          else if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
         const Py_ssize_t kwd_pos_args = __pyx_nargs;
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, __pyx_v_kwargs, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 192, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_kwvalues, __pyx_pyargnames, __pyx_v_kwargs, values + 0, kwd_pos_args, "__init__") < 0)) __PYX_ERR(0, 169, __pyx_L3_error)
       }
     } else {
       switch (__pyx_nargs) {
-        case  7: values[6] = __Pyx_Arg_VARARGS(__pyx_args, 6);
+        case 11: values[10] = __Pyx_Arg_VARARGS(__pyx_args, 10);
         CYTHON_FALLTHROUGH;
-        case  6: values[5] = __Pyx_Arg_VARARGS(__pyx_args, 5);
+        case 10: values[9] = __Pyx_Arg_VARARGS(__pyx_args, 9);
         CYTHON_FALLTHROUGH;
-        case  5: values[4] = __Pyx_Arg_VARARGS(__pyx_args, 4);
+        case  9: values[8] = __Pyx_Arg_VARARGS(__pyx_args, 8);
         CYTHON_FALLTHROUGH;
-        case  4: values[3] = __Pyx_Arg_VARARGS(__pyx_args, 3);
+        case  8: values[7] = __Pyx_Arg_VARARGS(__pyx_args, 7);
         CYTHON_FALLTHROUGH;
-        case  3: values[2] = __Pyx_Arg_VARARGS(__pyx_args, 2);
+        case  7: values[6] = __Pyx_Arg_VARARGS(__pyx_args, 6);
         CYTHON_FALLTHROUGH;
-        case  2: values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
+        case  6: values[5] = __Pyx_Arg_VARARGS(__pyx_args, 5);
+        CYTHON_FALLTHROUGH;
+        case  5: values[4] = __Pyx_Arg_VARARGS(__pyx_args, 4);
+        values[3] = __Pyx_Arg_VARARGS(__pyx_args, 3);
+        values[2] = __Pyx_Arg_VARARGS(__pyx_args, 2);
+        values[1] = __Pyx_Arg_VARARGS(__pyx_args, 1);
         values[0] = __Pyx_Arg_VARARGS(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
     __pyx_v_algorithm = values[0];
     __pyx_v_tree = values[1];
-    __pyx_v_max_neighbors_search = values[2];
-    __pyx_v_metric = values[3];
-    __pyx_v_leaf_size = values[4];
-    __pyx_v_n_jobs = values[5];
-    __pyx_v_is_slow = values[6];
+    __pyx_v_buffer_uf = values[2];
+    __pyx_v_buffer_fast = values[3];
+    __pyx_v_buffer_values = values[4];
+    __pyx_v_max_neighbors_search = values[5];
+    __pyx_v_metric = values[6];
+    __pyx_v_leaf_size = values[7];
+    __pyx_v_n_jobs = values[8];
+    __pyx_v_buffer_ranks = values[9];
+    __pyx_v_buffer_edgepairs = values[10];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 7, __pyx_nargs); __PYX_ERR(0, 192, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 5, 11, __pyx_nargs); __PYX_ERR(0, 169, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_DECREF(__pyx_v_kwargs); __pyx_v_kwargs = 0;
   __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity___init__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self), __pyx_v_algorithm, __pyx_v_tree, __pyx_v_max_neighbors_search, __pyx_v_metric, __pyx_v_leaf_size, __pyx_v_n_jobs, __pyx_v_is_slow, __pyx_v_kwargs);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity___init__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self), __pyx_v_algorithm, __pyx_v_tree, __pyx_v_buffer_uf, __pyx_v_buffer_fast, __pyx_v_buffer_values, __pyx_v_max_neighbors_search, __pyx_v_metric, __pyx_v_leaf_size, __pyx_v_n_jobs, __pyx_v_buffer_ranks, __pyx_v_buffer_edgepairs, __pyx_v_kwargs);
+
+  /* "druhg/_druhg_tree.pyx":169
+ *         public np.ndarray knn_i
+ * 
+ *     def __init__(self, algorithm, tree,             # <<<<<<<<<<<<<<
+ *                  buffer_uf, buffer_fast, buffer_values,
+ *                  max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4,
+ */
 
   /* function exit code */
   __Pyx_DECREF(__pyx_v_kwargs);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity___init__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_algorithm, PyObject *__pyx_v_tree, PyObject *__pyx_v_max_neighbors_search, PyObject *__pyx_v_metric, PyObject *__pyx_v_leaf_size, PyObject *__pyx_v_n_jobs, PyObject *__pyx_v_is_slow, PyObject *__pyx_v_kwargs) {
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity___init__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_algorithm, PyObject *__pyx_v_tree, PyObject *__pyx_v_buffer_uf, PyObject *__pyx_v_buffer_fast, PyObject *__pyx_v_buffer_values, PyObject *__pyx_v_max_neighbors_search, PyObject *__pyx_v_metric, PyObject *__pyx_v_leaf_size, PyObject *__pyx_v_n_jobs, PyObject *__pyx_v_buffer_ranks, PyObject *__pyx_v_buffer_edgepairs, PyObject *__pyx_v_kwargs) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   __pyx_t_5numpy_double_t __pyx_t_2;
   __pyx_t_5numpy_intp_t __pyx_t_3;
   int __pyx_t_4;
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
-  int __pyx_t_8;
+  Py_ssize_t __pyx_t_8;
+  int __pyx_t_9;
+  int __pyx_t_10;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "druhg/_druhg_tree.pyx":194
- *     def __init__(self, algorithm, tree, max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4, is_slow=0, **kwargs):
+  /* "druhg/_druhg_tree.pyx":175
+ *                  **kwargs):
  * 
  *         self.PRECISION = kwargs.get('double_precision', 0.0000001) # this is only relevant if distances between datapoints are super small             # <<<<<<<<<<<<<<
  *         self.n_jobs = n_jobs
  * 
  */
-  __pyx_t_1 = __Pyx_PyDict_GetItemDefault(__pyx_v_kwargs, __pyx_n_u_double_precision, __pyx_float_0_0000001); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 194, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyDict_GetItemDefault(__pyx_v_kwargs, __pyx_n_u_double_precision, __pyx_float_0_0000001); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 175, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 194, __pyx_L1_error)
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 175, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_v_self->PRECISION = __pyx_t_2;
 
-  /* "druhg/_druhg_tree.pyx":195
+  /* "druhg/_druhg_tree.pyx":176
  * 
  *         self.PRECISION = kwargs.get('double_precision', 0.0000001) # this is only relevant if distances between datapoints are super small
  *         self.n_jobs = n_jobs             # <<<<<<<<<<<<<<
  * 
  *         if algorithm == 0:
  */
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_v_n_jobs); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 195, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_v_n_jobs); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 176, __pyx_L1_error)
   __pyx_v_self->n_jobs = __pyx_t_3;
 
-  /* "druhg/_druhg_tree.pyx":197
+  /* "druhg/_druhg_tree.pyx":178
  *         self.n_jobs = n_jobs
  * 
  *         if algorithm == 0:             # <<<<<<<<<<<<<<
  *             self.dist_tree = tree
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  */
-  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 197, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 178, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 197, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 178, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   if (__pyx_t_4) {
 
-    /* "druhg/_druhg_tree.pyx":198
+    /* "druhg/_druhg_tree.pyx":179
  * 
  *         if algorithm == 0:
  *             self.dist_tree = tree             # <<<<<<<<<<<<<<
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]
  */
     __Pyx_INCREF(__pyx_v_tree);
     __Pyx_GIVEREF(__pyx_v_tree);
     __Pyx_GOTREF(__pyx_v_self->dist_tree);
     __Pyx_DECREF(__pyx_v_self->dist_tree);
     __pyx_v_self->dist_tree = __pyx_v_tree;
 
-    /* "druhg/_druhg_tree.pyx":199
+    /* "druhg/_druhg_tree.pyx":180
  *         if algorithm == 0:
  *             self.dist_tree = tree
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)             # <<<<<<<<<<<<<<
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 1:
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_KDTree); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 199, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_KDTree); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 180, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_data); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 199, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_data); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 180, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 199, __pyx_L1_error)
+    __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 180, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
     __pyx_t_5 = 0;
-    __pyx_t_7 = __Pyx_PyDict_NewPresized(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 199, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyDict_NewPresized(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 180, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_metric, __pyx_v_metric) < 0) __PYX_ERR(0, 199, __pyx_L1_error)
-    if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_leaf_size, __pyx_v_leaf_size) < 0) __PYX_ERR(0, 199, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_metric, __pyx_v_metric) < 0) __PYX_ERR(0, 180, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_leaf_size, __pyx_v_leaf_size) < 0) __PYX_ERR(0, 180, __pyx_L1_error)
     __pyx_t_5 = __pyx_t_7;
     __pyx_t_7 = 0;
-    if (__Pyx_MergeKeywords(__pyx_t_5, __pyx_v_kwargs) < 0) __PYX_ERR(0, 199, __pyx_L1_error)
-    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 199, __pyx_L1_error)
+    if (__Pyx_MergeKeywords(__pyx_t_5, __pyx_v_kwargs) < 0) __PYX_ERR(0, 180, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 180, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_GIVEREF(__pyx_t_7);
     __Pyx_GOTREF(__pyx_v_self->tree);
     __Pyx_DECREF(__pyx_v_self->tree);
     __pyx_v_self->tree = __pyx_t_7;
     __pyx_t_7 = 0;
 
-    /* "druhg/_druhg_tree.pyx":200
+    /* "druhg/_druhg_tree.pyx":181
  *             self.dist_tree = tree
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]             # <<<<<<<<<<<<<<
  *         elif algorithm == 1:
  *             self.dist_tree = tree
  */
-    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 200, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 181, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 200, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 181, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __pyx_t_7 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 200, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 181, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_7); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 200, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_7); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 181, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     __pyx_v_self->num_points = __pyx_t_3;
 
-    /* "druhg/_druhg_tree.pyx":197
+    /* "druhg/_druhg_tree.pyx":178
  *         self.n_jobs = n_jobs
  * 
  *         if algorithm == 0:             # <<<<<<<<<<<<<<
  *             self.dist_tree = tree
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  */
     goto __pyx_L3;
   }
 
-  /* "druhg/_druhg_tree.pyx":201
+  /* "druhg/_druhg_tree.pyx":182
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 1:             # <<<<<<<<<<<<<<
  *             self.dist_tree = tree
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  */
-  __pyx_t_7 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 201, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 182, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
-  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 201, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 182, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
   if (__pyx_t_4) {
 
-    /* "druhg/_druhg_tree.pyx":202
+    /* "druhg/_druhg_tree.pyx":183
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 1:
  *             self.dist_tree = tree             # <<<<<<<<<<<<<<
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]
  */
     __Pyx_INCREF(__pyx_v_tree);
     __Pyx_GIVEREF(__pyx_v_tree);
     __Pyx_GOTREF(__pyx_v_self->dist_tree);
     __Pyx_DECREF(__pyx_v_self->dist_tree);
     __pyx_v_self->dist_tree = __pyx_v_tree;
 
-    /* "druhg/_druhg_tree.pyx":203
+    /* "druhg/_druhg_tree.pyx":184
  *         elif algorithm == 1:
  *             self.dist_tree = tree
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)             # <<<<<<<<<<<<<<
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 2:
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_7, __pyx_n_s_BallTree); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 203, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_7, __pyx_n_s_BallTree); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 184, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_data); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 203, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_data); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 184, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 203, __pyx_L1_error)
+    __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 184, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
     __pyx_t_5 = 0;
-    __pyx_t_1 = __Pyx_PyDict_NewPresized(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 203, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyDict_NewPresized(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 184, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_metric, __pyx_v_metric) < 0) __PYX_ERR(0, 203, __pyx_L1_error)
-    if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_leaf_size, __pyx_v_leaf_size) < 0) __PYX_ERR(0, 203, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_metric, __pyx_v_metric) < 0) __PYX_ERR(0, 184, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_leaf_size, __pyx_v_leaf_size) < 0) __PYX_ERR(0, 184, __pyx_L1_error)
     __pyx_t_5 = __pyx_t_1;
     __pyx_t_1 = 0;
-    if (__Pyx_MergeKeywords(__pyx_t_5, __pyx_v_kwargs) < 0) __PYX_ERR(0, 203, __pyx_L1_error)
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 203, __pyx_L1_error)
+    if (__Pyx_MergeKeywords(__pyx_t_5, __pyx_v_kwargs) < 0) __PYX_ERR(0, 184, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 184, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_GIVEREF(__pyx_t_1);
     __Pyx_GOTREF(__pyx_v_self->tree);
     __Pyx_DECREF(__pyx_v_self->tree);
     __pyx_v_self->tree = __pyx_t_1;
     __pyx_t_1 = 0;
 
-    /* "druhg/_druhg_tree.pyx":204
+    /* "druhg/_druhg_tree.pyx":185
  *             self.dist_tree = tree
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]             # <<<<<<<<<<<<<<
  *         elif algorithm == 2:
  *             self.dist_tree = PairwiseDistanceTreeGeneric(tree.shape[0], tree)
  */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 204, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 185, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 204, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 185, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 204, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 185, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 204, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 185, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_v_self->num_points = __pyx_t_3;
 
-    /* "druhg/_druhg_tree.pyx":201
+    /* "druhg/_druhg_tree.pyx":182
  *             self.tree = KDTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 1:             # <<<<<<<<<<<<<<
  *             self.dist_tree = tree
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  */
     goto __pyx_L3;
   }
 
-  /* "druhg/_druhg_tree.pyx":205
+  /* "druhg/_druhg_tree.pyx":186
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 2:             # <<<<<<<<<<<<<<
  *             self.dist_tree = PairwiseDistanceTreeGeneric(tree.shape[0], tree)
  *             self.tree = tree
  */
-  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_2, 2, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 205, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_2, 2, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 186, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 205, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 186, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   if (__pyx_t_4) {
 
-    /* "druhg/_druhg_tree.pyx":206
+    /* "druhg/_druhg_tree.pyx":187
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 2:
  *             self.dist_tree = PairwiseDistanceTreeGeneric(tree.shape[0], tree)             # <<<<<<<<<<<<<<
  *             self.tree = tree
  *             self.num_points = self.tree.shape[0]
  */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 187, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 206, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 187, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)
+    __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 187, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5);
     __Pyx_INCREF(__pyx_v_tree);
     __Pyx_GIVEREF(__pyx_v_tree);
     PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_v_tree);
     __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric), __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 206, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric), __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 187, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_GIVEREF(__pyx_t_5);
     __Pyx_GOTREF(__pyx_v_self->dist_tree);
     __Pyx_DECREF(__pyx_v_self->dist_tree);
     __pyx_v_self->dist_tree = __pyx_t_5;
     __pyx_t_5 = 0;
 
-    /* "druhg/_druhg_tree.pyx":207
+    /* "druhg/_druhg_tree.pyx":188
  *         elif algorithm == 2:
  *             self.dist_tree = PairwiseDistanceTreeGeneric(tree.shape[0], tree)
  *             self.tree = tree             # <<<<<<<<<<<<<<
  *             self.num_points = self.tree.shape[0]
  *         elif algorithm == 3:
  */
     __Pyx_INCREF(__pyx_v_tree);
     __Pyx_GIVEREF(__pyx_v_tree);
     __Pyx_GOTREF(__pyx_v_self->tree);
     __Pyx_DECREF(__pyx_v_self->tree);
     __pyx_v_self->tree = __pyx_v_tree;
 
-    /* "druhg/_druhg_tree.pyx":208
+    /* "druhg/_druhg_tree.pyx":189
  *             self.dist_tree = PairwiseDistanceTreeGeneric(tree.shape[0], tree)
  *             self.tree = tree
  *             self.num_points = self.tree.shape[0]             # <<<<<<<<<<<<<<
  *         elif algorithm == 3:
  *             self.dist_tree = PairwiseDistanceTreeSparse(tree.shape[0], tree)
  */
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 208, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 189, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 208, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 189, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 208, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 189, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_v_self->num_points = __pyx_t_3;
 
-    /* "druhg/_druhg_tree.pyx":205
+    /* "druhg/_druhg_tree.pyx":186
  *             self.tree = BallTree(tree.data, metric=metric, leaf_size=leaf_size, **kwargs)
  *             self.num_points = self.tree.data.shape[0]
  *         elif algorithm == 2:             # <<<<<<<<<<<<<<
  *             self.dist_tree = PairwiseDistanceTreeGeneric(tree.shape[0], tree)
  *             self.tree = tree
  */
     goto __pyx_L3;
   }
 
-  /* "druhg/_druhg_tree.pyx":209
+  /* "druhg/_druhg_tree.pyx":190
  *             self.tree = tree
  *             self.num_points = self.tree.shape[0]
  *         elif algorithm == 3:             # <<<<<<<<<<<<<<
  *             self.dist_tree = PairwiseDistanceTreeSparse(tree.shape[0], tree)
  *             self.tree = tree
  */
-  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_3, 3, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 209, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_algorithm, __pyx_int_3, 3, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 190, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 209, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 190, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   if (likely(__pyx_t_4)) {
 
-    /* "druhg/_druhg_tree.pyx":210
+    /* "druhg/_druhg_tree.pyx":191
  *             self.num_points = self.tree.shape[0]
  *         elif algorithm == 3:
  *             self.dist_tree = PairwiseDistanceTreeSparse(tree.shape[0], tree)             # <<<<<<<<<<<<<<
  *             self.tree = tree
  *             self.num_points = self.tree.shape[0]
  */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 210, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 191, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 210, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 191, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 210, __pyx_L1_error)
+    __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 191, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5);
     __Pyx_INCREF(__pyx_v_tree);
     __Pyx_GIVEREF(__pyx_v_tree);
     PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_v_tree);
     __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse), __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 210, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse), __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 191, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_GIVEREF(__pyx_t_5);
     __Pyx_GOTREF(__pyx_v_self->dist_tree);
     __Pyx_DECREF(__pyx_v_self->dist_tree);
     __pyx_v_self->dist_tree = __pyx_t_5;
     __pyx_t_5 = 0;
 
-    /* "druhg/_druhg_tree.pyx":211
+    /* "druhg/_druhg_tree.pyx":192
  *         elif algorithm == 3:
  *             self.dist_tree = PairwiseDistanceTreeSparse(tree.shape[0], tree)
  *             self.tree = tree             # <<<<<<<<<<<<<<
  *             self.num_points = self.tree.shape[0]
  *         else:
  */
     __Pyx_INCREF(__pyx_v_tree);
     __Pyx_GIVEREF(__pyx_v_tree);
     __Pyx_GOTREF(__pyx_v_self->tree);
     __Pyx_DECREF(__pyx_v_self->tree);
     __pyx_v_self->tree = __pyx_v_tree;
 
-    /* "druhg/_druhg_tree.pyx":212
+    /* "druhg/_druhg_tree.pyx":193
  *             self.dist_tree = PairwiseDistanceTreeSparse(tree.shape[0], tree)
  *             self.tree = tree
  *             self.num_points = self.tree.shape[0]             # <<<<<<<<<<<<<<
  *         else:
  *             raise ValueError('algorithm value '+str(algorithm)+' is not valid')
  */
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 212, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->tree, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 193, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 212, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 193, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 212, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 193, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_v_self->num_points = __pyx_t_3;
 
-    /* "druhg/_druhg_tree.pyx":209
+    /* "druhg/_druhg_tree.pyx":190
  *             self.tree = tree
  *             self.num_points = self.tree.shape[0]
  *         elif algorithm == 3:             # <<<<<<<<<<<<<<
  *             self.dist_tree = PairwiseDistanceTreeSparse(tree.shape[0], tree)
  *             self.tree = tree
  */
     goto __pyx_L3;
   }
 
-  /* "druhg/_druhg_tree.pyx":214
+  /* "druhg/_druhg_tree.pyx":195
  *             self.num_points = self.tree.shape[0]
  *         else:
  *             raise ValueError('algorithm value '+str(algorithm)+' is not valid')             # <<<<<<<<<<<<<<
  * 
  *         self.max_neighbors_search = max_neighbors_search
  */
   /*else*/ {
-    __pyx_t_1 = __Pyx_PyObject_Str(__pyx_v_algorithm); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 214, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Str(__pyx_v_algorithm); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 195, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = PyNumber_Add(__pyx_kp_u_algorithm_value, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 214, __pyx_L1_error)
+    __pyx_t_5 = PyNumber_Add(__pyx_kp_u_algorithm_value, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 195, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_5, __pyx_kp_u_is_not_valid); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 214, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_5, __pyx_kp_u_is_not_valid); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 195, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 214, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 195, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_Raise(__pyx_t_5, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __PYX_ERR(0, 214, __pyx_L1_error)
+    __PYX_ERR(0, 195, __pyx_L1_error)
   }
   __pyx_L3:;
 
-  /* "druhg/_druhg_tree.pyx":216
+  /* "druhg/_druhg_tree.pyx":197
  *             raise ValueError('algorithm value '+str(algorithm)+' is not valid')
  * 
  *         self.max_neighbors_search = max_neighbors_search             # <<<<<<<<<<<<<<
  * 
  *         # self.num_features = self.tree.data.shape[1]
  */
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_v_max_neighbors_search); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 216, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(__pyx_v_max_neighbors_search); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 197, __pyx_L1_error)
   __pyx_v_self->max_neighbors_search = __pyx_t_3;
 
-  /* "druhg/_druhg_tree.pyx":220
+  /* "druhg/_druhg_tree.pyx":201
  *         # self.num_features = self.tree.data.shape[1]
  * 
- *         self.U = UnionFind(self.num_points)             # <<<<<<<<<<<<<<
+ *         self.U = UnionFind(self.num_points, buffer_uf, buffer_fast)             # <<<<<<<<<<<<<<
+ *         self.U.nullify()
  * 
- *         self.result_edges = 0
  */
-  __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_self->num_points); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 220, __pyx_L1_error)
+  __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_self->num_points); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 201, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_1 = __Pyx_PyObject_CallOneArg(((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UnionFind), __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 220, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 201, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5);
+  __Pyx_INCREF(__pyx_v_buffer_uf);
+  __Pyx_GIVEREF(__pyx_v_buffer_uf);
+  PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_v_buffer_uf);
+  __Pyx_INCREF(__pyx_v_buffer_fast);
+  __Pyx_GIVEREF(__pyx_v_buffer_fast);
+  PyTuple_SET_ITEM(__pyx_t_1, 2, __pyx_v_buffer_fast);
+  __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind), __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 201, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_GIVEREF(__pyx_t_5);
   __Pyx_GOTREF((PyObject *)__pyx_v_self->U);
   __Pyx_DECREF((PyObject *)__pyx_v_self->U);
-  __pyx_v_self->U = ((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)__pyx_t_1);
-  __pyx_t_1 = 0;
+  __pyx_v_self->U = ((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)__pyx_t_5);
+  __pyx_t_5 = 0;
 
-  /* "druhg/_druhg_tree.pyx":222
- *         self.U = UnionFind(self.num_points)
+  /* "druhg/_druhg_tree.pyx":202
+ * 
+ *         self.U = UnionFind(self.num_points, buffer_uf, buffer_fast)
+ *         self.U.nullify()             # <<<<<<<<<<<<<<
+ * 
+ *         self.result_edges = 0
+ */
+  (void)(((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self->U->__pyx_vtab)->nullify(__pyx_v_self->U));
+
+  /* "druhg/_druhg_tree.pyx":204
+ *         self.U.nullify()
  * 
  *         self.result_edges = 0             # <<<<<<<<<<<<<<
  * 
- *         self.result_pairs_arr = np.empty((self.num_points*2 - 2))
+ *         self.result_values_arr = buffer_values
  */
   __pyx_v_self->result_edges = 0;
 
-  /* "druhg/_druhg_tree.pyx":224
+  /* "druhg/_druhg_tree.pyx":206
  *         self.result_edges = 0
  * 
- *         self.result_pairs_arr = np.empty((self.num_points*2 - 2))             # <<<<<<<<<<<<<<
- *         self.result_value_arr = np.empty(self.num_points - 1)
+ *         self.result_values_arr = buffer_values             # <<<<<<<<<<<<<<
+ *         if len(self.result_values_arr) < self.num_points - 1:
+ *             print('ERROR: values buffer is too small', len(self.result_values_arr), self.num_points - 1)
+ */
+  if (!(likely(((__pyx_v_buffer_values) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_buffer_values, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 206, __pyx_L1_error)
+  __pyx_t_5 = __pyx_v_buffer_values;
+  __Pyx_INCREF(__pyx_t_5);
+  __Pyx_GIVEREF(__pyx_t_5);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->result_values_arr);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->result_values_arr);
+  __pyx_v_self->result_values_arr = ((PyArrayObject *)__pyx_t_5);
+  __pyx_t_5 = 0;
+
+  /* "druhg/_druhg_tree.pyx":207
  * 
+ *         self.result_values_arr = buffer_values
+ *         if len(self.result_values_arr) < self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print('ERROR: values buffer is too small', len(self.result_values_arr), self.num_points - 1)
+ *             return
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 224, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_empty); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 224, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_5 = ((PyObject *)__pyx_v_self->result_values_arr);
+  __Pyx_INCREF(__pyx_t_5);
+  __pyx_t_8 = PyObject_Length(__pyx_t_5); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(0, 207, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __pyx_t_5 = PyInt_FromSsize_t(((__pyx_v_self->num_points * 2) - 2)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 224, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_7 = NULL;
-  __pyx_t_8 = 0;
-  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_6))) {
-    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_6);
-    if (likely(__pyx_t_7)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
-      __Pyx_INCREF(__pyx_t_7);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_6, function);
-      __pyx_t_8 = 1;
-    }
-  }
-  {
-    PyObject *__pyx_callargs[2] = {__pyx_t_7, __pyx_t_5};
-    __pyx_t_1 = __Pyx_PyObject_FastCall(__pyx_t_6, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
-    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+  __pyx_t_4 = ((__pyx_t_8 < (__pyx_v_self->num_points - 1)) != 0);
+  if (__pyx_t_4) {
+
+    /* "druhg/_druhg_tree.pyx":208
+ *         self.result_values_arr = buffer_values
+ *         if len(self.result_values_arr) < self.num_points - 1:
+ *             print('ERROR: values buffer is too small', len(self.result_values_arr), self.num_points - 1)             # <<<<<<<<<<<<<<
+ *             return
+ * 
+ */
+    __pyx_t_5 = ((PyObject *)__pyx_v_self->result_values_arr);
+    __Pyx_INCREF(__pyx_t_5);
+    __pyx_t_8 = PyObject_Length(__pyx_t_5); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(0, 208, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 224, __pyx_L1_error)
+    __pyx_t_5 = PyInt_FromSsize_t(__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 208, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_1 = PyInt_FromSsize_t((__pyx_v_self->num_points - 1)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 208, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 208, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_INCREF(__pyx_kp_u_ERROR_values_buffer_is_too_small);
+    __Pyx_GIVEREF(__pyx_kp_u_ERROR_values_buffer_is_too_small);
+    PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_kp_u_ERROR_values_buffer_is_too_small);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_5);
+    __Pyx_GIVEREF(__pyx_t_1);
+    PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_1);
+    __pyx_t_5 = 0;
+    __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_6, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 208, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+
+    /* "druhg/_druhg_tree.pyx":209
+ *         if len(self.result_values_arr) < self.num_points - 1:
+ *             print('ERROR: values buffer is too small', len(self.result_values_arr), self.num_points - 1)
+ *             return             # <<<<<<<<<<<<<<
+ * 
+ *         self.result_pairs_arr = buffer_edgepairs # np.empty((self.num_points*2 - 2))
+ */
+    __pyx_r = 0;
+    goto __pyx_L0;
+
+    /* "druhg/_druhg_tree.pyx":207
+ * 
+ *         self.result_values_arr = buffer_values
+ *         if len(self.result_values_arr) < self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print('ERROR: values buffer is too small', len(self.result_values_arr), self.num_points - 1)
+ *             return
+ */
   }
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 224, __pyx_L1_error)
+
+  /* "druhg/_druhg_tree.pyx":211
+ *             return
+ * 
+ *         self.result_pairs_arr = buffer_edgepairs # np.empty((self.num_points*2 - 2))             # <<<<<<<<<<<<<<
+ *         if self.result_pairs_arr is not None and len(self.result_pairs_arr) < self.num_points*2 - 2:
+ *             print('ERROR: edgepairs buffer is too small', len(self.result_pairs_arr), self.num_points*2 - 2)
+ */
+  if (!(likely(((__pyx_v_buffer_edgepairs) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_buffer_edgepairs, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 211, __pyx_L1_error)
+  __pyx_t_1 = __pyx_v_buffer_edgepairs;
+  __Pyx_INCREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_1);
   __Pyx_GOTREF((PyObject *)__pyx_v_self->result_pairs_arr);
   __Pyx_DECREF((PyObject *)__pyx_v_self->result_pairs_arr);
   __pyx_v_self->result_pairs_arr = ((PyArrayObject *)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_tree.pyx":225
+  /* "druhg/_druhg_tree.pyx":212
  * 
- *         self.result_pairs_arr = np.empty((self.num_points*2 - 2))
- *         self.result_value_arr = np.empty(self.num_points - 1)             # <<<<<<<<<<<<<<
+ *         self.result_pairs_arr = buffer_edgepairs # np.empty((self.num_points*2 - 2))
+ *         if self.result_pairs_arr is not None and len(self.result_pairs_arr) < self.num_points*2 - 2:             # <<<<<<<<<<<<<<
+ *             print('ERROR: edgepairs buffer is too small', len(self.result_pairs_arr), self.num_points*2 - 2)
+ *             return
+ */
+  __pyx_t_9 = (((PyObject *)__pyx_v_self->result_pairs_arr) != Py_None);
+  __pyx_t_10 = (__pyx_t_9 != 0);
+  if (__pyx_t_10) {
+  } else {
+    __pyx_t_4 = __pyx_t_10;
+    goto __pyx_L6_bool_binop_done;
+  }
+  __pyx_t_1 = ((PyObject *)__pyx_v_self->result_pairs_arr);
+  __Pyx_INCREF(__pyx_t_1);
+  __pyx_t_8 = PyObject_Length(__pyx_t_1); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(0, 212, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_10 = ((__pyx_t_8 < ((__pyx_v_self->num_points * 2) - 2)) != 0);
+  __pyx_t_4 = __pyx_t_10;
+  __pyx_L6_bool_binop_done:;
+  if (__pyx_t_4) {
+
+    /* "druhg/_druhg_tree.pyx":213
+ *         self.result_pairs_arr = buffer_edgepairs # np.empty((self.num_points*2 - 2))
+ *         if self.result_pairs_arr is not None and len(self.result_pairs_arr) < self.num_points*2 - 2:
+ *             print('ERROR: edgepairs buffer is too small', len(self.result_pairs_arr), self.num_points*2 - 2)             # <<<<<<<<<<<<<<
+ *             return
  * 
- *         # self.result_extras1_arr = np.empty(self.num_points - 1)
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 225, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_empty); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 225, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  __pyx_t_6 = PyInt_FromSsize_t((__pyx_v_self->num_points - 1)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 225, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_7 = NULL;
-  __pyx_t_8 = 0;
-  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
-    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_5);
-    if (likely(__pyx_t_7)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
-      __Pyx_INCREF(__pyx_t_7);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_5, function);
-      __pyx_t_8 = 1;
-    }
+    __pyx_t_1 = ((PyObject *)__pyx_v_self->result_pairs_arr);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_t_8 = PyObject_Length(__pyx_t_1); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(0, 213, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = PyInt_FromSsize_t(__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 213, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_6 = PyInt_FromSsize_t(((__pyx_v_self->num_points * 2) - 2)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 213, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_5 = PyTuple_New(3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 213, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_INCREF(__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm);
+    __Pyx_GIVEREF(__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm);
+    PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm);
+    __Pyx_GIVEREF(__pyx_t_1);
+    PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_1);
+    __Pyx_GIVEREF(__pyx_t_6);
+    PyTuple_SET_ITEM(__pyx_t_5, 2, __pyx_t_6);
+    __pyx_t_1 = 0;
+    __pyx_t_6 = 0;
+    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_5, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 213, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+
+    /* "druhg/_druhg_tree.pyx":214
+ *         if self.result_pairs_arr is not None and len(self.result_pairs_arr) < self.num_points*2 - 2:
+ *             print('ERROR: edgepairs buffer is too small', len(self.result_pairs_arr), self.num_points*2 - 2)
+ *             return             # <<<<<<<<<<<<<<
+ * 
+ *         self.result_rank_arr = buffer_ranks # np.empty((self.num_points - 1))
+ */
+    __pyx_r = 0;
+    goto __pyx_L0;
+
+    /* "druhg/_druhg_tree.pyx":212
+ * 
+ *         self.result_pairs_arr = buffer_edgepairs # np.empty((self.num_points*2 - 2))
+ *         if self.result_pairs_arr is not None and len(self.result_pairs_arr) < self.num_points*2 - 2:             # <<<<<<<<<<<<<<
+ *             print('ERROR: edgepairs buffer is too small', len(self.result_pairs_arr), self.num_points*2 - 2)
+ *             return
+ */
   }
-  {
-    PyObject *__pyx_callargs[2] = {__pyx_t_7, __pyx_t_6};
-    __pyx_t_1 = __Pyx_PyObject_FastCall(__pyx_t_5, __pyx_callargs+1-__pyx_t_8, 1+__pyx_t_8);
-    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+
+  /* "druhg/_druhg_tree.pyx":216
+ *             return
+ * 
+ *         self.result_rank_arr = buffer_ranks # np.empty((self.num_points - 1))             # <<<<<<<<<<<<<<
+ *         if self.result_rank_arr is not None and len(self.result_rank_arr) < self.num_points - 1:
+ *             print('ERROR: ranks buffer is too small', len(self.result_rank_arr), self.num_points - 1)
+ */
+  if (!(likely(((__pyx_v_buffer_ranks) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_buffer_ranks, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 216, __pyx_L1_error)
+  __pyx_t_6 = __pyx_v_buffer_ranks;
+  __Pyx_INCREF(__pyx_t_6);
+  __Pyx_GIVEREF(__pyx_t_6);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->result_rank_arr);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->result_rank_arr);
+  __pyx_v_self->result_rank_arr = ((PyArrayObject *)__pyx_t_6);
+  __pyx_t_6 = 0;
+
+  /* "druhg/_druhg_tree.pyx":217
+ * 
+ *         self.result_rank_arr = buffer_ranks # np.empty((self.num_points - 1))
+ *         if self.result_rank_arr is not None and len(self.result_rank_arr) < self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print('ERROR: ranks buffer is too small', len(self.result_rank_arr), self.num_points - 1)
+ *             return
+ */
+  __pyx_t_10 = (((PyObject *)__pyx_v_self->result_rank_arr) != Py_None);
+  __pyx_t_9 = (__pyx_t_10 != 0);
+  if (__pyx_t_9) {
+  } else {
+    __pyx_t_4 = __pyx_t_9;
+    goto __pyx_L9_bool_binop_done;
+  }
+  __pyx_t_6 = ((PyObject *)__pyx_v_self->result_rank_arr);
+  __Pyx_INCREF(__pyx_t_6);
+  __pyx_t_8 = PyObject_Length(__pyx_t_6); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(0, 217, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_9 = ((__pyx_t_8 < (__pyx_v_self->num_points - 1)) != 0);
+  __pyx_t_4 = __pyx_t_9;
+  __pyx_L9_bool_binop_done:;
+  if (__pyx_t_4) {
+
+    /* "druhg/_druhg_tree.pyx":218
+ *         self.result_rank_arr = buffer_ranks # np.empty((self.num_points - 1))
+ *         if self.result_rank_arr is not None and len(self.result_rank_arr) < self.num_points - 1:
+ *             print('ERROR: ranks buffer is too small', len(self.result_rank_arr), self.num_points - 1)             # <<<<<<<<<<<<<<
+ *             return
+ * 
+ */
+    __pyx_t_6 = ((PyObject *)__pyx_v_self->result_rank_arr);
+    __Pyx_INCREF(__pyx_t_6);
+    __pyx_t_8 = PyObject_Length(__pyx_t_6); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(0, 218, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 225, __pyx_L1_error)
+    __pyx_t_6 = PyInt_FromSsize_t(__pyx_t_8); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_5 = PyInt_FromSsize_t((__pyx_v_self->num_points - 1)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 218, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_kp_u_ERROR_ranks_buffer_is_too_small);
+    __Pyx_GIVEREF(__pyx_kp_u_ERROR_ranks_buffer_is_too_small);
+    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_kp_u_ERROR_ranks_buffer_is_too_small);
+    __Pyx_GIVEREF(__pyx_t_6);
+    PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_6);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_1, 2, __pyx_t_5);
+    __pyx_t_6 = 0;
+    __pyx_t_5 = 0;
+    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 218, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+    /* "druhg/_druhg_tree.pyx":219
+ *         if self.result_rank_arr is not None and len(self.result_rank_arr) < self.num_points - 1:
+ *             print('ERROR: ranks buffer is too small', len(self.result_rank_arr), self.num_points - 1)
+ *             return             # <<<<<<<<<<<<<<
+ * 
+ *         self._compute_tree_edges()
+ */
+    __pyx_r = 0;
+    goto __pyx_L0;
+
+    /* "druhg/_druhg_tree.pyx":217
+ * 
+ *         self.result_rank_arr = buffer_ranks # np.empty((self.num_points - 1))
+ *         if self.result_rank_arr is not None and len(self.result_rank_arr) < self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print('ERROR: ranks buffer is too small', len(self.result_rank_arr), self.num_points - 1)
+ *             return
+ */
   }
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 225, __pyx_L1_error)
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF((PyObject *)__pyx_v_self->result_value_arr);
-  __Pyx_DECREF((PyObject *)__pyx_v_self->result_value_arr);
-  __pyx_v_self->result_value_arr = ((PyArrayObject *)__pyx_t_1);
-  __pyx_t_1 = 0;
 
-  /* "druhg/_druhg_tree.pyx":230
- *         # self.result_extras2_arr = np.empty(self.num_points - 1)
+  /* "druhg/_druhg_tree.pyx":221
+ *             return
  * 
- *         self._compute_tree_edges(is_slow)             # <<<<<<<<<<<<<<
+ *         self._compute_tree_edges()             # <<<<<<<<<<<<<<
  * 
  *     cpdef tuple get_tree(self):
  */
-  __pyx_t_1 = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self->__pyx_vtab)->_compute_tree_edges(__pyx_v_self, __pyx_v_is_slow); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 230, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_5 = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self->__pyx_vtab)->_compute_tree_edges(__pyx_v_self); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 221, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "druhg/_druhg_tree.pyx":192
- *         # np.ndarray result_extras2_arr # to extract everything else
+  /* "druhg/_druhg_tree.pyx":169
+ *         public np.ndarray knn_i
  * 
- *     def __init__(self, algorithm, tree, max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4, is_slow=0, **kwargs):             # <<<<<<<<<<<<<<
- * 
- *         self.PRECISION = kwargs.get('double_precision', 0.0000001) # this is only relevant if distances between datapoints are super small
+ *     def __init__(self, algorithm, tree,             # <<<<<<<<<<<<<<
+ *                  buffer_uf, buffer_fast, buffer_values,
+ *                  max_neighbors_search=16, metric='euclidean', leaf_size=20, n_jobs=4,
  */
 
   /* function exit code */
   __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
@@ -7869,20 +8163,20 @@
   __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":232
- *         self._compute_tree_edges(is_slow)
+/* "druhg/_druhg_tree.pyx":223
+ *         self._compute_tree_edges()
  * 
  *     cpdef tuple get_tree(self):             # <<<<<<<<<<<<<<
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
- * 
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  */
 
 static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_3get_tree(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
@@ -7892,28 +8186,29 @@
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   int __pyx_t_5;
+  PyObject *__pyx_t_6 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("get_tree", 0);
   /* Check if called by wrapper */
   if (unlikely(__pyx_skip_dispatch)) ;
   /* Check if overridden in Python */
   else if (unlikely((Py_TYPE(((PyObject *)__pyx_v_self))->tp_dictoffset != 0) || __Pyx_PyType_HasFeature(Py_TYPE(((PyObject *)__pyx_v_self)), (Py_TPFLAGS_IS_ABSTRACT | Py_TPFLAGS_HEAPTYPE)))) {
     #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     static PY_UINT64_T __pyx_tp_dict_version = __PYX_DICT_VERSION_INIT, __pyx_obj_dict_version = __PYX_DICT_VERSION_INIT;
     if (unlikely(!__Pyx_object_dict_version_matches(((PyObject *)__pyx_v_self), __pyx_tp_dict_version, __pyx_obj_dict_version))) {
       PY_UINT64_T __pyx_typedict_guard = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
       #endif
-      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_get_tree); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 232, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_get_tree); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 223, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       #ifdef __Pyx_CyFunction_USED
       if (!__Pyx_IsCyOrPyCFunction(__pyx_t_1)
       #else
       if (!PyCFunction_Check(__pyx_t_1)
       #endif
               || (PyCFunction_GET_FUNCTION(__pyx_t_1) != (PyCFunction)(void*)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_3get_tree)) {
@@ -7931,19 +8226,19 @@
             __pyx_t_5 = 1;
           }
         }
         {
           PyObject *__pyx_callargs[1] = {__pyx_t_4, };
           __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 0+__pyx_t_5);
           __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 232, __pyx_L1_error)
+          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 223, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         }
-        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 232, __pyx_L1_error)
+        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 223, __pyx_L1_error)
         __pyx_r = ((PyObject*)__pyx_t_2);
         __pyx_t_2 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         goto __pyx_L0;
       }
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
       __pyx_tp_dict_version = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
@@ -7954,75 +8249,120 @@
       #endif
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     }
     #endif
   }
 
-  /* "druhg/_druhg_tree.pyx":233
+  /* "druhg/_druhg_tree.pyx":224
  * 
  *     cpdef tuple get_tree(self):
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])             # <<<<<<<<<<<<<<
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\             # <<<<<<<<<<<<<<
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  * 
- *     cpdef tuple get_extras(self):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_2 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_self->result_pairs_arr), 0, (__pyx_v_self->result_edges * 2), NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 233, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_astype); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 233, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_self->result_values_arr), 0, (__pyx_v_self->result_edges * 2), NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 224, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_self->result_pairs_arr), 0, (__pyx_v_self->result_edges * 2), NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 224, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = NULL;
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_astype); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 224, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = NULL;
   __pyx_t_5 = 0;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
-    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
-    if (likely(__pyx_t_2)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-      __Pyx_INCREF(__pyx_t_2);
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_3)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_3);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_3, function);
+      __Pyx_DECREF_SET(__pyx_t_4, function);
       __pyx_t_5 = 1;
     }
   }
   {
-    PyObject *__pyx_callargs[2] = {__pyx_t_2, ((PyObject *)(&PyInt_Type))};
-    __pyx_t_1 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 233, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    PyObject *__pyx_callargs[2] = {__pyx_t_3, ((PyObject *)(&PyInt_Type))};
+    __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_4, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 224, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   }
-  __pyx_t_3 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_self->result_value_arr), 0, __pyx_v_self->result_edges, NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 233, __pyx_L1_error)
+
+  /* "druhg/_druhg_tree.pyx":225
+ *     cpdef tuple get_tree(self):
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)             # <<<<<<<<<<<<<<
+ * 
+ *     cpdef tuple get_buffers(self):
+ */
+  __pyx_t_3 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_self->result_rank_arr), 0, (__pyx_v_self->result_edges * 2), NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 225, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 233, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_astype); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 225, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = NULL;
+  __pyx_t_5 = 0;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
+    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
+    if (likely(__pyx_t_3)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
+      __Pyx_INCREF(__pyx_t_3);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_6, function);
+      __pyx_t_5 = 1;
+    }
+  }
+  {
+    PyObject *__pyx_callargs[2] = {__pyx_t_3, ((PyObject *)(&PyInt_Type))};
+    __pyx_t_4 = __Pyx_PyObject_FastCall(__pyx_t_6, __pyx_callargs+1-__pyx_t_5, 1+__pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 225, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  }
+
+  /* "druhg/_druhg_tree.pyx":224
+ * 
+ *     cpdef tuple get_tree(self):
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\             # <<<<<<<<<<<<<<
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
+ * 
+ */
+  __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 224, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
   __Pyx_GIVEREF(__pyx_t_1);
-  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_3);
+  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_2);
+  __Pyx_GIVEREF(__pyx_t_4);
+  PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_4);
   __pyx_t_1 = 0;
-  __pyx_t_3 = 0;
-  __pyx_r = ((PyObject*)__pyx_t_2);
   __pyx_t_2 = 0;
+  __pyx_t_4 = 0;
+  __pyx_r = ((PyObject*)__pyx_t_6);
+  __pyx_t_6 = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_tree.pyx":232
- *         self._compute_tree_edges(is_slow)
+  /* "druhg/_druhg_tree.pyx":223
+ *         self._compute_tree_edges()
  * 
  *     cpdef tuple get_tree(self):             # <<<<<<<<<<<<<<
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
- * 
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.get_tree", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
@@ -8065,15 +8405,15 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("get_tree", 0);
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_tree(__pyx_v_self, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 232, __pyx_L1_error)
+  __pyx_t_1 = __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_tree(__pyx_v_self, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 223, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
@@ -8082,58 +8422,58 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":235
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
+/* "druhg/_druhg_tree.pyx":227
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  * 
- *     cpdef tuple get_extras(self):             # <<<<<<<<<<<<<<
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])
+ *     cpdef tuple get_buffers(self):             # <<<<<<<<<<<<<<
+ *         return self.result_values_arr, self.U.parent_arr
  * 
  */
 
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras(PyObject *__pyx_v_self, 
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_extras(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, int __pyx_skip_dispatch) {
+static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_buffers(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, int __pyx_skip_dispatch) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   int __pyx_t_5;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("get_extras", 0);
+  __Pyx_RefNannySetupContext("get_buffers", 0);
   /* Check if called by wrapper */
   if (unlikely(__pyx_skip_dispatch)) ;
   /* Check if overridden in Python */
   else if (unlikely((Py_TYPE(((PyObject *)__pyx_v_self))->tp_dictoffset != 0) || __Pyx_PyType_HasFeature(Py_TYPE(((PyObject *)__pyx_v_self)), (Py_TPFLAGS_IS_ABSTRACT | Py_TPFLAGS_HEAPTYPE)))) {
     #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     static PY_UINT64_T __pyx_tp_dict_version = __PYX_DICT_VERSION_INIT, __pyx_obj_dict_version = __PYX_DICT_VERSION_INIT;
     if (unlikely(!__Pyx_object_dict_version_matches(((PyObject *)__pyx_v_self), __pyx_tp_dict_version, __pyx_obj_dict_version))) {
       PY_UINT64_T __pyx_typedict_guard = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
       #endif
-      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_get_extras); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 235, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_get_buffers); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 227, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       #ifdef __Pyx_CyFunction_USED
       if (!__Pyx_IsCyOrPyCFunction(__pyx_t_1)
       #else
       if (!PyCFunction_Check(__pyx_t_1)
       #endif
-              || (PyCFunction_GET_FUNCTION(__pyx_t_1) != (PyCFunction)(void*)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras)) {
+              || (PyCFunction_GET_FUNCTION(__pyx_t_1) != (PyCFunction)(void*)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers)) {
         __Pyx_XDECREF(__pyx_r);
         __Pyx_INCREF(__pyx_t_1);
         __pyx_t_3 = __pyx_t_1; __pyx_t_4 = NULL;
         __pyx_t_5 = 0;
         if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
           __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
           if (likely(__pyx_t_4)) {
@@ -8144,19 +8484,19 @@
             __pyx_t_5 = 1;
           }
         }
         {
           PyObject *__pyx_callargs[1] = {__pyx_t_4, };
           __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_3, __pyx_callargs+1-__pyx_t_5, 0+__pyx_t_5);
           __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 235, __pyx_L1_error)
+          if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 227, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         }
-        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 235, __pyx_L1_error)
+        if (!(likely(PyTuple_CheckExact(__pyx_t_2))||((__pyx_t_2) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_t_2))) __PYX_ERR(0, 227, __pyx_L1_error)
         __pyx_r = ((PyObject*)__pyx_t_2);
         __pyx_t_2 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         goto __pyx_L0;
       }
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
       __pyx_tp_dict_version = __Pyx_get_tp_dict_version(((PyObject *)__pyx_v_self));
@@ -8167,326 +8507,279 @@
       #endif
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_PYTYPE_LOOKUP && CYTHON_USE_TYPE_SLOTS
     }
     #endif
   }
 
-  /* "druhg/_druhg_tree.pyx":236
+  /* "druhg/_druhg_tree.pyx":228
+ * 
+ *     cpdef tuple get_buffers(self):
+ *         return self.result_values_arr, self.U.parent_arr             # <<<<<<<<<<<<<<
  * 
- *     cpdef tuple get_extras(self):
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])             # <<<<<<<<<<<<<<
  * 
- *     cdef void result_add_edge_debug(self, np.intp_t a, np.intp_t b, Relation* rel):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_result_extras1_arr); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 236, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetSlice(__pyx_t_1, 0, __pyx_v_self->result_edges, NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 236, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_result_extras2_arr); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 236, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __Pyx_PyObject_GetSlice(__pyx_t_1, 0, __pyx_v_self->result_edges, NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 236, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 236, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 228, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_2);
-  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_2);
-  __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_3);
-  __pyx_t_2 = 0;
-  __pyx_t_3 = 0;
+  __Pyx_INCREF((PyObject *)__pyx_v_self->result_values_arr);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_self->result_values_arr);
+  PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_self->result_values_arr));
+  __Pyx_INCREF((PyObject *)__pyx_v_self->U->parent_arr);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_self->U->parent_arr);
+  PyTuple_SET_ITEM(__pyx_t_1, 1, ((PyObject *)__pyx_v_self->U->parent_arr));
   __pyx_r = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_tree.pyx":235
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
+  /* "druhg/_druhg_tree.pyx":227
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  * 
- *     cpdef tuple get_extras(self):             # <<<<<<<<<<<<<<
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])
+ *     cpdef tuple get_buffers(self):             # <<<<<<<<<<<<<<
+ *         return self.result_values_arr, self.U.parent_arr
  * 
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
-  __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.get_extras", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.get_buffers", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* Python wrapper */
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras(PyObject *__pyx_v_self, 
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras = {"get_extras", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras(PyObject *__pyx_v_self, 
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers = {"get_buffers", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
   #if !CYTHON_METH_FASTCALL
   CYTHON_UNUSED const Py_ssize_t __pyx_nargs = PyTuple_GET_SIZE(__pyx_args);
   #endif
   CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_FASTCALL(__pyx_args, __pyx_nargs);
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("get_extras (wrapper)", 0);
+  __Pyx_RefNannySetupContext("get_buffers (wrapper)", 0);
   if (unlikely(__pyx_nargs > 0)) {
-    __Pyx_RaiseArgtupleInvalid("get_extras", 1, 0, 0, __pyx_nargs); return NULL;}
-  if (unlikely(__pyx_kwds) && __Pyx_NumKwargs_FASTCALL(__pyx_kwds) && unlikely(!__Pyx_CheckKeywordStrings(__pyx_kwds, "get_extras", 0))) return NULL;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_4get_extras(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self));
+    __Pyx_RaiseArgtupleInvalid("get_buffers", 1, 0, 0, __pyx_nargs); return NULL;}
+  if (unlikely(__pyx_kwds) && __Pyx_NumKwargs_FASTCALL(__pyx_kwds) && unlikely(!__Pyx_CheckKeywordStrings(__pyx_kwds, "get_buffers", 0))) return NULL;
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_4get_buffers(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_4get_extras(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_4get_buffers(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("get_extras", 0);
+  __Pyx_RefNannySetupContext("get_buffers", 0);
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_extras(__pyx_v_self, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 235, __pyx_L1_error)
+  __pyx_t_1 = __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_buffers(__pyx_v_self, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 227, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.get_extras", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.get_buffers", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":238
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])
+/* "druhg/_druhg_tree.pyx":231
+ * 
  * 
- *     cdef void result_add_edge_debug(self, np.intp_t a, np.intp_t b, Relation* rel):             # <<<<<<<<<<<<<<
+ *     cdef void result_write(self, np.double_t v, np.intp_t a, np.intp_t b, np.intp_t r):             # <<<<<<<<<<<<<<
  *         cdef np.intp_t i
  * 
  */
 
-static void __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_add_edge_debug(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_a, __pyx_t_5numpy_intp_t __pyx_v_b, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel) {
+static void __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_write(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_double_t __pyx_v_v, __pyx_t_5numpy_intp_t __pyx_v_a, __pyx_t_5numpy_intp_t __pyx_v_b, __pyx_t_5numpy_intp_t __pyx_v_r) {
   __pyx_t_5numpy_intp_t __pyx_v_i;
   __Pyx_RefNannyDeclarations
   __pyx_t_5numpy_intp_t __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_t_3;
+  int __pyx_t_4;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("result_add_edge_debug", 0);
+  __Pyx_RefNannySetupContext("result_write", 0);
 
-  /* "druhg/_druhg_tree.pyx":241
+  /* "druhg/_druhg_tree.pyx":234
  *         cdef np.intp_t i
  * 
  *         i = self.result_edges             # <<<<<<<<<<<<<<
  *         self.result_edges += 1
- * 
+ *         self.result_values_arr[i] = v
  */
   __pyx_t_1 = __pyx_v_self->result_edges;
   __pyx_v_i = __pyx_t_1;
 
-  /* "druhg/_druhg_tree.pyx":242
+  /* "druhg/_druhg_tree.pyx":235
  * 
  *         i = self.result_edges
  *         self.result_edges += 1             # <<<<<<<<<<<<<<
+ *         self.result_values_arr[i] = v
  * 
- *         self.result_pairs_arr[2*i] = a
  */
   __pyx_v_self->result_edges = (__pyx_v_self->result_edges + 1);
 
-  /* "druhg/_druhg_tree.pyx":244
+  /* "druhg/_druhg_tree.pyx":236
+ *         i = self.result_edges
  *         self.result_edges += 1
+ *         self.result_values_arr[i] = v             # <<<<<<<<<<<<<<
  * 
- *         self.result_pairs_arr[2*i] = a             # <<<<<<<<<<<<<<
- *         self.result_pairs_arr[2*i + 1] = b
- *         self.result_value_arr[i] = rel.dia_dis
- */
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 244, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = (2 * __pyx_v_i);
-  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_pairs_arr), __pyx_t_1, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 244, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_tree.pyx":245
- * 
- *         self.result_pairs_arr[2*i] = a
- *         self.result_pairs_arr[2*i + 1] = b             # <<<<<<<<<<<<<<
- *         self.result_value_arr[i] = rel.dia_dis
- *         # self.result_extras1_arr[i] = rel.rec_rank
- */
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 245, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = ((2 * __pyx_v_i) + 1);
-  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_pairs_arr), __pyx_t_1, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 245, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_tree.pyx":246
- *         self.result_pairs_arr[2*i] = a
- *         self.result_pairs_arr[2*i + 1] = b
- *         self.result_value_arr[i] = rel.dia_dis             # <<<<<<<<<<<<<<
- *         # self.result_extras1_arr[i] = rel.rec_rank
- *         # self.result_extras2_arr[i] = rel.my_members
+ *         if self.result_pairs_arr is not None:
  */
-  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_rel->dia_dis); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 246, __pyx_L1_error)
+  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_v); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 236, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_value_arr), __pyx_v_i, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 246, __pyx_L1_error)
+  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_values_arr), __pyx_v_i, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 236, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "druhg/_druhg_tree.pyx":238
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])
- * 
- *     cdef void result_add_edge_debug(self, np.intp_t a, np.intp_t b, Relation* rel):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t i
+ *         self.result_values_arr[i] = v
  * 
+ *         if self.result_pairs_arr is not None:             # <<<<<<<<<<<<<<
+ *             self.result_pairs_arr[2 * i] = a
+ *             self.result_pairs_arr[2 * i + 1] = b
  */
+  __pyx_t_3 = (((PyObject *)__pyx_v_self->result_pairs_arr) != Py_None);
+  __pyx_t_4 = (__pyx_t_3 != 0);
+  if (__pyx_t_4) {
 
-  /* function exit code */
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity.result_add_edge_debug", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-}
-
-/* "druhg/_druhg_tree.pyx":253
- *         # print(rel.reciprocity, self.result_edges, a,b, rel.rec_dis, 'rR', rel.my_rank, rel.rec_rank, 'Dd', rel.rec_dis, rel.my_dis, 'Mm', rel.my_members, rel.rec_members)
- * 
- *     cdef void result_add_edge(self, np.intp_t a, np.intp_t b, np.double_t v):             # <<<<<<<<<<<<<<
- *         cdef np.intp_t i
+    /* "druhg/_druhg_tree.pyx":239
  * 
+ *         if self.result_pairs_arr is not None:
+ *             self.result_pairs_arr[2 * i] = a             # <<<<<<<<<<<<<<
+ *             self.result_pairs_arr[2 * i + 1] = b
+ *         if self.result_rank_arr is not None:
  */
+    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 239, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = (2 * __pyx_v_i);
+    if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_pairs_arr), __pyx_t_1, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 239, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-static void __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_add_edge(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_a, __pyx_t_5numpy_intp_t __pyx_v_b, __pyx_t_5numpy_double_t __pyx_v_v) {
-  __pyx_t_5numpy_intp_t __pyx_v_i;
-  __Pyx_RefNannyDeclarations
-  __pyx_t_5numpy_intp_t __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("result_add_edge", 0);
-
-  /* "druhg/_druhg_tree.pyx":256
- *         cdef np.intp_t i
- * 
- *         i = self.result_edges             # <<<<<<<<<<<<<<
- *         self.result_edges += 1
- * 
+    /* "druhg/_druhg_tree.pyx":240
+ *         if self.result_pairs_arr is not None:
+ *             self.result_pairs_arr[2 * i] = a
+ *             self.result_pairs_arr[2 * i + 1] = b             # <<<<<<<<<<<<<<
+ *         if self.result_rank_arr is not None:
+ *             self.result_rank_arr[i] = r
  */
-  __pyx_t_1 = __pyx_v_self->result_edges;
-  __pyx_v_i = __pyx_t_1;
+    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 240, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = ((2 * __pyx_v_i) + 1);
+    if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_pairs_arr), __pyx_t_1, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 240, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":257
- * 
- *         i = self.result_edges
- *         self.result_edges += 1             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_tree.pyx":238
+ *         self.result_values_arr[i] = v
  * 
- *         self.result_pairs_arr[2*i] = a
+ *         if self.result_pairs_arr is not None:             # <<<<<<<<<<<<<<
+ *             self.result_pairs_arr[2 * i] = a
+ *             self.result_pairs_arr[2 * i + 1] = b
  */
-  __pyx_v_self->result_edges = (__pyx_v_self->result_edges + 1);
+  }
 
-  /* "druhg/_druhg_tree.pyx":259
- *         self.result_edges += 1
- * 
- *         self.result_pairs_arr[2*i] = a             # <<<<<<<<<<<<<<
- *         self.result_pairs_arr[2*i + 1] = b
- *         self.result_value_arr[i] = v
+  /* "druhg/_druhg_tree.pyx":241
+ *             self.result_pairs_arr[2 * i] = a
+ *             self.result_pairs_arr[2 * i + 1] = b
+ *         if self.result_rank_arr is not None:             # <<<<<<<<<<<<<<
+ *             self.result_rank_arr[i] = r
+ *         # print ('result_add_edge_two_values', a,b, v, r)
  */
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_a); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 259, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = (2 * __pyx_v_i);
-  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_pairs_arr), __pyx_t_1, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 259, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_4 = (((PyObject *)__pyx_v_self->result_rank_arr) != Py_None);
+  __pyx_t_3 = (__pyx_t_4 != 0);
+  if (__pyx_t_3) {
 
-  /* "druhg/_druhg_tree.pyx":260
- * 
- *         self.result_pairs_arr[2*i] = a
- *         self.result_pairs_arr[2*i + 1] = b             # <<<<<<<<<<<<<<
- *         self.result_value_arr[i] = v
+    /* "druhg/_druhg_tree.pyx":242
+ *             self.result_pairs_arr[2 * i + 1] = b
+ *         if self.result_rank_arr is not None:
+ *             self.result_rank_arr[i] = r             # <<<<<<<<<<<<<<
+ *         # print ('result_add_edge_two_values', a,b, v, r)
  * 
  */
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_b); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 260, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = ((2 * __pyx_v_i) + 1);
-  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_pairs_arr), __pyx_t_1, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 260, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_r); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 242, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_rank_arr), __pyx_v_i, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 242, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":261
- *         self.result_pairs_arr[2*i] = a
- *         self.result_pairs_arr[2*i + 1] = b
- *         self.result_value_arr[i] = v             # <<<<<<<<<<<<<<
- * 
- * 
+    /* "druhg/_druhg_tree.pyx":241
+ *             self.result_pairs_arr[2 * i] = a
+ *             self.result_pairs_arr[2 * i + 1] = b
+ *         if self.result_rank_arr is not None:             # <<<<<<<<<<<<<<
+ *             self.result_rank_arr[i] = r
+ *         # print ('result_add_edge_two_values', a,b, v, r)
  */
-  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_v); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 261, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  if (unlikely((__Pyx_SetItemInt(((PyObject *)__pyx_v_self->result_value_arr), __pyx_v_i, __pyx_t_2, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0) < 0))) __PYX_ERR(0, 261, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  }
 
-  /* "druhg/_druhg_tree.pyx":253
- *         # print(rel.reciprocity, self.result_edges, a,b, rel.rec_dis, 'rR', rel.my_rank, rel.rec_rank, 'Dd', rel.rec_dis, rel.my_dis, 'Mm', rel.my_members, rel.rec_members)
+  /* "druhg/_druhg_tree.pyx":231
  * 
- *     cdef void result_add_edge(self, np.intp_t a, np.intp_t b, np.double_t v):             # <<<<<<<<<<<<<<
+ * 
+ *     cdef void result_write(self, np.double_t v, np.intp_t a, np.intp_t b, np.intp_t r):             # <<<<<<<<<<<<<<
  *         cdef np.intp_t i
  * 
  */
 
   /* function exit code */
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity.result_add_edge", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
+  __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity.result_write", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
 }
 
-/* "druhg/_druhg_tree.pyx":264
+/* "druhg/_druhg_tree.pyx":246
  * 
  * 
- *     cdef bint _pure_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation* rel, np.intp_t* infinitesimal):             # <<<<<<<<<<<<<<
- *         """Finding pure reciprocal pairs(both ranks = 2)
- *         And deals with equal objects.
+ *     cdef bint _pure_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist,             # <<<<<<<<<<<<<<
+ *                                        Relation* rel, np.intp_t* infinitesimal):
+ *         cdef:
  */
 
 static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__pure_reciprocity(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel, __pyx_t_5numpy_intp_t *__pyx_v_infinitesimal) {
   __pyx_t_5numpy_intp_t __pyx_v_ranki;
   __pyx_t_5numpy_intp_t __pyx_v_j;
-  __pyx_t_5numpy_intp_t __pyx_v_rank_left;
-  __pyx_t_5numpy_intp_t __pyx_v_rank_right;
   __pyx_t_5numpy_intp_t __pyx_v_parent;
+  __pyx_t_5numpy_intp_t __pyx_v_rank;
+  __pyx_t_5numpy_intp_t __pyx_v_orank;
+  CYTHON_UNUSED __pyx_t_5numpy_intp_t __pyx_v_res;
   __pyx_t_5numpy_double_t __pyx_v_dis;
-  PyObject *__pyx_v_indices = NULL;
-  PyObject *__pyx_v_distances = NULL;
+  PyArrayObject *__pyx_v_indices = 0;
+  PyArrayObject *__pyx_v_distances = 0;
   __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_dist;
   __Pyx_Buffer __pyx_pybuffer_knn_dist;
   __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_indices;
   __Pyx_Buffer __pyx_pybuffer_knn_indices;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
@@ -8511,281 +8804,273 @@
   __pyx_pybuffernd_knn_indices.rcbuffer = &__pyx_pybuffer_knn_indices;
   __pyx_pybuffer_knn_dist.pybuffer.buf = NULL;
   __pyx_pybuffer_knn_dist.refcount = 0;
   __pyx_pybuffernd_knn_dist.data = NULL;
   __pyx_pybuffernd_knn_dist.rcbuffer = &__pyx_pybuffer_knn_dist;
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
-    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 264, __pyx_L1_error)
+    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 246, __pyx_L1_error)
   }
   __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
-    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 264, __pyx_L1_error)
+    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 246, __pyx_L1_error)
   }
   __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
 
-  /* "druhg/_druhg_tree.pyx":303
- *             np.double_t dis
+  /* "druhg/_druhg_tree.pyx":249
+ *                                        Relation* rel, np.intp_t* infinitesimal):
+ *         cdef:
+ *             np.intp_t ranki, j, \             # <<<<<<<<<<<<<<
+ *                 parent, \
+ *                 rank, orank, \
+ */
+  __pyx_v_res = 0;
+
+  /* "druhg/_druhg_tree.pyx":259
+ *             np.ndarray distances, dis_opp
  * 
- *         parent = self.U.fast_find(i)             # <<<<<<<<<<<<<<
+ *         parent = self.U.mark_up(i)             # <<<<<<<<<<<<<<
  *         indices, distances = knn_indices[i], knn_dist[i]
- *         for ranki in range(0, self.max_neighbors_search + 1):
+ * 
  */
-  __pyx_v_parent = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_v_self->U, __pyx_v_i);
+  __pyx_v_parent = ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_v_self->U, __pyx_v_i);
 
-  /* "druhg/_druhg_tree.pyx":304
+  /* "druhg/_druhg_tree.pyx":260
  * 
- *         parent = self.U.fast_find(i)
+ *         parent = self.U.mark_up(i)
  *         indices, distances = knn_indices[i], knn_dist[i]             # <<<<<<<<<<<<<<
- *         for ranki in range(0, self.max_neighbors_search + 1):
- *             j = indices[ranki]
+ * 
+ *         rel.reciprocity = INF
  */
-  __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_indices), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 304, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_indices), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 260, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 304, __pyx_L1_error)
+  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 260, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 260, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_v_indices = __pyx_t_1;
+  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 260, __pyx_L1_error)
+  __pyx_v_indices = ((PyArrayObject *)__pyx_t_1);
   __pyx_t_1 = 0;
-  __pyx_v_distances = __pyx_t_2;
+  __pyx_v_distances = ((PyArrayObject *)__pyx_t_2);
   __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":305
- *         parent = self.U.fast_find(i)
+  /* "druhg/_druhg_tree.pyx":262
  *         indices, distances = knn_indices[i], knn_dist[i]
+ * 
+ *         rel.reciprocity = INF             # <<<<<<<<<<<<<<
+ *         for ranki in range(0, self.max_neighbors_search + 1):
+ *             j = indices[ranki]
+ */
+  __pyx_v_rel->reciprocity = __pyx_v_5druhg_11_druhg_tree_INF;
+
+  /* "druhg/_druhg_tree.pyx":263
+ * 
+ *         rel.reciprocity = INF
  *         for ranki in range(0, self.max_neighbors_search + 1):             # <<<<<<<<<<<<<<
  *             j = indices[ranki]
- *             if parent == self.U.fast_find(j):
+ * 
  */
   __pyx_t_3 = (__pyx_v_self->max_neighbors_search + 1);
   __pyx_t_4 = __pyx_t_3;
   for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
     __pyx_v_ranki = __pyx_t_5;
 
-    /* "druhg/_druhg_tree.pyx":306
- *         indices, distances = knn_indices[i], knn_dist[i]
+    /* "druhg/_druhg_tree.pyx":264
+ *         rel.reciprocity = INF
  *         for ranki in range(0, self.max_neighbors_search + 1):
  *             j = indices[ranki]             # <<<<<<<<<<<<<<
- *             if parent == self.U.fast_find(j):
- *                 continue
+ * 
+ *             if parent == self.U.mark_up(j):
  */
-    __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_indices, __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 306, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_indices), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 264, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 306, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 264, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __pyx_v_j = __pyx_t_6;
 
-    /* "druhg/_druhg_tree.pyx":307
- *         for ranki in range(0, self.max_neighbors_search + 1):
+    /* "druhg/_druhg_tree.pyx":266
  *             j = indices[ranki]
- *             if parent == self.U.fast_find(j):             # <<<<<<<<<<<<<<
+ * 
+ *             if parent == self.U.mark_up(j):             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
-    __pyx_t_7 = ((__pyx_v_parent == ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_v_self->U, __pyx_v_j)) != 0);
+    __pyx_t_7 = ((__pyx_v_parent == ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_v_self->U, __pyx_v_j)) != 0);
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_tree.pyx":308
- *             j = indices[ranki]
- *             if parent == self.U.fast_find(j):
+      /* "druhg/_druhg_tree.pyx":267
+ * 
+ *             if parent == self.U.mark_up(j):
  *                 continue             # <<<<<<<<<<<<<<
  * 
  *             dis = distances[ranki]
  */
       goto __pyx_L3_continue;
 
-      /* "druhg/_druhg_tree.pyx":307
- *         for ranki in range(0, self.max_neighbors_search + 1):
+      /* "druhg/_druhg_tree.pyx":266
  *             j = indices[ranki]
- *             if parent == self.U.fast_find(j):             # <<<<<<<<<<<<<<
+ * 
+ *             if parent == self.U.mark_up(j):             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":310
+    /* "druhg/_druhg_tree.pyx":269
  *                 continue
  * 
  *             dis = distances[ranki]             # <<<<<<<<<<<<<<
  *             if dis == 0.: # degenerate case.
  *                 rel.reciprocity = 0.
  */
-    __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_distances, __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 310, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 269, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_8 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 310, __pyx_L1_error)
+    __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_8 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 269, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __pyx_v_dis = __pyx_t_8;
 
-    /* "druhg/_druhg_tree.pyx":311
+    /* "druhg/_druhg_tree.pyx":270
  * 
  *             dis = distances[ranki]
  *             if dis == 0.: # degenerate case.             # <<<<<<<<<<<<<<
  *                 rel.reciprocity = 0.
- *                 rel.target = j
+ *                 rel.endpoint = j
  */
     __pyx_t_7 = ((__pyx_v_dis == 0.) != 0);
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_tree.pyx":312
+      /* "druhg/_druhg_tree.pyx":271
  *             dis = distances[ranki]
  *             if dis == 0.: # degenerate case.
  *                 rel.reciprocity = 0.             # <<<<<<<<<<<<<<
- *                 rel.target = j
- *                 # rel.my_rank = ranki
+ *                 rel.endpoint = j
+ *                 return 1
  */
       __pyx_v_rel->reciprocity = 0.;
 
-      /* "druhg/_druhg_tree.pyx":313
+      /* "druhg/_druhg_tree.pyx":272
  *             if dis == 0.: # degenerate case.
  *                 rel.reciprocity = 0.
- *                 rel.target = j             # <<<<<<<<<<<<<<
- *                 # rel.my_rank = ranki
- *                 # rel.rec_rank = ranki
+ *                 rel.endpoint = j             # <<<<<<<<<<<<<<
+ *                 return 1
+ *             infinitesimal += dis <= self.PRECISION
  */
-      __pyx_v_rel->target = __pyx_v_j;
+      __pyx_v_rel->endpoint = __pyx_v_j;
 
-      /* "druhg/_druhg_tree.pyx":317
- *                 # rel.rec_rank = ranki
- *                 # rel.my_dis = 0.
- *                 rel.dia_dis = 0.             # <<<<<<<<<<<<<<
- *                 # rel.my_members = ranki
- *                 # rel.rec_members = 1
- */
-      __pyx_v_rel->dia_dis = 0.;
-
-      /* "druhg/_druhg_tree.pyx":322
- *                 # rel.index = i
- * 
- *                 return ranki + 1             # <<<<<<<<<<<<<<
+      /* "druhg/_druhg_tree.pyx":273
+ *                 rel.reciprocity = 0.
+ *                 rel.endpoint = j
+ *                 return 1             # <<<<<<<<<<<<<<
+ *             infinitesimal += dis <= self.PRECISION
  * 
- *             if dis <= self.PRECISION:
  */
-      __pyx_r = (__pyx_v_ranki + 1);
+      __pyx_r = 1;
       goto __pyx_L0;
 
-      /* "druhg/_druhg_tree.pyx":311
+      /* "druhg/_druhg_tree.pyx":270
  * 
  *             dis = distances[ranki]
  *             if dis == 0.: # degenerate case.             # <<<<<<<<<<<<<<
  *                 rel.reciprocity = 0.
- *                 rel.target = j
+ *                 rel.endpoint = j
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":324
- *                 return ranki + 1
- * 
- *             if dis <= self.PRECISION:             # <<<<<<<<<<<<<<
- *                 infinitesimal += 1
- * 
- */
-    __pyx_t_7 = ((__pyx_v_dis <= __pyx_v_self->PRECISION) != 0);
-    if (__pyx_t_7) {
-
-      /* "druhg/_druhg_tree.pyx":325
- * 
- *             if dis <= self.PRECISION:
- *                 infinitesimal += 1             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_tree.pyx":274
+ *                 rel.endpoint = j
+ *                 return 1
+ *             infinitesimal += dis <= self.PRECISION             # <<<<<<<<<<<<<<
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION)
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
  */
-      __pyx_v_infinitesimal = (__pyx_v_infinitesimal + 1);
+    __pyx_v_infinitesimal = (__pyx_v_infinitesimal + (__pyx_v_dis <= __pyx_v_self->PRECISION));
 
-      /* "druhg/_druhg_tree.pyx":324
- *                 return ranki + 1
+    /* "druhg/_druhg_tree.pyx":276
+ *             infinitesimal += dis <= self.PRECISION
  * 
- *             if dis <= self.PRECISION:             # <<<<<<<<<<<<<<
- *                 infinitesimal += 1
- * 
- */
-    }
-
-    /* "druhg/_druhg_tree.pyx":327
- *                 infinitesimal += 1
- * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION)             # <<<<<<<<<<<<<<
- *             if rank_left > 2:
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)             # <<<<<<<<<<<<<<
+ *             if rank > 2:
  *                 return 0
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 327, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 276, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 327, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 276, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 327, __pyx_L1_error)
+    __pyx_t_1 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 276, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __pyx_t_10 = NULL;
     __pyx_t_11 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
       __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_9);
       if (likely(__pyx_t_10)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
         __Pyx_INCREF(__pyx_t_10);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_9, function);
         __pyx_t_11 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[3] = {__pyx_t_10, __pyx_v_distances, __pyx_t_1};
+      PyObject *__pyx_callargs[3] = {__pyx_t_10, ((PyObject *)__pyx_v_distances), __pyx_t_1};
       __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
       __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 327, __pyx_L1_error)
+      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 276, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
     }
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 327, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 276, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_v_rank_left = __pyx_t_6;
+    __pyx_v_rank = __pyx_t_6;
 
-    /* "druhg/_druhg_tree.pyx":328
+    /* "druhg/_druhg_tree.pyx":277
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION)
- *             if rank_left > 2:             # <<<<<<<<<<<<<<
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
+ *             if rank > 2:             # <<<<<<<<<<<<<<
  *                 return 0
  * 
  */
-    __pyx_t_7 = ((__pyx_v_rank_left > 2) != 0);
+    __pyx_t_7 = ((__pyx_v_rank > 2) != 0);
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_tree.pyx":329
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION)
- *             if rank_left > 2:
+      /* "druhg/_druhg_tree.pyx":278
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
+ *             if rank > 2:
  *                 return 0             # <<<<<<<<<<<<<<
  * 
- *             rank_right = bisect.bisect(knn_dist[j], dis + self.PRECISION)
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION) # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)
  */
       __pyx_r = 0;
       goto __pyx_L0;
 
-      /* "druhg/_druhg_tree.pyx":328
+      /* "druhg/_druhg_tree.pyx":277
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION)
- *             if rank_left > 2:             # <<<<<<<<<<<<<<
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
+ *             if rank > 2:             # <<<<<<<<<<<<<<
  *                 return 0
  * 
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":331
+    /* "druhg/_druhg_tree.pyx":280
  *                 return 0
  * 
- *             rank_right = bisect.bisect(knn_dist[j], dis + self.PRECISION)             # <<<<<<<<<<<<<<
- *             if rank_right > 2:
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION) # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)             # <<<<<<<<<<<<<<
+ *             if orank > 2:
  *                 return 0
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 280, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 280, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_t_9 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_j, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_j, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 280, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_10 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __pyx_t_10 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 280, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
     __pyx_t_12 = NULL;
     __pyx_t_11 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
       __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_1);
       if (likely(__pyx_t_12)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
@@ -8797,106 +9082,97 @@
     }
     {
       PyObject *__pyx_callargs[3] = {__pyx_t_12, __pyx_t_9, __pyx_t_10};
       __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_1, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
       __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 331, __pyx_L1_error)
+      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 280, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     }
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 331, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 280, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_v_rank_right = __pyx_t_6;
+    __pyx_v_orank = __pyx_t_6;
 
-    /* "druhg/_druhg_tree.pyx":332
+    /* "druhg/_druhg_tree.pyx":281
  * 
- *             rank_right = bisect.bisect(knn_dist[j], dis + self.PRECISION)
- *             if rank_right > 2:             # <<<<<<<<<<<<<<
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION) # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)
+ *             if orank > 2:             # <<<<<<<<<<<<<<
  *                 return 0
  * 
  */
-    __pyx_t_7 = ((__pyx_v_rank_right > 2) != 0);
+    __pyx_t_7 = ((__pyx_v_orank > 2) != 0);
     if (__pyx_t_7) {
 
-      /* "druhg/_druhg_tree.pyx":333
- *             rank_right = bisect.bisect(knn_dist[j], dis + self.PRECISION)
- *             if rank_right > 2:
+      /* "druhg/_druhg_tree.pyx":282
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION) # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)
+ *             if orank > 2:
  *                 return 0             # <<<<<<<<<<<<<<
  * 
  *             rel.reciprocity = dis
  */
       __pyx_r = 0;
       goto __pyx_L0;
 
-      /* "druhg/_druhg_tree.pyx":332
+      /* "druhg/_druhg_tree.pyx":281
  * 
- *             rank_right = bisect.bisect(knn_dist[j], dis + self.PRECISION)
- *             if rank_right > 2:             # <<<<<<<<<<<<<<
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION) # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)
+ *             if orank > 2:             # <<<<<<<<<<<<<<
  *                 return 0
  * 
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":335
+    /* "druhg/_druhg_tree.pyx":284
  *                 return 0
  * 
  *             rel.reciprocity = dis             # <<<<<<<<<<<<<<
- *             rel.target = j
- *             # rel.my_rank = 2
+ *             rel.endpoint = j
+ *             return 1
  */
     __pyx_v_rel->reciprocity = __pyx_v_dis;
 
-    /* "druhg/_druhg_tree.pyx":336
+    /* "druhg/_druhg_tree.pyx":285
  * 
  *             rel.reciprocity = dis
- *             rel.target = j             # <<<<<<<<<<<<<<
- *             # rel.my_rank = 2
- *             # rel.rec_rank = 2
- */
-    __pyx_v_rel->target = __pyx_v_j;
-
-    /* "druhg/_druhg_tree.pyx":340
- *             # rel.rec_rank = 2
- *             # rel.my_dis = dis
- *             rel.dia_dis = dis             # <<<<<<<<<<<<<<
- *             # rel.my_members = 1
- *             # rel.rec_members = 1
+ *             rel.endpoint = j             # <<<<<<<<<<<<<<
+ *             return 1
+ * 
  */
-    __pyx_v_rel->dia_dis = __pyx_v_dis;
+    __pyx_v_rel->endpoint = __pyx_v_j;
 
-    /* "druhg/_druhg_tree.pyx":345
- *             # rel.index = i
+    /* "druhg/_druhg_tree.pyx":286
+ *             rel.reciprocity = dis
+ *             rel.endpoint = j
+ *             return 1             # <<<<<<<<<<<<<<
  * 
- *             return 2             # <<<<<<<<<<<<<<
  *         return 0
- * 
  */
-    __pyx_r = 2;
+    __pyx_r = 1;
     goto __pyx_L0;
     __pyx_L3_continue:;
   }
 
-  /* "druhg/_druhg_tree.pyx":346
+  /* "druhg/_druhg_tree.pyx":288
+ *             return 1
  * 
- *             return 2
  *         return 0             # <<<<<<<<<<<<<<
  * 
- *     cdef bint _evaluate_reciprocity_slow(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation *rel):
+ *     cdef bint _evaluate_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation* rel):
  */
   __pyx_r = 0;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_tree.pyx":264
+  /* "druhg/_druhg_tree.pyx":246
  * 
  * 
- *     cdef bint _pure_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation* rel, np.intp_t* infinitesimal):             # <<<<<<<<<<<<<<
- *         """Finding pure reciprocal pairs(both ranks = 2)
- *         And deals with equal objects.
+ *     cdef bint _pure_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist,             # <<<<<<<<<<<<<<
+ *                                        Relation* rel, np.intp_t* infinitesimal):
+ *         cdef:
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_9);
@@ -8912,1027 +9188,514 @@
   __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity._pure_reciprocity", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __pyx_r = 0;
   goto __pyx_L2;
   __pyx_L0:;
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
   __pyx_L2:;
-  __Pyx_XDECREF(__pyx_v_indices);
-  __Pyx_XDECREF(__pyx_v_distances);
+  __Pyx_XDECREF((PyObject *)__pyx_v_indices);
+  __Pyx_XDECREF((PyObject *)__pyx_v_distances);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":348
+/* "druhg/_druhg_tree.pyx":290
  *         return 0
  * 
- *     cdef bint _evaluate_reciprocity_slow(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation *rel):             # <<<<<<<<<<<<<<
- * 
+ *     cdef bint _evaluate_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation* rel):             # <<<<<<<<<<<<<<
  *         cdef:
+ *             np.intp_t j, ranki, skip_first, \
  */
 
-static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity_slow(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel) {
-  __pyx_t_5numpy_intp_t __pyx_v_ranki;
+static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel) {
   __pyx_t_5numpy_intp_t __pyx_v_j;
+  __pyx_t_5numpy_intp_t __pyx_v_ranki;
+  __pyx_t_5numpy_intp_t __pyx_v_skip_first;
   __pyx_t_5numpy_intp_t __pyx_v_parent;
-  __pyx_t_5numpy_intp_t __pyx_v_rank_left;
-  __pyx_t_5numpy_intp_t __pyx_v_rank_right;
+  __pyx_t_5numpy_intp_t __pyx_v_rank;
+  __pyx_t_5numpy_intp_t __pyx_v_orank;
   __pyx_t_5numpy_intp_t __pyx_v_res;
   __pyx_t_5numpy_double_t __pyx_v_best;
-  __pyx_t_5numpy_double_t __pyx_v_order;
+  __pyx_t_5numpy_double_t __pyx_v_v;
   __pyx_t_5numpy_double_t __pyx_v_dis;
-  __pyx_t_5numpy_double_t __pyx_v_rank_dis;
+  __pyx_t_5numpy_double_t __pyx_v_odis;
   PyArrayObject *__pyx_v_indices = 0;
   PyArrayObject *__pyx_v_distances = 0;
-  PyArrayObject *__pyx_v_dis_opp = 0;
   __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_dist;
   __Pyx_Buffer __pyx_pybuffer_knn_dist;
   __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_indices;
   __Pyx_Buffer __pyx_pybuffer_knn_indices;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
+  __pyx_t_5numpy_intp_t __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
-  __pyx_t_5numpy_intp_t __pyx_t_3;
+  PyObject *__pyx_t_3 = NULL;
   __pyx_t_5numpy_intp_t __pyx_t_4;
   __pyx_t_5numpy_intp_t __pyx_t_5;
   __pyx_t_5numpy_intp_t __pyx_t_6;
   __pyx_t_5numpy_double_t __pyx_t_7;
   int __pyx_t_8;
   PyObject *__pyx_t_9 = NULL;
   PyObject *__pyx_t_10 = NULL;
-  int __pyx_t_11;
-  Py_ssize_t __pyx_t_12;
+  PyObject *__pyx_t_11 = NULL;
+  int __pyx_t_12;
+  __pyx_t_5numpy_double_t __pyx_t_13;
+  __pyx_t_5numpy_double_t __pyx_t_14;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("_evaluate_reciprocity_slow", 0);
+  __Pyx_RefNannySetupContext("_evaluate_reciprocity", 0);
   __pyx_pybuffer_knn_indices.pybuffer.buf = NULL;
   __pyx_pybuffer_knn_indices.refcount = 0;
   __pyx_pybuffernd_knn_indices.data = NULL;
   __pyx_pybuffernd_knn_indices.rcbuffer = &__pyx_pybuffer_knn_indices;
   __pyx_pybuffer_knn_dist.pybuffer.buf = NULL;
   __pyx_pybuffer_knn_dist.refcount = 0;
   __pyx_pybuffernd_knn_dist.data = NULL;
   __pyx_pybuffernd_knn_dist.rcbuffer = &__pyx_pybuffer_knn_dist;
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
-    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 348, __pyx_L1_error)
+    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 290, __pyx_L1_error)
   }
   __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
   {
     __Pyx_BufFmt_StackElem __pyx_stack[1];
-    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 348, __pyx_L1_error)
+    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 290, __pyx_L1_error)
   }
   __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
 
-  /* "druhg/_druhg_tree.pyx":351
- * 
+  /* "druhg/_druhg_tree.pyx":292
+ *     cdef bint _evaluate_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation* rel):
  *         cdef:
- *             np.intp_t ranki, j, \             # <<<<<<<<<<<<<<
+ *             np.intp_t j, ranki, skip_first, \             # <<<<<<<<<<<<<<
  *                 parent, \
- *                 rank_left, rank_right, \
+ *                 rank, orank, \
  */
   __pyx_v_res = 0;
 
-  /* "druhg/_druhg_tree.pyx":362
+  /* "druhg/_druhg_tree.pyx":303
  *             np.ndarray distances, dis_opp
  * 
- *         parent = self.U.fast_find(i)             # <<<<<<<<<<<<<<
+ *         skip_first = rel.skip_first             # <<<<<<<<<<<<<<
+ * 
+ *         parent = self.U.mark_up(i)
+ */
+  __pyx_t_1 = __pyx_v_rel->skip_first;
+  __pyx_v_skip_first = __pyx_t_1;
+
+  /* "druhg/_druhg_tree.pyx":305
+ *         skip_first = rel.skip_first
+ * 
+ *         parent = self.U.mark_up(i)             # <<<<<<<<<<<<<<
  *         indices, distances = knn_indices[i], knn_dist[i]
  * 
  */
-  __pyx_v_parent = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_v_self->U, __pyx_v_i);
+  __pyx_v_parent = ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_v_self->U, __pyx_v_i);
 
-  /* "druhg/_druhg_tree.pyx":363
+  /* "druhg/_druhg_tree.pyx":306
  * 
- *         parent = self.U.fast_find(i)
+ *         parent = self.U.mark_up(i)
  *         indices, distances = knn_indices[i], knn_dist[i]             # <<<<<<<<<<<<<<
  * 
  *         best = INF
  */
-  __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_indices), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 363, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 363, __pyx_L1_error)
-  __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 363, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_indices), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 306, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 363, __pyx_L1_error)
-  __pyx_v_indices = ((PyArrayObject *)__pyx_t_1);
-  __pyx_t_1 = 0;
-  __pyx_v_distances = ((PyArrayObject *)__pyx_t_2);
+  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 306, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 306, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 306, __pyx_L1_error)
+  __pyx_v_indices = ((PyArrayObject *)__pyx_t_2);
   __pyx_t_2 = 0;
+  __pyx_v_distances = ((PyArrayObject *)__pyx_t_3);
+  __pyx_t_3 = 0;
 
-  /* "druhg/_druhg_tree.pyx":365
+  /* "druhg/_druhg_tree.pyx":308
  *         indices, distances = knn_indices[i], knn_dist[i]
  * 
  *         best = INF             # <<<<<<<<<<<<<<
- *         # print(self.max_neighbors_search, 'yo',distances)
- *         for ranki in range(0, self.max_neighbors_search + 1):
+ *         rel.reciprocity = best
+ *         for ranki in range(skip_first, self.max_neighbors_search + 1):
  */
   __pyx_v_best = __pyx_v_5druhg_11_druhg_tree_INF;
 
-  /* "druhg/_druhg_tree.pyx":367
+  /* "druhg/_druhg_tree.pyx":309
+ * 
  *         best = INF
- *         # print(self.max_neighbors_search, 'yo',distances)
- *         for ranki in range(0, self.max_neighbors_search + 1):             # <<<<<<<<<<<<<<
+ *         rel.reciprocity = best             # <<<<<<<<<<<<<<
+ *         for ranki in range(skip_first, self.max_neighbors_search + 1):
+ *             j = indices[ranki]
+ */
+  __pyx_v_rel->reciprocity = __pyx_v_best;
+
+  /* "druhg/_druhg_tree.pyx":310
+ *         best = INF
+ *         rel.reciprocity = best
+ *         for ranki in range(skip_first, self.max_neighbors_search + 1):             # <<<<<<<<<<<<<<
  *             j = indices[ranki]
  *             dis = distances[ranki]
  */
-  __pyx_t_3 = (__pyx_v_self->max_neighbors_search + 1);
-  __pyx_t_4 = __pyx_t_3;
-  for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
+  __pyx_t_1 = (__pyx_v_self->max_neighbors_search + 1);
+  __pyx_t_4 = __pyx_t_1;
+  for (__pyx_t_5 = __pyx_v_skip_first; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
     __pyx_v_ranki = __pyx_t_5;
 
-    /* "druhg/_druhg_tree.pyx":368
- *         # print(self.max_neighbors_search, 'yo',distances)
- *         for ranki in range(0, self.max_neighbors_search + 1):
+    /* "druhg/_druhg_tree.pyx":311
+ *         rel.reciprocity = best
+ *         for ranki in range(skip_first, self.max_neighbors_search + 1):
  *             j = indices[ranki]             # <<<<<<<<<<<<<<
  *             dis = distances[ranki]
  * 
  */
-    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_indices), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 368, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 368, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_3 = __Pyx_GetItemInt(((PyObject *)__pyx_v_indices), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 311, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 311, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __pyx_v_j = __pyx_t_6;
 
-    /* "druhg/_druhg_tree.pyx":369
- *         for ranki in range(0, self.max_neighbors_search + 1):
+    /* "druhg/_druhg_tree.pyx":312
+ *         for ranki in range(skip_first, self.max_neighbors_search + 1):
  *             j = indices[ranki]
  *             dis = distances[ranki]             # <<<<<<<<<<<<<<
  * 
- *             if parent == self.U.fast_find(j):
+ *             if dis - self.PRECISION > best:
  */
-    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 369, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_7 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 369, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_3 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 312, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_3); if (unlikely((__pyx_t_7 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 312, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __pyx_v_dis = __pyx_t_7;
 
-    /* "druhg/_druhg_tree.pyx":371
- *             dis = distances[ranki]
- * 
- *             if parent == self.U.fast_find(j):             # <<<<<<<<<<<<<<
- *                 continue
- * 
- */
-    __pyx_t_8 = ((__pyx_v_parent == ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_v_self->U, __pyx_v_j)) != 0);
-    if (__pyx_t_8) {
-
-      /* "druhg/_druhg_tree.pyx":372
- * 
- *             if parent == self.U.fast_find(j):
- *                 continue             # <<<<<<<<<<<<<<
- * 
- *             if dis >= best + self.PRECISION:
- */
-      goto __pyx_L3_continue;
-
-      /* "druhg/_druhg_tree.pyx":371
+    /* "druhg/_druhg_tree.pyx":314
  *             dis = distances[ranki]
  * 
- *             if parent == self.U.fast_find(j):             # <<<<<<<<<<<<<<
- *                 continue
- * 
- */
-    }
-
-    /* "druhg/_druhg_tree.pyx":374
- *                 continue
- * 
- *             if dis >= best + self.PRECISION:             # <<<<<<<<<<<<<<
+ *             if dis - self.PRECISION > best:             # <<<<<<<<<<<<<<
  *                 break
  * 
  */
-    __pyx_t_8 = ((__pyx_v_dis >= (__pyx_v_best + __pyx_v_self->PRECISION)) != 0);
+    __pyx_t_8 = (((__pyx_v_dis - __pyx_v_self->PRECISION) > __pyx_v_best) != 0);
     if (__pyx_t_8) {
 
-      /* "druhg/_druhg_tree.pyx":375
+      /* "druhg/_druhg_tree.pyx":315
  * 
- *             if dis >= best + self.PRECISION:
+ *             if dis - self.PRECISION > best:
  *                 break             # <<<<<<<<<<<<<<
  * 
- *             dis_opp = knn_dist[j]
+ *             if self.U.is_same_parent(parent, j):
  */
       goto __pyx_L4_break;
 
-      /* "druhg/_druhg_tree.pyx":374
- *                 continue
+      /* "druhg/_druhg_tree.pyx":314
+ *             dis = distances[ranki]
  * 
- *             if dis >= best + self.PRECISION:             # <<<<<<<<<<<<<<
+ *             if dis - self.PRECISION > best:             # <<<<<<<<<<<<<<
  *                 break
  * 
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":377
+    /* "druhg/_druhg_tree.pyx":317
  *                 break
  * 
- *             dis_opp = knn_dist[j]             # <<<<<<<<<<<<<<
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:
- */
-    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_j, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 377, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 377, __pyx_L1_error)
-    __Pyx_XDECREF_SET(__pyx_v_dis_opp, ((PyArrayObject *)__pyx_t_2));
-    __pyx_t_2 = 0;
-
-    /* "druhg/_druhg_tree.pyx":378
- * 
- *             dis_opp = knn_dist[j]
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)             # <<<<<<<<<<<<<<
- *             if ranki > rank_right:
+ *             if self.U.is_same_parent(parent, j):             # <<<<<<<<<<<<<<
+ *                 rel.skip_first += ranki == rel.skip_first
  *                 continue
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 378, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 378, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 378, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_10 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
-      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_9);
-      if (likely(__pyx_t_10)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-        __Pyx_INCREF(__pyx_t_10);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_9, function);
-        __pyx_t_11 = 1;
-      }
-    }
-    {
-      PyObject *__pyx_callargs[3] = {__pyx_t_10, ((PyObject *)__pyx_v_dis_opp), __pyx_t_1};
-      __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 378, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    }
-    __pyx_t_9 = __Pyx_PyInt_SubtractObjC(__pyx_t_2, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 378, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 378, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_v_rank_right = __pyx_t_6;
+    __pyx_t_8 = (((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_v_self->U->__pyx_vtab)->is_same_parent(__pyx_v_self->U, __pyx_v_parent, __pyx_v_j) != 0);
+    if (__pyx_t_8) {
 
-    /* "druhg/_druhg_tree.pyx":379
- *             dis_opp = knn_dist[j]
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:             # <<<<<<<<<<<<<<
+      /* "druhg/_druhg_tree.pyx":318
+ * 
+ *             if self.U.is_same_parent(parent, j):
+ *                 rel.skip_first += ranki == rel.skip_first             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
-    __pyx_t_8 = ((__pyx_v_ranki > __pyx_v_rank_right) != 0);
-    if (__pyx_t_8) {
+      __pyx_v_rel->skip_first = (__pyx_v_rel->skip_first + (__pyx_v_ranki == __pyx_v_rel->skip_first));
 
-      /* "druhg/_druhg_tree.pyx":380
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:
+      /* "druhg/_druhg_tree.pyx":319
+ *             if self.U.is_same_parent(parent, j):
+ *                 rel.skip_first += ranki == rel.skip_first
  *                 continue             # <<<<<<<<<<<<<<
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION)  # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)
  */
       goto __pyx_L3_continue;
 
-      /* "druhg/_druhg_tree.pyx":379
- *             dis_opp = knn_dist[j]
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:             # <<<<<<<<<<<<<<
- *                 continue
+      /* "druhg/_druhg_tree.pyx":317
+ *                 break
  * 
+ *             if self.U.is_same_parent(parent, j):             # <<<<<<<<<<<<<<
+ *                 rel.skip_first += ranki == rel.skip_first
+ *                 continue
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":382
+    /* "druhg/_druhg_tree.pyx":321
  *                 continue
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1             # <<<<<<<<<<<<<<
- *             if rank_left > rank_right:
- *                 continue
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION)  # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)             # <<<<<<<<<<<<<<
+ *             odis = distances[orank-1]
+ * 
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_bisect); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 382, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_bisect); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 321, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 382, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 382, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_j, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 321, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_10 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
-      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_1);
-      if (likely(__pyx_t_10)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
-        __Pyx_INCREF(__pyx_t_10);
+    __pyx_t_10 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __pyx_t_11 = NULL;
+    __pyx_t_12 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
+      __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_9);
+      if (likely(__pyx_t_11)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
+        __Pyx_INCREF(__pyx_t_11);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_1, function);
-        __pyx_t_11 = 1;
+        __Pyx_DECREF_SET(__pyx_t_9, function);
+        __pyx_t_12 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[3] = {__pyx_t_10, ((PyObject *)__pyx_v_distances), __pyx_t_2};
-      __pyx_t_9 = __Pyx_PyObject_FastCall(__pyx_t_1, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+      PyObject *__pyx_callargs[3] = {__pyx_t_11, __pyx_t_2, __pyx_t_10};
+      __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_12, 2+__pyx_t_12);
+      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 382, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 321, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
     }
-    __pyx_t_1 = __Pyx_PyInt_SubtractObjC(__pyx_t_9, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 382, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 382, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_v_rank_left = __pyx_t_6;
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __pyx_v_orank = __pyx_t_6;
 
-    /* "druhg/_druhg_tree.pyx":383
+    /* "druhg/_druhg_tree.pyx":322
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
- *             if rank_left > rank_right:             # <<<<<<<<<<<<<<
- *                 continue
+ *             orank = bisect.bisect(knn_dist[j], dis + self.PRECISION)  # !reminder! bisect.bisect(odis, dis) >= bisect.bisect_left(odis, dis)
+ *             odis = distances[orank-1]             # <<<<<<<<<<<<<<
  * 
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
  */
-    __pyx_t_8 = ((__pyx_v_rank_left > __pyx_v_rank_right) != 0);
-    if (__pyx_t_8) {
-
-      /* "druhg/_druhg_tree.pyx":384
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
- *             if rank_left > rank_right:
- *                 continue             # <<<<<<<<<<<<<<
- * 
- *             rank_dis = distances[rank_right]
- */
-      goto __pyx_L3_continue;
+    __pyx_t_6 = (__pyx_v_orank - 1);
+    __pyx_t_3 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_t_6, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_3); if (unlikely((__pyx_t_7 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __pyx_v_odis = __pyx_t_7;
 
-      /* "druhg/_druhg_tree.pyx":383
+    /* "druhg/_druhg_tree.pyx":324
+ *             odis = distances[orank-1]
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
- *             if rank_left > rank_right:             # <<<<<<<<<<<<<<
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)             # <<<<<<<<<<<<<<
+ *             if orank < rank:
  *                 continue
- * 
  */
-    }
-
-    /* "druhg/_druhg_tree.pyx":386
- *                 continue
- * 
- *             rank_dis = distances[rank_right]             # <<<<<<<<<<<<<<
- *             rank_left = len(set(indices[:rank_left+1]) - set(knn_indices[j][:rank_right+1])) + 1
- * 
- */
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_v_rank_right, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 386, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_7 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 386, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_v_rank_dis = __pyx_t_7;
-
-    /* "druhg/_druhg_tree.pyx":387
- * 
- *             rank_dis = distances[rank_right]
- *             rank_left = len(set(indices[:rank_left+1]) - set(knn_indices[j][:rank_right+1])) + 1             # <<<<<<<<<<<<<<
- * 
- *             order = 1. * rank_right/rank_left * rank_dis
- */
-    __pyx_t_1 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_indices), 0, (__pyx_v_rank_left + 1), NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 387, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_9 = PySet_New(__pyx_t_1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 387, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 324, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_indices), __pyx_v_j, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 387, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_2 = __Pyx_PyObject_GetSlice(__pyx_t_1, 0, (__pyx_v_rank_right + 1), NULL, NULL, NULL, 0, 1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 387, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = PySet_New(__pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 387, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = PyNumber_Subtract(__pyx_t_9, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 387, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_bisect); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 324, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
     __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_12 = PyObject_Length(__pyx_t_2); if (unlikely(__pyx_t_12 == ((Py_ssize_t)-1))) __PYX_ERR(0, 387, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_v_rank_left = (__pyx_t_12 + 1);
-
-    /* "druhg/_druhg_tree.pyx":389
- *             rank_left = len(set(indices[:rank_left+1]) - set(knn_indices[j][:rank_right+1])) + 1
- * 
- *             order = 1. * rank_right/rank_left * rank_dis             # <<<<<<<<<<<<<<
- * 
- *             # print(i, order < best, order, '=', rank_right, m, rank_dis, 'rl', rank_left, dis)
- */
-    __pyx_v_order = (((1. * __pyx_v_rank_right) / ((double)__pyx_v_rank_left)) * __pyx_v_rank_dis);
-
-    /* "druhg/_druhg_tree.pyx":396
- *             # print(distances[:rank_left+2], knn_dist[j][:rank_right+2])
- * 
- *             if order < best: # minimizing             # <<<<<<<<<<<<<<
- *                 res = 1
- *                 best = order
- */
-    __pyx_t_8 = ((__pyx_v_order < __pyx_v_best) != 0);
-    if (__pyx_t_8) {
-
-      /* "druhg/_druhg_tree.pyx":397
- * 
- *             if order < best: # minimizing
- *                 res = 1             # <<<<<<<<<<<<<<
- *                 best = order
- * 
- */
-      __pyx_v_res = 1;
-
-      /* "druhg/_druhg_tree.pyx":398
- *             if order < best: # minimizing
- *                 res = 1
- *                 best = order             # <<<<<<<<<<<<<<
- * 
- *                 rel.reciprocity = best
- */
-      __pyx_v_best = __pyx_v_order;
-
-      /* "druhg/_druhg_tree.pyx":400
- *                 best = order
- * 
- *                 rel.reciprocity = best             # <<<<<<<<<<<<<<
- *                 rel.target = j
- *                 # rel.my_dis = dis
- */
-      __pyx_v_rel->reciprocity = __pyx_v_best;
-
-      /* "druhg/_druhg_tree.pyx":401
- * 
- *                 rel.reciprocity = best
- *                 rel.target = j             # <<<<<<<<<<<<<<
- *                 # rel.my_dis = dis
- *                 rel.dia_dis = rank_dis
- */
-      __pyx_v_rel->target = __pyx_v_j;
-
-      /* "druhg/_druhg_tree.pyx":403
- *                 rel.target = j
- *                 # rel.my_dis = dis
- *                 rel.dia_dis = rank_dis             # <<<<<<<<<<<<<<
- *                 # rel.loop_rank = ranki
- *                 # rel.my_rank = rank_left
- */
-      __pyx_v_rel->dia_dis = __pyx_v_rank_dis;
-
-      /* "druhg/_druhg_tree.pyx":396
- *             # print(distances[:rank_left+2], knn_dist[j][:rank_right+2])
- * 
- *             if order < best: # minimizing             # <<<<<<<<<<<<<<
- *                 res = 1
- *                 best = order
- */
-    }
-    __pyx_L3_continue:;
-  }
-  __pyx_L4_break:;
-
-  /* "druhg/_druhg_tree.pyx":413
- *                 # rel.value = pow(rel.rec_dis, 2) * (rel.rec_rank) * pow(1.*rel.my_members/rel.rec_members, 0.5)
- * 
- *         return res             # <<<<<<<<<<<<<<
- * 
- *     cdef bint _evaluate_reciprocity_fast(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation *rel):
- */
-  __pyx_r = __pyx_v_res;
-  goto __pyx_L0;
-
-  /* "druhg/_druhg_tree.pyx":348
- *         return 0
- * 
- *     cdef bint _evaluate_reciprocity_slow(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation *rel):             # <<<<<<<<<<<<<<
- * 
- *         cdef:
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_9);
-  __Pyx_XDECREF(__pyx_t_10);
-  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
-    __Pyx_PyThreadState_declare
-    __Pyx_PyThreadState_assign
-    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
-    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
-    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
-  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
-  __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity._evaluate_reciprocity_slow", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
-  __pyx_r = 0;
-  goto __pyx_L2;
-  __pyx_L0:;
-  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
-  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
-  __pyx_L2:;
-  __Pyx_XDECREF((PyObject *)__pyx_v_indices);
-  __Pyx_XDECREF((PyObject *)__pyx_v_distances);
-  __Pyx_XDECREF((PyObject *)__pyx_v_dis_opp);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "druhg/_druhg_tree.pyx":415
- *         return res
- * 
- *     cdef bint _evaluate_reciprocity_fast(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation *rel):             # <<<<<<<<<<<<<<
- * 
- *         cdef:
- */
-
-static int __pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity_fast(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, __pyx_t_5numpy_intp_t __pyx_v_i, PyArrayObject *__pyx_v_knn_indices, PyArrayObject *__pyx_v_knn_dist, struct __pyx_t_5druhg_11_druhg_tree_Relation *__pyx_v_rel) {
-  __pyx_t_5numpy_intp_t __pyx_v_ranki;
-  __pyx_t_5numpy_intp_t __pyx_v_j;
-  __pyx_t_5numpy_intp_t __pyx_v_parent;
-  __pyx_t_5numpy_intp_t __pyx_v_rank_left;
-  __pyx_t_5numpy_intp_t __pyx_v_rank_right;
-  __pyx_t_5numpy_intp_t __pyx_v_res;
-  __pyx_t_5numpy_double_t __pyx_v_best;
-  __pyx_t_5numpy_double_t __pyx_v_order;
-  __pyx_t_5numpy_double_t __pyx_v_dis;
-  __pyx_t_5numpy_double_t __pyx_v_rank_dis;
-  PyArrayObject *__pyx_v_indices = 0;
-  PyArrayObject *__pyx_v_distances = 0;
-  PyArrayObject *__pyx_v_dis_opp = 0;
-  __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_dist;
-  __Pyx_Buffer __pyx_pybuffer_knn_dist;
-  __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_indices;
-  __Pyx_Buffer __pyx_pybuffer_knn_indices;
-  int __pyx_r;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
-  __pyx_t_5numpy_intp_t __pyx_t_3;
-  __pyx_t_5numpy_intp_t __pyx_t_4;
-  __pyx_t_5numpy_intp_t __pyx_t_5;
-  __pyx_t_5numpy_intp_t __pyx_t_6;
-  __pyx_t_5numpy_double_t __pyx_t_7;
-  int __pyx_t_8;
-  PyObject *__pyx_t_9 = NULL;
-  PyObject *__pyx_t_10 = NULL;
-  int __pyx_t_11;
-  int __pyx_lineno = 0;
-  const char *__pyx_filename = NULL;
-  int __pyx_clineno = 0;
-  __Pyx_RefNannySetupContext("_evaluate_reciprocity_fast", 0);
-  __pyx_pybuffer_knn_indices.pybuffer.buf = NULL;
-  __pyx_pybuffer_knn_indices.refcount = 0;
-  __pyx_pybuffernd_knn_indices.data = NULL;
-  __pyx_pybuffernd_knn_indices.rcbuffer = &__pyx_pybuffer_knn_indices;
-  __pyx_pybuffer_knn_dist.pybuffer.buf = NULL;
-  __pyx_pybuffer_knn_dist.refcount = 0;
-  __pyx_pybuffernd_knn_dist.data = NULL;
-  __pyx_pybuffernd_knn_dist.rcbuffer = &__pyx_pybuffer_knn_dist;
-  {
-    __Pyx_BufFmt_StackElem __pyx_stack[1];
-    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 415, __pyx_L1_error)
-  }
-  __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
-  {
-    __Pyx_BufFmt_StackElem __pyx_stack[1];
-    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 415, __pyx_L1_error)
-  }
-  __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
-
-  /* "druhg/_druhg_tree.pyx":418
- * 
- *         cdef:
- *             np.intp_t ranki, j, \             # <<<<<<<<<<<<<<
- *                 parent, \
- *                 rank_left, rank_right, \
- */
-  __pyx_v_res = 0;
-
-  /* "druhg/_druhg_tree.pyx":429
- *             np.ndarray distances, dis_opp
- * 
- *         parent = self.U.fast_find(i)             # <<<<<<<<<<<<<<
- *         indices, distances = knn_indices[i], knn_dist[i]
- * 
- */
-  __pyx_v_parent = ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_v_self->U, __pyx_v_i);
-
-  /* "druhg/_druhg_tree.pyx":430
- * 
- *         parent = self.U.fast_find(i)
- *         indices, distances = knn_indices[i], knn_dist[i]             # <<<<<<<<<<<<<<
- * 
- *         best = INF
- */
-  __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_indices), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 430, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 430, __pyx_L1_error)
-  __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 430, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 430, __pyx_L1_error)
-  __pyx_v_indices = ((PyArrayObject *)__pyx_t_1);
-  __pyx_t_1 = 0;
-  __pyx_v_distances = ((PyArrayObject *)__pyx_t_2);
-  __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_tree.pyx":432
- *         indices, distances = knn_indices[i], knn_dist[i]
- * 
- *         best = INF             # <<<<<<<<<<<<<<
- *         # print(self.max_neighbors_search, 'yo',distances)
- *         for ranki in range(0, self.max_neighbors_search + 1):
- */
-  __pyx_v_best = __pyx_v_5druhg_11_druhg_tree_INF;
-
-  /* "druhg/_druhg_tree.pyx":434
- *         best = INF
- *         # print(self.max_neighbors_search, 'yo',distances)
- *         for ranki in range(0, self.max_neighbors_search + 1):             # <<<<<<<<<<<<<<
- *             j = indices[ranki]
- *             dis = distances[ranki]
- */
-  __pyx_t_3 = (__pyx_v_self->max_neighbors_search + 1);
-  __pyx_t_4 = __pyx_t_3;
-  for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
-    __pyx_v_ranki = __pyx_t_5;
-
-    /* "druhg/_druhg_tree.pyx":435
- *         # print(self.max_neighbors_search, 'yo',distances)
- *         for ranki in range(0, self.max_neighbors_search + 1):
- *             j = indices[ranki]             # <<<<<<<<<<<<<<
- *             dis = distances[ranki]
- * 
- */
-    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_indices), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 435, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 435, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_v_j = __pyx_t_6;
-
-    /* "druhg/_druhg_tree.pyx":436
- *         for ranki in range(0, self.max_neighbors_search + 1):
- *             j = indices[ranki]
- *             dis = distances[ranki]             # <<<<<<<<<<<<<<
- * 
- *             if parent == self.U.fast_find(j):
- */
-    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_v_ranki, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 436, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_7 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 436, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_v_dis = __pyx_t_7;
-
-    /* "druhg/_druhg_tree.pyx":438
- *             dis = distances[ranki]
- * 
- *             if parent == self.U.fast_find(j):             # <<<<<<<<<<<<<<
- *                 continue
- * 
- */
-    __pyx_t_8 = ((__pyx_v_parent == ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_v_self->U, __pyx_v_j)) != 0);
-    if (__pyx_t_8) {
-
-      /* "druhg/_druhg_tree.pyx":439
- * 
- *             if parent == self.U.fast_find(j):
- *                 continue             # <<<<<<<<<<<<<<
- * 
- *             if dis >= best + self.PRECISION:
- */
-      goto __pyx_L3_continue;
-
-      /* "druhg/_druhg_tree.pyx":438
- *             dis = distances[ranki]
- * 
- *             if parent == self.U.fast_find(j):             # <<<<<<<<<<<<<<
- *                 continue
- * 
- */
-    }
-
-    /* "druhg/_druhg_tree.pyx":441
- *                 continue
- * 
- *             if dis >= best + self.PRECISION:             # <<<<<<<<<<<<<<
- *                 break
- * 
- */
-    __pyx_t_8 = ((__pyx_v_dis >= (__pyx_v_best + __pyx_v_self->PRECISION)) != 0);
-    if (__pyx_t_8) {
-
-      /* "druhg/_druhg_tree.pyx":442
- * 
- *             if dis >= best + self.PRECISION:
- *                 break             # <<<<<<<<<<<<<<
- * 
- *             dis_opp = knn_dist[j]
- */
-      goto __pyx_L4_break;
-
-      /* "druhg/_druhg_tree.pyx":441
- *                 continue
- * 
- *             if dis >= best + self.PRECISION:             # <<<<<<<<<<<<<<
- *                 break
- * 
- */
-    }
-
-    /* "druhg/_druhg_tree.pyx":444
- *                 break
- * 
- *             dis_opp = knn_dist[j]             # <<<<<<<<<<<<<<
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:
- */
-    __pyx_t_2 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_j, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 444, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 444, __pyx_L1_error)
-    __Pyx_XDECREF_SET(__pyx_v_dis_opp, ((PyArrayObject *)__pyx_t_2));
-    __pyx_t_2 = 0;
-
-    /* "druhg/_druhg_tree.pyx":445
- * 
- *             dis_opp = knn_dist[j]
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)             # <<<<<<<<<<<<<<
- *             if ranki > rank_right:
- *                 continue
- */
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 445, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_bisect); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 445, __pyx_L1_error)
+    __pyx_t_9 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 324, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 445, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_10 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
-      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_9);
-      if (likely(__pyx_t_10)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-        __Pyx_INCREF(__pyx_t_10);
+    __pyx_t_2 = NULL;
+    __pyx_t_12 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_10))) {
+      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_10);
+      if (likely(__pyx_t_2)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
+        __Pyx_INCREF(__pyx_t_2);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_9, function);
-        __pyx_t_11 = 1;
+        __Pyx_DECREF_SET(__pyx_t_10, function);
+        __pyx_t_12 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[3] = {__pyx_t_10, ((PyObject *)__pyx_v_dis_opp), __pyx_t_1};
-      __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 445, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
+      PyObject *__pyx_callargs[3] = {__pyx_t_2, ((PyObject *)__pyx_v_distances), __pyx_t_9};
+      __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_10, __pyx_callargs+1-__pyx_t_12, 2+__pyx_t_12);
+      __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 324, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
     }
-    __pyx_t_9 = __Pyx_PyInt_SubtractObjC(__pyx_t_2, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 445, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 445, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_v_rank_right = __pyx_t_6;
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 324, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __pyx_v_rank = __pyx_t_6;
 
-    /* "druhg/_druhg_tree.pyx":446
- *             dis_opp = knn_dist[j]
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_tree.pyx":325
+ * 
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
+ *             if orank < rank:             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
-    __pyx_t_8 = ((__pyx_v_ranki > __pyx_v_rank_right) != 0);
+    __pyx_t_8 = ((__pyx_v_orank < __pyx_v_rank) != 0);
     if (__pyx_t_8) {
 
-      /* "druhg/_druhg_tree.pyx":447
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:
+      /* "druhg/_druhg_tree.pyx":326
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
+ *             if orank < rank:
  *                 continue             # <<<<<<<<<<<<<<
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
+ *             v = min(odis, dis * orank / (1.*rank)) # evaluates from POV of the i and the opp
  */
       goto __pyx_L3_continue;
 
-      /* "druhg/_druhg_tree.pyx":446
- *             dis_opp = knn_dist[j]
- *             rank_right = bisect.bisect(dis_opp, dis + self.PRECISION) - 1 # !reminder! bisect.bisect(dis_opp, dis) >= bisect.bisect_left(dis_opp, dis)
- *             if ranki > rank_right:             # <<<<<<<<<<<<<<
+      /* "druhg/_druhg_tree.pyx":325
+ * 
+ *             rank = bisect.bisect(distances, dis + self.PRECISION)
+ *             if orank < rank:             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":449
+    /* "druhg/_druhg_tree.pyx":328
  *                 continue
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1             # <<<<<<<<<<<<<<
- *             if rank_left > rank_right:
+ *             v = min(odis, dis * orank / (1.*rank)) # evaluates from POV of the i and the opp             # <<<<<<<<<<<<<<
+ *             if v >= best:
  *                 continue
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_bisect); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 449, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_bisect); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 449, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = PyFloat_FromDouble((__pyx_v_dis + __pyx_v_self->PRECISION)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 449, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_10 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
-      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_1);
-      if (likely(__pyx_t_10)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
-        __Pyx_INCREF(__pyx_t_10);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_1, function);
-        __pyx_t_11 = 1;
-      }
-    }
-    {
-      PyObject *__pyx_callargs[3] = {__pyx_t_10, ((PyObject *)__pyx_v_distances), __pyx_t_2};
-      __pyx_t_9 = __Pyx_PyObject_FastCall(__pyx_t_1, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 449, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_7 = ((__pyx_v_dis * __pyx_v_orank) / ((__pyx_t_5numpy_double_t)(1. * __pyx_v_rank)));
+    __pyx_t_13 = __pyx_v_odis;
+    if (((__pyx_t_7 < __pyx_t_13) != 0)) {
+      __pyx_t_14 = __pyx_t_7;
+    } else {
+      __pyx_t_14 = __pyx_t_13;
     }
-    __pyx_t_1 = __Pyx_PyInt_SubtractObjC(__pyx_t_9, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 449, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_1); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 449, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_v_rank_left = __pyx_t_6;
+    __pyx_v_v = __pyx_t_14;
 
-    /* "druhg/_druhg_tree.pyx":450
+    /* "druhg/_druhg_tree.pyx":329
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
- *             if rank_left > rank_right:             # <<<<<<<<<<<<<<
+ *             v = min(odis, dis * orank / (1.*rank)) # evaluates from POV of the i and the opp
+ *             if v >= best:             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
-    __pyx_t_8 = ((__pyx_v_rank_left > __pyx_v_rank_right) != 0);
+    __pyx_t_8 = ((__pyx_v_v >= __pyx_v_best) != 0);
     if (__pyx_t_8) {
 
-      /* "druhg/_druhg_tree.pyx":451
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
- *             if rank_left > rank_right:
+      /* "druhg/_druhg_tree.pyx":330
+ *             v = min(odis, dis * orank / (1.*rank)) # evaluates from POV of the i and the opp
+ *             if v >= best:
  *                 continue             # <<<<<<<<<<<<<<
  * 
- *             rank_dis = distances[rank_right]
+ *             best = v
  */
       goto __pyx_L3_continue;
 
-      /* "druhg/_druhg_tree.pyx":450
+      /* "druhg/_druhg_tree.pyx":329
  * 
- *             rank_left = bisect.bisect(distances, dis + self.PRECISION) - 1
- *             if rank_left > rank_right:             # <<<<<<<<<<<<<<
+ *             v = min(odis, dis * orank / (1.*rank)) # evaluates from POV of the i and the opp
+ *             if v >= best:             # <<<<<<<<<<<<<<
  *                 continue
  * 
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":453
+    /* "druhg/_druhg_tree.pyx":332
  *                 continue
  * 
- *             rank_dis = distances[rank_right]             # <<<<<<<<<<<<<<
- *             # rank_left = 1.*len(set(indices[:rank_left+1]) - set(knn_indices[j][:rank_right+1])) + 1 # slow/proper
- *             order = 1. * rank_right/rank_left * rank_dis
- */
-    __pyx_t_1 = __Pyx_GetItemInt(((PyObject *)__pyx_v_distances), __pyx_v_rank_right, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 453, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_7 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 453, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_v_rank_dis = __pyx_t_7;
-
-    /* "druhg/_druhg_tree.pyx":455
- *             rank_dis = distances[rank_right]
- *             # rank_left = 1.*len(set(indices[:rank_left+1]) - set(knn_indices[j][:rank_right+1])) + 1 # slow/proper
- *             order = 1. * rank_right/rank_left * rank_dis             # <<<<<<<<<<<<<<
- * 
- *             # print(i, order < best, order, '=', rank_right, m, rank_dis, 'rl', rank_left, dis)
- */
-    __pyx_v_order = (((1. * __pyx_v_rank_right) / ((double)__pyx_v_rank_left)) * __pyx_v_rank_dis);
-
-    /* "druhg/_druhg_tree.pyx":462
- *             # print(distances[:rank_left+2], knn_dist[j][:rank_right+2])
- * 
- *             if order < best: # minimizing             # <<<<<<<<<<<<<<
- *                 res = 1
- *                 best = order
+ *             best = v             # <<<<<<<<<<<<<<
+ *             rel.reciprocity = best
+ *             rel.endpoint = j
  */
-    __pyx_t_8 = ((__pyx_v_order < __pyx_v_best) != 0);
-    if (__pyx_t_8) {
+    __pyx_v_best = __pyx_v_v;
 
-      /* "druhg/_druhg_tree.pyx":463
- * 
- *             if order < best: # minimizing
- *                 res = 1             # <<<<<<<<<<<<<<
- *                 best = order
+    /* "druhg/_druhg_tree.pyx":333
  * 
+ *             best = v
+ *             rel.reciprocity = best             # <<<<<<<<<<<<<<
+ *             rel.endpoint = j
+ *             rel.max_rank = orank
  */
-      __pyx_v_res = 1;
+    __pyx_v_rel->reciprocity = __pyx_v_best;
 
-      /* "druhg/_druhg_tree.pyx":464
- *             if order < best: # minimizing
- *                 res = 1
- *                 best = order             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_tree.pyx":334
+ *             best = v
+ *             rel.reciprocity = best
+ *             rel.endpoint = j             # <<<<<<<<<<<<<<
+ *             rel.max_rank = orank
  * 
- *                 rel.reciprocity = best
  */
-      __pyx_v_best = __pyx_v_order;
+    __pyx_v_rel->endpoint = __pyx_v_j;
 
-      /* "druhg/_druhg_tree.pyx":466
- *                 best = order
+    /* "druhg/_druhg_tree.pyx":335
+ *             rel.reciprocity = best
+ *             rel.endpoint = j
+ *             rel.max_rank = orank             # <<<<<<<<<<<<<<
  * 
- *                 rel.reciprocity = best             # <<<<<<<<<<<<<<
- *                 rel.target = j
- *                 # rel.my_dis = dis
+ *             res = 1
  */
-      __pyx_v_rel->reciprocity = __pyx_v_best;
+    __pyx_v_rel->max_rank = __pyx_v_orank;
 
-      /* "druhg/_druhg_tree.pyx":467
+    /* "druhg/_druhg_tree.pyx":337
+ *             rel.max_rank = orank
  * 
- *                 rel.reciprocity = best
- *                 rel.target = j             # <<<<<<<<<<<<<<
- *                 # rel.my_dis = dis
- *                 rel.dia_dis = rank_dis
- */
-      __pyx_v_rel->target = __pyx_v_j;
-
-      /* "druhg/_druhg_tree.pyx":469
- *                 rel.target = j
- *                 # rel.my_dis = dis
- *                 rel.dia_dis = rank_dis             # <<<<<<<<<<<<<<
- *                 # rel.loop_rank = ranki
- *                 # rel.my_rank = rank_left
- */
-      __pyx_v_rel->dia_dis = __pyx_v_rank_dis;
-
-      /* "druhg/_druhg_tree.pyx":462
- *             # print(distances[:rank_left+2], knn_dist[j][:rank_right+2])
+ *             res = 1             # <<<<<<<<<<<<<<
  * 
- *             if order < best: # minimizing             # <<<<<<<<<<<<<<
- *                 res = 1
- *                 best = order
+ *         return res
  */
-    }
+    __pyx_v_res = 1;
     __pyx_L3_continue:;
   }
   __pyx_L4_break:;
 
-  /* "druhg/_druhg_tree.pyx":479
- *                 # rel.value = pow(rel.rec_dis, 2) * (rel.rec_rank) * pow(1.*rel.my_members/rel.rec_members, 0.5)
+  /* "druhg/_druhg_tree.pyx":339
+ *             res = 1
  * 
  *         return res             # <<<<<<<<<<<<<<
  * 
- * 
+ *     cdef _compute_tree_edges(self):
  */
   __pyx_r = __pyx_v_res;
   goto __pyx_L0;
 
-  /* "druhg/_druhg_tree.pyx":415
- *         return res
- * 
- *     cdef bint _evaluate_reciprocity_fast(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation *rel):             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_tree.pyx":290
+ *         return 0
  * 
+ *     cdef bint _evaluate_reciprocity(self, np.intp_t i, np.ndarray[np.intp_t, ndim=2] knn_indices, np.ndarray[np.double_t, ndim=2] knn_dist, Relation* rel):             # <<<<<<<<<<<<<<
  *         cdef:
+ *             np.intp_t j, ranki, skip_first, \
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_9);
   __Pyx_XDECREF(__pyx_t_10);
+  __Pyx_XDECREF(__pyx_t_11);
   { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
     __Pyx_PyThreadState_declare
     __Pyx_PyThreadState_assign
     __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
   __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
-  __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity._evaluate_reciprocity_fast", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
+  __Pyx_WriteUnraisable("druhg._druhg_tree.UniversalReciprocity._evaluate_reciprocity", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __pyx_r = 0;
   goto __pyx_L2;
   __pyx_L0:;
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
   __pyx_L2:;
   __Pyx_XDECREF((PyObject *)__pyx_v_indices);
   __Pyx_XDECREF((PyObject *)__pyx_v_distances);
-  __Pyx_XDECREF((PyObject *)__pyx_v_dis_opp);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 static PyObject *__pyx_gb_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_2generator(__pyx_CoroutineObject *__pyx_generator, CYTHON_UNUSED PyThreadState *__pyx_tstate, PyObject *__pyx_sent_value); /* proto */
 
-/* "druhg/_druhg_tree.pyx":509
+/* "druhg/_druhg_tree.pyx":368
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)
  *                 (points,             # <<<<<<<<<<<<<<
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  */
 
@@ -9944,23 +9707,23 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("genexpr", 0);
   __pyx_cur_scope = (struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr *)__pyx_tp_new_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr(__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr, __pyx_empty_tuple, NULL);
   if (unlikely(!__pyx_cur_scope)) {
     __pyx_cur_scope = ((struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr *)Py_None);
     __Pyx_INCREF(Py_None);
-    __PYX_ERR(0, 509, __pyx_L1_error)
+    __PYX_ERR(0, 368, __pyx_L1_error)
   } else {
     __Pyx_GOTREF((PyObject *)__pyx_cur_scope);
   }
   __pyx_cur_scope->__pyx_outer_scope = (struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges *) __pyx_self;
   __Pyx_INCREF((PyObject *)__pyx_cur_scope->__pyx_outer_scope);
   __Pyx_GIVEREF((PyObject *)__pyx_cur_scope->__pyx_outer_scope);
   {
-    __pyx_CoroutineObject *gen = __Pyx_Generator_New((__pyx_coroutine_body_t) __pyx_gb_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_2generator, NULL, (PyObject *) __pyx_cur_scope, __pyx_n_s_genexpr, __pyx_n_s_UniversalReciprocity__compute_tr, __pyx_n_s_druhg__druhg_tree); if (unlikely(!gen)) __PYX_ERR(0, 509, __pyx_L1_error)
+    __pyx_CoroutineObject *gen = __Pyx_Generator_New((__pyx_coroutine_body_t) __pyx_gb_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_2generator, NULL, (PyObject *) __pyx_cur_scope, __pyx_n_s_genexpr, __pyx_n_s_UniversalReciprocity__compute_tr, __pyx_n_s_druhg__druhg_tree); if (unlikely(!gen)) __PYX_ERR(0, 368, __pyx_L1_error)
     __Pyx_DECREF(__pyx_cur_scope);
     __Pyx_RefNannyFinishContext();
     return (PyObject *) gen;
   }
 
   /* function exit code */
   __pyx_L1_error:;
@@ -9992,53 +9755,53 @@
     case 0: goto __pyx_L3_first_run;
     case 1: goto __pyx_L6_resume_from_yield;
     default: /* CPython raises the right error here */
     __Pyx_RefNannyFinishContext();
     return NULL;
   }
   __pyx_L3_first_run:;
-  if (unlikely(!__pyx_sent_value)) __PYX_ERR(0, 509, __pyx_L1_error)
+  if (unlikely(!__pyx_sent_value)) __PYX_ERR(0, 368, __pyx_L1_error)
 
-  /* "druhg/_druhg_tree.pyx":514
+  /* "druhg/_druhg_tree.pyx":373
  *                  breadth_first=True
  *                  )
  *                 for points in datasets)             # <<<<<<<<<<<<<<
  *             knn_dist = np.vstack([x[0] for x in knn_data])
  *             knn_indices = np.vstack([x[1] for x in knn_data])
  */
-  if (unlikely(!__pyx_cur_scope->__pyx_outer_scope->__pyx_v_datasets)) { __Pyx_RaiseClosureNameError("datasets"); __PYX_ERR(0, 514, __pyx_L1_error) }
+  if (unlikely(!__pyx_cur_scope->__pyx_outer_scope->__pyx_v_datasets)) { __Pyx_RaiseClosureNameError("datasets"); __PYX_ERR(0, 373, __pyx_L1_error) }
   if (unlikely(__pyx_cur_scope->__pyx_outer_scope->__pyx_v_datasets == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
-    __PYX_ERR(0, 514, __pyx_L1_error)
+    __PYX_ERR(0, 373, __pyx_L1_error)
   }
   __pyx_t_1 = __pyx_cur_scope->__pyx_outer_scope->__pyx_v_datasets; __Pyx_INCREF(__pyx_t_1); __pyx_t_2 = 0;
   for (;;) {
     if (__pyx_t_2 >= PyList_GET_SIZE(__pyx_t_1)) break;
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    __pyx_t_3 = PyList_GET_ITEM(__pyx_t_1, __pyx_t_2); __Pyx_INCREF(__pyx_t_3); __pyx_t_2++; if (unlikely((0 < 0))) __PYX_ERR(0, 514, __pyx_L1_error)
+    __pyx_t_3 = PyList_GET_ITEM(__pyx_t_1, __pyx_t_2); __Pyx_INCREF(__pyx_t_3); __pyx_t_2++; if (unlikely((0 < 0))) __PYX_ERR(0, 373, __pyx_L1_error)
     #else
-    __pyx_t_3 = PySequence_ITEM(__pyx_t_1, __pyx_t_2); __pyx_t_2++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 514, __pyx_L1_error)
+    __pyx_t_3 = PySequence_ITEM(__pyx_t_1, __pyx_t_2); __pyx_t_2++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 373, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     #endif
     __Pyx_XGOTREF(__pyx_cur_scope->__pyx_v_points);
     __Pyx_XDECREF_SET(__pyx_cur_scope->__pyx_v_points, __pyx_t_3);
     __Pyx_GIVEREF(__pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "druhg/_druhg_tree.pyx":508
+    /* "druhg/_druhg_tree.pyx":367
  * 
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)             # <<<<<<<<<<<<<<
  *                 (points,
  *                  self.max_neighbors_search + 1,
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_delayed); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 508, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_delayed); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 367, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    if (unlikely(!__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self)) { __Pyx_RaiseClosureNameError("self"); __PYX_ERR(0, 508, __pyx_L1_error) }
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self->tree, __pyx_n_s_query); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 508, __pyx_L1_error)
+    if (unlikely(!__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self)) { __Pyx_RaiseClosureNameError("self"); __PYX_ERR(0, 367, __pyx_L1_error) }
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self->tree, __pyx_n_s_query); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 367, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __pyx_t_6 = NULL;
     __pyx_t_7 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_6)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
@@ -10049,74 +9812,74 @@
       }
     }
     {
       PyObject *__pyx_callargs[2] = {__pyx_t_6, __pyx_t_5};
       __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_4, __pyx_callargs+1-__pyx_t_7, 1+__pyx_t_7);
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 508, __pyx_L1_error)
+      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 367, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     }
 
-    /* "druhg/_druhg_tree.pyx":510
+    /* "druhg/_druhg_tree.pyx":369
  *                 delayed(self.tree.query)
  *                 (points,
  *                  self.max_neighbors_search + 1,             # <<<<<<<<<<<<<<
  *                  dualtree=True,
  *                  breadth_first=True
  */
-    if (unlikely(!__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self)) { __Pyx_RaiseClosureNameError("self"); __PYX_ERR(0, 510, __pyx_L1_error) }
-    __pyx_t_4 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self->max_neighbors_search + 1)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 510, __pyx_L1_error)
+    if (unlikely(!__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self)) { __Pyx_RaiseClosureNameError("self"); __PYX_ERR(0, 369, __pyx_L1_error) }
+    __pyx_t_4 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_outer_scope->__pyx_v_self->max_neighbors_search + 1)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 369, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
 
-    /* "druhg/_druhg_tree.pyx":509
+    /* "druhg/_druhg_tree.pyx":368
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)
  *                 (points,             # <<<<<<<<<<<<<<
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  */
-    __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 509, __pyx_L1_error)
+    __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 368, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_INCREF(__pyx_cur_scope->__pyx_v_points);
     __Pyx_GIVEREF(__pyx_cur_scope->__pyx_v_points);
     PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_cur_scope->__pyx_v_points);
     __Pyx_GIVEREF(__pyx_t_4);
     PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_4);
     __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_tree.pyx":511
+    /* "druhg/_druhg_tree.pyx":370
  *                 (points,
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,             # <<<<<<<<<<<<<<
  *                  breadth_first=True
  *                  )
  */
-    __pyx_t_4 = __Pyx_PyDict_NewPresized(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 511, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyDict_NewPresized(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 370, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dualtree, Py_True) < 0) __PYX_ERR(0, 511, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dualtree, Py_True) < 0) __PYX_ERR(0, 370, __pyx_L1_error)
 
-    /* "druhg/_druhg_tree.pyx":512
+    /* "druhg/_druhg_tree.pyx":371
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  *                  breadth_first=True             # <<<<<<<<<<<<<<
  *                  )
  *                 for points in datasets)
  */
-    if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_breadth_first, Py_True) < 0) __PYX_ERR(0, 511, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_breadth_first, Py_True) < 0) __PYX_ERR(0, 370, __pyx_L1_error)
 
-    /* "druhg/_druhg_tree.pyx":509
+    /* "druhg/_druhg_tree.pyx":368
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)
  *                 (points,             # <<<<<<<<<<<<<<
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  */
-    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 509, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 368, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __pyx_r = __pyx_t_6;
     __pyx_t_6 = 0;
     __Pyx_XGIVEREF(__pyx_t_1);
@@ -10129,28 +9892,28 @@
     __pyx_generator->resume_label = 1;
     return __pyx_r;
     __pyx_L6_resume_from_yield:;
     __pyx_t_1 = __pyx_cur_scope->__pyx_t_0;
     __pyx_cur_scope->__pyx_t_0 = 0;
     __Pyx_XGOTREF(__pyx_t_1);
     __pyx_t_2 = __pyx_cur_scope->__pyx_t_1;
-    if (unlikely(!__pyx_sent_value)) __PYX_ERR(0, 509, __pyx_L1_error)
+    if (unlikely(!__pyx_sent_value)) __PYX_ERR(0, 368, __pyx_L1_error)
 
-    /* "druhg/_druhg_tree.pyx":514
+    /* "druhg/_druhg_tree.pyx":373
  *                  breadth_first=True
  *                  )
  *                 for points in datasets)             # <<<<<<<<<<<<<<
  *             knn_dist = np.vstack([x[0] for x in knn_data])
  *             knn_indices = np.vstack([x[1] for x in knn_data])
  */
   }
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   CYTHON_MAYBE_UNUSED_VAR(__pyx_cur_scope);
 
-  /* "druhg/_druhg_tree.pyx":509
+  /* "druhg/_druhg_tree.pyx":368
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)
  *                 (points,             # <<<<<<<<<<<<<<
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  */
 
@@ -10172,78 +9935,80 @@
   #endif
   __pyx_generator->resume_label = -1;
   __Pyx_Coroutine_clear((PyObject*)__pyx_generator);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "druhg/_druhg_tree.pyx":482
- * 
+/* "druhg/_druhg_tree.pyx":341
+ *         return res
  * 
- *     cdef _compute_tree_edges(self, is_slow):             # <<<<<<<<<<<<<<
+ *     cdef _compute_tree_edges(self):             # <<<<<<<<<<<<<<
  *         # DRUHG
  *         # computes DRUHG Spanning Tree
  */
 
-static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__compute_tree_edges(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_is_slow) {
+static PyObject *__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__compute_tree_edges(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
   struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges *__pyx_cur_scope;
   __pyx_t_5numpy_intp_t __pyx_v_i;
-  __pyx_t_5numpy_intp_t __pyx_v_j;
   __pyx_t_5numpy_intp_t __pyx_v_warn;
   __pyx_t_5numpy_intp_t __pyx_v_infinitesimal;
-  __pyx_t_5numpy_double_t __pyx_v_v;
-  PyObject *__pyx_v_heap = 0;
   struct __pyx_t_5druhg_11_druhg_tree_Relation __pyx_v_rel;
   PyArrayObject *__pyx_v_knn_dist = 0;
   PyArrayObject *__pyx_v_knn_indices = 0;
+  PyObject *__pyx_v_heap = 0;
   PyObject *__pyx_v_split_cnt = NULL;
   PyObject *__pyx_v_knn_data = NULL;
-  PyObject *__pyx_v_best = NULL;
+  __pyx_t_5numpy_intp_t __pyx_v_p;
+  __pyx_t_5numpy_intp_t __pyx_v_op;
+  PyObject *__pyx_v_edge_cases = NULL;
   PyObject *__pyx_gb_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_2generator = 0;
   PyObject *__pyx_8genexpr1__pyx_v_x = NULL;
   PyObject *__pyx_8genexpr2__pyx_v_x = NULL;
   __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_dist;
   __Pyx_Buffer __pyx_pybuffer_knn_dist;
   __Pyx_LocalBuf_ND __pyx_pybuffernd_knn_indices;
   __Pyx_Buffer __pyx_pybuffer_knn_indices;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
+  struct __pyx_t_5druhg_11_druhg_tree_Relation __pyx_t_1;
+  int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
-  int __pyx_t_4;
-  __pyx_t_5numpy_intp_t __pyx_t_5;
+  PyObject *__pyx_t_4 = NULL;
+  int __pyx_t_5;
   __pyx_t_5numpy_intp_t __pyx_t_6;
   __pyx_t_5numpy_intp_t __pyx_t_7;
-  PyObject *__pyx_t_8 = NULL;
+  __pyx_t_5numpy_intp_t __pyx_t_8;
   PyObject *__pyx_t_9 = NULL;
   PyObject *__pyx_t_10 = NULL;
-  int __pyx_t_11;
+  PyObject *__pyx_t_11 = NULL;
   int __pyx_t_12;
-  PyObject *__pyx_t_13 = NULL;
-  Py_ssize_t __pyx_t_14;
-  PyObject *(*__pyx_t_15)(PyObject *);
-  PyArrayObject *__pyx_t_16 = NULL;
-  PyObject *__pyx_t_17 = NULL;
+  int __pyx_t_13;
+  PyObject *__pyx_t_14 = NULL;
+  Py_ssize_t __pyx_t_15;
+  PyObject *(*__pyx_t_16)(PyObject *);
+  PyArrayObject *__pyx_t_17 = NULL;
   PyObject *__pyx_t_18 = NULL;
   PyObject *__pyx_t_19 = NULL;
-  PyArrayObject *__pyx_t_20 = NULL;
-  PyObject *(*__pyx_t_21)(PyObject *);
-  int __pyx_t_22;
+  PyObject *__pyx_t_20 = NULL;
+  PyArrayObject *__pyx_t_21 = NULL;
+  PyObject *(*__pyx_t_22)(PyObject *);
   PyObject *__pyx_t_23 = NULL;
-  __pyx_t_5numpy_double_t __pyx_t_24;
+  PyObject *__pyx_t_24 = NULL;
+  __pyx_t_5numpy_double_t __pyx_t_25;
+  __pyx_t_5numpy_intp_t __pyx_t_26;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("_compute_tree_edges", 0);
   __pyx_cur_scope = (struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges *)__pyx_tp_new_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges(__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges, __pyx_empty_tuple, NULL);
   if (unlikely(!__pyx_cur_scope)) {
     __pyx_cur_scope = ((struct __pyx_obj_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges *)Py_None);
     __Pyx_INCREF(Py_None);
-    __PYX_ERR(0, 482, __pyx_L1_error)
+    __PYX_ERR(0, 341, __pyx_L1_error)
   } else {
     __Pyx_GOTREF((PyObject *)__pyx_cur_scope);
   }
   __pyx_cur_scope->__pyx_v_self = __pyx_v_self;
   __Pyx_INCREF((PyObject *)__pyx_cur_scope->__pyx_v_self);
   __Pyx_GIVEREF((PyObject *)__pyx_cur_scope->__pyx_v_self);
   __pyx_pybuffer_knn_dist.pybuffer.buf = NULL;
@@ -10251,1857 +10016,1920 @@
   __pyx_pybuffernd_knn_dist.data = NULL;
   __pyx_pybuffernd_knn_dist.rcbuffer = &__pyx_pybuffer_knn_dist;
   __pyx_pybuffer_knn_indices.pybuffer.buf = NULL;
   __pyx_pybuffer_knn_indices.refcount = 0;
   __pyx_pybuffernd_knn_indices.data = NULL;
   __pyx_pybuffernd_knn_indices.rcbuffer = &__pyx_pybuffer_knn_indices;
 
-  /* "druhg/_druhg_tree.pyx":498
- *             np.ndarray[np.intp_t, ndim=2] knn_indices
+  /* "druhg/_druhg_tree.pyx":349
+ *                 warn, infinitesimal
+ * 
+ *             Relation rel = Relation(0,0,0,0)             # <<<<<<<<<<<<<<
+ * 
+ *             np.ndarray[np.double_t, ndim=2] knn_dist
+ */
+  __pyx_t_1.reciprocity = 0.0;
+  __pyx_t_1.endpoint = 0;
+  __pyx_t_1.max_rank = 0;
+  __pyx_t_1.skip_first = 0;
+  __pyx_v_rel = __pyx_t_1;
+
+  /* "druhg/_druhg_tree.pyx":356
+ *             list heap
  * 
  *         if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets             # <<<<<<<<<<<<<<
+ *         # if self.n_jobs > 1:
  *             split_cnt = self.num_points // self.n_jobs
- *             datasets = []
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 498, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 498, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 356, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 498, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_shape); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 356, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = PyObject_RichCompare(__pyx_t_2, __pyx_int_16384, Py_GT); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 498, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 498, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_GetItemInt(__pyx_t_4, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 356, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_4 = PyObject_RichCompare(__pyx_t_3, __pyx_int_16384, Py_GT); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 356, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (__pyx_t_4) {
+  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 356, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (__pyx_t_5) {
   } else {
-    __pyx_t_1 = __pyx_t_4;
+    __pyx_t_2 = __pyx_t_5;
     goto __pyx_L4_bool_binop_done;
   }
-  __pyx_t_4 = ((__pyx_cur_scope->__pyx_v_self->n_jobs > 1) != 0);
-  __pyx_t_1 = __pyx_t_4;
+  __pyx_t_5 = ((__pyx_cur_scope->__pyx_v_self->n_jobs > 1) != 0);
+  __pyx_t_2 = __pyx_t_5;
   __pyx_L4_bool_binop_done:;
-  if (__pyx_t_1) {
+  if (__pyx_t_2) {
 
-    /* "druhg/_druhg_tree.pyx":499
- * 
+    /* "druhg/_druhg_tree.pyx":358
  *         if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets
+ *         # if self.n_jobs > 1:
  *             split_cnt = self.num_points // self.n_jobs             # <<<<<<<<<<<<<<
  *             datasets = []
  *             for i in range(self.n_jobs):
  */
-    __pyx_t_3 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_v_self->num_points / __pyx_cur_scope->__pyx_v_self->n_jobs)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 499, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_v_split_cnt = __pyx_t_3;
-    __pyx_t_3 = 0;
+    __pyx_t_4 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_v_self->num_points / __pyx_cur_scope->__pyx_v_self->n_jobs)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 358, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_v_split_cnt = __pyx_t_4;
+    __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_tree.pyx":500
- *         if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets
+    /* "druhg/_druhg_tree.pyx":359
+ *         # if self.n_jobs > 1:
  *             split_cnt = self.num_points // self.n_jobs
  *             datasets = []             # <<<<<<<<<<<<<<
  *             for i in range(self.n_jobs):
  *                 if i == self.n_jobs - 1:
  */
-    __pyx_t_3 = PyList_New(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 500, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_GIVEREF(__pyx_t_3);
-    __pyx_cur_scope->__pyx_v_datasets = ((PyObject*)__pyx_t_3);
-    __pyx_t_3 = 0;
+    __pyx_t_4 = PyList_New(0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 359, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_GIVEREF(__pyx_t_4);
+    __pyx_cur_scope->__pyx_v_datasets = ((PyObject*)__pyx_t_4);
+    __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_tree.pyx":501
+    /* "druhg/_druhg_tree.pyx":360
  *             split_cnt = self.num_points // self.n_jobs
  *             datasets = []
  *             for i in range(self.n_jobs):             # <<<<<<<<<<<<<<
  *                 if i == self.n_jobs - 1:
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:]))
  */
-    __pyx_t_5 = __pyx_cur_scope->__pyx_v_self->n_jobs;
-    __pyx_t_6 = __pyx_t_5;
-    for (__pyx_t_7 = 0; __pyx_t_7 < __pyx_t_6; __pyx_t_7+=1) {
-      __pyx_v_i = __pyx_t_7;
+    __pyx_t_6 = __pyx_cur_scope->__pyx_v_self->n_jobs;
+    __pyx_t_7 = __pyx_t_6;
+    for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
+      __pyx_v_i = __pyx_t_8;
 
-      /* "druhg/_druhg_tree.pyx":502
+      /* "druhg/_druhg_tree.pyx":361
  *             datasets = []
  *             for i in range(self.n_jobs):
  *                 if i == self.n_jobs - 1:             # <<<<<<<<<<<<<<
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:]))
  *                 else:
  */
-      __pyx_t_1 = ((__pyx_v_i == (__pyx_cur_scope->__pyx_v_self->n_jobs - 1)) != 0);
-      if (__pyx_t_1) {
+      __pyx_t_2 = ((__pyx_v_i == (__pyx_cur_scope->__pyx_v_self->n_jobs - 1)) != 0);
+      if (__pyx_t_2) {
 
-        /* "druhg/_druhg_tree.pyx":503
+        /* "druhg/_druhg_tree.pyx":362
  *             for i in range(self.n_jobs):
  *                 if i == self.n_jobs - 1:
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:]))             # <<<<<<<<<<<<<<
  *                 else:
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:(i+1)*split_cnt]))
  */
-        __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 503, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_asarray); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 503, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 503, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 503, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 362, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_3);
+        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_asarray); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 362, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_10 = PyNumber_Multiply(__pyx_t_9, __pyx_v_split_cnt); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 503, __pyx_L1_error)
+        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 362, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_3);
+        __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 362, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_t_9 = __Pyx_PyObject_GetSlice(__pyx_t_2, 0, 0, &__pyx_t_10, NULL, NULL, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 503, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+        __pyx_t_11 = PyNumber_Multiply(__pyx_t_10, __pyx_v_split_cnt); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 362, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_11);
         __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-        __pyx_t_10 = NULL;
-        __pyx_t_11 = 0;
-        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_8))) {
-          __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_8);
-          if (likely(__pyx_t_10)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
-            __Pyx_INCREF(__pyx_t_10);
+        __pyx_t_10 = __Pyx_PyObject_GetSlice(__pyx_t_3, 0, 0, &__pyx_t_11, NULL, NULL, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 362, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_10);
+        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+        __pyx_t_11 = NULL;
+        __pyx_t_12 = 0;
+        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
+          __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_9);
+          if (likely(__pyx_t_11)) {
+            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
+            __Pyx_INCREF(__pyx_t_11);
             __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_8, function);
-            __pyx_t_11 = 1;
+            __Pyx_DECREF_SET(__pyx_t_9, function);
+            __pyx_t_12 = 1;
           }
         }
         {
-          PyObject *__pyx_callargs[2] = {__pyx_t_10, __pyx_t_9};
-          __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_8, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-          __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+          PyObject *__pyx_callargs[2] = {__pyx_t_11, __pyx_t_10};
+          __pyx_t_4 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_12, 1+__pyx_t_12);
+          __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
+          __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+          if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 362, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_4);
           __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-          if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 503, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
         }
-        __pyx_t_12 = __Pyx_PyList_Append(__pyx_cur_scope->__pyx_v_datasets, __pyx_t_3); if (unlikely(__pyx_t_12 == ((int)-1))) __PYX_ERR(0, 503, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+        __pyx_t_13 = __Pyx_PyList_Append(__pyx_cur_scope->__pyx_v_datasets, __pyx_t_4); if (unlikely(__pyx_t_13 == ((int)-1))) __PYX_ERR(0, 362, __pyx_L1_error)
+        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-        /* "druhg/_druhg_tree.pyx":502
+        /* "druhg/_druhg_tree.pyx":361
  *             datasets = []
  *             for i in range(self.n_jobs):
  *                 if i == self.n_jobs - 1:             # <<<<<<<<<<<<<<
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:]))
  *                 else:
  */
         goto __pyx_L8;
       }
 
-      /* "druhg/_druhg_tree.pyx":505
+      /* "druhg/_druhg_tree.pyx":364
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:]))
  *                 else:
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:(i+1)*split_cnt]))             # <<<<<<<<<<<<<<
  * 
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  */
       /*else*/ {
-        __Pyx_GetModuleGlobalName(__pyx_t_8, __pyx_n_s_np); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_asarray); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 505, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_np); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 364, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 505, __pyx_L1_error)
+        __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_asarray); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 364, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_10);
-        __pyx_t_2 = PyNumber_Multiply(__pyx_t_10, __pyx_v_split_cnt); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-        __pyx_t_10 = PyInt_FromSsize_t((__pyx_v_i + 1)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __pyx_t_13 = PyNumber_Multiply(__pyx_t_10, __pyx_v_split_cnt); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-        __pyx_t_10 = __Pyx_PyObject_GetSlice(__pyx_t_8, 0, 0, &__pyx_t_2, &__pyx_t_13, NULL, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __pyx_t_13 = NULL;
-        __pyx_t_11 = 0;
-        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_13 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_13)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_13);
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_9);
+        __pyx_t_11 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_11);
+        __pyx_t_3 = PyNumber_Multiply(__pyx_t_11, __pyx_v_split_cnt); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_3);
+        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+        __pyx_t_11 = PyInt_FromSsize_t((__pyx_v_i + 1)); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_11);
+        __pyx_t_14 = PyNumber_Multiply(__pyx_t_11, __pyx_v_split_cnt); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_14);
+        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+        __pyx_t_11 = __Pyx_PyObject_GetSlice(__pyx_t_9, 0, 0, &__pyx_t_3, &__pyx_t_14, NULL, 0, 0, 0); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_11);
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+        __pyx_t_14 = NULL;
+        __pyx_t_12 = 0;
+        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_10))) {
+          __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_10);
+          if (likely(__pyx_t_14)) {
+            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
+            __Pyx_INCREF(__pyx_t_14);
             __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-            __pyx_t_11 = 1;
+            __Pyx_DECREF_SET(__pyx_t_10, function);
+            __pyx_t_12 = 1;
           }
         }
         {
-          PyObject *__pyx_callargs[2] = {__pyx_t_13, __pyx_t_10};
-          __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-          __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
+          PyObject *__pyx_callargs[2] = {__pyx_t_14, __pyx_t_11};
+          __pyx_t_4 = __Pyx_PyObject_FastCall(__pyx_t_10, __pyx_callargs+1-__pyx_t_12, 1+__pyx_t_12);
+          __Pyx_XDECREF(__pyx_t_14); __pyx_t_14 = 0;
+          __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+          if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 364, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_4);
           __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-          if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 505, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         }
-        __pyx_t_12 = __Pyx_PyList_Append(__pyx_cur_scope->__pyx_v_datasets, __pyx_t_3); if (unlikely(__pyx_t_12 == ((int)-1))) __PYX_ERR(0, 505, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+        __pyx_t_13 = __Pyx_PyList_Append(__pyx_cur_scope->__pyx_v_datasets, __pyx_t_4); if (unlikely(__pyx_t_13 == ((int)-1))) __PYX_ERR(0, 364, __pyx_L1_error)
+        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       }
       __pyx_L8:;
     }
 
-    /* "druhg/_druhg_tree.pyx":507
+    /* "druhg/_druhg_tree.pyx":366
  *                     datasets.append(np.asarray(self.tree.data[i*split_cnt:(i+1)*split_cnt]))
  * 
  *             knn_data = Parallel(n_jobs=self.n_jobs)(             # <<<<<<<<<<<<<<
  *                 delayed(self.tree.query)
  *                 (points,
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_Parallel); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 507, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_10 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 507, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_10, __pyx_n_s_Parallel); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 366, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_13 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->n_jobs); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 507, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    if (PyDict_SetItem(__pyx_t_10, __pyx_n_s_n_jobs, __pyx_t_13) < 0) __PYX_ERR(0, 507, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-    __pyx_t_13 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_empty_tuple, __pyx_t_10); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 507, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __pyx_t_11 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 366, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __pyx_t_14 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->n_jobs); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 366, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    if (PyDict_SetItem(__pyx_t_11, __pyx_n_s_n_jobs, __pyx_t_14) < 0) __PYX_ERR(0, 366, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+    __pyx_t_14 = __Pyx_PyObject_Call(__pyx_t_10, __pyx_empty_tuple, __pyx_t_11); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 366, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
     __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
 
-    /* "druhg/_druhg_tree.pyx":509
+    /* "druhg/_druhg_tree.pyx":368
  *             knn_data = Parallel(n_jobs=self.n_jobs)(
  *                 delayed(self.tree.query)
  *                 (points,             # <<<<<<<<<<<<<<
  *                  self.max_neighbors_search + 1,
  *                  dualtree=True,
  */
-    __pyx_t_10 = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_genexpr(((PyObject*)__pyx_cur_scope)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 509, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_9 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_13))) {
-      __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_13);
-      if (likely(__pyx_t_9)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
-        __Pyx_INCREF(__pyx_t_9);
+    __pyx_t_11 = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_genexpr(((PyObject*)__pyx_cur_scope)); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 368, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __pyx_t_10 = NULL;
+    __pyx_t_12 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_14))) {
+      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_14);
+      if (likely(__pyx_t_10)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
+        __Pyx_INCREF(__pyx_t_10);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_13, function);
-        __pyx_t_11 = 1;
+        __Pyx_DECREF_SET(__pyx_t_14, function);
+        __pyx_t_12 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[2] = {__pyx_t_9, __pyx_t_10};
-      __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_13, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 507, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      PyObject *__pyx_callargs[2] = {__pyx_t_10, __pyx_t_11};
+      __pyx_t_4 = __Pyx_PyObject_FastCall(__pyx_t_14, __pyx_callargs+1-__pyx_t_12, 1+__pyx_t_12);
+      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+      if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 366, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
     }
-    __pyx_v_knn_data = __pyx_t_3;
-    __pyx_t_3 = 0;
+    __pyx_v_knn_data = __pyx_t_4;
+    __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_tree.pyx":515
+    /* "druhg/_druhg_tree.pyx":374
  *                  )
  *                 for points in datasets)
  *             knn_dist = np.vstack([x[0] for x in knn_data])             # <<<<<<<<<<<<<<
  *             knn_indices = np.vstack([x[1] for x in knn_data])
  *         else:
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_13, __pyx_n_s_np); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 515, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_13, __pyx_n_s_vstack); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 515, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+    __Pyx_GetModuleGlobalName(__pyx_t_14, __pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 374, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __pyx_t_11 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_vstack); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 374, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
     { /* enter inner scope */
-      __pyx_t_13 = PyList_New(0); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 515, __pyx_L11_error)
-      __Pyx_GOTREF(__pyx_t_13);
+      __pyx_t_14 = PyList_New(0); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 374, __pyx_L11_error)
+      __Pyx_GOTREF(__pyx_t_14);
       if (likely(PyList_CheckExact(__pyx_v_knn_data)) || PyTuple_CheckExact(__pyx_v_knn_data)) {
-        __pyx_t_9 = __pyx_v_knn_data; __Pyx_INCREF(__pyx_t_9); __pyx_t_14 = 0;
-        __pyx_t_15 = NULL;
+        __pyx_t_10 = __pyx_v_knn_data; __Pyx_INCREF(__pyx_t_10); __pyx_t_15 = 0;
+        __pyx_t_16 = NULL;
       } else {
-        __pyx_t_14 = -1; __pyx_t_9 = PyObject_GetIter(__pyx_v_knn_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 515, __pyx_L11_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_15 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_9); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 515, __pyx_L11_error)
+        __pyx_t_15 = -1; __pyx_t_10 = PyObject_GetIter(__pyx_v_knn_data); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 374, __pyx_L11_error)
+        __Pyx_GOTREF(__pyx_t_10);
+        __pyx_t_16 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_10); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 374, __pyx_L11_error)
       }
       for (;;) {
-        if (likely(!__pyx_t_15)) {
-          if (likely(PyList_CheckExact(__pyx_t_9))) {
-            if (__pyx_t_14 >= PyList_GET_SIZE(__pyx_t_9)) break;
+        if (likely(!__pyx_t_16)) {
+          if (likely(PyList_CheckExact(__pyx_t_10))) {
+            if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_10)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_2 = PyList_GET_ITEM(__pyx_t_9, __pyx_t_14); __Pyx_INCREF(__pyx_t_2); __pyx_t_14++; if (unlikely((0 < 0))) __PYX_ERR(0, 515, __pyx_L11_error)
+            __pyx_t_3 = PyList_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_3); __pyx_t_15++; if (unlikely((0 < 0))) __PYX_ERR(0, 374, __pyx_L11_error)
             #else
-            __pyx_t_2 = PySequence_ITEM(__pyx_t_9, __pyx_t_14); __pyx_t_14++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 515, __pyx_L11_error)
-            __Pyx_GOTREF(__pyx_t_2);
+            __pyx_t_3 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 374, __pyx_L11_error)
+            __Pyx_GOTREF(__pyx_t_3);
             #endif
           } else {
-            if (__pyx_t_14 >= PyTuple_GET_SIZE(__pyx_t_9)) break;
+            if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_10)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_2 = PyTuple_GET_ITEM(__pyx_t_9, __pyx_t_14); __Pyx_INCREF(__pyx_t_2); __pyx_t_14++; if (unlikely((0 < 0))) __PYX_ERR(0, 515, __pyx_L11_error)
+            __pyx_t_3 = PyTuple_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_3); __pyx_t_15++; if (unlikely((0 < 0))) __PYX_ERR(0, 374, __pyx_L11_error)
             #else
-            __pyx_t_2 = PySequence_ITEM(__pyx_t_9, __pyx_t_14); __pyx_t_14++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 515, __pyx_L11_error)
-            __Pyx_GOTREF(__pyx_t_2);
+            __pyx_t_3 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 374, __pyx_L11_error)
+            __Pyx_GOTREF(__pyx_t_3);
             #endif
           }
         } else {
-          __pyx_t_2 = __pyx_t_15(__pyx_t_9);
-          if (unlikely(!__pyx_t_2)) {
+          __pyx_t_3 = __pyx_t_16(__pyx_t_10);
+          if (unlikely(!__pyx_t_3)) {
             PyObject* exc_type = PyErr_Occurred();
             if (exc_type) {
               if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-              else __PYX_ERR(0, 515, __pyx_L11_error)
+              else __PYX_ERR(0, 374, __pyx_L11_error)
             }
             break;
           }
-          __Pyx_GOTREF(__pyx_t_2);
+          __Pyx_GOTREF(__pyx_t_3);
         }
-        __Pyx_XDECREF_SET(__pyx_8genexpr1__pyx_v_x, __pyx_t_2);
-        __pyx_t_2 = 0;
-        __pyx_t_2 = __Pyx_GetItemInt(__pyx_8genexpr1__pyx_v_x, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 515, __pyx_L11_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        if (unlikely(__Pyx_ListComp_Append(__pyx_t_13, (PyObject*)__pyx_t_2))) __PYX_ERR(0, 515, __pyx_L11_error)
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+        __Pyx_XDECREF_SET(__pyx_8genexpr1__pyx_v_x, __pyx_t_3);
+        __pyx_t_3 = 0;
+        __pyx_t_3 = __Pyx_GetItemInt(__pyx_8genexpr1__pyx_v_x, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 374, __pyx_L11_error)
+        __Pyx_GOTREF(__pyx_t_3);
+        if (unlikely(__Pyx_ListComp_Append(__pyx_t_14, (PyObject*)__pyx_t_3))) __PYX_ERR(0, 374, __pyx_L11_error)
+        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       }
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_XDECREF(__pyx_8genexpr1__pyx_v_x); __pyx_8genexpr1__pyx_v_x = 0;
       goto __pyx_L14_exit_scope;
       __pyx_L11_error:;
       __Pyx_XDECREF(__pyx_8genexpr1__pyx_v_x); __pyx_8genexpr1__pyx_v_x = 0;
       goto __pyx_L1_error;
       __pyx_L14_exit_scope:;
     } /* exit inner scope */
-    __pyx_t_9 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_10))) {
-      __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_10);
-      if (likely(__pyx_t_9)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
-        __Pyx_INCREF(__pyx_t_9);
+    __pyx_t_10 = NULL;
+    __pyx_t_12 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_11))) {
+      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_11);
+      if (likely(__pyx_t_10)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_11);
+        __Pyx_INCREF(__pyx_t_10);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_10, function);
-        __pyx_t_11 = 1;
+        __Pyx_DECREF_SET(__pyx_t_11, function);
+        __pyx_t_12 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[2] = {__pyx_t_9, __pyx_t_13};
-      __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_10, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 515, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+      PyObject *__pyx_callargs[2] = {__pyx_t_10, __pyx_t_14};
+      __pyx_t_4 = __Pyx_PyObject_FastCall(__pyx_t_11, __pyx_callargs+1-__pyx_t_12, 1+__pyx_t_12);
+      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+      if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 374, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
     }
-    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 515, __pyx_L1_error)
-    __pyx_t_16 = ((PyArrayObject *)__pyx_t_3);
+    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 374, __pyx_L1_error)
+    __pyx_t_17 = ((PyArrayObject *)__pyx_t_4);
     {
       __Pyx_BufFmt_StackElem __pyx_stack[1];
       __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
-      __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_t_16, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
-      if (unlikely(__pyx_t_11 < 0)) {
-        PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
+      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_t_17, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
+      if (unlikely(__pyx_t_12 < 0)) {
+        PyErr_Fetch(&__pyx_t_18, &__pyx_t_19, &__pyx_t_20);
         if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
-          Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
+          Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_20);
           __Pyx_RaiseBufferFallbackError();
         } else {
-          PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
+          PyErr_Restore(__pyx_t_18, __pyx_t_19, __pyx_t_20);
         }
-        __pyx_t_17 = __pyx_t_18 = __pyx_t_19 = 0;
+        __pyx_t_18 = __pyx_t_19 = __pyx_t_20 = 0;
       }
       __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
-      if (unlikely((__pyx_t_11 < 0))) __PYX_ERR(0, 515, __pyx_L1_error)
+      if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 374, __pyx_L1_error)
     }
-    __pyx_t_16 = 0;
-    __pyx_v_knn_dist = ((PyArrayObject *)__pyx_t_3);
-    __pyx_t_3 = 0;
+    __pyx_t_17 = 0;
+    __pyx_v_knn_dist = ((PyArrayObject *)__pyx_t_4);
+    __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_tree.pyx":516
+    /* "druhg/_druhg_tree.pyx":375
  *                 for points in datasets)
  *             knn_dist = np.vstack([x[0] for x in knn_data])
  *             knn_indices = np.vstack([x[1] for x in knn_data])             # <<<<<<<<<<<<<<
  *         else:
  *             knn_dist, knn_indices = self.dist_tree.query(
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_10, __pyx_n_s_np); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 516, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_10, __pyx_n_s_vstack); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 516, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_GetModuleGlobalName(__pyx_t_11, __pyx_n_s_np); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 375, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_11, __pyx_n_s_vstack); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 375, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
     { /* enter inner scope */
-      __pyx_t_10 = PyList_New(0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 516, __pyx_L17_error)
-      __Pyx_GOTREF(__pyx_t_10);
+      __pyx_t_11 = PyList_New(0); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 375, __pyx_L17_error)
+      __Pyx_GOTREF(__pyx_t_11);
       if (likely(PyList_CheckExact(__pyx_v_knn_data)) || PyTuple_CheckExact(__pyx_v_knn_data)) {
-        __pyx_t_9 = __pyx_v_knn_data; __Pyx_INCREF(__pyx_t_9); __pyx_t_14 = 0;
-        __pyx_t_15 = NULL;
+        __pyx_t_10 = __pyx_v_knn_data; __Pyx_INCREF(__pyx_t_10); __pyx_t_15 = 0;
+        __pyx_t_16 = NULL;
       } else {
-        __pyx_t_14 = -1; __pyx_t_9 = PyObject_GetIter(__pyx_v_knn_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 516, __pyx_L17_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_15 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_9); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 516, __pyx_L17_error)
+        __pyx_t_15 = -1; __pyx_t_10 = PyObject_GetIter(__pyx_v_knn_data); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 375, __pyx_L17_error)
+        __Pyx_GOTREF(__pyx_t_10);
+        __pyx_t_16 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_10); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 375, __pyx_L17_error)
       }
       for (;;) {
-        if (likely(!__pyx_t_15)) {
-          if (likely(PyList_CheckExact(__pyx_t_9))) {
-            if (__pyx_t_14 >= PyList_GET_SIZE(__pyx_t_9)) break;
+        if (likely(!__pyx_t_16)) {
+          if (likely(PyList_CheckExact(__pyx_t_10))) {
+            if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_10)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_2 = PyList_GET_ITEM(__pyx_t_9, __pyx_t_14); __Pyx_INCREF(__pyx_t_2); __pyx_t_14++; if (unlikely((0 < 0))) __PYX_ERR(0, 516, __pyx_L17_error)
+            __pyx_t_3 = PyList_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_3); __pyx_t_15++; if (unlikely((0 < 0))) __PYX_ERR(0, 375, __pyx_L17_error)
             #else
-            __pyx_t_2 = PySequence_ITEM(__pyx_t_9, __pyx_t_14); __pyx_t_14++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 516, __pyx_L17_error)
-            __Pyx_GOTREF(__pyx_t_2);
+            __pyx_t_3 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 375, __pyx_L17_error)
+            __Pyx_GOTREF(__pyx_t_3);
             #endif
           } else {
-            if (__pyx_t_14 >= PyTuple_GET_SIZE(__pyx_t_9)) break;
+            if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_10)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_2 = PyTuple_GET_ITEM(__pyx_t_9, __pyx_t_14); __Pyx_INCREF(__pyx_t_2); __pyx_t_14++; if (unlikely((0 < 0))) __PYX_ERR(0, 516, __pyx_L17_error)
+            __pyx_t_3 = PyTuple_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_3); __pyx_t_15++; if (unlikely((0 < 0))) __PYX_ERR(0, 375, __pyx_L17_error)
             #else
-            __pyx_t_2 = PySequence_ITEM(__pyx_t_9, __pyx_t_14); __pyx_t_14++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 516, __pyx_L17_error)
-            __Pyx_GOTREF(__pyx_t_2);
+            __pyx_t_3 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 375, __pyx_L17_error)
+            __Pyx_GOTREF(__pyx_t_3);
             #endif
           }
         } else {
-          __pyx_t_2 = __pyx_t_15(__pyx_t_9);
-          if (unlikely(!__pyx_t_2)) {
+          __pyx_t_3 = __pyx_t_16(__pyx_t_10);
+          if (unlikely(!__pyx_t_3)) {
             PyObject* exc_type = PyErr_Occurred();
             if (exc_type) {
               if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-              else __PYX_ERR(0, 516, __pyx_L17_error)
+              else __PYX_ERR(0, 375, __pyx_L17_error)
             }
             break;
           }
-          __Pyx_GOTREF(__pyx_t_2);
+          __Pyx_GOTREF(__pyx_t_3);
         }
-        __Pyx_XDECREF_SET(__pyx_8genexpr2__pyx_v_x, __pyx_t_2);
-        __pyx_t_2 = 0;
-        __pyx_t_2 = __Pyx_GetItemInt(__pyx_8genexpr2__pyx_v_x, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 516, __pyx_L17_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        if (unlikely(__Pyx_ListComp_Append(__pyx_t_10, (PyObject*)__pyx_t_2))) __PYX_ERR(0, 516, __pyx_L17_error)
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+        __Pyx_XDECREF_SET(__pyx_8genexpr2__pyx_v_x, __pyx_t_3);
+        __pyx_t_3 = 0;
+        __pyx_t_3 = __Pyx_GetItemInt(__pyx_8genexpr2__pyx_v_x, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 375, __pyx_L17_error)
+        __Pyx_GOTREF(__pyx_t_3);
+        if (unlikely(__Pyx_ListComp_Append(__pyx_t_11, (PyObject*)__pyx_t_3))) __PYX_ERR(0, 375, __pyx_L17_error)
+        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       }
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_XDECREF(__pyx_8genexpr2__pyx_v_x); __pyx_8genexpr2__pyx_v_x = 0;
       goto __pyx_L20_exit_scope;
       __pyx_L17_error:;
       __Pyx_XDECREF(__pyx_8genexpr2__pyx_v_x); __pyx_8genexpr2__pyx_v_x = 0;
       goto __pyx_L1_error;
       __pyx_L20_exit_scope:;
     } /* exit inner scope */
-    __pyx_t_9 = NULL;
-    __pyx_t_11 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_13))) {
-      __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_13);
-      if (likely(__pyx_t_9)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
-        __Pyx_INCREF(__pyx_t_9);
+    __pyx_t_10 = NULL;
+    __pyx_t_12 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_14))) {
+      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_14);
+      if (likely(__pyx_t_10)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
+        __Pyx_INCREF(__pyx_t_10);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_13, function);
-        __pyx_t_11 = 1;
+        __Pyx_DECREF_SET(__pyx_t_14, function);
+        __pyx_t_12 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[2] = {__pyx_t_9, __pyx_t_10};
-      __pyx_t_3 = __Pyx_PyObject_FastCall(__pyx_t_13, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-      __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 516, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      PyObject *__pyx_callargs[2] = {__pyx_t_10, __pyx_t_11};
+      __pyx_t_4 = __Pyx_PyObject_FastCall(__pyx_t_14, __pyx_callargs+1-__pyx_t_12, 1+__pyx_t_12);
+      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+      if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 375, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
     }
-    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 516, __pyx_L1_error)
-    __pyx_t_20 = ((PyArrayObject *)__pyx_t_3);
+    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 375, __pyx_L1_error)
+    __pyx_t_21 = ((PyArrayObject *)__pyx_t_4);
     {
       __Pyx_BufFmt_StackElem __pyx_stack[1];
       __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
-      __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_t_20, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
-      if (unlikely(__pyx_t_11 < 0)) {
-        PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
+      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_t_21, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
+      if (unlikely(__pyx_t_12 < 0)) {
+        PyErr_Fetch(&__pyx_t_20, &__pyx_t_19, &__pyx_t_18);
         if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
-          Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
+          Py_XDECREF(__pyx_t_20); Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18);
           __Pyx_RaiseBufferFallbackError();
         } else {
-          PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
+          PyErr_Restore(__pyx_t_20, __pyx_t_19, __pyx_t_18);
         }
-        __pyx_t_19 = __pyx_t_18 = __pyx_t_17 = 0;
+        __pyx_t_20 = __pyx_t_19 = __pyx_t_18 = 0;
       }
       __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
-      if (unlikely((__pyx_t_11 < 0))) __PYX_ERR(0, 516, __pyx_L1_error)
+      if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 375, __pyx_L1_error)
     }
-    __pyx_t_20 = 0;
-    __pyx_v_knn_indices = ((PyArrayObject *)__pyx_t_3);
-    __pyx_t_3 = 0;
+    __pyx_t_21 = 0;
+    __pyx_v_knn_indices = ((PyArrayObject *)__pyx_t_4);
+    __pyx_t_4 = 0;
 
-    /* "druhg/_druhg_tree.pyx":498
- *             np.ndarray[np.intp_t, ndim=2] knn_indices
+    /* "druhg/_druhg_tree.pyx":356
+ *             list heap
  * 
  *         if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets             # <<<<<<<<<<<<<<
+ *         # if self.n_jobs > 1:
  *             split_cnt = self.num_points // self.n_jobs
- *             datasets = []
  */
     goto __pyx_L3;
   }
 
-  /* "druhg/_druhg_tree.pyx":518
+  /* "druhg/_druhg_tree.pyx":377
  *             knn_indices = np.vstack([x[1] for x in knn_data])
  *         else:
  *             knn_dist, knn_indices = self.dist_tree.query(             # <<<<<<<<<<<<<<
  *                         self.tree.data,
  *                         k=self.max_neighbors_search + 1,
  */
   /*else*/ {
-    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->dist_tree, __pyx_n_s_query); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 518, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->dist_tree, __pyx_n_s_query); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 377, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
 
-    /* "druhg/_druhg_tree.pyx":519
+    /* "druhg/_druhg_tree.pyx":378
  *         else:
  *             knn_dist, knn_indices = self.dist_tree.query(
  *                         self.tree.data,             # <<<<<<<<<<<<<<
  *                         k=self.max_neighbors_search + 1,
  *                         dualtree=True,
  */
-    __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 519, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
+    __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_cur_scope->__pyx_v_self->tree, __pyx_n_s_data); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 378, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
 
-    /* "druhg/_druhg_tree.pyx":518
+    /* "druhg/_druhg_tree.pyx":377
  *             knn_indices = np.vstack([x[1] for x in knn_data])
  *         else:
  *             knn_dist, knn_indices = self.dist_tree.query(             # <<<<<<<<<<<<<<
  *                         self.tree.data,
  *                         k=self.max_neighbors_search + 1,
  */
-    __pyx_t_10 = PyTuple_New(1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 518, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __Pyx_GIVEREF(__pyx_t_13);
-    PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_13);
-    __pyx_t_13 = 0;
+    __pyx_t_11 = PyTuple_New(1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 377, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __Pyx_GIVEREF(__pyx_t_14);
+    PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_14);
+    __pyx_t_14 = 0;
 
-    /* "druhg/_druhg_tree.pyx":520
+    /* "druhg/_druhg_tree.pyx":379
  *             knn_dist, knn_indices = self.dist_tree.query(
  *                         self.tree.data,
  *                         k=self.max_neighbors_search + 1,             # <<<<<<<<<<<<<<
  *                         dualtree=True,
  *                         breadth_first=True,
  */
-    __pyx_t_13 = __Pyx_PyDict_NewPresized(3); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 520, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __pyx_t_9 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_v_self->max_neighbors_search + 1)); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 520, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    if (PyDict_SetItem(__pyx_t_13, __pyx_n_s_k, __pyx_t_9) < 0) __PYX_ERR(0, 520, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __pyx_t_14 = __Pyx_PyDict_NewPresized(3); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 379, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __pyx_t_10 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_v_self->max_neighbors_search + 1)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 379, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    if (PyDict_SetItem(__pyx_t_14, __pyx_n_s_k, __pyx_t_10) < 0) __PYX_ERR(0, 379, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-    /* "druhg/_druhg_tree.pyx":521
+    /* "druhg/_druhg_tree.pyx":380
  *                         self.tree.data,
  *                         k=self.max_neighbors_search + 1,
  *                         dualtree=True,             # <<<<<<<<<<<<<<
  *                         breadth_first=True,
  *                         )
  */
-    if (PyDict_SetItem(__pyx_t_13, __pyx_n_s_dualtree, Py_True) < 0) __PYX_ERR(0, 520, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_14, __pyx_n_s_dualtree, Py_True) < 0) __PYX_ERR(0, 379, __pyx_L1_error)
 
-    /* "druhg/_druhg_tree.pyx":522
+    /* "druhg/_druhg_tree.pyx":381
  *                         k=self.max_neighbors_search + 1,
  *                         dualtree=True,
  *                         breadth_first=True,             # <<<<<<<<<<<<<<
  *                         )
- * 
+ *         heap = []
  */
-    if (PyDict_SetItem(__pyx_t_13, __pyx_n_s_breadth_first, Py_True) < 0) __PYX_ERR(0, 520, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_14, __pyx_n_s_breadth_first, Py_True) < 0) __PYX_ERR(0, 379, __pyx_L1_error)
 
-    /* "druhg/_druhg_tree.pyx":518
+    /* "druhg/_druhg_tree.pyx":377
  *             knn_indices = np.vstack([x[1] for x in knn_data])
  *         else:
  *             knn_dist, knn_indices = self.dist_tree.query(             # <<<<<<<<<<<<<<
  *                         self.tree.data,
  *                         k=self.max_neighbors_search + 1,
  */
-    __pyx_t_9 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_10, __pyx_t_13); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 518, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-    if ((likely(PyTuple_CheckExact(__pyx_t_9))) || (PyList_CheckExact(__pyx_t_9))) {
-      PyObject* sequence = __pyx_t_9;
+    __pyx_t_10 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_11, __pyx_t_14); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 377, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+    if ((likely(PyTuple_CheckExact(__pyx_t_10))) || (PyList_CheckExact(__pyx_t_10))) {
+      PyObject* sequence = __pyx_t_10;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 2)) {
         if (size > 2) __Pyx_RaiseTooManyValuesError(2);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 518, __pyx_L1_error)
+        __PYX_ERR(0, 377, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
-        __pyx_t_13 = PyTuple_GET_ITEM(sequence, 0); 
-        __pyx_t_10 = PyTuple_GET_ITEM(sequence, 1); 
+        __pyx_t_14 = PyTuple_GET_ITEM(sequence, 0); 
+        __pyx_t_11 = PyTuple_GET_ITEM(sequence, 1); 
       } else {
-        __pyx_t_13 = PyList_GET_ITEM(sequence, 0); 
-        __pyx_t_10 = PyList_GET_ITEM(sequence, 1); 
+        __pyx_t_14 = PyList_GET_ITEM(sequence, 0); 
+        __pyx_t_11 = PyList_GET_ITEM(sequence, 1); 
       }
-      __Pyx_INCREF(__pyx_t_13);
-      __Pyx_INCREF(__pyx_t_10);
+      __Pyx_INCREF(__pyx_t_14);
+      __Pyx_INCREF(__pyx_t_11);
       #else
-      __pyx_t_13 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 518, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_13);
-      __pyx_t_10 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 518, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
+      __pyx_t_14 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 377, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_14);
+      __pyx_t_11 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 377, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_11);
       #endif
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
     } else {
       Py_ssize_t index = -1;
-      __pyx_t_3 = PyObject_GetIter(__pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 518, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __pyx_t_21 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_3);
-      index = 0; __pyx_t_13 = __pyx_t_21(__pyx_t_3); if (unlikely(!__pyx_t_13)) goto __pyx_L21_unpacking_failed;
-      __Pyx_GOTREF(__pyx_t_13);
-      index = 1; __pyx_t_10 = __pyx_t_21(__pyx_t_3); if (unlikely(!__pyx_t_10)) goto __pyx_L21_unpacking_failed;
-      __Pyx_GOTREF(__pyx_t_10);
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_21(__pyx_t_3), 2) < 0) __PYX_ERR(0, 518, __pyx_L1_error)
-      __pyx_t_21 = NULL;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __pyx_t_4 = PyObject_GetIter(__pyx_t_10); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 377, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __pyx_t_22 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_4);
+      index = 0; __pyx_t_14 = __pyx_t_22(__pyx_t_4); if (unlikely(!__pyx_t_14)) goto __pyx_L21_unpacking_failed;
+      __Pyx_GOTREF(__pyx_t_14);
+      index = 1; __pyx_t_11 = __pyx_t_22(__pyx_t_4); if (unlikely(!__pyx_t_11)) goto __pyx_L21_unpacking_failed;
+      __Pyx_GOTREF(__pyx_t_11);
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_22(__pyx_t_4), 2) < 0) __PYX_ERR(0, 377, __pyx_L1_error)
+      __pyx_t_22 = NULL;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       goto __pyx_L22_unpacking_done;
       __pyx_L21_unpacking_failed:;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_21 = NULL;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_22 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 518, __pyx_L1_error)
+      __PYX_ERR(0, 377, __pyx_L1_error)
       __pyx_L22_unpacking_done:;
     }
-    if (!(likely(((__pyx_t_13) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_13, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 518, __pyx_L1_error)
-    if (!(likely(((__pyx_t_10) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_10, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 518, __pyx_L1_error)
-    __pyx_t_16 = ((PyArrayObject *)__pyx_t_13);
+    if (!(likely(((__pyx_t_14) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_14, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 377, __pyx_L1_error)
+    if (!(likely(((__pyx_t_11) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_11, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 377, __pyx_L1_error)
+    __pyx_t_17 = ((PyArrayObject *)__pyx_t_14);
     {
       __Pyx_BufFmt_StackElem __pyx_stack[1];
       __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
-      __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_t_16, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
-      if (unlikely(__pyx_t_11 < 0)) {
-        PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
+      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_t_17, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
+      if (unlikely(__pyx_t_12 < 0)) {
+        PyErr_Fetch(&__pyx_t_18, &__pyx_t_19, &__pyx_t_20);
         if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_dist, &__Pyx_TypeInfo_nn___pyx_t_5numpy_double_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
-          Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
+          Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_20);
           __Pyx_RaiseBufferFallbackError();
         } else {
-          PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
+          PyErr_Restore(__pyx_t_18, __pyx_t_19, __pyx_t_20);
         }
-        __pyx_t_17 = __pyx_t_18 = __pyx_t_19 = 0;
+        __pyx_t_18 = __pyx_t_19 = __pyx_t_20 = 0;
       }
       __pyx_pybuffernd_knn_dist.diminfo[0].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_dist.diminfo[0].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_dist.diminfo[1].strides = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_dist.diminfo[1].shape = __pyx_pybuffernd_knn_dist.rcbuffer->pybuffer.shape[1];
-      if (unlikely((__pyx_t_11 < 0))) __PYX_ERR(0, 518, __pyx_L1_error)
+      if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 377, __pyx_L1_error)
     }
-    __pyx_t_16 = 0;
-    __pyx_v_knn_dist = ((PyArrayObject *)__pyx_t_13);
-    __pyx_t_13 = 0;
-    __pyx_t_20 = ((PyArrayObject *)__pyx_t_10);
+    __pyx_t_17 = 0;
+    __pyx_v_knn_dist = ((PyArrayObject *)__pyx_t_14);
+    __pyx_t_14 = 0;
+    __pyx_t_21 = ((PyArrayObject *)__pyx_t_11);
     {
       __Pyx_BufFmt_StackElem __pyx_stack[1];
       __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
-      __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_t_20, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
-      if (unlikely(__pyx_t_11 < 0)) {
-        PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
+      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_t_21, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
+      if (unlikely(__pyx_t_12 < 0)) {
+        PyErr_Fetch(&__pyx_t_20, &__pyx_t_19, &__pyx_t_18);
         if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer, (PyObject*)__pyx_v_knn_indices, &__Pyx_TypeInfo_nn___pyx_t_5numpy_intp_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
-          Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
+          Py_XDECREF(__pyx_t_20); Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18);
           __Pyx_RaiseBufferFallbackError();
         } else {
-          PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
+          PyErr_Restore(__pyx_t_20, __pyx_t_19, __pyx_t_18);
         }
-        __pyx_t_19 = __pyx_t_18 = __pyx_t_17 = 0;
+        __pyx_t_20 = __pyx_t_19 = __pyx_t_18 = 0;
       }
       __pyx_pybuffernd_knn_indices.diminfo[0].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_knn_indices.diminfo[0].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_knn_indices.diminfo[1].strides = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_knn_indices.diminfo[1].shape = __pyx_pybuffernd_knn_indices.rcbuffer->pybuffer.shape[1];
-      if (unlikely((__pyx_t_11 < 0))) __PYX_ERR(0, 518, __pyx_L1_error)
+      if (unlikely((__pyx_t_12 < 0))) __PYX_ERR(0, 377, __pyx_L1_error)
     }
-    __pyx_t_20 = 0;
-    __pyx_v_knn_indices = ((PyArrayObject *)__pyx_t_10);
-    __pyx_t_10 = 0;
+    __pyx_t_21 = 0;
+    __pyx_v_knn_indices = ((PyArrayObject *)__pyx_t_11);
+    __pyx_t_11 = 0;
   }
   __pyx_L3:;
 
-  /* "druhg/_druhg_tree.pyx":525
+  /* "druhg/_druhg_tree.pyx":383
+ *                         breadth_first=True,
  *                         )
- * 
- *         warn, infinitesimal = 0, 0             # <<<<<<<<<<<<<<
- *         heap = []
- * #### Initialization of pure reciprocity then ranks are less than 2
+ *         heap = []             # <<<<<<<<<<<<<<
+ * #### Initialization and pure reciprocity (ranks <= 2)
+ *         warn, infinitesimal = 0, 0
  */
-  __pyx_t_5 = 0;
-  __pyx_t_6 = 0;
-  __pyx_v_warn = __pyx_t_5;
-  __pyx_v_infinitesimal = __pyx_t_6;
+  __pyx_t_10 = PyList_New(0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 383, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_10);
+  __pyx_v_heap = ((PyObject*)__pyx_t_10);
+  __pyx_t_10 = 0;
 
-  /* "druhg/_druhg_tree.pyx":526
+  /* "druhg/_druhg_tree.pyx":385
+ *         heap = []
+ * #### Initialization and pure reciprocity (ranks <= 2)
+ *         warn, infinitesimal = 0, 0             # <<<<<<<<<<<<<<
  * 
- *         warn, infinitesimal = 0, 0
- *         heap = []             # <<<<<<<<<<<<<<
- * #### Initialization of pure reciprocity then ranks are less than 2
- *         i = self.num_points
+ *         # if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets
  */
-  __pyx_t_9 = PyList_New(0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 526, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __pyx_v_heap = ((PyObject*)__pyx_t_9);
-  __pyx_t_9 = 0;
+  __pyx_t_6 = 0;
+  __pyx_t_7 = 0;
+  __pyx_v_warn = __pyx_t_6;
+  __pyx_v_infinitesimal = __pyx_t_7;
 
-  /* "druhg/_druhg_tree.pyx":528
- *         heap = []
- * #### Initialization of pure reciprocity then ranks are less than 2
+  /* "druhg/_druhg_tree.pyx":388
+ * 
+ *         # if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets
  *         i = self.num_points             # <<<<<<<<<<<<<<
  *         while i:
  *             i -= 1
  */
-  __pyx_t_6 = __pyx_cur_scope->__pyx_v_self->num_points;
-  __pyx_v_i = __pyx_t_6;
+  __pyx_t_7 = __pyx_cur_scope->__pyx_v_self->num_points;
+  __pyx_v_i = __pyx_t_7;
 
-  /* "druhg/_druhg_tree.pyx":529
- * #### Initialization of pure reciprocity then ranks are less than 2
+  /* "druhg/_druhg_tree.pyx":389
+ *         # if self.tree.data.shape[0] > 16384 and self.n_jobs > 1: # multicore 2-3x speed up for big datasets
  *         i = self.num_points
  *         while i:             # <<<<<<<<<<<<<<
  *             i -= 1
  *             if knn_dist[i][0] < 0.:
  */
   while (1) {
-    __pyx_t_1 = (__pyx_v_i != 0);
-    if (!__pyx_t_1) break;
+    __pyx_t_2 = (__pyx_v_i != 0);
+    if (!__pyx_t_2) break;
 
-    /* "druhg/_druhg_tree.pyx":530
+    /* "druhg/_druhg_tree.pyx":390
  *         i = self.num_points
  *         while i:
  *             i -= 1             # <<<<<<<<<<<<<<
  *             if knn_dist[i][0] < 0.:
  *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])
  */
     __pyx_v_i = (__pyx_v_i - 1);
 
-    /* "druhg/_druhg_tree.pyx":531
+    /* "druhg/_druhg_tree.pyx":391
  *         while i:
  *             i -= 1
  *             if knn_dist[i][0] < 0.:             # <<<<<<<<<<<<<<
  *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])
  *                 return
  */
-    __pyx_t_9 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 531, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_10 = __Pyx_GetItemInt(__pyx_t_9, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 531, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 391, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __pyx_t_9 = PyObject_RichCompare(__pyx_t_10, __pyx_float_0_, Py_LT); __Pyx_XGOTREF(__pyx_t_9); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 531, __pyx_L1_error)
+    __pyx_t_11 = __Pyx_GetItemInt(__pyx_t_10, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 391, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
     __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely((__pyx_t_1 < 0))) __PYX_ERR(0, 531, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    if (__pyx_t_1) {
+    __pyx_t_10 = PyObject_RichCompare(__pyx_t_11, __pyx_float_0_, Py_LT); __Pyx_XGOTREF(__pyx_t_10); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 391, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_10); if (unlikely((__pyx_t_2 < 0))) __PYX_ERR(0, 391, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    if (__pyx_t_2) {
 
-      /* "druhg/_druhg_tree.pyx":532
+      /* "druhg/_druhg_tree.pyx":392
  *             i -= 1
  *             if knn_dist[i][0] < 0.:
  *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])             # <<<<<<<<<<<<<<
  *                 return
- * 
+ *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):
  */
-      __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 532, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_10 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 532, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_13 = __Pyx_GetItemInt(__pyx_t_10, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 532, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_13);
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __pyx_t_10 = PyTuple_New(3); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 532, __pyx_L1_error)
+      __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 392, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
+      __pyx_t_11 = __Pyx_GetItemInt(((PyObject *)__pyx_v_knn_dist), __pyx_v_i, __pyx_t_5numpy_intp_t, 1, PyInt_FromSsize_t, 0, 0, 0); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 392, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_11);
+      __pyx_t_14 = __Pyx_GetItemInt(__pyx_t_11, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 392, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_14);
+      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+      __pyx_t_11 = PyTuple_New(3); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 392, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_11);
       __Pyx_INCREF(__pyx_kp_u_Distances_cannot_be_negative_Exi);
       __Pyx_GIVEREF(__pyx_kp_u_Distances_cannot_be_negative_Exi);
-      PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_kp_u_Distances_cannot_be_negative_Exi);
-      __Pyx_GIVEREF(__pyx_t_9);
-      PyTuple_SET_ITEM(__pyx_t_10, 1, __pyx_t_9);
-      __Pyx_GIVEREF(__pyx_t_13);
-      PyTuple_SET_ITEM(__pyx_t_10, 2, __pyx_t_13);
-      __pyx_t_9 = 0;
-      __pyx_t_13 = 0;
-      __pyx_t_13 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_10, NULL); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 532, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_13);
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_kp_u_Distances_cannot_be_negative_Exi);
+      __Pyx_GIVEREF(__pyx_t_10);
+      PyTuple_SET_ITEM(__pyx_t_11, 1, __pyx_t_10);
+      __Pyx_GIVEREF(__pyx_t_14);
+      PyTuple_SET_ITEM(__pyx_t_11, 2, __pyx_t_14);
+      __pyx_t_10 = 0;
+      __pyx_t_14 = 0;
+      __pyx_t_14 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_11, NULL); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 392, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_14);
+      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
 
-      /* "druhg/_druhg_tree.pyx":533
+      /* "druhg/_druhg_tree.pyx":393
  *             if knn_dist[i][0] < 0.:
  *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])
  *                 return             # <<<<<<<<<<<<<<
- * 
- *             rel.reciprocity = 1.
+ *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, 2)
  */
       __Pyx_XDECREF(__pyx_r);
       __pyx_r = Py_None; __Pyx_INCREF(Py_None);
       goto __pyx_L0;
 
-      /* "druhg/_druhg_tree.pyx":531
+      /* "druhg/_druhg_tree.pyx":391
  *         while i:
  *             i -= 1
  *             if knn_dist[i][0] < 0.:             # <<<<<<<<<<<<<<
  *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])
  *                 return
  */
     }
 
-    /* "druhg/_druhg_tree.pyx":535
+    /* "druhg/_druhg_tree.pyx":394
+ *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])
  *                 return
- * 
- *             rel.reciprocity = 1.             # <<<<<<<<<<<<<<
- *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):
- *                 self.U.union(i, rel.target)
- */
-    __pyx_v_rel.reciprocity = 1.;
-
-    /* "druhg/_druhg_tree.pyx":536
- * 
- *             rel.reciprocity = 1.
  *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):             # <<<<<<<<<<<<<<
- *                 self.U.union(i, rel.target)
- *                 self.result_add_edge(i, rel.target, rel.dia_dis)
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, 2)
+ *                 p = self.U.mark_up(i)
  */
-    __pyx_t_1 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_pure_reciprocity(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel), (&__pyx_v_infinitesimal)) != 0);
-    if (__pyx_t_1) {
+    __pyx_t_2 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_pure_reciprocity(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel), (&__pyx_v_infinitesimal)) != 0);
+    if (__pyx_t_2) {
 
-      /* "druhg/_druhg_tree.pyx":537
- *             rel.reciprocity = 1.
+      /* "druhg/_druhg_tree.pyx":395
+ *                 return
  *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):
- *                 self.U.union(i, rel.target)             # <<<<<<<<<<<<<<
- *                 self.result_add_edge(i, rel.target, rel.dia_dis)
- * 
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, 2)             # <<<<<<<<<<<<<<
+ *                 p = self.U.mark_up(i)
+ *                 op = self.U.mark_up(rel.endpoint)
  */
-      ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->__pyx_union(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i, __pyx_v_rel.target);
+      ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->result_write(__pyx_cur_scope->__pyx_v_self, __pyx_v_rel.reciprocity, __pyx_v_i, __pyx_v_rel.endpoint, 2);
 
-      /* "druhg/_druhg_tree.pyx":538
+      /* "druhg/_druhg_tree.pyx":396
  *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):
- *                 self.U.union(i, rel.target)
- *                 self.result_add_edge(i, rel.target, rel.dia_dis)             # <<<<<<<<<<<<<<
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, 2)
+ *                 p = self.U.mark_up(i)             # <<<<<<<<<<<<<<
+ *                 op = self.U.mark_up(rel.endpoint)
+ *                 self.U.union(i, rel.endpoint, p, op)
+ */
+      __pyx_v_p = ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i);
+
+      /* "druhg/_druhg_tree.pyx":397
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, 2)
+ *                 p = self.U.mark_up(i)
+ *                 op = self.U.mark_up(rel.endpoint)             # <<<<<<<<<<<<<<
+ *                 self.U.union(i, rel.endpoint, p, op)
  * 
- *             if rel.reciprocity == 0.: # values match
  */
-      ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->result_add_edge(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, __pyx_v_rel.target, __pyx_v_rel.dia_dis);
+      __pyx_v_op = ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_rel.endpoint);
 
-      /* "druhg/_druhg_tree.pyx":536
+      /* "druhg/_druhg_tree.pyx":398
+ *                 p = self.U.mark_up(i)
+ *                 op = self.U.mark_up(rel.endpoint)
+ *                 self.U.union(i, rel.endpoint, p, op)             # <<<<<<<<<<<<<<
  * 
- *             rel.reciprocity = 1.
- *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):             # <<<<<<<<<<<<<<
- *                 self.U.union(i, rel.target)
- *                 self.result_add_edge(i, rel.target, rel.dia_dis)
+ *                 if rel.reciprocity == 0.: # values match
  */
-    }
+      ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->__pyx_union(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i, __pyx_v_rel.endpoint, __pyx_v_p, __pyx_v_op);
 
-    /* "druhg/_druhg_tree.pyx":540
- *                 self.result_add_edge(i, rel.target, rel.dia_dis)
+      /* "druhg/_druhg_tree.pyx":400
+ *                 self.U.union(i, rel.endpoint, p, op)
  * 
- *             if rel.reciprocity == 0.: # values match             # <<<<<<<<<<<<<<
- *                 warn += 1
- *                 i += 1 # need to relaunch same values
+ *                 if rel.reciprocity == 0.: # values match             # <<<<<<<<<<<<<<
+ *                     warn += 1
+ *                     i += 1  # need to relaunch same index
  */
-    __pyx_t_1 = ((__pyx_v_rel.reciprocity == 0.) != 0);
-    if (__pyx_t_1) {
+      __pyx_t_2 = ((__pyx_v_rel.reciprocity == 0.) != 0);
+      if (__pyx_t_2) {
 
-      /* "druhg/_druhg_tree.pyx":541
+        /* "druhg/_druhg_tree.pyx":401
  * 
- *             if rel.reciprocity == 0.: # values match
- *                 warn += 1             # <<<<<<<<<<<<<<
- *                 i += 1 # need to relaunch same values
- *                 continue
+ *                 if rel.reciprocity == 0.: # values match
+ *                     warn += 1             # <<<<<<<<<<<<<<
+ *                     i += 1  # need to relaunch same index
+ *                     continue
  */
-      __pyx_v_warn = (__pyx_v_warn + 1);
+        __pyx_v_warn = (__pyx_v_warn + 1);
 
-      /* "druhg/_druhg_tree.pyx":542
- *             if rel.reciprocity == 0.: # values match
- *                 warn += 1
- *                 i += 1 # need to relaunch same values             # <<<<<<<<<<<<<<
- *                 continue
+        /* "druhg/_druhg_tree.pyx":402
+ *                 if rel.reciprocity == 0.: # values match
+ *                     warn += 1
+ *                     i += 1  # need to relaunch same index             # <<<<<<<<<<<<<<
+ *                     continue
  * 
  */
-      __pyx_v_i = (__pyx_v_i + 1);
+        __pyx_v_i = (__pyx_v_i + 1);
 
-      /* "druhg/_druhg_tree.pyx":543
- *                 warn += 1
- *                 i += 1 # need to relaunch same values
- *                 continue             # <<<<<<<<<<<<<<
+        /* "druhg/_druhg_tree.pyx":403
+ *                     warn += 1
+ *                     i += 1  # need to relaunch same index
+ *                     continue             # <<<<<<<<<<<<<<
  * 
- *                 # print ('pure', i,j)
+ *             rel.skip_first = 1
  */
-      goto __pyx_L23_continue;
+        goto __pyx_L23_continue;
 
-      /* "druhg/_druhg_tree.pyx":540
- *                 self.result_add_edge(i, rel.target, rel.dia_dis)
+        /* "druhg/_druhg_tree.pyx":400
+ *                 self.U.union(i, rel.endpoint, p, op)
  * 
- *             if rel.reciprocity == 0.: # values match             # <<<<<<<<<<<<<<
- *                 warn += 1
- *                 i += 1 # need to relaunch same values
+ *                 if rel.reciprocity == 0.: # values match             # <<<<<<<<<<<<<<
+ *                     warn += 1
+ *                     i += 1  # need to relaunch same index
  */
-    }
+      }
 
-    /* "druhg/_druhg_tree.pyx":547
- *                 # print ('pure', i,j)
- * #### initialization of reciprocities
- *             if (is_slow and self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel))\             # <<<<<<<<<<<<<<
- *             or (not is_slow and self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel)):
- *                 heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis))
+      /* "druhg/_druhg_tree.pyx":394
+ *                 print ('Distances cannot be negative! Exiting. ', i, knn_dist[i][0])
+ *                 return
+ *             if self._pure_reciprocity(i, knn_indices, knn_dist, &rel, &infinitesimal):             # <<<<<<<<<<<<<<
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, 2)
+ *                 p = self.U.mark_up(i)
  */
-    __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_v_is_slow); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 547, __pyx_L1_error)
-    if (!__pyx_t_4) {
-      goto __pyx_L30_next_or;
-    } else {
     }
-    __pyx_t_4 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_evaluate_reciprocity_slow(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel)) != 0);
-    if (!__pyx_t_4) {
-    } else {
-      __pyx_t_1 = __pyx_t_4;
-      goto __pyx_L29_bool_binop_done;
-    }
-    __pyx_L30_next_or:;
 
-    /* "druhg/_druhg_tree.pyx":548
- * #### initialization of reciprocities
- *             if (is_slow and self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel))\
- *             or (not is_slow and self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel)):             # <<<<<<<<<<<<<<
- *                 heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis))
- *                 # print('RESULT', rel.reciprocity, i)
- */
-    __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_v_is_slow); if (unlikely((__pyx_t_4 < 0))) __PYX_ERR(0, 548, __pyx_L1_error)
-    __pyx_t_22 = ((!__pyx_t_4) != 0);
-    if (__pyx_t_22) {
-    } else {
-      __pyx_t_1 = __pyx_t_22;
-      goto __pyx_L29_bool_binop_done;
-    }
-    __pyx_t_22 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_evaluate_reciprocity_fast(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel)) != 0);
-    __pyx_t_1 = __pyx_t_22;
-    __pyx_L29_bool_binop_done:;
-
-    /* "druhg/_druhg_tree.pyx":547
- *                 # print ('pure', i,j)
- * #### initialization of reciprocities
- *             if (is_slow and self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel))\             # <<<<<<<<<<<<<<
- *             or (not is_slow and self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel)):
- *                 heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis))
- */
-    if (__pyx_t_1) {
-
-      /* "druhg/_druhg_tree.pyx":549
- *             if (is_slow and self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel))\
- *             or (not is_slow and self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel)):
- *                 heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis))             # <<<<<<<<<<<<<<
- *                 # print('RESULT', rel.reciprocity, i)
- *         # return
+    /* "druhg/_druhg_tree.pyx":405
+ *                     continue
+ * 
+ *             rel.skip_first = 1             # <<<<<<<<<<<<<<
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):
+ *                 heapq.heappush(heap,
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_10, __pyx_n_s_heapq); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 549, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_10, __pyx_n_s_heappush); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 549, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __pyx_t_10 = PyFloat_FromDouble(__pyx_v_rel.reciprocity); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 549, __pyx_L1_error)
+    __pyx_v_rel.skip_first = 1;
+
+    /* "druhg/_druhg_tree.pyx":406
+ * 
+ *             rel.skip_first = 1
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
+ *                 heapq.heappush(heap,
+ *                                (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
+ */
+    __pyx_t_2 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_evaluate_reciprocity(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel)) != 0);
+    if (__pyx_t_2) {
+
+      /* "druhg/_druhg_tree.pyx":407
+ *             rel.skip_first = 1
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):
+ *                 heapq.heappush(heap,             # <<<<<<<<<<<<<<
+ *                                (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
+ * 
+ */
+      __Pyx_GetModuleGlobalName(__pyx_t_11, __pyx_n_s_heapq); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 407, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_11);
+      __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_11, __pyx_n_s_heappush); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 407, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 549, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+
+      /* "druhg/_druhg_tree.pyx":408
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):
+ *                 heapq.heappush(heap,
+ *                                (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))             # <<<<<<<<<<<<<<
+ * 
+ *         if self.result_edges >= self.num_points - 1:
+ */
+      __pyx_t_11 = PyFloat_FromDouble(__pyx_v_rel.reciprocity); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 408, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_11);
+      __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 408, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_rel.endpoint); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 408, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_rel.target); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 549, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_8 = PyFloat_FromDouble(__pyx_v_rel.dia_dis); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 549, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __pyx_t_23 = PyTuple_New(4); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 549, __pyx_L1_error)
+      __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_rel.max_rank); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 408, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_9);
+      __pyx_t_23 = PyInt_FromSsize_t(__pyx_v_rel.skip_first); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 408, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_23);
-      __Pyx_GIVEREF(__pyx_t_10);
-      PyTuple_SET_ITEM(__pyx_t_23, 0, __pyx_t_10);
+      __pyx_t_24 = PyTuple_New(5); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 408, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_24);
+      __Pyx_GIVEREF(__pyx_t_11);
+      PyTuple_SET_ITEM(__pyx_t_24, 0, __pyx_t_11);
+      __Pyx_GIVEREF(__pyx_t_4);
+      PyTuple_SET_ITEM(__pyx_t_24, 1, __pyx_t_4);
       __Pyx_GIVEREF(__pyx_t_3);
-      PyTuple_SET_ITEM(__pyx_t_23, 1, __pyx_t_3);
-      __Pyx_GIVEREF(__pyx_t_2);
-      PyTuple_SET_ITEM(__pyx_t_23, 2, __pyx_t_2);
-      __Pyx_GIVEREF(__pyx_t_8);
-      PyTuple_SET_ITEM(__pyx_t_23, 3, __pyx_t_8);
-      __pyx_t_10 = 0;
-      __pyx_t_3 = 0;
-      __pyx_t_2 = 0;
-      __pyx_t_8 = 0;
-      __pyx_t_8 = NULL;
+      PyTuple_SET_ITEM(__pyx_t_24, 2, __pyx_t_3);
+      __Pyx_GIVEREF(__pyx_t_9);
+      PyTuple_SET_ITEM(__pyx_t_24, 3, __pyx_t_9);
+      __Pyx_GIVEREF(__pyx_t_23);
+      PyTuple_SET_ITEM(__pyx_t_24, 4, __pyx_t_23);
       __pyx_t_11 = 0;
-      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
-        __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_9);
-        if (likely(__pyx_t_8)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-          __Pyx_INCREF(__pyx_t_8);
+      __pyx_t_4 = 0;
+      __pyx_t_3 = 0;
+      __pyx_t_9 = 0;
+      __pyx_t_23 = 0;
+      __pyx_t_23 = NULL;
+      __pyx_t_12 = 0;
+      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_10))) {
+        __pyx_t_23 = PyMethod_GET_SELF(__pyx_t_10);
+        if (likely(__pyx_t_23)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
+          __Pyx_INCREF(__pyx_t_23);
           __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_9, function);
-          __pyx_t_11 = 1;
+          __Pyx_DECREF_SET(__pyx_t_10, function);
+          __pyx_t_12 = 1;
         }
       }
       {
-        PyObject *__pyx_callargs[3] = {__pyx_t_8, __pyx_v_heap, __pyx_t_23};
-        __pyx_t_13 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-        __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 549, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+        PyObject *__pyx_callargs[3] = {__pyx_t_23, __pyx_v_heap, __pyx_t_24};
+        __pyx_t_14 = __Pyx_PyObject_FastCall(__pyx_t_10, __pyx_callargs+1-__pyx_t_12, 2+__pyx_t_12);
+        __Pyx_XDECREF(__pyx_t_23); __pyx_t_23 = 0;
+        __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
+        if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 407, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_14);
+        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
       }
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
 
-      /* "druhg/_druhg_tree.pyx":547
- *                 # print ('pure', i,j)
- * #### initialization of reciprocities
- *             if (is_slow and self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel))\             # <<<<<<<<<<<<<<
- *             or (not is_slow and self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel)):
- *                 heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis))
+      /* "druhg/_druhg_tree.pyx":406
+ * 
+ *             rel.skip_first = 1
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
+ *                 heapq.heappush(heap,
+ *                                (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
  */
     }
     __pyx_L23_continue:;
   }
 
-  /* "druhg/_druhg_tree.pyx":552
- *                 # print('RESULT', rel.reciprocity, i)
- *         # return
- *         if warn > 0:             # <<<<<<<<<<<<<<
- *             print ('A lot of values(',warn,') are the same. Try increasing max_neighbors_search(',self.max_neighbors_search,') parameter.')
+  /* "druhg/_druhg_tree.pyx":410
+ *                                (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
  * 
+ *         if self.result_edges >= self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print ('Two subjects only')
+ *             return
  */
-  __pyx_t_1 = ((__pyx_v_warn > 0) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_2 = ((__pyx_cur_scope->__pyx_v_self->result_edges >= (__pyx_cur_scope->__pyx_v_self->num_points - 1)) != 0);
+  if (__pyx_t_2) {
+
+    /* "druhg/_druhg_tree.pyx":411
+ * 
+ *         if self.result_edges >= self.num_points - 1:
+ *             print ('Two subjects only')             # <<<<<<<<<<<<<<
+ *             return
+ *         if warn > 0:
+ */
+    __pyx_t_14 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 411, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
 
-    /* "druhg/_druhg_tree.pyx":553
- *         # return
+    /* "druhg/_druhg_tree.pyx":412
+ *         if self.result_edges >= self.num_points - 1:
+ *             print ('Two subjects only')
+ *             return             # <<<<<<<<<<<<<<
  *         if warn > 0:
- *             print ('A lot of values(',warn,') are the same. Try increasing max_neighbors_search(',self.max_neighbors_search,') parameter.')             # <<<<<<<<<<<<<<
+ *             print (
+ */
+    __Pyx_XDECREF(__pyx_r);
+    __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+    goto __pyx_L0;
+
+    /* "druhg/_druhg_tree.pyx":410
+ *                                (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
  * 
- *         if infinitesimal > 0:
+ *         if self.result_edges >= self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print ('Two subjects only')
+ *             return
  */
-    __pyx_t_13 = PyInt_FromSsize_t(__pyx_v_warn); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 553, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
-    __pyx_t_9 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 553, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_23 = PyTuple_New(5); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 553, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_23);
+  }
+
+  /* "druhg/_druhg_tree.pyx":413
+ *             print ('Two subjects only')
+ *             return
+ *         if warn > 0:             # <<<<<<<<<<<<<<
+ *             print (
+ *             'A lot of values(', warn, ') are the same. Try increasing max_neighbors_search(', self.max_neighbors_search,
+ */
+  __pyx_t_2 = ((__pyx_v_warn > 0) != 0);
+  if (__pyx_t_2) {
+
+    /* "druhg/_druhg_tree.pyx":415
+ *         if warn > 0:
+ *             print (
+ *             'A lot of values(', warn, ') are the same. Try increasing max_neighbors_search(', self.max_neighbors_search,             # <<<<<<<<<<<<<<
+ *             ') parameter.')
+ * 
+ */
+    __pyx_t_14 = PyInt_FromSsize_t(__pyx_v_warn); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 415, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __pyx_t_10 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 415, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+
+    /* "druhg/_druhg_tree.pyx":414
+ *             return
+ *         if warn > 0:
+ *             print (             # <<<<<<<<<<<<<<
+ *             'A lot of values(', warn, ') are the same. Try increasing max_neighbors_search(', self.max_neighbors_search,
+ *             ') parameter.')
+ */
+    __pyx_t_24 = PyTuple_New(5); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 414, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_24);
     __Pyx_INCREF(__pyx_kp_u_A_lot_of_values);
     __Pyx_GIVEREF(__pyx_kp_u_A_lot_of_values);
-    PyTuple_SET_ITEM(__pyx_t_23, 0, __pyx_kp_u_A_lot_of_values);
-    __Pyx_GIVEREF(__pyx_t_13);
-    PyTuple_SET_ITEM(__pyx_t_23, 1, __pyx_t_13);
+    PyTuple_SET_ITEM(__pyx_t_24, 0, __pyx_kp_u_A_lot_of_values);
+    __Pyx_GIVEREF(__pyx_t_14);
+    PyTuple_SET_ITEM(__pyx_t_24, 1, __pyx_t_14);
     __Pyx_INCREF(__pyx_kp_u_are_the_same_Try_increasing_max);
     __Pyx_GIVEREF(__pyx_kp_u_are_the_same_Try_increasing_max);
-    PyTuple_SET_ITEM(__pyx_t_23, 2, __pyx_kp_u_are_the_same_Try_increasing_max);
-    __Pyx_GIVEREF(__pyx_t_9);
-    PyTuple_SET_ITEM(__pyx_t_23, 3, __pyx_t_9);
+    PyTuple_SET_ITEM(__pyx_t_24, 2, __pyx_kp_u_are_the_same_Try_increasing_max);
+    __Pyx_GIVEREF(__pyx_t_10);
+    PyTuple_SET_ITEM(__pyx_t_24, 3, __pyx_t_10);
     __Pyx_INCREF(__pyx_kp_u_parameter);
     __Pyx_GIVEREF(__pyx_kp_u_parameter);
-    PyTuple_SET_ITEM(__pyx_t_23, 4, __pyx_kp_u_parameter);
-    __pyx_t_13 = 0;
-    __pyx_t_9 = 0;
-    __pyx_t_9 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_23, NULL); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 553, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    PyTuple_SET_ITEM(__pyx_t_24, 4, __pyx_kp_u_parameter);
+    __pyx_t_14 = 0;
+    __pyx_t_10 = 0;
+    __pyx_t_10 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_24, NULL); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 414, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-    /* "druhg/_druhg_tree.pyx":552
- *                 # print('RESULT', rel.reciprocity, i)
- *         # return
+    /* "druhg/_druhg_tree.pyx":413
+ *             print ('Two subjects only')
+ *             return
  *         if warn > 0:             # <<<<<<<<<<<<<<
- *             print ('A lot of values(',warn,') are the same. Try increasing max_neighbors_search(',self.max_neighbors_search,') parameter.')
- * 
+ *             print (
+ *             'A lot of values(', warn, ') are the same. Try increasing max_neighbors_search(', self.max_neighbors_search,
  */
   }
 
-  /* "druhg/_druhg_tree.pyx":555
- *             print ('A lot of values(',warn,') are the same. Try increasing max_neighbors_search(',self.max_neighbors_search,') parameter.')
+  /* "druhg/_druhg_tree.pyx":418
+ *             ') parameter.')
  * 
  *         if infinitesimal > 0:             # <<<<<<<<<<<<<<
- *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,') level. Try decreasing double_precision parameter.')
- * 
+ *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,
+ *                    ') level. Try decreasing double_precision parameter.')
  */
-  __pyx_t_1 = ((__pyx_v_infinitesimal > 0) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_2 = ((__pyx_v_infinitesimal > 0) != 0);
+  if (__pyx_t_2) {
 
-    /* "druhg/_druhg_tree.pyx":556
+    /* "druhg/_druhg_tree.pyx":419
  * 
  *         if infinitesimal > 0:
- *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,') level. Try decreasing double_precision parameter.')             # <<<<<<<<<<<<<<
+ *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,             # <<<<<<<<<<<<<<
+ *                    ') level. Try decreasing double_precision parameter.')
  * 
- *         if self.result_edges >= self.num_points - 1:
  */
-    __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_infinitesimal); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 556, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_23 = PyFloat_FromDouble(__pyx_cur_scope->__pyx_v_self->PRECISION); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 556, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_23);
-    __pyx_t_13 = PyTuple_New(5); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 556, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
+    __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_infinitesimal); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 419, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __pyx_t_24 = PyFloat_FromDouble(__pyx_cur_scope->__pyx_v_self->PRECISION); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 419, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_24);
+    __pyx_t_14 = PyTuple_New(5); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 419, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
     __Pyx_INCREF(__pyx_kp_u_Some_distances);
     __Pyx_GIVEREF(__pyx_kp_u_Some_distances);
-    PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_kp_u_Some_distances);
-    __Pyx_GIVEREF(__pyx_t_9);
-    PyTuple_SET_ITEM(__pyx_t_13, 1, __pyx_t_9);
+    PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_kp_u_Some_distances);
+    __Pyx_GIVEREF(__pyx_t_10);
+    PyTuple_SET_ITEM(__pyx_t_14, 1, __pyx_t_10);
     __Pyx_INCREF(__pyx_kp_u_are_smaller_than_self_PRECISION);
     __Pyx_GIVEREF(__pyx_kp_u_are_smaller_than_self_PRECISION);
-    PyTuple_SET_ITEM(__pyx_t_13, 2, __pyx_kp_u_are_smaller_than_self_PRECISION);
-    __Pyx_GIVEREF(__pyx_t_23);
-    PyTuple_SET_ITEM(__pyx_t_13, 3, __pyx_t_23);
+    PyTuple_SET_ITEM(__pyx_t_14, 2, __pyx_kp_u_are_smaller_than_self_PRECISION);
+    __Pyx_GIVEREF(__pyx_t_24);
+    PyTuple_SET_ITEM(__pyx_t_14, 3, __pyx_t_24);
     __Pyx_INCREF(__pyx_kp_u_level_Try_decreasing_double_pre);
     __Pyx_GIVEREF(__pyx_kp_u_level_Try_decreasing_double_pre);
-    PyTuple_SET_ITEM(__pyx_t_13, 4, __pyx_kp_u_level_Try_decreasing_double_pre);
-    __pyx_t_9 = 0;
-    __pyx_t_23 = 0;
-    __pyx_t_23 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_13, NULL); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 556, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_23);
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
+    PyTuple_SET_ITEM(__pyx_t_14, 4, __pyx_kp_u_level_Try_decreasing_double_pre);
+    __pyx_t_10 = 0;
+    __pyx_t_24 = 0;
+    __pyx_t_24 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_14, NULL); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 419, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_24);
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+    __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
 
-    /* "druhg/_druhg_tree.pyx":555
- *             print ('A lot of values(',warn,') are the same. Try increasing max_neighbors_search(',self.max_neighbors_search,') parameter.')
+    /* "druhg/_druhg_tree.pyx":418
+ *             ') parameter.')
  * 
  *         if infinitesimal > 0:             # <<<<<<<<<<<<<<
- *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,') level. Try decreasing double_precision parameter.')
- * 
+ *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,
+ *                    ') level. Try decreasing double_precision parameter.')
  */
   }
 
-  /* "druhg/_druhg_tree.pyx":558
- *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,') level. Try decreasing double_precision parameter.')
- * 
- *         if self.result_edges >= self.num_points - 1:             # <<<<<<<<<<<<<<
- *             print ('Two subjects only')
- *             return
- */
-  __pyx_t_1 = ((__pyx_cur_scope->__pyx_v_self->result_edges >= (__pyx_cur_scope->__pyx_v_self->num_points - 1)) != 0);
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_tree.pyx":559
- * 
- *         if self.result_edges >= self.num_points - 1:
- *             print ('Two subjects only')             # <<<<<<<<<<<<<<
- *             return
- * 
- */
-    __pyx_t_23 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 559, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_23);
-    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-
-    /* "druhg/_druhg_tree.pyx":560
- *         if self.result_edges >= self.num_points - 1:
- *             print ('Two subjects only')
- *             return             # <<<<<<<<<<<<<<
+  /* "druhg/_druhg_tree.pyx":422
+ *                    ') level. Try decreasing double_precision parameter.')
  * 
- *         heapq.heappush(heap, (INF, -1,-1,0.))
+ *         edge_cases = 0             # <<<<<<<<<<<<<<
+ * ############
+ *         while self.result_edges < self.num_points - 1 and heap:
  */
-    __Pyx_XDECREF(__pyx_r);
-    __pyx_r = Py_None; __Pyx_INCREF(Py_None);
-    goto __pyx_L0;
+  __Pyx_INCREF(__pyx_int_0);
+  __pyx_v_edge_cases = __pyx_int_0;
 
-    /* "druhg/_druhg_tree.pyx":558
- *             print ('Some distances(', infinitesimal, ') are smaller than self.PRECISION (', self.PRECISION,') level. Try decreasing double_precision parameter.')
+  /* "druhg/_druhg_tree.pyx":424
+ *         edge_cases = 0
+ * ############
+ *         while self.result_edges < self.num_points - 1 and heap:             # <<<<<<<<<<<<<<
+ *             rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first = heapq.heappop(heap)
  * 
- *         if self.result_edges >= self.num_points - 1:             # <<<<<<<<<<<<<<
- *             print ('Two subjects only')
- *             return
  */
-  }
-
-  /* "druhg/_druhg_tree.pyx":562
- *             return
- * 
- *         heapq.heappush(heap, (INF, -1,-1,0.))             # <<<<<<<<<<<<<<
- *         if is_slow:
- *             while self.result_edges < self.num_points - 1:
- */
-  __Pyx_GetModuleGlobalName(__pyx_t_13, __pyx_n_s_heapq); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 562, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_13);
-  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_13, __pyx_n_s_heappush); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 562, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-  __pyx_t_13 = PyFloat_FromDouble(__pyx_v_5druhg_11_druhg_tree_INF); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 562, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_13);
-  __pyx_t_8 = PyTuple_New(4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 562, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_8);
-  __Pyx_GIVEREF(__pyx_t_13);
-  PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_13);
-  __Pyx_INCREF(__pyx_int_neg_1);
-  __Pyx_GIVEREF(__pyx_int_neg_1);
-  PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_int_neg_1);
-  __Pyx_INCREF(__pyx_int_neg_1);
-  __Pyx_GIVEREF(__pyx_int_neg_1);
-  PyTuple_SET_ITEM(__pyx_t_8, 2, __pyx_int_neg_1);
-  __Pyx_INCREF(__pyx_float_0_);
-  __Pyx_GIVEREF(__pyx_float_0_);
-  PyTuple_SET_ITEM(__pyx_t_8, 3, __pyx_float_0_);
-  __pyx_t_13 = 0;
-  __pyx_t_13 = NULL;
-  __pyx_t_11 = 0;
-  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
-    __pyx_t_13 = PyMethod_GET_SELF(__pyx_t_9);
-    if (likely(__pyx_t_13)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-      __Pyx_INCREF(__pyx_t_13);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_9, function);
-      __pyx_t_11 = 1;
+  while (1) {
+    __pyx_t_5 = ((__pyx_cur_scope->__pyx_v_self->result_edges < (__pyx_cur_scope->__pyx_v_self->num_points - 1)) != 0);
+    if (__pyx_t_5) {
+    } else {
+      __pyx_t_2 = __pyx_t_5;
+      goto __pyx_L34_bool_binop_done;
     }
-  }
-  {
-    PyObject *__pyx_callargs[3] = {__pyx_t_13, __pyx_v_heap, __pyx_t_8};
-    __pyx_t_23 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-    __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
-    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-    if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 562, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_23);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-  }
-  __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-
-  /* "druhg/_druhg_tree.pyx":563
- * 
- *         heapq.heappush(heap, (INF, -1,-1,0.))
- *         if is_slow:             # <<<<<<<<<<<<<<
- *             while self.result_edges < self.num_points - 1:
- *                 best, i, j, v = heapq.heappop(heap)
- */
-  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_is_slow); if (unlikely((__pyx_t_1 < 0))) __PYX_ERR(0, 563, __pyx_L1_error)
-  if (__pyx_t_1) {
-
-    /* "druhg/_druhg_tree.pyx":564
- *         heapq.heappush(heap, (INF, -1,-1,0.))
- *         if is_slow:
- *             while self.result_edges < self.num_points - 1:             # <<<<<<<<<<<<<<
- *                 best, i, j, v = heapq.heappop(heap)
- * 
- */
-    while (1) {
-      __pyx_t_1 = ((__pyx_cur_scope->__pyx_v_self->result_edges < (__pyx_cur_scope->__pyx_v_self->num_points - 1)) != 0);
-      if (!__pyx_t_1) break;
-
-      /* "druhg/_druhg_tree.pyx":565
- *         if is_slow:
- *             while self.result_edges < self.num_points - 1:
- *                 best, i, j, v = heapq.heappop(heap)             # <<<<<<<<<<<<<<
- * 
- *                 if best == INF:
- */
-      __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_heapq); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 565, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_heappop); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 565, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __pyx_t_9 = NULL;
-      __pyx_t_11 = 0;
-      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_8))) {
-        __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_8);
-        if (likely(__pyx_t_9)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
-          __Pyx_INCREF(__pyx_t_9);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_8, function);
-          __pyx_t_11 = 1;
-        }
+    __pyx_t_5 = (PyList_GET_SIZE(__pyx_v_heap) != 0);
+    __pyx_t_2 = __pyx_t_5;
+    __pyx_L34_bool_binop_done:;
+    if (!__pyx_t_2) break;
+
+    /* "druhg/_druhg_tree.pyx":425
+ * ############
+ *         while self.result_edges < self.num_points - 1 and heap:
+ *             rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first = heapq.heappop(heap)             # <<<<<<<<<<<<<<
+ * 
+ *             p, op = self.U.mark_up(i), self.U.mark_up(rel.endpoint)
+ */
+    __Pyx_GetModuleGlobalName(__pyx_t_14, __pyx_n_s_heapq); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_heappop); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+    __pyx_t_14 = NULL;
+    __pyx_t_12 = 0;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_10))) {
+      __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_10);
+      if (likely(__pyx_t_14)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
+        __Pyx_INCREF(__pyx_t_14);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_10, function);
+        __pyx_t_12 = 1;
       }
-      {
-        PyObject *__pyx_callargs[2] = {__pyx_t_9, __pyx_v_heap};
-        __pyx_t_23 = __Pyx_PyObject_FastCall(__pyx_t_8, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-        __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-        if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 565, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      }
-      if ((likely(PyTuple_CheckExact(__pyx_t_23))) || (PyList_CheckExact(__pyx_t_23))) {
-        PyObject* sequence = __pyx_t_23;
-        Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
-        if (unlikely(size != 4)) {
-          if (size > 4) __Pyx_RaiseTooManyValuesError(4);
-          else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-          __PYX_ERR(0, 565, __pyx_L1_error)
-        }
-        #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        if (likely(PyTuple_CheckExact(sequence))) {
-          __pyx_t_8 = PyTuple_GET_ITEM(sequence, 0); 
-          __pyx_t_9 = PyTuple_GET_ITEM(sequence, 1); 
-          __pyx_t_13 = PyTuple_GET_ITEM(sequence, 2); 
-          __pyx_t_2 = PyTuple_GET_ITEM(sequence, 3); 
-        } else {
-          __pyx_t_8 = PyList_GET_ITEM(sequence, 0); 
-          __pyx_t_9 = PyList_GET_ITEM(sequence, 1); 
-          __pyx_t_13 = PyList_GET_ITEM(sequence, 2); 
-          __pyx_t_2 = PyList_GET_ITEM(sequence, 3); 
-        }
-        __Pyx_INCREF(__pyx_t_8);
-        __Pyx_INCREF(__pyx_t_9);
-        __Pyx_INCREF(__pyx_t_13);
-        __Pyx_INCREF(__pyx_t_2);
-        #else
-        {
-          Py_ssize_t i;
-          PyObject** temps[4] = {&__pyx_t_8,&__pyx_t_9,&__pyx_t_13,&__pyx_t_2};
-          for (i=0; i < 4; i++) {
-            PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 565, __pyx_L1_error)
-            __Pyx_GOTREF(item);
-            *(temps[i]) = item;
-          }
-        }
-        #endif
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
+    }
+    {
+      PyObject *__pyx_callargs[2] = {__pyx_t_14, __pyx_v_heap};
+      __pyx_t_24 = __Pyx_PyObject_FastCall(__pyx_t_10, __pyx_callargs+1-__pyx_t_12, 1+__pyx_t_12);
+      __Pyx_XDECREF(__pyx_t_14); __pyx_t_14 = 0;
+      if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 425, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_24);
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    }
+    if ((likely(PyTuple_CheckExact(__pyx_t_24))) || (PyList_CheckExact(__pyx_t_24))) {
+      PyObject* sequence = __pyx_t_24;
+      Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
+      if (unlikely(size != 5)) {
+        if (size > 5) __Pyx_RaiseTooManyValuesError(5);
+        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
+        __PYX_ERR(0, 425, __pyx_L1_error)
+      }
+      #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
+      if (likely(PyTuple_CheckExact(sequence))) {
+        __pyx_t_10 = PyTuple_GET_ITEM(sequence, 0); 
+        __pyx_t_14 = PyTuple_GET_ITEM(sequence, 1); 
+        __pyx_t_23 = PyTuple_GET_ITEM(sequence, 2); 
+        __pyx_t_9 = PyTuple_GET_ITEM(sequence, 3); 
+        __pyx_t_3 = PyTuple_GET_ITEM(sequence, 4); 
       } else {
-        Py_ssize_t index = -1;
-        PyObject** temps[4] = {&__pyx_t_8,&__pyx_t_9,&__pyx_t_13,&__pyx_t_2};
-        __pyx_t_3 = PyObject_GetIter(__pyx_t_23); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 565, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_21 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_3);
-        for (index=0; index < 4; index++) {
-          PyObject* item = __pyx_t_21(__pyx_t_3); if (unlikely(!item)) goto __pyx_L39_unpacking_failed;
+        __pyx_t_10 = PyList_GET_ITEM(sequence, 0); 
+        __pyx_t_14 = PyList_GET_ITEM(sequence, 1); 
+        __pyx_t_23 = PyList_GET_ITEM(sequence, 2); 
+        __pyx_t_9 = PyList_GET_ITEM(sequence, 3); 
+        __pyx_t_3 = PyList_GET_ITEM(sequence, 4); 
+      }
+      __Pyx_INCREF(__pyx_t_10);
+      __Pyx_INCREF(__pyx_t_14);
+      __Pyx_INCREF(__pyx_t_23);
+      __Pyx_INCREF(__pyx_t_9);
+      __Pyx_INCREF(__pyx_t_3);
+      #else
+      {
+        Py_ssize_t i;
+        PyObject** temps[5] = {&__pyx_t_10,&__pyx_t_14,&__pyx_t_23,&__pyx_t_9,&__pyx_t_3};
+        for (i=0; i < 5; i++) {
+          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 425, __pyx_L1_error)
           __Pyx_GOTREF(item);
-          *(temps[index]) = item;
+          *(temps[i]) = item;
         }
-        if (__Pyx_IternextUnpackEndCheck(__pyx_t_21(__pyx_t_3), 4) < 0) __PYX_ERR(0, 565, __pyx_L1_error)
-        __pyx_t_21 = NULL;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        goto __pyx_L40_unpacking_done;
-        __pyx_L39_unpacking_failed:;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_21 = NULL;
-        if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-        __PYX_ERR(0, 565, __pyx_L1_error)
-        __pyx_L40_unpacking_done:;
       }
-      __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 565, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __pyx_t_5 = __Pyx_PyIndex_AsSsize_t(__pyx_t_13); if (unlikely((__pyx_t_5 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 565, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-      __pyx_t_24 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_24 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 565, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_XDECREF_SET(__pyx_v_best, __pyx_t_8);
-      __pyx_t_8 = 0;
-      __pyx_v_i = __pyx_t_6;
-      __pyx_v_j = __pyx_t_5;
-      __pyx_v_v = __pyx_t_24;
-
-      /* "druhg/_druhg_tree.pyx":567
- *                 best, i, j, v = heapq.heappop(heap)
- * 
- *                 if best == INF:             # <<<<<<<<<<<<<<
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')
- *                     break
- */
-      __pyx_t_23 = PyFloat_FromDouble(__pyx_v_5druhg_11_druhg_tree_INF); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 567, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_23);
-      __pyx_t_2 = PyObject_RichCompare(__pyx_v_best, __pyx_t_23, Py_EQ); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 567, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely((__pyx_t_1 < 0))) __PYX_ERR(0, 567, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      if (__pyx_t_1) {
+      #endif
+      __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
+    } else {
+      Py_ssize_t index = -1;
+      PyObject** temps[5] = {&__pyx_t_10,&__pyx_t_14,&__pyx_t_23,&__pyx_t_9,&__pyx_t_3};
+      __pyx_t_4 = PyObject_GetIter(__pyx_t_24); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 425, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
+      __pyx_t_22 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_4);
+      for (index=0; index < 5; index++) {
+        PyObject* item = __pyx_t_22(__pyx_t_4); if (unlikely(!item)) goto __pyx_L36_unpacking_failed;
+        __Pyx_GOTREF(item);
+        *(temps[index]) = item;
+      }
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_22(__pyx_t_4), 5) < 0) __PYX_ERR(0, 425, __pyx_L1_error)
+      __pyx_t_22 = NULL;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      goto __pyx_L37_unpacking_done;
+      __pyx_L36_unpacking_failed:;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_22 = NULL;
+      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
+      __PYX_ERR(0, 425, __pyx_L1_error)
+      __pyx_L37_unpacking_done:;
+    }
+    __pyx_t_25 = __pyx_PyFloat_AsDouble(__pyx_t_10); if (unlikely((__pyx_t_25 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __pyx_t_7 = __Pyx_PyIndex_AsSsize_t(__pyx_t_14); if (unlikely((__pyx_t_7 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_23); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
+    __pyx_t_8 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_8 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __pyx_t_26 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_26 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 425, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __pyx_v_rel.reciprocity = __pyx_t_25;
+    __pyx_v_i = __pyx_t_7;
+    __pyx_v_rel.endpoint = __pyx_t_6;
+    __pyx_v_rel.max_rank = __pyx_t_8;
+    __pyx_v_rel.skip_first = __pyx_t_26;
 
-        /* "druhg/_druhg_tree.pyx":568
- * 
- *                 if best == INF:
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')             # <<<<<<<<<<<<<<
- *                     break
+    /* "druhg/_druhg_tree.pyx":427
+ *             rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first = heapq.heappop(heap)
  * 
+ *             p, op = self.U.mark_up(i), self.U.mark_up(rel.endpoint)             # <<<<<<<<<<<<<<
+ *             if p != op:
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)
  */
-        __pyx_t_2 = PyInt_FromSsize_t(((__pyx_cur_scope->__pyx_v_self->num_points - 1) - __pyx_cur_scope->__pyx_v_self->result_edges)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_23 = __Pyx_PyObject_Str(__pyx_t_2); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __pyx_t_2 = PyNumber_Add(__pyx_t_23, __pyx_kp_u_not_connected_edges_It_is_a_for); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_23 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __pyx_t_13 = __Pyx_PyObject_Str(__pyx_t_23); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_23 = PyNumber_Add(__pyx_t_2, __pyx_t_13); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __pyx_t_13 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_23, __pyx_kp_u_for_a_better_result); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_23 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_13); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 568, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
+    __pyx_t_26 = ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i);
+    __pyx_t_8 = ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->mark_up(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_rel.endpoint);
+    __pyx_v_p = __pyx_t_26;
+    __pyx_v_op = __pyx_t_8;
 
-        /* "druhg/_druhg_tree.pyx":569
- *                 if best == INF:
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')
- *                     break             # <<<<<<<<<<<<<<
+    /* "druhg/_druhg_tree.pyx":428
  * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):
+ *             p, op = self.U.mark_up(i), self.U.mark_up(rel.endpoint)
+ *             if p != op:             # <<<<<<<<<<<<<<
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)
+ *                 self.U.union(i, rel.endpoint, p, op)
  */
-        goto __pyx_L38_break;
+    __pyx_t_2 = ((__pyx_v_p != __pyx_v_op) != 0);
+    if (__pyx_t_2) {
 
-        /* "druhg/_druhg_tree.pyx":567
- *                 best, i, j, v = heapq.heappop(heap)
- * 
- *                 if best == INF:             # <<<<<<<<<<<<<<
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')
- *                     break
+      /* "druhg/_druhg_tree.pyx":429
+ *             p, op = self.U.mark_up(i), self.U.mark_up(rel.endpoint)
+ *             if p != op:
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)             # <<<<<<<<<<<<<<
+ *                 self.U.union(i, rel.endpoint, p, op)
+ *                 if rel.max_rank == self.max_neighbors_search:
  */
-      }
+      ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->result_write(__pyx_cur_scope->__pyx_v_self, __pyx_v_rel.reciprocity, __pyx_v_i, __pyx_v_rel.endpoint, __pyx_v_rel.max_rank);
 
-      /* "druhg/_druhg_tree.pyx":571
- *                     break
- * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):             # <<<<<<<<<<<<<<
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
+      /* "druhg/_druhg_tree.pyx":430
+ *             if p != op:
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)
+ *                 self.U.union(i, rel.endpoint, p, op)             # <<<<<<<<<<<<<<
+ *                 if rel.max_rank == self.max_neighbors_search:
+ *                     edge_cases+=1
  */
-      __pyx_t_1 = ((((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i) != ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_j)) != 0);
-      if (__pyx_t_1) {
+      ((struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->__pyx_union(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i, __pyx_v_rel.endpoint, __pyx_v_p, __pyx_v_op);
 
-        /* "druhg/_druhg_tree.pyx":572
+      /* "druhg/_druhg_tree.pyx":431
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)
+ *                 self.U.union(i, rel.endpoint, p, op)
+ *                 if rel.max_rank == self.max_neighbors_search:             # <<<<<<<<<<<<<<
+ *                     edge_cases+=1
  * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):
- *                     self.U.union(i, j)             # <<<<<<<<<<<<<<
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel):
  */
-        ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->__pyx_union(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i, __pyx_v_j);
+      __pyx_t_2 = ((__pyx_v_rel.max_rank == __pyx_cur_scope->__pyx_v_self->max_neighbors_search) != 0);
+      if (__pyx_t_2) {
 
-        /* "druhg/_druhg_tree.pyx":573
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)             # <<<<<<<<<<<<<<
- *                 if self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel):
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- */
-        ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->result_add_edge(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, __pyx_v_j, __pyx_v_v);
-
-        /* "druhg/_druhg_tree.pyx":571
- *                     break
+        /* "druhg/_druhg_tree.pyx":432
+ *                 self.U.union(i, rel.endpoint, p, op)
+ *                 if rel.max_rank == self.max_neighbors_search:
+ *                     edge_cases+=1             # <<<<<<<<<<<<<<
  * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):             # <<<<<<<<<<<<<<
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):
  */
-      }
+        __pyx_t_24 = __Pyx_PyInt_AddObjC(__pyx_v_edge_cases, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 432, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_24);
+        __Pyx_DECREF_SET(__pyx_v_edge_cases, __pyx_t_24);
+        __pyx_t_24 = 0;
 
-      /* "druhg/_druhg_tree.pyx":574
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- *         else:
- */
-      __pyx_t_1 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_evaluate_reciprocity_slow(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel)) != 0);
-      if (__pyx_t_1) {
-
-        /* "druhg/_druhg_tree.pyx":575
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel):
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in             # <<<<<<<<<<<<<<
- *         else:
- *             while self.result_edges < self.num_points - 1:
- */
-        __Pyx_GetModuleGlobalName(__pyx_t_13, __pyx_n_s_heapq); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_13, __pyx_n_s_heappush); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __pyx_t_13 = PyFloat_FromDouble(__pyx_v_rel.reciprocity); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __pyx_t_9 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_8 = PyInt_FromSsize_t(__pyx_v_rel.target); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __pyx_t_3 = PyFloat_FromDouble(__pyx_v_rel.dia_dis); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_10 = PyTuple_New(4); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 575, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_GIVEREF(__pyx_t_13);
-        PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_13);
-        __Pyx_GIVEREF(__pyx_t_9);
-        PyTuple_SET_ITEM(__pyx_t_10, 1, __pyx_t_9);
-        __Pyx_GIVEREF(__pyx_t_8);
-        PyTuple_SET_ITEM(__pyx_t_10, 2, __pyx_t_8);
-        __Pyx_GIVEREF(__pyx_t_3);
-        PyTuple_SET_ITEM(__pyx_t_10, 3, __pyx_t_3);
-        __pyx_t_13 = 0;
-        __pyx_t_9 = 0;
-        __pyx_t_8 = 0;
-        __pyx_t_3 = 0;
-        __pyx_t_3 = NULL;
-        __pyx_t_11 = 0;
-        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
-          __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
-          if (likely(__pyx_t_3)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-            __Pyx_INCREF(__pyx_t_3);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_2, function);
-            __pyx_t_11 = 1;
-          }
-        }
-        {
-          PyObject *__pyx_callargs[3] = {__pyx_t_3, __pyx_v_heap, __pyx_t_10};
-          __pyx_t_23 = __Pyx_PyObject_FastCall(__pyx_t_2, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-          __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-          if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 575, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_23);
-          __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-
-        /* "druhg/_druhg_tree.pyx":574
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_slow(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- *         else:
+        /* "druhg/_druhg_tree.pyx":431
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)
+ *                 self.U.union(i, rel.endpoint, p, op)
+ *                 if rel.max_rank == self.max_neighbors_search:             # <<<<<<<<<<<<<<
+ *                     edge_cases+=1
+ * 
  */
       }
-    }
-    __pyx_L38_break:;
 
-    /* "druhg/_druhg_tree.pyx":563
+      /* "druhg/_druhg_tree.pyx":428
  * 
- *         heapq.heappush(heap, (INF, -1,-1,0.))
- *         if is_slow:             # <<<<<<<<<<<<<<
- *             while self.result_edges < self.num_points - 1:
- *                 best, i, j, v = heapq.heappop(heap)
+ *             p, op = self.U.mark_up(i), self.U.mark_up(rel.endpoint)
+ *             if p != op:             # <<<<<<<<<<<<<<
+ *                 self.result_write(rel.reciprocity, i, rel.endpoint, rel.max_rank)
+ *                 self.U.union(i, rel.endpoint, p, op)
  */
-    goto __pyx_L36;
-  }
+    }
 
-  /* "druhg/_druhg_tree.pyx":577
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- *         else:
- *             while self.result_edges < self.num_points - 1:             # <<<<<<<<<<<<<<
- *                 best, i, j, v = heapq.heappop(heap)
+    /* "druhg/_druhg_tree.pyx":434
+ *                     edge_cases+=1
  * 
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
+ *                 heapq.heappush(heap, (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
+ * ###############
  */
-  /*else*/ {
-    while (1) {
-      __pyx_t_1 = ((__pyx_cur_scope->__pyx_v_self->result_edges < (__pyx_cur_scope->__pyx_v_self->num_points - 1)) != 0);
-      if (!__pyx_t_1) break;
+    __pyx_t_2 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_evaluate_reciprocity(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel)) != 0);
+    if (__pyx_t_2) {
 
-      /* "druhg/_druhg_tree.pyx":578
- *         else:
- *             while self.result_edges < self.num_points - 1:
- *                 best, i, j, v = heapq.heappop(heap)             # <<<<<<<<<<<<<<
+      /* "druhg/_druhg_tree.pyx":435
  * 
- *                 if best == INF:
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):
+ *                 heapq.heappush(heap, (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))             # <<<<<<<<<<<<<<
+ * ###############
+ *         if self.result_edges != self.num_points - 1:
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_heapq); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 578, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_heappop); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 578, __pyx_L1_error)
+      __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_heapq); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_heappush); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_9);
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_rel.reciprocity); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __pyx_t_23 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_23);
+      __pyx_t_14 = PyInt_FromSsize_t(__pyx_v_rel.endpoint); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_14);
+      __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_rel.max_rank); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 435, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __pyx_t_2 = NULL;
-      __pyx_t_11 = 0;
-      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_10))) {
-        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_10);
-        if (likely(__pyx_t_2)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
-          __Pyx_INCREF(__pyx_t_2);
+      __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_rel.skip_first); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_11 = PyTuple_New(5); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 435, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_11);
+      __Pyx_GIVEREF(__pyx_t_3);
+      PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_3);
+      __Pyx_GIVEREF(__pyx_t_23);
+      PyTuple_SET_ITEM(__pyx_t_11, 1, __pyx_t_23);
+      __Pyx_GIVEREF(__pyx_t_14);
+      PyTuple_SET_ITEM(__pyx_t_11, 2, __pyx_t_14);
+      __Pyx_GIVEREF(__pyx_t_10);
+      PyTuple_SET_ITEM(__pyx_t_11, 3, __pyx_t_10);
+      __Pyx_GIVEREF(__pyx_t_4);
+      PyTuple_SET_ITEM(__pyx_t_11, 4, __pyx_t_4);
+      __pyx_t_3 = 0;
+      __pyx_t_23 = 0;
+      __pyx_t_14 = 0;
+      __pyx_t_10 = 0;
+      __pyx_t_4 = 0;
+      __pyx_t_4 = NULL;
+      __pyx_t_12 = 0;
+      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
+        __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_9);
+        if (likely(__pyx_t_4)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
+          __Pyx_INCREF(__pyx_t_4);
           __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_10, function);
-          __pyx_t_11 = 1;
+          __Pyx_DECREF_SET(__pyx_t_9, function);
+          __pyx_t_12 = 1;
         }
       }
       {
-        PyObject *__pyx_callargs[2] = {__pyx_t_2, __pyx_v_heap};
-        __pyx_t_23 = __Pyx_PyObject_FastCall(__pyx_t_10, __pyx_callargs+1-__pyx_t_11, 1+__pyx_t_11);
-        __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-        if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 578, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      }
-      if ((likely(PyTuple_CheckExact(__pyx_t_23))) || (PyList_CheckExact(__pyx_t_23))) {
-        PyObject* sequence = __pyx_t_23;
-        Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
-        if (unlikely(size != 4)) {
-          if (size > 4) __Pyx_RaiseTooManyValuesError(4);
-          else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-          __PYX_ERR(0, 578, __pyx_L1_error)
-        }
-        #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        if (likely(PyTuple_CheckExact(sequence))) {
-          __pyx_t_10 = PyTuple_GET_ITEM(sequence, 0); 
-          __pyx_t_2 = PyTuple_GET_ITEM(sequence, 1); 
-          __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
-          __pyx_t_8 = PyTuple_GET_ITEM(sequence, 3); 
-        } else {
-          __pyx_t_10 = PyList_GET_ITEM(sequence, 0); 
-          __pyx_t_2 = PyList_GET_ITEM(sequence, 1); 
-          __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
-          __pyx_t_8 = PyList_GET_ITEM(sequence, 3); 
-        }
-        __Pyx_INCREF(__pyx_t_10);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(__pyx_t_3);
-        __Pyx_INCREF(__pyx_t_8);
-        #else
-        {
-          Py_ssize_t i;
-          PyObject** temps[4] = {&__pyx_t_10,&__pyx_t_2,&__pyx_t_3,&__pyx_t_8};
-          for (i=0; i < 4; i++) {
-            PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 578, __pyx_L1_error)
-            __Pyx_GOTREF(item);
-            *(temps[i]) = item;
-          }
-        }
-        #endif
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-      } else {
-        Py_ssize_t index = -1;
-        PyObject** temps[4] = {&__pyx_t_10,&__pyx_t_2,&__pyx_t_3,&__pyx_t_8};
-        __pyx_t_9 = PyObject_GetIter(__pyx_t_23); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 578, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_21 = __Pyx_PyObject_GetIterNextFunc(__pyx_t_9);
-        for (index=0; index < 4; index++) {
-          PyObject* item = __pyx_t_21(__pyx_t_9); if (unlikely(!item)) goto __pyx_L46_unpacking_failed;
-          __Pyx_GOTREF(item);
-          *(temps[index]) = item;
-        }
-        if (__Pyx_IternextUnpackEndCheck(__pyx_t_21(__pyx_t_9), 4) < 0) __PYX_ERR(0, 578, __pyx_L1_error)
-        __pyx_t_21 = NULL;
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        goto __pyx_L47_unpacking_done;
-        __pyx_L46_unpacking_failed:;
+        PyObject *__pyx_callargs[3] = {__pyx_t_4, __pyx_v_heap, __pyx_t_11};
+        __pyx_t_24 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_12, 2+__pyx_t_12);
+        __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+        if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 435, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_24);
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_t_21 = NULL;
-        if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-        __PYX_ERR(0, 578, __pyx_L1_error)
-        __pyx_L47_unpacking_done:;
       }
-      __pyx_t_5 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_5 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 578, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_6 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(0, 578, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_24 = __pyx_PyFloat_AsDouble(__pyx_t_8); if (unlikely((__pyx_t_24 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 578, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __Pyx_XDECREF_SET(__pyx_v_best, __pyx_t_10);
-      __pyx_t_10 = 0;
-      __pyx_v_i = __pyx_t_5;
-      __pyx_v_j = __pyx_t_6;
-      __pyx_v_v = __pyx_t_24;
-
-      /* "druhg/_druhg_tree.pyx":580
- *                 best, i, j, v = heapq.heappop(heap)
- * 
- *                 if best == INF:             # <<<<<<<<<<<<<<
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')
- *                     break
- */
-      __pyx_t_23 = PyFloat_FromDouble(__pyx_v_5druhg_11_druhg_tree_INF); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 580, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_23);
-      __pyx_t_8 = PyObject_RichCompare(__pyx_v_best, __pyx_t_23, Py_EQ); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 580, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely((__pyx_t_1 < 0))) __PYX_ERR(0, 580, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      if (__pyx_t_1) {
+      __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
 
-        /* "druhg/_druhg_tree.pyx":581
+      /* "druhg/_druhg_tree.pyx":434
+ *                     edge_cases+=1
  * 
- *                 if best == INF:
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')             # <<<<<<<<<<<<<<
- *                     break
- * 
- */
-        __pyx_t_8 = PyInt_FromSsize_t(((__pyx_cur_scope->__pyx_v_self->num_points - 1) - __pyx_cur_scope->__pyx_v_self->result_edges)); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __pyx_t_23 = __Pyx_PyObject_Str(__pyx_t_8); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __pyx_t_8 = PyNumber_Add(__pyx_t_23, __pyx_kp_u_not_connected_edges_It_is_a_for); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_23 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __pyx_t_3 = __Pyx_PyObject_Str(__pyx_t_23); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_23 = PyNumber_Add(__pyx_t_8, __pyx_t_3); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_23, __pyx_kp_u_for_a_better_result); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-        __pyx_t_23 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_3); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 581, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_23);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
-
-        /* "druhg/_druhg_tree.pyx":582
- *                 if best == INF:
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')
- *                     break             # <<<<<<<<<<<<<<
- * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):#    ?     target  diadis
+ *             if self._evaluate_reciprocity(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
+ *                 heapq.heappush(heap, (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
+ * ###############
  */
-        goto __pyx_L45_break;
+    }
+  }
 
-        /* "druhg/_druhg_tree.pyx":580
- *                 best, i, j, v = heapq.heappop(heap)
- * 
- *                 if best == INF:             # <<<<<<<<<<<<<<
- *                     print (str(self.num_points - 1 - self.result_edges) +' not connected edges. It is a forest. Try increasing max_neighbors(max_ranking) value '+str(self.max_neighbors_search)+' for a better result.')
- *                     break
+  /* "druhg/_druhg_tree.pyx":437
+ *                 heapq.heappush(heap, (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
+ * ###############
+ *         if self.result_edges != self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
  */
-      }
+  __pyx_t_2 = ((__pyx_cur_scope->__pyx_v_self->result_edges != (__pyx_cur_scope->__pyx_v_self->num_points - 1)) != 0);
+  if (__pyx_t_2) {
 
-      /* "druhg/_druhg_tree.pyx":584
- *                     break
- * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):#    ?     target  diadis             # <<<<<<<<<<<<<<
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
+    /* "druhg/_druhg_tree.pyx":439
+ *         if self.result_edges != self.num_points - 1:
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(             # <<<<<<<<<<<<<<
+ *                 self.max_neighbors_search) + ' for a better result.')
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
  */
-      __pyx_t_1 = ((((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i) != ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->fast_find(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_j)) != 0);
-      if (__pyx_t_1) {
+    __pyx_t_24 = PyInt_FromSsize_t(((__pyx_cur_scope->__pyx_v_self->num_points - 1) - __pyx_cur_scope->__pyx_v_self->result_edges)); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 439, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_24);
 
-        /* "druhg/_druhg_tree.pyx":585
- * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):#    ?     target  diadis
- *                     self.U.union(i, j)             # <<<<<<<<<<<<<<
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel):
+    /* "druhg/_druhg_tree.pyx":438
+ * ###############
+ *         if self.result_edges != self.num_points - 1:
+ *             print (str(             # <<<<<<<<<<<<<<
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
+ *                 self.max_neighbors_search) + ' for a better result.')
  */
-        ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind *)__pyx_cur_scope->__pyx_v_self->U->__pyx_vtab)->__pyx_union(__pyx_cur_scope->__pyx_v_self->U, __pyx_v_i, __pyx_v_j);
+    __pyx_t_9 = __Pyx_PyObject_Str(__pyx_t_24); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 438, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
+    __Pyx_DECREF(__pyx_t_24); __pyx_t_24 = 0;
 
-        /* "druhg/_druhg_tree.pyx":586
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):#    ?     target  diadis
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)             # <<<<<<<<<<<<<<
- *                 if self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel):
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
+    /* "druhg/_druhg_tree.pyx":439
+ *         if self.result_edges != self.num_points - 1:
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(             # <<<<<<<<<<<<<<
+ *                 self.max_neighbors_search) + ' for a better result.')
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
  */
-        ((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->result_add_edge(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, __pyx_v_j, __pyx_v_v);
+    __pyx_t_24 = PyNumber_Add(__pyx_t_9, __pyx_kp_u_not_connected_edges_of); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 439, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_24);
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __pyx_t_9 = PyInt_FromSsize_t((__pyx_cur_scope->__pyx_v_self->num_points - 1)); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 439, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
 
-        /* "druhg/_druhg_tree.pyx":584
- *                     break
- * 
- *                 if self.U.fast_find(i)!=self.U.fast_find(j):#    ?     target  diadis             # <<<<<<<<<<<<<<
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
+    /* "druhg/_druhg_tree.pyx":440
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
+ *                 self.max_neighbors_search) + ' for a better result.')             # <<<<<<<<<<<<<<
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
+ *             # todo: may be check the actual reachability of indices?
+ */
+    __pyx_t_11 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 440, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+
+    /* "druhg/_druhg_tree.pyx":439
+ *         if self.result_edges != self.num_points - 1:
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(             # <<<<<<<<<<<<<<
+ *                 self.max_neighbors_search) + ' for a better result.')
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
  */
-      }
+    __pyx_t_4 = __Pyx_PyObject_Str(__pyx_t_11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 439, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __pyx_t_11 = PyNumber_Add(__pyx_kp_u_It_is_a_forest_Try_increasing_m, __pyx_t_4); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 439, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-      /* "druhg/_druhg_tree.pyx":587
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- * 
+    /* "druhg/_druhg_tree.pyx":440
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
+ *                 self.max_neighbors_search) + ' for a better result.')             # <<<<<<<<<<<<<<
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
+ *             # todo: may be check the actual reachability of indices?
  */
-      __pyx_t_1 = (((struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_cur_scope->__pyx_v_self->__pyx_vtab)->_evaluate_reciprocity_fast(__pyx_cur_scope->__pyx_v_self, __pyx_v_i, ((PyArrayObject *)__pyx_v_knn_indices), ((PyArrayObject *)__pyx_v_knn_dist), (&__pyx_v_rel)) != 0);
-      if (__pyx_t_1) {
+    __pyx_t_4 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_11, __pyx_kp_u_for_a_better_result); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 440, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
 
-        /* "druhg/_druhg_tree.pyx":588
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel):
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in             # <<<<<<<<<<<<<<
- * 
- *         return
+    /* "druhg/_druhg_tree.pyx":438
+ * ###############
+ *         if self.result_edges != self.num_points - 1:
+ *             print (str(             # <<<<<<<<<<<<<<
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
+ *                 self.max_neighbors_search) + ' for a better result.')
+ */
+    __pyx_t_11 = PyTuple_New(3); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 438, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __Pyx_GIVEREF(__pyx_t_24);
+    PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_24);
+    __Pyx_GIVEREF(__pyx_t_9);
+    PyTuple_SET_ITEM(__pyx_t_11, 1, __pyx_t_9);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_11, 2, __pyx_t_4);
+    __pyx_t_24 = 0;
+    __pyx_t_9 = 0;
+    __pyx_t_4 = 0;
+    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_builtin_print, __pyx_t_11, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 438, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "druhg/_druhg_tree.pyx":437
+ *                 heapq.heappush(heap, (rel.reciprocity, i, rel.endpoint, rel.max_rank, rel.skip_first))
+ * ###############
+ *         if self.result_edges != self.num_points - 1:             # <<<<<<<<<<<<<<
+ *             print (str(
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
  */
-        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_heapq); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_heappush); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = PyFloat_FromDouble(__pyx_v_rel.reciprocity); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_i); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_10 = PyInt_FromSsize_t(__pyx_v_rel.target); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __pyx_t_9 = PyFloat_FromDouble(__pyx_v_rel.dia_dis); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_13 = PyTuple_New(4); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 588, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_GIVEREF(__pyx_t_3);
-        PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_3);
-        __Pyx_GIVEREF(__pyx_t_2);
-        PyTuple_SET_ITEM(__pyx_t_13, 1, __pyx_t_2);
-        __Pyx_GIVEREF(__pyx_t_10);
-        PyTuple_SET_ITEM(__pyx_t_13, 2, __pyx_t_10);
-        __Pyx_GIVEREF(__pyx_t_9);
-        PyTuple_SET_ITEM(__pyx_t_13, 3, __pyx_t_9);
-        __pyx_t_3 = 0;
-        __pyx_t_2 = 0;
-        __pyx_t_10 = 0;
-        __pyx_t_9 = 0;
-        __pyx_t_9 = NULL;
-        __pyx_t_11 = 0;
-        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_8))) {
-          __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_8);
-          if (likely(__pyx_t_9)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
-            __Pyx_INCREF(__pyx_t_9);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_8, function);
-            __pyx_t_11 = 1;
-          }
-        }
-        {
-          PyObject *__pyx_callargs[3] = {__pyx_t_9, __pyx_v_heap, __pyx_t_13};
-          __pyx_t_23 = __Pyx_PyObject_FastCall(__pyx_t_8, __pyx_callargs+1-__pyx_t_11, 2+__pyx_t_11);
-          __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-          if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 588, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_23);
-          __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
+  }
 
-        /* "druhg/_druhg_tree.pyx":587
- *                     self.U.union(i, j)
- *                     self.result_add_edge(i, j, v)
- *                 if self._evaluate_reciprocity_fast(i, knn_indices, knn_dist, &rel):             # <<<<<<<<<<<<<<
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- * 
+  /* "druhg/_druhg_tree.pyx":441
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
+ *                 self.max_neighbors_search) + ' for a better result.')
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:             # <<<<<<<<<<<<<<
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(
  */
-      }
-    }
-    __pyx_L45_break:;
+  __pyx_t_5 = ((__pyx_cur_scope->__pyx_v_self->max_neighbors_search < __pyx_cur_scope->__pyx_v_self->num_points) != 0);
+  if (__pyx_t_5) {
+  } else {
+    __pyx_t_2 = __pyx_t_5;
+    goto __pyx_L43_bool_binop_done;
   }
-  __pyx_L36:;
+  __pyx_t_4 = __Pyx_PyInt_NeObjC(__pyx_v_edge_cases, __pyx_int_0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 441, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely((__pyx_t_5 < 0))) __PYX_ERR(0, 441, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_2 = __pyx_t_5;
+  __pyx_L43_bool_binop_done:;
+  if (__pyx_t_2) {
+
+    /* "druhg/_druhg_tree.pyx":443
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(             # <<<<<<<<<<<<<<
+ *                 self.max_neighbors_search) + 'or pick the square mode (not available).')
+ */
+    __pyx_t_4 = __Pyx_PyObject_Str(__pyx_v_edge_cases); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 443, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_11 = PyNumber_Add(__pyx_t_4, __pyx_kp_u_edges_with_the_max_rank_Try_inc); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 443, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_11);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-  /* "druhg/_druhg_tree.pyx":590
- *                     heapq.heappush(heap, (rel.reciprocity, i, rel.target, rel.dia_dis)) # updated value is in
- * 
- *         return             # <<<<<<<<<<<<<<
- *         # less storage, reevaluating to get the data
- *         # heapq.heappush(heap, (INF, -1))
+    /* "druhg/_druhg_tree.pyx":444
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(
+ *                 self.max_neighbors_search) + 'or pick the square mode (not available).')             # <<<<<<<<<<<<<<
  */
-  __Pyx_XDECREF(__pyx_r);
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
-  goto __pyx_L0;
+    __pyx_t_4 = PyInt_FromSsize_t(__pyx_cur_scope->__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 444, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
 
-  /* "druhg/_druhg_tree.pyx":482
- * 
+    /* "druhg/_druhg_tree.pyx":443
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(             # <<<<<<<<<<<<<<
+ *                 self.max_neighbors_search) + 'or pick the square mode (not available).')
+ */
+    __pyx_t_9 = __Pyx_PyObject_Str(__pyx_t_4); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 443, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = PyNumber_Add(__pyx_t_11, __pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 443, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+
+    /* "druhg/_druhg_tree.pyx":444
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(
+ *                 self.max_neighbors_search) + 'or pick the square mode (not available).')             # <<<<<<<<<<<<<<
+ */
+    __pyx_t_9 = __Pyx_PyUnicode_ConcatInPlace(__pyx_t_4, __pyx_kp_u_or_pick_the_square_mode_not_avai); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 444, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "druhg/_druhg_tree.pyx":443
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(             # <<<<<<<<<<<<<<
+ *                 self.max_neighbors_search) + 'or pick the square mode (not available).')
+ */
+    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_print, __pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 443, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "druhg/_druhg_tree.pyx":441
+ *                 self.num_points - 1 - self.result_edges) + ' not connected edges of', self.num_points - 1,'. It is a forest. Try increasing max_neighbors(max_ranking) value ' + str(
+ *                 self.max_neighbors_search) + ' for a better result.')
+ *         if self.max_neighbors_search < self.num_points and edge_cases != 0:             # <<<<<<<<<<<<<<
+ *             # todo: may be check the actual reachability of indices?
+ *             print (str(edge_cases) + ' edges with the max rank. Try increasing max_neighbors(max_ranking) value '+ str(
+ */
+  }
+
+  /* "druhg/_druhg_tree.pyx":341
+ *         return res
  * 
- *     cdef _compute_tree_edges(self, is_slow):             # <<<<<<<<<<<<<<
+ *     cdef _compute_tree_edges(self):             # <<<<<<<<<<<<<<
  *         # DRUHG
  *         # computes DRUHG Spanning Tree
  */
 
   /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_9);
   __Pyx_XDECREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_13);
+  __Pyx_XDECREF(__pyx_t_11);
+  __Pyx_XDECREF(__pyx_t_14);
   __Pyx_XDECREF(__pyx_t_23);
+  __Pyx_XDECREF(__pyx_t_24);
   { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
     __Pyx_PyThreadState_declare
     __Pyx_PyThreadState_assign
     __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
     __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
   __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
   __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity._compute_tree_edges", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   goto __pyx_L2;
   __pyx_L0:;
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_dist.rcbuffer->pybuffer);
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_knn_indices.rcbuffer->pybuffer);
   __pyx_L2:;
-  __Pyx_XDECREF(__pyx_v_heap);
   __Pyx_XDECREF((PyObject *)__pyx_v_knn_dist);
   __Pyx_XDECREF((PyObject *)__pyx_v_knn_indices);
+  __Pyx_XDECREF(__pyx_v_heap);
   __Pyx_XDECREF(__pyx_v_split_cnt);
   __Pyx_XDECREF(__pyx_v_knn_data);
-  __Pyx_XDECREF(__pyx_v_best);
+  __Pyx_XDECREF(__pyx_v_edge_cases);
   __Pyx_XDECREF(__pyx_gb_5druhg_11_druhg_tree_20UniversalReciprocity_19_compute_tree_edges_2generator);
   __Pyx_XDECREF(__pyx_8genexpr1__pyx_v_x);
   __Pyx_XDECREF(__pyx_8genexpr2__pyx_v_x);
   __Pyx_DECREF((PyObject *)__pyx_cur_scope);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
+/* "druhg/_druhg_tree.pyx":166
+ *         np.ndarray result_rank_arr
+ * 
+ *         public np.ndarray knn_d             # <<<<<<<<<<<<<<
+ *         public np.ndarray knn_i
+ * 
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_1__get__(PyObject *__pyx_v_self); /*proto*/
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_1__get__(PyObject *__pyx_v_self) {
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__get__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d___get__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d___get__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__get__", 0);
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_INCREF((PyObject *)__pyx_v_self->knn_d);
+  __pyx_r = ((PyObject *)__pyx_v_self->knn_d);
+  goto __pyx_L0;
+
+  /* function exit code */
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* Python wrapper */
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_3__set__(PyObject *__pyx_v_self, PyObject *__pyx_v_value); /*proto*/
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_3__set__(PyObject *__pyx_v_self, PyObject *__pyx_v_value) {
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__set__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_2__set__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self), ((PyObject *)__pyx_v_value));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_2__set__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_value) {
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__set__", 0);
+  if (!(likely(((__pyx_v_value) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_value, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 166, __pyx_L1_error)
+  __pyx_t_1 = __pyx_v_value;
+  __Pyx_INCREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->knn_d);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->knn_d);
+  __pyx_v_self->knn_d = ((PyArrayObject *)__pyx_t_1);
+  __pyx_t_1 = 0;
+
+  /* function exit code */
+  __pyx_r = 0;
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.knn_d.__set__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = -1;
+  __pyx_L0:;
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* Python wrapper */
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_5__del__(PyObject *__pyx_v_self); /*proto*/
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_5__del__(PyObject *__pyx_v_self) {
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__del__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_4__del__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_4__del__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__del__", 0);
+  __Pyx_INCREF(Py_None);
+  __Pyx_GIVEREF(Py_None);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->knn_d);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->knn_d);
+  __pyx_v_self->knn_d = ((PyArrayObject *)Py_None);
+
+  /* function exit code */
+  __pyx_r = 0;
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "druhg/_druhg_tree.pyx":167
+ * 
+ *         public np.ndarray knn_d
+ *         public np.ndarray knn_i             # <<<<<<<<<<<<<<
+ * 
+ *     def __init__(self, algorithm, tree,
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_1__get__(PyObject *__pyx_v_self); /*proto*/
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_1__get__(PyObject *__pyx_v_self) {
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__get__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i___get__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i___get__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__get__", 0);
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_INCREF((PyObject *)__pyx_v_self->knn_i);
+  __pyx_r = ((PyObject *)__pyx_v_self->knn_i);
+  goto __pyx_L0;
+
+  /* function exit code */
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* Python wrapper */
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_3__set__(PyObject *__pyx_v_self, PyObject *__pyx_v_value); /*proto*/
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_3__set__(PyObject *__pyx_v_self, PyObject *__pyx_v_value) {
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__set__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_2__set__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self), ((PyObject *)__pyx_v_value));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_2__set__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self, PyObject *__pyx_v_value) {
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__set__", 0);
+  if (!(likely(((__pyx_v_value) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_value, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 167, __pyx_L1_error)
+  __pyx_t_1 = __pyx_v_value;
+  __Pyx_INCREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->knn_i);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->knn_i);
+  __pyx_v_self->knn_i = ((PyArrayObject *)__pyx_t_1);
+  __pyx_t_1 = 0;
+
+  /* function exit code */
+  __pyx_r = 0;
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("druhg._druhg_tree.UniversalReciprocity.knn_i.__set__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = -1;
+  __pyx_L0:;
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* Python wrapper */
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_5__del__(PyObject *__pyx_v_self); /*proto*/
+static int __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_5__del__(PyObject *__pyx_v_self) {
+  CYTHON_UNUSED PyObject *const *__pyx_kwvalues = __Pyx_KwValues_VARARGS(__pyx_args, __pyx_nargs);
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__del__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_4__del__(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static int __pyx_pf_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_4__del__(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v_self) {
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__del__", 0);
+  __Pyx_INCREF(Py_None);
+  __Pyx_GIVEREF(Py_None);
+  __Pyx_GOTREF((PyObject *)__pyx_v_self->knn_i);
+  __Pyx_DECREF((PyObject *)__pyx_v_self->knn_i);
+  __pyx_v_self->knn_i = ((PyArrayObject *)Py_None);
+
+  /* function exit code */
+  __pyx_r = 0;
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
 /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
 
 /* Python wrapper */
@@ -12157,15 +11985,15 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":5
  *     cdef object _dict
  *     cdef bint use_setstate
- *     state = (self.PRECISION, self.U, self.dist_tree, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_value_arr, self.tree)             # <<<<<<<<<<<<<<
+ *     state = (self.PRECISION, self.U, self.dist_tree, self.knn_d, self.knn_i, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_rank_arr, self.result_values_arr, self.tree)             # <<<<<<<<<<<<<<
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:
  */
   __pyx_t_1 = PyFloat_FromDouble(__pyx_v_self->PRECISION); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_self->max_neighbors_search); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
@@ -12173,66 +12001,75 @@
   __Pyx_GOTREF(__pyx_t_3);
   __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_self->num_features); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_self->num_points); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
   __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_self->result_edges); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_7 = PyTuple_New(11); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __pyx_t_7 = PyTuple_New(14); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_1);
   __Pyx_INCREF((PyObject *)__pyx_v_self->U);
   __Pyx_GIVEREF((PyObject *)__pyx_v_self->U);
   PyTuple_SET_ITEM(__pyx_t_7, 1, ((PyObject *)__pyx_v_self->U));
   __Pyx_INCREF(__pyx_v_self->dist_tree);
   __Pyx_GIVEREF(__pyx_v_self->dist_tree);
   PyTuple_SET_ITEM(__pyx_t_7, 2, __pyx_v_self->dist_tree);
+  __Pyx_INCREF((PyObject *)__pyx_v_self->knn_d);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_self->knn_d);
+  PyTuple_SET_ITEM(__pyx_t_7, 3, ((PyObject *)__pyx_v_self->knn_d));
+  __Pyx_INCREF((PyObject *)__pyx_v_self->knn_i);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_self->knn_i);
+  PyTuple_SET_ITEM(__pyx_t_7, 4, ((PyObject *)__pyx_v_self->knn_i));
   __Pyx_GIVEREF(__pyx_t_2);
-  PyTuple_SET_ITEM(__pyx_t_7, 3, __pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_7, 5, __pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_7, 4, __pyx_t_3);
+  PyTuple_SET_ITEM(__pyx_t_7, 6, __pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_4);
-  PyTuple_SET_ITEM(__pyx_t_7, 5, __pyx_t_4);
+  PyTuple_SET_ITEM(__pyx_t_7, 7, __pyx_t_4);
   __Pyx_GIVEREF(__pyx_t_5);
-  PyTuple_SET_ITEM(__pyx_t_7, 6, __pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_7, 8, __pyx_t_5);
   __Pyx_GIVEREF(__pyx_t_6);
-  PyTuple_SET_ITEM(__pyx_t_7, 7, __pyx_t_6);
+  PyTuple_SET_ITEM(__pyx_t_7, 9, __pyx_t_6);
   __Pyx_INCREF((PyObject *)__pyx_v_self->result_pairs_arr);
   __Pyx_GIVEREF((PyObject *)__pyx_v_self->result_pairs_arr);
-  PyTuple_SET_ITEM(__pyx_t_7, 8, ((PyObject *)__pyx_v_self->result_pairs_arr));
-  __Pyx_INCREF((PyObject *)__pyx_v_self->result_value_arr);
-  __Pyx_GIVEREF((PyObject *)__pyx_v_self->result_value_arr);
-  PyTuple_SET_ITEM(__pyx_t_7, 9, ((PyObject *)__pyx_v_self->result_value_arr));
+  PyTuple_SET_ITEM(__pyx_t_7, 10, ((PyObject *)__pyx_v_self->result_pairs_arr));
+  __Pyx_INCREF((PyObject *)__pyx_v_self->result_rank_arr);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_self->result_rank_arr);
+  PyTuple_SET_ITEM(__pyx_t_7, 11, ((PyObject *)__pyx_v_self->result_rank_arr));
+  __Pyx_INCREF((PyObject *)__pyx_v_self->result_values_arr);
+  __Pyx_GIVEREF((PyObject *)__pyx_v_self->result_values_arr);
+  PyTuple_SET_ITEM(__pyx_t_7, 12, ((PyObject *)__pyx_v_self->result_values_arr));
   __Pyx_INCREF(__pyx_v_self->tree);
   __Pyx_GIVEREF(__pyx_v_self->tree);
-  PyTuple_SET_ITEM(__pyx_t_7, 10, __pyx_v_self->tree);
+  PyTuple_SET_ITEM(__pyx_t_7, 13, __pyx_v_self->tree);
   __pyx_t_1 = 0;
   __pyx_t_2 = 0;
   __pyx_t_3 = 0;
   __pyx_t_4 = 0;
   __pyx_t_5 = 0;
   __pyx_t_6 = 0;
   __pyx_v_state = ((PyObject*)__pyx_t_7);
   __pyx_t_7 = 0;
 
   /* "(tree fragment)":6
  *     cdef bint use_setstate
- *     state = (self.PRECISION, self.U, self.dist_tree, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_value_arr, self.tree)
+ *     state = (self.PRECISION, self.U, self.dist_tree, self.knn_d, self.knn_i, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_rank_arr, self.result_values_arr, self.tree)
  *     _dict = getattr(self, '__dict__', None)             # <<<<<<<<<<<<<<
  *     if _dict is not None:
  *         state += (_dict,)
  */
   __pyx_t_7 = __Pyx_GetAttr3(((PyObject *)__pyx_v_self), __pyx_n_s_dict, Py_None); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 6, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
   __pyx_v__dict = __pyx_t_7;
   __pyx_t_7 = 0;
 
   /* "(tree fragment)":7
- *     state = (self.PRECISION, self.U, self.dist_tree, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_value_arr, self.tree)
+ *     state = (self.PRECISION, self.U, self.dist_tree, self.knn_d, self.knn_i, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_rank_arr, self.result_values_arr, self.tree)
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:             # <<<<<<<<<<<<<<
  *         state += (_dict,)
  *         use_setstate = True
  */
   __pyx_t_8 = (__pyx_v__dict != Py_None);
   __pyx_t_9 = (__pyx_t_8 != 0);
@@ -12257,34 +12094,34 @@
     __pyx_t_6 = 0;
 
     /* "(tree fragment)":9
  *     if _dict is not None:
  *         state += (_dict,)
  *         use_setstate = True             # <<<<<<<<<<<<<<
  *     else:
- *         use_setstate = self.U is not None or self.dist_tree is not None or self.result_pairs_arr is not None or self.result_value_arr is not None or self.tree is not None
+ *         use_setstate = self.U is not None or self.dist_tree is not None or self.knn_d is not None or self.knn_i is not None or self.result_pairs_arr is not None or self.result_rank_arr is not None or self.result_values_arr is not None or self.tree is not None
  */
     __pyx_v_use_setstate = 1;
 
     /* "(tree fragment)":7
- *     state = (self.PRECISION, self.U, self.dist_tree, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_value_arr, self.tree)
+ *     state = (self.PRECISION, self.U, self.dist_tree, self.knn_d, self.knn_i, self.max_neighbors_search, self.n_jobs, self.num_features, self.num_points, self.result_edges, self.result_pairs_arr, self.result_rank_arr, self.result_values_arr, self.tree)
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:             # <<<<<<<<<<<<<<
  *         state += (_dict,)
  *         use_setstate = True
  */
     goto __pyx_L3;
   }
 
   /* "(tree fragment)":11
  *         use_setstate = True
  *     else:
- *         use_setstate = self.U is not None or self.dist_tree is not None or self.result_pairs_arr is not None or self.result_value_arr is not None or self.tree is not None             # <<<<<<<<<<<<<<
+ *         use_setstate = self.U is not None or self.dist_tree is not None or self.knn_d is not None or self.knn_i is not None or self.result_pairs_arr is not None or self.result_rank_arr is not None or self.result_values_arr is not None or self.tree is not None             # <<<<<<<<<<<<<<
  *     if use_setstate:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, None), state
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, None), state
  */
   /*else*/ {
     __pyx_t_8 = (((PyObject *)__pyx_v_self->U) != Py_None);
     __pyx_t_10 = (__pyx_t_8 != 0);
     if (!__pyx_t_10) {
     } else {
       __pyx_t_9 = __pyx_t_10;
@@ -12293,64 +12130,85 @@
     __pyx_t_10 = (__pyx_v_self->dist_tree != Py_None);
     __pyx_t_8 = (__pyx_t_10 != 0);
     if (!__pyx_t_8) {
     } else {
       __pyx_t_9 = __pyx_t_8;
       goto __pyx_L4_bool_binop_done;
     }
+    __pyx_t_8 = (((PyObject *)__pyx_v_self->knn_d) != Py_None);
+    __pyx_t_10 = (__pyx_t_8 != 0);
+    if (!__pyx_t_10) {
+    } else {
+      __pyx_t_9 = __pyx_t_10;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_10 = (((PyObject *)__pyx_v_self->knn_i) != Py_None);
+    __pyx_t_8 = (__pyx_t_10 != 0);
+    if (!__pyx_t_8) {
+    } else {
+      __pyx_t_9 = __pyx_t_8;
+      goto __pyx_L4_bool_binop_done;
+    }
     __pyx_t_8 = (((PyObject *)__pyx_v_self->result_pairs_arr) != Py_None);
     __pyx_t_10 = (__pyx_t_8 != 0);
     if (!__pyx_t_10) {
     } else {
       __pyx_t_9 = __pyx_t_10;
       goto __pyx_L4_bool_binop_done;
     }
-    __pyx_t_10 = (((PyObject *)__pyx_v_self->result_value_arr) != Py_None);
+    __pyx_t_10 = (((PyObject *)__pyx_v_self->result_rank_arr) != Py_None);
     __pyx_t_8 = (__pyx_t_10 != 0);
     if (!__pyx_t_8) {
     } else {
       __pyx_t_9 = __pyx_t_8;
       goto __pyx_L4_bool_binop_done;
     }
-    __pyx_t_8 = (__pyx_v_self->tree != Py_None);
+    __pyx_t_8 = (((PyObject *)__pyx_v_self->result_values_arr) != Py_None);
     __pyx_t_10 = (__pyx_t_8 != 0);
-    __pyx_t_9 = __pyx_t_10;
+    if (!__pyx_t_10) {
+    } else {
+      __pyx_t_9 = __pyx_t_10;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_10 = (__pyx_v_self->tree != Py_None);
+    __pyx_t_8 = (__pyx_t_10 != 0);
+    __pyx_t_9 = __pyx_t_8;
     __pyx_L4_bool_binop_done:;
     __pyx_v_use_setstate = __pyx_t_9;
   }
   __pyx_L3:;
 
   /* "(tree fragment)":12
  *     else:
- *         use_setstate = self.U is not None or self.dist_tree is not None or self.result_pairs_arr is not None or self.result_value_arr is not None or self.tree is not None
+ *         use_setstate = self.U is not None or self.dist_tree is not None or self.knn_d is not None or self.knn_i is not None or self.result_pairs_arr is not None or self.result_rank_arr is not None or self.result_values_arr is not None or self.tree is not None
  *     if use_setstate:             # <<<<<<<<<<<<<<
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, None), state
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, None), state
  *     else:
  */
   __pyx_t_9 = (__pyx_v_use_setstate != 0);
   if (__pyx_t_9) {
 
     /* "(tree fragment)":13
- *         use_setstate = self.U is not None or self.dist_tree is not None or self.result_pairs_arr is not None or self.result_value_arr is not None or self.tree is not None
+ *         use_setstate = self.U is not None or self.dist_tree is not None or self.knn_d is not None or self.knn_i is not None or self.result_pairs_arr is not None or self.result_rank_arr is not None or self.result_values_arr is not None or self.tree is not None
  *     if use_setstate:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, None), state             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, None), state             # <<<<<<<<<<<<<<
  *     else:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_pyx_unpickle_UniversalReciproc); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 13, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __pyx_t_7 = PyTuple_New(3); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 13, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
     __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
     PyTuple_SET_ITEM(__pyx_t_7, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_INCREF(__pyx_int_234627805);
-    __Pyx_GIVEREF(__pyx_int_234627805);
-    PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_int_234627805);
+    __Pyx_INCREF(__pyx_int_204757032);
+    __Pyx_GIVEREF(__pyx_int_204757032);
+    PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_int_204757032);
     __Pyx_INCREF(Py_None);
     __Pyx_GIVEREF(Py_None);
     PyTuple_SET_ITEM(__pyx_t_7, 2, Py_None);
     __pyx_t_5 = PyTuple_New(3); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 13, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_GIVEREF(__pyx_t_6);
     PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6);
@@ -12363,40 +12221,40 @@
     __pyx_t_7 = 0;
     __pyx_r = __pyx_t_5;
     __pyx_t_5 = 0;
     goto __pyx_L0;
 
     /* "(tree fragment)":12
  *     else:
- *         use_setstate = self.U is not None or self.dist_tree is not None or self.result_pairs_arr is not None or self.result_value_arr is not None or self.tree is not None
+ *         use_setstate = self.U is not None or self.dist_tree is not None or self.knn_d is not None or self.knn_i is not None or self.result_pairs_arr is not None or self.result_rank_arr is not None or self.result_values_arr is not None or self.tree is not None
  *     if use_setstate:             # <<<<<<<<<<<<<<
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, None), state
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, None), state
  *     else:
  */
   }
 
   /* "(tree fragment)":15
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, None), state
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, None), state
  *     else:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_UniversalReciprocity__set_state(self, __pyx_state)
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
     __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_pyx_unpickle_UniversalReciproc); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 15, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __pyx_t_7 = PyTuple_New(3); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 15, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
     __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
     PyTuple_SET_ITEM(__pyx_t_7, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_INCREF(__pyx_int_234627805);
-    __Pyx_GIVEREF(__pyx_int_234627805);
-    PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_int_234627805);
+    __Pyx_INCREF(__pyx_int_204757032);
+    __Pyx_GIVEREF(__pyx_int_204757032);
+    PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_int_204757032);
     __Pyx_INCREF(__pyx_v_state);
     __Pyx_GIVEREF(__pyx_v_state);
     PyTuple_SET_ITEM(__pyx_t_7, 2, __pyx_v_state);
     __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 15, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
@@ -12432,15 +12290,15 @@
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* "(tree fragment)":16
  *     else:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_UniversalReciprocity__set_state(self, __pyx_state)
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_9__setstate_cython__(PyObject *__pyx_v_self, 
 #if CYTHON_METH_FASTCALL
@@ -12522,26 +12380,26 @@
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":17
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_UniversalReciprocity__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
  */
   if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_v___pyx_state))) __PYX_ERR(1, 17, __pyx_L1_error)
   __pyx_t_1 = __pyx_f_5druhg_11_druhg_tree___pyx_unpickle_UniversalReciprocity__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "(tree fragment)":16
  *     else:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_UniversalReciprocity__set_state(self, __pyx_state)
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
@@ -12558,23 +12416,23 @@
 /* "(tree fragment)":1
  * def __pyx_unpickle_PairwiseDistanceTreeSparse(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_1__pyx_unpickle_PairwiseDistanceTreeSparse(PyObject *__pyx_self, 
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_7__pyx_unpickle_PairwiseDistanceTreeSparse(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_1__pyx_unpickle_PairwiseDistanceTreeSparse = {"__pyx_unpickle_PairwiseDistanceTreeSparse", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_1__pyx_unpickle_PairwiseDistanceTreeSparse, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_1__pyx_unpickle_PairwiseDistanceTreeSparse(PyObject *__pyx_self, 
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_7__pyx_unpickle_PairwiseDistanceTreeSparse = {"__pyx_unpickle_PairwiseDistanceTreeSparse", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_7__pyx_unpickle_PairwiseDistanceTreeSparse, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_7__pyx_unpickle_PairwiseDistanceTreeSparse(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
   PyObject *__pyx_v___pyx_type = 0;
@@ -12649,22 +12507,22 @@
   __pyx_L5_argtuple_error:;
   __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_PairwiseDistanceTreeSparse", 1, 3, 3, __pyx_nargs); __PYX_ERR(1, 1, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.__pyx_unpickle_PairwiseDistanceTreeSparse", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree___pyx_unpickle_PairwiseDistanceTreeSparse(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_6__pyx_unpickle_PairwiseDistanceTreeSparse(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_11_druhg_tree___pyx_unpickle_PairwiseDistanceTreeSparse(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_6__pyx_unpickle_PairwiseDistanceTreeSparse(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
@@ -12972,23 +12830,23 @@
 /* "(tree fragment)":1
  * def __pyx_unpickle_PairwiseDistanceTreeGeneric(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_3__pyx_unpickle_PairwiseDistanceTreeGeneric(PyObject *__pyx_self, 
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_9__pyx_unpickle_PairwiseDistanceTreeGeneric(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_3__pyx_unpickle_PairwiseDistanceTreeGeneric = {"__pyx_unpickle_PairwiseDistanceTreeGeneric", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_3__pyx_unpickle_PairwiseDistanceTreeGeneric, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_3__pyx_unpickle_PairwiseDistanceTreeGeneric(PyObject *__pyx_self, 
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_9__pyx_unpickle_PairwiseDistanceTreeGeneric = {"__pyx_unpickle_PairwiseDistanceTreeGeneric", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_9__pyx_unpickle_PairwiseDistanceTreeGeneric, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_9__pyx_unpickle_PairwiseDistanceTreeGeneric(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
   PyObject *__pyx_v___pyx_type = 0;
@@ -13063,22 +12921,22 @@
   __pyx_L5_argtuple_error:;
   __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_PairwiseDistanceTreeGeneric", 1, 3, 3, __pyx_nargs); __PYX_ERR(1, 1, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.__pyx_unpickle_PairwiseDistanceTreeGeneric", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_2__pyx_unpickle_PairwiseDistanceTreeGeneric(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_8__pyx_unpickle_PairwiseDistanceTreeGeneric(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_2__pyx_unpickle_PairwiseDistanceTreeGeneric(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_8__pyx_unpickle_PairwiseDistanceTreeGeneric(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
@@ -13386,23 +13244,23 @@
 /* "(tree fragment)":1
  * def __pyx_unpickle_UniversalReciprocity(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_5__pyx_unpickle_UniversalReciprocity(PyObject *__pyx_self, 
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_11__pyx_unpickle_UniversalReciprocity(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ); /*proto*/
-static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_5__pyx_unpickle_UniversalReciprocity = {"__pyx_unpickle_UniversalReciprocity", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_5__pyx_unpickle_UniversalReciprocity, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_5druhg_11_druhg_tree_5__pyx_unpickle_UniversalReciprocity(PyObject *__pyx_self, 
+static PyMethodDef __pyx_mdef_5druhg_11_druhg_tree_11__pyx_unpickle_UniversalReciprocity = {"__pyx_unpickle_UniversalReciprocity", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_11__pyx_unpickle_UniversalReciprocity, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_5druhg_11_druhg_tree_11__pyx_unpickle_UniversalReciprocity(PyObject *__pyx_self, 
 #if CYTHON_METH_FASTCALL
 PyObject *const *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds
 #else
 PyObject *__pyx_args, PyObject *__pyx_kwds
 #endif
 ) {
   PyObject *__pyx_v___pyx_type = 0;
@@ -13477,22 +13335,22 @@
   __pyx_L5_argtuple_error:;
   __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_UniversalReciprocity", 1, 3, 3, __pyx_nargs); __PYX_ERR(1, 1, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("druhg._druhg_tree.__pyx_unpickle_UniversalReciprocity", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_4__pyx_unpickle_UniversalReciprocity(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
+  __pyx_r = __pyx_pf_5druhg_11_druhg_tree_10__pyx_unpickle_UniversalReciprocity(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_5druhg_11_druhg_tree_4__pyx_unpickle_UniversalReciprocity(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_5druhg_11_druhg_tree_10__pyx_unpickle_UniversalReciprocity(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
@@ -13503,26 +13361,26 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_UniversalReciprocity", 0);
 
   /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0xdfc22dd:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum != 0xc345828:             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum
  */
-  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0xdfc22dd) != 0);
+  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0xc345828) != 0);
   if (__pyx_t_1) {
 
     /* "(tree fragment)":5
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0xdfc22dd:
+ *     if __pyx_checksum != 0xc345828:
  *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum
  *     __pyx_result = UniversalReciprocity.__new__(__pyx_type)
  */
     __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_n_s_PickleError);
     __Pyx_GIVEREF(__pyx_n_s_PickleError);
     PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
@@ -13533,41 +13391,41 @@
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_t_2);
     __pyx_v___pyx_PickleError = __pyx_t_2;
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
     /* "(tree fragment)":6
- *     if __pyx_checksum != 0xdfc22dd:
+ *     if __pyx_checksum != 0xc345828:
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum             # <<<<<<<<<<<<<<
  *     __pyx_result = UniversalReciprocity.__new__(__pyx_type)
  *     if __pyx_state is not None:
  */
     __pyx_t_3 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0xdf, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0xc3, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_Raise(__pyx_v___pyx_PickleError, __pyx_t_2, 0, 0);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __PYX_ERR(1, 6, __pyx_L1_error)
 
     /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0xdfc22dd:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum != 0xc345828:             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum
  */
   }
 
   /* "(tree fragment)":7
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum
  *     __pyx_result = UniversalReciprocity.__new__(__pyx_type)             # <<<<<<<<<<<<<<
  *     if __pyx_state is not None:
  *         __pyx_unpickle_UniversalReciprocity__set_state(<UniversalReciprocity> __pyx_result, __pyx_state)
  */
   __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity), __pyx_n_s_new); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __pyx_t_4 = NULL;
@@ -13590,15 +13448,15 @@
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   }
   __pyx_v___pyx_result = __pyx_t_2;
   __pyx_t_2 = 0;
 
   /* "(tree fragment)":8
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum
  *     __pyx_result = UniversalReciprocity.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_UniversalReciprocity__set_state(<UniversalReciprocity> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
   __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
   __pyx_t_6 = (__pyx_t_1 != 0);
@@ -13613,28 +13471,28 @@
  */
     if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None) || __Pyx_RaiseUnexpectedTypeError("tuple", __pyx_v___pyx_state))) __PYX_ERR(1, 9, __pyx_L1_error)
     __pyx_t_2 = __pyx_f_5druhg_11_druhg_tree___pyx_unpickle_UniversalReciprocity__set_state(((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 9, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
     /* "(tree fragment)":8
- *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xdfc22dd = (PRECISION, U, dist_tree, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_value_arr, tree))" % __pyx_checksum
+ *         raise __pyx_PickleError, "Incompatible checksums (%s vs 0xc345828 = (PRECISION, U, dist_tree, knn_d, knn_i, max_neighbors_search, n_jobs, num_features, num_points, result_edges, result_pairs_arr, result_rank_arr, result_values_arr, tree))" % __pyx_checksum
  *     __pyx_result = UniversalReciprocity.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_UniversalReciprocity__set_state(<UniversalReciprocity> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
   }
 
   /* "(tree fragment)":10
  *     if __pyx_state is not None:
  *         __pyx_unpickle_UniversalReciprocity__set_state(<UniversalReciprocity> __pyx_result, __pyx_state)
  *     return __pyx_result             # <<<<<<<<<<<<<<
  * cdef __pyx_unpickle_UniversalReciprocity__set_state(UniversalReciprocity __pyx_result, tuple __pyx_state):
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v___pyx_result);
   __pyx_r = __pyx_v___pyx_result;
   goto __pyx_L0;
 
   /* "(tree fragment)":1
@@ -13658,16 +13516,16 @@
   return __pyx_r;
 }
 
 /* "(tree fragment)":11
  *         __pyx_unpickle_UniversalReciprocity__set_state(<UniversalReciprocity> __pyx_result, __pyx_state)
  *     return __pyx_result
  * cdef __pyx_unpickle_UniversalReciprocity__set_state(UniversalReciprocity __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]
- *     if len(__pyx_state) > 11 and hasattr(__pyx_result, '__dict__'):
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]
+ *     if len(__pyx_state) > 14 and hasattr(__pyx_result, '__dict__'):
  */
 
 static PyObject *__pyx_f_5druhg_11_druhg_tree___pyx_unpickle_UniversalReciprocity__set_state(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *__pyx_v___pyx_result, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   __pyx_t_5numpy_double_t __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
@@ -13683,35 +13541,35 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_UniversalReciprocity__set_state", 0);
 
   /* "(tree fragment)":12
  *     return __pyx_result
  * cdef __pyx_unpickle_UniversalReciprocity__set_state(UniversalReciprocity __pyx_result, tuple __pyx_state):
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]             # <<<<<<<<<<<<<<
- *     if len(__pyx_state) > 11 and hasattr(__pyx_result, '__dict__'):
- *         __pyx_result.__dict__.update(__pyx_state[11])
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]             # <<<<<<<<<<<<<<
+ *     if len(__pyx_state) > 14 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[14])
  */
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
   __pyx_t_1 = __pyx_PyFloat_AsDouble(PyTuple_GET_ITEM(__pyx_v___pyx_state, 0)); if (unlikely((__pyx_t_1 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_v___pyx_result->PRECISION = __pyx_t_1;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 1)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 1), __pyx_ptype_5druhg_11_druhg_tree_UnionFind))))) __PYX_ERR(1, 12, __pyx_L1_error)
+  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 1)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 1), __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind))))) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 1);
   __Pyx_INCREF(__pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_2);
   __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->U);
   __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->U);
-  __pyx_v___pyx_result->U = ((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)__pyx_t_2);
+  __pyx_v___pyx_result->U = ((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)__pyx_t_2);
   __pyx_t_2 = 0;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
   __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 2);
   __Pyx_INCREF(__pyx_t_2);
@@ -13720,103 +13578,139 @@
   __Pyx_DECREF(__pyx_v___pyx_result->dist_tree);
   __pyx_v___pyx_result->dist_tree = __pyx_t_2;
   __pyx_t_2 = 0;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 3)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 3)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 3), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 3);
+  __Pyx_INCREF(__pyx_t_2);
+  __Pyx_GIVEREF(__pyx_t_2);
+  __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->knn_d);
+  __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->knn_d);
+  __pyx_v___pyx_result->knn_d = ((PyArrayObject *)__pyx_t_2);
+  __pyx_t_2 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 4)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 4), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 4);
+  __Pyx_INCREF(__pyx_t_2);
+  __Pyx_GIVEREF(__pyx_t_2);
+  __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->knn_i);
+  __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->knn_i);
+  __pyx_v___pyx_result->knn_i = ((PyArrayObject *)__pyx_t_2);
+  __pyx_t_2 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 5)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_v___pyx_result->max_neighbors_search = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 4)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 6)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_v___pyx_result->n_jobs = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 5)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 7)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_v___pyx_result->num_features = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 6)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 8)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_v___pyx_result->num_points = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 7)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyIndex_AsSsize_t(PyTuple_GET_ITEM(__pyx_v___pyx_state, 9)); if (unlikely((__pyx_t_3 == ((npy_intp)-1)) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __pyx_v___pyx_result->result_edges = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 8)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 8), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
-  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 8);
+  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 10)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 10), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 10);
   __Pyx_INCREF(__pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_2);
   __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->result_pairs_arr);
   __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->result_pairs_arr);
   __pyx_v___pyx_result->result_pairs_arr = ((PyArrayObject *)__pyx_t_2);
   __pyx_t_2 = 0;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 9)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 9), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
-  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 9);
+  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 11)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 11), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 11);
   __Pyx_INCREF(__pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_2);
-  __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->result_value_arr);
-  __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->result_value_arr);
-  __pyx_v___pyx_result->result_value_arr = ((PyArrayObject *)__pyx_t_2);
+  __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->result_rank_arr);
+  __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->result_rank_arr);
+  __pyx_v___pyx_result->result_rank_arr = ((PyArrayObject *)__pyx_t_2);
   __pyx_t_2 = 0;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 10);
+  if (!(likely(((PyTuple_GET_ITEM(__pyx_v___pyx_state, 12)) == Py_None) || likely(__Pyx_TypeTest(PyTuple_GET_ITEM(__pyx_v___pyx_state, 12), __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 12);
+  __Pyx_INCREF(__pyx_t_2);
+  __Pyx_GIVEREF(__pyx_t_2);
+  __Pyx_GOTREF((PyObject *)__pyx_v___pyx_result->result_values_arr);
+  __Pyx_DECREF((PyObject *)__pyx_v___pyx_result->result_values_arr);
+  __pyx_v___pyx_result->result_values_arr = ((PyArrayObject *)__pyx_t_2);
+  __pyx_t_2 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_2 = PyTuple_GET_ITEM(__pyx_v___pyx_state, 13);
   __Pyx_INCREF(__pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_2);
   __Pyx_GOTREF(__pyx_v___pyx_result->tree);
   __Pyx_DECREF(__pyx_v___pyx_result->tree);
   __pyx_v___pyx_result->tree = __pyx_t_2;
   __pyx_t_2 = 0;
 
   /* "(tree fragment)":13
  * cdef __pyx_unpickle_UniversalReciprocity__set_state(UniversalReciprocity __pyx_result, tuple __pyx_state):
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]
- *     if len(__pyx_state) > 11 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
- *         __pyx_result.__dict__.update(__pyx_state[11])
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]
+ *     if len(__pyx_state) > 14 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[14])
  */
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
     __PYX_ERR(1, 13, __pyx_L1_error)
   }
   __pyx_t_5 = PyTuple_GET_SIZE(__pyx_v___pyx_state); if (unlikely(__pyx_t_5 == ((Py_ssize_t)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
-  __pyx_t_6 = ((__pyx_t_5 > 11) != 0);
+  __pyx_t_6 = ((__pyx_t_5 > 14) != 0);
   if (__pyx_t_6) {
   } else {
     __pyx_t_4 = __pyx_t_6;
     goto __pyx_L4_bool_binop_done;
   }
   __pyx_t_6 = __Pyx_HasAttr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
   __pyx_t_7 = (__pyx_t_6 != 0);
   __pyx_t_4 = __pyx_t_7;
   __pyx_L4_bool_binop_done:;
   if (__pyx_t_4) {
 
     /* "(tree fragment)":14
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]
- *     if len(__pyx_state) > 11 and hasattr(__pyx_result, '__dict__'):
- *         __pyx_result.__dict__.update(__pyx_state[11])             # <<<<<<<<<<<<<<
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]
+ *     if len(__pyx_state) > 14 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[14])             # <<<<<<<<<<<<<<
  */
     __pyx_t_8 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_update); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 14, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     if (unlikely(__pyx_v___pyx_state == Py_None)) {
@@ -13832,37 +13726,37 @@
         __Pyx_INCREF(__pyx_t_8);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_9, function);
         __pyx_t_10 = 1;
       }
     }
     {
-      PyObject *__pyx_callargs[2] = {__pyx_t_8, PyTuple_GET_ITEM(__pyx_v___pyx_state, 11)};
+      PyObject *__pyx_callargs[2] = {__pyx_t_8, PyTuple_GET_ITEM(__pyx_v___pyx_state, 14)};
       __pyx_t_2 = __Pyx_PyObject_FastCall(__pyx_t_9, __pyx_callargs+1-__pyx_t_10, 1+__pyx_t_10);
       __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 14, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
     }
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
     /* "(tree fragment)":13
  * cdef __pyx_unpickle_UniversalReciprocity__set_state(UniversalReciprocity __pyx_result, tuple __pyx_state):
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]
- *     if len(__pyx_state) > 11 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
- *         __pyx_result.__dict__.update(__pyx_state[11])
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]
+ *     if len(__pyx_state) > 14 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[14])
  */
   }
 
   /* "(tree fragment)":11
  *         __pyx_unpickle_UniversalReciprocity__set_state(<UniversalReciprocity> __pyx_result, __pyx_state)
  *     return __pyx_result
  * cdef __pyx_unpickle_UniversalReciprocity__set_state(UniversalReciprocity __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.max_neighbors_search = __pyx_state[3]; __pyx_result.n_jobs = __pyx_state[4]; __pyx_result.num_features = __pyx_state[5]; __pyx_result.num_points = __pyx_state[6]; __pyx_result.result_edges = __pyx_state[7]; __pyx_result.result_pairs_arr = __pyx_state[8]; __pyx_result.result_value_arr = __pyx_state[9]; __pyx_result.tree = __pyx_state[10]
- *     if len(__pyx_state) > 11 and hasattr(__pyx_result, '__dict__'):
+ *     __pyx_result.PRECISION = __pyx_state[0]; __pyx_result.U = __pyx_state[1]; __pyx_result.dist_tree = __pyx_state[2]; __pyx_result.knn_d = __pyx_state[3]; __pyx_result.knn_i = __pyx_state[4]; __pyx_result.max_neighbors_search = __pyx_state[5]; __pyx_result.n_jobs = __pyx_state[6]; __pyx_result.num_features = __pyx_state[7]; __pyx_result.num_points = __pyx_state[8]; __pyx_result.result_edges = __pyx_state[9]; __pyx_result.result_pairs_arr = __pyx_state[10]; __pyx_result.result_rank_arr = __pyx_state[11]; __pyx_result.result_values_arr = __pyx_state[12]; __pyx_result.tree = __pyx_state[13]
+ *     if len(__pyx_state) > 14 and hasattr(__pyx_result, '__dict__'):
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_2);
@@ -15446,170 +15340,14 @@
   0, /*tp_print*/
   #endif
   #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
   0, /*tp_pypy_flags*/
   #endif
 };
 #endif
-static struct __pyx_vtabstruct_5druhg_11_druhg_tree_UnionFind __pyx_vtable_5druhg_11_druhg_tree_UnionFind;
-
-static PyObject *__pyx_tp_new_5druhg_11_druhg_tree_UnionFind(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
-  struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *p;
-  PyObject *o;
-  #if CYTHON_COMPILING_IN_LIMITED_API
-  allocfunc alloc_func = (allocfunc)PyType_GetSlot(t, Py_tp_alloc);
-  o = alloc_func(t, 0);
-  #else
-  if (likely(!__Pyx_PyType_HasFeature(t, Py_TPFLAGS_IS_ABSTRACT))) {
-    o = (*t->tp_alloc)(t, 0);
-  } else {
-    o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
-  }
-  if (unlikely(!o)) return 0;
-  #endif
-  p = ((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)o);
-  p->__pyx_vtab = __pyx_vtabptr_5druhg_11_druhg_tree_UnionFind;
-  p->parent_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
-  return o;
-}
-
-static void __pyx_tp_dealloc_5druhg_11_druhg_tree_UnionFind(PyObject *o) {
-  struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *p = (struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)o;
-  #if CYTHON_USE_TP_FINALIZE
-  if (unlikely((PY_VERSION_HEX >= 0x03080000 || __Pyx_PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE)) && __Pyx_PyObject_GetSlot(o, tp_finalize, destructor)) && !_PyGC_FINALIZED(o)) {
-    if (__Pyx_PyObject_GetSlot(o, tp_dealloc, destructor) == __pyx_tp_dealloc_5druhg_11_druhg_tree_UnionFind) {
-      if (PyObject_CallFinalizerFromDealloc(o)) return;
-    }
-  }
-  #endif
-  PyObject_GC_UnTrack(o);
-  Py_CLEAR(p->parent_arr);
-  (*Py_TYPE(o)->tp_free)(o);
-}
-
-static int __pyx_tp_traverse_5druhg_11_druhg_tree_UnionFind(PyObject *o, visitproc v, void *a) {
-  int e;
-  struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *p = (struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)o;
-  if (p->parent_arr) {
-    e = (*v)(((PyObject *)p->parent_arr), a); if (e) return e;
-  }
-  return 0;
-}
-
-static int __pyx_tp_clear_5druhg_11_druhg_tree_UnionFind(PyObject *o) {
-  PyObject* tmp;
-  struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *p = (struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)o;
-  tmp = ((PyObject*)p->parent_arr);
-  p->parent_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  return 0;
-}
-
-static PyMethodDef __pyx_methods_5druhg_11_druhg_tree_UnionFind[] = {
-  {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_9UnionFind_3__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
-  {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_9UnionFind_5__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
-  {0, 0, 0, 0}
-};
-#if CYTHON_USE_TYPE_SPECS
-static PyType_Slot __pyx_type_5druhg_11_druhg_tree_UnionFind_slots[] = {
-  {Py_tp_dealloc, (void *)__pyx_tp_dealloc_5druhg_11_druhg_tree_UnionFind},
-  {Py_tp_traverse, (void *)__pyx_tp_traverse_5druhg_11_druhg_tree_UnionFind},
-  {Py_tp_clear, (void *)__pyx_tp_clear_5druhg_11_druhg_tree_UnionFind},
-  {Py_tp_methods, (void *)__pyx_methods_5druhg_11_druhg_tree_UnionFind},
-  {Py_tp_init, (void *)__pyx_pw_5druhg_11_druhg_tree_9UnionFind_1__init__},
-  {Py_tp_new, (void *)__pyx_tp_new_5druhg_11_druhg_tree_UnionFind},
-  {0, 0},
-};
-static PyType_Spec __pyx_type_5druhg_11_druhg_tree_UnionFind_spec = {
-  "druhg._druhg_tree.UnionFind",
-  sizeof(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind),
-  0,
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC,
-  __pyx_type_5druhg_11_druhg_tree_UnionFind_slots,
-};
-#else
-
-static PyTypeObject __pyx_type_5druhg_11_druhg_tree_UnionFind = {
-  PyVarObject_HEAD_INIT(0, 0)
-  "druhg._druhg_tree.""UnionFind", /*tp_name*/
-  sizeof(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind), /*tp_basicsize*/
-  0, /*tp_itemsize*/
-  __pyx_tp_dealloc_5druhg_11_druhg_tree_UnionFind, /*tp_dealloc*/
-  #if PY_VERSION_HEX < 0x030800b4
-  0, /*tp_print*/
-  #endif
-  #if PY_VERSION_HEX >= 0x030800b4
-  0, /*tp_vectorcall_offset*/
-  #endif
-  0, /*tp_getattr*/
-  0, /*tp_setattr*/
-  #if PY_MAJOR_VERSION < 3
-  0, /*tp_compare*/
-  #endif
-  #if PY_MAJOR_VERSION >= 3
-  0, /*tp_as_async*/
-  #endif
-  0, /*tp_repr*/
-  0, /*tp_as_number*/
-  0, /*tp_as_sequence*/
-  0, /*tp_as_mapping*/
-  0, /*tp_hash*/
-  0, /*tp_call*/
-  0, /*tp_str*/
-  0, /*tp_getattro*/
-  0, /*tp_setattro*/
-  0, /*tp_as_buffer*/
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
-  0, /*tp_doc*/
-  __pyx_tp_traverse_5druhg_11_druhg_tree_UnionFind, /*tp_traverse*/
-  __pyx_tp_clear_5druhg_11_druhg_tree_UnionFind, /*tp_clear*/
-  0, /*tp_richcompare*/
-  0, /*tp_weaklistoffset*/
-  0, /*tp_iter*/
-  0, /*tp_iternext*/
-  __pyx_methods_5druhg_11_druhg_tree_UnionFind, /*tp_methods*/
-  0, /*tp_members*/
-  0, /*tp_getset*/
-  0, /*tp_base*/
-  0, /*tp_dict*/
-  0, /*tp_descr_get*/
-  0, /*tp_descr_set*/
-  #if !CYTHON_USE_TYPE_SPECS
-  0, /*tp_dictoffset*/
-  #endif
-  __pyx_pw_5druhg_11_druhg_tree_9UnionFind_1__init__, /*tp_init*/
-  0, /*tp_alloc*/
-  __pyx_tp_new_5druhg_11_druhg_tree_UnionFind, /*tp_new*/
-  0, /*tp_free*/
-  0, /*tp_is_gc*/
-  0, /*tp_bases*/
-  0, /*tp_mro*/
-  0, /*tp_cache*/
-  0, /*tp_subclasses*/
-  0, /*tp_weaklist*/
-  0, /*tp_del*/
-  0, /*tp_version_tag*/
-  #if PY_VERSION_HEX >= 0x030400a1
-  #if CYTHON_USE_TP_FINALIZE
-  0, /*tp_finalize*/
-  #else
-  NULL, /*tp_finalize*/
-  #endif
-  #endif
-  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
-  0, /*tp_vectorcall*/
-  #endif
-  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
-  0, /*tp_print*/
-  #endif
-  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
-  0, /*tp_pypy_flags*/
-  #endif
-};
-#endif
 static struct __pyx_vtabstruct_5druhg_11_druhg_tree_UniversalReciprocity __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity;
 
 static PyObject *__pyx_tp_new_5druhg_11_druhg_tree_UniversalReciprocity(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
   struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *p;
   PyObject *o;
   #if CYTHON_COMPILING_IN_LIMITED_API
   allocfunc alloc_func = (allocfunc)PyType_GetSlot(t, Py_tp_alloc);
@@ -15622,17 +15360,20 @@
   }
   if (unlikely(!o)) return 0;
   #endif
   p = ((struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)o);
   p->__pyx_vtab = __pyx_vtabptr_5druhg_11_druhg_tree_UniversalReciprocity;
   p->tree = Py_None; Py_INCREF(Py_None);
   p->dist_tree = Py_None; Py_INCREF(Py_None);
-  p->U = ((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)Py_None); Py_INCREF(Py_None);
-  p->result_value_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  p->U = ((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)Py_None); Py_INCREF(Py_None);
+  p->result_values_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
   p->result_pairs_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  p->result_rank_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  p->knn_d = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  p->knn_i = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
   return o;
 }
 
 static void __pyx_tp_dealloc_5druhg_11_druhg_tree_UniversalReciprocity(PyObject *o) {
   struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *p = (struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)o;
   #if CYTHON_USE_TP_FINALIZE
   if (unlikely((PY_VERSION_HEX >= 0x03080000 || __Pyx_PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE)) && __Pyx_PyObject_GetSlot(o, tp_finalize, destructor)) && !_PyGC_FINALIZED(o)) {
@@ -15641,16 +15382,19 @@
     }
   }
   #endif
   PyObject_GC_UnTrack(o);
   Py_CLEAR(p->tree);
   Py_CLEAR(p->dist_tree);
   Py_CLEAR(p->U);
-  Py_CLEAR(p->result_value_arr);
+  Py_CLEAR(p->result_values_arr);
   Py_CLEAR(p->result_pairs_arr);
+  Py_CLEAR(p->result_rank_arr);
+  Py_CLEAR(p->knn_d);
+  Py_CLEAR(p->knn_i);
   (*Py_TYPE(o)->tp_free)(o);
 }
 
 static int __pyx_tp_traverse_5druhg_11_druhg_tree_UniversalReciprocity(PyObject *o, visitproc v, void *a) {
   int e;
   struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *p = (struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)o;
   if (p->tree) {
@@ -15658,56 +15402,107 @@
   }
   if (p->dist_tree) {
     e = (*v)(p->dist_tree, a); if (e) return e;
   }
   if (p->U) {
     e = (*v)(((PyObject *)p->U), a); if (e) return e;
   }
-  if (p->result_value_arr) {
-    e = (*v)(((PyObject *)p->result_value_arr), a); if (e) return e;
+  if (p->result_values_arr) {
+    e = (*v)(((PyObject *)p->result_values_arr), a); if (e) return e;
   }
   if (p->result_pairs_arr) {
     e = (*v)(((PyObject *)p->result_pairs_arr), a); if (e) return e;
   }
+  if (p->result_rank_arr) {
+    e = (*v)(((PyObject *)p->result_rank_arr), a); if (e) return e;
+  }
+  if (p->knn_d) {
+    e = (*v)(((PyObject *)p->knn_d), a); if (e) return e;
+  }
+  if (p->knn_i) {
+    e = (*v)(((PyObject *)p->knn_i), a); if (e) return e;
+  }
   return 0;
 }
 
 static int __pyx_tp_clear_5druhg_11_druhg_tree_UniversalReciprocity(PyObject *o) {
   PyObject* tmp;
   struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *p = (struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *)o;
   tmp = ((PyObject*)p->tree);
   p->tree = Py_None; Py_INCREF(Py_None);
   Py_XDECREF(tmp);
   tmp = ((PyObject*)p->dist_tree);
   p->dist_tree = Py_None; Py_INCREF(Py_None);
   Py_XDECREF(tmp);
   tmp = ((PyObject*)p->U);
-  p->U = ((struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *)Py_None); Py_INCREF(Py_None);
+  p->U = ((struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind *)Py_None); Py_INCREF(Py_None);
   Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->result_value_arr);
-  p->result_value_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  tmp = ((PyObject*)p->result_values_arr);
+  p->result_values_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
   Py_XDECREF(tmp);
   tmp = ((PyObject*)p->result_pairs_arr);
   p->result_pairs_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
   Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->result_rank_arr);
+  p->result_rank_arr = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->knn_d);
+  p->knn_d = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->knn_i);
+  p->knn_i = ((PyArrayObject *)Py_None); Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
   return 0;
 }
 
+static PyObject *__pyx_getprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_d(PyObject *o, CYTHON_UNUSED void *x) {
+  return __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_1__get__(o);
+}
+
+static int __pyx_setprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_d(PyObject *o, PyObject *v, CYTHON_UNUSED void *x) {
+  if (v) {
+    return __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_3__set__(o, v);
+  }
+  else {
+    return __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_d_5__del__(o);
+  }
+}
+
+static PyObject *__pyx_getprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_i(PyObject *o, CYTHON_UNUSED void *x) {
+  return __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_1__get__(o);
+}
+
+static int __pyx_setprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_i(PyObject *o, PyObject *v, CYTHON_UNUSED void *x) {
+  if (v) {
+    return __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_3__set__(o, v);
+  }
+  else {
+    return __pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_5knn_i_5__del__(o);
+  }
+}
+
 static PyMethodDef __pyx_methods_5druhg_11_druhg_tree_UniversalReciprocity[] = {
   {"__reduce_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_7__reduce_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
   {"__setstate_cython__", (PyCFunction)(void*)(__Pyx_PyCFunction_FastCallWithKeywords)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_9__setstate_cython__, __Pyx_METH_FASTCALL|METH_KEYWORDS, 0},
   {0, 0, 0, 0}
 };
+
+static struct PyGetSetDef __pyx_getsets_5druhg_11_druhg_tree_UniversalReciprocity[] = {
+  {(char *)"knn_d", __pyx_getprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_d, __pyx_setprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_d, (char *)0, 0},
+  {(char *)"knn_i", __pyx_getprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_i, __pyx_setprop_5druhg_11_druhg_tree_20UniversalReciprocity_knn_i, (char *)0, 0},
+  {0, 0, 0, 0, 0}
+};
 #if CYTHON_USE_TYPE_SPECS
 static PyType_Slot __pyx_type_5druhg_11_druhg_tree_UniversalReciprocity_slots[] = {
   {Py_tp_dealloc, (void *)__pyx_tp_dealloc_5druhg_11_druhg_tree_UniversalReciprocity},
   {Py_tp_doc, (void *)PyDoc_STR("Constructs DRUHG spanning tree and marks parents of clusters\n\n    Parameters\n    ----------\n\n    algorithm : int\n        0/1 - for KDTree/BallTree object\n        2/3 - for a full/scipy.sparse precomputed pairwise squared distance matrix\n\n    data: object\n        Pass KDTree/BallTree objects or pairwise matrix.\n\n    max_neighbors_search : int, optional (default= 16)\n        The max_neighbors_search parameter of DRUHG.\n        Effects performance vs precision.\n        Default is more than enough.\n\n    metric : string, optional (default='euclidean')\n        The metric used to compute distances for the tree.\n        Used only with KDTree/BallTree option.\n\n    leaf_size : int, optional (default=20)\n        sklearn K-NearestNeighbor uses it.\n        Used only with KDTree/BallTree option.\n\n    **kwargs :\n        Keyword args passed to the metric.\n        Used only with KDTree/BallTree option.\n    ")},
   {Py_tp_traverse, (void *)__pyx_tp_traverse_5druhg_11_druhg_tree_UniversalReciprocity},
   {Py_tp_clear, (void *)__pyx_tp_clear_5druhg_11_druhg_tree_UniversalReciprocity},
   {Py_tp_methods, (void *)__pyx_methods_5druhg_11_druhg_tree_UniversalReciprocity},
+  {Py_tp_getset, (void *)__pyx_getsets_5druhg_11_druhg_tree_UniversalReciprocity},
   {Py_tp_init, (void *)__pyx_pw_5druhg_11_druhg_tree_20UniversalReciprocity_1__init__},
   {Py_tp_new, (void *)__pyx_tp_new_5druhg_11_druhg_tree_UniversalReciprocity},
   {0, 0},
 };
 static PyType_Spec __pyx_type_5druhg_11_druhg_tree_UniversalReciprocity_spec = {
   "druhg._druhg_tree.UniversalReciprocity",
   sizeof(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity),
@@ -15753,15 +15548,15 @@
   __pyx_tp_clear_5druhg_11_druhg_tree_UniversalReciprocity, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
   __pyx_methods_5druhg_11_druhg_tree_UniversalReciprocity, /*tp_methods*/
   0, /*tp_members*/
-  0, /*tp_getset*/
+  __pyx_getsets_5druhg_11_druhg_tree_UniversalReciprocity, /*tp_getset*/
   0, /*tp_base*/
   0, /*tp_dict*/
   0, /*tp_descr_get*/
   0, /*tp_descr_set*/
   #if !CYTHON_USE_TYPE_SPECS
   0, /*tp_dictoffset*/
   #endif
@@ -16109,137 +15904,154 @@
 
 static __Pyx_StringTabEntry __pyx_string_tab[] = {
   #if CYTHON_USE_MODULE_STATE
   {0, __pyx_k_A_lot_of_values, sizeof(__pyx_k_A_lot_of_values), 0, 1, 0, 0},
   {0, __pyx_k_Attention_Sparse_matrix_has_an_e, sizeof(__pyx_k_Attention_Sparse_matrix_has_an_e), 0, 1, 0, 0},
   {0, __pyx_k_BallTree, sizeof(__pyx_k_BallTree), 0, 0, 1, 1},
   {0, __pyx_k_Distances_cannot_be_negative_Exi, sizeof(__pyx_k_Distances_cannot_be_negative_Exi), 0, 1, 0, 0},
+  {0, __pyx_k_ERROR_edgepairs_buffer_is_too_sm, sizeof(__pyx_k_ERROR_edgepairs_buffer_is_too_sm), 0, 1, 0, 0},
+  {0, __pyx_k_ERROR_ranks_buffer_is_too_small, sizeof(__pyx_k_ERROR_ranks_buffer_is_too_small), 0, 1, 0, 0},
+  {0, __pyx_k_ERROR_values_buffer_is_too_small, sizeof(__pyx_k_ERROR_values_buffer_is_too_small), 0, 1, 0, 0},
   {0, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
   {0, __pyx_k_Incompatible_checksums_s_vs_0x14, sizeof(__pyx_k_Incompatible_checksums_s_vs_0x14), 0, 0, 1, 0},
-  {0, __pyx_k_Incompatible_checksums_s_vs_0xdf, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xdf), 0, 0, 1, 0},
+  {0, __pyx_k_Incompatible_checksums_s_vs_0xc3, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xc3), 0, 0, 1, 0},
+  {0, __pyx_k_It_is_a_forest_Try_increasing_m, sizeof(__pyx_k_It_is_a_forest_Try_increasing_m), 0, 1, 0, 0},
   {0, __pyx_k_KDTree, sizeof(__pyx_k_KDTree), 0, 0, 1, 1},
   {0, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeGeneric, sizeof(__pyx_k_PairwiseDistanceTreeGeneric), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeGeneric___re, sizeof(__pyx_k_PairwiseDistanceTreeGeneric___re), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeGeneric___se, sizeof(__pyx_k_PairwiseDistanceTreeGeneric___se), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeGeneric_quer, sizeof(__pyx_k_PairwiseDistanceTreeGeneric_quer), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeSparse, sizeof(__pyx_k_PairwiseDistanceTreeSparse), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeSparse___red, sizeof(__pyx_k_PairwiseDistanceTreeSparse___red), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeSparse___set, sizeof(__pyx_k_PairwiseDistanceTreeSparse___set), 0, 0, 1, 1},
   {0, __pyx_k_PairwiseDistanceTreeSparse_query, sizeof(__pyx_k_PairwiseDistanceTreeSparse_query), 0, 0, 1, 1},
   {0, __pyx_k_Parallel, sizeof(__pyx_k_Parallel), 0, 0, 1, 1},
   {0, __pyx_k_PickleError, sizeof(__pyx_k_PickleError), 0, 0, 1, 1},
   {0, __pyx_k_Some_distances, sizeof(__pyx_k_Some_distances), 0, 1, 0, 0},
   {0, __pyx_k_Two_subjects_only, sizeof(__pyx_k_Two_subjects_only), 0, 1, 0, 0},
-  {0, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
   {0, __pyx_k_UnionFind, sizeof(__pyx_k_UnionFind), 0, 0, 1, 1},
-  {0, __pyx_k_UnionFind___reduce_cython, sizeof(__pyx_k_UnionFind___reduce_cython), 0, 0, 1, 1},
-  {0, __pyx_k_UnionFind___setstate_cython, sizeof(__pyx_k_UnionFind___setstate_cython), 0, 0, 1, 1},
   {0, __pyx_k_UniversalReciprocity, sizeof(__pyx_k_UniversalReciprocity), 0, 0, 1, 1},
   {0, __pyx_k_UniversalReciprocity___reduce_cy, sizeof(__pyx_k_UniversalReciprocity___reduce_cy), 0, 0, 1, 1},
   {0, __pyx_k_UniversalReciprocity___setstate, sizeof(__pyx_k_UniversalReciprocity___setstate), 0, 0, 1, 1},
   {0, __pyx_k_UniversalReciprocity__compute_tr, sizeof(__pyx_k_UniversalReciprocity__compute_tr), 0, 0, 1, 1},
-  {0, __pyx_k_UniversalReciprocity_get_extras, sizeof(__pyx_k_UniversalReciprocity_get_extras), 0, 0, 1, 1},
+  {0, __pyx_k_UniversalReciprocity_get_buffers, sizeof(__pyx_k_UniversalReciprocity_get_buffers), 0, 0, 1, 1},
   {0, __pyx_k_UniversalReciprocity_get_tree, sizeof(__pyx_k_UniversalReciprocity_get_tree), 0, 0, 1, 1},
   {0, __pyx_k_ValueError, sizeof(__pyx_k_ValueError), 0, 0, 1, 1},
   {0, __pyx_k__2, sizeof(__pyx_k__2), 0, 1, 0, 0},
-  {0, __pyx_k__27, sizeof(__pyx_k__27), 0, 0, 1, 1},
+  {0, __pyx_k__29, sizeof(__pyx_k__29), 0, 0, 1, 1},
   {0, __pyx_k__5, sizeof(__pyx_k__5), 0, 0, 1, 1},
   {0, __pyx_k_algorithm, sizeof(__pyx_k_algorithm), 0, 0, 1, 1},
   {0, __pyx_k_algorithm_value, sizeof(__pyx_k_algorithm_value), 0, 1, 0, 0},
+  {0, __pyx_k_allocate_buffer_edgepairs, sizeof(__pyx_k_allocate_buffer_edgepairs), 0, 0, 1, 1},
+  {0, __pyx_k_allocate_buffer_ranks, sizeof(__pyx_k_allocate_buffer_ranks), 0, 0, 1, 1},
+  {0, __pyx_k_allocate_buffer_values, sizeof(__pyx_k_allocate_buffer_values), 0, 0, 1, 1},
   {0, __pyx_k_are_smaller_than_self_PRECISION, sizeof(__pyx_k_are_smaller_than_self_PRECISION), 0, 1, 0, 0},
   {0, __pyx_k_are_the_same_Try_increasing_max, sizeof(__pyx_k_are_the_same_Try_increasing_max), 0, 1, 0, 0},
   {0, __pyx_k_args, sizeof(__pyx_k_args), 0, 0, 1, 1},
   {0, __pyx_k_argsort, sizeof(__pyx_k_argsort), 0, 0, 1, 1},
   {0, __pyx_k_asarray, sizeof(__pyx_k_asarray), 0, 0, 1, 1},
   {0, __pyx_k_astype, sizeof(__pyx_k_astype), 0, 0, 1, 1},
   {0, __pyx_k_asyncio_coroutines, sizeof(__pyx_k_asyncio_coroutines), 0, 0, 1, 1},
   {0, __pyx_k_bisect, sizeof(__pyx_k_bisect), 0, 0, 1, 1},
   {0, __pyx_k_breadth_first, sizeof(__pyx_k_breadth_first), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_edgepairs, sizeof(__pyx_k_buffer_edgepairs), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_fast, sizeof(__pyx_k_buffer_fast), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_ranks, sizeof(__pyx_k_buffer_ranks), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_uf, sizeof(__pyx_k_buffer_uf), 0, 0, 1, 1},
+  {0, __pyx_k_buffer_values, sizeof(__pyx_k_buffer_values), 0, 0, 1, 1},
   {0, __pyx_k_class_getitem, sizeof(__pyx_k_class_getitem), 0, 0, 1, 1},
   {0, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
   {0, __pyx_k_close, sizeof(__pyx_k_close), 0, 0, 1, 1},
+  {0, __pyx_k_cyheapq, sizeof(__pyx_k_cyheapq), 0, 0, 1, 1},
   {0, __pyx_k_d, sizeof(__pyx_k_d), 0, 0, 1, 1},
   {0, __pyx_k_data, sizeof(__pyx_k_data), 0, 0, 1, 1},
   {0, __pyx_k_delayed, sizeof(__pyx_k_delayed), 0, 0, 1, 1},
   {0, __pyx_k_dict, sizeof(__pyx_k_dict), 0, 0, 1, 1},
   {0, __pyx_k_dict_2, sizeof(__pyx_k_dict_2), 0, 0, 1, 1},
   {0, __pyx_k_disable, sizeof(__pyx_k_disable), 0, 1, 0, 0},
+  {0, __pyx_k_double, sizeof(__pyx_k_double), 0, 0, 1, 1},
   {0, __pyx_k_double_precision, sizeof(__pyx_k_double_precision), 0, 1, 0, 1},
   {0, __pyx_k_druhg__druhg_tree, sizeof(__pyx_k_druhg__druhg_tree), 0, 0, 1, 1},
   {0, __pyx_k_druhg__druhg_tree_pyx, sizeof(__pyx_k_druhg__druhg_tree_pyx), 0, 0, 1, 0},
+  {0, __pyx_k_druhg_unionfind, sizeof(__pyx_k_druhg_unionfind), 0, 0, 1, 1},
   {0, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
   {0, __pyx_k_dualtree, sizeof(__pyx_k_dualtree), 0, 0, 1, 1},
+  {0, __pyx_k_edges_with_the_max_rank_Try_inc, sizeof(__pyx_k_edges_with_the_max_rank_Try_inc), 0, 1, 0, 0},
   {0, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
   {0, __pyx_k_enable, sizeof(__pyx_k_enable), 0, 1, 0, 0},
+  {0, __pyx_k_endpoint, sizeof(__pyx_k_endpoint), 0, 0, 1, 1},
   {0, __pyx_k_euclidean, sizeof(__pyx_k_euclidean), 0, 1, 0, 1},
   {0, __pyx_k_float_info, sizeof(__pyx_k_float_info), 0, 0, 1, 1},
   {0, __pyx_k_for_a_better_result, sizeof(__pyx_k_for_a_better_result), 0, 1, 0, 0},
   {0, __pyx_k_gc, sizeof(__pyx_k_gc), 0, 1, 0, 0},
   {0, __pyx_k_genexpr, sizeof(__pyx_k_genexpr), 0, 0, 1, 1},
   {0, __pyx_k_get, sizeof(__pyx_k_get), 0, 0, 1, 1},
-  {0, __pyx_k_get_extras, sizeof(__pyx_k_get_extras), 0, 0, 1, 1},
+  {0, __pyx_k_get_buffers, sizeof(__pyx_k_get_buffers), 0, 0, 1, 1},
   {0, __pyx_k_get_tree, sizeof(__pyx_k_get_tree), 0, 0, 1, 1},
   {0, __pyx_k_getrow, sizeof(__pyx_k_getrow), 0, 0, 1, 1},
   {0, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
   {0, __pyx_k_heappop, sizeof(__pyx_k_heappop), 0, 0, 1, 1},
   {0, __pyx_k_heappush, sizeof(__pyx_k_heappush), 0, 0, 1, 1},
   {0, __pyx_k_heapq, sizeof(__pyx_k_heapq), 0, 0, 1, 1},
   {0, __pyx_k_heapq_2, sizeof(__pyx_k_heapq_2), 0, 0, 1, 1},
+  {0, __pyx_k_heapq_merge, sizeof(__pyx_k_heapq_merge), 0, 0, 1, 1},
   {0, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {0, __pyx_k_indices, sizeof(__pyx_k_indices), 0, 0, 1, 1},
   {0, __pyx_k_initializing, sizeof(__pyx_k_initializing), 0, 0, 1, 1},
   {0, __pyx_k_intp, sizeof(__pyx_k_intp), 0, 0, 1, 1},
   {0, __pyx_k_is_coroutine, sizeof(__pyx_k_is_coroutine), 0, 0, 1, 1},
   {0, __pyx_k_is_not_valid, sizeof(__pyx_k_is_not_valid), 0, 1, 0, 0},
-  {0, __pyx_k_is_slow, sizeof(__pyx_k_is_slow), 0, 0, 1, 1},
   {0, __pyx_k_isenabled, sizeof(__pyx_k_isenabled), 0, 1, 0, 0},
   {0, __pyx_k_items, sizeof(__pyx_k_items), 0, 0, 1, 1},
   {0, __pyx_k_joblib, sizeof(__pyx_k_joblib), 0, 0, 1, 1},
   {0, __pyx_k_k, sizeof(__pyx_k_k), 0, 0, 1, 1},
   {0, __pyx_k_leaf_size, sizeof(__pyx_k_leaf_size), 0, 0, 1, 1},
   {0, __pyx_k_level_Try_decreasing_double_pre, sizeof(__pyx_k_level_Try_decreasing_double_pre), 0, 1, 0, 0},
   {0, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
   {0, __pyx_k_max, sizeof(__pyx_k_max), 0, 0, 1, 1},
   {0, __pyx_k_max_neighbors_search, sizeof(__pyx_k_max_neighbors_search), 0, 0, 1, 1},
+  {0, __pyx_k_max_rank, sizeof(__pyx_k_max_rank), 0, 0, 1, 1},
+  {0, __pyx_k_merge, sizeof(__pyx_k_merge), 0, 0, 1, 1},
   {0, __pyx_k_metric, sizeof(__pyx_k_metric), 0, 0, 1, 1},
   {0, __pyx_k_n_jobs, sizeof(__pyx_k_n_jobs), 0, 0, 1, 1},
   {0, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
   {0, __pyx_k_new, sizeof(__pyx_k_new), 0, 0, 1, 1},
-  {0, __pyx_k_not_connected_edges_It_is_a_for, sizeof(__pyx_k_not_connected_edges_It_is_a_for), 0, 1, 0, 0},
+  {0, __pyx_k_not_connected_edges_of, sizeof(__pyx_k_not_connected_edges_of), 0, 1, 0, 0},
   {0, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
+  {0, __pyx_k_num_points, sizeof(__pyx_k_num_points), 0, 0, 1, 1},
   {0, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {0, __pyx_k_numpy_core_multiarray_failed_to, sizeof(__pyx_k_numpy_core_multiarray_failed_to), 0, 0, 1, 0},
   {0, __pyx_k_numpy_core_umath_failed_to_impor, sizeof(__pyx_k_numpy_core_umath_failed_to_impor), 0, 0, 1, 0},
   {0, __pyx_k_ones, sizeof(__pyx_k_ones), 0, 0, 1, 1},
+  {0, __pyx_k_or_pick_the_square_mode_not_avai, sizeof(__pyx_k_or_pick_the_square_mode_not_avai), 0, 1, 0, 0},
   {0, __pyx_k_parameter, sizeof(__pyx_k_parameter), 0, 1, 0, 0},
   {0, __pyx_k_pickle, sizeof(__pyx_k_pickle), 0, 0, 1, 1},
   {0, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
   {0, __pyx_k_pyx_PickleError, sizeof(__pyx_k_pyx_PickleError), 0, 0, 1, 1},
   {0, __pyx_k_pyx_checksum, sizeof(__pyx_k_pyx_checksum), 0, 0, 1, 1},
   {0, __pyx_k_pyx_result, sizeof(__pyx_k_pyx_result), 0, 0, 1, 1},
   {0, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
   {0, __pyx_k_pyx_type, sizeof(__pyx_k_pyx_type), 0, 0, 1, 1},
   {0, __pyx_k_pyx_unpickle_PairwiseDistanceT, sizeof(__pyx_k_pyx_unpickle_PairwiseDistanceT), 0, 0, 1, 1},
   {0, __pyx_k_pyx_unpickle_PairwiseDistanceT_2, sizeof(__pyx_k_pyx_unpickle_PairwiseDistanceT_2), 0, 0, 1, 1},
   {0, __pyx_k_pyx_unpickle_UniversalReciproc, sizeof(__pyx_k_pyx_unpickle_UniversalReciproc), 0, 0, 1, 1},
   {0, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {0, __pyx_k_query, sizeof(__pyx_k_query), 0, 0, 1, 1},
   {0, __pyx_k_range, sizeof(__pyx_k_range), 0, 0, 1, 1},
+  {0, __pyx_k_reciprocity, sizeof(__pyx_k_reciprocity), 0, 0, 1, 1},
   {0, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
   {0, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
   {0, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
-  {0, __pyx_k_result_extras1_arr, sizeof(__pyx_k_result_extras1_arr), 0, 0, 1, 1},
-  {0, __pyx_k_result_extras2_arr, sizeof(__pyx_k_result_extras2_arr), 0, 0, 1, 1},
   {0, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
-  {0, __pyx_k_self_parent_cannot_be_converted, sizeof(__pyx_k_self_parent_cannot_be_converted), 0, 0, 1, 0},
   {0, __pyx_k_send, sizeof(__pyx_k_send), 0, 0, 1, 1},
   {0, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
   {0, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
   {0, __pyx_k_shape, sizeof(__pyx_k_shape), 0, 0, 1, 1},
+  {0, __pyx_k_skip_first, sizeof(__pyx_k_skip_first), 0, 0, 1, 1},
   {0, __pyx_k_sklearn_neighbors, sizeof(__pyx_k_sklearn_neighbors), 0, 0, 1, 1},
   {0, __pyx_k_spec, sizeof(__pyx_k_spec), 0, 0, 1, 1},
   {0, __pyx_k_state, sizeof(__pyx_k_state), 0, 0, 1, 1},
   {0, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
   {0, __pyx_k_sys, sizeof(__pyx_k_sys), 0, 0, 1, 1},
   {0, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
   {0, __pyx_k_throw, sizeof(__pyx_k_throw), 0, 0, 1, 1},
@@ -16249,137 +16061,154 @@
   {0, __pyx_k_vstack, sizeof(__pyx_k_vstack), 0, 0, 1, 1},
   {0, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   #else
   {&__pyx_kp_u_A_lot_of_values, __pyx_k_A_lot_of_values, sizeof(__pyx_k_A_lot_of_values), 0, 1, 0, 0},
   {&__pyx_kp_u_Attention_Sparse_matrix_has_an_e, __pyx_k_Attention_Sparse_matrix_has_an_e, sizeof(__pyx_k_Attention_Sparse_matrix_has_an_e), 0, 1, 0, 0},
   {&__pyx_n_s_BallTree, __pyx_k_BallTree, sizeof(__pyx_k_BallTree), 0, 0, 1, 1},
   {&__pyx_kp_u_Distances_cannot_be_negative_Exi, __pyx_k_Distances_cannot_be_negative_Exi, sizeof(__pyx_k_Distances_cannot_be_negative_Exi), 0, 1, 0, 0},
+  {&__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm, __pyx_k_ERROR_edgepairs_buffer_is_too_sm, sizeof(__pyx_k_ERROR_edgepairs_buffer_is_too_sm), 0, 1, 0, 0},
+  {&__pyx_kp_u_ERROR_ranks_buffer_is_too_small, __pyx_k_ERROR_ranks_buffer_is_too_small, sizeof(__pyx_k_ERROR_ranks_buffer_is_too_small), 0, 1, 0, 0},
+  {&__pyx_kp_u_ERROR_values_buffer_is_too_small, __pyx_k_ERROR_values_buffer_is_too_small, sizeof(__pyx_k_ERROR_values_buffer_is_too_small), 0, 1, 0, 0},
   {&__pyx_n_s_ImportError, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
   {&__pyx_kp_s_Incompatible_checksums_s_vs_0x14, __pyx_k_Incompatible_checksums_s_vs_0x14, sizeof(__pyx_k_Incompatible_checksums_s_vs_0x14), 0, 0, 1, 0},
-  {&__pyx_kp_s_Incompatible_checksums_s_vs_0xdf, __pyx_k_Incompatible_checksums_s_vs_0xdf, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xdf), 0, 0, 1, 0},
+  {&__pyx_kp_s_Incompatible_checksums_s_vs_0xc3, __pyx_k_Incompatible_checksums_s_vs_0xc3, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xc3), 0, 0, 1, 0},
+  {&__pyx_kp_u_It_is_a_forest_Try_increasing_m, __pyx_k_It_is_a_forest_Try_increasing_m, sizeof(__pyx_k_It_is_a_forest_Try_increasing_m), 0, 1, 0, 0},
   {&__pyx_n_s_KDTree, __pyx_k_KDTree, sizeof(__pyx_k_KDTree), 0, 0, 1, 1},
   {&__pyx_n_s_N, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeGeneric, __pyx_k_PairwiseDistanceTreeGeneric, sizeof(__pyx_k_PairwiseDistanceTreeGeneric), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeGeneric___re, __pyx_k_PairwiseDistanceTreeGeneric___re, sizeof(__pyx_k_PairwiseDistanceTreeGeneric___re), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeGeneric___se, __pyx_k_PairwiseDistanceTreeGeneric___se, sizeof(__pyx_k_PairwiseDistanceTreeGeneric___se), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeGeneric_quer, __pyx_k_PairwiseDistanceTreeGeneric_quer, sizeof(__pyx_k_PairwiseDistanceTreeGeneric_quer), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeSparse, __pyx_k_PairwiseDistanceTreeSparse, sizeof(__pyx_k_PairwiseDistanceTreeSparse), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeSparse___red, __pyx_k_PairwiseDistanceTreeSparse___red, sizeof(__pyx_k_PairwiseDistanceTreeSparse___red), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeSparse___set, __pyx_k_PairwiseDistanceTreeSparse___set, sizeof(__pyx_k_PairwiseDistanceTreeSparse___set), 0, 0, 1, 1},
   {&__pyx_n_s_PairwiseDistanceTreeSparse_query, __pyx_k_PairwiseDistanceTreeSparse_query, sizeof(__pyx_k_PairwiseDistanceTreeSparse_query), 0, 0, 1, 1},
   {&__pyx_n_s_Parallel, __pyx_k_Parallel, sizeof(__pyx_k_Parallel), 0, 0, 1, 1},
   {&__pyx_n_s_PickleError, __pyx_k_PickleError, sizeof(__pyx_k_PickleError), 0, 0, 1, 1},
   {&__pyx_kp_u_Some_distances, __pyx_k_Some_distances, sizeof(__pyx_k_Some_distances), 0, 1, 0, 0},
   {&__pyx_kp_u_Two_subjects_only, __pyx_k_Two_subjects_only, sizeof(__pyx_k_Two_subjects_only), 0, 1, 0, 0},
-  {&__pyx_n_s_TypeError, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
   {&__pyx_n_s_UnionFind, __pyx_k_UnionFind, sizeof(__pyx_k_UnionFind), 0, 0, 1, 1},
-  {&__pyx_n_s_UnionFind___reduce_cython, __pyx_k_UnionFind___reduce_cython, sizeof(__pyx_k_UnionFind___reduce_cython), 0, 0, 1, 1},
-  {&__pyx_n_s_UnionFind___setstate_cython, __pyx_k_UnionFind___setstate_cython, sizeof(__pyx_k_UnionFind___setstate_cython), 0, 0, 1, 1},
   {&__pyx_n_s_UniversalReciprocity, __pyx_k_UniversalReciprocity, sizeof(__pyx_k_UniversalReciprocity), 0, 0, 1, 1},
   {&__pyx_n_s_UniversalReciprocity___reduce_cy, __pyx_k_UniversalReciprocity___reduce_cy, sizeof(__pyx_k_UniversalReciprocity___reduce_cy), 0, 0, 1, 1},
   {&__pyx_n_s_UniversalReciprocity___setstate, __pyx_k_UniversalReciprocity___setstate, sizeof(__pyx_k_UniversalReciprocity___setstate), 0, 0, 1, 1},
   {&__pyx_n_s_UniversalReciprocity__compute_tr, __pyx_k_UniversalReciprocity__compute_tr, sizeof(__pyx_k_UniversalReciprocity__compute_tr), 0, 0, 1, 1},
-  {&__pyx_n_s_UniversalReciprocity_get_extras, __pyx_k_UniversalReciprocity_get_extras, sizeof(__pyx_k_UniversalReciprocity_get_extras), 0, 0, 1, 1},
+  {&__pyx_n_s_UniversalReciprocity_get_buffers, __pyx_k_UniversalReciprocity_get_buffers, sizeof(__pyx_k_UniversalReciprocity_get_buffers), 0, 0, 1, 1},
   {&__pyx_n_s_UniversalReciprocity_get_tree, __pyx_k_UniversalReciprocity_get_tree, sizeof(__pyx_k_UniversalReciprocity_get_tree), 0, 0, 1, 1},
   {&__pyx_n_s_ValueError, __pyx_k_ValueError, sizeof(__pyx_k_ValueError), 0, 0, 1, 1},
   {&__pyx_kp_u__2, __pyx_k__2, sizeof(__pyx_k__2), 0, 1, 0, 0},
-  {&__pyx_n_s__27, __pyx_k__27, sizeof(__pyx_k__27), 0, 0, 1, 1},
+  {&__pyx_n_s__29, __pyx_k__29, sizeof(__pyx_k__29), 0, 0, 1, 1},
   {&__pyx_n_s__5, __pyx_k__5, sizeof(__pyx_k__5), 0, 0, 1, 1},
   {&__pyx_n_s_algorithm, __pyx_k_algorithm, sizeof(__pyx_k_algorithm), 0, 0, 1, 1},
   {&__pyx_kp_u_algorithm_value, __pyx_k_algorithm_value, sizeof(__pyx_k_algorithm_value), 0, 1, 0, 0},
+  {&__pyx_n_s_allocate_buffer_edgepairs, __pyx_k_allocate_buffer_edgepairs, sizeof(__pyx_k_allocate_buffer_edgepairs), 0, 0, 1, 1},
+  {&__pyx_n_s_allocate_buffer_ranks, __pyx_k_allocate_buffer_ranks, sizeof(__pyx_k_allocate_buffer_ranks), 0, 0, 1, 1},
+  {&__pyx_n_s_allocate_buffer_values, __pyx_k_allocate_buffer_values, sizeof(__pyx_k_allocate_buffer_values), 0, 0, 1, 1},
   {&__pyx_kp_u_are_smaller_than_self_PRECISION, __pyx_k_are_smaller_than_self_PRECISION, sizeof(__pyx_k_are_smaller_than_self_PRECISION), 0, 1, 0, 0},
   {&__pyx_kp_u_are_the_same_Try_increasing_max, __pyx_k_are_the_same_Try_increasing_max, sizeof(__pyx_k_are_the_same_Try_increasing_max), 0, 1, 0, 0},
   {&__pyx_n_s_args, __pyx_k_args, sizeof(__pyx_k_args), 0, 0, 1, 1},
   {&__pyx_n_s_argsort, __pyx_k_argsort, sizeof(__pyx_k_argsort), 0, 0, 1, 1},
   {&__pyx_n_s_asarray, __pyx_k_asarray, sizeof(__pyx_k_asarray), 0, 0, 1, 1},
   {&__pyx_n_s_astype, __pyx_k_astype, sizeof(__pyx_k_astype), 0, 0, 1, 1},
   {&__pyx_n_s_asyncio_coroutines, __pyx_k_asyncio_coroutines, sizeof(__pyx_k_asyncio_coroutines), 0, 0, 1, 1},
   {&__pyx_n_s_bisect, __pyx_k_bisect, sizeof(__pyx_k_bisect), 0, 0, 1, 1},
   {&__pyx_n_s_breadth_first, __pyx_k_breadth_first, sizeof(__pyx_k_breadth_first), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_edgepairs, __pyx_k_buffer_edgepairs, sizeof(__pyx_k_buffer_edgepairs), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_fast, __pyx_k_buffer_fast, sizeof(__pyx_k_buffer_fast), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_ranks, __pyx_k_buffer_ranks, sizeof(__pyx_k_buffer_ranks), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_uf, __pyx_k_buffer_uf, sizeof(__pyx_k_buffer_uf), 0, 0, 1, 1},
+  {&__pyx_n_s_buffer_values, __pyx_k_buffer_values, sizeof(__pyx_k_buffer_values), 0, 0, 1, 1},
   {&__pyx_n_s_class_getitem, __pyx_k_class_getitem, sizeof(__pyx_k_class_getitem), 0, 0, 1, 1},
   {&__pyx_n_s_cline_in_traceback, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
   {&__pyx_n_s_close, __pyx_k_close, sizeof(__pyx_k_close), 0, 0, 1, 1},
+  {&__pyx_n_s_cyheapq, __pyx_k_cyheapq, sizeof(__pyx_k_cyheapq), 0, 0, 1, 1},
   {&__pyx_n_s_d, __pyx_k_d, sizeof(__pyx_k_d), 0, 0, 1, 1},
   {&__pyx_n_s_data, __pyx_k_data, sizeof(__pyx_k_data), 0, 0, 1, 1},
   {&__pyx_n_s_delayed, __pyx_k_delayed, sizeof(__pyx_k_delayed), 0, 0, 1, 1},
   {&__pyx_n_s_dict, __pyx_k_dict, sizeof(__pyx_k_dict), 0, 0, 1, 1},
   {&__pyx_n_s_dict_2, __pyx_k_dict_2, sizeof(__pyx_k_dict_2), 0, 0, 1, 1},
   {&__pyx_kp_u_disable, __pyx_k_disable, sizeof(__pyx_k_disable), 0, 1, 0, 0},
+  {&__pyx_n_s_double, __pyx_k_double, sizeof(__pyx_k_double), 0, 0, 1, 1},
   {&__pyx_n_u_double_precision, __pyx_k_double_precision, sizeof(__pyx_k_double_precision), 0, 1, 0, 1},
   {&__pyx_n_s_druhg__druhg_tree, __pyx_k_druhg__druhg_tree, sizeof(__pyx_k_druhg__druhg_tree), 0, 0, 1, 1},
   {&__pyx_kp_s_druhg__druhg_tree_pyx, __pyx_k_druhg__druhg_tree_pyx, sizeof(__pyx_k_druhg__druhg_tree_pyx), 0, 0, 1, 0},
+  {&__pyx_n_s_druhg_unionfind, __pyx_k_druhg_unionfind, sizeof(__pyx_k_druhg_unionfind), 0, 0, 1, 1},
   {&__pyx_n_s_dtype, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
   {&__pyx_n_s_dualtree, __pyx_k_dualtree, sizeof(__pyx_k_dualtree), 0, 0, 1, 1},
+  {&__pyx_kp_u_edges_with_the_max_rank_Try_inc, __pyx_k_edges_with_the_max_rank_Try_inc, sizeof(__pyx_k_edges_with_the_max_rank_Try_inc), 0, 1, 0, 0},
   {&__pyx_n_s_empty, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
   {&__pyx_kp_u_enable, __pyx_k_enable, sizeof(__pyx_k_enable), 0, 1, 0, 0},
+  {&__pyx_n_s_endpoint, __pyx_k_endpoint, sizeof(__pyx_k_endpoint), 0, 0, 1, 1},
   {&__pyx_n_u_euclidean, __pyx_k_euclidean, sizeof(__pyx_k_euclidean), 0, 1, 0, 1},
   {&__pyx_n_s_float_info, __pyx_k_float_info, sizeof(__pyx_k_float_info), 0, 0, 1, 1},
   {&__pyx_kp_u_for_a_better_result, __pyx_k_for_a_better_result, sizeof(__pyx_k_for_a_better_result), 0, 1, 0, 0},
   {&__pyx_kp_u_gc, __pyx_k_gc, sizeof(__pyx_k_gc), 0, 1, 0, 0},
   {&__pyx_n_s_genexpr, __pyx_k_genexpr, sizeof(__pyx_k_genexpr), 0, 0, 1, 1},
   {&__pyx_n_s_get, __pyx_k_get, sizeof(__pyx_k_get), 0, 0, 1, 1},
-  {&__pyx_n_s_get_extras, __pyx_k_get_extras, sizeof(__pyx_k_get_extras), 0, 0, 1, 1},
+  {&__pyx_n_s_get_buffers, __pyx_k_get_buffers, sizeof(__pyx_k_get_buffers), 0, 0, 1, 1},
   {&__pyx_n_s_get_tree, __pyx_k_get_tree, sizeof(__pyx_k_get_tree), 0, 0, 1, 1},
   {&__pyx_n_s_getrow, __pyx_k_getrow, sizeof(__pyx_k_getrow), 0, 0, 1, 1},
   {&__pyx_n_s_getstate, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
   {&__pyx_n_s_heappop, __pyx_k_heappop, sizeof(__pyx_k_heappop), 0, 0, 1, 1},
   {&__pyx_n_s_heappush, __pyx_k_heappush, sizeof(__pyx_k_heappush), 0, 0, 1, 1},
   {&__pyx_n_s_heapq, __pyx_k_heapq, sizeof(__pyx_k_heapq), 0, 0, 1, 1},
   {&__pyx_n_s_heapq_2, __pyx_k_heapq_2, sizeof(__pyx_k_heapq_2), 0, 0, 1, 1},
+  {&__pyx_n_s_heapq_merge, __pyx_k_heapq_merge, sizeof(__pyx_k_heapq_merge), 0, 0, 1, 1},
   {&__pyx_n_s_import, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {&__pyx_n_s_indices, __pyx_k_indices, sizeof(__pyx_k_indices), 0, 0, 1, 1},
   {&__pyx_n_s_initializing, __pyx_k_initializing, sizeof(__pyx_k_initializing), 0, 0, 1, 1},
   {&__pyx_n_s_intp, __pyx_k_intp, sizeof(__pyx_k_intp), 0, 0, 1, 1},
   {&__pyx_n_s_is_coroutine, __pyx_k_is_coroutine, sizeof(__pyx_k_is_coroutine), 0, 0, 1, 1},
   {&__pyx_kp_u_is_not_valid, __pyx_k_is_not_valid, sizeof(__pyx_k_is_not_valid), 0, 1, 0, 0},
-  {&__pyx_n_s_is_slow, __pyx_k_is_slow, sizeof(__pyx_k_is_slow), 0, 0, 1, 1},
   {&__pyx_kp_u_isenabled, __pyx_k_isenabled, sizeof(__pyx_k_isenabled), 0, 1, 0, 0},
   {&__pyx_n_s_items, __pyx_k_items, sizeof(__pyx_k_items), 0, 0, 1, 1},
   {&__pyx_n_s_joblib, __pyx_k_joblib, sizeof(__pyx_k_joblib), 0, 0, 1, 1},
   {&__pyx_n_s_k, __pyx_k_k, sizeof(__pyx_k_k), 0, 0, 1, 1},
   {&__pyx_n_s_leaf_size, __pyx_k_leaf_size, sizeof(__pyx_k_leaf_size), 0, 0, 1, 1},
   {&__pyx_kp_u_level_Try_decreasing_double_pre, __pyx_k_level_Try_decreasing_double_pre, sizeof(__pyx_k_level_Try_decreasing_double_pre), 0, 1, 0, 0},
   {&__pyx_n_s_main, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
   {&__pyx_n_s_max, __pyx_k_max, sizeof(__pyx_k_max), 0, 0, 1, 1},
   {&__pyx_n_s_max_neighbors_search, __pyx_k_max_neighbors_search, sizeof(__pyx_k_max_neighbors_search), 0, 0, 1, 1},
+  {&__pyx_n_s_max_rank, __pyx_k_max_rank, sizeof(__pyx_k_max_rank), 0, 0, 1, 1},
+  {&__pyx_n_s_merge, __pyx_k_merge, sizeof(__pyx_k_merge), 0, 0, 1, 1},
   {&__pyx_n_s_metric, __pyx_k_metric, sizeof(__pyx_k_metric), 0, 0, 1, 1},
   {&__pyx_n_s_n_jobs, __pyx_k_n_jobs, sizeof(__pyx_k_n_jobs), 0, 0, 1, 1},
   {&__pyx_n_s_name, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
   {&__pyx_n_s_new, __pyx_k_new, sizeof(__pyx_k_new), 0, 0, 1, 1},
-  {&__pyx_kp_u_not_connected_edges_It_is_a_for, __pyx_k_not_connected_edges_It_is_a_for, sizeof(__pyx_k_not_connected_edges_It_is_a_for), 0, 1, 0, 0},
+  {&__pyx_kp_u_not_connected_edges_of, __pyx_k_not_connected_edges_of, sizeof(__pyx_k_not_connected_edges_of), 0, 1, 0, 0},
   {&__pyx_n_s_np, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
+  {&__pyx_n_s_num_points, __pyx_k_num_points, sizeof(__pyx_k_num_points), 0, 0, 1, 1},
   {&__pyx_n_s_numpy, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {&__pyx_kp_s_numpy_core_multiarray_failed_to, __pyx_k_numpy_core_multiarray_failed_to, sizeof(__pyx_k_numpy_core_multiarray_failed_to), 0, 0, 1, 0},
   {&__pyx_kp_s_numpy_core_umath_failed_to_impor, __pyx_k_numpy_core_umath_failed_to_impor, sizeof(__pyx_k_numpy_core_umath_failed_to_impor), 0, 0, 1, 0},
   {&__pyx_n_s_ones, __pyx_k_ones, sizeof(__pyx_k_ones), 0, 0, 1, 1},
+  {&__pyx_kp_u_or_pick_the_square_mode_not_avai, __pyx_k_or_pick_the_square_mode_not_avai, sizeof(__pyx_k_or_pick_the_square_mode_not_avai), 0, 1, 0, 0},
   {&__pyx_kp_u_parameter, __pyx_k_parameter, sizeof(__pyx_k_parameter), 0, 1, 0, 0},
   {&__pyx_n_s_pickle, __pyx_k_pickle, sizeof(__pyx_k_pickle), 0, 0, 1, 1},
   {&__pyx_n_s_print, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_PickleError, __pyx_k_pyx_PickleError, sizeof(__pyx_k_pyx_PickleError), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_checksum, __pyx_k_pyx_checksum, sizeof(__pyx_k_pyx_checksum), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_result, __pyx_k_pyx_result, sizeof(__pyx_k_pyx_result), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_state, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_type, __pyx_k_pyx_type, sizeof(__pyx_k_pyx_type), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_PairwiseDistanceT, __pyx_k_pyx_unpickle_PairwiseDistanceT, sizeof(__pyx_k_pyx_unpickle_PairwiseDistanceT), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2, __pyx_k_pyx_unpickle_PairwiseDistanceT_2, sizeof(__pyx_k_pyx_unpickle_PairwiseDistanceT_2), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_UniversalReciproc, __pyx_k_pyx_unpickle_UniversalReciproc, sizeof(__pyx_k_pyx_unpickle_UniversalReciproc), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_vtable, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {&__pyx_n_s_query, __pyx_k_query, sizeof(__pyx_k_query), 0, 0, 1, 1},
   {&__pyx_n_s_range, __pyx_k_range, sizeof(__pyx_k_range), 0, 0, 1, 1},
+  {&__pyx_n_s_reciprocity, __pyx_k_reciprocity, sizeof(__pyx_k_reciprocity), 0, 0, 1, 1},
   {&__pyx_n_s_reduce, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
   {&__pyx_n_s_reduce_cython, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
   {&__pyx_n_s_reduce_ex, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
-  {&__pyx_n_s_result_extras1_arr, __pyx_k_result_extras1_arr, sizeof(__pyx_k_result_extras1_arr), 0, 0, 1, 1},
-  {&__pyx_n_s_result_extras2_arr, __pyx_k_result_extras2_arr, sizeof(__pyx_k_result_extras2_arr), 0, 0, 1, 1},
   {&__pyx_n_s_self, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
-  {&__pyx_kp_s_self_parent_cannot_be_converted, __pyx_k_self_parent_cannot_be_converted, sizeof(__pyx_k_self_parent_cannot_be_converted), 0, 0, 1, 0},
   {&__pyx_n_s_send, __pyx_k_send, sizeof(__pyx_k_send), 0, 0, 1, 1},
   {&__pyx_n_s_setstate, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
   {&__pyx_n_s_setstate_cython, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
   {&__pyx_n_s_shape, __pyx_k_shape, sizeof(__pyx_k_shape), 0, 0, 1, 1},
+  {&__pyx_n_s_skip_first, __pyx_k_skip_first, sizeof(__pyx_k_skip_first), 0, 0, 1, 1},
   {&__pyx_n_s_sklearn_neighbors, __pyx_k_sklearn_neighbors, sizeof(__pyx_k_sklearn_neighbors), 0, 0, 1, 1},
   {&__pyx_n_s_spec, __pyx_k_spec, sizeof(__pyx_k_spec), 0, 0, 1, 1},
   {&__pyx_n_s_state, __pyx_k_state, sizeof(__pyx_k_state), 0, 0, 1, 1},
   {&__pyx_kp_s_stringsource, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
   {&__pyx_n_s_sys, __pyx_k_sys, sizeof(__pyx_k_sys), 0, 0, 1, 1},
   {&__pyx_n_s_test, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
   {&__pyx_n_s_throw, __pyx_k_throw, sizeof(__pyx_k_throw), 0, 0, 1, 1},
@@ -16389,37 +16218,36 @@
   {&__pyx_n_s_vstack, __pyx_k_vstack, sizeof(__pyx_k_vstack), 0, 0, 1, 1},
   {&__pyx_n_s_zeros, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   #endif
   {0, 0, 0, 0, 0, 0, 0}
 };
 /* #### Code section: cached_builtins ### */
 static CYTHON_SMALL_CODE int __Pyx_InitCachedBuiltins(void) {
-  __pyx_builtin_print = __Pyx_GetBuiltinName(__pyx_n_s_print); if (!__pyx_builtin_print) __PYX_ERR(0, 69, __pyx_L1_error)
-  __pyx_builtin_TypeError = __Pyx_GetBuiltinName(__pyx_n_s_TypeError); if (!__pyx_builtin_TypeError) __PYX_ERR(1, 2, __pyx_L1_error)
-  __pyx_builtin_ValueError = __Pyx_GetBuiltinName(__pyx_n_s_ValueError); if (!__pyx_builtin_ValueError) __PYX_ERR(0, 214, __pyx_L1_error)
-  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(0, 305, __pyx_L1_error)
+  __pyx_builtin_print = __Pyx_GetBuiltinName(__pyx_n_s_print); if (!__pyx_builtin_print) __PYX_ERR(0, 82, __pyx_L1_error)
+  __pyx_builtin_ValueError = __Pyx_GetBuiltinName(__pyx_n_s_ValueError); if (!__pyx_builtin_ValueError) __PYX_ERR(0, 195, __pyx_L1_error)
+  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(0, 263, __pyx_L1_error)
   __pyx_builtin_ImportError = __Pyx_GetBuiltinName(__pyx_n_s_ImportError); if (!__pyx_builtin_ImportError) __PYX_ERR(2, 987, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: cached_constants ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);
 
-  /* "druhg/_druhg_tree.pyx":559
+  /* "druhg/_druhg_tree.pyx":411
  * 
  *         if self.result_edges >= self.num_points - 1:
  *             print ('Two subjects only')             # <<<<<<<<<<<<<<
  *             return
- * 
+ *         if warn > 0:
  */
-  __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_Two_subjects_only); if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 559, __pyx_L1_error)
+  __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_Two_subjects_only); if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 411, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple_);
   __Pyx_GIVEREF(__pyx_tuple_);
 
   /* "venv/lib/site-packages/numpy/__init__.cython-30.pxd":987
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
@@ -16437,136 +16265,151 @@
  * 
  * cdef inline int import_ufunc() except -1:
  */
   __pyx_tuple__4 = PyTuple_Pack(1, __pyx_kp_s_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(2, 993, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__4);
   __Pyx_GIVEREF(__pyx_tuple__4);
 
+  /* "druhg/_druhg_tree.pyx":33
+ * from joblib import Parallel, delayed
+ * 
+ * def allocate_buffer_values(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ */
+  __pyx_tuple__6 = PyTuple_Pack(1, __pyx_n_s_num_points); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 33, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__6);
+  __Pyx_GIVEREF(__pyx_tuple__6);
+  __pyx_codeobj__7 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_allocate_buffer_values, 33, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__7)) __PYX_ERR(0, 33, __pyx_L1_error)
+
   /* "druhg/_druhg_tree.pyx":35
+ * def allocate_buffer_values(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):
+ */
+  __pyx_codeobj__8 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_allocate_buffer_edgepairs, 35, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__8)) __PYX_ERR(0, 35, __pyx_L1_error)
+
+  /* "druhg/_druhg_tree.pyx":37
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.intp)
+ * 
+ */
+  __pyx_codeobj__9 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_allocate_buffer_ranks, 37, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__9)) __PYX_ERR(0, 37, __pyx_L1_error)
+
+  /* "druhg/_druhg_tree.pyx":48
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         # TODO: actually we need to consider replacing INF with something else.
  *         # Reciprocity of absent link is not the same as the INF. Do reciprocity with graphs!
  */
-  __pyx_tuple__6 = PyTuple_Pack(5, __pyx_n_s_self, __pyx_n_s_d, __pyx_n_s_k, __pyx_n_s_dualtree, __pyx_n_s_breadth_first); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 35, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__6);
-  __Pyx_GIVEREF(__pyx_tuple__6);
-  __pyx_codeobj__7 = (PyObject*)__Pyx_PyCode_New(5, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_query, 35, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__7)) __PYX_ERR(0, 35, __pyx_L1_error)
-  __pyx_tuple__8 = PyTuple_Pack(2, __pyx_int_0, __pyx_int_0); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(0, 35, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__8);
-  __Pyx_GIVEREF(__pyx_tuple__8);
+  __pyx_tuple__10 = PyTuple_Pack(5, __pyx_n_s_self, __pyx_n_s_d, __pyx_n_s_k, __pyx_n_s_dualtree, __pyx_n_s_breadth_first); if (unlikely(!__pyx_tuple__10)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__10);
+  __Pyx_GIVEREF(__pyx_tuple__10);
+  __pyx_codeobj__11 = (PyObject*)__Pyx_PyCode_New(5, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__10, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_query, 48, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__11)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __pyx_tuple__12 = PyTuple_Pack(2, __pyx_int_0, __pyx_int_0); if (unlikely(!__pyx_tuple__12)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__12);
+  __Pyx_GIVEREF(__pyx_tuple__12);
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
-  __pyx_tuple__9 = PyTuple_Pack(4, __pyx_n_s_self, __pyx_n_s_state, __pyx_n_s_dict_2, __pyx_n_s_use_setstate); if (unlikely(!__pyx_tuple__9)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__9);
-  __Pyx_GIVEREF(__pyx_tuple__9);
-  __pyx_codeobj__10 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__9, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__10)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__13 = PyTuple_Pack(4, __pyx_n_s_self, __pyx_n_s_state, __pyx_n_s_dict_2, __pyx_n_s_use_setstate); if (unlikely(!__pyx_tuple__13)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__13);
+  __Pyx_GIVEREF(__pyx_tuple__13);
+  __pyx_codeobj__14 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__13, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__14)) __PYX_ERR(1, 1, __pyx_L1_error)
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_PairwiseDistanceTreeSparse, (type(self), 0x147f899, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_PairwiseDistanceTreeSparse__set_state(self, __pyx_state)
  */
-  __pyx_tuple__11 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_pyx_state); if (unlikely(!__pyx_tuple__11)) __PYX_ERR(1, 16, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__11);
-  __Pyx_GIVEREF(__pyx_tuple__11);
-  __pyx_codeobj__12 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__11, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__12)) __PYX_ERR(1, 16, __pyx_L1_error)
+  __pyx_tuple__15 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_pyx_state); if (unlikely(!__pyx_tuple__15)) __PYX_ERR(1, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__15);
+  __Pyx_GIVEREF(__pyx_tuple__15);
+  __pyx_codeobj__16 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__15, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__16)) __PYX_ERR(1, 16, __pyx_L1_error)
 
-  /* "druhg/_druhg_tree.pyx":81
+  /* "druhg/_druhg_tree.pyx":94
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         cdef np.ndarray[np.double_t, ndim=2] knn_dist
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  */
-  __pyx_codeobj__13 = (PyObject*)__Pyx_PyCode_New(5, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_query, 81, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__13)) __PYX_ERR(0, 81, __pyx_L1_error)
+  __pyx_codeobj__17 = (PyObject*)__Pyx_PyCode_New(5, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__10, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_query, 94, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__17)) __PYX_ERR(0, 94, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
-  __pyx_codeobj__14 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__9, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__14)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_codeobj__18 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__13, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__18)) __PYX_ERR(1, 1, __pyx_L1_error)
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_PairwiseDistanceTreeGeneric, (type(self), 0x147f899, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_PairwiseDistanceTreeGeneric__set_state(self, __pyx_state)
  */
-  __pyx_codeobj__15 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__11, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__15)) __PYX_ERR(1, 16, __pyx_L1_error)
-
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-  __pyx_tuple__16 = PyTuple_Pack(1, __pyx_n_s_self); if (unlikely(!__pyx_tuple__16)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__16);
-  __Pyx_GIVEREF(__pyx_tuple__16);
-  __pyx_codeobj__17 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__16, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__17)) __PYX_ERR(1, 1, __pyx_L1_error)
-
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-  __pyx_codeobj__18 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__11, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 3, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__18)) __PYX_ERR(1, 3, __pyx_L1_error)
+  __pyx_codeobj__19 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__15, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__19)) __PYX_ERR(1, 16, __pyx_L1_error)
 
-  /* "druhg/_druhg_tree.pyx":232
- *         self._compute_tree_edges(is_slow)
+  /* "druhg/_druhg_tree.pyx":223
+ *         self._compute_tree_edges()
  * 
  *     cpdef tuple get_tree(self):             # <<<<<<<<<<<<<<
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
- * 
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  */
-  __pyx_codeobj__19 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__16, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_get_tree, 232, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__19)) __PYX_ERR(0, 232, __pyx_L1_error)
+  __pyx_tuple__20 = PyTuple_Pack(1, __pyx_n_s_self); if (unlikely(!__pyx_tuple__20)) __PYX_ERR(0, 223, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__20);
+  __Pyx_GIVEREF(__pyx_tuple__20);
+  __pyx_codeobj__21 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__20, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_get_tree, 223, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__21)) __PYX_ERR(0, 223, __pyx_L1_error)
 
-  /* "druhg/_druhg_tree.pyx":235
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
+  /* "druhg/_druhg_tree.pyx":227
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  * 
- *     cpdef tuple get_extras(self):             # <<<<<<<<<<<<<<
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])
+ *     cpdef tuple get_buffers(self):             # <<<<<<<<<<<<<<
+ *         return self.result_values_arr, self.U.parent_arr
  * 
  */
-  __pyx_codeobj__20 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__16, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_get_extras, 235, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__20)) __PYX_ERR(0, 235, __pyx_L1_error)
+  __pyx_codeobj__22 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__20, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_druhg__druhg_tree_pyx, __pyx_n_s_get_buffers, 227, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__22)) __PYX_ERR(0, 227, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
-  __pyx_codeobj__21 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__9, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__21)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_codeobj__23 = (PyObject*)__Pyx_PyCode_New(1, 0, 0, 4, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__13, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_reduce_cython, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__23)) __PYX_ERR(1, 1, __pyx_L1_error)
 
   /* "(tree fragment)":16
  *     else:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_UniversalReciprocity__set_state(self, __pyx_state)
  */
-  __pyx_codeobj__22 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__11, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__22)) __PYX_ERR(1, 16, __pyx_L1_error)
+  __pyx_codeobj__24 = (PyObject*)__Pyx_PyCode_New(2, 0, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__15, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_setstate_cython, 16, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__24)) __PYX_ERR(1, 16, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_PairwiseDistanceTreeSparse(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_tuple__23 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__23)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__23);
-  __Pyx_GIVEREF(__pyx_tuple__23);
-  __pyx_codeobj__24 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__23, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PairwiseDistanceT, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__24)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_codeobj__25 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__23, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PairwiseDistanceT_2, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__25)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_codeobj__26 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__23, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_UniversalReciproc, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__26)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__25 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__25)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__25);
+  __Pyx_GIVEREF(__pyx_tuple__25);
+  __pyx_codeobj__26 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__25, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PairwiseDistanceT, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__26)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_codeobj__27 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__25, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PairwiseDistanceT_2, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__27)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_codeobj__28 = (PyObject*)__Pyx_PyCode_New(3, 0, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__25, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_UniversalReciproc, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__28)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
 /* #### Code section: init_constants ### */
@@ -16575,149 +16418,166 @@
   __pyx_umethod_PyDict_Type_get.type = (PyObject*)&PyDict_Type;
   __pyx_umethod_PyDict_Type_get.method_name = &__pyx_n_s_get;
   #if CYTHON_USE_MODULE_STATE
   if (__Pyx_InitString(__pyx_string_tab[0], &__pyx_kp_u_A_lot_of_values) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   if (__Pyx_InitString(__pyx_string_tab[1], &__pyx_kp_u_Attention_Sparse_matrix_has_an_e) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   if (__Pyx_InitString(__pyx_string_tab[2], &__pyx_n_s_BallTree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   if (__Pyx_InitString(__pyx_string_tab[3], &__pyx_kp_u_Distances_cannot_be_negative_Exi) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[4], &__pyx_n_s_ImportError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[5], &__pyx_kp_s_Incompatible_checksums_s_vs_0x14) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[6], &__pyx_kp_s_Incompatible_checksums_s_vs_0xdf) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[7], &__pyx_n_s_KDTree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[8], &__pyx_n_s_N) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[9], &__pyx_n_s_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[10], &__pyx_n_s_PairwiseDistanceTreeGeneric___re) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[11], &__pyx_n_s_PairwiseDistanceTreeGeneric___se) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[12], &__pyx_n_s_PairwiseDistanceTreeGeneric_quer) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[13], &__pyx_n_s_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[14], &__pyx_n_s_PairwiseDistanceTreeSparse___red) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[15], &__pyx_n_s_PairwiseDistanceTreeSparse___set) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[16], &__pyx_n_s_PairwiseDistanceTreeSparse_query) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[17], &__pyx_n_s_Parallel) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[18], &__pyx_n_s_PickleError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[19], &__pyx_kp_u_Some_distances) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[20], &__pyx_kp_u_Two_subjects_only) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[21], &__pyx_n_s_TypeError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[22], &__pyx_n_s_UnionFind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[23], &__pyx_n_s_UnionFind___reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[24], &__pyx_n_s_UnionFind___setstate_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[25], &__pyx_n_s_UniversalReciprocity) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[26], &__pyx_n_s_UniversalReciprocity___reduce_cy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[27], &__pyx_n_s_UniversalReciprocity___setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[28], &__pyx_n_s_UniversalReciprocity__compute_tr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[29], &__pyx_n_s_UniversalReciprocity_get_extras) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[30], &__pyx_n_s_UniversalReciprocity_get_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[31], &__pyx_n_s_ValueError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[32], &__pyx_kp_u__2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[33], &__pyx_n_s__27) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[34], &__pyx_n_s__5) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[35], &__pyx_n_s_algorithm) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[36], &__pyx_kp_u_algorithm_value) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[37], &__pyx_kp_u_are_smaller_than_self_PRECISION) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[38], &__pyx_kp_u_are_the_same_Try_increasing_max) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[39], &__pyx_n_s_args) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[40], &__pyx_n_s_argsort) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[41], &__pyx_n_s_asarray) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[42], &__pyx_n_s_astype) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[43], &__pyx_n_s_asyncio_coroutines) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[44], &__pyx_n_s_bisect) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[45], &__pyx_n_s_breadth_first) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[46], &__pyx_n_s_class_getitem) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[47], &__pyx_n_s_cline_in_traceback) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[48], &__pyx_n_s_close) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[49], &__pyx_n_s_d) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[50], &__pyx_n_s_data) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[51], &__pyx_n_s_delayed) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[52], &__pyx_n_s_dict) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[53], &__pyx_n_s_dict_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[54], &__pyx_kp_u_disable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[55], &__pyx_n_u_double_precision) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[56], &__pyx_n_s_druhg__druhg_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[57], &__pyx_kp_s_druhg__druhg_tree_pyx) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[58], &__pyx_n_s_dtype) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[59], &__pyx_n_s_dualtree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[60], &__pyx_n_s_empty) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[61], &__pyx_kp_u_enable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[62], &__pyx_n_u_euclidean) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[63], &__pyx_n_s_float_info) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[64], &__pyx_kp_u_for_a_better_result) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[65], &__pyx_kp_u_gc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[66], &__pyx_n_s_genexpr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[67], &__pyx_n_s_get) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[68], &__pyx_n_s_get_extras) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[69], &__pyx_n_s_get_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[70], &__pyx_n_s_getrow) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[71], &__pyx_n_s_getstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[72], &__pyx_n_s_heappop) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[73], &__pyx_n_s_heappush) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[74], &__pyx_n_s_heapq) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[75], &__pyx_n_s_heapq_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[76], &__pyx_n_s_import) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[77], &__pyx_n_s_indices) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[78], &__pyx_n_s_initializing) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[79], &__pyx_n_s_intp) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[80], &__pyx_n_s_is_coroutine) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[81], &__pyx_kp_u_is_not_valid) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[82], &__pyx_n_s_is_slow) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[83], &__pyx_kp_u_isenabled) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[84], &__pyx_n_s_items) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[85], &__pyx_n_s_joblib) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[86], &__pyx_n_s_k) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[87], &__pyx_n_s_leaf_size) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[88], &__pyx_kp_u_level_Try_decreasing_double_pre) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[89], &__pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[90], &__pyx_n_s_max) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[91], &__pyx_n_s_max_neighbors_search) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[92], &__pyx_n_s_metric) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[93], &__pyx_n_s_n_jobs) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[94], &__pyx_n_s_name) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[95], &__pyx_n_s_new) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[96], &__pyx_kp_u_not_connected_edges_It_is_a_for) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[97], &__pyx_n_s_np) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[98], &__pyx_n_s_numpy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[99], &__pyx_kp_s_numpy_core_multiarray_failed_to) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[100], &__pyx_kp_s_numpy_core_umath_failed_to_impor) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[101], &__pyx_n_s_ones) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[102], &__pyx_kp_u_parameter) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[103], &__pyx_n_s_pickle) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[104], &__pyx_n_s_print) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[105], &__pyx_n_s_pyx_PickleError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[106], &__pyx_n_s_pyx_checksum) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[107], &__pyx_n_s_pyx_result) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[108], &__pyx_n_s_pyx_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[109], &__pyx_n_s_pyx_type) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[110], &__pyx_n_s_pyx_unpickle_PairwiseDistanceT) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[111], &__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[112], &__pyx_n_s_pyx_unpickle_UniversalReciproc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[113], &__pyx_n_s_pyx_vtable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[114], &__pyx_n_s_query) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[115], &__pyx_n_s_range) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[116], &__pyx_n_s_reduce) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[117], &__pyx_n_s_reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[118], &__pyx_n_s_reduce_ex) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[119], &__pyx_n_s_result_extras1_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[120], &__pyx_n_s_result_extras2_arr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[121], &__pyx_n_s_self) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[122], &__pyx_kp_s_self_parent_cannot_be_converted) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[123], &__pyx_n_s_send) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[124], &__pyx_n_s_setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[125], &__pyx_n_s_setstate_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[126], &__pyx_n_s_shape) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[127], &__pyx_n_s_sklearn_neighbors) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[128], &__pyx_n_s_spec) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[129], &__pyx_n_s_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[130], &__pyx_kp_s_stringsource) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[131], &__pyx_n_s_sys) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[132], &__pyx_n_s_test) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[133], &__pyx_n_s_throw) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[134], &__pyx_n_s_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[135], &__pyx_n_s_update) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[136], &__pyx_n_s_use_setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[137], &__pyx_n_s_vstack) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
-  if (__Pyx_InitString(__pyx_string_tab[138], &__pyx_n_s_zeros) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[4], &__pyx_kp_u_ERROR_edgepairs_buffer_is_too_sm) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[5], &__pyx_kp_u_ERROR_ranks_buffer_is_too_small) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[6], &__pyx_kp_u_ERROR_values_buffer_is_too_small) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[7], &__pyx_n_s_ImportError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[8], &__pyx_kp_s_Incompatible_checksums_s_vs_0x14) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[9], &__pyx_kp_s_Incompatible_checksums_s_vs_0xc3) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[10], &__pyx_kp_u_It_is_a_forest_Try_increasing_m) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[11], &__pyx_n_s_KDTree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[12], &__pyx_n_s_N) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[13], &__pyx_n_s_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[14], &__pyx_n_s_PairwiseDistanceTreeGeneric___re) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[15], &__pyx_n_s_PairwiseDistanceTreeGeneric___se) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[16], &__pyx_n_s_PairwiseDistanceTreeGeneric_quer) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[17], &__pyx_n_s_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[18], &__pyx_n_s_PairwiseDistanceTreeSparse___red) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[19], &__pyx_n_s_PairwiseDistanceTreeSparse___set) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[20], &__pyx_n_s_PairwiseDistanceTreeSparse_query) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[21], &__pyx_n_s_Parallel) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[22], &__pyx_n_s_PickleError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[23], &__pyx_kp_u_Some_distances) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[24], &__pyx_kp_u_Two_subjects_only) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[25], &__pyx_n_s_UnionFind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[26], &__pyx_n_s_UniversalReciprocity) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[27], &__pyx_n_s_UniversalReciprocity___reduce_cy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[28], &__pyx_n_s_UniversalReciprocity___setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[29], &__pyx_n_s_UniversalReciprocity__compute_tr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[30], &__pyx_n_s_UniversalReciprocity_get_buffers) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[31], &__pyx_n_s_UniversalReciprocity_get_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[32], &__pyx_n_s_ValueError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[33], &__pyx_kp_u__2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[34], &__pyx_n_s__29) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[35], &__pyx_n_s__5) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[36], &__pyx_n_s_algorithm) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[37], &__pyx_kp_u_algorithm_value) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[38], &__pyx_n_s_allocate_buffer_edgepairs) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[39], &__pyx_n_s_allocate_buffer_ranks) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[40], &__pyx_n_s_allocate_buffer_values) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[41], &__pyx_kp_u_are_smaller_than_self_PRECISION) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[42], &__pyx_kp_u_are_the_same_Try_increasing_max) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[43], &__pyx_n_s_args) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[44], &__pyx_n_s_argsort) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[45], &__pyx_n_s_asarray) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[46], &__pyx_n_s_astype) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[47], &__pyx_n_s_asyncio_coroutines) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[48], &__pyx_n_s_bisect) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[49], &__pyx_n_s_breadth_first) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[50], &__pyx_n_s_buffer_edgepairs) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[51], &__pyx_n_s_buffer_fast) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[52], &__pyx_n_s_buffer_ranks) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[53], &__pyx_n_s_buffer_uf) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[54], &__pyx_n_s_buffer_values) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[55], &__pyx_n_s_class_getitem) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[56], &__pyx_n_s_cline_in_traceback) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[57], &__pyx_n_s_close) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[58], &__pyx_n_s_cyheapq) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[59], &__pyx_n_s_d) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[60], &__pyx_n_s_data) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[61], &__pyx_n_s_delayed) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[62], &__pyx_n_s_dict) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[63], &__pyx_n_s_dict_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[64], &__pyx_kp_u_disable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[65], &__pyx_n_s_double) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[66], &__pyx_n_u_double_precision) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[67], &__pyx_n_s_druhg__druhg_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[68], &__pyx_kp_s_druhg__druhg_tree_pyx) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[69], &__pyx_n_s_druhg_unionfind) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[70], &__pyx_n_s_dtype) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[71], &__pyx_n_s_dualtree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[72], &__pyx_kp_u_edges_with_the_max_rank_Try_inc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[73], &__pyx_n_s_empty) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[74], &__pyx_kp_u_enable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[75], &__pyx_n_s_endpoint) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[76], &__pyx_n_u_euclidean) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[77], &__pyx_n_s_float_info) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[78], &__pyx_kp_u_for_a_better_result) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[79], &__pyx_kp_u_gc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[80], &__pyx_n_s_genexpr) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[81], &__pyx_n_s_get) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[82], &__pyx_n_s_get_buffers) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[83], &__pyx_n_s_get_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[84], &__pyx_n_s_getrow) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[85], &__pyx_n_s_getstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[86], &__pyx_n_s_heappop) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[87], &__pyx_n_s_heappush) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[88], &__pyx_n_s_heapq) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[89], &__pyx_n_s_heapq_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[90], &__pyx_n_s_heapq_merge) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[91], &__pyx_n_s_import) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[92], &__pyx_n_s_indices) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[93], &__pyx_n_s_initializing) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[94], &__pyx_n_s_intp) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[95], &__pyx_n_s_is_coroutine) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[96], &__pyx_kp_u_is_not_valid) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[97], &__pyx_kp_u_isenabled) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[98], &__pyx_n_s_items) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[99], &__pyx_n_s_joblib) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[100], &__pyx_n_s_k) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[101], &__pyx_n_s_leaf_size) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[102], &__pyx_kp_u_level_Try_decreasing_double_pre) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[103], &__pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[104], &__pyx_n_s_max) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[105], &__pyx_n_s_max_neighbors_search) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[106], &__pyx_n_s_max_rank) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[107], &__pyx_n_s_merge) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[108], &__pyx_n_s_metric) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[109], &__pyx_n_s_n_jobs) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[110], &__pyx_n_s_name) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[111], &__pyx_n_s_new) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[112], &__pyx_kp_u_not_connected_edges_of) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[113], &__pyx_n_s_np) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[114], &__pyx_n_s_num_points) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[115], &__pyx_n_s_numpy) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[116], &__pyx_kp_s_numpy_core_multiarray_failed_to) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[117], &__pyx_kp_s_numpy_core_umath_failed_to_impor) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[118], &__pyx_n_s_ones) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[119], &__pyx_kp_u_or_pick_the_square_mode_not_avai) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[120], &__pyx_kp_u_parameter) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[121], &__pyx_n_s_pickle) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[122], &__pyx_n_s_print) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[123], &__pyx_n_s_pyx_PickleError) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[124], &__pyx_n_s_pyx_checksum) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[125], &__pyx_n_s_pyx_result) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[126], &__pyx_n_s_pyx_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[127], &__pyx_n_s_pyx_type) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[128], &__pyx_n_s_pyx_unpickle_PairwiseDistanceT) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[129], &__pyx_n_s_pyx_unpickle_PairwiseDistanceT_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[130], &__pyx_n_s_pyx_unpickle_UniversalReciproc) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[131], &__pyx_n_s_pyx_vtable) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[132], &__pyx_n_s_query) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[133], &__pyx_n_s_range) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[134], &__pyx_n_s_reciprocity) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[135], &__pyx_n_s_reduce) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[136], &__pyx_n_s_reduce_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[137], &__pyx_n_s_reduce_ex) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[138], &__pyx_n_s_self) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[139], &__pyx_n_s_send) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[140], &__pyx_n_s_setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[141], &__pyx_n_s_setstate_cython) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[142], &__pyx_n_s_shape) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[143], &__pyx_n_s_skip_first) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[144], &__pyx_n_s_sklearn_neighbors) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[145], &__pyx_n_s_spec) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[146], &__pyx_n_s_state) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[147], &__pyx_kp_s_stringsource) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[148], &__pyx_n_s_sys) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[149], &__pyx_n_s_test) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[150], &__pyx_n_s_throw) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[151], &__pyx_n_s_tree) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[152], &__pyx_n_s_update) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[153], &__pyx_n_s_use_setstate) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[154], &__pyx_n_s_vstack) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitString(__pyx_string_tab[155], &__pyx_n_s_zeros) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #endif
   #if !CYTHON_USE_MODULE_STATE
   if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   #endif
   __pyx_float_0_ = PyFloat_FromDouble(0.); if (unlikely(!__pyx_float_0_)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_float_0_0000001 = PyFloat_FromDouble(0.0000001); if (unlikely(!__pyx_float_0_0000001)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_0 = PyInt_FromLong(0); if (unlikely(!__pyx_int_0)) __PYX_ERR(0, 1, __pyx_L1_error)
@@ -16725,16 +16585,15 @@
   __pyx_int_2 = PyInt_FromLong(2); if (unlikely(!__pyx_int_2)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_3 = PyInt_FromLong(3); if (unlikely(!__pyx_int_3)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_4 = PyInt_FromLong(4); if (unlikely(!__pyx_int_4)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_16 = PyInt_FromLong(16); if (unlikely(!__pyx_int_16)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_20 = PyInt_FromLong(20); if (unlikely(!__pyx_int_20)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_16384 = PyInt_FromLong(16384L); if (unlikely(!__pyx_int_16384)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_21493913 = PyInt_FromLong(21493913L); if (unlikely(!__pyx_int_21493913)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_int_234627805 = PyInt_FromLong(234627805L); if (unlikely(!__pyx_int_234627805)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_int_neg_1 = PyInt_FromLong(-1); if (unlikely(!__pyx_int_neg_1)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_204757032 = PyInt_FromLong(204757032L); if (unlikely(!__pyx_int_204757032)) __PYX_ERR(0, 1, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 /* #### Code section: init_globals ### */
 
 static CYTHON_SMALL_CODE int __Pyx_InitGlobals(void) {
@@ -16747,15 +16606,15 @@
  */
 #ifdef NPY_FEATURE_VERSION
 #if !NO_IMPORT_ARRAY
 if (unlikely(_import_array() == -1)) {
     PyErr_SetString(PyExc_ImportError, "numpy.core.multiarray failed to import "
     "(auto-generated because you didn't call 'numpy.import_array()' after cimporting numpy; "
     "use '<void>numpy._import_array' to disable if you are certain you don't need it).");
-    __PYX_ERR(0, 14, __pyx_L1_error);
+    __PYX_ERR(0, 15, __pyx_L1_error);
 }
 #endif
 #endif
 
 if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 1, __pyx_L1_error)
 
   return 0;
@@ -16802,164 +16661,132 @@
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_init_code", 0);
   /*--- Type init code ---*/
   __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse = &__pyx_vtable_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse;
   __pyx_vtable_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse.query = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse *, PyObject *, PyObject *, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_query *__pyx_optional_args))__pyx_f_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_query;
   #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse)) __PYX_ERR(0, 27, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse_spec, __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse)) __PYX_ERR(0, 40, __pyx_L1_error)
+  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse_spec, __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   #else
   __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse = &__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   #endif
   #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   #endif
   #if PY_MAJOR_VERSION < 3
   __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_print = 0;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_dictoffset && __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
   #endif
-  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse, __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse, __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   #endif
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PairwiseDistanceTreeSparse, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PairwiseDistanceTreeSparse, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 27, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   #endif
   __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric = &__pyx_vtable_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric;
   __pyx_vtable_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric.query = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric *, PyObject *, PyObject *, int __pyx_skip_dispatch, struct __pyx_opt_args_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query *__pyx_optional_args))__pyx_f_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_query;
   #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric)) __PYX_ERR(0, 73, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric_spec, __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
+  __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric)) __PYX_ERR(0, 86, __pyx_L1_error)
+  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric_spec, __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
   #else
   __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric = &__pyx_type_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   #endif
   #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
+  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
   #endif
   #if PY_MAJOR_VERSION < 3
   __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_print = 0;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_dictoffset && __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
   #endif
-  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric, __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
+  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric, __pyx_vtabptr_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
+  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
   #endif
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PairwiseDistanceTreeGeneric, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PairwiseDistanceTreeGeneric, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
-  #endif
-  __pyx_vtabptr_5druhg_11_druhg_tree_UnionFind = &__pyx_vtable_5druhg_11_druhg_tree_UnionFind;
-  __pyx_vtable_5druhg_11_druhg_tree_UnionFind.fast_find = (__pyx_t_5numpy_intp_t (*)(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_11_druhg_tree_9UnionFind_fast_find;
-  __pyx_vtable_5druhg_11_druhg_tree_UnionFind.__pyx_union = (void (*)(struct __pyx_obj_5druhg_11_druhg_tree_UnionFind *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_11_druhg_tree_9UnionFind_union;
-  #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_11_druhg_tree_UnionFind = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_UnionFind_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_UnionFind)) __PYX_ERR(0, 101, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_UnionFind_spec, __pyx_ptype_5druhg_11_druhg_tree_UnionFind) < 0) __PYX_ERR(0, 101, __pyx_L1_error)
-  #else
-  __pyx_ptype_5druhg_11_druhg_tree_UnionFind = &__pyx_type_5druhg_11_druhg_tree_UnionFind;
-  #endif
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  #endif
-  #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_UnionFind) < 0) __PYX_ERR(0, 101, __pyx_L1_error)
-  #endif
-  #if PY_MAJOR_VERSION < 3
-  __pyx_ptype_5druhg_11_druhg_tree_UnionFind->tp_print = 0;
-  #endif
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_11_druhg_tree_UnionFind->tp_dictoffset && __pyx_ptype_5druhg_11_druhg_tree_UnionFind->tp_getattro == PyObject_GenericGetAttr)) {
-    __pyx_ptype_5druhg_11_druhg_tree_UnionFind->tp_getattro = __Pyx_PyObject_GenericGetAttr;
-  }
-  #endif
-  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_UnionFind, __pyx_vtabptr_5druhg_11_druhg_tree_UnionFind) < 0) __PYX_ERR(0, 101, __pyx_L1_error)
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_UnionFind) < 0) __PYX_ERR(0, 101, __pyx_L1_error)
-  #endif
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_UnionFind, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_UnionFind) < 0) __PYX_ERR(0, 101, __pyx_L1_error)
-  #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_UnionFind) < 0) __PYX_ERR(0, 101, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric) < 0) __PYX_ERR(0, 86, __pyx_L1_error)
   #endif
   __pyx_vtabptr_5druhg_11_druhg_tree_UniversalReciprocity = &__pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity;
   __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity.get_tree = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, int __pyx_skip_dispatch))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_tree;
-  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity.get_extras = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, int __pyx_skip_dispatch))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_extras;
-  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity.result_add_edge_debug = (void (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, struct __pyx_t_5druhg_11_druhg_tree_Relation *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_add_edge_debug;
-  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity.result_add_edge = (void (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_double_t))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_add_edge;
+  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity.get_buffers = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, int __pyx_skip_dispatch))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_get_buffers;
+  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity.result_write = (void (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_double_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t, __pyx_t_5numpy_intp_t))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity_result_write;
   __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity._pure_reciprocity = (int (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *, __pyx_t_5numpy_intp_t *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__pure_reciprocity;
-  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity._evaluate_reciprocity_slow = (int (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity_slow;
-  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity._evaluate_reciprocity_fast = (int (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity_fast;
-  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity._compute_tree_edges = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, PyObject *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__compute_tree_edges;
+  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity._evaluate_reciprocity = (int (*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *, __pyx_t_5numpy_intp_t, PyArrayObject *, PyArrayObject *, struct __pyx_t_5druhg_11_druhg_tree_Relation *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__evaluate_reciprocity;
+  __pyx_vtable_5druhg_11_druhg_tree_UniversalReciprocity._compute_tree_edges = (PyObject *(*)(struct __pyx_obj_5druhg_11_druhg_tree_UniversalReciprocity *))__pyx_f_5druhg_11_druhg_tree_20UniversalReciprocity__compute_tree_edges;
   #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity)) __PYX_ERR(0, 140, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity_spec, __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 140, __pyx_L1_error)
+  __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity)) __PYX_ERR(0, 115, __pyx_L1_error)
+  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity_spec, __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 115, __pyx_L1_error)
   #else
   __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity = &__pyx_type_5druhg_11_druhg_tree_UniversalReciprocity;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   #endif
   #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 140, __pyx_L1_error)
+  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 115, __pyx_L1_error)
   #endif
   #if PY_MAJOR_VERSION < 3
   __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_print = 0;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dictoffset && __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
   #endif
-  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity, __pyx_vtabptr_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 140, __pyx_L1_error)
+  if (__Pyx_SetVtable(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity, __pyx_vtabptr_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 115, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 140, __pyx_L1_error)
+  if (__Pyx_MergeVtables(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 115, __pyx_L1_error)
   #endif
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_UniversalReciprocity, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 140, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_UniversalReciprocity, (PyObject *) __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 115, __pyx_L1_error)
   #if !CYTHON_COMPILING_IN_LIMITED_API
-  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 140, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject *) __pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity) < 0) __PYX_ERR(0, 115, __pyx_L1_error)
   #endif
   #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges)) __PYX_ERR(0, 482, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges_spec, __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges) < 0) __PYX_ERR(0, 482, __pyx_L1_error)
+  __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges)) __PYX_ERR(0, 341, __pyx_L1_error)
+  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges_spec, __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges) < 0) __PYX_ERR(0, 341, __pyx_L1_error)
   #else
   __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges = &__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   #endif
   #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges) < 0) __PYX_ERR(0, 482, __pyx_L1_error)
+  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges) < 0) __PYX_ERR(0, 341, __pyx_L1_error)
   #endif
   #if PY_MAJOR_VERSION < 3
   __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges->tp_print = 0;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges->tp_dictoffset && __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges->tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct___compute_tree_edges->tp_getattro = __Pyx_PyObject_GenericGetAttrNoDict;
   }
   #endif
   #if CYTHON_USE_TYPE_SPECS
-  __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr)) __PYX_ERR(0, 509, __pyx_L1_error)
-  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr_spec, __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr) < 0) __PYX_ERR(0, 509, __pyx_L1_error)
+  __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr = (PyTypeObject *) __Pyx_PyType_FromModuleAndSpec(__pyx_m, &__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr_spec, NULL); if (unlikely(!__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr)) __PYX_ERR(0, 368, __pyx_L1_error)
+  if (__Pyx_fix_up_extension_type_from_spec(&__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr_spec, __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr) < 0) __PYX_ERR(0, 368, __pyx_L1_error)
   #else
   __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr = &__pyx_type_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   #endif
   #if !CYTHON_USE_TYPE_SPECS
-  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr) < 0) __PYX_ERR(0, 509, __pyx_L1_error)
+  if (__Pyx_PyType_Ready(__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr) < 0) __PYX_ERR(0, 368, __pyx_L1_error)
   #endif
   #if PY_MAJOR_VERSION < 3
   __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr->tp_print = 0;
   #endif
   #if !CYTHON_COMPILING_IN_LIMITED_API
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr->tp_dictoffset && __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr->tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_ptype_5druhg_11_druhg_tree___pyx_scope_struct_1_genexpr->tp_getattro = __Pyx_PyObject_GenericGetAttrNoDict;
@@ -17022,14 +16849,20 @@
   __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(2, 829, __pyx_L1_error)
   __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_character) __PYX_ERR(2, 831, __pyx_L1_error)
   __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(2, 869, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = PyImport_ImportModule("druhg._druhg_unionfind"); if (unlikely(!__pyx_t_1)) __PYX_ERR(4, 16, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_ptype_5druhg_16_druhg_unionfind_UnionFind = __Pyx_ImportType(__pyx_t_1, "druhg._druhg_unionfind", "UnionFind", sizeof(struct __pyx_obj_5druhg_16_druhg_unionfind_UnionFind), __Pyx_ImportType_CheckSize_Warn);
+   if (!__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind) __PYX_ERR(4, 16, __pyx_L1_error)
+  __pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind = (struct __pyx_vtabstruct_5druhg_16_druhg_unionfind_UnionFind*)__Pyx_GetVtable(__pyx_ptype_5druhg_16_druhg_unionfind_UnionFind); if (unlikely(!__pyx_vtabptr_5druhg_16_druhg_unionfind_UnionFind)) __PYX_ERR(4, 16, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_RefNannyFinishContext();
   return -1;
 }
@@ -17324,309 +17157,362 @@
   (void)__Pyx_modinit_variable_import_code();
   (void)__Pyx_modinit_function_import_code();
   /*--- Execution code ---*/
   #if defined(__Pyx_Generator_USED) || defined(__Pyx_Coroutine_USED)
   if (__Pyx_patch_abc() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
 
-  /* "druhg/_druhg_tree.pyx":13
- * # License: 3-clause BSD
+  /* "druhg/_druhg_tree.pyx":14
+ * 
  * 
  * import numpy as np             # <<<<<<<<<<<<<<
  * cimport numpy as np
  * import sys
  */
-  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_numpy, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 13, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_numpy, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 14, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_2) < 0) __PYX_ERR(0, 13, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_2) < 0) __PYX_ERR(0, 14, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":15
+  /* "druhg/_druhg_tree.pyx":16
  * import numpy as np
  * cimport numpy as np
  * import sys             # <<<<<<<<<<<<<<
  * 
- * import _heapq as heapq
+ * from ._druhg_unionfind import UnionFind
  */
-  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_sys, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 15, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_sys, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sys, __pyx_t_2) < 0) __PYX_ERR(0, 15, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sys, __pyx_t_2) < 0) __PYX_ERR(0, 16, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":17
+  /* "druhg/_druhg_tree.pyx":18
  * import sys
  * 
+ * from ._druhg_unionfind import UnionFind             # <<<<<<<<<<<<<<
+ * from ._druhg_unionfind cimport UnionFind
+ * 
+ */
+  __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 18, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_INCREF(__pyx_n_s_UnionFind);
+  __Pyx_GIVEREF(__pyx_n_s_UnionFind);
+  PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_UnionFind);
+  __pyx_t_3 = __Pyx_Import(__pyx_n_s_druhg_unionfind, __pyx_t_2, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 18, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+  /* "druhg/_druhg_tree.pyx":21
+ * from ._druhg_unionfind cimport UnionFind
+ * 
  * import _heapq as heapq             # <<<<<<<<<<<<<<
+ * from ._cyheapq import merge as heapq_merge
+ * 
+ */
+  __pyx_t_3 = __Pyx_ImportDottedModule(__pyx_n_s_heapq_2, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 21, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_heapq, __pyx_t_3) < 0) __PYX_ERR(0, 21, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+  /* "druhg/_druhg_tree.pyx":22
+ * 
+ * import _heapq as heapq
+ * from ._cyheapq import merge as heapq_merge             # <<<<<<<<<<<<<<
+ * 
  * from libc.math cimport fabs, pow
- * import bisect
  */
-  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_heapq_2, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __pyx_t_3 = PyList_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 22, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_INCREF(__pyx_n_s_merge);
+  __Pyx_GIVEREF(__pyx_n_s_merge);
+  PyList_SET_ITEM(__pyx_t_3, 0, __pyx_n_s_merge);
+  __pyx_t_2 = __Pyx_Import(__pyx_n_s_cyheapq, __pyx_t_3, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 22, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_heapq, __pyx_t_2) < 0) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_merge); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 22, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_heapq_merge, __pyx_t_3) < 0) __PYX_ERR(0, 22, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":19
- * import _heapq as heapq
+  /* "druhg/_druhg_tree.pyx":25
+ * 
  * from libc.math cimport fabs, pow
  * import bisect             # <<<<<<<<<<<<<<
  * 
  * cdef np.double_t INF = sys.float_info.max
  */
-  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_bisect, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 19, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_ImportDottedModule(__pyx_n_s_bisect, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 25, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_bisect, __pyx_t_2) < 0) __PYX_ERR(0, 19, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_bisect, __pyx_t_2) < 0) __PYX_ERR(0, 25, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "druhg/_druhg_tree.pyx":21
+  /* "druhg/_druhg_tree.pyx":27
  * import bisect
  * 
  * cdef np.double_t INF = sys.float_info.max             # <<<<<<<<<<<<<<
  * 
  * from sklearn.neighbors import KDTree, BallTree
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_sys); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 21, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_sys); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 27, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_float_info); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 21, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_float_info); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 27, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_max); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 21, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_max); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 27, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_4 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_4 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 21, __pyx_L1_error)
+  __pyx_t_4 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_4 == ((npy_double)-1)) && PyErr_Occurred())) __PYX_ERR(0, 27, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __pyx_v_5druhg_11_druhg_tree_INF = __pyx_t_4;
 
-  /* "druhg/_druhg_tree.pyx":23
+  /* "druhg/_druhg_tree.pyx":29
  * cdef np.double_t INF = sys.float_info.max
  * 
  * from sklearn.neighbors import KDTree, BallTree             # <<<<<<<<<<<<<<
  * # from sklearn import preprocessing
  * from joblib import Parallel, delayed
  */
-  __pyx_t_2 = PyList_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 23, __pyx_L1_error)
+  __pyx_t_2 = PyList_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 29, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_INCREF(__pyx_n_s_KDTree);
   __Pyx_GIVEREF(__pyx_n_s_KDTree);
   PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_KDTree);
   __Pyx_INCREF(__pyx_n_s_BallTree);
   __Pyx_GIVEREF(__pyx_n_s_BallTree);
   PyList_SET_ITEM(__pyx_t_2, 1, __pyx_n_s_BallTree);
-  __pyx_t_3 = __Pyx_Import(__pyx_n_s_sklearn_neighbors, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 23, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_Import(__pyx_n_s_sklearn_neighbors, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 29, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_KDTree); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 23, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_KDTree); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 29, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_KDTree, __pyx_t_2) < 0) __PYX_ERR(0, 23, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_KDTree, __pyx_t_2) < 0) __PYX_ERR(0, 29, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_BallTree); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 23, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_BallTree); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 29, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_BallTree, __pyx_t_2) < 0) __PYX_ERR(0, 23, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_BallTree, __pyx_t_2) < 0) __PYX_ERR(0, 29, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "druhg/_druhg_tree.pyx":25
+  /* "druhg/_druhg_tree.pyx":31
  * from sklearn.neighbors import KDTree, BallTree
  * # from sklearn import preprocessing
  * from joblib import Parallel, delayed             # <<<<<<<<<<<<<<
  * 
- * cdef class PairwiseDistanceTreeSparse(object):
+ * def allocate_buffer_values(np.intp_t num_points):
  */
-  __pyx_t_3 = PyList_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 25, __pyx_L1_error)
+  __pyx_t_3 = PyList_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 31, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_INCREF(__pyx_n_s_Parallel);
   __Pyx_GIVEREF(__pyx_n_s_Parallel);
   PyList_SET_ITEM(__pyx_t_3, 0, __pyx_n_s_Parallel);
   __Pyx_INCREF(__pyx_n_s_delayed);
   __Pyx_GIVEREF(__pyx_n_s_delayed);
   PyList_SET_ITEM(__pyx_t_3, 1, __pyx_n_s_delayed);
-  __pyx_t_2 = __Pyx_Import(__pyx_n_s_joblib, __pyx_t_3, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 25, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_Import(__pyx_n_s_joblib, __pyx_t_3, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 31, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_Parallel); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 25, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_Parallel); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 31, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_Parallel, __pyx_t_3) < 0) __PYX_ERR(0, 25, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_Parallel, __pyx_t_3) < 0) __PYX_ERR(0, 31, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_delayed); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 25, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_delayed); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 31, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_delayed, __pyx_t_3) < 0) __PYX_ERR(0, 25, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_delayed, __pyx_t_3) < 0) __PYX_ERR(0, 31, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
+  /* "druhg/_druhg_tree.pyx":33
+ * from joblib import Parallel, delayed
+ * 
+ * def allocate_buffer_values(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ */
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_1allocate_buffer_values, 0, __pyx_n_s_allocate_buffer_values, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__7)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 33, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_allocate_buffer_values, __pyx_t_2) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
   /* "druhg/_druhg_tree.pyx":35
+ * def allocate_buffer_values(np.intp_t num_points):
+ *     return np.empty((num_points - 1), dtype=np.double)
+ * def allocate_buffer_edgepairs(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):
+ */
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_3allocate_buffer_edgepairs, 0, __pyx_n_s_allocate_buffer_edgepairs, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__8)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 35, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_allocate_buffer_edgepairs, __pyx_t_2) < 0) __PYX_ERR(0, 35, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+  /* "druhg/_druhg_tree.pyx":37
+ * def allocate_buffer_edgepairs(np.intp_t num_points):
+ *     return np.empty((num_points*2 - 2), dtype=np.intp)
+ * def allocate_buffer_ranks(np.intp_t num_points):             # <<<<<<<<<<<<<<
+ *     return np.empty((num_points - 1), dtype=np.intp)
+ * 
+ */
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_5allocate_buffer_ranks, 0, __pyx_n_s_allocate_buffer_ranks, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__9)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 37, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_allocate_buffer_ranks, __pyx_t_2) < 0) __PYX_ERR(0, 37, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+  /* "druhg/_druhg_tree.pyx":48
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         # TODO: actually we need to consider replacing INF with something else.
  *         # Reciprocity of absent link is not the same as the INF. Do reciprocity with graphs!
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_3query, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeSparse_query, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__7)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 35, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_3query, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeSparse_query, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__11)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 48, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_2, __pyx_tuple__8);
-  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_dict, __pyx_n_s_query, __pyx_t_2) < 0) __PYX_ERR(0, 35, __pyx_L1_error)
+  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_2, __pyx_tuple__12);
+  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_dict, __pyx_n_s_query, __pyx_t_2) < 0) __PYX_ERR(0, 48, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_5__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeSparse___red, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__10)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_5__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeSparse___red, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__14)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_dict, __pyx_n_s_reduce_cython, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_PairwiseDistanceTreeSparse, (type(self), 0x147f899, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_PairwiseDistanceTreeSparse__set_state(self, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_7__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeSparse___set, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__12)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_26PairwiseDistanceTreeSparse_7__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeSparse___set, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__16)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse->tp_dict, __pyx_n_s_setstate_cython, __pyx_t_2) < 0) __PYX_ERR(1, 16, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeSparse);
 
-  /* "druhg/_druhg_tree.pyx":81
+  /* "druhg/_druhg_tree.pyx":94
  *         self.data_arr = d
  * 
  *     cpdef tuple query(self, d, k, dualtree = 0, breadth_first = 0):             # <<<<<<<<<<<<<<
  *         cdef np.ndarray[np.double_t, ndim=2] knn_dist
  *         cdef np.ndarray[np.intp_t, ndim=2] knn_indices
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_3query, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeGeneric_quer, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__13)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 81, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_3query, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeGeneric_quer, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__17)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 94, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_2, __pyx_tuple__8);
-  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_dict, __pyx_n_s_query, __pyx_t_2) < 0) __PYX_ERR(0, 81, __pyx_L1_error)
+  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_2, __pyx_tuple__12);
+  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_dict, __pyx_n_s_query, __pyx_t_2) < 0) __PYX_ERR(0, 94, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_5__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeGeneric___re, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__14)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_5__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeGeneric___re, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__18)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_dict, __pyx_n_s_reduce_cython, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_PairwiseDistanceTreeGeneric, (type(self), 0x147f899, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_PairwiseDistanceTreeGeneric__set_state(self, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_7__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeGeneric___se, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__15)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_27PairwiseDistanceTreeGeneric_7__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_PairwiseDistanceTreeGeneric___se, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__19)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric->tp_dict, __pyx_n_s_setstate_cython, __pyx_t_2) < 0) __PYX_ERR(1, 16, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_PairwiseDistanceTreeGeneric);
 
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):
- */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_9UnionFind_3__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UnionFind___reduce_cython, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__17)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_reduce_cython, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError, "self.parent cannot be converted to a Python object for pickling"
- */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_9UnionFind_5__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UnionFind___setstate_cython, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__18)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 3, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_setstate_cython, __pyx_t_2) < 0) __PYX_ERR(1, 3, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-  /* "druhg/_druhg_tree.pyx":232
- *         self._compute_tree_edges(is_slow)
+  /* "druhg/_druhg_tree.pyx":223
+ *         self._compute_tree_edges()
  * 
  *     cpdef tuple get_tree(self):             # <<<<<<<<<<<<<<
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
- * 
+ *         return self.result_values_arr[:self.result_edges * 2], self.result_pairs_arr[:self.result_edges*2].astype(int),\
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_3get_tree, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity_get_tree, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__19)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 232, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_3get_tree, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity_get_tree, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__21)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 223, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dict, __pyx_n_s_get_tree, __pyx_t_2) < 0) __PYX_ERR(0, 232, __pyx_L1_error)
+  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dict, __pyx_n_s_get_tree, __pyx_t_2) < 0) __PYX_ERR(0, 223, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity);
 
-  /* "druhg/_druhg_tree.pyx":235
- *         return (self.result_pairs_arr[:self.result_edges*2].astype(int), self.result_value_arr[:self.result_edges])
+  /* "druhg/_druhg_tree.pyx":227
+ *                self.result_rank_arr[:self.result_edges*2].astype(int)
  * 
- *     cpdef tuple get_extras(self):             # <<<<<<<<<<<<<<
- *         return (self.result_extras1_arr[:self.result_edges], self.result_extras2_arr[:self.result_edges])
+ *     cpdef tuple get_buffers(self):             # <<<<<<<<<<<<<<
+ *         return self.result_values_arr, self.U.parent_arr
  * 
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_5get_extras, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity_get_extras, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__20)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 235, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_5get_buffers, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity_get_buffers, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__22)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 227, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dict, __pyx_n_s_get_extras, __pyx_t_2) < 0) __PYX_ERR(0, 235, __pyx_L1_error)
+  if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dict, __pyx_n_s_get_buffers, __pyx_t_2) < 0) __PYX_ERR(0, 227, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity);
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_7__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity___reduce_cy, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__21)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_7__reduce_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity___reduce_cy, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__23)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dict, __pyx_n_s_reduce_cython, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity);
 
   /* "(tree fragment)":16
  *     else:
- *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xdfc22dd, state)
+ *         return __pyx_unpickle_UniversalReciprocity, (type(self), 0xc345828, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_UniversalReciprocity__set_state(self, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_9__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity___setstate, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__22)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_20UniversalReciprocity_9__setstate_cython__, __Pyx_CYFUNCTION_CCLASS, __pyx_n_s_UniversalReciprocity___setstate, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__24)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem((PyObject *)__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity->tp_dict, __pyx_n_s_setstate_cython, __pyx_t_2) < 0) __PYX_ERR(1, 16, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   PyType_Modified(__pyx_ptype_5druhg_11_druhg_tree_UniversalReciprocity);
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_PairwiseDistanceTreeSparse(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_1__pyx_unpickle_PairwiseDistanceTreeSparse, 0, __pyx_n_s_pyx_unpickle_PairwiseDistanceT, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__24)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_7__pyx_unpickle_PairwiseDistanceTreeSparse, 0, __pyx_n_s_pyx_unpickle_PairwiseDistanceT, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__26)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_PairwiseDistanceT, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "(tree fragment)":11
  *         __pyx_unpickle_PairwiseDistanceTreeSparse__set_state(<PairwiseDistanceTreeSparse> __pyx_result, __pyx_state)
  *     return __pyx_result
  * cdef __pyx_unpickle_PairwiseDistanceTreeSparse__set_state(PairwiseDistanceTreeSparse __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_result.data_arr = __pyx_state[0]; __pyx_result.data_size = __pyx_state[1]
  *     if len(__pyx_state) > 2 and hasattr(__pyx_result, '__dict__'):
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_3__pyx_unpickle_PairwiseDistanceTreeGeneric, 0, __pyx_n_s_pyx_unpickle_PairwiseDistanceT_2, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__25)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_9__pyx_unpickle_PairwiseDistanceTreeGeneric, 0, __pyx_n_s_pyx_unpickle_PairwiseDistanceT_2, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__27)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_PairwiseDistanceT_2, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_UniversalReciprocity(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_5__pyx_unpickle_UniversalReciprocity, 0, __pyx_n_s_pyx_unpickle_UniversalReciproc, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__26)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_5druhg_11_druhg_tree_11__pyx_unpickle_UniversalReciprocity, 0, __pyx_n_s_pyx_unpickle_UniversalReciproc, NULL, __pyx_n_s_druhg__druhg_tree, __pyx_d, ((PyObject *)__pyx_codeobj__28)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_UniversalReciproc, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "druhg/_druhg_tree.pyx":1
  * # cython: language_level=3             # <<<<<<<<<<<<<<
  * # cython: boundscheck=False
@@ -18006,40 +17892,14 @@
             return kwvalues[i];
         }
     }
     return NULL;  // not found (no exception set)
 }
 #endif
 
-/* RaiseArgTupleInvalid */
-static void __Pyx_RaiseArgtupleInvalid(
-    const char* func_name,
-    int exact,
-    Py_ssize_t num_min,
-    Py_ssize_t num_max,
-    Py_ssize_t num_found)
-{
-    Py_ssize_t num_expected;
-    const char *more_or_less;
-    if (num_found < num_min) {
-        num_expected = num_min;
-        more_or_less = "at least";
-    } else {
-        num_expected = num_max;
-        more_or_less = "at most";
-    }
-    if (exact) {
-        more_or_less = "exactly";
-    }
-    PyErr_Format(PyExc_TypeError,
-                 "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
-                 func_name, more_or_less, num_expected,
-                 (num_expected == 1) ? "" : "s", num_found);
-}
-
 /* RaiseDoubleKeywords */
 static void __Pyx_RaiseDoubleKeywordsError(
     const char* func_name,
     PyObject* kw_name)
 {
     PyErr_Format(PyExc_TypeError,
         #if PY_MAJOR_VERSION >= 3
@@ -18162,14 +18022,40 @@
         "%s() got an unexpected keyword argument '%U'",
         function_name, key);
     #endif
 bad:
     return -1;
 }
 
+/* RaiseArgTupleInvalid */
+static void __Pyx_RaiseArgtupleInvalid(
+    const char* func_name,
+    int exact,
+    Py_ssize_t num_min,
+    Py_ssize_t num_max,
+    Py_ssize_t num_found)
+{
+    Py_ssize_t num_expected;
+    const char *more_or_less;
+    if (num_found < num_min) {
+        num_expected = num_min;
+        more_or_less = "at least";
+    } else {
+        num_expected = num_max;
+        more_or_less = "at most";
+    }
+    if (exact) {
+        more_or_less = "exactly";
+    }
+    PyErr_Format(PyExc_TypeError,
+                 "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
+                 func_name, more_or_less, num_expected,
+                 (num_expected == 1) ? "" : "s", num_found);
+}
+
 /* PyDictVersioning */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
 static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj) {
     PyObject *dict = Py_TYPE(obj)->tp_dict;
     return likely(dict) ? __PYX_GET_DICT_VERSION(dict) : 0;
 }
 static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj) {
@@ -18188,14 +18074,77 @@
     PyObject *dict = Py_TYPE(obj)->tp_dict;
     if (unlikely(!dict) || unlikely(tp_dict_version != __PYX_GET_DICT_VERSION(dict)))
         return 0;
     return obj_dict_version == __Pyx_get_object_dict_version(obj);
 }
 #endif
 
+/* GetModuleGlobalName */
+#if CYTHON_USE_DICT_VERSIONS
+static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value)
+#else
+static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name)
+#endif
+{
+    PyObject *result;
+#if !CYTHON_AVOID_BORROWED_REFS
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1
+    result = _PyDict_GetItem_KnownHash(__pyx_d, name, ((PyASCIIObject *) name)->hash);
+    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
+    if (likely(result)) {
+        return __Pyx_NewRef(result);
+    } else if (unlikely(PyErr_Occurred())) {
+        return NULL;
+    }
+#elif CYTHON_COMPILING_IN_LIMITED_API
+    if (unlikely(!__pyx_m)) {
+        return NULL;
+    }
+    result = PyObject_GetAttr(__pyx_m, name);
+    if (likely(result)) {
+        return result;
+    }
+#else
+    result = PyDict_GetItem(__pyx_d, name);
+    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
+    if (likely(result)) {
+        return __Pyx_NewRef(result);
+    }
+#endif
+#else
+    result = PyObject_GetItem(__pyx_d, name);
+    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
+    if (likely(result)) {
+        return __Pyx_NewRef(result);
+    }
+    PyErr_Clear();
+#endif
+    return __Pyx_GetBuiltinName(name);
+}
+
+/* PyObjectCall */
+#if CYTHON_COMPILING_IN_CPYTHON
+static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw) {
+    PyObject *result;
+    ternaryfunc call = Py_TYPE(func)->tp_call;
+    if (unlikely(!call))
+        return PyObject_Call(func, arg, kw);
+    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
+        return NULL;
+    result = (*call)(func, arg, kw);
+    Py_LeaveRecursiveCall();
+    if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
+        PyErr_SetString(
+            PyExc_SystemError,
+            "NULL result without error in PyObject_Call");
+    }
+    return result;
+}
+#endif
+
 /* PyFunctionFastCall */
 #if CYTHON_FAST_PYCALL && !CYTHON_VECTORCALL
 static PyObject* __Pyx_PyFunction_FastCallNoKw(PyCodeObject *co, PyObject **args, Py_ssize_t na,
                                                PyObject *globals) {
     PyFrameObject *f;
     PyThreadState *tstate = __Pyx_PyThreadState_Current;
     PyObject **fastlocals;
@@ -18305,34 +18254,14 @@
     Py_XDECREF(kwtuple);
 done:
     Py_LeaveRecursiveCall();
     return result;
 }
 #endif
 
-/* PyObjectCall */
-#if CYTHON_COMPILING_IN_CPYTHON
-static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw) {
-    PyObject *result;
-    ternaryfunc call = Py_TYPE(func)->tp_call;
-    if (unlikely(!call))
-        return PyObject_Call(func, arg, kw);
-    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
-        return NULL;
-    result = (*call)(func, arg, kw);
-    Py_LeaveRecursiveCall();
-    if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
-        PyErr_SetString(
-            PyExc_SystemError,
-            "NULL result without error in PyObject_Call");
-    }
-    return result;
-}
-#endif
-
 /* PyObjectCallMethO */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg) {
     PyObject *self, *result;
     PyCFunction cfunc;
     cfunc = PyCFunction_GET_FUNCTION(func);
     self = PyCFunction_GET_SELF(func);
@@ -18433,57 +18362,14 @@
     __Pyx_TypeName obj_type_name = __Pyx_PyType_GetName(Py_TYPE(obj));
     PyErr_Format(PyExc_TypeError, "Expected %s, got " __Pyx_FMT_TYPENAME,
                  expected, obj_type_name);
     __Pyx_DECREF_TypeName(obj_type_name);
     return 0;
 }
 
-/* GetModuleGlobalName */
-#if CYTHON_USE_DICT_VERSIONS
-static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value)
-#else
-static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name)
-#endif
-{
-    PyObject *result;
-#if !CYTHON_AVOID_BORROWED_REFS
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1
-    result = _PyDict_GetItem_KnownHash(__pyx_d, name, ((PyASCIIObject *) name)->hash);
-    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
-    if (likely(result)) {
-        return __Pyx_NewRef(result);
-    } else if (unlikely(PyErr_Occurred())) {
-        return NULL;
-    }
-#elif CYTHON_COMPILING_IN_LIMITED_API
-    if (unlikely(!__pyx_m)) {
-        return NULL;
-    }
-    result = PyObject_GetAttr(__pyx_m, name);
-    if (likely(result)) {
-        return result;
-    }
-#else
-    result = PyDict_GetItem(__pyx_d, name);
-    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
-    if (likely(result)) {
-        return __Pyx_NewRef(result);
-    }
-#endif
-#else
-    result = PyObject_GetItem(__pyx_d, name);
-    __PYX_UPDATE_DICT_CACHE(__pyx_d, result, *dict_cached_value, *dict_version)
-    if (likely(result)) {
-        return __Pyx_NewRef(result);
-    }
-    PyErr_Clear();
-#endif
-    return __Pyx_GetBuiltinName(name);
-}
-
 /* PyIntBinop */
 #if !CYTHON_COMPILING_IN_PYPY
 static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check) {
     CYTHON_MAYBE_UNUSED_VAR(intval);
     CYTHON_MAYBE_UNUSED_VAR(inplace);
     CYTHON_UNUSED_VAR(zerodivision_check);
     #if PY_MAJOR_VERSION < 3
@@ -19621,173 +19507,14 @@
         return r;
     }
 #endif
     r = PyObject_GetAttr(o, n);
     return (likely(r)) ? r : __Pyx_GetAttr3Default(d);
 }
 
-/* RaiseException */
-  #if PY_MAJOR_VERSION < 3
-static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
-    __Pyx_PyThreadState_declare
-    CYTHON_UNUSED_VAR(cause);
-    Py_XINCREF(type);
-    if (!value || value == Py_None)
-        value = NULL;
-    else
-        Py_INCREF(value);
-    if (!tb || tb == Py_None)
-        tb = NULL;
-    else {
-        Py_INCREF(tb);
-        if (!PyTraceBack_Check(tb)) {
-            PyErr_SetString(PyExc_TypeError,
-                "raise: arg 3 must be a traceback or None");
-            goto raise_error;
-        }
-    }
-    if (PyType_Check(type)) {
-#if CYTHON_COMPILING_IN_PYPY
-        if (!value) {
-            Py_INCREF(Py_None);
-            value = Py_None;
-        }
-#endif
-        PyErr_NormalizeException(&type, &value, &tb);
-    } else {
-        if (value) {
-            PyErr_SetString(PyExc_TypeError,
-                "instance exception may not have a separate value");
-            goto raise_error;
-        }
-        value = type;
-        type = (PyObject*) Py_TYPE(type);
-        Py_INCREF(type);
-        if (!PyType_IsSubtype((PyTypeObject *)type, (PyTypeObject *)PyExc_BaseException)) {
-            PyErr_SetString(PyExc_TypeError,
-                "raise: exception class must be a subclass of BaseException");
-            goto raise_error;
-        }
-    }
-    __Pyx_PyThreadState_assign
-    __Pyx_ErrRestore(type, value, tb);
-    return;
-raise_error:
-    Py_XDECREF(value);
-    Py_XDECREF(type);
-    Py_XDECREF(tb);
-    return;
-}
-#else
-static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
-    PyObject* owned_instance = NULL;
-    if (tb == Py_None) {
-        tb = 0;
-    } else if (tb && !PyTraceBack_Check(tb)) {
-        PyErr_SetString(PyExc_TypeError,
-            "raise: arg 3 must be a traceback or None");
-        goto bad;
-    }
-    if (value == Py_None)
-        value = 0;
-    if (PyExceptionInstance_Check(type)) {
-        if (value) {
-            PyErr_SetString(PyExc_TypeError,
-                "instance exception may not have a separate value");
-            goto bad;
-        }
-        value = type;
-        type = (PyObject*) Py_TYPE(value);
-    } else if (PyExceptionClass_Check(type)) {
-        PyObject *instance_class = NULL;
-        if (value && PyExceptionInstance_Check(value)) {
-            instance_class = (PyObject*) Py_TYPE(value);
-            if (instance_class != type) {
-                int is_subclass = PyObject_IsSubclass(instance_class, type);
-                if (!is_subclass) {
-                    instance_class = NULL;
-                } else if (unlikely(is_subclass == -1)) {
-                    goto bad;
-                } else {
-                    type = instance_class;
-                }
-            }
-        }
-        if (!instance_class) {
-            PyObject *args;
-            if (!value)
-                args = PyTuple_New(0);
-            else if (PyTuple_Check(value)) {
-                Py_INCREF(value);
-                args = value;
-            } else
-                args = PyTuple_Pack(1, value);
-            if (!args)
-                goto bad;
-            owned_instance = PyObject_Call(type, args, NULL);
-            Py_DECREF(args);
-            if (!owned_instance)
-                goto bad;
-            value = owned_instance;
-            if (!PyExceptionInstance_Check(value)) {
-                PyErr_Format(PyExc_TypeError,
-                             "calling %R should have returned an instance of "
-                             "BaseException, not %R",
-                             type, Py_TYPE(value));
-                goto bad;
-            }
-        }
-    } else {
-        PyErr_SetString(PyExc_TypeError,
-            "raise: exception class must be a subclass of BaseException");
-        goto bad;
-    }
-    if (cause) {
-        PyObject *fixed_cause;
-        if (cause == Py_None) {
-            fixed_cause = NULL;
-        } else if (PyExceptionClass_Check(cause)) {
-            fixed_cause = PyObject_CallObject(cause, NULL);
-            if (fixed_cause == NULL)
-                goto bad;
-        } else if (PyExceptionInstance_Check(cause)) {
-            fixed_cause = cause;
-            Py_INCREF(fixed_cause);
-        } else {
-            PyErr_SetString(PyExc_TypeError,
-                            "exception causes must derive from "
-                            "BaseException");
-            goto bad;
-        }
-        PyException_SetCause(value, fixed_cause);
-    }
-    PyErr_SetObject(type, value);
-    if (tb) {
-#if CYTHON_COMPILING_IN_PYPY ||  CYTHON_COMPILING_IN_LIMITED_API
-        PyObject *tmp_type, *tmp_value, *tmp_tb;
-        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
-        Py_INCREF(tb);
-        PyErr_Restore(tmp_type, tmp_value, tb);
-        Py_XDECREF(tmp_tb);
-#else
-        PyThreadState *tstate = __Pyx_PyThreadState_Current;
-        PyObject* tmp_tb = tstate->curexc_traceback;
-        if (tb != tmp_tb) {
-            Py_INCREF(tb);
-            tstate->curexc_traceback = tb;
-            Py_XDECREF(tmp_tb);
-        }
-#endif
-    }
-bad:
-    Py_XDECREF(owned_instance);
-    return;
-}
-#endif
-
 /* UnpackUnboundCMethod */
   static int __Pyx_TryUnpackUnboundCMethod(__Pyx_CachedCFunction* target) {
     PyObject *method;
     method = __Pyx_PyObject_GetAttrStr(target->type, *target->method_name);
     if (unlikely(!method))
         return -1;
     target->method = method;
@@ -20473,14 +20200,173 @@
         return *p_left;
     } else {
         return __Pyx_PyUnicode_Concat(left, right);
     }
   }
 #endif
 
+/* RaiseException */
+  #if PY_MAJOR_VERSION < 3
+static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
+    __Pyx_PyThreadState_declare
+    CYTHON_UNUSED_VAR(cause);
+    Py_XINCREF(type);
+    if (!value || value == Py_None)
+        value = NULL;
+    else
+        Py_INCREF(value);
+    if (!tb || tb == Py_None)
+        tb = NULL;
+    else {
+        Py_INCREF(tb);
+        if (!PyTraceBack_Check(tb)) {
+            PyErr_SetString(PyExc_TypeError,
+                "raise: arg 3 must be a traceback or None");
+            goto raise_error;
+        }
+    }
+    if (PyType_Check(type)) {
+#if CYTHON_COMPILING_IN_PYPY
+        if (!value) {
+            Py_INCREF(Py_None);
+            value = Py_None;
+        }
+#endif
+        PyErr_NormalizeException(&type, &value, &tb);
+    } else {
+        if (value) {
+            PyErr_SetString(PyExc_TypeError,
+                "instance exception may not have a separate value");
+            goto raise_error;
+        }
+        value = type;
+        type = (PyObject*) Py_TYPE(type);
+        Py_INCREF(type);
+        if (!PyType_IsSubtype((PyTypeObject *)type, (PyTypeObject *)PyExc_BaseException)) {
+            PyErr_SetString(PyExc_TypeError,
+                "raise: exception class must be a subclass of BaseException");
+            goto raise_error;
+        }
+    }
+    __Pyx_PyThreadState_assign
+    __Pyx_ErrRestore(type, value, tb);
+    return;
+raise_error:
+    Py_XDECREF(value);
+    Py_XDECREF(type);
+    Py_XDECREF(tb);
+    return;
+}
+#else
+static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
+    PyObject* owned_instance = NULL;
+    if (tb == Py_None) {
+        tb = 0;
+    } else if (tb && !PyTraceBack_Check(tb)) {
+        PyErr_SetString(PyExc_TypeError,
+            "raise: arg 3 must be a traceback or None");
+        goto bad;
+    }
+    if (value == Py_None)
+        value = 0;
+    if (PyExceptionInstance_Check(type)) {
+        if (value) {
+            PyErr_SetString(PyExc_TypeError,
+                "instance exception may not have a separate value");
+            goto bad;
+        }
+        value = type;
+        type = (PyObject*) Py_TYPE(value);
+    } else if (PyExceptionClass_Check(type)) {
+        PyObject *instance_class = NULL;
+        if (value && PyExceptionInstance_Check(value)) {
+            instance_class = (PyObject*) Py_TYPE(value);
+            if (instance_class != type) {
+                int is_subclass = PyObject_IsSubclass(instance_class, type);
+                if (!is_subclass) {
+                    instance_class = NULL;
+                } else if (unlikely(is_subclass == -1)) {
+                    goto bad;
+                } else {
+                    type = instance_class;
+                }
+            }
+        }
+        if (!instance_class) {
+            PyObject *args;
+            if (!value)
+                args = PyTuple_New(0);
+            else if (PyTuple_Check(value)) {
+                Py_INCREF(value);
+                args = value;
+            } else
+                args = PyTuple_Pack(1, value);
+            if (!args)
+                goto bad;
+            owned_instance = PyObject_Call(type, args, NULL);
+            Py_DECREF(args);
+            if (!owned_instance)
+                goto bad;
+            value = owned_instance;
+            if (!PyExceptionInstance_Check(value)) {
+                PyErr_Format(PyExc_TypeError,
+                             "calling %R should have returned an instance of "
+                             "BaseException, not %R",
+                             type, Py_TYPE(value));
+                goto bad;
+            }
+        }
+    } else {
+        PyErr_SetString(PyExc_TypeError,
+            "raise: exception class must be a subclass of BaseException");
+        goto bad;
+    }
+    if (cause) {
+        PyObject *fixed_cause;
+        if (cause == Py_None) {
+            fixed_cause = NULL;
+        } else if (PyExceptionClass_Check(cause)) {
+            fixed_cause = PyObject_CallObject(cause, NULL);
+            if (fixed_cause == NULL)
+                goto bad;
+        } else if (PyExceptionInstance_Check(cause)) {
+            fixed_cause = cause;
+            Py_INCREF(fixed_cause);
+        } else {
+            PyErr_SetString(PyExc_TypeError,
+                            "exception causes must derive from "
+                            "BaseException");
+            goto bad;
+        }
+        PyException_SetCause(value, fixed_cause);
+    }
+    PyErr_SetObject(type, value);
+    if (tb) {
+#if CYTHON_COMPILING_IN_PYPY ||  CYTHON_COMPILING_IN_LIMITED_API
+        PyObject *tmp_type, *tmp_value, *tmp_tb;
+        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
+        Py_INCREF(tb);
+        PyErr_Restore(tmp_type, tmp_value, tb);
+        Py_XDECREF(tmp_tb);
+#else
+        PyThreadState *tstate = __Pyx_PyThreadState_Current;
+        PyObject* tmp_tb = tstate->curexc_traceback;
+        if (tb != tmp_tb) {
+            Py_INCREF(tb);
+            tstate->curexc_traceback = tb;
+            Py_XDECREF(tmp_tb);
+        }
+#endif
+    }
+bad:
+    Py_XDECREF(owned_instance);
+    return;
+}
+#endif
+
 /* SliceObject */
   static CYTHON_INLINE PyObject* __Pyx_PyObject_GetSlice(PyObject* obj,
         Py_ssize_t cstart, Py_ssize_t cstop,
         PyObject** _py_start, PyObject** _py_stop, PyObject** _py_slice,
         int has_cstart, int has_cstop, int wraparound) {
     __Pyx_TypeName obj_type_name;
 #if CYTHON_USE_TYPE_SLOTS
@@ -20732,14 +20618,87 @@
         #ifdef __Pyx_StopAsyncIteration_USED
         is_async_stopiteration ? "async generator raised StopAsyncIteration" :
         in_async_gen ? "async generator raised StopIteration" :
         #endif
         "generator raised StopIteration");
 }
 
+/* PyIntCompare */
+  static CYTHON_INLINE PyObject* __Pyx_PyInt_NeObjC(PyObject *op1, PyObject *op2, long intval, long inplace) {
+    CYTHON_MAYBE_UNUSED_VAR(intval);
+    CYTHON_UNUSED_VAR(inplace);
+    if (op1 == op2) {
+        Py_RETURN_FALSE;
+    }
+    #if PY_MAJOR_VERSION < 3
+    if (likely(PyInt_CheckExact(op1))) {
+        const long b = intval;
+        long a = PyInt_AS_LONG(op1);
+        if (a != b) Py_RETURN_TRUE; else Py_RETURN_FALSE;
+    }
+    #endif
+    #if CYTHON_USE_PYLONG_INTERNALS
+    if (likely(PyLong_CheckExact(op1))) {
+        int unequal;
+        unsigned long uintval;
+        Py_ssize_t size = Py_SIZE(op1);
+        const digit* digits = ((PyLongObject*)op1)->ob_digit;
+        if (intval == 0) {
+            if (size != 0) Py_RETURN_TRUE; else Py_RETURN_FALSE;
+        } else if (intval < 0) {
+            if (size >= 0)
+                Py_RETURN_TRUE;
+            intval = -intval;
+            size = -size;
+        } else {
+            if (size <= 0)
+                Py_RETURN_TRUE;
+        }
+        uintval = (unsigned long) intval;
+#if PyLong_SHIFT * 4 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 4)) {
+            unequal = (size != 5) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[2] != ((uintval >> (2 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[3] != ((uintval >> (3 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[4] != ((uintval >> (4 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+#if PyLong_SHIFT * 3 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 3)) {
+            unequal = (size != 4) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[2] != ((uintval >> (2 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[3] != ((uintval >> (3 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+#if PyLong_SHIFT * 2 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 2)) {
+            unequal = (size != 3) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK)) | (digits[2] != ((uintval >> (2 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+#if PyLong_SHIFT * 1 < SIZEOF_LONG*8
+        if (uintval >> (PyLong_SHIFT * 1)) {
+            unequal = (size != 2) || (digits[0] != (uintval & (unsigned long) PyLong_MASK))
+                 | (digits[1] != ((uintval >> (1 * PyLong_SHIFT)) & (unsigned long) PyLong_MASK));
+        } else
+#endif
+            unequal = (size != 1) || (((unsigned long) digits[0]) != (uintval & (unsigned long) PyLong_MASK));
+        if (unequal != 0) Py_RETURN_TRUE; else Py_RETURN_FALSE;
+    }
+    #endif
+    if (PyFloat_CheckExact(op1)) {
+        const long b = intval;
+#if CYTHON_COMPILING_IN_LIMITED_API
+        double a = __pyx_PyFloat_AsDouble(op1);
+#else
+        double a = PyFloat_AS_DOUBLE(op1);
+#endif
+        if ((double)a != (double)b) Py_RETURN_TRUE; else Py_RETURN_FALSE;
+    }
+    return (
+        PyObject_RichCompare(op1, op2, Py_NE));
+}
+
 /* Import */
   static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
     PyObject *module = 0;
     PyObject *empty_dict = 0;
     PyObject *empty_list = 0;
     #if PY_MAJOR_VERSION < 3
     PyObject *py_import;
@@ -23636,15 +23595,15 @@
 static __Pyx_TypeName
 __Pyx_PyType_GetName(PyTypeObject* tp)
 {
     PyObject *name = __Pyx_PyObject_GetAttrStr((PyObject *)tp,
                                                __pyx_n_s_name);
     if (unlikely(name == NULL) || unlikely(!PyUnicode_Check(name))) {
         PyErr_Clear();
-        Py_XSETREF(name, __Pyx_NewRef(__pyx_n_s__27));
+        Py_XSETREF(name, __Pyx_NewRef(__pyx_n_s__29));
     }
     return name;
 }
 #endif
 
 /* FastTypeChecks */
   #if CYTHON_COMPILING_IN_CPYTHON
```

### Comparing `druhg-1.3.0/druhg/plots.py` & `druhg-1.4.0/druhg/plots.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,181 +1,185 @@
 # -*- coding: utf-8 -*-
-# Author: Pavel "DRUHG" Artamonov
+# Author: Pavel Artamonov
 # License: 3-clause BSD
 
 
 import numpy as np
+import collections
+from math import exp, log
+
 
 # from scipy.cluster.hierarchy import dendrogram
 from sklearn.manifold import TSNE
 from sklearn.decomposition import PCA
 from warnings import warn
 
+
+class Joint(object):
+    def __init__(self, size=1, dist=0.):
+        self.size = size
+        self.val = dist
+        self.L = None  # L.size >= R.size
+        self.R = None
+        self.T = None
+        self.c = 'gray'
+
+    def walkup(self):
+        t = self
+        while t.T:
+            t = t.T
+        return t
+
+    def walkdown(self):
+        l = self
+        while l.L:
+            l = l.L
+        return l
+
+
 class SingleLinkage(object):
-# todo: make it pretty
+    # todo: make it pretty
     def __init__(self, mst_pairs, values, labels):
         self._mst_pairs = mst_pairs
         self._values = values
         # self._data = data
         self._labels = labels
 
-    def fast_find(self, unionfind, n):
-        n = int(n)
-        p = unionfind[n]
-        if p == 0:
-            return n
-
-        while unionfind[p] != 0:
-            p = unionfind[p]
-
-        # label up to the root
-        while p != n:
-            temp = unionfind[n]
-            unionfind[n] = p
-            n = temp
-
-        return p
-
+        self.default_scale_coef = 10.
+        self.max_value = 1.
 
     def draw_dendrogram(self, ax, pairs, values, labels, lw=20., alpha=0.4, cmap='viridis'):
-        try:
-            from matplotlib import collections as mc
-            from matplotlib.pyplot import Arrow
-            from matplotlib.pyplot import Normalize
-            from matplotlib.pyplot import cm
-        except ImportError:
-            raise ImportError('You must install the matplotlib library to plot the minimum spanning tree.')
+        # Step 1: Fill and connect Joints. Evaluate scales.
+        # Step 2: Arrange outstanding trees.
+        # Step 3: Depth-First search. Apply radial or flat visualisation func.
 
         min_index, max_index = min(pairs), max(pairs)
         if min_index < 0:
             raise ValueError('Indices should be non-negative')
+        min_value, self.max_value = min(values), max(values[values != np.inf])
+        if min_value < 0:
+            raise ValueError('Values should be non-negative')
 
-        size = int(len(pairs) / 2 + 1)
+        cm = self.get_dendro_colors(labels)
 
-        union_size = size
-        if max_index > union_size - 1:
-            union_size = max_index + 1
-        union_size += 2
-
-        # we will create Union Find as usual
-        uf, sz = np.zeros(2 * union_size, dtype=int), np.ones(union_size)
-        next_label = union_size + 1
-        # also we need links
-        l, r = np.arange(0, 2*union_size), np.arange(0, 2*union_size)
+        scale_sum = 0.
 
-        next_label = union_size + 1
+        size = int(len(pairs) / 2 + 1)
+        tops = {}
+        # trees building
         for j in range(0, size - 1):
             a, b = pairs[2 * j], pairs[2 * j + 1]
 
-            # we will stack first cluster on the left of second
-            aa = a
-            while aa != r[aa]:
-                aa = r[aa]
-            bb = b
-            while bb != l[bb]:
-                bb = l[bb]
-            l[bb] = aa
-            r[aa] = bb # linking
-
-            aa = a
-            while aa != l[aa]:
-                aa = l[aa]
-            bb = b
-            while bb != r[bb]:
-                bb = r[bb]
-            l[next_label] = aa # marking the borders
-            r[next_label] = bb
+            v = values[j]
+            if v == np.inf:
+                scale_sum += self.max_value * self.default_scale_coef
+            else:
+                scale_sum += v
 
-            aa, bb = self.fast_find(uf, a), self.fast_find(uf, b)
-            uf[aa] = uf[bb] = next_label
+            topjoi = Joint()
 
-            # i = next_label - union_size
-            # a2 = (uf[a] != 0) * (aa - union_size)
-            # b2 = (uf[b] != 0) * (bb - union_size)
-            # na, nb = sz[a2], sz[b2]
-            # sz[i] = na + nb
-
-            next_label += 1
-
-        x_arr = self.arrange_nodes_on_x_axis(uf, union_size, l, r, 200.)
-
-        norm = len(np.unique(pairs))
-        sm = cm.ScalarMappable(cmap=cmap,
-                                   norm=Normalize(0, norm))
-        sm.set_array(norm)
-
-        colors = self.get_dendro_colors(labels)
-        heights = {}
-        uf.fill(0)
-        next_label = union_size + 1
-        for j in range(0, size - 1):
-            v = np.log2(1. + values[j]) # logarithm
-            heights[next_label] = v
+            ta, sa = None, 1
+            if a in tops:
+                ta = tops[a].walkup()
+                sa = ta.size
+                ta.T = topjoi
+
+            tb, sb = None, 1
+            if b in tops:
+                tb = tops[b].walkup()
+                sb = tb.size
+                tb.T = topjoi
+
+            topjoi.size = sa + sb
+            topjoi.val = v
+            if sa >= sb:
+                topjoi.L, topjoi.R = ta, tb
+            else:
+                topjoi.L, topjoi.R = tb, ta
 
-            a, b = pairs[2 * j], pairs[2 * j + 1]
+            if labels[a] == labels[b]:
+                topjoi.c = cm[labels[a]]
+            tops[a] = topjoi
+            tops[b] = topjoi
 
-            # i = next_label - union_size
-            aa, bb = self.fast_find(uf, a), self.fast_find(uf, b)
-            x_arr[next_label] = (x_arr[r[aa]] + x_arr[l[bb]])/2.
-            uf[aa] = uf[bb] = next_label
-            next_label += 1
-
-            # a = (uf[a] != 0) * (aa - union_size)
-            # b = (uf[b] != 0) * (bb - union_size)
-            # na, nb = sz[a], sz[b]
-            # sz[i] = na + nb
-
-            ha, hb = 0, 0
-            xa, xb = x_arr[aa], x_arr[bb]
-            if aa in heights:
-                ha = heights[aa]
-            if bb in heights:
-                hb = heights[bb]
-
-            c = 'gray'
-            if labels[a] == labels[b] and labels[a] > 0:
-                c = colors[labels[a]]
-
-            ax.plot([xa, xa], [ha, v], color=c)
-            ax.plot([xb, xb], [hb, v], color=c)
-            ax.plot([xa, xb], [v, v], color=c)
+        # arranging trees in case they are not connected
+        trees = collections.OrderedDict()
+        for t in tops:
+            joi = tops[t].walkup()
+            if joi not in trees:
+                trees[joi] = joi.size
+
+        scale_sum += (len(trees) - 1) * self.max_value * self.default_scale_coef
+
+        self.plot_radial(ax, trees, labels, scale_sum)
+
+
+
+    def plot_radial(self, ax, trees, labels, scale_sum):
+        try:
+            from matplotlib import collections as mc
+            from matplotlib.pyplot import Arrow
+            from matplotlib.pyplot import Normalize
+            from matplotlib.pyplot import cm
+        except ImportError:
+            raise ImportError('You must install the matplotlib library to plot the minimum spanning tree.')
+
+        # norm = len(labels)
+        # sm = cm.ScalarMappable(cmap=cmap,
+        #                            norm=Normalize(0, norm))
+        # sm.set_array(norm)
+        # colors = self.get_dendro_colors(labels)
+        # c = 'gray'
+
+        # depth first search
+        x = 0.
+        # print('so many treeess', len(trees))
+
+        for tree in trees:
+            l = tree.walkdown()
+            while l:
+                l, x = self.dps_flat_plot(ax, l, x)
+            x += self.max_value * self.default_scale_coef
 
         ax.set_xticks([])
         for side in ('right', 'top', 'bottom'):
             ax.spines[side].set_visible(False)
         ax.set_ylabel('distance')
 
-        # line_collection.set_array(self._mst[:, 2].T)
         return ax
 
-    def arrange_nodes_on_x_axis(self, uf, union_size, l, r, step = 2.):
-        x_arr = np.zeros(2 * union_size, dtype=int)
-        processed = {}
-        x = 1.
-        # constructing the tree
-        # there is a possibility of a forest instead of a tree
-        for a in (0, union_size):
-            if l[a] == a: # can happened when some indices were not passed
-                continue
-
-            aa = self.fast_find(uf, a)
-            if aa in processed:
-                continue
-            processed[aa] = aa
-            aa = a
-            while aa != r[aa]:
-                aa = r[aa]
-            while aa != l[aa]:
-                x_arr[aa] = x
-
-                x += step
-                aa = l[aa]
-            x_arr[aa] = x
+    def dps_flat_plot(self, ax, joi, x):
+        c = joi.c
+        v = joi.val
+        vexp = (1.+v)**2
+        x1 = x
+        nx = x + vexp
+        x2 = nx
+        ht = vexp
+        h1 = h2 = (1. + v / 2.)**2
+        s1 = s2 = 1
+        if joi.L:
+            h1 = joi.L.val
+            s1 = joi.L.size
+        if joi.R:
+            h2 = joi.R.val
+            s2 = joi.R.size
+
+        ax.plot([x1, x2], [ht, ht], color=c, linewidth=log(1+s2))
+        ax.plot([x1, x1], [ht, h1], color=c)
+        ax.plot([x2, x2], [ht, h2], color=c)
+        # print(x1, x2, ht, h1, h2)
+        # print('hello', s1, s2, v, joi.L, joi.R, joi.T)
+
+        if joi.R is not None:
+            r = joi.R.walkdown()
+            while r!=joi:
+                r, nx = self.dps_flat_plot(ax, r, nx)
 
-        return x_arr
+        return joi.T, nx
 
     def get_dendro_colors(self, labels):
         try:
             import seaborn as sns
         except ImportError:
             raise ImportError('You must install the seaborn library to draw colored labels.')
 
@@ -222,44 +226,46 @@
         """
         try:
             import matplotlib.pyplot as plt
         except ImportError:
             raise ImportError('You must install the matplotlib library to plot the minimum spanning tree.')
 
         if axis is None:
-            axis = plt.gca()
-            axis.set_axis_off()
+            # axis = plt.gca()
+            # axis.set_axis_off()
+            fig = plt.figure(figsize=[130, 50])
+            axis = plt.subplot(111)
 
 
         axis = self.draw_dendrogram(axis, self._mst_pairs, self._values, self._labels)
 
         return axis
 
 
 class MinimumSpanningTree(object):
     def __init__(self, mst_pairs, data, labels):
         self._mst_pairs = mst_pairs
-        self._data = data
+        self._raw_data = data
         self._labels = labels
 
     def decrease_dimensions(self):
-        if self._data.shape[1] > 2:
+        if self._raw_data.shape[1] > 2:
             # Get a 2D projection; if we have a lot of dimensions use PCA first
-            if self._data.shape[1] > 32:
+            if self._raw_data.shape[1] > 32:
                 # Use PCA to get down to 32 dimension
-                data_for_projection = PCA(n_components=32).fit_transform(self._data)
+                data_for_projection = PCA(n_components=32).fit_transform(self._raw_data)
             else:
-                data_for_projection = self._data
+                data_for_projection = self._raw_data
 
             projection = TSNE().fit_transform(data_for_projection)
-        elif self._data.shape[1] == 2:
-            projection = self._data.copy()
+        elif self._raw_data.shape[1] == 2:
+            projection = self._raw_data.copy()
         else:
             # one dimensional. We need to add dimension
-            projection = self._data.copy()
+            projection = self._raw_data.copy()
             projection = np.array([e for e in enumerate(projection)], np.int)
 
         return projection
 
     def get_node_colors(self, labels):
         try:
             import seaborn as sns
@@ -288,35 +294,14 @@
                 continue
             alpha = a * counts[i] + b
             color_map[unique[i]] = palette[col] + (alpha,)
             col += 1
 
         return [color_map[x] for x in labels]
 
-    def draw_simple_edges(self, ax, pairs, pos, lw=2., alpha=0.5):
-        try:
-            from matplotlib import collections as mc
-        except ImportError:
-            raise ImportError('You must install the matplotlib library to plot the minimum spanning tree.')
-
-        lines, line_heads = [], []
-
-        size = int(len(pairs) / 2)
-        for i in range(0, size):
-            start, end = pos[pairs[2 * i]], pos[pairs[2 * i + 1]]
-
-            lines.append([start, end])
-            line_heads.append([((start + end) / 2 + end) / 2, end])
-
-        lc = mc.LineCollection(lines, colors=(0., 0., 0., alpha), linewidths=lw)
-        ax.add_collection(lc)
-
-        lc = mc.LineCollection(line_heads, colors=(0., 0., 0., alpha * 0.8), linewidths=lw * 4.)
-        ax.add_collection(lc)
-
     def fast_find(self, unionfind, n):
         n = int(n)
         p = unionfind[n]
         if p == 0:
             return n
 
         while unionfind[p] != 0:
@@ -326,20 +311,15 @@
         while p != n:
             temp = unionfind[n]
             unionfind[n] = p
             n = temp
 
         return p
 
-    def merge_means(self, na, meana, nb, meanb):
-        delta = meanb - meana
-        meana = meana + delta * nb / (na + nb)
-        return meana
-
-    def draw_druhg_edges(self, ax, pairs, pos, lw=20., alpha=0.4):
+    def draw_edges(self, ax, pairs, pos, cols, lw=20., alpha=0.4, vary_line_width = None):
         try:
             from matplotlib import collections as mc
             from matplotlib.pyplot import Arrow
         except ImportError:
             raise ImportError('You must install the matplotlib library to plot the minimum spanning tree.')
 
         min_index, max_index = min(pairs), max(pairs)
@@ -352,45 +332,61 @@
         if max_index > union_size - 1:
             union_size = max_index + 1
         union_size += 2
 
         uf, sz = np.zeros(2 * union_size, dtype=int), np.ones(union_size)
         next_label = union_size + 1
 
-        default_color = (0, 0, 0, alpha)
+        line_width = 0.5
+
+        outliner_color = (0, 0, 0, alpha)
+        clusters_color = (0, 0, 0, min(alpha*2.,1.))
+
         min_arrow_width = 0.002
         max_arrow_width = lw
         max_collision = np.sqrt(union_size)
-        thick_a = (max_arrow_width - min_arrow_width)/(1.*max_collision - 1)
-        thick_b = max_arrow_width - 1.*max_collision*thick_a
+        thick_a = (max_arrow_width - min_arrow_width) / (1. * max_collision - 1)
+        thick_b = max_arrow_width - 1. * max_collision * thick_a
         for j in range(0, size - 1):
             a, b = pairs[2 * j], pairs[2 * j + 1]
             start, end = pos[a], pos[b]
 
+            color = outliner_color
+            if self._labels[a] < 0 or self._labels[b] < 0:
+                color = outliner_color
+            elif self._labels[a] == self._labels[b]:
+                color = cols[a]
+                color = (color[0], color[1], color[2], alpha)
+            else:
+                color = clusters_color
+
             i = next_label - union_size
             aa, bb = self.fast_find(uf, a), self.fast_find(uf, b)
 
             a = (uf[a] != 0) * (aa - union_size)
             b = (uf[b] != 0) * (bb - union_size)
-            uf[aa] = uf[bb] = next_label
-            next_label += 1
+            if aa!=bb:
+                uf[aa] = uf[bb] = next_label
+                next_label += 1
 
-            na, nb = sz[a], sz[b]
-            sz[i] = na + nb
+                na, nb = sz[a], sz[b]
+                sz[i] = na + nb
 
             size_reflection = np.sqrt(min(na, nb))
-            w = size_reflection*thick_a + thick_b
-            arr = Arrow(start[0], start[1], end[0] - start[0], end[1] - start[1], color = default_color, width=w)
+            if vary_line_width:
+                line_width = size_reflection * thick_a + thick_b
+
+            arr = Arrow(start[0], start[1], end[0] - start[0], end[1] - start[1], color=color, width=line_width)
             ax.add_patch(arr)
 
         # line_collection.set_array(self._mst[:, 2].T)
 
     def plot(self, axis=None, node_size=40, node_color=None,
              node_alpha=0.8, edge_alpha=0.15, edge_linewidth=8, vary_line_width=True,
-             core_color = 'purple'):
+             core_color='purple'):
         """Plot the minimum spanning tree (as projected into 2D by t-SNE if required).
 
         Parameters
         ----------
 
         axis : matplotlib axis, optional
                The axis to render the plot to
@@ -428,33 +424,33 @@
                 The axis used the render the plot.
         """
         try:
             import matplotlib.pyplot as plt
         except ImportError:
             raise ImportError('You must install the matplotlib library to plot the minimum spanning tree.')
 
-        if self._data.shape[0] > 32767:
+        if self._raw_data.shape[0] > 32767:
             warn('Too many data points for safe rendering of a minimal spanning tree!')
             return None
 
         if axis is None:
             axis = plt.gca()
             axis.set_axis_off()
 
         pos = self.decrease_dimensions()
 
+        cols = node_color
         if node_color is None:
-            axis.scatter(pos.T[0], pos.T[1], c=self.get_node_colors(self._labels), s=node_size, alpha=node_alpha)
+            cols = self.get_node_colors(self._labels)
+            axis.scatter(pos.T[0], pos.T[1], c=cols, s=node_size, alpha=node_alpha)
         else:
-            axis.scatter(pos.T[0], pos.T[1], c=node_color, s=node_size)
+            axis.scatter(pos.T[0], pos.T[1], c=cols, s=node_size)
+
+        self.draw_edges(axis, self._mst_pairs, pos, cols, edge_linewidth, edge_alpha, vary_line_width)
 
-        if vary_line_width:
-            self.draw_druhg_edges(axis, self._mst_pairs, pos, edge_linewidth, edge_alpha)
-        elif vary_line_width is not None:
-            self.draw_simple_edges(axis, self._mst_pairs, pos, edge_linewidth, edge_alpha)
 
         # axis.set_xticks([])
         # axis.set_yticks([])
 
         if core_color is not None:
             # adding dots at the node centers
             axis.scatter(pos.T[0], pos.T[1], c=core_color, marker='.', s=node_size / 10)
@@ -490,15 +486,67 @@
         """
         try:
             from networkx import Graph, set_node_attributes
         except ImportError:
             raise ImportError('You must have networkx installed to export networkx graphs')
 
         result = Graph()
-        size = int(len(self._mst_pairs)/2)
+        size = int(len(self._mst_pairs) / 2)
         for i in range(0, size):
-            result.add_edge(self._mst_pairs[2*i], self._mst_pairs[2*i+1])
+            result.add_edge(self._mst_pairs[2 * i], self._mst_pairs[2 * i + 1])
 
-        data_dict = {index: tuple(row) for index, row in enumerate(self._data)}
+        data_dict = {index: tuple(row) for index, row in enumerate(self._raw_data)}
         set_node_attributes(result, data_dict, 'data')
 
         return result
+
+
+class Frames(object):
+    def __init__(self, druhg):
+        self._druhg = druhg
+
+    # https://matplotlib.org/stable/tutorials/introductory/animation_tutorial.html
+    def animate(self, XX, ax=None, fig=None, frames=40, interval_ms=500, xlim=[-20, 20], ylim=[-20, 20], xlabel='x', ylabel='y'):
+        try:
+            import matplotlib.pyplot as plt
+            import matplotlib.animation as animation
+        except ImportError:
+            raise ImportError('You must install the matplotlib library to animate the data.')
+        print('frames=', frames, 'interval=', interval_ms)
+        if XX.shape[0] > 32767:
+            warn('Too many data points for safe rendering!')
+            return None
+
+        self._druhg.allocate_buffers(XX)
+        self._run_times = 0
+
+        if fig is None or ax is None:
+            fig, ax = plt.subplots()
+
+        time_text = ax.text(0.95, 0.01, 'frame: ',
+               verticalalignment='bottom', horizontalalignment='right',
+               transform=ax.transAxes,
+               color='green', fontsize=15)
+
+        scat = ax.scatter(0, 0, c="b", s=5)
+        scat.set_offsets(self._druhg._buffer_data1)
+        ax.set(xlim=xlim, ylim=ylim, xlabel=xlabel, ylabel=ylabel)
+
+        def update_frame(frame):
+            if self._run_times <= frame:
+                self._run_times += 1
+
+                self._druhg.buffer_develop()
+                scat.set_offsets(self._druhg.new_data_)
+                time_text.set_text('frame: '+str(frame))
+
+            return (scat, time_text)
+
+        def empty_init():
+            pass
+
+
+        ani = animation.FuncAnimation(fig=fig, func=update_frame, init_func=empty_init(),
+                                      frames=frames, interval=interval_ms,)
+        plt.show()
+
+        return self
```

### Comparing `druhg-1.3.0/druhg/tests/test_druhg.py` & `druhg-1.4.0/druhg/tests/test_druhg.py`

 * *Files 6% similar despite different names*

```diff
@@ -5,23 +5,15 @@
 import numpy as np
 import pandas as pd
 from scipy.spatial import distance
 from scipy import sparse
 from scipy import stats
 import pytest  #delete __init__.py or it wont work
 
-# from sklearn.utils.estimator_checks import check_estimator
-# from sklearn.utils.testing import (assert_equal,
-#                                    assert_array_equal,
-#                                    assert_array_almost_equal,
-#                                    assert_raises,
-#                                    assert_in,
-#                                    assert_not_in,
-#                                    assert_no_warnings,
-#                                    if_matplotlib)
+
 from druhg import (DRUHG,
                    druhg)
 
 from matplotlib import pyplot as plt
 from mpl_toolkits.mplot3d import Axes3D
 
 # from sklearn.cluster.tests.common import generate_clustered_data
@@ -39,61 +31,63 @@
 
 moons, _ = datasets.make_moons(n_samples=50, noise=0.05)
 blobs, _ = datasets.make_blobs(n_samples=50, centers=[(-0.75, 2.25), (1.0, 2.0)], cluster_std=0.25)
 X = np.vstack([moons, blobs])
 
 _plot_graph = 0
 
+
 def test_iris(filename=None):
     if filename is None:
         filename = test_iris.__name__
     iris = datasets.load_iris()
     XX = iris['data']
-    # print (XX, type(XX))
+    # print(XX, type(XX))
     dr = DRUHG(max_ranking=50, verbose=False)
     dr.fit(XX)
     labels = dr.labels_
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'1'+'.png')
 
     ari = adjusted_rand_score(iris['target'], labels)
-    print ('iris ari', ari)
+    print('iris ari', ari)
     assert (ari >= 0.50)
     # breaking biggest cluster
     labels = dr.relabel(limit1=0, limit2=int(len(XX)/2), fix_outliers=1)
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename + '2' + '.png')
 
     ari = adjusted_rand_score(iris['target'], labels)
-    print ('iris ari', ari)
+    print('iris ari', ari)
     assert (ari >= 0.85)
 
 def test_plot_mst():
     iris = datasets.load_iris()
     XX = iris['data']
     dr = DRUHG(max_ranking=50)
     dr.fit(XX)
     dr.minimum_spanning_tree_.plot()
 
 def test_plot_dendrogram(filename=None):
     if filename is None:
         filename = test_plot_dendrogram.__name__
     iris = datasets.load_iris()
     XX = iris['data']
-    dr = DRUHG(max_ranking=50, limit2=int(len(XX)/2),fix_outliers=1) #, limit1=0, limit2=int(len(XX)/2), fix_outliers=1)
+    dr = DRUHG(max_ranking=50, limit2=int(len(XX)/2), fix_outliers=1)  #, limit1=0, limit2=int(len(XX)/2), fix_outliers=1)
     dr.fit(XX)
     if _plot_graph:
         plt.close('all')
         dr.single_linkage_.plot()
         plt.savefig(filename+'.png')
+    assert (False)
 
 def test_plot_one_dimension():
     iris = datasets.load_iris()
     XX = iris['data']
     XX = XX.reshape(XX.size,1)
     XX = np.array(sorted(XX))
     dr = DRUHG(max_ranking=50)
@@ -105,20 +99,20 @@
     cons = 10.
     XX = [[0.,0.],[1.,1.],[cons+3.,2.],[cons+4.,1.],[cons+5.,2.]]
     XX = np.array(XX)
     dr = DRUHG(algorithm='slow', max_ranking=200, limit1 = 1, limit2 = 1000, verbose=False)
     dr.fit(XX)
     # two clusters
     # assert (len(dr.parents_) == 2)
-    print (dr.mst_)
-    print (dr.mst_[6]*dr.mst_[7])
+    print(dr.mst_)
+    print(dr.mst_[6]*dr.mst_[7])
 
     labels = dr.labels_
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
     n_clusters = len(set(labels)) - int(-1 in labels)
     print('n_clusters', n_clusters)
 
     # proper connection between two groups
     # assert (dr.mst_[6]*dr.mst_[7] == 2) # this is not working anymore
 
     assert (labels[0]==labels[1])
@@ -193,16 +187,18 @@
 
     dr = DRUHG(max_ranking=50, limit1=1, limit2=len(XX), verbose=False)
     dr.fit(XX)
     # s = 2*len(XX) - 2
     # starts somewhere in the middle
     # and grows one by one
     # that's why there are no clusters
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
+    np.set_printoptions(precision=2)
+    print('values', dr.values_)
     # assert (len(dr.parents_)==0)
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot(vary_line_width=None)
         plt.savefig(filename+'.png')
     labels = dr.labels_
 
@@ -210,82 +206,88 @@
         assert (all(x == labels[0] for x in labels))
         return
 
     assert (not all(x == labels[0] for x in labels))
     assert (labels[0] == labels[len(labels)-1])
     assert (labels[1] == labels[len(labels)-2])
     assert (labels[0] != labels[1])
-    # assert (0 == 1)
+    # assert 0
 
 def test_longline(filename=None):
     if filename is None:
         filename = test_longline.__name__
-    test_line(size=100, filename = filename)
+    test_line(size=100, filename=filename)
 
 def test_fiveline(filename=None):
     if filename is None:
         filename = test_fiveline.__name__
-    test_line(size=5, filename = filename)
+    test_line(size=5, filename=filename)
 
 # def test_hypersquare():
 #     XX = []
 #     size, scale = 6, 1.
 #     for i1 in range(0, size):
 #         for i2 in range(0, size):
 #             for i3 in range(0, size):
 #                 for i4 in range(0, size):
 #                     for i5 in range(0, size):
 #                         XX.append([i1*scale,i2*scale,i3*scale,i4*scale,i5*scale])
 #     XX = np.array(XX)
 #     dr = DRUHG(max_ranking=10, limit1=1, limit2=len(XX), verbose=False)
 #     dr.fit(XX)
 #     s = 2*len(XX) - 2
-#     print (dr.mst_)
-#     print (dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
+#     print(dr.mst_)
+#     print(dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
 #     labels = dr.labels_
 #     n_clusters = len(set(labels)) - int(-1 in labels)
 #     print('n_clusters', n_clusters)
-#     print (dr.mst_)
-#     print (XX)
-#     print (dr.labels_)
+#     print(dr.mst_)
+#     print(XX)
+#     print(dr.labels_)
 #     assert (n_clusters==1)
 #     labels = dr.relabel(limit1=1)
 #     n_clusters = len(set(labels)) - int(-1 in labels)
 #     print('n_clusters', n_clusters)
 #     assert (n_clusters == 5)
 #     assert (0==1)
 
-def test_square(showplot=True, size = 10, scale = 5., filename=None):
+def test_square(showplot=True, size=10, scale=5., filename=None):
     if filename is None:
         filename = test_square.__name__
     XX = []
     for i in range(0, size):
         for j in range(0, size):
             XX.append([scale*i,scale*j])
 
     XX = np.array(XX)
     np.random.shuffle(XX)
 
-    dr = DRUHG(max_ranking=20, algorithm='slow', limit1=1, limit2=len(XX), verbose=False)
+    dr = DRUHG(max_ranking=2000, algorithm='slow', limit1=1, limit2=len(XX), verbose=False)
     dr.fit(XX)
+
+    if False and showplot and _plot_graph:
+        plt.close('all')
+        dr.single_linkage_.plot()
+        plt.savefig(filename + 'plot' + '.png')
+
     s = 2*len(XX) - 2
-    print (dr.mst_)
-    print (dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
+    # print(dr.mst_)
+    # print(dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
     labels = dr.labels_
     n_clusters = len(set(labels)) - int(-1 in labels)
     print('n_clusters', n_clusters)
-    print (dr.mst_)
-    # print (XX)
-    print (dr.labels_)
+    print(dr.mst_)
+    # print(XX)
+    print(dr.labels_)
     # assert (n_clusters==1)
     # labels = dr.relabel(limit1=1, limit2=size*2)
     n_clusters = len(set(labels)) - int(-1 in labels)
     # print('n_clusters', n_clusters)
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    # print('pairs', dr.mst_)
+    print('labels', dr.labels_)
 
     un, cn = np.unique(labels, return_counts=True)
     for i in range(0, len(un)):
         print('square', un[i], cn[i] )
 
     if showplot and _plot_graph:
         plt.close('all')
@@ -295,49 +297,56 @@
     un, cn = np.unique(labels, return_counts=True)
     print('uniques', un, cn)
 
     sorteds = np.argsort(cn)
     print('hello')
     print('hello2', un[sorteds[0]],un[sorteds[1]])
     # assert (False)
-    dr.relabel(limit1=1, limit2=len(XX), exclude=[un[sorteds[0]], un[sorteds[1]]])
-    if _plot_graph:
+    dr.relabel(limit1=1, limit2=size*2)
+    if showplot and _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'2'+'.png')
     assert (n_clusters >= 5)
     assert (cn[sorteds[-1]] == (size-2)**2)
     assert (un[sorteds[0]] == -1 and cn[sorteds[0]] == 4)
     for i in range(1,5):
         assert (cn[sorteds[i]] == size - 2)
-    # assert (False)
+    assert (False)
 
 def test_scaled_square(filename=None):
     if filename is None:
         filename = test_scaled_square.__name__
     for i in range(-5, 4):
         test_square(scale=10**i, filename=filename)
 
 
 
-def test_two_squares():
+def test_two_squares(filename=None):
+    if filename is None:
+        filename = test_two_squares.__name__
     XX = []
     size, scale = 6, 1
     for i in range(0, size):
         for j in range(0, size):
             XX.append([scale*i, scale*j])
             XX.append([2*size + scale*i, scale*j])
     XX = np.array(XX)
     dr = DRUHG(max_ranking=200, verbose=False)
     dr.fit(XX)
     s = 2*len(XX) - 2
-    print (dr.mst_)
-    print (dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
+    print(dr.mst_)
+    print(dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
     labels = dr.labels_
     n_clusters = len(set(labels)) - int(-1 in labels)
+
+    if _plot_graph:
+        plt.close('all')
+        dr.minimum_spanning_tree_.plot()
+        plt.savefig(filename+'.png')
     assert (n_clusters==2)
 
 
 def test_particles(filename=None):
     if filename is None:
         filename = test_particles.__name__
     XX = [[-0.51,1.5], [1.51,1.5]]
@@ -350,31 +359,57 @@
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
 
     s = 2*len(XX) - 2
-    print (dr.mst_)
-    print (dr.labels_)
-    print (dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
+    print(dr.mst_)
+    print(dr.labels_)
+    print(dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
+    # two points are further metrically but close reciprocally
+    assert (dr.mst_[s-4]*dr.mst_[s-3] == 0)
+    assert (dr.mst_[s-4] + dr.mst_[s-3] == 1)
+
+def test_particles_big(filename=None):
+    if filename is None:
+        filename = test_particles_big.__name__
+    XX = [[-0.51,1.5], [1.51,1.5]]
+    for i in range(-5, 7):
+        for j in range(-8, 1):
+            XX.append([i,j])
+    XX = np.array(XX)
+    dr = DRUHG(max_ranking=200, algorithm='slow', limit1=1, limit2=len(XX), verbose=False)
+    dr.fit(XX)
+
+    if _plot_graph:
+        plt.close('all')
+        dr.minimum_spanning_tree_.plot()
+        plt.savefig(filename+'.png')
+
+    s = 2*len(XX) - 2
+    print(dr.mst_)
+    print(dr.labels_)
+    print(dr.mst_[s-1], dr.mst_[s-2], XX[dr.mst_[s-1]], XX[dr.mst_[s-2]])
     # two points are further metrically but close reciprocally
     assert (dr.mst_[s-4]*dr.mst_[s-3] == 0)
     assert (dr.mst_[s-4] + dr.mst_[s-3] == 1)
+    assert (False)
+
 #
 def test_bomb():
     XX = [[0.,1.],[0.,2.],[0.,3.],[0.,4.],[0.,5.]]
     for i in range(-3, 4):
         for j in range(-6, 1):
             XX.append([i,j])
     XX = np.array(XX)
     dr = DRUHG(algorithm='slow', max_ranking=200, limit1=1, limit2=len(XX), verbose=False)
     dr.fit(XX)
     s = 2*len(XX) - 2
-    print (dr.mst_)
+    print(dr.mst_)
     x = 12
     labs = dr.labels_
     # fuse is separate
     print(labs)
     assert (labs[0]==labs[1]==labs[2]==labs[3])
     assert (np.count_nonzero(labs == labs[0]) == 4)
 
@@ -388,16 +423,16 @@
         XX.append([j,0.])
     XX = np.array(XX)
     # np.random.shuffle(XX)
     dr = DRUHG(max_ranking=200, algorithm='slow', verbose=False)
     dr.fit(XX)
     labels = dr.labels_
     n_clusters = len(set(labels)) - int(-1 in labels)
-    print ('n_clusters', n_clusters)
-    print ('labels', len(labels), labels)
+    print('n_clusters', n_clusters)
+    print('labels', len(labels), labels)
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
     # t-center is an outlier too
     assert (n_clusters == 3)
@@ -414,20 +449,20 @@
     for i in range(1, 10):
         XX.append([0., i])
         XX.append([0., i - 10])
     XX = np.array(XX)
     # np.random.shuffle(XX)
     dr = DRUHG(max_ranking=200, verbose=False)
     dr.fit(XX)
-    print (XX)
+    print(XX)
     # center is an outlier
     labels = dr.labels_
     n_clusters = len(set(labels)) - int(-1 in labels)
-    print ('n_clusters', n_clusters)
-    print ('labels', len(labels))
+    print('n_clusters', n_clusters)
+    print('labels', len(labels))
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
 
     assert (n_clusters == 4)
@@ -444,28 +479,28 @@
         for j in range(0, size):
             for k in range(0, size):
                 XX.append([i*scale,j*scale,k*scale])
     XX = np.array(XX)
     np.random.shuffle(XX)
     print(XX)
     # for i, x in enumerate(XX):
-    #     print (i, x)
+    #     print(i, x)
     dr = DRUHG(algorithm='slow', max_ranking=200, limit1=1, limit2=int(len(XX)/2), verbose=False)
     dr.fit(XX)
     s = 2*len(XX) - 2
-    print (dr.mst_)
+    print(dr.mst_)
     # assert (0==1)
     labels = dr.labels_
     unique, counts = np.unique(labels, return_counts=True)
-    print (unique, counts)
+    print(unique, counts)
     # labels = dr.relabel(limit1=1, limit2=len(XX)/2)
 
     n_clusters = len(set(labels)) - int(-1 in labels)
-    print ('n_clusters', n_clusters, set(labels))
-    # print ('labels', labels)
+    print('n_clusters', n_clusters, set(labels))
+    # print('labels', labels)
 
     # sorteds = np.argsort(counts)
     # dr.relabel(limit1=1, limit2=len(XX), exclude=[unique[sorteds[0]], unique[sorteds[1]]])
     # labels = dr.labels_
 
     if showplot and _plot_graph:
         import seaborn as sns
@@ -542,28 +577,30 @@
 
     # # assert (False)
     # # labels = dr.relabel(limit1=1)
     # labels = dr.relabel(limit1=1, limit2=len(XX))
     # print('out')
     # n_clusters = len(set(labels)) - int(-1 in labels)
     # print('n_clusters2', n_clusters, set(labels))
-    # # print ('labels2', labels)
+    # # print('labels2', labels)
     # assert (n_clusters == 1+6+12)
 
-    # assert (0==1)
+    assert (0==1)
 
 def test_loop_cube():
+    return
     k = 100
     while k!=0:
         # print('+++++++++++++PREVED+++++++++++++', k - 1000)
         test_cube(showplot=False)
         # assert (False)
         k-=1
 
 def test_loop_square():
+    return
     k = 100
     while k!=0:
         # print('+++++++++++++PREVED+++++++++++++', k - 1000)
         test_square(False)
         # assert (False)
         k-=1
 
@@ -571,68 +608,68 @@
     row = np.array([0, 0, 1, 2, 2, 2])
     col = np.array([0, 2, 2, 0, 1, 2])
     data = np.array([1, 2, 3, 4, 5, 6])
     sparse_X = sparse.csr_matrix((data, (row, col)), shape=(3, 3))
 
     dr = DRUHG()
     dr.fit(sparse_X)
-    print ('sparse labels', dr.labels_)
+    print('sparse labels', dr.labels_)
 
 def test_druhg_distance_matrix(filename=None):
     if filename is None:
         filename = test_druhg_distance_matrix.__name__
     D = distance.squareform(distance.pdist(X))
     D /= np.max(D)
 
-    print (D.shape)
+    print(D.shape)
     dr = druhg(D, metric='precomputed')
-    print (dr)
+    print(dr)
     n_clusters = len(set(dr[0])) - int(-1 in dr[0])
-    print (n_clusters)
+    print(n_clusters)
     if _plot_graph:
         plt.close('all')
         dr = DRUHG(metric="precomputed").fit(D)
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'1'+'.png')
     assert(n_clusters==4)
 
     dr = DRUHG(metric="precomputed", limit1=5).fit(D)
     labels = dr.labels_
-    print (labels)
+    print(labels)
     n_clusters = len(set(labels)) - int(-1 in labels)
-    print (n_clusters)
+    print(n_clusters)
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'2'+'.png')
 
     assert(n_clusters==4)
 
 def test_moons_and_blobs():
     XX = X
     dr = DRUHG(max_ranking=50, verbose=False)
     dr.fit(XX)
     labels = dr.labels_
     n_clusters = len(set(labels)) - int(-1 in labels)
     # expecting 4 clusters
-    print (labels)
+    print(labels)
 
     assert (n_clusters == 4)
 #
 def test_hdbscan_clusterable_data(filename=None):
     if filename is None:
         filename = test_hdbscan_clusterable_data.__name__
     XX = np.load('druhg\\tests\\clusterable_data.npy')
     dr = DRUHG(max_ranking=50, verbose=False)
     dr.fit(XX)
     labels = dr.labels_
     uniques, counts = np.unique(labels, True)
-    print (uniques, counts)
+    print(uniques, counts)
     n_clusters = len(set(labels)) - int(-1 in labels)
-    print (n_clusters)
+    print(n_clusters)
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
 
     assert (n_clusters==6)
@@ -641,80 +678,24 @@
     if filename is None:
         filename = test_three_blobs.__name__
     XX = np.load('druhg\\tests\\three_blobs.npy')
     dr = DRUHG(max_ranking=3550, verbose=False)
     dr.fit(XX)
     labels = dr.labels_
     uniques, counts = np.unique(labels, True)
-    print (uniques, counts)
+    print(uniques, counts)
     n_clusters = len(set(labels)) - int(-1 in labels)
-    print (n_clusters)
+    print(n_clusters)
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
 
     assert (n_clusters==3)
-#
-def test_chameleon(is_reciprocal=1, filename=None):
-    if filename is None:
-        filename = test_chameleon.__name__
-    XX = pd.read_csv('druhg\\tests\\chameleon.csv', sep='\t', header=None)
-    XX = np.array(XX)
-    dr = DRUHG(max_ranking=4200, limit1 = 1, limit2=len(XX), is_reciprocal=is_reciprocal, verbose=False)
-    dr.fit(XX)
-    labels = dr.labels_
-    # labels = dr.relabel(limit1=1)
-    values, counts = np.unique(labels, return_counts=True)
-    n_clusters = 0
-    for i, c in enumerate(counts):
-        print (i, c, values[i])
-        if c > 500 and values[i] >= 0:
-            n_clusters += 1
-    print('n_clusters', n_clusters)
-
-    if _plot_graph:
-        plt.close('all')
-        dr.minimum_spanning_tree_.plot()
-        plt.savefig(filename+'1'+'.png')
-
-    dr = DRUHG( max_ranking=200, limit1 = 1, limit2=int(len(XX)/4), is_reciprocal=is_reciprocal, exclude=[], verbose=False)
-    dr.fit(XX)
-
-    if _plot_graph:
-        plt.close('all')
-        dr.minimum_spanning_tree_.plot()
-        plt.savefig(filename+'2'+'.png')
-
-    values, counts = np.unique(dr.labels_, return_counts=True)
-    for i, v in enumerate(values):
-        if counts[i] > 200:
-            print (v, counts[i])
-
-    exc = dr.labels_[3024]
-    dr.relabel(limit1=3, limit2=int(len(XX)/4), is_reciprocal=is_reciprocal, exclude=[exc])
-    if _plot_graph:
-        plt.close('all')
-        dr.minimum_spanning_tree_.plot()
-        plt.savefig(filename+'3'+'.png')
-
-    exc = dr.labels_[3024]
-    dr.relabel(limit1=3, limit2=int(len(XX)/8), is_reciprocal=is_reciprocal, exclude=[exc])
-    if _plot_graph:
-        plt.close('all')
-        dr.minimum_spanning_tree_.plot()
-        plt.savefig(filename+'4'+'.png')
-
-    assert (n_clusters==6)
-#
-def test_reciprocal_chameleon(filename = None):
-    if filename is None:
-        filename = test_reciprocal_chameleon.__name__
-    test_chameleon(is_reciprocal=0, filename=filename)
 
 def test_synthetic_outliers(filename=None):
     if filename is None:
         filename = test_synthetic_outliers.__name__
     XX = pd.read_csv('druhg\\tests\\synthetic.csv', sep=',')
     XX.drop(u'outlier', axis=1, inplace=True)
     XX = np.array(XX)
@@ -724,30 +705,30 @@
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
 
     # values, counts = np.unique(dr.labels_, return_counts=True)
     # for i, v in enumerate(values):
-    #     print (v, counts[i])
+    #     print(v, counts[i])
 
     labels = dr.labels_
     # labels = dr.relabel(limit1=1)
     n_clusters = len(set(labels)) - int(-1 in labels)
     print(labels)
     print('n_clusters', n_clusters)
     assert (n_clusters==6)
 
 
 def test_compound1(filename=None):
     if filename is None:
         filename = test_compound1.__name__
     XX = pd.read_csv('druhg/tests/Compound.csv', sep=',', header=None).drop(2, axis=1)
     XX = np.array(XX)
-    dr = DRUHG(max_ranking=200, limit1=3, limit2=len(XX), verbose=False)
+    dr = DRUHG(max_ranking=1550, limit1=3, limit2=len(XX), verbose=False)
     dr.fit(XX)
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'1'+'.png')
 
@@ -756,15 +737,15 @@
     n_clusters = len(set(labels)) - int(-1 in labels)
     # np.save('labels_compound', labels)
     print('n_clusters', n_clusters, set(labels))
     exc = labels[398]
     # dr.relabel(limit1=3, limit2=len(XX), exclude=[exc])
     # labels = dr.labels_
     n_clusters2 = len(set(labels)) - int(-1 in labels)
-    print (exc, n_clusters2, set(labels))
+    print(exc, n_clusters2, set(labels))
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'2'+'.png')
 
     exc2 = labels[398]
@@ -772,24 +753,25 @@
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'3'+'.png')
 
 
     assert (n_clusters==4)
+    assert (False)
 
 
 def test_compound_egg(filename=None):
     if filename is None:
         filename = test_compound_egg.__name__
     XX = pd.read_csv('druhg/tests/Compound.csv', sep=',', header=None)
     XX = XX[(XX[2]==6) | (XX[2]==5)]
     XX = XX.drop(2, axis=1)
     XX = np.array(XX)
-    dr = DRUHG(max_ranking=200, limit1=3, limit2=len(XX), verbose=False)
+    dr = DRUHG(max_ranking=2000, limit1=3, limit2=len(XX), verbose=False)
     dr.fit(XX)
 
     if _plot_graph:
         plt.close('all')
         dr.minimum_spanning_tree_.plot()
         plt.savefig(filename+'.png')
 
@@ -797,75 +779,75 @@
     # labels = dr.relabel(limit1=1)
     n_clusters = len(set(labels)) - int(-1 in labels)
     # np.save('labels_compound', labels)
     print('n_clusters', n_clusters, set(labels))
     # dr.relabel(limit1=3, limit2=len(XX), exclude=[exc])
     # labels = dr.labels_
     n_clusters2 = len(set(labels)) - int(-1 in labels)
-    print ( n_clusters2, set(labels))
+    print( n_clusters2, set(labels))
 
     assert (n_clusters==2)
-    # assert (False)
+    assert (False)
 
 def test_copycat():
     XX = [[0]]*100
     XX = np.array(XX)
     dr = DRUHG(max_ranking=200, limit1=1, verbose=False)
     dr.fit(XX)
-    print (dr.mst_[0], dr.mst_[1])
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    print(dr.mst_[0], dr.mst_[1])
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
     labels = dr.labels_
     assert (all(x == labels[0] for x in labels))
 
 def test_copycats(): # should fail until weights are made
     XX = np.concatenate( ([[0]]*100, [[1]]*100))
     dr = DRUHG(max_ranking=10, limit1=1, verbose=False)
     dr.fit(XX)
-    print (dr.mst_[0], dr.mst_[1])
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    print(dr.mst_[0], dr.mst_[1])
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
     labels = dr.labels_
     assert (not all(x == labels[0] for x in labels))
     assert (labels[0] != labels[-1])
 
     uniques, counts = np.unique(labels, True)
-    print (uniques, counts)
+    print(uniques, counts)
     n_clusters = len(set(labels)) - int(-1 in labels)
     assert (n_clusters==2)
 
 def test_copycats2():
     XX = np.concatenate( ([[0]]*10, [[1]]*10))
     dr = DRUHG(max_ranking=200, limit1=1, verbose=False)
     dr.fit(XX)
-    print (dr.mst_[0], dr.mst_[1])
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    print(dr.mst_[0], dr.mst_[1])
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
     labels = dr.labels_
     assert (not all(x == labels[0] for x in labels))
     assert (labels[0] != labels[-1])
 
     uniques, counts = np.unique(labels, True)
-    print (uniques, counts)
+    print(uniques, counts)
     n_clusters = len(set(labels)) - int(-1 in labels)
     assert (n_clusters==2)
 
 def test_copycats3(): # should fail until weights are made
     XX = np.concatenate( ([[0]]*100, [[1]]*100, [[2]]*5) )
     dr = DRUHG(max_ranking=10, limit1=1, limit2=250, verbose=False)
     dr.fit(XX)
-    print (dr.mst_[0], dr.mst_[1])
-    print ('pairs', dr.mst_)
-    print ('labels', dr.labels_)
+    print(dr.mst_[0], dr.mst_[1])
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
     labels = dr.labels_
     assert (not all(x == labels[0] for x in labels))
     assert (labels[0] != labels[-1])
 
     uniques, counts = np.unique(labels, True)
-    print (uniques, counts)
+    print(uniques, counts)
     n_clusters = len(set(labels)) - int(-1 in labels)
     assert (n_clusters==3)
 #
 # def test_speed0():
 #     XX = []
 #     size = 5
 #     for i in range(0, size):
@@ -913,8 +895,94 @@
 #
 # def test_speed5(k=100):
 #     XX = test_speed0()
 #     while k!=0:
 #         k -= 1
 #         np.random.shuffle(XX)
 #         dr = DRUHG(algorithm='slow', max_ranking=200, limit1=1, limit2=int(len(XX) / 2), verbose=False)
-#         dr.fit(XX)
+#         dr.fit(XX)
+
+
+
+def test_triangle(scale = 1., filename = None, all_clusters = True):
+    if filename is None:
+        filename = test_rightangle.__name__
+    XX = [[0., 0.], [scale, 0], [0, scale*10.]]
+    XX = np.array(XX)
+    dr = DRUHG(algorithm='slow', max_ranking=200, limit1=1, limit2=1000, verbose=False)
+    dr.fit(XX)
+
+    # two clusters
+    # assert (len(dr.parents_) == 2)
+
+    labels = dr.labels_
+    print('pairs', dr.mst_)
+    print('labels', dr.labels_)
+    n_clusters = len(set(labels)) - int(-1 in labels)
+    print('n_clusters', n_clusters)
+
+    # assert (all(x == labels[0] for x in labels))
+
+    dr.relabel(coords_arr=XX)
+    assert (False)
+
+
+def test_chameleon(filename=None):
+    if filename is None:
+        filename = test_chameleon.__name__
+    XX = pd.read_csv('druhg\\tests\\chameleon.csv', sep='\t', header=None)
+    XX = np.array(XX)
+    dr = DRUHG(max_ranking=4200, limit1 = 1, limit2=len(XX), verbose=False, algorithm='slow')
+    dr.fit(XX)
+    labels = dr.labels_
+    # labels = dr.relabel(limit1=1)
+    values, counts = np.unique(labels, return_counts=True)
+    n_clusters = 0
+    for i, c in enumerate(counts):
+        print(i, c, values[i])
+        if c > 500 and values[i] >= 0:
+            n_clusters += 1
+    print('n_clusters', n_clusters)
+
+    if _plot_graph:
+        plt.close('all')
+        dr.minimum_spanning_tree_.plot()
+        plt.savefig(filename+'1'+'.png')
+
+    dr = DRUHG(max_ranking=1200, limit1=1, limit2=int(len(XX)/4), exclude=[], verbose=False, algorithm='slow')
+    dr.fit(XX)
+
+    values, counts = np.unique(dr.labels_, return_counts=True)
+    n_clusters2 = 0
+    for i, c in enumerate(counts):
+        print(i, c, values[i])
+        if c > 500 and values[i] >= 0:
+            n_clusters2 += 1
+    print('n_clusters2', n_clusters2)
+
+    if _plot_graph:
+        plt.close('all')
+        dr.minimum_spanning_tree_.plot()
+        plt.savefig(filename+'2'+'.png')
+
+    if _plot_graph:
+        plt.close('all')
+        dr.single_linkage_.plot()
+        plt.savefig(filename +'plot'+ '.png')
+
+    exc = dr.labels_[3024]
+    dr.relabel(limit1=3, limit2=int(len(XX)/4), exclude=[exc])
+    if _plot_graph:
+        plt.close('all')
+        dr.minimum_spanning_tree_.plot()
+        plt.savefig(filename+'3'+'.png')
+
+    exc = dr.labels_[3024]
+    dr.relabel(limit1=3, limit2=int(len(XX)/8), exclude=[exc])
+    if _plot_graph:
+        plt.close('all')
+        dr.minimum_spanning_tree_.plot()
+        plt.savefig(filename+'4'+'.png')
+
+    assert (n_clusters2==6)
+    assert (n_clusters==6)
+    assert False
```

### Comparing `druhg-1.3.0/druhg.egg-info/PKG-INFO` & `druhg-1.4.0/druhg.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 Metadata-Version: 1.2
 Name: druhg
-Version: 1.3.0
+Version: 1.4.0
 Summary: Universal clustering based on dialectical materialism
 Home-page: https://github.com/artamono/druhg
-Maintainer: Pavel "DRUHG" Artamonov
+Maintainer: Pavel Artamonov
 Maintainer-email: druhg.p@gmail.com
 License: BSD
 Description: .. image:: https://img.shields.io/pypi/v/druhg.svg
             :target: https://pypi.python.org/pypi/druhg/
             :alt: PyPI Version
         .. image:: https://img.shields.io/pypi/l/druhg.svg
             :target: https://github.com/artamono/druhg/blob/master/LICENSE
```

### Comparing `druhg-1.3.0/setup.py` & `druhg-1.4.0/setup.py`

 * *Files 9% similar despite different names*

```diff
@@ -21,36 +21,38 @@
 
         # Add numpy headers to include_dirs
         self.include_dirs.append(numpy.get_include())
 
         # Call original build_ext command
         build_ext.run(self)
 
-
+_druhg_unionfind = Extension('druhg._druhg_unionfind',
+                         sources=['druhg/_druhg_unionfind.pyx'])
 _druhg_tree = Extension('druhg._druhg_tree',
                          sources=['druhg/_druhg_tree.pyx'])
-_druhg_amalgamation = Extension('druhg._druhg_amalgamation',
-                         sources=['druhg/_druhg_amalgamation.pyx'])
+_druhg_group = Extension('druhg._druhg_group',
+                         sources=['druhg/_druhg_group.pyx'])
 _druhg_label = Extension('druhg._druhg_label',
                          sources=['druhg/_druhg_label.pyx'])
-
+_cyheapq = Extension('druhg._cyheapq',
+                         sources=['druhg/_cyheapq.pyx'])
 
 
 def readme():
     with open('README.rst') as readme_file:
         return readme_file.read()
 
 def requirements():
     # The dependencies are the same as the contents of requirements.txt
     with open('requirements.txt') as f:
         return [line.strip() for line in f if line.strip()]
 
 configuration = {
     'name': 'druhg',
-    'version': '1.3.0',
+    'version': '1.4.0',
     'description': 'Universal clustering based on dialectical materialism',
     'long_description': readme(),
     'classifiers': [
         'Development Status :: 4 - Beta',
         'Intended Audience :: Science/Research',
         'Intended Audience :: Developers',
         'License :: OSI Approved',
@@ -63,27 +65,30 @@
         'Operating System :: Unix',
         'Operating System :: MacOS',
         'Programming Language :: Python :: 2.7',
         'Programming Language :: Python :: 3.8',
     ],
     'keywords': 'cluster clustering density dialectics',
     'url': 'https://github.com/artamono/druhg',
-    'maintainer': 'Pavel "DRUHG" Artamonov',
+    'maintainer': 'Pavel Artamonov',
     'maintainer_email': 'druhg.p@gmail.com',
     'license': 'BSD',
     'packages': ['druhg', 'druhg.tests'],
     'install_requires': requirements(),
-    'ext_modules': [_druhg_tree,
-                    _druhg_amalgamation,
+    'ext_modules': [
+                    _druhg_unionfind,
+                    _druhg_tree,
+                    _druhg_group,
                     _druhg_label,
+                    _cyheapq
                     ],
     'zip_safe': False,
     'cmdclass': {'build_ext': CustomBuildExtCommand},
     'tests_require': ['pytest'],
-    'data_files': ('druhg/_druhg_amalgamation.pxd', 'druhg/_druhg_tree.pxd',)
+    'data_files': ('druhg/_druhg_unionfind.pxd', 'druhg/_druhg_group.pxd', 'druhg/_druhg_tree.pxd',)
 }
 
 if not HAVE_CYTHON:
     warnings.warn('Due to incompatibilities with Python 3.7 druhg now'
                   'requires Cython to be installed in order to build it')
     raise ImportError('Cython not found! Please install cython and try again')
```

